<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.ECommerce.com/DataOperation">

  <dataCommand name="QueryProductPurchase" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
     IF OBJECT_ID(N'tempdb..#SearchPO') IS NOT NULL
 DROP TABLE #SearchPO
;
SELECT
 po.sysno
,po.poid
,po.createtime
,po.audittime
,po.intime
,po.status
,po.etp
,po.ComfirmTime
,po.PrintTime PrintTime
,po.HasSendMail
,po.MailAddress
,po.StockSysNo
,po.ITStockSysNo
,po.PM_ReturnPointSysNo
,po.Source
,po.CloseUser
,po.CloseTime
,po.ContractNumber
,po.ApportionTime
,po.createusersysno
,po.auditusersysno
,po.auditusername
,po.vendorsysno
,po.ApportionUserSysNo
,po.inusersysno
,po.ComfirmUserSysNo
,po.TPStatus
,po.PaySettleCompany
,po.LeaseFlag
INTO #SearchPO
FROM IPP3.dbo.po_master po WITH(NOLOCK)
#StrWhere# replaceSQL1

 SELECT @TotalCount = COUNT(1)
        FROM #SearchPO
          po WITH(NOLOCK)
	        INNER JOIN IPP3.dbo.Vendor WITH(NOLOCK)
				    ON po.vendorsysno =  IPP3.dbo.Vendor.sysno
	        INNER JOIN  OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
				    ON po.stocksysno = stock.sysno
	        LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_audit WITH(NOLOCK)
				    ON po.auditusersysno = con_audit.UserSysNo
            LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_apport WITH(NOLOCK)
				    ON po.ApportionUserSysNo = con_apport.UserSysNo
            replaceSQL2
            
        SELECT
          sysno
          ,poid
          ,VendorSysNo
          ,vendorname
          ,stockname
          ,ITStockName
          ,createname
          ,createtime
          , (CASE WHEN createtime IS NULL THEN '' ELSE  createname + '[' + CONVERT(varchar(100),createtime,120) + ']'  END) as CreateTimeAndUser
          ,auditname
          ,audittime
          , (CASE WHEN audittime IS NULL THEN '' ELSE  auditname + '[' + CONVERT(varchar(100),audittime,120) + ']'  END) as AuditTimeAndUser
          ,inname
          ,intime
          , (CASE WHEN intime IS NULL THEN '' ELSE  inname + '[' + CONVERT(varchar(100),intime,120) + ']'  END) as InTimeAndUser
          ,status
          ,etp
          ,ComfirmUserSysNo
          ,ComfirmTime
          ,ComfirmUser
          , (CASE WHEN ComfirmTime IS NULL THEN '' ELSE  ComfirmUser + '[' + CONVERT(varchar(100),ComfirmTime,120) + ']'  END) as ConfirmTimeAndUser
          ,PrintTime
          ,HasSendMail
          ,MailAddress
		      ,Email
		      ,StockSysNo
		      ,ITStockSysNo
          ,MaxTastDate
          ,PreEimsCount
          ,QtyEimsCount
          ,PreCount
          ,QtyCount
          ,AllPurchaseQty
          ,AllQuantity
          ,AllPrePurchaseQty
		      ,EIMSNo
		      ,EIMSAmt
          ,UsedEIMSAmt
          ,Source
          ,CloseUser
          ,CloseTime
          , (CASE WHEN CloseTime IS NULL THEN '' ELSE  CloseUser + '[' + CONVERT(varchar(100),CloseTime,120) + ']'  END) as CloseTimeAndUser
          ,ContractNumber
          ,ApportionTime
          ,ApportionUserName
          , (CASE WHEN ApportionTime IS NULL THEN '' ELSE  ApportionUserName + '[' + CONVERT(varchar(100),ApportionTime,120) + ']'  END) as ApportionTimeAndUser
          ,EIMSNoList
          ,PaySettleCompany
          ,LeaseFlag
        FROM
        (
	          select TOP (@EndNumber)
	             po.sysno
	            ,po.poid
              ,vendor.SysNo as VendorSysNo
	            ,vendor.vendorname
	            ,(SELECT TOP (1) stock.stockname FROM OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK) WHERE po.stocksysno = stock.sysno) AS stockname
              ,(SELECT TOP (1) stock.stockname FROM OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK) WHERE po.ITStockSysNo = stock.sysno) AS ITStockName
	            ,con_create.DisplayName as createname
	            ,po.createtime
	            ,po.auditusername as auditname
	            ,po.audittime
	            ,con_in.DisplayName as inname
	            ,po.intime
	            ,po.status
	            ,po.etp
	            ,po.ComfirmUserSysNo
	            ,po.ComfirmTime
	            ,com_user.DisplayName as ComfirmUser
	            ,po.PrintTime PrintTime
              ,po.HasSendMail
              ,po.MailAddress
			        ,vendor.Email
			        ,po.StockSysNo
			        ,po.ITStockSysNo
              ,a.MaxTastDate
              ,pocount.PreEimsCount
              ,pocount.QtyEimsCount
              ,pocount.PreCount
              ,pocount.QtyCount
              ,pocount.AllPurchaseQty
              ,pocount.AllQuantity
              ,pocount.AllPrePurchaseQty
			        ,po.PM_ReturnPointSysNo AS EIMSNo
			        --,UsingReturnPoint AS EIMSAmt
				      ,po.Source
				      ,po.CloseUser
				      ,po.CloseTime
				      ,po.ContractNumber
				      ,po.ApportionTime
				      ,po.ApportionUserSysNo
              ,con_apport.DisplayName AS ApportionUserName
              ,EIMSAmt = (
                SELECT ISNULL( SUM(EIMSAmt),0.00)
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
              ),
              UsedEIMSAmt = (
                SELECT ISNULL( SUM(EIMSAmt),0.00)
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfoDetail WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
              )
              ,EIMSNoList = (
                SELECT ISNULL(CAST(EIMSNo AS VARCHAR)+',','')
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
                FOR XML PATH(''))
              ,po.PaySettleCompany
              ,po.LeaseFlag
	            ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
	          FROM #SearchPO po WITH(NOLOCK)
	          INNER JOIN  IPP3.dbo.Vendor vendor WITH(NOLOCK)
				      ON po.vendorsysno =  vendor.sysno
	          LEFT JOIN  OverseaArchitecture.dbo.V_AR_UserInfo AS con_create WITH(NOLOCK)
				      ON po.createusersysno = con_create.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_audit WITH(NOLOCK)
				      ON po.auditusersysno = con_audit.UserSysNo
            LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_apport WITH(NOLOCK)
				      ON po.ApportionUserSysNo = con_apport.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_in WITH(NOLOCK)
				      ON po.inusersysno = con_in.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS com_user WITH(NOLOCK)
				      ON po.ComfirmUserSysNo = com_user.UserSysNo
	          LEFT  JOIN
	          (   SELECT Purno,MAX(recdate) AS MaxTastDate
                  FROM scm.dbo.poLog WITH (nolock)
                  GROUP BY Purno
               )a ON po.SysNo = a.Purno
            LEFT OUTER JOIN
            (
              SELECT POSysNo
                    , SUM(CASE AcquireReturnPointType WHEN 1 THEN round( PurchaseQty*OrderPrice*AcquireReturnPoint/100,2) WHEN 0 THEN PurchaseQty*AcquireReturnPoint  END  ) AS PreEimsCount
                    , SUM(CASE AcquireReturnPointType WHEN 1 THEN round( Quantity*OrderPrice*AcquireReturnPoint/100,2 ) WHEN 0 THEN Quantity*AcquireReturnPoint  END  ) AS QtyEimsCount
                    , SUM(PrePurchaseQty*OrderPrice) AS PreCount
                    , SUM(Quantity*OrderPrice) AS QtyCount
                    ,SUM(PurchaseQty) AS AllPurchaseQty
                    , SUM(Quantity)  AS AllQuantity
                    ,SUM(PrePurchaseQty) AS AllPrePurchaseQty
              FROM IPP3.dbo.PO_Item
              GROUP BY POSysNo
            ) pocount ON pocount.POSysNo = po.sysno
            replaceSQL3
        )RESULT WHERE RowNumber > @StartNumber ORDER BY RESULT.RowNumber
			]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>

  <dataCommand name="AddPOItemByProductSysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
          Item.SysNo ProductSysNo
          ,Item.ProductID
          ,Item.ProductTitle AS ProductName
          ,Item.ProductMode
          ,Item.BMCode
          ,Item.UPCCode
          ,Item.PMUserSysNo
          ,Item.CurrentPrice
          ,Item.UnitCost
          ,Item.UnitCostWithoutTax
          ,Item.ItemPoint as Point
          ,basic.Weight
          ,basic.BriefName
	        ,isnull(Item.Month1SalesCount,0) M1
          ,isnull(Item.Week1SalesCount,0) Week1SalesCount
          ,isnull(shf.ShiftQty,0) ShiftQty
          ,productprice.VirtualPrice AS VirtualPrice
          ,ex.ProductTradeType
        FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo Item WITH(NOLOCK)
        INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo basic  WITH(NOLOCK)
           ON basic.SysNo = Item.SysNo
        INNER JOIN ipp3.dbo.Product_ex ex WITH(NOLOCK)
          ON ex.SysNo = basic.SysNo
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
		       ON shf.ProductSysNo = Item.SysNo
        LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productprice WITH(NOLOCK)
		       ON productprice.ProductSysNo = item.SysNo
        WHERE Item.SysNo = @ProductSysNo
          AND basic.Merchantsysno=@SellerSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@SellerSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetExtendPurchaseOrderItemInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      CurrentUnitCost =
          (
            SELECT  UnitCost
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      CurrentPrice =
          (
            SELECT TOP 1  CurrentPrice
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      LastOrderPrice=
          (
            SELECT TOP 1  LastPrice AS lastOrderPrice
            FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      AvailableQty = --每个Item在库存中应对应一条数据
          (
            SELECT TOP 1 SUM( isnull(OnlineQty,0) - isnull(VirtualQty,0)) FROM OverseaInventoryManagement.dbo.V_INM_Inventory  WITH(NOLOCK)
            WHERE ItemSysNumber = @ProductSysNo
          ),
      M1=
          (
            SELECT TOP 1 [m1] FROM [OverseaContentManagement].[dbo].[V_CM_ItemSaleTrendInfo]  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      LastAdjustPriceDate =
          (
            SELECT TOP 1 CreateDate AS LastAdjustPriceDate FROM OverseaContentManagement.dbo.V_IM_ProductPricechangeLog WITH(NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
            ORDER BY CreateDate DESC
          ),
      LastInTime =
          (
              SELECT TOP 1 LastInTime FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo WITH(NOLOCK)
              WHERE ProductSysNo = @ProductSysNo
          ),
       UnActivatyCount= (SELECT count(1) AS UnActivatyCount
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ProductSysNo
       )
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="IsVirtualStockPurchaseOrderProduct" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT [ItemSysNumber]
      ,Inv.[AccountQty]
      ,isnull(Inv.OnlineQty,0) - isnull(Inv.VirtualQty,0) AS AvailableQty
      ,Inv.[AllocatedQty]
      ,Inv.[OrderQty]
      ,Inv.[ConsignQty]
      ,Inv.[VirtualQty]
      ,Inv.[OnlineQty]
      ,Inv.[PurchaseQty]
      ,Inv.[ShiftQty]
      ,act.UnActivatyCount
      FROM OverseaInventoryManagement.dbo.V_INM_Inventory Inv WITH(NOLOCK)
      LEFT JOIN
      (SELECT count(1) AS UnActivatyCount
        ,ProductSysNo
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ItemSysNumber
        GROUP BY ProductSysNo
      ) act on act.ProductSysNo = Inv.ItemSysNumber
      WHERE ItemSysNumber = @ItemSysNumber
			]]>
    </commandText>
    <parameters>
      <param name="@ItemSysNumber" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductInventoryByProductSysNO" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT [ItemSysNumber]
      ,Inv.[AccountQty]
      ,isnull(Inv.OnlineQty,0) - isnull(Inv.VirtualQty,0) AS AvailableQty
      ,Inv.[AllocatedQty]
      ,Inv.[OrderQty]
      ,Inv.[ConsignQty]
      ,Inv.[VirtualQty]
      ,Inv.[OnlineQty]
      ,Inv.[PurchaseQty]
      ,Inv.[ShiftQty]
      ,act.UnActivatyCount
      FROM OverseaInventoryManagement.dbo.V_INM_Inventory Inv WITH(NOLOCK)
      LEFT JOIN 
      (SELECT count(1) AS UnActivatyCount 
        ,ProductSysNo
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ItemSysNumber
        GROUP BY ProductSysNo
      ) act on act.ProductSysNo = Inv.ItemSysNumber
      WHERE ItemSysNumber = @ItemSysNumber 
			]]>
    </commandText>
    <parameters>
      <param name="@ItemSysNumber" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductLastPOInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
    SELECT
    LastVendorSysNo,
    LastPrice,
    ProductSysNo
    FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1 WITH (NOLOCK)
    WHERE ProductSysNo = @ProductSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOMasterBySysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	      SELECT
          po.[SysNo]
          ,po.[POID] as [PurchaseOrderBasicInfo.PurchaseOrderID]
          ,po.[VendorSysNo]  as [SellerSysNo]
          ,po.[PaySettleCompany]  as [VendorInfo.VendorBasicInfo.PaySettleCompany]
          ,po.[StockSysNo] as  [PurchaseOrderBasicInfo.StockInfo.SysNo]
          ,po.[ShipTypeSysNo] as [PurchaseOrderBasicInfo.ShippingType.SysNo]
          ,po.[PayTypeSysNo] as [PurchaseOrderBasicInfo.PayType.SysNo]
          ,po.[CurrencySysNo] as [PurchaseOrderBasicInfo.CurrencyCode]
          ,po.[ExchangeRate] as [PurchaseOrderBasicInfo.ExchangeRate]
          ,po.[TotalAmt] as [PurchaseOrderBasicInfo.TotalAmt]
          ,po.[CreateTime] as [PurchaseOrderBasicInfo.CreateDate]
          ,po.[CreateUserSysNo] as [PurchaseOrderBasicInfo.CreateUserSysNo]
          ,po.[AuditTime] as [PurchaseOrderBasicInfo.AuditDate]
          ,po.[AuditUserSysNo] as [PurchaseOrderBasicInfo.AuditUserSysNo]
          ,po.[InTime] as [PurchaseOrderBasicInfo.InTime]
          ,po.[InUserSysNo] as [PurchaseOrderBasicInfo.InUserSysNo]
          ,po.[IsApportion] as [PurchaseOrderBasicInfo.IsApportion]
          ,po.[ApportionTime]
          ,po.[ApportionUserSysNo] as [PurchaseOrderBasicInfo.ApportionUserSysNo]
          ,po.[ETP] as [PurchaseOrderBasicInfo.ETP]
          ,po.[Memo] as [PurchaseOrderBasicInfo.MemoInfo.Memo]
          ,po.[Note] as [PurchaseOrderBasicInfo.MemoInfo.Note]
          ,po.[Status] as [PurchaseOrderBasicInfo.PurchaseOrderStatus]
          ,po.[IsConsign] as [PurchaseOrderBasicInfo.ConsignFlag]
          ,po.[POType] as [PurchaseOrderBasicInfo.PurchaseOrderType]
          ,po.[LeaseFlag] as [PurchaseOrderBasicInfo.PurchaseOrderLeaseFlag]
          ,po.[WHReceiptSN]
          ,po.[InStockMemo] as [PurchaseOrderBasicInfo.MemoInfo.InStockMemo]
          ,PMConfirmUser.DisplayName as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmUserName]
          --,po.[ComfirmUserSysNo] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[ComfirmTime] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[PartlyReceiveStatus]
          ,po.[CarriageCost]  as [PurchaseOrderBasicInfo.CarriageCost]
          ,po.[ExecptStatus] as [PurchaseOrderBasicInfo.PurchaseOrderExceptStatus]
          ,po.[CompanyCode]
          ,po.[PM_ReturnPointSysNo]  as [PurchaseOrderBasicInfo.PM_ReturnPointSysNo]
          ,po.[UsingReturnPoint]  as [PurchaseOrderBasicInfo.UsingReturnPoint]
          ,po.[ReturnPointC3SysNo] as [PurchaseOrderBasicInfo.ReturnPointC3SysNo]
          ,po.[TaxRate] as [PurchaseOrderBasicInfo.TaxRate]
          ,CONVERT(int ,po.[TaxRate] * 100)  as [PurchaseOrderBasicInfo.TaxRateType]
          ,po.[PurchaseStockSysno]  as [PurchaseOrderBasicInfo.PurchaseStockSysno]
          ,po.[PrintTime]
          ,po.[PMRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.PMRequestMemo]
          ,po.[TLRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.TLRequestMemo]
          ,po.[PMSysNo] [PurchaseOrderBasicInfo.ProductManager.SysNo]
          ,po.[SettlementCompany] as [PurchaseOrderBasicInfo.SettleCompanySysNo]
          ,po.ETATime as [PurchaseOrderBasicInfo.ETATimeInfo.ETATime]
          ,po.ETAHalfDay as [PurchaseOrderBasicInfo.ETATimeInfo.HalfDay]
          ,po.RefuseMemo as [PurchaseOrderBasicInfo.MemoInfo.RefuseMemo]
          ,po.ITStockSysNo as [PurchaseOrderBasicInfo.ITStockInfo.SysNo]
          ,po.ShiftSysNo as [PurchaseOrderBasicInfo.ShiftSysNo]
          ,po.CheckResult as [PurchaseOrderBasicInfo.CheckResult]
          ,po.Source as  [PurchaseOrderBasicInfo.Source]
          ,po.TPStatus as [PurchaseOrderBasicInfo.PurchaseOrderTPStatus]
          ,po.ContractNumber as [PurchaseOrderBasicInfo.ContractNumber]
          ,po.[AutoSendMail] as [PurchaseOrderBasicInfo.AutoSendMailAddress]
          ,po.[MailAddress] as [PurchaseOrderBasicInfo.MailAddress]
          ,Currency.CurrencySymbol as [PurchaseOrderBasicInfo.CurrencySymbol]
          ,Currency.CurrencyName as [PurchaseOrderBasicInfo.CurrencyName]
          ,Stock.StockName as [PurchaseOrderBasicInfo.StockInfo.StockName]
          ,Stock.ReceiveAddress
          ,Stock.ReceiveContact
          ,Stock.ReceiveContactPhone
          ,UserInfo.DisplayName as [PurchaseOrderBasicInfo.ProductManager.UserInfo.UserName]
          ,ShipType.ShipTypeName as [PurchaseOrderBasicInfo.ShippingType.ShippingTypeName]
          ,LocalCurrencySymbol=
          (
          SELECT TOP 1
          [CurrencySymbol]
          FROM [OverseaControlPanel].[dbo].[V_CP_Currency] WITH(nolock)
          WHERE IsLocal = 1
          )
          ,[PurchaseOrderBasicInfo.ARMCount]=
          (
          SELECT DISTINCT COUNT(1)
          FROM OverseaServiceManagement.dbo.V_SM_RMAOutboundMaster RMA_OutBound WITH(NOLOCK)
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMAOutboundTransaction RMA_OutBound_Item WITH (NOLOCK)
          on RMA_OutBound_Item.OutBoundSysNo = RMA_OutBound.SysNo
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister RMA_Register WITH (NOLOCK)
          on RMA_Register.SysNo = RMA_OutBound_Item.RegisterSysNo
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH (NOLOCK)
          on Product.SysNo = RMA_Register.ProductSysNo
          INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARequestTransaction] RMA_Request_Item WITH (NOLOCK)
          on RMA_Request_Item.RegisterSysNo = RMA_Register.Sysno
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster RMA_Request WITH(NOLOCK)
          on RMA_Request.SysNo = RMA_Request_Item.RequestSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master V_SO_Master WITH(NOLOCK)
          on V_SO_Master.SysNo = RMA_Request.SoSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item V_SO_Item WITH (NOLOCK)
          on (V_SO_Item.SOSysNo = V_SO_Master.SysNo and V_SO_Item.ProductSysNo = Product.SysNo)
          INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category3 WITH (NOLOCK)
          on product.Category3SysNo = category3.Category3Sysno
          LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sys_user WITH (NOLOCK)
          on Product.pmusersysno = sys_user.UserSysNo
          LEFT JOIN  IPP3.dbo.Vendor Vendor WITH (NOLOCK)
          on Vendor.SysNo=RMA_OutBound.VendorSysNo
          WHERE RMA_OutBound.VendorSysNo= po.[VendorSysNo]
          AND RMA_Register.ResponseDesc IS NOT NULL
          AND DateAdd(Day,15,RMA_OutBound.OutTime)<getdate()
          AND RMA_Register.Status=1
          AND RMA_Register.OutBoundStatus = 1
          )
          ,EIMSTotal=(
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
            WHERE POSysNo=po.SysNo
          )
          ,UsedEIMSTotal = (
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfoDetail WITH(NOLOCK)
            WHERE POSysNo = po.SysNo
          )
          ,pocount.AllPurchaseQty as [PurchaseOrderBasicInfo.PlanedPurchaseQty]
          ,pocount.AllQuantity as [PurchaseOrderBasicInfo.TotalQty]
          ,pocount.AllPrePurchaseQty as [PurchaseOrderBasicInfo.TotalPrePurchaseQty]
          FROM IPP3.dbo.po_master po  WITH (NOLOCK)
          LEFT JOIN  IPP3.dbo.Vendor v WITH (NOLOCK)
          ON po.VendorSysNo =V.SysNo
          LEFT JOIN OverseaControlPanel.dbo.V_CP_Currency Currency WITH (NOLOCK)
          ON  Currency.SysNo = po.CurrencySysNo
          LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Stock Stock WITH (NOLOCK)
          ON Stock.SysNo =po.StockSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK)
           ON UserInfo.UserSysNo = po.PMSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS PMConfirmUser WITH(NOLOCK)
           ON PMConfirmUser.UserSysNo = po.[ComfirmUserSysNo]
          LEFT JOIN [OverseaControlPanel].[dbo].[V_CP_ShipType] ShipType WITH(NOLOCK)
           ON ShipType.SysNo =po.ShipTypeSysNo
          LEFT OUTER JOIN
            (
              SELECT POSysNo
                    ,SUM(PurchaseQty) AS AllPurchaseQty
                    , SUM(Quantity)  AS AllQuantity
                    ,SUM(PrePurchaseQty) AS AllPrePurchaseQty
              FROM IPP3.dbo.PO_Item
              GROUP BY POSysNo
            ) pocount ON pocount.POSysNo = po.sysno
          WHERE po.SysNo =@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOMaster" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	      SELECT
          po.[SysNo]
          ,po.[POID] as [PurchaseOrderBasicInfo.PurchaseOrderID]
          ,po.[VendorSysNo]  as [SellerSysNo]
          ,po.[PaySettleCompany]  as [VendorInfo.VendorBasicInfo.PaySettleCompany]
          ,po.[StockSysNo] as  [PurchaseOrderBasicInfo.StockInfo.SysNo]
          ,po.[ShipTypeSysNo] as [PurchaseOrderBasicInfo.ShippingType.SysNo]
          ,po.[PayTypeSysNo] as [PurchaseOrderBasicInfo.PayType.SysNo]
          ,po.[CurrencySysNo] as [PurchaseOrderBasicInfo.CurrencyCode]
          ,po.[ExchangeRate] as [PurchaseOrderBasicInfo.ExchangeRate]
          ,po.[TotalAmt] as [PurchaseOrderBasicInfo.TotalAmt]
          ,po.[CreateTime] as [PurchaseOrderBasicInfo.CreateDate]
          ,po.[CreateUserSysNo] as [PurchaseOrderBasicInfo.CreateUserSysNo]
          ,po.[AuditTime] as [PurchaseOrderBasicInfo.AuditDate]
          ,po.[AuditUserSysNo] as [PurchaseOrderBasicInfo.AuditUserSysNo]
          ,po.[InTime] as [PurchaseOrderBasicInfo.InTime]
          ,po.[InUserSysNo] as [PurchaseOrderBasicInfo.InUserSysNo]
          ,po.[IsApportion] as [PurchaseOrderBasicInfo.IsApportion]
          ,po.[ApportionTime]
          ,po.[ApportionUserSysNo] as [PurchaseOrderBasicInfo.ApportionUserSysNo]
          ,po.[ETP] as [PurchaseOrderBasicInfo.ETP]
          ,po.[Memo] as [PurchaseOrderBasicInfo.MemoInfo.Memo]
          ,po.[Note] as [PurchaseOrderBasicInfo.MemoInfo.Note]
          ,po.[Status] as [PurchaseOrderBasicInfo.PurchaseOrderStatus]
          ,po.[IsConsign] as [PurchaseOrderBasicInfo.ConsignFlag]
          ,po.[POType] as [PurchaseOrderBasicInfo.PurchaseOrderType]
          ,po.[LeaseFlag] as [PurchaseOrderBasicInfo.PurchaseOrderLeaseFlag]
          ,po.[WHReceiptSN]
          ,po.[InStockMemo] as [PurchaseOrderBasicInfo.MemoInfo.InStockMemo]
          ,PMConfirmUser.DisplayName as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmUserName]
          --,po.[ComfirmUserSysNo] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[ComfirmTime] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[PartlyReceiveStatus]
          ,po.[CarriageCost]  as [PurchaseOrderBasicInfo.CarriageCost]
          ,po.[ExecptStatus] as [PurchaseOrderBasicInfo.PurchaseOrderExceptStatus]
          ,po.[CompanyCode]
          ,po.[PM_ReturnPointSysNo]  as [PurchaseOrderBasicInfo.PM_ReturnPointSysNo]
          ,po.[UsingReturnPoint]  as [PurchaseOrderBasicInfo.UsingReturnPoint]
          ,po.[ReturnPointC3SysNo] as [PurchaseOrderBasicInfo.ReturnPointC3SysNo]
          ,po.[TaxRate] as [PurchaseOrderBasicInfo.TaxRate]
          ,CONVERT(int ,po.[TaxRate] * 100)  as [PurchaseOrderBasicInfo.TaxRateType]
          ,po.[PurchaseStockSysno]  as [PurchaseOrderBasicInfo.PurchaseStockSysno]
          ,po.[PrintTime]
          ,po.[PMRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.PMRequestMemo]
          ,po.[TLRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.TLRequestMemo]
          ,po.[PMSysNo] [PurchaseOrderBasicInfo.ProductManager.SysNo]
          ,po.[SettlementCompany] as [PurchaseOrderBasicInfo.SettleCompanySysNo]
          ,po.ETATime as [PurchaseOrderBasicInfo.ETATimeInfo.ETATime]
          ,po.ETAHalfDay as [PurchaseOrderBasicInfo.ETATimeInfo.HalfDay]
          ,po.RefuseMemo as [PurchaseOrderBasicInfo.MemoInfo.RefuseMemo]
          ,po.ITStockSysNo as [PurchaseOrderBasicInfo.ITStockInfo.SysNo]
          ,po.ShiftSysNo as [PurchaseOrderBasicInfo.ShiftSysNo]
          ,po.CheckResult as [PurchaseOrderBasicInfo.CheckResult]
          ,po.Source as  [PurchaseOrderBasicInfo.Source]
          ,po.TPStatus as [PurchaseOrderBasicInfo.PurchaseOrderTPStatus]
          ,po.ContractNumber as [PurchaseOrderBasicInfo.ContractNumber]
          ,po.[AutoSendMail] as [PurchaseOrderBasicInfo.AutoSendMailAddress]
          ,po.[MailAddress] as [PurchaseOrderBasicInfo.MailAddress]
          ,Currency.CurrencySymbol as [PurchaseOrderBasicInfo.CurrencySymbol]
          ,Currency.CurrencyName as [PurchaseOrderBasicInfo.CurrencyName]
          ,Stock.StockName as [PurchaseOrderBasicInfo.StockInfo.StockName]
          ,Stock.ReceiveAddress
          ,Stock.ReceiveContact
          ,Stock.ReceiveContactPhone
          ,UserInfo.DisplayName as [PurchaseOrderBasicInfo.ProductManager.UserInfo.UserName]
          ,ShipType.ShipTypeName as [PurchaseOrderBasicInfo.ShippingType.ShippingTypeName]
          ,LocalCurrencySymbol=
          (
          SELECT TOP 1
          [CurrencySymbol]
          FROM [OverseaControlPanel].[dbo].[V_CP_Currency] WITH(nolock)
          WHERE IsLocal = 1
          )
          ,[PurchaseOrderBasicInfo.ARMCount]=
          (
          SELECT DISTINCT COUNT(1)
          FROM OverseaServiceManagement.dbo.V_SM_RMAOutboundMaster RMA_OutBound WITH(NOLOCK)
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMAOutboundTransaction RMA_OutBound_Item WITH (NOLOCK)
          on RMA_OutBound_Item.OutBoundSysNo = RMA_OutBound.SysNo
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister RMA_Register WITH (NOLOCK)
          on RMA_Register.SysNo = RMA_OutBound_Item.RegisterSysNo
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH (NOLOCK)
          on Product.SysNo = RMA_Register.ProductSysNo
          INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARequestTransaction] RMA_Request_Item WITH (NOLOCK)
          on RMA_Request_Item.RegisterSysNo = RMA_Register.Sysno
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster RMA_Request WITH(NOLOCK)
          on RMA_Request.SysNo = RMA_Request_Item.RequestSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master V_SO_Master WITH(NOLOCK)
          on V_SO_Master.SysNo = RMA_Request.SoSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item V_SO_Item WITH (NOLOCK)
          on (V_SO_Item.SOSysNo = V_SO_Master.SysNo and V_SO_Item.ProductSysNo = Product.SysNo)
          INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category3 WITH (NOLOCK)
          on product.Category3SysNo = category3.Category3Sysno
          LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sys_user WITH (NOLOCK)
          on Product.pmusersysno = sys_user.UserSysNo
          LEFT JOIN  IPP3.dbo.Vendor Vendor WITH (NOLOCK)
          on Vendor.SysNo=RMA_OutBound.VendorSysNo
          WHERE RMA_OutBound.VendorSysNo= po.[VendorSysNo]
          AND RMA_Register.ResponseDesc IS NOT NULL
          AND DateAdd(Day,15,RMA_OutBound.OutTime)<getdate()
          AND RMA_Register.Status=1
          AND RMA_Register.OutBoundStatus = 1
          )
          ,EIMSTotal=(
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
            WHERE POSysNo=po.SysNo
          )
          ,UsedEIMSTotal = (
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfoDetail WITH(NOLOCK)
            WHERE POSysNo = po.SysNo
          )
          ,pocount.AllPurchaseQty as [PurchaseOrderBasicInfo.PlanedPurchaseQty]
          ,pocount.AllQuantity as [PurchaseOrderBasicInfo.TotalQty]
          ,pocount.AllPrePurchaseQty as [PurchaseOrderBasicInfo.TotalPrePurchaseQty]
          FROM IPP3.dbo.po_master po  WITH (NOLOCK)
          LEFT JOIN  IPP3.dbo.Vendor v WITH (NOLOCK)
          ON po.VendorSysNo =V.SysNo
          LEFT JOIN OverseaControlPanel.dbo.V_CP_Currency Currency WITH (NOLOCK)
          ON  Currency.SysNo = po.CurrencySysNo
          LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Stock Stock WITH (NOLOCK)
          ON Stock.SysNo =po.StockSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK)
           ON UserInfo.UserSysNo = po.PMSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS PMConfirmUser WITH(NOLOCK)
           ON PMConfirmUser.UserSysNo = po.[ComfirmUserSysNo]
          LEFT JOIN [OverseaControlPanel].[dbo].[V_CP_ShipType] ShipType WITH(NOLOCK)
           ON ShipType.SysNo =po.ShipTypeSysNo
          LEFT OUTER JOIN
            (
              SELECT POSysNo
                    ,SUM(PurchaseQty) AS AllPurchaseQty
                    , SUM(Quantity)  AS AllQuantity
                    ,SUM(PrePurchaseQty) AS AllPrePurchaseQty
              FROM IPP3.dbo.PO_Item
              GROUP BY POSysNo
            ) pocount ON pocount.POSysNo = po.sysno
          WHERE po.SysNo =@SysNo
          AND po.VendorSysNo=@VendorSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@VendorSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>


  <dataCommand name="GetPOETA" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT  [Sysno]  as [ETATimeSysNo]
	             ,[POSysNo]
	             ,[ETATime]
	             ,[HalfDay]
	             ,[STATUS] as [Status]
	             ,[Memo]
	             ,[Indate]
	             ,[InUser]
	             ,[EditDate]
	             ,[EditUser]
        FROM IPP3.dbo.PO_ETA WITH(NOLOCK)
        WHERE POSysNo=@POSysNo AND [Status]=1
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOItemsByPOSysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	  SELECT
		 item.[SysNo] as [ItemSysNo]
    ,item.BatchInfo as [BatchInfo]
		,item.[POSysNo] as [POSysNo]
		,item.[ProductSysNo] as [ProductSysNo]
		,item.[Quantity] as [Quantity]
		,item.[Weight] as [Weight]
		,item.[OrderPrice] as [OrderPrice]
		,item.[ApportionAddOn] as [ApportionAddOn]
		,item.[ReturnCost] as [ReturnCost]
		,item.[PurchaseQty] as [PurchaseQty]
		,item.[CheckStatus] as [CheckStatus]
		,item.[CheckReasonMemo] as [CheckReasonMemo]
		,item.[ExecptStatus] as [ExecptStatus]
		,product.[ProductID] as [ProductID]
		,item.[UnitCostWithoutTax] as [UnitCostWithoutTax]
		,item.[JDPrice] as [JingDongPrice]
		,item.[AvailableQty] as [AvailableQty]
		,item.[m1] as [M1]
		,item.[UnitCost] as [UnitCost]
		,item.[CurrentUnitCost] as [CurrentUnitCost]
		,item.[LastAdjustPriceDate] as [LastAdjustPriceDate]
		,item.[lastOrderPrice] as [LastOrderPrice]
		,item.[LastInTime] as [LastInTime]
    ,item.AcquireReturnPointType  as [AcquireReturnPointType]
    ,item.AcquireReturnPoint  as [AcquireReturnPoint]
    ,item.ReadyQuantity as [ReadyQuantity]
		,product.ProductMode as [ProductMode]
    ,product.BMCode as [BMCode]
    ,product.UPCCode as [UPCCode]
		,product.ProductTitle as [ProductName]
    ,product.ProductName AS [BriefName]
		,product.CurrentPrice as [CurrentPrice]
		,isnull(product.Week1SalesCount,0) as [Week1SalesCount]
		,isnull(shf.ShiftQty,0)as [ShiftQty]
    ,isnull(v_pps.PurchasePrice,0) as [PurchasePrice]
    , (CASE WHEN product.Vfitem = 'N' THEN 0 ELSE 1 END) as [IsVFItem]
    ,productPrice.VirtualPrice AS [VirtualPrice]
    ,isnull( h.UnActivatyCount,0) AS UnActivatyCount
    ,proEx.IsBatch AS IsBatch
    ,item.CompanyCode
    ,item.PrePurchaseQty
	FROM ipp3.dbo.po_item as item WITH (NOLOCK)
	LEFT JOIN OverseaContentManagement.dbo.V_CM_ItemCommonInfo as product WITH (NOLOCK)
	ON product.SysNo = item.[ProductSysNo]
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
	ON shf.ProductSysNo = Item.[ProductSysNo]
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_Mapping as v_mapping WITH (NOLOCK)
  ON v_mapping.ProductSysno = item.ProductSysNo
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_SynProduct v_pps WITH(NOLOCK)
  ON v_pps.ProductMappingSysNo = v_mapping.SysNo
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productPrice WITH(NOLOCK)
  ON  productPrice.ProductSysNo = product.SysNo
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Ex proEx WITH(NOLOCK)
  ON proEx.PreviousProductSysNo = product.SysNo
  LEFT JOIN (
      SELECT count(1) AS UnActivatyCount
             ,ProductSysNo
      FROM  OverseaInventoryManagement.dbo.Product_Batch WITH(NOLOCK)
      WHERE Status IN ('R','I')
      Group By ProductSysNo
      ) h 
    ON h.ProductSysNo = item.ProductSysNo
   WHERE  item.POSysNo = @POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	SELECT
		[purno] POSysNo
		,SUM(ISNULL(TotalAmt,0)) SumTotalAmt
		,SUM(ISNULL(EIMSAmt,0))  SumEIMSAmt
	FROM [Scm].[dbo].[poLog]
	WHERE [purno]=@POSysNo
	GROUP BY [purno]
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOReceivedInfoByPOSysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT distinct pr.[Vendno]  VenderSysNo
			  ,pr.[Purno] as [POSysNo]
			  ,p.SysNo as [ProductSysNo]
			  ,pr.[Item] as [ProductID]
			  ,pr.[BatchNumber]
			  ,pr.Descrip as [ProductName]
			  ,pr.[WarehouseNumber]
			  ,pr.[ReceivedQuantity]
			  ,pr.[ReceivedDate]
			  ,pr.[ReceivedUser]
		FROM [Scm].[dbo].[POReceivedDetail]  pr WITH(NOLOCK)
		LEFT  JOIN OverseaContentManagement.dbo.V_IM_Product  p  WITH(NOLOCK)
		ON p.ProductID=pr.[Item]
		WHERE pr.[Purno]=@POSysNo
		ORDER BY pr.[ReceivedDate]
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOSequence" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	     INSERT INTO ipp3.dbo.PO_Sequence
	      (
          createtime
	      )
	      VALUES(
	        getdate()
	      )
        SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="CreatePOMaster" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	      INSERT INTO ipp3.dbo.PO_Master
        (
        SysNo
        ,POID
        ,VendorSysNo
        ,StockSysNo
        ,ShipTypeSysNo
        ,PayTypeSysNo
        ,CurrencySysNo
        ,ExchangeRate
        ,TotalAmt
        ,CreateTime
        ,CreateUserSysNo
        ,AuditTime
        ,AuditUserSysNo
        ,InTime
        ,InUserSysNo
        ,IsApportion
        ,ApportionTime
        ,ApportionUserSysNo
        ,Memo
        ,InStockMemo
        ,Status
        ,ETP
        ,IsConsign
        ,POType
        ,TaxRate
        ,PurchaseStockSysno
        ,PMSysNo
        ,CompanyCode
		,ETATime
		,ETAHalfDay
		,ITStockSysNo
    ,AutoSendMail
        )
        VALUES
        (
        @SysNo
        ,@POID
        ,@VendorSysNo
        ,@StockSysNo
        ,@ShipTypeSysNo
        ,@PayTypeSysNo
        ,@CurrencySysNo
        ,@ExchangeRate
        ,@TotalAmt
        ,@CreateTime
        ,@CreateUserSysNo
        ,@AuditTime
        ,@AuditUserSysNo
        ,@InTime
        ,@InUserSysNo
        ,@IsApportion
        ,@ApportionTime
        ,@ApportionUserSysNo
        ,@Memo
        ,@InStockMemo
        ,@Status
        ,@ETP
        ,@IsConsign
        ,@POType
        ,@TaxRate
        ,@PurchaseStockSysno
        ,@PMSysNo
        ,@CompanyCode
		,@ETATime
		,@ETAHalfDay
		,@ITStockSysNo
    ,@AutoSendMail
        )
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POID" dbType="String" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@ShipTypeSysNo" dbType="Int32" />
      <param name="@PayTypeSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@ExchangeRate" dbType="Decimal" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@CreateUserSysNo" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@InTime" dbType="DateTime" />
      <param name="@InUserSysNo" dbType="Int32" />
      <param name="@IsApportion" dbType="Int32" />
      <param name="@ApportionTime" dbType="DateTime" />
      <param name="@ApportionUserSysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@InStockMemo" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@IsConsign" dbType="Int32" />
      <param name="@POType" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />
      <param name="@PurchaseStockSysno" dbType="Int32" />
      <param name="@PMSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="Int32" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="String" />
      <param name="@ITStockSysNo" dbType="Int32" />
      <param name="@AutoSendMail" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOItems" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	    INSERT INTO IPP3.dbo.PO_Item
				  (
				  POSysNo
				  ,ProductSysNo
				  ,BriefName
				  ,Quantity
				  ,Weight
				  ,OrderPrice
				  ,ApportionAddOn
				  ,UnitCost
				  ,ReturnCost
				  ,PurchaseQty
				  ,CheckStatus
				  ,CheckReasonMemo
				  ,lastOrderPrice
				  ,ExecptStatus
				  ,ProductID
				  ,UnitCostWithoutTax
				  ,AvailableQty
				  ,m1
				  ,CompanyCode
				  ,CurrencySysNo
          ,BatchInfo
          ,CurrentPrice
          ,CurrentUnitCost
          ,PrePurchaseQty
				  )
      VALUES (
			  @POSysNo
			  ,@ProductSysNo
			  ,@BriefName
			  ,@Quantity
			  ,@Weight
			  ,@OrderPrice
			  ,@ApportionAddOn
			  ,@UnitCost
			  ,@ReturnCost
			  ,@PurchaseQty
			  ,1
			  ,''
			  ,@lastOrderPrice
			  ,@ExecptStatus
			  ,@ProductID
			  ,@UnitCostWithoutTax
			  ,@AvailableQty
			  ,@m1
			  ,@CompanyCode
			  ,@CurrencySysNo
        ,@BatchInfo
        ,@CurrentPrice
        ,@CurrentUnitCost
        ,@PrePurchaseQty
			  )
      SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@BriefName" dbType="String" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@Weight" dbType="Int32" />
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@ApportionAddOn" dbType="Decimal" />
      <param name="@UnitCost" dbType="Decimal" />
      <param name="@ReturnCost" dbType="Decimal" />
      <param name="@lastOrderPrice" dbType="Decimal" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@ProductID" dbType="String" />
      <param name="@UnitCostWithoutTax" dbType="Decimal" />
      <param name="@AvailableQty" dbType="Int32" />
      <param name="@m1" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@BatchInfo" dbType="String" />
      <param name="@CurrentPrice" dbType="Decimal" />
      <param name="@CurrentUnitCost" dbType="Decimal" />
      <param name="@PrePurchaseQty" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOStatus" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE [IPP3].[dbo].[PO_Master]
          Set
			  Status=@Status,
			  RefuseMemo=@RefuseMemo,
		      TPStatus=@TPStatus,
          AuditTime=@AuditDate,
			  AuditUserSysNo=@AuditUserSysNo,
        AuditUserName=@AuditUserName,
			  PMRequestMemo=@PMRequestMemo
		  Where SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefuseMemo" dbType="String" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TPStatus" dbType="AnsiStringFixedLength" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditDate" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@AuditUserName" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOETAInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          INSERT INTO [IPP3].[dbo].[PO_ETA]
           ([POSysNo]
           ,[ETATime]
           ,[HalfDay]
           ,[STATUS]
           ,[Indate]
           ,[InUser]
           )
		 VALUES
           (@POSysNo
           ,@ETATime
           ,@HalfDay
           ,1
           ,getdate()
           ,@InUser
           )
       SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ETATime" dbType="DateTime" />
      <param name="@HalfDay" dbType="AnsiStringFixedLength"/>
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOETAInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE [IPP3].[dbo].[PO_ETA]
           SET [STATUS]=@Status,
		       EditDate=getdate(),
			   EditUser=@EditUser
         WHERE POSysNo=@POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@EditUser" dbType="String" />
    </parameters>
  </dataCommand>


  <dataCommand name="UpdatePOItemStatusVerifyInStock" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE ipp3.[dbo].[PO_Master]
         SET Status = @Status
            ,ApportionTime = @ApportionTime
            ,ApportionUserSysNo = @ApportionUserSysNo
            ,AuditTime = @AuditTime
            ,AuditUserSysNo = @AuditUserSysNo
            ,PMRequestMemo = @PMRequestMemo
            ,ETP = @ETP
			      ,ETATime=@ETATime
			      ,ETAHalfDay=@ETAHalfDay
			      ,TPStatus=case @Status
            WHEN 5 THEN @TPStatus
					  ELSE ''
					  END
            ,RefuseMemo=@RefuseMemo
        WHERE   [SysNo] = @SysNo  AND Status in(12)

			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="AnsiStringFixedLength" />
      <param name="@TPStatus" dbType="String" />
      <param name="@RefuseMemo" dbType="String" />
      <param name="@ApportionTime" dbType="DateTime" />
      <param name="@ApportionUserSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetJDPriceAndM1AndAndAvailableQty" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
SELECT
      CurrentUnitCost =
          (
            SELECT  UnitCost
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      CurrentPrice =
          (
            SELECT TOP 1  CurrentPrice
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      LastOrderPrice=
          (
            SELECT TOP 1  LastPrice AS lastOrderPrice
            FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      AvailableQty = --每个Item在库存中应对应一条数据
          (
            SELECT TOP 1 SUM( isnull(OnlineQty,0) - isnull(VirtualQty,0)) FROM OverseaInventoryManagement.dbo.V_INM_Inventory  WITH(NOLOCK)
            WHERE ItemSysNumber = @ProductSysNo
          ),
      M1=
          (
            SELECT TOP 1 [m1] FROM [OverseaContentManagement].[dbo].[V_CM_ItemSaleTrendInfo]  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      JingDongPrice=
          (
            SELECT TOP 1 JDPrice FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo  WITH(NOLOCK)
            WHERE SysNo = @ProductSysNo
          ),
      LastAdjustPriceDate =
          (
            SELECT TOP 1 CreateDate AS LastAdjustPriceDate FROM OverseaContentManagement.dbo.V_IM_ProductPricechangeLog WITH(NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
            ORDER BY CreateDate DESC
          ),
      LastInTime =
          (
              SELECT TOP 1 LastInTime FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo WITH(NOLOCK)
              WHERE ProductSysNo = @ProductSysNo
          ),
       UnActivatyCount= (SELECT count(1) AS UnActivatyCount
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ProductSysNo
       )
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOItem" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	      UPDATE ipp3.dbo.PO_Item SET
        POSysNo=@POSysNo
        ,ProductSysNo=@ProductSysNo
        ,BriefName=@BriefName
        ,Quantity=@Quantity
        ,Weight=@Weight
        ,OrderPrice=@OrderPrice
        ,ApportionAddOn=@ApportionAddOn
        ,UnitCost=@UnitCost
        ,ReturnCost=@ReturnCost
        ,lastOrderPrice=@lastOrderPrice
        ,ExecptStatus=@ExecptStatus
        ,UnitCostWithoutTax=@UnitCostWithoutTax
        ,AvailableQty=@AvailableQty
        ,PurchaseQty = @PurchaseQty
        ,m1=@m1
        ,CurrencySysNo = @CurrencySysNo
        ,CurrentUnitCost = @CurrentUnitCost
        ,CurrentPrice = @CurrentPrice
        ,LastAdjustPriceDate = @LastAdjustPriceDate
        ,LastInTime = @LastInTime
        WHERE
        SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@BriefName" dbType="String" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@Weight" dbType="Int32" />
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@ApportionAddOn" dbType="Decimal" />
      <param name="@UnitCost" dbType="Decimal" />
      <param name="@ReturnCost" dbType="Decimal" />
      <param name="@lastOrderPrice" dbType="Decimal" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@UnitCostWithoutTax" dbType="Decimal" />
      <param name="@AvailableQty" dbType="Int32" />
      <param name="@m1" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@CurrentUnitCost" dbType="Decimal" />
      <param name="@CurrentPrice" dbType="Decimal" />
      <param name="@LastAdjustPriceDate" dbType="DateTime" />
      <param name="@LastInTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOItemPurchaseQty" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
	    IF EXISTS(SELECT TOP 1 1 FROM  ipp3.dbo.PO_Item (NOLOCK) WHERE SysNo = @SysNo)
BEGIN
UPDATE ipp3.dbo.PO_Item 
SET PurchaseQty = @PurchaseQty WHERE SysNo = @SysNo
END
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="IsBatchProductInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT SysNo AS  ProductSysNo
      FROM OverseaContentManagement.dbo.V_IM_Product_Ex pe WITH(nolock)
      WHERE pe.IsBatch = 'Y' AND pe.SysNo = @PreviousProductSysNo
  		]]>
    </commandText>
    <parameters>
      <param name="@PreviousProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOSSBLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT [SysNo]
          ,[POSysNo]
          ,[Content]
          ,[ActionType]
          ,[InUser]
          ,[Indate]
          ,[ErrMSg]
          ,[ErrMSgTime]
          ,[SendErrMail]
          ,[CompanyCode]
          ,[LanguageCode]
          ,[StoreCompanyCode]
      FROM [OverseaPOASNManagement].[dbo].[POSSB_Log] WITH(NOLOCK)
      WHERE POSysNo = @POSysNo
      AND ActionType = @ActionType
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ActionType" dbType="StringFixedLength" />
    </parameters>
  </dataCommand>


  <dataCommand name="GetProductAccessoriesByProductSysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
WITH temp as
(
  SELECT
  Product.ProductID,
  Accessories.AccessoriesName
  FROM  OverseaContentManagement.dbo.V_CM_Product_Accessories Product_Accessories WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH(NOLOCK)
  ON Product_Accessories.ProductSysno = Product.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_CM_Accessories Accessories WITH(NOLOCK)
  ON Product_Accessories.AccessoriesSysno = Accessories.Sysno
  #StrWhere# OtherCondition
  UNION ALL
  SELECT
  item.ProductID,
  product.BriefName AS AccessoriesName
  FROM  OverseaContentManagement.dbo.V_IM_Product_Attachment atc WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo item WITH(NOLOCK)
  ON atc.ProductSysno = item.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
  ON atc.ProductAttachmentSysNo = product.Sysno
  WHERE  product.status = 2 AND #CustomCondition#
)
SELECT row_number() OVER(ORDER BY ProductID) as rowNumber
,ProductID
,STUFF
(
  (
        SELECT ' '+ltrim(rtrim(AccessoriesName)
  )
  FROM temp t WHERE ProductID=temp.ProductID FOR XML PATH('')), 1, 1, ''
) as Description
FROM temp GROUP BY ProductID
			]]>
    </commandText>
  </dataCommand>


  <dataCommand name="UpdateStockInfoForAdjust" database="Write" commandType="Text">
    <commandText>
      <![CDATA[

--更新分仓库存:
IF EXISTS(SELECT TOP 1 1 FROM [IPP3].[dbo].[Inventory_Stock](NOLOCK) WHERE StockSysNo = @StockSysNo And ProductSysNo = @ProductSysNo)
BEGIN
  UPDATE [IPP3].[dbo].[Inventory_Stock]
  SET [AvailableQty] = [AvailableQty] + @Qty
  WHERE StockSysNo = @StockSysNo And ProductSysNo = @ProductSysNo
END
ELSE
BEGIN
  INSERT INTO [IPP3].[dbo].[Inventory_Stock]
             ([StockSysNo]
             ,[ProductSysNo]
             ,[AccountQty]
             ,[AvailableQty]
             ,[AllocatedQty]
             ,[OrderQty]
             ,[PurchaseQty]
             ,[ShiftInQty]
             ,[ShiftOutQty]
             ,[SafeQty]
             ,[Position1]
             ,[Position2]
             ,[ConsignQty]
             ,[VirtualQty]
             ,[DMSValue]
             ,[SaleDays]
             ,[CompanyCode]
             ,[LanguageCode]
             ,[StoreCompanyCode]
             ,[ReservedQty]
             ,[InvalidQty]
             ,[ChannelQty])
       VALUES
             (@StockSysNo
             ,@ProductSysNo
             ,0
             ,@Qty
             ,0
             ,0
             ,0
             ,0
             ,0
             ,0
             ,null
             ,null
             ,0
             ,0
             ,0
             ,0
             ,'8601'
             ,'zh-CN'
             ,'8601'
             ,0
             ,0
             ,0)
END

--更新总仓库存
UPDATE [IPP3].[dbo].[Inventory]
SET [AvailableQty] = [AvailableQty] + @Qty
WHERE ProductSysNo = @ProductSysNo

  		]]>
    </commandText>
    <parameters>
      <param name="@Qty" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

</dataOperations>
