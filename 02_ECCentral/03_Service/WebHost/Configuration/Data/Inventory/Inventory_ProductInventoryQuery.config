<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  
  <dataCommand name="QueryInventory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
          @TotalCount = COUNT(a.ProductSysNo) 
        FROM IPP3.dbo.Inventory a WITH(NOLOCK) 
        INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
        ON a.ProductSysNo = b.SysNo
		    LEFT JOIN IPP3.dbo.Manufacturer mf WITH(NOLOCK)
		    ON mf.SysNo = b.ManufacturerSysNo
		    LEFT JOIN OverseaContentManagement.dbo.Brand bd WITH(NOLOCK)
		    ON bd.SysNo = b.BrandSysNo
		    INNER JOIN IPP3.dbo.Category3 c3 WITH(NOLOCK)
		    ON b.Category3SysNo=c3.SysNo
		    INNER JOIN IPP3.dbo.Category2 c2 WITH(NOLOCK)
		    ON c3.C2SysNo=c2.SysNo
		    INNER JOIN IPP3.dbo.Category1 c1 WITH(NOLOCK)
		    ON c2.C1SysNo=c1.SysNo
        INNER JOIN IPP3.dbo.[Product_Ex] pe WITH(NOLOCK)
		    ON pe.SysNo=b.SysNo
        LEFT JOIN
        (
	        SELECT DISTINCT pl.ProductSysNo,pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
	        INNER JOIN 
	        (
	        SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) GROUP BY plp.ProductSysNo
	        )pp 
	        ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
        ) plm
        ON plm.ProductSysNo = a.ProductSysNo
        #StrWhere#

        SELECT 
			    ProductSysNo,
			    ProductID,
			    IsConsign,
			    ProductName,
			    AccountQty,
			    AvailableQty,
			    AllocatedQty,
			    OrderQty,
			    AActivedQty,
			    IActivedQty,
			    RActivedQty,
			    VirtualQty,
			    ConsignQty,
			    PurchaseQty,
			    UnPayOrderQty,
          CostAmount,
			    CompanyCode,
			    LanguageCode,
          VendorName,
          RetainQty,
          SafeQty
        FROM
        (
	        SELECT TOP (@EndNumber) 
				    a.ProductSysNo,
				    b.ProductID,
				    ISNULL(b.IsConsign,0) AS IsConsign,   --是否代销商品
			      b.ProductName,
			      a.AccountQty,
			      a.AvailableQty,
			      a.AllocatedQty,
			      a.OrderQty,
			      a.VirtualQty,
			      a.ConsignQty,
				    a.PurchaseQty,
				    a.CompanyCode,
				    a.LanguageCode,
				    SA.ActivedQty AS AActivedQty,
				    SI.ActivedQty AS IActivedQty,
				    SR.ActivedQty AS RActivedQty,
				    0 AS UnPayOrderQty,
            (SELECT ISNULL(SUM (LEFTQUANTITY*COST*ISNULL(ExchangeRate,1)),0) FROM OverseaInventoryManagement.dbo.ProductCostIn WITH(NOLOCK)WHERE ProductSysNo=a.ProductSysNo) AS CostAmount,
            (SELECT TOP 1 VendorName FROM ipp3.dbo.product_lastpoinfo L WITH(NOLOCK) INNER JOIN ipp3.dbo.Vendor V WITH(NOLOCK) ON V.SysNo = L.LastVendorSysNo AND L.ProductSysNo = plm.ProductSysNo ORDER BY L.SysNo DESC) AS VendorName,
            ISNULL(a.RetainQty,0) as RetainQty,
            pe.[SafeQty] AS SafeQty,
	          (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
	        FROM IPP3.dbo.Inventory a WITH(NOLOCK) 
			    INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
			    ON a.ProductSysNo = b.SysNo
			    LEFT JOIN IPP3.dbo.Manufacturer mf WITH(NOLOCK)
			    ON mf.SysNo = b.ManufacturerSysNo
			    LEFT JOIN OverseaContentManagement.dbo.Brand bd WITH(NOLOCK)
			    ON bd.SysNo = b.BrandSysNo
			    INNER JOIN IPP3.dbo.Category3 c3 WITH(NOLOCK)
			    ON b.Category3SysNo=c3.SysNo
			    INNER JOIN IPP3.dbo.Category2 c2 WITH(NOLOCK)
			    ON c3.C2SysNo=c2.SysNo
			    INNER JOIN IPP3.dbo.Category1 c1 WITH(NOLOCK)
			    ON c2.C1SysNo=c1.SysNo
          INNER JOIN IPP3.dbo.[Product_Ex] pe WITH(NOLOCK)
		      ON pe.SysNo=b.SysNo
          LEFT JOIN
          (
	          SELECT DISTINCT pl.ProductSysNo,pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
	          INNER JOIN 
	          (
	          SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) GROUP BY plp.ProductSysNo
	          )pp 
	          ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
          ) plm
          ON plm.ProductSysNo = a.ProductSysNo
          LEFT JOIN 
          (
			      SELECT 
                ProductSysNo
               ,ISNULL(SUM(PB.ActualQty),0) AS  ActivedQty 
            FROM OverseaInventoryManagement.dbo.V_INM_ProductBatch PB WITH(NOLOCK) 
            WHERE 
                PB.Status='A' 
            GROUP BY ProductSysNo 
          ) SA
          ON a.ProductSysNo =SA.ProductSysNo
          LEFT JOIN 
          (
			      SELECT 
                ProductSysNo
               ,ISNULL(SUM(PB.ActualQty),0) AS  ActivedQty 
            FROM OverseaInventoryManagement.dbo.V_INM_ProductBatch PB WITH(NOLOCK) 
            WHERE 
                PB.Status='I' 
            GROUP BY ProductSysNo 
          ) SI
          ON a.ProductSysNo =SI.ProductSysNo
          LEFT JOIN 
          (
			      SELECT 
                ProductSysNo
               ,ISNULL(SUM(PB.ActualQty),0) AS  ActivedQty 
            FROM OverseaInventoryManagement.dbo.V_INM_ProductBatch PB WITH(NOLOCK) 
            WHERE 
                PB.Status='R' 
            GROUP BY ProductSysNo 
          ) SR
          ON a.ProductSysNo =SR.ProductSysNo
	        #StrWhere#
        ) RESULT 
        WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryInventoryStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
          @TotalCount = COUNT(c.SysNo) 
        FROM IPP3.dbo.Inventory_Stock a WITH(NOLOCK) 
        INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
        ON a.ProductSysNo = b.SysNo
		    LEFT JOIN IPP3.dbo.Manufacturer mf WITH(NOLOCK)
		    ON mf.SysNo = b.ManufacturerSysNo
		    LEFT JOIN OverseaContentManagement.dbo.Brand bd WITH(NOLOCK)
		    ON bd.SysNo = b.BrandSysNo
		    INNER JOIN IPP3.dbo.Category3 c3 WITH(NOLOCK)
		    ON b.Category3SysNo=c3.SysNo
		    INNER JOIN IPP3.dbo.Category2 c2 WITH(NOLOCK)
		    ON c3.C2SysNo=c2.SysNo
		    INNER JOIN IPP3.dbo.Category1 c1 WITH(NOLOCK)
		    ON c2.C1SysNo=c1.SysNo
        INNER JOIN OverseaContentManagement.dbo.V_IM_Product_Ex PE WITH(NOLOCK) 
        ON PE.SysNo = a.ProductSysNo
        INNER JOIN IPP3.dbo.Stock c WITH(NOLOCK)
        ON a.StockSysNo = c.SysNo
        LEFT JOIN
        (
	        SELECT DISTINCT pl.ProductSysNo,pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
	        INNER JOIN 
	        (
	        SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) GROUP BY plp.ProductSysNo
	        )pp 
	        ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
        ) plm 
        ON plm.ProductSysNo = a.ProductSysNo
        LEFT  JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  ActivedQty
            FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='A' 
            GROUP By StockSysNo,PB.ProductSysNo
         ) TempStatusA    
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusA.ProductSysNo AND  a.StockSysNo = TempStatusA.StockSysNo
        LEFT JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InactiveQty
            FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='R' 
            GROUP By StockSysNo,PB.ProductSysNo
         ) TempStatusR
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusR.ProductSysNo AND a.StockSysNo = TempStatusR.StockSysNo
        LEFT JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InvalidQty
            FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='I'  
            GROUP By StockSysNo,PB.ProductSysNo
         )  TempStatusI    
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusI.ProductSysNo  AND a.StockSysNo = TempStatusI.StockSysNo 
        #StrWhere#

        SELECT *		   
        FROM
        (
	        SELECT 
            TOP (@EndNumber) 
		        c.StockName,
            a.StockSysNo AS StockSysNo,
            a.ProductSysNo,
            b.ProductID,
            b.SysNo AS ItemSysNumber,
				    b.ProductName,
				    a.AccountQty,
				    a.AvailableQty,
				    a.AllocatedQty,
				    a.OrderQty,
				    a.VirtualQty,
				    a.ConsignQty,
            a.PurchaseQty,
            a.ShiftInQty,
            a.ShiftOutQty,
            a.Position1 AS PositionInWarehouse,
            0 AS UnPayOrderQty,
            a.CompanyCode,
            a.LanguageCode,
            ISNULL(PAVGS.AVGDailySalesNew,0.00) AS AVGDailySales,--商品对应分仓的日均销售量
            ISNULL(PAVGS.AvailableSalesDays,0) AS AvailableSalesDays,--商品对应分仓的可卖天数
            TempStatusA.ActivedQty  AS  ActivedQty,  --已激活
            TempStatusR.InactiveQty AS  InactiveQty, --未激活
            TempStatusI.InvalidQty  AS  InvalidQty,  --已失效
            PE.IsBatch,                              --是否批号管理商品
            b.IsConsign,                             --是否代销商品
            wc.WebChannelName,
            (SELECT ISNULL(SUM (LEFTQUANTITY*COST*ISNULL(ExchangeRate,1)),0) FROM OverseaInventoryManagement.dbo.ProductCostIn WITH(NOLOCK) WHERE WarehouseNumber=a.StockSysNo AND ProductSysNo=a.ProductSysNo) AS CostAmount,
            (SELECT TOP 1 VendorName FROM ipp3.dbo.product_lastpoinfo L WITH(NOLOCK) INNER JOIN ipp3.dbo.Vendor V WITH(NOLOCK) ON V.SysNo = L.LastVendorSysNo AND L.ProductSysNo = a.ProductSysNo ORDER BY L.SysNo DESC) AS VendorName,
            ISNULL(a.RetainQty,0) as RetainQty,
            PE.SafeQty AS SafeQty,
            (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
          FROM  IPP3.dbo.Inventory_Stock a WITH(NOLOCK) 
          LEFT JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
          LEFT JOIN OverseaControlPanel.dbo.WebChannel wc WITH(NOLOCK) ON stk.WebChannelSysNo=wc.SysNo
          INNER JOIN  OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK) ON b.SysNo = a.ProductSysNo
			    LEFT JOIN IPP3.dbo.Manufacturer mf WITH(NOLOCK)
			    ON mf.SysNo = b.ManufacturerSysNo
			    LEFT JOIN OverseaContentManagement.dbo.Brand bd WITH(NOLOCK)
			    ON bd.SysNo = b.BrandSysNo
			    INNER JOIN IPP3.dbo.Category3 c3 WITH(NOLOCK)
			    ON b.Category3SysNo=c3.SysNo
			    INNER JOIN IPP3.dbo.Category2 c2 WITH(NOLOCK)
			    ON c3.C2SysNo=c2.SysNo
			    INNER JOIN IPP3.dbo.Category1 c1 WITH(NOLOCK)
			    ON c2.C1SysNo=c1.SysNo
          INNER JOIN  OverseaContentManagement.dbo.V_IM_Product_Ex PE WITH(NOLOCK) ON PE.SysNo = a.ProductSysNo
          INNER JOIN IPP3.dbo.Stock c WITH(NOLOCK) ON a.StockSysNo = c.SysNo
          LEFT JOIN
          (
	          SELECT DISTINCT pl.ProductSysNo,pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
	          INNER JOIN 
	          (
	          SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) GROUP BY plp.ProductSysNo
	          )pp 
	          ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
          ) plm
          ON plm.ProductSysNo = a.ProductSysNo
          LEFT  JOIN OverseaInventoryManagement.dbo.Inventory_Product_AVGDailySales PAVGS WITH(NOLOCK) ON a.ProductSysNo = PAVGS.ProductSysNo  AND a.StockSysNo =PAVGS.StockSysNo   
          LEFT  JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  ActivedQty
            FROM  OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='A' 
            GROUP By StockSysNo,PB.ProductSysNo
         ) TempStatusA    
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusA.ProductSysNo  AND  a.StockSysNo = TempStatusA.StockSysNo
         LEFT JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InactiveQty
            FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='R' 
            GROUP By StockSysNo,PB.ProductSysNo
         ) TempStatusR
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusR.ProductSysNo    AND  a.StockSysNo = TempStatusR.StockSysNo 
         LEFT JOIN
         (                          
            SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InvalidQty
            FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
            INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
            ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
            WHERE PB.Status='I' 
            GROUP By StockSysNo,PB.ProductSysNo
         )  TempStatusI    
         ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusI.ProductSysNo    AND  a.StockSysNo = TempStatusI.StockSysNo
          #StrWhere# 
        ) RESULT         
        WHERE RowNumber>@StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryProductInventoryByStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
          @TotalCount = COUNT(a.ProductSysNo) 
        FROM IPP3.dbo.Inventory_Stock a WITH(NOLOCK) 
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
            ON a.ProductSysNo = b.SysNo
          #StrWhere#

        SELECT 
          ProductSysNo,
	        ProductID,
          StockSysNo,
          StockName,
          IsConsign,
			    ProductName,
			    AccountQty,
			    AvailableQty,
			    AllocatedQty,
			    OrderQty,          
			    VirtualQty,
			    ConsignQty,
          PurchaseQty, 
          ShiftInQty,
          ShiftOutQty,
          0 AS ShiftQty,
          CompanyCode
        FROM
        (
	        SELECT TOP (@EndNumber) 
            a.ProductSysNo,
            a.StockSysNo,
            s.StockName,
	          b.ProductID,
            ISNULL(b.IsConsign,0) AS IsConsign,   --是否代销商品
			      b.ProductName,
			      a.AccountQty,
			      a.AvailableQty,
			      a.AllocatedQty,
			      a.OrderQty,
			      a.VirtualQty,
			      a.ConsignQty,
            a.PurchaseQty,
            a.ShiftInQty,
            a.ShiftOutQty,            
            a.CompanyCode,    
	          (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
	        FROM IPP3.dbo.Inventory_Stock a WITH(NOLOCK) 
           INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
              ON a.ProductSysNo = b.SysNo  
            LEFT JOIN [IPP3].[dbo].[Stock] AS S WITH(NOLOCK)
              ON a.StockSysNo=S.SysNo
	        #StrWhere#
        ) RESULT 
        WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryProductInventoryTotal" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
          @TotalCount = COUNT(a.ProductSysNo) 
        FROM IPP3.dbo.Inventory a WITH(NOLOCK) 
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
            ON a.ProductSysNo = b.SysNo
          #StrWhere#

        SELECT 
          ProductSysNo,
	        ProductID,
          0 AS StockSysNo,
          '总仓' AS StockName,
          IsConsign,
			    ProductName,
			    AccountQty,
			    AvailableQty,
			    AllocatedQty,
			    OrderQty,          
			    VirtualQty,
			    ConsignQty,
          PurchaseQty,  
          0 AS ShiftInQty,
          0 AS ShiftOutQty,
          ShiftQty,
          CompanyCode
        FROM
        (
	        SELECT TOP (@EndNumber) 
            a.ProductSysNo,      
	          b.ProductID,
            ISNULL(b.IsConsign,0) AS IsConsign,   --是否代销商品
			      b.ProductName,
			      a.AccountQty,
			      a.AvailableQty,
			      a.AllocatedQty,
			      a.OrderQty,
			      a.VirtualQty,
			      a.ConsignQty,
            a.PurchaseQty,
            a.ShiftQty,
            a.CompanyCode,          
	          (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
	        FROM IPP3.dbo.Inventory a WITH(NOLOCK) 
           INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK)
              ON a.ProductSysNo = b.SysNo             
	        #StrWhere#
        ) RESULT 
        WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryUnPayQty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DECLARE @qty INT
        
        EXEC OverseaOrderManagement.dbo.UP_OM_CalUnPayOrderQty_V102009112001 @ProductSysNo,@whNo,@Flag,@CompanyCode,@qty OUTPUT
        
        SELECT @qty
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@whNo" dbType="AnsiStringFixedLength" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@Flag" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductBelongPMSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT TOP(1) PMUserSysNo FROM OverseaContentManagement.dbo.V_IM_Product WITH(NOLOCK) WHERE SysNo=@SysNo;
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
    <dataCommand name="GetProductBelongVendorSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT DISTINCT pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
        INNER JOIN 
        (
	        SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) 
	        GROUP BY plp.ProductSysNo
        )pp 
        ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
        WHERE pl.ProductSysNo=@ProductSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetUnmarketableInventoryInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[   
      DECLARE @item_key varchar(25)
      Select @item_key =  ProductID From OverseaContentManagement.dbo.V_CM_ItemBasicInfo WITH(NOLOCK) WHERE  SysNo=@ProductSysNo And CompanyCode=@CompanyCode
      SELECT 
        ProductSysNo     = @productSysNo
       ,ProductID        = @item_key        --产品Item#
      ,DateRange
      ,SUMQuantity       =  SUM(Quantity)  
      ,SUMPrice          =  SUM(Quantity*UnitCost)
      ,MAXInStockDays    =  Max(InStockDays)
      FROM OverseaInventoryManagement.dbo.BI_Inventory_Actual_Aging With(Nolock)
      WHERE Item_key=@item_key
      GROUP By  Item_key,DateRange
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductBatchInfoByProductAndStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      
      SELECT @TotalCount = COUNT(batch.BatchNumber)
      FROM
      OverseaContentManagement.dbo.Product_BatchManagementInfo AS bm
      INNER JOIN OverseaInventoryManagement.dbo.Product_Batch AS batch ON bm.ProductSysNo=batch.ProductSysNo
      INNER JOIN IPP3.dbo.Product AS p ON p.SysNo = batch.ProductSysNo
      INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock AS bStock
      ON batch.BatchNumber = bStock.BatchNumber
      #StrWhere#
      
      SELECT
      BatchNumber
      ,ProductSysNo
      ,ProductName
      ,ProductID
      ,MinReceiptDays
      ,MaxDeliveryDays
      ,GuaranteePeriodYear
      ,GuaranteePeriodMonth
      ,GuaranteePeriodDay
      ,InDate
      ,MfgDate
      ,ExpDate
      ,LotNo
      ,Status
      ,StockSysNo
      ,ActualQty
      ,AllocatedQty
      ,InStockDate
      FROM
      (
      SELECT TOP (@EndNumber) 
      batch.BatchNumber
      ,batch.ProductSysNo
      ,p.ProductName
      ,p.ProductID
      ,bm.MinReceiptDays
      ,bm.MaxDeliveryDays
      ,bm.GuaranteePeriodYear
      ,bm.GuaranteePeriodMonth
      ,bm.GuaranteePeriodDay
      ,batch.InDate
      ,batch.MfgDate
      ,batch.ExpDate
      ,batch.LotNo
      ,batch.Status
      ,bStock.StockSysNo
      ,bStock.ActualQty
      ,bStock.AllocatedQty
      ,bStock.InDate AS InStockDate
      ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
      FROM 
      OverseaContentManagement.dbo.Product_BatchManagementInfo AS bm
      INNER JOIN OverseaInventoryManagement.dbo.Product_Batch AS batch ON bm.ProductSysNo=batch.ProductSysNo
      INNER JOIN IPP3.dbo.Product AS p ON p.SysNo = batch.ProductSysNo
      INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock AS bStock
      ON batch.BatchNumber = bStock.BatchNumber
      #StrWhere#
      ) AS RESULT
      WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
    <param name="@ProductSysNo" dbType="Int32"/>
    <param name="@StockSysNo" dbType="Int32"/>
  </dataCommand>

  <dataCommand name="QueryProductCostInAndCostOutReport" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
DECLARE @tCostIn Table
(
ProductSysNo INT,
StockSysNo INT,
CostInQty INT,
CostInAmt DECIMAL(12,2),
LeftAmt DECIMAL(12,2)
)
DECLARE @tCostOut Table
(
ProductSysNo INT,
StockSysNo INT,
CostOutQty INT,
CostOutAmt DECIMAL(12,2)
)

INSERT INTO @tCostIn

--1.采购单（正采购）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.po_item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.POSysNo
INNER JOIN ipp3.dbo.PO_Master m on m.SysNo = p.POSysNo
WHERE  #strWhereDate# AND BillType = 40
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--2.损益单（益单，增加库存）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.St_Adjust_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.AdjustSysNo
INNER JOIN Ipp3.dbo.St_Adjust m on m.SysNo = p.AdjustSysNo
WHERE  #strWhereDate# AND BillType = 41
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL 

--3.物流拒收
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.RMA_Return_Item p on c.BillSysNo = p.ReturnSysNo
INNER JOIN (
	SELECT DISTINCT SysNo,ProductSysNo FROM ipp3.dbo.RMA_Register
) r on r.ProductSysNo = c.ProductSysNo and r.SysNo = p.RegisterSysNo
INNER JOIN Ipp3.dbo.RMA_Return m on m.SysNo = p.ReturnSysNo
WHERE  #strWhereDate# AND BillType = 3
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--3.转换单（目标商品）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.St_Transfer_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.TransferSysNo
INNER JOIN Ipp3.dbo.St_Transfer m on m.SysNo = p.TransferSysNo
WHERE  #strWhereDate# AND BillType = 43
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--4.借货单（归还）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.St_Lend_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.LendSysNo
INNER JOIN Ipp3.dbo.St_Lend m on m.SysNo = p.LendSysNo
WHERE  #strWhereDate# AND BillType = 4
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--5.销售订单已出库申报失败作废
SELECT c.ProductSysNo, m.LocalWHSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
, SUM(c.LeftQuantity*c.Cost*ISNULL(c.ExchangeRate,1)) LeftAmt
FROM OverseaInventoryManagement.dbo.ProductCostin c
INNER JOIN Ipp3.dbo.SO_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.SOSysNo
INNER JOIN Ipp3.dbo.SO_CheckShipping m on m.SOSysNo = p.SOSysNo
WHERE  #strWhereDate# AND BillType = 20
GROUP BY c.ProductSysNo, m.LocalWHSysNo


INSERT INTO @tCostOut

--1.采购单（负采购）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
FROM OverseaInventoryManagement.dbo.ProductCostout c
INNER JOIN Ipp3.dbo.po_item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.POSysNo
INNER JOIN ipp3.dbo.PO_Master m on m.SysNo = p.POSysNo
WHERE  #strWhereDate# AND BillType = 40
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--2.损益单（损单，减少库存）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
FROM OverseaInventoryManagement.dbo.ProductCostout c
INNER JOIN Ipp3.dbo.St_Adjust_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.AdjustSysNo
INNER JOIN Ipp3.dbo.St_Adjust m on m.SysNo = p.AdjustSysNo
WHERE  #strWhereDate# AND BillType = 41
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--3.销售订单
SELECT c.ProductSysNo, m.LocalWHSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
FROM OverseaInventoryManagement.dbo.ProductCostout c
INNER JOIN Ipp3.dbo.so_item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.SOSysNo
INNER JOIN Ipp3.dbo.SO_CheckShipping m on m.SOSysNo = p.SOSysNo
WHERE  #strWhereDate# AND BillType = 20
GROUP BY c.ProductSysNo, m.LocalWHSysNo

UNION ALL

--4.转换单（源商品）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
FROM OverseaInventoryManagement.dbo.ProductCostout c
INNER JOIN Ipp3.dbo.St_Transfer_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.TransferSysNo
INNER JOIN Ipp3.dbo.St_Transfer m on m.SysNo = p.TransferSysNo
WHERE  #strWhereDate# AND BillType = 43
GROUP BY c.ProductSysNo, m.StockSysNo

UNION ALL

--5.借货单（出库）
SELECT c.ProductSysNo, m.StockSysNo
, SUM(c.Quantity) CostInQty
, SUM(c.Quantity*c.Cost*ISNULL(c.ExchangeRate,1)) CostInAmt
FROM OverseaInventoryManagement.dbo.ProductCostout c
INNER JOIN Ipp3.dbo.St_Lend_Item p on p.ProductSysNo = c.ProductSysNo and c.BillSysNo = p.LendSysNo
INNER JOIN Ipp3.dbo.St_Lend m on m.SysNo = p.LendSysNo
WHERE  #strWhereDate# AND BillType = 21
GROUP BY c.ProductSysNo, m.StockSysNo



SELECT @TotalCount = COUNT(1)
FROM IPP3.dbo.Inventory_stock a WITH(NOLOCK) 
LEFT JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) ON p.SysNo = a.ProductSysNo
LEFT JOIN ipp3.dbo.Category3 c3 on p.Category3SysNo = c3.sysno
LEFT JOIN ipp3.dbo.Category2 c2 on c2.sysno = c3.C2SysNo
LEFT JOIN ipp3.dbo.Category1 c1 on c1.SysNo = c2.C1SysNo
LEFT JOIN ipp3.dbo.Inventory inv on inv.productsysno = p.SysNo
LEFT JOIN OverseaContentManagement.dbo.Brand brand on brand.SysNo = p.BrandSysNo
LEFT JOIN ipp3.dbo.Vendor vendor on vendor.sysno = p.MerchantSysNo
LEFT JOIN OverseaControlPanel.dbo.WebChannel wc WITH(NOLOCK) ON stk.WebChannelSysNo=wc.SysNo
LEFT JOIN (
	SELECT productsysno,StockSysNo,SUM(CostInQty)CostInQty,
	SUM(CostInAmt)CostInAmt,SUM(LeftAmt)LeftAmt FROM @tCostIn
	GROUP BY productsysno,StockSysNo
)ci ON ci.ProductSysNo = p.SysNo AND a.StockSysNo = ci.StockSysNo
LEFT JOIN (
	SELECT productsysno,StockSysNo,SUM(CostOutQty)CostOutQty,
	SUM(CostOutAmt)CostOutAmt FROM @tCostOut
	GROUP BY productsysno,StockSysNo
)co ON co.ProductSysNo = p.SysNo AND a.StockSysNo = co.StockSysNo
#StrWhere#


SELECT * FROM (
SELECT TOP (@EndNumber)
	stk.StockName
	,p.ProductID
	,p.ProductName
	,c1.C1Name
	,c2.C2Name
	,c3.C3Name
	,brand.BrandName_Ch AS BrandName
	,vendor.VendorName
	,a.AccountQty
	,ISNULL(ci.LeftAmt,0)LeftAmt
	,ISNULL(ci.CostInQty,0)CostInQty
	,ISNULL(ci.CostInAmt,0)CostInAmt
	,ISNULL(co.CostOutQty,0)CostOutQty
	,ISNULL(co.CostOutAmt,0)CostOutAmt
	,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
 FROM IPP3.dbo.Inventory_stock a WITH(NOLOCK) 
LEFT JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) ON p.SysNo = a.ProductSysNo
LEFT JOIN ipp3.dbo.Category3 c3 on p.Category3SysNo = c3.sysno
LEFT JOIN ipp3.dbo.Category2 c2 on c2.sysno = c3.C2SysNo
LEFT JOIN ipp3.dbo.Category1 c1 on c1.SysNo = c2.C1SysNo
LEFT JOIN ipp3.dbo.Inventory inv on inv.productsysno = p.SysNo
LEFT JOIN OverseaContentManagement.dbo.Brand brand on brand.SysNo = p.BrandSysNo
LEFT JOIN ipp3.dbo.Vendor vendor on vendor.sysno = p.MerchantSysNo
LEFT JOIN OverseaControlPanel.dbo.WebChannel wc WITH(NOLOCK) ON stk.WebChannelSysNo=wc.SysNo
LEFT JOIN (
	SELECT productsysno,StockSysNo,SUM(CostInQty)CostInQty,
	SUM(CostInAmt)CostInAmt,SUM(LeftAmt)LeftAmt FROM @tCostIn
	GROUP BY productsysno,StockSysNo
)ci ON ci.ProductSysNo = p.SysNo AND a.StockSysNo = ci.StockSysNo
LEFT JOIN (
	SELECT productsysno,StockSysNo,SUM(CostOutQty)CostOutQty,
	SUM(CostOutAmt)CostOutAmt FROM @tCostOut
	GROUP BY productsysno,StockSysNo
)co ON co.ProductSysNo = p.SysNo AND a.StockSysNo = co.StockSysNo
#StrWhere# )Result
WHERE RowNumber>@StartNumber      
      ]]>
    </commandText>
  </dataCommand>

  <!--查询月底库存-->
  <dataCommand name="QueryInventoryEndOfMouth" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     SELECT 
	    c.StockName,
        a.StockSysNo AS StockSysNo,
        a.ProductSysNo,
        b.ProductID,
        b.SysNo AS ItemSysNumber,
	    b.ProductName,
	    a.AccountQty,
	    a.AvailableQty,
	    a.AllocatedQty,
	    a.OrderQty,
	    a.VirtualQty,
	    a.ConsignQty,
        a.PurchaseQty,
        a.ShiftInQty,
        a.ShiftOutQty,
        a.Position1 AS PositionInWarehouse,
        0 AS UnPayOrderQty,
        a.CompanyCode,
        a.LanguageCode,
        ISNULL(PAVGS.AVGDailySalesNew,0.00) AS AVGDailySales,--商品对应分仓的日均销售量
        ISNULL(PAVGS.AvailableSalesDays,0) AS AvailableSalesDays,--商品对应分仓的可卖天数
        TempStatusA.ActivedQty  AS  ActivedQty,  --已激活
        TempStatusR.InactiveQty AS  InactiveQty, --未激活
        TempStatusI.InvalidQty  AS  InvalidQty,  --已失效
        PE.IsBatch,                              --是否批号管理商品
        b.IsConsign,                             --是否代销商品
        wc.WebChannelName,
        (SELECT ISNULL(SUM (LEFTQUANTITY*COST*ISNULL(ExchangeRate,1)),0) FROM OverseaInventoryManagement.dbo.ProductCostIn WITH(NOLOCK) WHERE WarehouseNumber=a.StockSysNo AND ProductSysNo=a.ProductSysNo) AS CostAmount,
        (SELECT TOP 1 VendorName FROM ipp3.dbo.product_lastpoinfo L WITH(NOLOCK) INNER JOIN ipp3.dbo.Vendor V WITH(NOLOCK) ON V.SysNo = L.LastVendorSysNo AND L.ProductSysNo = a.ProductSysNo ORDER BY L.SysNo DESC) AS VendorName,
        (ROW_NUMBER() OVER(ORDER BY b.SysNo)) AS RowNumber 
      FROM  IPP3.dbo.Inventory_Stock a WITH(NOLOCK) 
      LEFT JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
      LEFT JOIN OverseaControlPanel.dbo.WebChannel wc WITH(NOLOCK) ON stk.WebChannelSysNo=wc.SysNo
      INNER JOIN  OverseaContentManagement.dbo.V_CM_ItemBasicInfo b WITH(NOLOCK) ON b.SysNo = a.ProductSysNo
		    LEFT JOIN IPP3.dbo.Manufacturer mf WITH(NOLOCK)
		    ON mf.SysNo = b.ManufacturerSysNo
		    LEFT JOIN OverseaContentManagement.dbo.Brand bd WITH(NOLOCK)
		    ON bd.SysNo = b.BrandSysNo
		    INNER JOIN IPP3.dbo.Category3 c3 WITH(NOLOCK)
		    ON b.Category3SysNo=c3.SysNo
		    INNER JOIN IPP3.dbo.Category2 c2 WITH(NOLOCK)
		    ON c3.C2SysNo=c2.SysNo
		    INNER JOIN IPP3.dbo.Category1 c1 WITH(NOLOCK)
		    ON c2.C1SysNo=c1.SysNo
      INNER JOIN  OverseaContentManagement.dbo.V_IM_Product_Ex PE WITH(NOLOCK) ON PE.SysNo = a.ProductSysNo
      INNER JOIN IPP3.dbo.Stock c WITH(NOLOCK) ON a.StockSysNo = c.SysNo
      LEFT JOIN
      (
          SELECT DISTINCT pl.ProductSysNo,pl.LastVendorSysNo FROM IPP3.dbo.Product_LastPOInfo pl WITH(NOLOCK) 
          INNER JOIN 
          (
          SELECT plp.ProductSysNo,MAX(plp.LastPOSysNo) AS LastPOSysNo FROM IPP3.dbo.Product_LastPOInfo plp WITH(NOLOCK) GROUP BY plp.ProductSysNo
          )pp 
          ON pl.ProductSysNo = pp.ProductSysNo AND pl.LastPOSysNo = pp.LastPOSysNo
      ) plm
      ON plm.ProductSysNo = a.ProductSysNo
      LEFT  JOIN OverseaInventoryManagement.dbo.Inventory_Product_AVGDailySales PAVGS WITH(NOLOCK) ON a.ProductSysNo = PAVGS.ProductSysNo  AND a.StockSysNo =PAVGS.StockSysNo   
      LEFT  JOIN
     (                          
        SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  ActivedQty
        FROM  OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
        INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
        ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
        WHERE PB.Status='A' 
        GROUP By StockSysNo,PB.ProductSysNo
     ) TempStatusA    
     ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusA.ProductSysNo  AND  a.StockSysNo = TempStatusA.StockSysNo
     LEFT JOIN
     (                          
        SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InactiveQty
        FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
        INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
        ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
        WHERE PB.Status='R' 
        GROUP By StockSysNo,PB.ProductSysNo
     ) TempStatusR
     ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusR.ProductSysNo    AND  a.StockSysNo = TempStatusR.StockSysNo 
     LEFT JOIN
     (                          
        SELECT PB.ProductSysNo,StockSysNo,ISNULL(SUM(PBS.ActualQty),0) AS  InvalidQty
        FROM OverseaInventoryManagement.dbo.Product_Batch PB WITH(NOLOCK)             
        INNER JOIN OverseaInventoryManagement.dbo.Product_Batch_Stock PBS WITH(NOLOCK) 
        ON   PB.ProductSysNo=PBS.ProductSysNo AND PB.BatchNumber=PBS.BatchNumber
        WHERE PB.Status='I' 
        GROUP By StockSysNo,PB.ProductSysNo
     )  TempStatusI    
     ON  PE.IsBatch='Y' AND a.ProductSysNo = TempStatusI.ProductSysNo    AND  a.StockSysNo = TempStatusI.StockSysNo
      WHERE   a.CompanyCode = '8601' AND b.ProductName NOT LIKE '%测试%' And b.ProductName NOT LIKE '%test%'
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryProductStockAgeReport" database="NCService" commandType="Text">
    <commandText>
        <![CDATA[
DECLARE @ProductStockAgeInventory TABLE(
	ProductSysNo INT,
	StockSysNo INT,
	VendorSysNo INT,
	Qty1m INT,Amt1m DECIMAL(12,2),
	Qty1m2m INT,Amt1m2m DECIMAL(12,2),
	Qty2m3m INT,Amt2m3m DECIMAL(12,2),
	Qty3m6m INT,Amt3m6m DECIMAL(12,2),
	Qty6m9m INT,Amt6m9m DECIMAL(12,2),
	Qty9m12m INT,Amt9m12m DECIMAL(12,2),
	Qty1y2y INT,Amt1y2y DECIMAL(12,2),
	Qty2y3y INT,Amt2y3y DECIMAL(12,2),
	Qty3y INT,Amt3y DECIMAL(12,2)
)

SELECT @TotalCount = COUNT(1)
FROM ipp3.dbo.Inventory_Stock a
INNER JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) ON p.SysNo = a.ProductSysNo 
LEFT JOIN ipp3.dbo.Category3 c3 WITH(NOLOCK) ON p.Category3SysNo = c3.sysno
LEFT JOIN ipp3.dbo.Category2 c2 WITH(NOLOCK) ON c2.sysno = c3.C2SysNo
LEFT JOIN ipp3.dbo.Category1 c1 WITH(NOLOCK) ON c1.SysNo = c2.C1SysNo
LEFT JOIN ipp3.dbo.Inventory inv WITH(NOLOCK) ON inv.productsysno = p.SysNo
INNER JOIN ipp3.dbo.FN_EC_GetProductPOInventory('1900-01-01',@StatisticDate) t
 ON t.ProductSysNo = p.SysNo AND t.StockSysNo = a.StockSysNo
LEFT JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK) ON vendor.sysno = t.VendorSysNo
#StrWhere#

INSERT INTO @ProductStockAgeInventory
(
ProductSysNo,StockSysNo,VendorSysNo
)
SELECT SysNo,StockSysNo,VendorSysNo
FROM (
SELECT TOP(@EndNumber) p.SysNo,a.StockSysNo,t.VendorSysNo
  ,ROW_NUMBER() OVER(ORDER BY #SortColumnName#) RowNumber
FROM ipp3.dbo.Inventory_Stock a
INNER JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) ON p.SysNo = a.ProductSysNo 
LEFT JOIN ipp3.dbo.Category3 c3 WITH(NOLOCK) ON p.Category3SysNo = c3.sysno
LEFT JOIN ipp3.dbo.Category2 c2 WITH(NOLOCK) ON c2.sysno = c3.C2SysNo
LEFT JOIN ipp3.dbo.Category1 c1 WITH(NOLOCK) ON c1.SysNo = c2.C1SysNo
LEFT JOIN ipp3.dbo.Inventory inv WITH(NOLOCK) ON inv.productsysno = p.SysNo
INNER JOIN ipp3.dbo.FN_EC_GetProductPOInventory('1900-01-01',@StatisticDate) t
 ON t.ProductSysNo = p.SysNo AND t.StockSysNo = a.StockSysNo
LEFT JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK) ON vendor.sysno = t.VendorSysNo
#StrWhere#) Result 
WHERE RowNumber > @StartNumber

#strUpdateProductStockAgeInventory#

SELECT p.Sysno AS ProductSysno,
	p.ProductID,p.ProductName 
	,c1.C1Name
	,c2.C2Name
	,c3.C3Name
	,stk.StockName
	,vendor.VendorName
	,ISNULL(t.Quantity,0) POQty
	,ISNULL(t.Amount,0.00) POAmt
	,ISNULL(si.Amt1m,0.00)Amt1m,ISNULL(si.Qty1m,0)Qty1m
	,ISNULL(si.Amt1m2m,0.00)Amt1m2m,ISNULL(si.Qty1m2m,0)Qty1m2m
	,ISNULL(si.Amt2m3m,0.00)Amt2m3m,ISNULL(si.Qty2m3m,0)Qty2m3m
	,ISNULL(si.Amt3m6m,0.00)Amt3m6m,ISNULL(si.Qty3m6m,0)Qty3m6m
	,ISNULL(si.Amt6m9m,0.00)Amt6m9m,ISNULL(si.Qty6m9m,0)Qty6m9m
	,ISNULL(si.Amt9m12m,0.00)Amt9m12m,ISNULL(si.Qty9m12m,0)Qty9m12m
	,ISNULL(si.Amt1y2y,0.00)Amt1y2y,ISNULL(si.Qty1y2y,0)Qty1y2y
	,ISNULL(si.Amt2y3y,0.00)Amt2y3y,ISNULL(si.Qty2y3y,0)Qty2y3y
	,ISNULL(si.Amt3y,0.00)Amt3y,ISNULL(si.Qty3y,0)Qty3y
FROM ipp3.dbo.Inventory_Stock a
INNER JOIN IPP3.dbo.Stock stk WITH(NOLOCK) ON a.StockSysNo=stk.SysNo
INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) ON p.SysNo = a.ProductSysNo
LEFT JOIN ipp3.dbo.Category3 c3 WITH(NOLOCK) ON p.Category3SysNo = c3.sysno
LEFT JOIN ipp3.dbo.Category2 c2 WITH(NOLOCK) ON c2.sysno = c3.C2SysNo
LEFT JOIN ipp3.dbo.Category1 c1 WITH(NOLOCK) ON c1.SysNo = c2.C1SysNo
LEFT JOIN ipp3.dbo.Inventory inv WITH(NOLOCK) ON inv.productsysno = p.SysNo
LEFT JOIN ipp3.dbo.FN_EC_GetProductPOInventory('1900-01-01',@StatisticDate) t
 ON t.ProductSysNo = p.SysNo AND t.StockSysNo = a.StockSysNo
LEFT JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK) 
 ON vendor.sysno = t.VendorSysNo
INNER JOIN @ProductStockAgeInventory si
 ON si.ProductSysNo = p.SysNo AND si.StockSysNo = a.StockSysNo AND si.VendorSysNo = t.VendorSysNo  
         ]]>
    </commandText>
  </dataCommand>
</dataOperations>