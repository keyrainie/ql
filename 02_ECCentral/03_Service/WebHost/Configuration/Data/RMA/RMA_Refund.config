<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <dataCommand name="QueryRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          @TotalCount = COUNT(1) 
        FROM [dbo].[RMA_Refund] AS RMA WITH (NOLOCK) 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS A WITH (NOLOCK) 
		        ON RMA.CreateUserSysNo = A.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS B WITH (NOLOCK) 
		        ON RMA.AuditUserSysNo = B.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS C WITH (NOLOCK) 
		        ON RMA.RefundUserSysNo = C.UserSysNo 
	        LEFT OUTER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo AS D WITH (NOLOCK) 
		        ON RMA.SysNo = D.OrderSysNo AND D.OrderType = #OrderType#
	        LEFT OUTER JOIN OverseaCustomerManagement.[dbo].[V_CUM_CustomerBaseInfo] AS E WITH (NOLOCK) 
		        ON RMA.CustomerSysNo = E.SysNo
          LEFT OUTER JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] F WITH(NOLOCK)
            ON RMA.InvoiceLocation = F.SysNo
          LEFT OUTER JOIN ( 
            SELECT 
                R.SysNo 
               ,RI.RefundSysNo 
               ,IsNull(S.StockName, '') AS ShippedWarehouse 
            FROM [dbo].[RMA_Register] R WITH(NOLOCK) 
              INNER JOIN ( 
                SELECT 
                    RMASysNo = MAX(RegisterSysNo) 
                   ,RefundSysNo 
                FROM [dbo].[RMA_Refund_Item] RI WITH(NOLOCK) 
                GROUP BY RI.RefundSysNo 
              ) RI  
                ON RI.RMASysNo=R.SysNo 
              LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] S WITH(NOLOCK) 
                ON CAST(S.SysNo AS varchar)= R.ShippedWarehouse 
          ) G 
            ON RMA.SysNo = G.RefundSysNo
	        #StrWhere# 

      SELECT [SysNo]
	      ,[RefundID]
	      ,[Status]
	      ,[SOSysNo]
	      ,[InvoiceLocation]
	      ,[SOInvoiceNo]
	      ,[CreateTime]
	      ,[AuditTime]
	      ,[RefundTime]
        ,[CreateName]
        ,[AuditName]
        ,[RefundName]
	      ,[AuditStatus]
	      ,[CSAuditTime]
	      ,[CustomerName]
	      ,[VIPRank]
        ,[ShippedWarehouse]
        ,[InvoiceWarehouse]
      FROM(
	      SELECT TOP (@EndNumber)
		        RMA.SysNo
	         ,RMA.RefundID
	         ,RMA.Status
	         ,RMA.SoSysNo
	         ,RMA.InvoiceLocation
	         ,RMA.SOInvoiceNo
	         ,RMA.CreateTime
	         ,RMA.AuditTime
	         ,RMA.RefundTime
	         --,A.DisplayName AS CreateName
           --,B.DisplayName AS AuditName
	         --,C.DisplayName AS RefundName
           ,ISNULL(RMA.CreateUserName,A.DisplayName) AS CreateName
           ,ISNULL(RMA.AuditUserName,B.DisplayName) AS AuditName
           ,ISNULL(RMA.RefundUserName,C.DisplayName) AS RefundName
	         ,D.Status AS AuditStatus
	         ,D.AuditTime AS CSAuditTime 
	         ,E.CustomerName 
	         ,E.VIPRank
           ,G.ShippedWarehouse AS ShippedWarehouse
           ,F.StockName AS InvoiceWarehouse
		       ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
        FROM [dbo].[RMA_Refund] AS RMA WITH (NOLOCK) 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS A WITH (NOLOCK) 
		        ON RMA.CreateUserSysNo = A.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS B WITH (NOLOCK) 
		        ON RMA.AuditUserSysNo = B.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS C WITH (NOLOCK) 
		        ON RMA.RefundUserSysNo = C.UserSysNo 
	        LEFT OUTER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo AS D WITH (NOLOCK) 
		        ON RMA.SysNo = D.OrderSysNo AND D.OrderType = #OrderType#
	        LEFT OUTER JOIN OverseaCustomerManagement.[dbo].[V_CUM_CustomerBaseInfo] AS E WITH (NOLOCK) 
		        ON RMA.CustomerSysNo = E.SysNo
          LEFT OUTER JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] F WITH(NOLOCK)
            ON RMA.InvoiceLocation = F.SysNo
          LEFT OUTER JOIN ( 
            SELECT 
                R.SysNo 
               ,RI.RefundSysNo 
               ,IsNull(S.StockName, '') AS ShippedWarehouse 
            FROM [dbo].[RMA_Register] R WITH(NOLOCK) 
              INNER JOIN ( 
                SELECT 
                    RMASysNo=MAX(RegisterSysNo) 
                   ,RefundSysNo 
                FROM [dbo].[RMA_Refund_Item] RI WITH(NOLOCK) 
                GROUP BY RI.RefundSysNo 
              ) RI  
                ON RI.RMASysNo=R.SysNo 
              LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] S WITH(NOLOCK) 
                ON CAST(S.SysNo AS varchar)= R.ShippedWarehouse 
          ) G 
            ON RMA.SysNo = G.RefundSysNo
	        #StrWhere# 
      ) PagingTable
      WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryRefundWithSoSysNOParam" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[      
  DECLARE @TempTableSoMaster TABLE 
  ( 
       [SysNo] [int] IDENTITY(1,1) NOT NULL
       ,SOSysNO int 
  )

  DECLARE @TempSysNo char(10)   

  DECLARE @TempStr varchar(8000)

  SET   @TempStr=@SoSysNoStr+','

  WHILE(@TempStr<>'')   
      BEGIN   
		  SET   @TempSysNo=LEFT(@TempStr,charindex(',',@TempStr,1)-1)   
		  INSERT   @TempTableSoMaster 
                      (
                           SOSysNO
                      ) 
                      VALUES
                      ( 
                           CAST(@TempSysNo AS int) 
                      ) 
		  SET   @TempStr=STUFF(@TempStr,1,CHARINDEX(',',@TempStr,1),'')   
      END
      
      SELECT 
          @TotalCount = COUNT(1) 
        FROM [dbo].[RMA_Refund] AS RMA WITH (NOLOCK) 
        INNER JOIN @TempTableSoMaster AS TempTableSoMaster 
          ON TempTableSoMaster.SOSysNO =RMA.SOSysNo
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS A WITH (NOLOCK) 
		        ON RMA.CreateUserSysNo = A.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS B WITH (NOLOCK) 
		        ON RMA.AuditUserSysNo = B.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS C WITH (NOLOCK) 
		        ON RMA.RefundUserSysNo = C.UserSysNo 
	        LEFT OUTER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo AS D WITH (NOLOCK) 
		        ON RMA.SysNo = D.OrderSysNo AND D.OrderType = #OrderType#
	        LEFT OUTER JOIN OverseaCustomerManagement.[dbo].[V_CUM_CustomerBaseInfo] AS E WITH (NOLOCK) 
		        ON RMA.CustomerSysNo = E.SysNo
          LEFT OUTER JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] F WITH(NOLOCK)
            ON RMA.InvoiceLocation = F.SysNo
          LEFT OUTER JOIN ( 
            SELECT 
                R.SysNo 
               ,RI.RefundSysNo 
               ,IsNull(S.StockName, '') AS ShippedWarehouse 
            FROM [dbo].[RMA_Register] R WITH(NOLOCK) 
              INNER JOIN ( 
                SELECT 
                    RMASysNo = MAX(RegisterSysNo) 
                   ,RefundSysNo 
                FROM [dbo].[RMA_Refund_Item] RI WITH(NOLOCK) 
                GROUP BY RI.RefundSysNo 
              ) RI  
                ON RI.RMASysNo=R.SysNo 
              LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] S WITH(NOLOCK) 
                ON CAST(S.SysNo AS varchar)= R.ShippedWarehouse 
          ) G 
            ON RMA.SysNo = G.RefundSysNo
	        #StrWhere# 

      SELECT [SysNo]
	      ,[RefundID]
	      ,[Status]
	      ,[SOSysNo]
	      ,[InvoiceLocation]
	      ,[SOInvoiceNo]
	      ,[CreateTime]
	      ,[AuditTime]
	      ,[RefundTime]
        ,[CreateName]
        ,[AuditName]
        ,[RefundName]
	      ,[AuditStatus]
	      ,[CSAuditTime]
	      ,[CustomerName]
	      ,[VIPRank]
        ,[ShippedWarehouse]
        ,[InvoiceWarehouse]
        ,RefundReason
      FROM(
	      SELECT TOP (@EndNumber)
		        RMA.SysNo
	         ,RMA.RefundID
	         ,RMA.Status
	         ,RMA.SoSysNo
	         ,RMA.InvoiceLocation
	         ,RMA.SOInvoiceNo
	         ,RMA.CreateTime
	         ,RMA.AuditTime
	         ,RMA.RefundTime
           ,RMA.RefundReason
	         ,A.DisplayName AS CreateName
	         ,B.DisplayName AS AuditName
	         ,C.DisplayName AS RefundName
	         ,D.Status AS AuditStatus
	         ,D.AuditTime AS CSAuditTime 
	         ,E.CustomerName 
	         ,E.VIPRank
           ,G.ShippedWarehouse AS ShippedWarehouse
           ,F.StockName AS InvoiceWarehouse
		       ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
        FROM [dbo].[RMA_Refund] AS RMA WITH (NOLOCK) 
        INNER JOIN @TempTableSoMaster AS TempTableSoMaster 
          ON TempTableSoMaster.SOSysNO =RMA.SOSysNo
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS A WITH (NOLOCK) 
		        ON RMA.CreateUserSysNo = A.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS B WITH (NOLOCK) 
		        ON RMA.AuditUserSysNo = B.UserSysNo 
	        LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS C WITH (NOLOCK) 
		        ON RMA.RefundUserSysNo = C.UserSysNo 
	        LEFT OUTER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo AS D WITH (NOLOCK) 
		        ON RMA.SysNo = D.OrderSysNo AND D.OrderType = #OrderType#
	        LEFT OUTER JOIN OverseaCustomerManagement.[dbo].[V_CUM_CustomerBaseInfo] AS E WITH (NOLOCK) 
		        ON RMA.CustomerSysNo = E.SysNo
          LEFT OUTER JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] F WITH(NOLOCK)
            ON RMA.InvoiceLocation = F.SysNo
          LEFT OUTER JOIN ( 
            SELECT 
                R.SysNo 
               ,RI.RefundSysNo 
               ,IsNull(S.StockName, '') AS ShippedWarehouse 
            FROM [dbo].[RMA_Register] R WITH(NOLOCK) 
              INNER JOIN ( 
                SELECT 
                    RMASysNo=MAX(RegisterSysNo) 
                   ,RefundSysNo 
                FROM [dbo].[RMA_Refund_Item] RI WITH(NOLOCK) 
                GROUP BY RI.RefundSysNo 
              ) RI  
                ON RI.RMASysNo=R.SysNo 
              LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] S WITH(NOLOCK) 
                ON CAST(S.SysNo AS varchar)= R.ShippedWarehouse 
          ) G 
            ON RMA.SysNo = G.RefundSysNo
	        #StrWhere# 
      ) PagingTable
      WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetRefundCashAmtBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT 
    TotalCashAmt=ISNULL(SUM(ISNull(CashAmt,0)),0) 
   ,TotalGiftCardAmt=ISNULL(SUM(ISNull(GiftCardAmt,0)),0) 
   ,TotalPointAmt=ISNULL(SUM(ISNull(PointAmt,0)),0)
   ,TotalShipPriceAmt=ISNULL(SUM(ISNull(CompensateShipPrice,0)),0) 
FROM [IPP3].[dbo].[RMA_Refund] With(NOLOCK)
WHERE 
    Status = @Status 
    AND SOSysNo = @SOSysNo 
GROUP BY sosysno
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRO_BalanceCashAmtByOrgSOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT 
    TotalCashAmt=ISNULL(SUM(ISNull(CashAmt,0)),0) 
   ,TotalGiftCardAmt=ISNULL(SUM(ISNull(GiftCardAmt,0)),0) 
   ,TotalPointAmt=ISNULL(SUM(ISNull(PointAmt,0)),0)
FROM [IPP3].[dbo].[RO_Balance] With(NOLOCK)
WHERE 
    Status = @Status
    AND OrgSOSysNo = @OrgSOSysNo 
GROUP BY OrgSOSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@OrgSOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRO_BalanceShipPriceAmtByOrgSOSysNoAndWarehouseNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT 
    TotalCashAmt=ISNULL(SUM(ISNull(CashAmt,0)),0) 
   ,TotalGiftCardAmt=ISNULL(SUM(ISNull(GiftCardAmt,0)),0) 
   ,TotalPointAmt=ISNULL(SUM(ISNull(PointAmt,0)),0) 
FROM [IPP3].[dbo].[RO_Balance] WITH(NOLOCK) 
WHERE 
    Status = @Status 
    AND OrgSOSysNo = @OrgSOSysNo 
    AND [ProductSysNo]=@ProductSysNo 
    AND OrgRefundSysNo IN(            
            SELECT 
                Refund.sysno 
            FROM RMA_Register RR WITH(NOLOCK) 
            INNER JOIN RMA_Refund_Item RRI WITH(NOLOCK) 
                ON RR.SysNo = RRI.RegisterSysNo 
            INNER JOIN RMA_Refund Refund WITH(NOLOCK) 
                ON Refund.SysNo = RRI.RefundSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item SI WITH(NOLOCK)  
                ON SI.ProductSysNo = RR.ProductSysNo 
                AND SI.SoSysNo = Refund.SOSysNo 
            WHERE 
                SI.WareHouseNumber=@InvoiceLocation 
                AND Refund.SOSysNo=@OrgSOSysNo 
                AND Refund.[status]=2 
        ) 
GROUP BY OrgSOSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@OrgSOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRO_BalanceShipPriceAmtByOrgSOSysNoAndOtherWarehouseNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT 
    TotalCashAmt=ISNULL(SUM(ISNull(CashAmt,0)),0) 
   ,TotalGiftCardAmt=ISNULL(SUM(ISNull(GiftCardAmt,0)),0) 
   ,TotalPointAmt=ISNULL(SUM(ISNull(PointAmt,0)),0) 
FROM [IPP3].[dbo].[RO_Balance] WITH(NOLOCK) 
WHERE 
    Status = @Status 
    AND OrgSOSysNo = @OrgSOSysNo 
    AND [ProductSysNo]=@ProductSysNo 
    AND OrgRefundSysNo NOT IN(            
            SELECT 
                Refund.sysno 
            FROM RMA_Register RR WITH(NOLOCK) 
            INNER JOIN RMA_Refund_Item RRI WITH(NOLOCK) 
                ON RR.SysNo = RRI.RegisterSysNo 
            INNER JOIN RMA_Refund Refund WITH(NOLOCK) 
                ON Refund.SysNo = RRI.RefundSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item SI WITH(NOLOCK)  
                ON SI.ProductSysNo = RR.ProductSysNo 
                AND SI.SoSysNo = Refund.SOSysNo 
            WHERE 
                SI.WareHouseNumber=@InvoiceLocation 
                AND Refund.SOSysNo=@OrgSOSysNo 
                AND Refund.[status]=2 
        ) 
GROUP BY OrgSOSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@OrgSOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundShipPriceBySOSysNoAndWareHouseNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT     
   ISNULL(SUM(ISNull(CompensateShipPrice,0)),0) as TotalShipPriceAmt
FROM [IPP3].[dbo].[RMA_Refund] With(NOLOCK)
WHERE 
    Status = @Status 
    AND SOSysNo = @SOSysNo 
    AND SysNo IN(
            SELECT 
                Refund.sysno 
            FROM RMA_Register RR WITH(NOLOCK) 
            INNER JOIN RMA_Refund_Item RRI WITH(NOLOCK) 
                ON RR.SysNo = RRI.RegisterSysNo 
            INNER JOIN RMA_Refund Refund WITH(NOLOCK) 
                ON Refund.SysNo = RRI.RefundSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item SI WITH(NOLOCK)  
                ON SI.ProductSysNo = RR.ProductSysNo 
                AND SI.SoSysNo = Refund.SOSysNo 
            WHERE 
                SI.WareHouseNumber=@InvoiceLocation 
                AND Refund.SOSysNo=@SOSysNo 
                AND Refund.[status]=2 
        )
GROUP BY sosysno
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundShipPriceBySOSysNoAndOtherWareHouseNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT     
   TotalShipPriceAmt=ISNULL(SUM(ISNull(CompensateShipPrice,0)),0) 
FROM [IPP3].[dbo].[RMA_Refund] With(NOLOCK)
WHERE 
    Status = @Status 
    AND SOSysNo = @SOSysNo 
    AND SysNo Not IN(
            SELECT 
                Refund.sysno 
            FROM RMA_Register RR WITH(NOLOCK) 
            INNER JOIN RMA_Refund_Item RRI WITH(NOLOCK) 
                ON RR.SysNo = RRI.RegisterSysNo 
            INNER JOIN RMA_Refund Refund WITH(NOLOCK) 
                ON Refund.SysNo = RRI.RefundSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item SI WITH(NOLOCK)  
                ON SI.ProductSysNo = RR.ProductSysNo 
                AND SI.SoSysNo = Refund.SOSysNo 
            WHERE 
                SI.WareHouseNumber=@InvoiceLocation 
                AND Refund.SOSysNo=@SOSysNo 
                AND Refund.[status]=2 
        )
GROUP BY sosysno
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetWaitingSOForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          DISTINCT [SOSysNo] 
      FROM [dbo].[RMA_Request] Request WITH(NOLOCK) 
        INNER JOIN [dbo].[RMA_Request_Item] RRI WITH(NOLOCK) 
          ON Request.[SysNo] = RRI.[RequestSysNo] 
        INNER JOIN [dbo].[RMA_Register] RR WITH(NOLOCK) 
          ON RRI.[RegisterSysNo] = RR.[SysNo] 
      WHERE 
          RR.[RefundStatus] = @RegisterRefundStatus 
          AND RR.[Status] <> @RegisterStatus          
          AND RR.[SysNo] NOT IN ( 
            SELECT 
                RRI.[RegisterSysNo] 
            FROM [dbo].[RMA_Refund] Refund WITH(NOLOCK) 
              INNER JOIN [dbo].[RMA_Refund_Item] RRI WITH(NOLOCK) 
                ON Refund.[SysNo] = RRI.[RefundSysNo] 
            WHERE 
                Refund.[Status] <> @RefundStatus 
          )
      ]]>
    </commandText>
    <parameters>
      <param name="@RegisterRefundStatus" dbType="Int32" />
      <param name="@RegisterStatus" dbType="Int32" />
      <param name="@RefundStatus" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryWaitingRegisterForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT DISTINCT 
	        AAA.[SysNo] AS [SysNo] 
         ,AAA.[CompanyCode]
         ,AAA.[ProductSysNo] 
         ,AAA.[SOSysNo] 
         ,AAA.[CustomerName] 
         ,AAA.[ProductID] 
         ,AAA.[ProductName] 
         ,AAC.[SysNo] AS [WarehouseSysNo] 
         ,AAC.[StockName] AS [ShippedWarehouse] 
      FROM ( 
              SELECT 
                  DISTINCT A.[SysNo] 
                 ,A.[CompanyCode]
                 ,F.[CustomerName] 
                 ,A.[ProductSysNo] 
                 ,E.[ProductID] 
                 ,CASE A.SOItemType 
                      WHEN 4 THEN D.BriefName 
                      ELSE E.BriefName 
                  END [ProductName] 
                 ,C.[SOSysNo] 
              FROM [dbo].[RMA_Register] A WITH(NOLOCK) 
              INNER JOIN [dbo].[RMA_Request_Item] B WITH(NOLOCK) 
                  ON A.[SysNo] = B.[RegisterSysNo] 
              INNER JOIN [dbo].[RMA_Request] C WITH(NOLOCK) 
                  ON B.[RequestSysNo] = C.[SysNo] 
              INNER JOIN [OverseaContentManagement].[dbo].[V_CM_ItemBasicInfo] E WITH(NOLOCK) 
                  ON A.[ProductSysNo] = E.[SysNo] 
              INNER JOIN [OverseaCustomerManagement].[dbo].[V_CUM_CustomerBaseInfo] F WITH(NOLOCK) 
                  ON C.[CustomerSysNo] = F.[SysNo] 
              LEFT JOIN [OverseaOrderManagement].[dbo].[V_OM_SO_Item] D WITH(NOLOCK) 
                  ON C.[SOSysNo] = D.[SOSysNo] AND D.[ProductType] = 4 AND D.[MasterProductSysNo] = CAST(A.[ProductSysNo] AS nvarchar) 
              WHERE 
                  A.[RefundStatus] = 0                   
                  AND A.[SysNo] NOT IN( 
                          SELECT  
                              AA.[SysNo] 
                          FROM  [dbo].[RMA_Register] AA WITH(NOLOCK) 
                          INNER JOIN [dbo].[RMA_Refund_Item] AB WITH(NOLOCK) 
                              ON AA.[SysNo] = AB.[RegisterSysNo] 
                          INNER JOIN [dbo].[RMA_Refund] AC WITH(NOLOCK) 
                              ON AB.[RefundSysNo] = AC.[SysNo] 
                          WHERE 
                              AC.[Status] <> @RefundStatus
                      ) 
                  AND #SOSysNo#
           ) AS AAA 
      INNER JOIN [OverseaOrderManagement].[dbo].[V_OM_SO_Item] AAB WITH(NOLOCK)
          ON AAA.[SOSysNo] = AAB.[SOSysNo] AND AAA.[ProductSysNo] = AAB.[ProductSysNo] 
      INNER JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] AAC WITH(NOLOCK) 
          ON AAB.[WarehouseNumber] = AAC.[SysNo]     
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@RefundStatus" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRegistersForCreate" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          [SysNo] 
         ,[ProductSysNo] as [BasicInfo.ProductSysNo]
         ,[SOItemType] as [BasicInfo.SOItemType]
         ,[LocationWarehouse] as [BasicInfo.LocationWarehouse]
      FROM dbo.[RMA_Register] WITH(NOLOCK) 
      WHERE 
          [SysNo] IN (#SysNoList)     
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetRefundItemsByRegisterSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          A.RegisterSysNo 
      FROM dbo.[RMA_Refund_Item] AS A WITH (NOLOCK) 
	      INNER JOIN dbo.[RMA_Refund] AS B WITH (NOLOCK) 
		      ON A.RefundSysNo = B.SysNo 
      WHERE (A.RegisterSysNo IN (#SysNoList)) 
	      AND (B.Status > - 1)       
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetRefundSysNoByRegisterSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          B.SysNo
      FROM dbo.[RMA_Refund_Item] AS A WITH (NOLOCK) 
	      INNER JOIN dbo.[RMA_Refund] AS B WITH (NOLOCK) 
		      ON A.RefundSysNo = B.SysNo 
      WHERE A.RegisterSysNo = @RegisterSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@RegisterSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundBySOSysNoAndProductSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[       
SELECT 
    Count(a.[SysNo])
FROM [IPP3].[dbo].[RMA_Refund] AS a WITH(NOLOCK) 
INNER JOIN [IPP3].[dbo].[RMA_Refund_Item] AS b WITH(NOLOCK) 
    ON b.RefundSysNo=a.SysNo 
INNER JOIN [IPP3].[dbo].RMA_Register AS c WITH(NOLOCK) 
    ON b.RegisterSysNo=c.SysNo 
WHERE 
    c.ProductSysNo=@ProductSysNo 
    AND a.[SOSysNo]=@SOSysNo 
    AND a.[Status]<>-1   
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreateRefundSysNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      INSERT INTO dbo.[RMA_Refund_Sequence]
      (
        [CreateTime]
      ) 
      VALUES
      (
        GETDATE()
      )
      SELECT SCOPE_IDENTITY()
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="InsertRefundMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			INSERT INTO dbo.[RMA_Refund] 
			(
        [SysNo],
        [RefundID],
        [SOSysNo],
        [CustomerSysNo],
        [AuditTime],
        [AuditUserSysNo],
        [RefundTime],
        [RefundUserSysNo],
        [CompensateShipPrice],
        [SOCashPointRate],
        [OrgCashAmt],
        [OrgPointAmt],
        [DeductPointFromAccount],
        [DeductPointFromCurrentCash],
        [CashAmt],
        [PointAmt],
        [RefundPayType],
        [Note],
        [Status],
        [CashFlag],
        [FinanceNote],
        [InvoiceLocation],
        [SOInvoiceNo],
        [RefundReason],
        [CreateTime],
        [CreateUserSysNo],
        [CompanyCode],
        OrgGiftCardAmt,
        GiftCardAmt,
        PriceprotectPoint
			)
			VALUES
			(
			  @SysNo,
			  @RefundID,
			  @SOSysNo,
			  @CustomerSysNo,
			  @AuditTime,
			  @AuditUserSysNo,
			  @RefundTime,
			  @RefundUserSysNo,
			  @CompensateShipPrice,
			  @SOCashPointRate,
			  @OrgCashAmt,
			  @OrgPointAmt,
			  @DeductPointFromAccount,
			  @DeductPointFromCurrentCash,
			  @CashAmt,
			  @PointAmt,
			  @RefundPayType,
			  @Note,
			  @Status,
			  @CashFlag,
			  @FinanceNote,
			  @InvoiceLocation,
			  @SOInvoiceNo,
			  @RefundReason,
			  GETDATE(),
			  @CreateUserSysNo,
        @CompanyCode,
        @OrgGiftCardAmt,
        @GiftCardAmt,
        @PriceprotectPoint
			)
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundID" dbType="String" />
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@RefundTime" dbType="DateTime" />
      <param name="@RefundUserSysNo" dbType="Int32" />
      <param name="@CompensateShipPrice" dbType="Decimal" />
      <param name="@SOCashPointRate" dbType="Decimal" />
      <param name="@OrgCashAmt" dbType="Decimal" />

      <param name="@OrgGiftCardAmt" dbType="Decimal" />
      <param name="@GiftCardAmt" dbType="Decimal" />

      <param name="@OrgPointAmt" dbType="Int32" />
      <param name="@DeductPointFromAccount" dbType="Int32" />
      <param name="@DeductPointFromCurrentCash" dbType="Decimal" />
      <param name="@CashAmt" dbType="Decimal" />
      <param name="@PointAmt" dbType="Int32" />
      <param name="@RefundPayType" dbType="Int32" />
      <param name="@Note" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@CashFlag" dbType="Int32" />
      <param name="@FinanceNote" dbType="String" />
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" />
      <param name="@SOInvoiceNo" dbType="AnsiString" />
      <param name="@RefundReason" dbType="Int32" />
      <!--<param name="@CreateTime" dbType="DateTime" property="[Now]"/>-->
      <param name="@CreateUserSysNo" dbType="Int32" property="[UserSysNo]"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@PriceprotectPoint" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="InsertRefundItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			INSERT INTO dbo.[RMA_Refund_Item] 
			(
			  [RefundSysNo],
			  [RegisterSysNo],
			  [OrgPrice],
			  [UnitDiscount],
			  [ProductValue],
			  [OrgPoint],
			  [RefundPrice],
			  [PointType],
			  [RefundCash],
			  [RefundPoint],
			  [RefundPriceType],
			  [RefundCost],
			  [RefundCostPoint],
			  [RefundCostWithoutTax],
        [CompanyCode],
        OrgGiftCardAmt
			)
			VALUES
			(
			  @RefundSysNo,
			  @RegisterSysNo,
			  @OrgPrice,
			  @UnitDiscount,
			  @ProductValue,
			  @OrgPoint,
			  @RefundPrice,
			  @PointType,
			  @RefundCash,
			  @RefundPoint,
			  @RefundPriceType,
			  @RefundCost,
			  @RefundCostPoint,
			  @RefundCostWithoutTax,
        @CompanyCode,
        @OrgGiftCardAmt
			)
      SELECT SCOPE_IDENTITY()
			]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
      <param name="@RegisterSysNo" dbType="Int32" />
      <param name="@OrgPrice" dbType="Decimal" />
      <param name="@UnitDiscount" dbType="Decimal" />
      <param name="@ProductValue" dbType="Decimal" />
      <param name="@OrgPoint" dbType="Int32" />
      <param name="@OrgGiftCardAmt" dbType="Decimal" />
      <param name="@RefundPrice" dbType="Decimal" />
      <param name="@PointType" dbType="Int32" />
      <param name="@RefundCash" dbType="Decimal" />
      <param name="@RefundPoint" dbType="Int32" />
      <param name="@RefundPriceType" dbType="Int32" />
      <param name="@RefundCost" dbType="Decimal" />
      <param name="@RefundCostPoint" dbType="Int32" />
      <param name="@RefundCostWithoutTax" dbType="Decimal" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetWarehouseNumberForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1  
          SI.WareHouseNumber WarehouseNo
      FROM RMA_Register RR WITH(NOLOCK) 
        INNER JOIN RMA_Refund_Item RRI WITH(NOLOCK) 
          ON RR.SysNo = RRI.RegisterSysNo 
        INNER JOIN RMA_Refund Refund WITH(NOLOCK) 
          ON Refund.SysNo = RRI.RefundSysNo 
        INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item SI WITH(NOLOCK)  
          ON SI.ProductSysNo = RR.ProductSysNo 
          AND SI.SoSysNo = Refund.SOSysNo 
      WHERE 
          RRI.RefundSysNo = @RefundSysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
            A.[SysNo] 
           ,A.[RefundID] 
           ,A.[SOSysNo] 
           ,A.[CustomerSysNo] 
           ,A.[CreateTime] 
           ,A.[CreateUserSysNo] 
           ,A.[AuditTime] 
           ,A.[AuditUserSysNo] 
           ,A.[RefundTime] 
           ,A.[RefundUserSysNo] 
           ,A.[CompensateShipPrice] 
           ,A.[SOCashPointRate] 
           ,A.[OrgCashAmt] 
           ,A.[OrgPointAmt] 
           ,A.[DeductPointFromAccount] 
           ,A.[DeductPointFromCurrentCash] 
           ,A.[CashAmt] 
           ,A.[PointAmt] 
           ,A.[OrgGiftCardAmt] 
           ,A.[GiftCardAmt] 
           ,A.[PriceprotectPoint]
           ,A.[RefundPayType] 
           ,A.[Note] 
           ,A.[Status] 
           ,A.[CashFlag] 
           ,A.[FinanceNote] 
           ,A.[InvoiceNo] 
           ,A.[InvoiceLocation] 
           ,A.[SOInvoiceNo] 
           ,B.[RefundReason] 
           ,A.[InvoiceCreateTime]
           ,A.[GiftCardAmt]
           ,A.[PriceprotectPoint]
           ,A.[CompanyCode]
          FROM dbo.[RMA_Refund] A with(nolock)
        LEFT OUTER JOIN [OverseaInvoiceReceiptManagement].[dbo].[V_IM_SOIncomeBankInfo] B WITH(NOLOCK)
          ON A.[SysNo] = B.[OrderSysNo] 
        LEFT OUTER JOIN OverseaCustomerManagement.[dbo].[V_CUM_CustomerBaseInfo] C WITH(NOLOCK) 
          ON A.[CustomerSysNo] = C.[SysNo]           
        WHERE A.[SysNo] = @SysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateRefundMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE dbo.[RMA_Refund] 
        SET [RefundPayType] = ISNULL(@RefundPayType, [RefundPayType]) 
          ,[Note] = ISNULL(@Note, [Note]) 
          ,[CashFlag] = ISNULL(@CashFlag, [CashFlag]) 
          ,[SOInvoiceNo] = ISNULL(@SOInvoiceNo, [SOInvoiceNo]) 
          ,[RefundReason] = ISNULL(@RefundReason, [RefundReason]) 
          ,[FinanceNote] = ISNULL(@FinanceNote, [FinanceNote])
          ,[InvoiceLocation] = ISNULL(@InvoiceLocation, [InvoiceLocation]) 
          ,[Status] = ISNULL(@Status, [Status]) 
          ,[AuditTime] = ISNULL(@AuditTime, [AuditTime])
          ,[AuditUserSysNo] = ISNULL(@AuditUserSysNo, [AuditUserSysNo])
          ,[RefundTime] = ISNULL(@RefundTime, [RefundTime])
          ,[RefundUserSysNo] = ISNULL(@RefundUserSysNo, [RefundUserSysNo])
        WHERE
          [SysNo] = @SysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundPayType" dbType="Int32" />
      <param name="@Note" dbType="String" />
      <param name="@CashFlag" dbType="Int32" />
      <param name="@SOInvoiceNo" dbType="AnsiString" />
      <param name="@RefundReason" dbType="Int32" />
      <param name="@FinanceNote" dbType="String" />
      <param name="@InvoiceLocation" dbType="AnsiStringFixedLength" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@RefundTime" dbType="DateTime" />
      <param name="@RefundUserSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          A.[SysNo] 
         ,A.[RefundSysNo] 
         ,A.[RegisterSysNo] 
         ,A.[OrgPrice] 
         ,A.[UnitDiscount] 
         ,A.[ProductValue] 
         ,A.[OrgPoint] 
         ,A.[RefundPrice] 
         ,A.[PointType] 
         ,A.[RefundCash] 
         ,A.[RefundPoint] 
         ,A.[RefundPriceType] 
         ,A.[RefundCost] 
         ,A.[RefundCostPoint] 
         ,A.[RefundCostWithoutTax] 
         ,B.[ProductSysNo] 
      FROM dbo.[RMA_Refund_Item] A WITH(NOLOCK) 
        INNER JOIN dbo.[RMA_Register] B WITH(NOLOCK) 
          ON A.[RegisterSysNo] = B.[SysNo] 
      WHERE
        [RefundSysNo] = @RefundSysNo
         AND A.[CompanyCode] = @CompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetItemsWithProductInfoByRefundSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          B.[SysNo] 
         ,B.[OrgPrice]	-- 订单当时价格
         ,B.[UnitDiscount]	-- 促销价值
         ,B.[ProductValue]	-- 商品价值
         ,B.[RefundPrice]	-- 退款价值
         ,B.[RefundPrice] as RealOrgPrice --同IPP一致，默认该价格为订单处理核算过的原始价格 fix bug 89685 by jack 2012-10-24
         ,B.[RefundPriceType]	-- 退款计算类型
         ,B.[PointType]	-- 支付种类
         ,B.[OrgPoint]	-- 原始赠送积分
         ,B.[RefundCash]		-- 初算退款现金
         ,B.[RefundPoint]	-- 初算退款积分
         ,B.[OrgGiftCardAmt]--初算退礼品卡
         ,C.[SysNo] AS RegisterSysNo	-- 单件编号
         ,C.[SOItemType]   -- 
         ,C.[ProductSysNo]    
         ,CASE C.SOItemType 
              WHEN 4 THEN E.BriefName 
              ELSE D.BriefName 
          END [ProductName]	-- 商品名称
         ,D.[ProductID]	-- 商品 ID
      FROM ipp3.[dbo].[RMA_Refund] A WITH(NOLOCK) 
      INNER JOIN [dbo].[RMA_Refund_Item] B WITH(NOLOCK) 
          ON A.[SysNo] = B.[RefundSysNo] 
      INNER JOIN [dbo].[RMA_Register] C WITH(NOLOCK) 
          ON B.[RegisterSysNo] = C.[SysNo] 
      INNER JOIN OverseaContentManagement.[dbo].[V_CM_ItemBasicInfo] D WITH(NOLOCK) 
          ON C.[ProductSysNo] = D.[SysNo] 
      LEFT JOIN [OverseaOrderManagement].[dbo].[V_OM_SO_Item] E WITH(NOLOCK) 
          ON A.[SOSysNo] = E.[SOSysNo] AND E.[ProductType] = 4 AND E.[MasterProductSysNo] = CAST(C.[ProductSysNo] AS nvarchar) 
      WHERE 
          B.[RefundSysNo] = @RefundSysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPriceprotectPointFormRefundSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[       
          SELECT 
    SUM(a.Point*a.Quantity) 
FROM [OverseaCustomerManagement].[dbo].[V_CUM_Customer_PointAddRequestItem] AS a WITH(NOLOCK) 
INNER JOIN [OverseaCustomerManagement].[dbo].[V_CUM_Customer_PointAddRequest] AS b WITH(NOLOCK) 
    ON b.sysno=a.[PointAddRequestSysNo] 
WHERE 
    b.SOSysNo=@SOSysNo 
    AND b.[Status]=1 
    AND a.ProductSysNo IN ( 
            SELECT 
                DISTINCT ProductSysNo 
            FROM [IPP3].[dbo].[RMA_Register] WITH(NOLOCK) 
            WHERE 
                sysno IN( 
                        SELECT 
                            RegisterSysNo 
                        FROM [IPP3].[dbo].[RMA_Refund_Item] WITH(NOLOCK) 
                        WHERE 
                            RefundSysNo=@RefundSysNo 
                    ) 
        )    
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@RefundSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateRefundMasterForCalc" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE dbo.[RMA_Refund] 
        SET [CompensateShipPrice] = ISNULL(@CompensateShipPrice, [CompensateShipPrice])
          ,[OrgCashAmt] = ISNULL(@OrgCashAmt, [OrgCashAmt])
          ,[OrgPointAmt] = ISNULL(@OrgPointAmt, [OrgPointAmt])
          ,[DeductPointFromAccount] = ISNULL(@DeductPointFromAccount, [DeductPointFromAccount])
          ,[DeductPointFromCurrentCash] = ISNULL(@DeductPointFromCurrentCash, [DeductPointFromCurrentCash])
          ,[CashAmt] = ISNULL(@CashAmt, [CashAmt])
          ,[PointAmt] = ISNULL(@PointAmt, [PointAmt])
          ,[RefundPayType] = ISNULL(@RefundPayType, [RefundPayType])
          ,GiftCardAmt= @GiftCardAmt
          ,OrgGiftCardAmt= @OrgGiftCardAmt
          ,[PriceprotectPoint] = @PriceprotectPoint
          ,[CashFlag] = @CashFlag
        WHERE
          [SysNo] = @SysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@CompensateShipPrice" dbType="Decimal" />
      <param name="@OrgCashAmt" dbType="Decimal" />
      <param name="@OrgPointAmt" dbType="Int32" />
      <param name="@DeductPointFromAccount" dbType="Int32" />
      <param name="@DeductPointFromCurrentCash" dbType="Decimal" />
      <param name="@CashAmt" dbType="Decimal" property="CashAmt"/>
      <param name="@RefundPayType" dbType="Int32" />
      <param name="@PriceprotectPoint" dbType="Int32" />
      <param name="@GiftCardAmt" dbType="Decimal" />
      <param name="@OrgGiftCardAmt" dbType="Decimal" />
      <param name="@PointAmt" dbType="Int32" property="PointAmt"/>
      <param name="@CashFlag" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateRefundItemForCalc" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE dbo.[RMA_Refund_Item] 
      SET [RefundPrice] = ISNULL(@RefundPrice, [RefundPrice]) 
         ,[RefundPriceType] = ISNULL(@RefundPriceType, [RefundPriceType])
         ,[RefundCash] = ISNULL(@RefundCash, [RefundCash]) 
         ,[RefundPoint] = ISNULL(@RefundPoint, [RefundPoint]) 
         ,OrgGiftCardAmt= @OrgGiftCardAmt
      WHERE
        [SysNo] = @SysNo        
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundPrice" dbType="Decimal" />
      <param name="@RefundPriceType" dbType="Int32" />
      <param name="@RefundCash" dbType="Decimal" />
      <param name="@RefundPoint" dbType="Int32" />
      <param name="@OrgGiftCardAmt" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="BatchUpdateRegisterRefundStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE dbo.[RMA_Register] 
        SET [RefundStatus] = @RefundStatus 
      WHERE 
          [SysNo] IN
	        ( 
		        SELECT 
			        [RegisterSysNo] 
		        FROM [RMA_Refund_Item] WITH(NOLOCK) 
		        WHERE 
			        [RefundSysNo] = @RefundSysNo
	        )          
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
      <param name="@RefundStatus" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSOAmountForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       EXEC OverseaServiceManagement.[dbo].[UP_IPP3_GetSOAmountForRefund] @RefundSysNo,@CompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetROAmountForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      EXEC .OverseaServiceManagement.[dbo].[UP_IPP3_GetROAmountForRefund] @RefundSysNo,@CompanyCode  
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRegistersForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
         A.[SysNo] as [ItemSysNo]
	      ,A.[RegisterSysNo]
	      ,B.[RevertStatus]
        ,B.[SOItemType] as [ProductType]
	      ,C.[WarehouseNumber] AS SalesWarehouse
			  ,B.[Cost]
			  ,F.ReceiveWarehouse
			  ,C.ProductSysNo
      FROM dbo.[RMA_Refund_Item] A WITH(NOLOCK)
        INNER JOIN dbo.[RMA_Register] B WITH(NOLOCK)
	        ON A.[RegisterSysNo] = B.[SysNo]
		  INNER JOIN dbo.RMA_Request_Item E WITH(NOLOCK)
		     ON E.[RegisterSysNo] = A.RegisterSysNo
		  INNER JOIN RMA_Request F WITH(NOLOCK)
		     ON E.RequestSysNo = F.SysNo
        INNER JOIN OverseaOrderManagement.dbo.[V_OM_SO_Item] C WITH(NOLOCK)
	        ON B.[ProductSysNo] = C.[ProductSysNo]
        INNER JOIN dbo.[RMA_Refund] D WITH(NOLOCK)
	        ON C.[SOSysNo] = D.[SOSysNo]  AND D.[SysNo] = A.[RefundSysNo]
		  WHERE D.[SysNo] = @RefundSysNo  
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundItemCost" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
    SELECT 
        D.[Cost] AS [RefundCost] 
       ,D.[Point] AS [RefundCostPoint] 
       ,D.[UnitCostWithoutTax] AS [RefundCostWithoutTax] 
    FROM dbo.[RMA_Refund_Item] A WITH(NOLOCK) 
    INNER JOIN dbo.[RMA_Register] B WITH(NOLOCK) 
        ON A.[RegisterSysNo] = B.[SysNo] 
    INNER JOIN dbo.[RMA_Refund] C WITH(NOLOCK) 
        ON A.[RefundSysNo] = C.[SysNo] 
    INNER JOIN OverseaOrderManagement.dbo.[V_OM_SO_Item] D WITH(NOLOCK) 
        ON D.[SOSysNo] = C.[SOSysNo] 
        AND D.ProductType=B.SoItemType 
        AND ((D.ProductType IN (0,1,5,6) AND D.ProductSysNo = B.ProductSysNo)         
        OR (D.ProductType = 4 AND D.MasterProductSysNo = CAST(B.ProductSysNo AS nvarchar(20))))
	    WHERE A.[SysNo] = @SysNo        
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateRefundItemForRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE dbo.[RMA_Refund_Item] 
      SET [RefundCost] = ISNULL(@RefundCost, [RefundCost]) 
         ,[RefundCostPoint] = ISNULL(@RefundCostPoint, [RefundCostPoint]) 
         ,[RefundCostWithoutTax] = ISNULL(@RefundCostWithoutTax, [RefundCostWithoutTax]) 
      WHERE
        [SysNo] = @SysNo        
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundCost" dbType="Decimal" />
      <param name="@RefundCostPoint" dbType="Int32" />
      <param name="@RefundCostWithoutTax" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundMasterByOrderSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT [SysNo] 
           ,[RefundID] 
           ,[SOSysNo] 
           ,[CustomerSysNo] 
           ,[CreateTime] 
           ,[CreateUserSysNo] 
           ,[AuditTime] 
           ,[AuditUserSysNo] 
           ,[RefundTime] 
           ,[RefundUserSysNo] 
           ,[CompensateShipPrice] 
           ,[SOCashPointRate] 
           ,[OrgCashAmt] 
           ,[OrgPointAmt] 
           ,[DeductPointFromAccount] 
           ,[DeductPointFromCurrentCash] 
           ,[CashAmt] 
           ,[PointAmt] 
           ,[RefundPayType] 
           ,[Note] 
           ,[Status] 
           ,[CashFlag] 
           ,[FinanceNote] 
           ,[InvoiceNo] 
           ,[InvoiceLocation] 
           ,[SOInvoiceNo] 
           ,[RefundReason] 
           ,[InvoiceCreateTime]
           ,[GiftCardAmt]
           ,[PriceprotectPoint]
           ,[CompanyCode]
          FROM dbo.[RMA_Refund] 
        WHERE [SOSysNo] = @OrderSysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@OrderSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundReasons" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT 		
	ReasonNumber as [Code],
	[Description] as [Name]
FROM OverseaServiceManagement.dbo.V_SM_RefundReason WITH(NOLOCK)          
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetAutoRMARefundBySoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT Count(1)
  FROM [OverseaServiceManagement].[dbo].[V_SM_RMARefundMaster] WITH(NOLOCK) 
WHERE 
    [SOSysNo]=@SOSysNo
    AND [RefundReason]=2
    AND Status=2
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundPrintDetail" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
         A.[SysNo]
        ,A.[RefundID]
        ,A.[SOSysNo]
	      ,A.[DeductPointFromCurrentCash]
	      ,A.[CompensateShipPrice]
	      ,A.[CashAmt] as [CashAmount]
	      ,A.[PointAmt] as [PointAmount]
	      ,A.[CustomerSysNo]
	      ,A.[RefundPayType]
	      ,B.[CustomerName]
	      ,B.[ReceiveName]
	      ,B.[ReceiveAddress]
	      ,B.[ReceivePhone]
	      ,C.[DisplayName] AS [AuditUserName]
      FROM [dbo].[RMA_Refund] A WITH(NOLOCK) 
        LEFT JOIN [OverseaCustomerManagement].[dbo].[V_CUM_CustomerInfoWithShippingAddress] B WITH(NOLOCK)
	        ON A.[CustomerSysNo] = B.[CustomerSysNo] AND B.[IsDefault] = 1
        LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] C WITH(NOLOCK)
	        ON A.[AuditUserSysNo] = C.[UserSysNo]
      WHERE A.[SysNo] = @SysNo        
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRefundPrintItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
          B.[SysNo] 
         ,B.[OrgPrice]	-- 订单当时价格
         ,B.[UnitDiscount]	-- 促销价值
         ,B.[ProductValue]	-- 商品价值
         ,B.[RefundPrice]	-- 退款价值
         ,B.[RefundPriceType]	-- 退款计算类型
         ,B.[PointType]	-- 支付种类
         ,B.[OrgPoint]	-- 原始赠送积分
         ,B.[RefundCash]		-- 初算退款现金
         ,B.[RefundPoint]	-- 初算退款积分
         ,B.[OrgGiftCardAmt]--初算退礼品卡
         ,C.[SysNo] AS RegisterSysNo	-- 单件编号
         ,C.[SOItemType]   -- 
         ,C.[ProductSysNo]   
         ,CASE C.SOItemType 
              WHEN 4 THEN E.BriefName 
              ELSE D.BriefName 
          END [ProductName]	-- 商品名称
         ,D.[ProductID]	-- 商品 ID
      FROM [dbo].[RMA_Refund] A WITH(NOLOCK) 
      INNER JOIN [dbo].[RMA_Refund_Item] B WITH(NOLOCK) 
          ON A.[SysNo] = B.[RefundSysNo] 
      INNER JOIN [dbo].[RMA_Register] C WITH(NOLOCK) 
          ON B.[RegisterSysNo] = C.[SysNo] 
      INNER JOIN OverseaContentManagement.[dbo].[V_CM_ItemBasicInfo] D WITH(NOLOCK) 
          ON C.[ProductSysNo] = D.[SysNo] 
      LEFT JOIN [OverseaOrderManagement].[dbo].[V_OM_SO_Item] E WITH(NOLOCK) 
          ON A.[SOSysNo] = E.[SOSysNo] AND E.[ProductType] = 4 AND E.[MasterProductSysNo] = CAST(C.[ProductSysNo] AS nvarchar) 
      WHERE 
          A.[SysNo] = @RefundSysNo          
      ]]>
    </commandText>
    <parameters>
      <param name="@RefundSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>


  <dataCommand name="GetMSMQAddressByStockID" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
       SELECT MSMQAddress FROM DropShip.dbo.ShippingProcess_AppConfig WITH (NOLOCK) 
       WHERE WarehouseNumber = @WarehouseNumber
      ]]>
    </commandText>
    <parameters>
      <param name="@WarehouseNumber" dbType="String" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateRefundPayTypeAndReason" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
      UPDATE IPP3.dbo.RMA_Refund SET
        RefundPayType = @RefundPayType,
        RefundReason = @RefundReason
      WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundPayType" dbType="Int32" />
      <param name="@RefundReason" dbType="Int32" />
    </parameters>
  </dataCommand>
</dataOperations>
