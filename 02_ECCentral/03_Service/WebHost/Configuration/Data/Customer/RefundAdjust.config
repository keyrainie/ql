<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation"
				xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dataCommand name="Customer_Query_RefundAdjust" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(R.SysNo) 
            FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
            INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster ref WITH(NOLOCK)
            ON R.RequestSysNo=ref.SysNo
             #StrWhere#

				 ;WITH TempTable AS (
				 SELECT  R.[SysNo]
						  ,Row_Number() OVER (Order BY  #SortColumnName#) AS RowNumber
					FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT JOIN OverseaControlPanel.dbo.V_Sys_User uu WITH(NOLOCK)
            ON R.RefundUserSysNo=uu.SysNo
            LEFT JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster ref WITH(NOLOCK)
            ON R.RequestSysNo=ref.SysNo
					 #StrWhere#  
										 )

       SELECT 
          R.SysNo AS AdjustSysNo,        
          R.AdjustOrderType ,
          R.RequestSysNo AS RequestSysNo,
          ref.RequestID AS RequestID,
          R.SOSysNo AS SOSysNo,
          R.CustomerSysNo ,
          c.customerid AS CustomerID,      
          R.CreateTime ,
          R.CreateUserSysNo ,
          R.RefundTime ,
          R.RefundUserSysNo ,
          R.CashAmt ,
          R.Status ,
          R.Note ,
          R.RefundPayType ,
          R.CompanyCode ,
          R.BankName,
          R.BranchBankName,
          R.CardNumber,
          R.CardOwnerName,
          u.UserName as CreateUserName,
          uu.UserName as RefundUserName
          FROM TempTable
            INNER JOIN [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
                ON TempTable.SysNo = R.SysNo
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
              LEFT JOIN OverseaControlPanel.dbo.V_Sys_User uu WITH(NOLOCK)
            ON R.RefundUserSysNo=uu.SysNo
             LEFT JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster ref WITH(NOLOCK)
            ON R.RequestSysNo=ref.SysNo
          WHERE RowNumber > @StartNumber AND RowNumber <= @EndNumber 
          ORDER BY RowNumber  

 ]]>
    </commandText>
  </dataCommand>
  <dataCommand name="Customer_Create_RefundAdjust" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
                 INSERT INTO OverseaCustomerManagement.dbo.RO_Adjust
                        ( 
                          AdjustOrderType,
                          RequestSysNo ,
                          SOSysNo ,
                          CustomerSysNo ,                        
                          CreateTime ,
                          CreateUserSysNo ,
                          RefundUserSysNo ,
                          CashAmt ,
                          Status ,
                          Note ,
                          InvoiceNo ,
                          RefundPayType ,
                          BankName ,
                          BranchBankName ,
                          CardNumber ,
                          CardOwnerName ,
                          InvoiceCreateTime ,
                          CompanyCode ,
                          LanguageCode ,
                          CurrencySysNo ,
                          StoreCompanyCode ,
                          GiftCardAmt ,
                          PointAmt ,
                          IsSAPImported                          
                        )
                VALUES  (
                          @AdjustOrderType,
                          @RequestSysNo ,
                          @SOSysNo ,
                          @CustomerSysNo ,
                          GETDATE(), -- CreateTime - datetime
                          @CreateUserSysNo,
                          @RefundUserSysNo,
                          @CashAmt,
                          @Status ,
                          @Note ,
                          NULL , -- InvoiceNo - nvarchar(200)
                          @RefundPayType,
                          @BankName ,
                          @BranchBankName ,
                          @CardNumber ,
                          @CardOwnerName ,
                          null,
                          @CompanyCode ,
                          'zh-CN',
                          null,
                          '8601' ,
                          NULL , -- GiftCardAmt - decimal
                          0 , -- PointAmt - int
                          'N'  -- IsSAPImported - char(1)                          
                        )
       ]]>
    </commandText>
    <parameters>
      <param name="@AdjustOrderType" dbType="Int32" />
      <param name="@RequestSysNo" dbType="Int32" />
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@CreateUserSysNo" dbType="Int32" />
      <param name="@RefundUserSysNo" dbType="Int32" />
      <param name="@CashAmt" dbType="Decimal" />
      <param name="@Status" dbType="Int32" />
      <param name="@Note" dbType="String" />
      <param name="@RefundPayType" dbType="Int32" />
      <param name="@BankName" dbType="String" />
      <param name="@BranchBankName" dbType="String" />
      <param name="@CardNumber" dbType="String" />
      <param name="@CardOwnerName" dbType="String" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_Get_RequestDetailBySoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
              SELECT TOP 1 
                        req.SOSysNo AS SOSysNo, 
                        v.sysno AS CustomerSysNo, 
                        v.customerid AS CustomerID,
                        req.RequestID,
                        req.SysNo AS RequestSysNo
              FROM      OverseaServiceManagement.dbo.V_SM_RMARequestMaster req WITH ( NOLOCK ) 
                        INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo v WITH ( NOLOCK ) 
                        ON req.CustomerSysNo = v.sysno 
              WHERE req.SOSysNo=@SOSysNo AND req.CompanyCode=@CompanyCode
              ORDER BY req.CreateTime DESC
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_Get_CustomerIDBySoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
              SELECT TOP 1 
                        so.SysNo AS SOSysNo, 
                        v.sysno AS CustomerSysNo, 
                        v.customerid AS CustomerID
              FROM      OverseaOrderManagement.dbo.V_OM_SO_Master so WITH ( NOLOCK ) 
                        INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo v WITH ( NOLOCK ) 
                        ON so.CustomerSysNo = v.sysno 
              WHERE so.SysNo=@SOSysNo AND  so.CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_RequestStatusBySoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT  TOP 1 [Status]
          FROM    OverseaServiceManagement.dbo.V_SM_RMARequestMaster WITH ( NOLOCK )
          WHERE   SOSysNo=@SOSysNo
          ORDER BY CreateTime DESC
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_Update_RequestStatusSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE TOP(1) OverseaCustomerManagement.[dbo].[RO_Adjust] SET Status=@Status
		      WHERE SysNo=@SysNo AND CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@Status" dbType="Int32" />
      <param name="@SysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_Audit_RequestAdjust" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE TOP(1) OverseaCustomerManagement.[dbo].[RO_Adjust] SET Status=@Status,RefundUserSysNo=@RefundUserSysNo,RefundTime=@RefundTime
		      WHERE SysNo=@SysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@Status" dbType="Int32" />
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefundUserSysNo" dbType="Int32" />
      <param name="@RefundTime" dbType="DateTime" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_Get_RefundDetailBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
  SELECT 
          R.SysNo AS AdjustSysNo,        
          R.AdjustOrderType ,
          R.RequestSysNo AS RequestSysNo,
          ref.RequestID AS RequestID,
          R.SOSysNo AS SOSysNo,
          R.CustomerSysNo ,
          c.customerid AS CustomerID,      
          R.CreateTime ,
          R.CreateUserSysNo ,
          R.RefundTime ,
          R.RefundUserSysNo ,
          R.CashAmt ,
          R.BankName,
          R.BranchBankName,
          R.CardNumber,
          R.CardOwnerName,
          R.PostAddress,
          R.PostCode,
          R.ReceiverName,
          R.CreateUserSysNo,          
          R.Status ,
          R.Note ,
          R.RefundPayType ,
          R.CompanyCode          
          FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
              INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
             LEFT JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster ref WITH(NOLOCK)
            ON R.RequestSysNo=ref.SysNo
            WHERE R.SysNo=@SysNo AND R.CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_RefundAdjustStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT  TOP 1 [Status]
          FROM    [OverseaCustomerManagement].[dbo].[RO_Adjust] WITH ( NOLOCK )
          WHERE   SysNo=@SysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_EnergySubsidyBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
    SELECT
	     EI.SOSysNo AS SOSysNo
	    ,V.customerid AS CustomerID
      ,V.sysno AS CustomerSysNo
	    ,TotalAmount AS CashAmt
    FROM(
	    SELECT 
	     SE.SoSysNo AS SOSysNo
	    ,SE.CompanyCode 
	    ,SUM(CalculatorAmount.Acount) AS TotalAmount
	    FROM [OverseaOrderManagement].[dbo].[SO_EnergySubsidy] SE WITH(NOLOCK)
	    INNER JOIN
	    (SELECT 
         SIE.SOSysNo
        ,PES.ProductSysNo
        ,SI.Quantity AS ProductCount
        ,(SI.Quantity*PES.Amount) AS Acount
		        FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
		        INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
		        ON SIE.ReferenceSysNo=PES.SysNo 
			        AND SIE.ProductSysNo=PES.ProductSysNo 
			        AND SIE.Type='E'			       
		        INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
		        ON SIE.SOSysNo=SI.SOSysNo AND SIE.ProductSysNo=SI.ProductSysNo
		        GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount,SI.Quantity
		    ) AS CalculatorAmount
	    ON SE.SoSysNo = CalculatorAmount.SOSysNo
	    GROUP BY SE.SoSysNo,SE.CompanyCode
	    ) EI
	    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
	    ON EI.SoSysNo=SM.SysNo
	    INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo V WITH(NOLOCK)
	    ON SM.CustomerSysNo = V.sysno
	    WHERE EI.SoSysNo=@SOSysNo AND EI.CompanyCode=@CompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_InProductEnergySubsidyBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT
	           EI.SOSysNo AS SOSysNo
	          ,V.customerid AS CustomerID
            ,V.sysno AS CustomerSysNo
	          ,TotalAmount AS CashAmt
        FROM(
	        SELECT 
	        CalculatorAmount.SOSysNo
	        ,CalculatorAmount.CompanyCode
	        ,SUM(CalculatorAmount.Acount) AS TotalAmount
	        FROM
	        (SELECT 
             SI.SOSysNo
            ,SI.CompanyCode
            ,PES.ProductSysNo
            ,SI.Quantity AS ProductCount
            ,(SI.Quantity*PES.Amount) AS Acount
		            FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
		            INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
		            ON PES.ProductSysNo=SI.ProductSysNo 
		            GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount,SI.Quantity,SI.CompanyCode
		        ) AS CalculatorAmount
		        GROUP BY CalculatorAmount.SOSysNo,CalculatorAmount.CompanyCode
	        ) EI
	        INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
	        ON EI.SoSysNo=SM.SysNo
	        INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo V WITH(NOLOCK)
	        ON SM.CustomerSysNo = V.sysno
	        WHERE EI.SoSysNo=@SOSysNo AND EI.CompanyCode=@CompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_EffectiveEnergySubsidySO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT TOP 1
	         SOSysNo
	        ,Status
	        FROM OverseaCustomerManagement.dbo.RO_Adjust
	        WHERE SOSysNo=@SOSysNo AND AdjustOrderType=3 AND Status<>-1 AND Status<>2
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetIsShippingOutBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT TOP 1 [Status] FROM OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory WHERE SysNo=@SOSysNo AND CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetHaveAutoRMABySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT TOP 1 [HaveAutoRMA] FROM OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory WHERE SysNo=@SOSysNo AND CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_Get_EnergySubsidyExport" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      ;WITH TempTable AS (
				 SELECT Result.SysNo,
                Row_Number() OVER ( ORDER BY Result.SysNo DESC ) AS RowNumber ,
                Result.ProductID,
                Result.VendorID
                FROM (SELECT  R.[SysNo]						 
						  ,ProductInfo.ProductID
						  ,ProductInfo.VendorID
					FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
             ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				      SELECT 
				       PRI.SOSysNo AS SOSysNo
				      ,P.ProductID AS ProductID
				      ,P.ProductName AS ProductName
				      ,PRI.ProductCount AS ProductCount
				      ,PRI.Acount AS Acount
				      ,V.VendorID AS VendorID
				      ,V.VendorName AS VendorName
			         FROM
			        (SELECT 
	               SIE.SOSysNo
	              ,PES.ProductSysNo
	              ,SI.Quantity AS ProductCount
	              ,(SI.Quantity*PES.Amount) AS Acount
		                  FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
		                  INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
		                  ON SIE.ReferenceSysNo=PES.SysNo 
			                  AND SIE.ProductSysNo=PES.ProductSysNo 
			                  AND SIE.Type='E'
			              INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
			              ON SIE.SOSysNo=SI.SOSysNo AND SIE.ProductSysNo=SI.ProductSysNo
		                  GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount,SI.Quantity
						        ) AS PRI
					        INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					        ON PRI.ProductSysNo = P.SysNo
					        INNER JOIN 
                  (SELECT 
						         SI.ProductSysNo,
						         obt.VendorSysno,
						         SI.SOSysNo AS SOSysNo
					      FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						         LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								      ON  pro.SysNo = si.ProductSysNo
						         LEFT JOIN (
									      SELECT il.ReferenceNumber,
										         ob.VendorSysno,
										         ob.ProductSysno,
										         ob.StockSysNo,
										         SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									      FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										         LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											       ON  il.Inventory_ObtainSysno = ob.Sysno 
											       AND il.Type = 'SO'
									      GROUP BY il.ReferenceNumber, 
									        ob.VendorSysno,
										      ob.ProductSysno,
										      ob.StockSysNo
								      ) AS obt
								      ON  si.ProductSysNo = obt.ProductSysno
								      AND si.WarehouseNumber = obt.StockSysNo
								      AND si.SOSysNo = obt.ReferenceNumber   
					      WHERE  SI.IsShippedOut = 1
					      ) VI
					      ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					      LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					      ON VI.VendorSysno=V.SysNo 
            ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
            ON SM.SysNo = R.SOSysNo
             LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo FSB WITH(NOLOCK)
            ON FSB.OrderType=6 AND FSB.OrderSysNo=R.SysNo AND FSB.CompanyCode='8601'
			 LEFT JOIN OverseaControlPanel.dbo.V_Sys_User au WITH(NOLOCK)
			ON FSB.AuditUserSysno=au.SysNo
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
			#StrWhere#	
      UNION ALL
			
			SELECT  R.[SysNo]						  
						  ,ProductInfo.ProductID
						  ,ProductInfo.VendorID
					FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
             ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				      SELECT 
				       PRI.SOSysNo AS SOSysNo
				      ,P.ProductID AS ProductID
				      ,P.ProductName AS ProductName
				      ,PRI.ProductCount AS ProductCount
				      ,PRI.Acount AS Acount
				      ,V.VendorID AS VendorID
				      ,V.VendorName AS VendorName
			         FROM
			        (SELECT 
	               SI.SOSysNo
	              ,PES.ProductSysNo
	              ,SI.Quantity AS ProductCount
	              ,(SI.Quantity*PES.Amount) AS Acount
		                  FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						      INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
							  ON PES.ProductSysNo=SI.ProductSysNo
							  GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount,SI.Quantity
						        ) AS PRI
					        INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					        ON PRI.ProductSysNo = P.SysNo
					        INNER JOIN 
                  (SELECT 
						         SI.ProductSysNo,
						         obt.VendorSysno,
						         SI.SOSysNo AS SOSysNo
					      FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						         LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								      ON  pro.SysNo = si.ProductSysNo
						         LEFT JOIN (
									      SELECT il.ReferenceNumber,
										         ob.VendorSysno,
										         ob.ProductSysno,
										         ob.StockSysNo,
										         SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									      FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										         LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											       ON  il.Inventory_ObtainSysno = ob.Sysno 
											       AND il.Type = 'SO'
									      GROUP BY il.ReferenceNumber, 
									        ob.VendorSysno,
										      ob.ProductSysno,
										      ob.StockSysNo
								      ) AS obt
								      ON  si.ProductSysNo = obt.ProductSysno
								      AND si.WarehouseNumber = obt.StockSysNo
								      AND si.SOSysNo = obt.ReferenceNumber   
					      WHERE  SI.IsShippedOut = 1
					      ) VI
					      ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					      LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					      ON VI.VendorSysno=V.SysNo 
            ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
            ON SM.SysNo = R.SOSysNo
             LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo FSB WITH(NOLOCK)
            ON FSB.OrderType=6 AND FSB.OrderSysNo=R.SysNo AND FSB.CompanyCode='8601'
			 LEFT JOIN OverseaControlPanel.dbo.V_Sys_User au WITH(NOLOCK)
			ON FSB.AuditUserSysno=au.SysNo
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
            #StrWhere#) Result
      GROUP BY Result.SysNo,Result.ProductID,Result.VendorID
      )

       SELECT 
		      ProductInfo.VendorID AS VendorID, --供应商ID
          ProductInfo.VendorName AS VendorName, -- 供应商名称
          ProductInfo.ProductID AS ProductID, -- 商品编号
          ProductInfo.ProductName AS ProductName,--商品名称
          ProductInfo.ProductCount AS ProductCount, -- 购买数量
          ProductInfo.Acount AS Acount, --节能补贴金额
          R.BankName AS Bank,--银行名称
          R.BranchBankName AS BranchBank,--分行名称
          R.CardNumber AS CardNumber, --银行卡号
          SM.ReceivePhone as Phone,--联系电话
          SM.ReceiveAddress as Address,--地址
          R.SysNo as SysNo,        
          R.AdjustOrderType ,
          R.SOSysNo AS SOSysNo,
          R.CustomerSysNo ,
          c.customerid AS CustomerID,--客户ID  
          R.CreateTime as CreateTime,
          R.CreateUserSysNo ,
          R.RefundTime as RefundTime,
          R.RefundUserSysNo ,
          R.CashAmt ,
          R.Status as Status,
          R.Note ,
          R.RefundPayType as PayTypeName,
          R.CompanyCode ,
          u.UserName as CreateUserName ,
          us.UserName AS  RefundUserName,
          FSB.AuditTime AS AuditTime, --审核时间
          au.UserName AS AuditUserName--审核人
          FROM TempTable
              INNER JOIN [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
            ON TempTable.SysNo = R.SysNo
            INNER JOIN 
            (
				SELECT 
				 PRI.SOSysNo AS SOSysNo
				,P.ProductID AS ProductID
				,P.ProductName AS ProductName
				,PRI.ProductCount AS ProductCount
				,PRI.Acount AS Acount
				,V.VendorID AS VendorID
				,V.VendorName AS VendorName
			   FROM
			(SELECT    SI.SOSysNo ,
                                                PES.ProductSysNo ,
                                                SI.Quantity AS ProductCount ,
                                                ( SI.Quantity * PES.Amount ) AS Acount
                                      FROM   [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES
                                                WITH ( NOLOCK )                                                           
                                                INNER JOIN IPP3.dbo.SO_Item SI
                                                WITH ( NOLOCK ) ON 
                                                               PES.ProductSysNo = SI.ProductSysNo
                                      GROUP BY  PES.ProductSysNo ,                                               
                                                PES.Amount ,
                                                SI.Quantity,
                                                SI.SOSysNo
						) AS PRI
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					ON PRI.ProductSysNo = P.SysNo
					INNER JOIN (SELECT 
						   SI.ProductSysNo,
						   obt.VendorSysno,
						   SI.SOSysNo AS SOSysNo

					FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						   LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								ON  pro.SysNo = si.ProductSysNo
						   LEFT JOIN (
									SELECT il.ReferenceNumber,
										   ob.VendorSysno,
										   ob.ProductSysno,
										   ob.StockSysNo,
										   SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										   LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											 ON  il.Inventory_ObtainSysno = ob.Sysno 
											 AND il.Type = 'SO'
									GROUP BY il.ReferenceNumber, 
									  ob.VendorSysno,
										ob.ProductSysno,
										ob.StockSysNo
								) AS obt
								ON  si.ProductSysNo = obt.ProductSysno
								AND si.WarehouseNumber = obt.StockSysNo
								AND si.SOSysNo = obt.ReferenceNumber   
					WHERE  SI.IsShippedOut = 1 
					) VI
					ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					ON VI.VendorSysno=V.SysNo
            ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo AND ProductInfo.ProductID = TempTable.ProductID
            AND (ProductInfo.VendorID = TempTable.VendorID OR ProductInfo.VendorID IS NULL)
            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
            ON SM.SysNo = R.SOSysNo
             LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeBankInfo FSB WITH(NOLOCK)
            ON FSB.OrderType=6 AND FSB.OrderSysNo=R.SysNo AND FSB.CompanyCode='8601'
			 LEFT JOIN OverseaControlPanel.dbo.V_Sys_User au WITH(NOLOCK)
			ON FSB.AuditUserSysno=au.SysNo
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
          WHERE RowNumber > @StartNumber AND RowNumber <= @EndNumber  
          ORDER BY RowNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand  name="Customer_Get_EnergySubsidySimple" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
            SELECT @TotalCount = COUNT(TableResult.SysNo)  FROM
          (SELECT TotalInfo.SysNo FROM(SELECT R.SysNo
            FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				SELECT 
				 PRI.SOSysNo AS SOSysNo
				,P.ProductID AS ProductID
				,P.ProductName AS ProductName
				,PRI.ProductCount AS ProductCount
				,PRI.Acount AS Acount
				,V.VendorID AS VendorID
				,V.VendorName AS VendorName
			   FROM
			(SELECT 
				 SIE.SOSysNo
				,PES.ProductSysNo
				,COUNT(*) AS ProductCount
				,(COUNT(*)*PES.Amount) AS Acount
						FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
						INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						ON SIE.ReferenceSysNo=PES.SysNo 
							AND SIE.ProductSysNo=PES.ProductSysNo 
							AND SIE.Type='E'
						GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount
						) AS PRI
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					ON PRI.ProductSysNo = P.SysNo
					INNER JOIN (SELECT 
						   SI.ProductSysNo,
						   obt.VendorSysno,
						   SI.SOSysNo AS SOSysNo

					FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						   LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								ON  pro.SysNo = si.ProductSysNo
						   LEFT JOIN (
									SELECT il.ReferenceNumber,
										   ob.VendorSysno,
										   ob.ProductSysno,
										   ob.StockSysNo,
										   SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										   LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											 ON  il.Inventory_ObtainSysno = ob.Sysno 
											 AND il.Type = 'SO'
									GROUP BY il.ReferenceNumber, 
									  ob.VendorSysno,
										ob.ProductSysno,
										ob.StockSysNo
								) AS obt
								ON  si.ProductSysNo = obt.ProductSysno
								AND si.WarehouseNumber = obt.StockSysNo
								AND si.SOSysNo = obt.ReferenceNumber   
					WHERE  SI.IsShippedOut = 1
					) VI
					ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					ON VI.VendorSysno=V.SysNo 
            ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
             #StrWhere#
             GROUP BY R.SysNo
             UNION ALL
             
             SELECT R.SysNo
            FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				SELECT 
				 PRI.SOSysNo AS SOSysNo
				,P.ProductID AS ProductID
				,P.ProductName AS ProductName
				,PRI.ProductCount AS ProductCount
				,PRI.Acount AS Acount
				,V.VendorID AS VendorID
				,V.VendorName AS VendorName
			   FROM
			(SELECT 
				 SI.SOSysNo
				,PES.ProductSysNo
				,COUNT(*) AS ProductCount
				,(COUNT(*)*PES.Amount) AS Acount
						FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						      INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
							  ON PES.ProductSysNo=SI.ProductSysNo
							  GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount
						) AS PRI
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					ON PRI.ProductSysNo = P.SysNo
					INNER JOIN (SELECT 
						   SI.ProductSysNo,
						   obt.VendorSysno,
						   SI.SOSysNo AS SOSysNo

					FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						   LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								ON  pro.SysNo = si.ProductSysNo
						   LEFT JOIN (
									SELECT il.ReferenceNumber,
										   ob.VendorSysno,
										   ob.ProductSysno,
										   ob.StockSysNo,
										   SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										   LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											 ON  il.Inventory_ObtainSysno = ob.Sysno 
											 AND il.Type = 'SO'
									GROUP BY il.ReferenceNumber, 
									  ob.VendorSysno,
										ob.ProductSysno,
										ob.StockSysNo
								) AS obt
								ON  si.ProductSysNo = obt.ProductSysno
								AND si.WarehouseNumber = obt.StockSysNo
								AND si.SOSysNo = obt.ReferenceNumber   
					WHERE  SI.IsShippedOut = 1
					) VI
					ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					ON VI.VendorSysno=V.SysNo 
            ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
             #StrWhere#
             GROUP BY R.SysNo
             ) AS TotalInfo 
             GROUP BY TotalInfo.SysNo) TableResult
             
				 ;WITH TempTable AS (
				 SELECT Result.SysNo,Row_Number() OVER (Order BY  #SortColumnName#) AS RowNumber FROM (SELECT  R.[SysNo],
                                    R.SOSysNo,
                                    C.customerid,
                                    r.CreateTime,
                                    R.RefundTime,
                                    R.CashAmt,
                                    R.RefundPayType,
                                    R.AdjustOrderType,
                                    R.Status,
                                    R.Note,
                                    u.UserName as CreateUserName ,
                                    us.UserName AS  RefundUserName  
					FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				      SELECT 
				       PRI.SOSysNo AS SOSysNo
				      ,P.ProductID AS ProductID
				      ,P.ProductName AS ProductName
				      ,PRI.ProductCount AS ProductCount
				      ,PRI.Acount AS Acount
				      ,V.VendorID AS VendorID
				      ,V.VendorName AS VendorName
			         FROM
			      (SELECT 
				       SIE.SOSysNo
				      ,PES.ProductSysNo
				      ,COUNT(*) AS ProductCount
				      ,(COUNT(*)*PES.Amount) AS Acount
						      FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
						      INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						      ON SIE.ReferenceSysNo=PES.SysNo 
							      AND SIE.ProductSysNo=PES.ProductSysNo 
							      AND SIE.Type='E'
						      GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount
						      ) AS PRI
					      INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					      ON PRI.ProductSysNo = P.SysNo
					      INNER JOIN (SELECT 
						         SI.ProductSysNo,
						         obt.VendorSysno,
						         SI.SOSysNo AS SOSysNo

					      FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						         LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								      ON  pro.SysNo = si.ProductSysNo
						         LEFT JOIN (
									      SELECT il.ReferenceNumber,
										         ob.VendorSysno,
										         ob.ProductSysno,
										         ob.StockSysNo,
										         SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									      FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										         LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											       ON  il.Inventory_ObtainSysno = ob.Sysno 
											       AND il.Type = 'SO'
									      GROUP BY il.ReferenceNumber, 
									        ob.VendorSysno,
										      ob.ProductSysno,
										      ob.StockSysNo
								      ) AS obt
								      ON  si.ProductSysNo = obt.ProductSysno
								      AND si.WarehouseNumber = obt.StockSysNo
								      AND si.SOSysNo = obt.ReferenceNumber   
					      WHERE  SI.IsShippedOut = 1
					      ) VI
					      ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					      LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					      ON VI.VendorSysno=V.SysNo 
                  ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
	
			#StrWhere#
      GROUP BY R.[SysNo],
                                    R.SOSysNo,
                                    C.customerid,
                                    r.CreateTime,
                                    R.RefundTime,
                                    R.CashAmt,
                                    R.RefundPayType,
                                    R.AdjustOrderType,
                                    R.Status,
                                    R.Note,
                                    u.UserName,
                                    us.UserName       
      UNION ALL
				 SELECT  R.[SysNo],
                                    R.SOSysNo,
                                    C.customerid,
                                    r.CreateTime,
                                    R.RefundTime,
                                    R.CashAmt,
                                    R.RefundPayType,
                                    R.AdjustOrderType,
                                    R.Status,
                                    R.Note,
                                    u.UserName as CreateUserName ,
                                    us.UserName AS  RefundUserName 
					FROM [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
            INNER JOIN 
            (
				      SELECT 
				       PRI.SOSysNo AS SOSysNo
				      ,P.ProductID AS ProductID
				      ,P.ProductName AS ProductName
				      ,PRI.ProductCount AS ProductCount
				      ,PRI.Acount AS Acount
				      ,V.VendorID AS VendorID
				      ,V.VendorName AS VendorName
			         FROM
			      (SELECT 
				       SI.SOSysNo
				      ,PES.ProductSysNo
				      ,COUNT(*) AS ProductCount
				      ,(COUNT(*)*PES.Amount) AS Acount
						      FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						      INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
							  ON PES.ProductSysNo=SI.ProductSysNo
							  GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount
						      ) AS PRI
					      INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
					      ON PRI.ProductSysNo = P.SysNo
					      INNER JOIN (SELECT 
						         SI.ProductSysNo,
						         obt.VendorSysno,
						         SI.SOSysNo AS SOSysNo

					      FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
						         LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
								      ON  pro.SysNo = si.ProductSysNo
						         LEFT JOIN (
									      SELECT il.ReferenceNumber,
										         ob.VendorSysno,
										         ob.ProductSysno,
										         ob.StockSysNo,
										         SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
									      FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
										         LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
											       ON  il.Inventory_ObtainSysno = ob.Sysno 
											       AND il.Type = 'SO'
									      GROUP BY il.ReferenceNumber, 
									        ob.VendorSysno,
										      ob.ProductSysno,
										      ob.StockSysNo
								      ) AS obt
								      ON  si.ProductSysNo = obt.ProductSysno
								      AND si.WarehouseNumber = obt.StockSysNo
								      AND si.SOSysNo = obt.ReferenceNumber   
					      WHERE  SI.IsShippedOut = 1
					      ) VI
					      ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
					      LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
					      ON VI.VendorSysno=V.SysNo 
                  ) ProductInfo
            ON ProductInfo.SOSysNo = R.SOSysNo 
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
	
			#StrWhere#
      GROUP BY R.[SysNo],
                                    R.SOSysNo,
                                    C.customerid,
                                    r.CreateTime,
                                    R.RefundTime,
                                    R.CashAmt,
                                    R.RefundPayType,
                                    R.AdjustOrderType,
                                    R.Status,
                                    R.Note,
                                    u.UserName,
                                    us.UserName ) Result 
      GROUP BY Result.SysNo,
       Result.SOSysNo,
                                    Result.customerid,
                                    Result.CreateTime,
                                    Result.RefundTime,
                                    Result.CashAmt,
                                    Result.RefundPayType,
                                    Result.AdjustOrderType,
                                    Result.Status,
                                    Result.Note,
                                    Result.CreateUserName,
                                    Result.RefundUserName)

       SELECT 
          R.SysNo AS AdjustSysNo,        
          R.AdjustOrderType ,
          R.RequestSysNo AS RequestSysNo,
          ref.RequestID AS RequestID,
          R.SOSysNo AS SOSysNo,
          R.CustomerSysNo ,
          c.customerid AS CustomerID,      
          R.CreateTime ,
          R.CreateUserSysNo ,
          R.RefundTime ,
          R.RefundUserSysNo ,
          R.CashAmt ,
          R.Status ,
          R.Note ,
          R.RefundPayType ,
          R.CompanyCode ,
          R.BankName,
          R.BranchBankName,
          R.CardNumber,
          R.CardOwnerName,
          u.UserName as CreateUserName ,
          us.UserName AS  RefundUserName         
          FROM TempTable
            INNER JOIN [OverseaCustomerManagement].[dbo].[RO_Adjust] AS R WITH(NOLOCK)
                ON TempTable.SysNo = R.SysNo
             INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c WITH(NOLOCK)
            ON R.CustomerSysNo=c.sysno
              INNER JOIN OverseaControlPanel.dbo.V_Sys_User u WITH(NOLOCK)
            ON R.CreateUserSysNo=u.SysNo
             LEFT JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster ref WITH(NOLOCK)
            ON R.RequestSysNo=ref.SysNo
             LEFT OUTER JOIN OverseaControlPanel.dbo.V_Sys_User us WITH(NOLOCK)
            ON R.RefundUserSysNo =us.SysNo
          WHERE RowNumber > @StartNumber AND RowNumber <= @EndNumber 
          ORDER BY RowNumber 
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_Get_EnergySubsidyDetials" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
            SELECT
	            EI.SOSysNo AS SOSysNo	--订单号
	            ,V.customerid AS CustomerID --顾客登陆ID
              ,V.sysno AS CustomerSysNo	--顾客系统编号
	            ,TotalAmount AS Amount --节能补贴金额
	            ,SES.CertificateNo AS CardID --身份证号
              ,SES.CertificateType AS CertificateType--类型 0:个人;1:公司
              ,SES.CertificaterName AS ReceiveName-- 公司名称/证件类型
	            ,V.cellphone AS CellPhone --电话号码
	            ,SM.ReceivePhone AS Phone --电话
	            ,SM.ReceiveAddress AS Address -- 顾客地址
	            ,PT.PayTypeName AS PayType -- 支付方式
	            ,(SM.SOAmt-SM.PointPay/10.0-PromotionInfo.PromotionCount+SM.PayPrice+SM.ShipPrice+SM.PremiumAmt-SM.DiscountAmt)AS OrderAmt --订单金额
	            ,SM.PointPay AS PointUsed --使用积分数
              ,PromotionInfo.PromotionCount Promotion--优惠券
            FROM(
	            SELECT 
	             SE.SoSysNo AS SOSysNo
	            ,SE.CompanyCode 
	            ,SUM(CalculatorAmount.Acount) AS TotalAmount
	            FROM [OverseaOrderManagement].[dbo].[SO_EnergySubsidy] SE WITH(NOLOCK)
	            INNER JOIN
	            (SELECT 
				         SIE.SOSysNo
				        ,PES.ProductSysNo
				        ,SI.Quantity AS ProductCount
				        ,(SI.Quantity*PES.Amount) AS Acount
						        FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
						        INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
						        ON SIE.ReferenceSysNo=PES.SysNo 
							        AND SIE.ProductSysNo=PES.ProductSysNo 
							        AND SIE.Type='E'							        
						        INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
						        ON SIE.SOSysNo=SI.SOSysNo AND SIE.ProductSysNo=SI.ProductSysNo
						        GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount,SI.Quantity
		            ) AS CalculatorAmount
	            ON SE.SoSysNo = CalculatorAmount.SOSysNo
	            GROUP BY SE.SoSysNo,SE.CompanyCode
	            ) EI
	            INNER JOIN [OverseaOrderManagement].[dbo].[SO_EnergySubsidy] SES WITH(NOLOCK)
	            ON EI.SOSysNo = SES.SoSysNo
	            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
	            ON EI.SoSysNo=SM.SysNo
		        INNER JOIN 
		        (SELECT 
	                 promotionSM.SysNo AS SOSysNo
	                ,SUM(promotionSI.PromotionDiscount*promotionSI.Quantity) AS PromotionCount
                FROM OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory promotionSM WITH(NOLOCK)
                INNER JOIN IPP3.dbo.SO_Item promotionSI WITH(NOLOCK)
                ON promotionSM.SysNo = promotionSI.SOSysNo   
                GROUP BY promotionSM.SysNo) AS PromotionInfo
                ON SM.SysNo = PromotionInfo.SOSysNo
	            INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo V WITH(NOLOCK)
	            ON SM.CustomerSysNo = V.sysno
	            INNER JOIN OverseaControlPanel.dbo.V_CP_PayType PT WITH(NOLOCK)
	            ON SM.PayTypeSysNo = PT.SysNo
	            WHERE EI.SoSysNo=@SOSysNo AND EI.CompanyCode=@CompanyCode
        ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_Get_InProductEnergySubsidyDetials" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT
	            EI.SOSysNo AS SOSysNo	--订单号
	            ,V.customerid AS CustomerID --顾客登陆ID
              ,V.sysno AS CustomerSysNo	--顾客系统编号
	            ,TotalAmount AS Amount --节能补贴金额
	            ,V.cellphone AS CellPhone --电话号码
	            ,SM.ReceivePhone AS Phone --电话
	            ,SM.ReceiveAddress AS Address -- 顾客地址
	            ,PT.PayTypeName AS PayType -- 支付方式
	            ,(SM.SOAmt-SM.PointPay/10.0-PromotionInfo.PromotionCount+SM.PayPrice+SM.ShipPrice+SM.PremiumAmt-SM.DiscountAmt)AS OrderAmt --订单金额
	            ,SM.PointPay AS PointUsed --使用积分数
              ,PromotionInfo.PromotionCount Promotion--优惠券
            FROM(
	            SELECT 
	             CalculatorAmount.SOSysNo AS SOSysNo
	            ,CalculatorAmount.CompanyCode 
	            ,SUM(CalculatorAmount.Acount) AS TotalAmount
				FROM
	            (SELECT 
			         SI.SOSysNo
			        ,PES.ProductSysNo
			        ,SI.Quantity AS ProductCount
			        ,SI.CompanyCode AS CompanyCode
			        ,(SI.Quantity*PES.Amount) AS Acount
					  FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)	       
						INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
						ON PES.ProductSysNo=SI.ProductSysNo           
						GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount,SI.Quantity,SI.CompanyCode
		            ) AS CalculatorAmount
	            GROUP BY CalculatorAmount.SOSysNo,CalculatorAmount.CompanyCode
	            ) EI
	            INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory SM WITH(NOLOCK)
	            ON EI.SoSysNo=SM.SysNo
		        INNER JOIN 
		        (SELECT 
	                 promotionSM.SysNo AS SOSysNo
	                ,SUM(promotionSI.PromotionDiscount*promotionSI.Quantity) AS PromotionCount
                FROM OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory promotionSM WITH(NOLOCK)
                INNER JOIN IPP3.dbo.SO_Item promotionSI WITH(NOLOCK)
                ON promotionSM.SysNo = promotionSI.SOSysNo   
                GROUP BY promotionSM.SysNo) AS PromotionInfo
                ON SM.SysNo = PromotionInfo.SOSysNo
	            INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo V WITH(NOLOCK)
	            ON SM.CustomerSysNo = V.sysno
	            INNER JOIN OverseaControlPanel.dbo.V_CP_PayType PT WITH(NOLOCK)
	            ON SM.PayTypeSysNo = PT.SysNo
	            WHERE EI.SoSysNo=@SOSysNo AND EI.CompanyCode=@CompanyCode
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_Get_EnergySubsidyProductInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
	         PRI.SOSysNo AS SOSysNo
	        ,P.ProductID AS ProductID
	        ,P.ProductName AS ProductName
	        ,PRI.ProductCount AS ProductCount
	        ,PRI.Acount AS Acount
          ,V.VendorID AS VendorID
	        ,V.VendorName AS VendorName
        FROM
        (SELECT 
	         SIE.SOSysNo
	        ,PES.ProductSysNo
	        ,SI.Quantity AS ProductCount
	        ,(SI.Quantity*PES.Amount) AS Acount
		            FROM OverseaOrderManagement.dbo.SO_Item_Extension SIE WITH(NOLOCK)
		            INNER JOIN [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
		            ON SIE.ReferenceSysNo=PES.SysNo 
			            AND SIE.ProductSysNo=PES.ProductSysNo 
			            AND SIE.Type='E'			            
			        INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
			        ON SIE.SOSysNo=SI.SOSysNo AND SIE.ProductSysNo=SI.ProductSysNo
			        WHERE SIE.SOSysNo=@SOSysNo AND PES.CompanyCode=@CompanyCode
		            GROUP BY PES.ProductSysNo,SIE.SOSysNo,PES.Amount,SI.Quantity
		            ) AS PRI
        INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
        ON PRI.ProductSysNo = P.SysNo
        LEFT JOIN (SELECT 
				   SI.ProductSysNo,
				   obt.VendorSysno,
				   SI.SOSysNo AS SOSysNo

			    FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
				       LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
						    ON  pro.SysNo = si.ProductSysNo
				       LEFT JOIN (
							    SELECT il.ReferenceNumber,
								       ob.VendorSysno,
								       ob.ProductSysno,
								       ob.StockSysNo,
								       SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
							    FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
								       LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
									     ON  il.Inventory_ObtainSysno = ob.Sysno 
									     AND il.Type = 'SO'
							    GROUP BY il.ReferenceNumber, 
							      ob.VendorSysno,
								    ob.ProductSysno,
								    ob.StockSysNo
						    ) AS obt
						    ON  si.ProductSysNo = obt.ProductSysno
						    AND si.WarehouseNumber = obt.StockSysNo
						    AND si.SOSysNo = obt.ReferenceNumber   
			    WHERE  SI.IsShippedOut = 1
			    ) VI
    ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
    LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
    ON VI.VendorSysno=V.SysNo
    WHERE PRI.SOSysNo=@SOSysNo
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_Get_InProductEnergySubsidyProductInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
	         PRI.SOSysNo AS SOSysNo
	        ,P.ProductID AS ProductID
	        ,P.ProductName AS ProductName
	        ,PRI.ProductCount AS ProductCount
	        ,PRI.Acount AS Acount
          ,V.VendorID AS VendorID
	        ,V.VendorName AS VendorName
        FROM
        (SELECT 
	         SI.SOSysNo
	        ,PES.ProductSysNo
	        ,SI.Quantity AS ProductCount
	        ,(SI.Quantity*PES.Amount) AS Acount
		            FROM [OverseaContentManagement].[dbo].[ProductEnergySubsidy] PES WITH(NOLOCK)
			        INNER JOIN IPP3.dbo.SO_Item SI WITH(NOLOCK)
			        ON PES.ProductSysNo=SI.ProductSysNo			       
			        WHERE SI.SOSysNo=@SOSysNo AND PES.CompanyCode=@CompanyCode
		            GROUP BY PES.ProductSysNo,SI.SOSysNo,PES.Amount,SI.Quantity
		            ) AS PRI
        INNER JOIN OverseaContentManagement.dbo.V_IM_Product P
        ON PRI.ProductSysNo = P.SysNo
        LEFT JOIN (SELECT 
				   SI.ProductSysNo,
				   obt.VendorSysno,
				   SI.SOSysNo AS SOSysNo

			    FROM   IPP3.dbo.SO_Item SI WITH(NOLOCK)
				       LEFT JOIN OverseaContentManagement.dbo.V_IM_Product pro WITH(NOLOCK)
						    ON  pro.SysNo = si.ProductSysNo
				       LEFT JOIN (
							    SELECT il.ReferenceNumber,
								       ob.VendorSysno,
								       ob.ProductSysno,
								       ob.StockSysNo,
								       SUM(il.AvailableQtyFrom - il.AvailableQtyTo) AS Quantity
							    FROM   OverseaInventoryManagement.dbo.V_Inventory_Obtain_Log il WITH(NOLOCK)
								       LEFT JOIN OverseaInventoryManagement.dbo.V_Inventory_Obtain ob WITH(NOLOCK)
									     ON  il.Inventory_ObtainSysno = ob.Sysno 
									     AND il.Type = 'SO'
							    GROUP BY il.ReferenceNumber, 
							      ob.VendorSysno,
								    ob.ProductSysno,
								    ob.StockSysNo
						    ) AS obt
						    ON  si.ProductSysNo = obt.ProductSysno
						    AND si.WarehouseNumber = obt.StockSysNo
						    AND si.SOSysNo = obt.ReferenceNumber   
			    WHERE  SI.IsShippedOut = 1
			    ) VI
    ON VI.ProductSysNo = PRI.ProductSysNo AND VI.SOSysNo=PRI.SOSysNo
    LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V WITH(NOLOCK)
    ON VI.VendorSysno=V.SysNo
    WHERE PRI.SOSysNo=@SOSysNo
      ]]>
    </commandText>
  </dataCommand>
</dataOperations>
