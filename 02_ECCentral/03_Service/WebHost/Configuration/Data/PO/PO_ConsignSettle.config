<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <dataCommand name="QueryVendorSettle" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
          @TotalCount = COUNT(a.SysNo) 
        FROM
           (SELECT 
	           Settle.[SysNo]
	          ,Settle.[SettleID]
	          ,Settle.[VendorSysNo]
			      ,Settle.UsingReturnPoint
			      ,IPP3.dbo.FN_GetExpectReturnPoint_fromPOAndPOConsign ('PC',Settle.[SysNo],0)   ExpectGetPointAmt	
            ,Vendor.[VendorName]
            ,Settle.[StockSysNo]
	          ,Stock.[StockName]
	          ,Settle.[TotalAmt]
            ,Settle.[CurrencySysNo]
	          ,Settle.[CreateTime]
	          ,Settle.[CreateUserSysNo]
	          ,UserInfo.[DisPlayName] AS CreateUser
	          ,Settle.[AuditTime]
	          ,Settle.[AuditUserSysNo]	        
	          ,Settle.[SettleTime]
	          ,Settle.[SettleUserSysNo]	        
	          ,Settle.[Memo]
	          ,Settle.[Note]
	          ,Settle.[Status]
	          ,Settle.[SettleBalanceSysNo]
	          ,Settle.[TaxRate] 
            ,Vendor.[IsConsign]
            ,Vendor.[PayPeriodType]
            ,Vendor.[PaySettleCompany]
          FROM IPP3.[dbo].[POConsign_Settle] AS Settle WITH(NOLOCK) 
          LEFT OUTER JOIN [IPP3].[dbo].[Vendor] AS Vendor WITH(NOLOCK) 
          ON   Vendor.SysNo = Settle.VendorSysNo 
          LEFT OUTER JOIN OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK) 
          ON  Stock.SysNo = Settle.StockSysNo 
          LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) 
          ON  UserInfo.UserSysNo = Settle.[CreateUserSysNo]
          #StrWhere#
          AND Settle.SysNo IN (SELECT SettleSysNo FROM [IPP3].[dbo].[POConsign_Settle_Item] item WITH(NOLOCK) WHERE item.SettleSysNo = Settle.SysNo AND item.POConsignToAccLogSysNo IS NOT NULL)
          ) AS a 
          
        SELECT 
           [SysNo]
	        ,[SettleID]
	        ,[VendorSysNo]
			    ,UsingReturnPoint
			    ,ExpectGetPointAmt
          ,[VendorName]
          ,[StockSysNo]
	        ,[StockName]
	        ,[TotalAmt]
          ,[CurrencySysNo]
	        ,[CreateTime]
	        ,[CreateUserSysNo]
	        ,[CreateUser]
	        ,[AuditTime]
	        ,[AuditUserSysNo]	
          ,[AuditUser]
	        ,[SettleTime]
	        ,[SettleUserSysNo]	        
	        ,[SettleUser]
          ,[Memo]
	        ,[Note]
	        ,[Status]
	        ,[SettleBalanceSysNo]
	        ,[TaxRate] 
          ,[Balance]
          ,[IsConsign]
          ,[PayPeriodType]
			    ,EIMSNo
          ,[PaySettleCompany]
         FROM 
          (SELECT 
	           TOP (@EndNumber)
               Settle.[SysNo]
	            ,Settle.[SettleID]
	            ,Settle.[VendorSysNo]
		          ,Settle.UsingReturnPoint
		          ,IPP3.dbo.FN_GetExpectReturnPoint_fromPOAndPOConsign ('PC',Settle.[SysNo],0)   ExpectGetPointAmt	
              ,Vendor.[VendorName]
              ,Settle.[StockSysNo]
	            ,Stock.[StockName]
	            ,Settle.[TotalAmt]
              ,Settle.[CurrencySysNo]
	            ,Settle.[CreateTime]
	            ,Settle.[CreateUserSysNo]
	            ,UserInfo.[DisPlayName] AS CreateUser
	            ,Settle.[AuditTime]
	            ,Settle.[AuditUserSysNo]	   
              ,(SELECT 
                  UserInfo.[DisPlayName]
                  FROM 
                  OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) 
                  WHERE 
                  UserInfo.UserSysNo = Settle.[AuditUserSysNo]) AS AuditUser
	            ,Settle.[SettleTime]
	            ,Settle.[SettleUserSysNo]
			        ,(SELECT 
				          UserInfo.[DisPlayName]
			              FROM 
				          OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) 
			              WHERE 
				          UserInfo.UserSysNo = Settle.[SettleUserSysNo]) AS SettleUser
	            ,Settle.[Memo]
	            ,Settle.[Note]
	            ,Settle.[Status]
	            ,Settle.[SettleBalanceSysNo]
	            ,Settle.[TaxRate] 
              ,(SELECT 	CONVERT(NUMERIC(15,2),ISNULL(Settle.[TotalAmt],0) - ISNULL(SUM(AccLog.CreateCost*AccLog.Quantity),0))
			          FROM [IPP3].[dbo].POConsign_Settle_Item AS Item WITH(NOLOCK)
				        INNER JOIN [IPP3].[dbo].POConsign_ToAccLog AS AccLog WITH(NOLOCK) 
					        ON AccLog.[SysNo] = Item.POConsignToAccLogSysNo				
				        WHERE Item.SettleSysNo = Settle.[SysNo]
			              ) AS Balance
			        ,Settle.PM_ReturnPointSysNo AS EIMSNo
              ,Vendor.[IsConsign]
              ,Vendor.[PayPeriodType]
              ,Vendor.[PaySettleCompany]
              ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
          FROM [IPP3].[dbo].[POConsign_Settle] AS Settle WITH(NOLOCK) 
          LEFT OUTER JOIN  [IPP3].[dbo].[Vendor] AS Vendor WITH(NOLOCK) 
          ON  Vendor.SysNo = Settle.VendorSysNo 
          LEFT OUTER JOIN OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK) 
          ON   Stock.SysNo = Settle.StockSysNo 
          LEFT OUTER JOIN OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) 
          ON   UserInfo.UserSysNo = Settle.[CreateUserSysNo]
          #StrWhere# 
          AND Settle.SysNo IN (SELECT SettleSysNo FROM [IPP3].[dbo].[POConsign_Settle_Item] item WITH(NOLOCK) WHERE item.SettleSysNo = Settle.SysNo AND item.POConsignToAccLogSysNo IS NOT NULL)
          ORDER BY RowNumber
          ) AS a 
          WHERE  RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetVendorSettleBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
	         Settle.[SysNo]
	        ,Settle.[SettleID] as [ReferenceSysNo]
	        ,Settle.[VendorSysNo] as [VendorInfo.SysNo]
          ,Vendor.[VendorName] as [VendorInfo.VendorBasicInfo.VendorNameLocal]
          ,Vendor.[PaySettleCompany] as [VendorInfo.VendorBasicInfo.PaySettleCompany]
          ,Settle.[StockSysNo] as [SourceStockInfo.SysNo]
	        ,Stock.[StockName] as [SourceStockInfo.StockName]
	        ,Settle.[TotalAmt]
          ,Settle.[CurrencySysNo] as [CurrencyCode]
	        ,Settle.[CreateTime] as [CreateDate]
	        ,Settle.[CreateUserSysNo]
	        ,(SELECT DisPlayName FROM OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) WHERE UserInfo.UserSysNo = [CreateUserSysNo]) AS CreateUser
	        ,Settle.[AuditTime] as [AuditDate]
	        ,Settle.[AuditUserSysNo] as [AuditUser.UserID]
	        ,(SELECT DisPlayName FROM OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) WHERE UserInfo.UserSysNo = [AuditUserSysNo]) as [AuditUser.UserName]
	        ,Settle.[SettleTime] as [SettleDate]
	        ,Settle.[SettleUserSysNo] as [SettleUser.UserID]
	        ,(SELECT DisPlayName FROM OverseaArchitecture.[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK) WHERE UserInfo.UserSysNo = [SettleUserSysNo]) as [SettleUser.UserName]
	        ,Settle.[Memo]
	        ,Settle.[Note]
	        ,Settle.[Status]
	        ,Settle.[SettleBalanceSysNo]
	        ,Settle.[CompanyCode]
          ,Settle.IsToLease as LeaseType
	        ,(CONVERT(INT,Settle.[TaxRate] * 100) ) as [TaxRateData]
            ,Settle.[UsingReturnPoint] as [EIMSInfo.UsingReturnPoint]
		    ,ipp3.dbo.FN_GetExpectReturnPoint_fromPOAndPOConsign ('PC',Settle.[SysNo],0)   ExpectGetPointAmt
            ,Settle.[PM_ReturnPointSysNo] as [EIMSInfo.ReturnPointSysNo]
            ,Settle.[PM_ReturnPointSysNo]
            ,Settle.[PMSysno] as [PMInfo.SysNo]
            ,Settle.[ReturnPointC3SysNo]
            ,Settle.DeductAmt
            ,Settle.DeductAccountType
            ,Settle.DeductMethod
            ,Settle.ConsignRange
            ,ve.DeductSysNo as [VendorInfo.VendorDeductInfo.DeductSysNo]
            ,ve.CalcType as [VendorInfo.VendorDeductInfo.CalcType]
            ,ve.DeductPercent as [VendorInfo.VendorDeductInfo.DeductPercent]
            ,ve.FixAmt as [VendorInfo.VendorDeductInfo.FixAmt]
            ,ve.MaxAmt as [VendorInfo.VendorDeductInfo.MaxAmt]
        FROM IPP3.[dbo].[POConsign_Settle] AS Settle WITH(NOLOCK)
        LEFT OUTER JOIN IPP3.[dbo].[Vendor] AS Vendor WITH(NOLOCK)
        ON 	 Vendor.SysNo = Settle.VendorSysNo
        LEFT OUTER JOIN  OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK)
        ON 	 Stock.SysNo = Settle.StockSysNo
        LEFT Join ipp3.dbo.Vendor_Ex ve WITH(NOLOCK)
        on Vendor.sysno=ve.VendorSysNo
        #StrWhere#
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetVendorSettleItemsBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
  SELECT
	         Item.[SysNo] as [ItemSysNo]
            ,Item.[SettleSysNo]
	        ,Item.[Cost] as [ConsignToAccLogInfo.Cost]
	        ,Item.[CosignAcctLogSysNo] as [ConsignToAccLogInfo.LogSysNo]
			,Item.[AcquireReturnPoint]
	        ,Item.[AcquireReturnPointType]
	        ,AccLog.[CreateCost] as [ConsignToAccLogInfo.CreateCost]
	        ,AccLog.[FoldCost] as [ConsignToAccLogInfo.FoldCost]
	        ,ProdouctInfo.[ProductID]
	        ,ProdouctInfo.[ProductName] AS [ProductName]
	        ,ProdouctInfo.[SysNo] AS [ProductSysNo]
	        ,AccLog.[ProductSysNo] as [ConsignToAccLogInfo.ProductSysNo]
	        ,StockInfo.StockName as [ConsignToAccLogInfo.StockName]
	        ,AccLog.[StockSysNo] as [ConsignToAccLogInfo.StockSysNo]
	        ,VendorInfo.VendorName AS [VendorBasicInfo.VendorNameLocal]
	        ,AccLog.[VendorSysNo] AS [VendorBasicInfo.VendorID]
	        ,AccLog.[Quantity] as [ConsignToAccLogInfo.ProductQuantity]
	        ,Inventory.[ConsignQty]
	        ,Inventory.[OnLineQty]	        
	        ,AccLog.[Status] as [ConsignToAccLogInfo.ConsignToAccStatus]
          ,Item.[SettleType]
	        ,Item.[SettlePercentage]
          ,AccLog.RetailPrice as [ConsignToAccLogInfo.SalePrice]
          ,AccLog.Point as [ConsignToAccLogInfo.Point]
          ,Price.MinCommission as [ConsignToAccLogInfo.MinCommission]
          ,Item.ConsignSettleRuleSysNO AS SettleRuleSysNo
          ,Item.POConsignToAccLogSysNo
          ,CR.SettleRuleName
          ,CR.NewSettlePrice as SettlePrice
         FROM [IPP3].[dbo].[POConsign_Settle_Item] AS Item WITH(NOLOCK)
        LEFT OUTER JOIN  [IPP3].[dbo].[POConsign_ToAccLog] AS AccLog WITH(NOLOCK)
        ON 	  AccLog.[SysNo] = Item.[POConsignToAccLogSysNo]
        LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price AS Price WITH(NOLOCK)
            ON Price.ProductSysNo = AccLog.ProductSysNo
        LEFT OUTER JOIN   OverseaInventoryManagement.[dbo].[V_INM_Inventory] AS Inventory WITH(NOLOCK)
        ON 	  Inventory.ItemSysNumber = AccLog.ProductSysNo
        LEFT OUTER JOIN   [IPP3].[dbo].[Vendor] AS VendorInfo WITH(NOLOCK)
        ON 	  VendorInfo.SysNo = AccLog.VendorSysNo
        LEFT OUTER JOIN   OverseaInventoryManagement.[dbo].V_INM_Stock AS StockInfo WITH(NOLOCK)
        ON 	  StockInfo.SysNo = AccLog.StockSysNo
        LEFT OUTER JOIN    OverseaContentManagement.[dbo].[V_CM_ItemBasicInfo] AS ProdouctInfo WITH(NOLOCK)
        ON 	  ProdouctInfo.SysNo = AccLog.ProductSysNo
        LEFT OUTER JOIN OverseaPOASNManagement.dbo.ConsignSettleRule AS CR WITH(NOLOCK)
        ON Item.ConsignSettleRuleSysNO = CR.SysNo
        WHERE   Item.SettleSysNo = @SettleSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="DeleteVendorSettleItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DELETE
        FROM
          ipp3.[dbo].[POConsign_Settle_Item]
        WHERE
          [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateVendorSettle" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE IPP3.[dbo].[POConsign_Settle]
        SET
           [SettleID] = @SettleID
          ,[VendorSysNo] = @VendorSysNo
          ,[StockSysNo] = @StockSysNo
          ,[TotalAmt] = @TotalAmt
          ,[CurrencySysNo] = @CurrencySysNo
          ,[Memo] = @Memo
          ,[Note] = @Note
          ,[SettleBalanceSysNo] = @SettleBalanceSysNo
          ,[TaxRate] = @TaxRate

          ,[UsingReturnPoint] = @UsingReturnPoint
          ,[PM_ReturnPointSysNo] = @PM_ReturnPointSysNo
          ,[PMSysno] = @PMSysno
          ,[ReturnPointC3SysNo] = @ReturnPointC3SysNo
          ,[ProductLineSysNo]=@ProductLineSysNo
        WHERE
          [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@SettleID" dbType="String" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@SettleBalanceSysNo" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />

      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@PM_ReturnPointSysNo" dbType="Int32" />
      <param name="@PMSysno" dbType="Int32" />
      <param name="@ReturnPointC3SysNo" dbType="Int32" />
      <param name="@ProductLineSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleItemNOAcquirePoint" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE IPP3.[dbo].[POConsign_Settle_Item]
        SET
          [Cost] = @Cost
         ,[CurrencySysNo] = @CurrencySysNo
         ,[SettleType] = @SettleType
         ,[SettlePercentage] = @SettlePercentage
          ,[ConsignSettleRuleSysNo]=@SettleRuleSysNo
        WHERE  [SysNo] = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Cost" dbType="Decimal" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@SettleType" dbType="String" />
      <param name="@SettlePercentage" dbType="Decimal" />
      <param name="@SettleRuleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateAuditStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
              UPDATE  [IPP3].[dbo].[POConsign_Settle] 
        SET
           [Status] = @Status
          ,[AuditTime] = @AuditTime
          ,[AuditUserSysNo] = @AuditUserSysNo
          ,[Memo] = @Memo
          ,[Note] = @Note
        WHERE 
          [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateSettleStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
              UPDATE  [IPP3].[dbo].[POConsign_Settle] 
        SET
           [Status] = @Status
          ,[SettleTime] = @SettleTime
          ,[SettleUserSysNo] = @SettleUserSysNo
          ,[Memo] = @Memo
          ,[Note] = @Note
        WHERE 
          [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SettleTime" dbType="DateTime" />
      <param name="@SettleUserSysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreateVendorSettle" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DECLARE @ReplaceString VARCHAR(9) 
        
        INSERT INTO  [IPP3].[dbo].[POConsign_Settle_Sequence] 
        (
          [CreateTime]
        )
        VALUES 
        (
          CURRENT_TIMESTAMP
        )
        
        SELECT @SysNo = SCOPE_IDENTITY()      
        SET @SettleID = 'V'+right('000000000' + cast(@SysNo as varchar),9) 
        
        
        INSERT INTO  [IPP3].[dbo].[POConsign_Settle] 
        (
           [SysNo]
          ,[SettleID]
          ,[VendorSysNo]
          ,[StockSysNo]
          ,[TotalAmt]
          ,[CurrencySysNo]
          ,[CreateTime]
          ,[CreateUserSysNo]
          ,[Memo]
          ,[Note]
          ,[Status]
          ,[SettleBalanceSysNo]
          ,[TaxRate]
          ,[CompanyCode]
          ,[UsingReturnPoint]
          ,[PM_ReturnPointSysNo]
          ,[PMSysno]
          ,[ReturnPointC3SysNo]		 
          ,[ProductLineSysNo]
          ,IsToLease
          ,DeductAmt
          ,DeductAccountType
          ,DeductMethod
          ,ConsignRange
        )  
        VALUES 
        (
            @SysNo
           ,@SettleID
           ,@VendorSysNo
           ,@StockSysNo
           ,@TotalAmt
           ,@CurrencySysNo
           ,@CreateTime
           ,@CreateUserSysNo
           ,@Memo
           ,@Note
           ,@Status
           ,@SettleBalanceSysNo
           ,@TaxRate
           ,@CompanyCode
           ,@UsingReturnPoint
           ,@PM_ReturnPointSysNo
           ,@PMSysno
           ,@ReturnPointC3SysNo		  
           ,@ProductLineSysNo
           ,@IsToLease
          ,@DeductAmt
          ,@DeductAccountType
          ,@DeductMethod
          ,@ConsignRange
        )  
        SELECT @SysNo 
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@SettleID" dbType="String" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@CreateUserSysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@SettleBalanceSysNo" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@PM_ReturnPointSysNo" dbType="Int32" />
      <param name="@PMSysno" dbType="Int32" />
      <param name="@ReturnPointC3SysNo" dbType="Int32" />
      <param name="@ProductLineSysNo" dbType="Int32" />
      <param name="@IsToLease" dbType="Int32" />
      <param name="@DeductAmt" dbType="Decimal" />
      <param name="@DeductAccountType" dbType="Int32" />
      <param name="@DeductMethod" dbType="Int32" />
      <param name="@ConsignRange" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetConsignToAccountLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT 
           [SysNo] as LogSysNo
          ,[ProductSysNo]
          ,[VendorSysNo]
          ,[StockSysNo]
          ,[Quantity] as ProductQuantity
          ,[CreateCost]
          ,[FoldCost]
          ,[SettleCost]
          ,[ConsignToAccType]
          ,[Status]  as ConsignToAccStatus
       FROM 
           [IPP3].[dbo].[POConsign_ToAccLog] 
       WHERE 
          SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="IsAccountLogExistOtherVendorSettle" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
select 
	count(*)
from 
	[IPP3].[dbo].[POConsign_Settle_Item] as item with(nolock)
left join
	[IPP3].[dbo].[POConsign_Settle] as m with(nolock)
on
	m.sysno = item.settlesysno
where
	[status] <> 0
	and item.POConsignToAccLogSysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SettleConsignToAccountLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE
           [IPP3].[dbo].[POConsign_ToAccLog] 
        SET 
           [SettleCost] = @SettleCost
          ,[Status] = @Status 
          ,[FoldCost] = @FoldCost
        WHERE 
          [SysNo] = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@SettleCost" dbType="Decimal" />
      <param name="@FoldCost" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="CancelSettleConsignToAccountLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE
           [IPP3].[dbo].[POConsign_ToAccLog] 
        SET 
          [Status] = @Status 
          ,[SettleCost] = @SettleCost
          ,[FoldCost] = @FoldCost
        WHERE 
          [SysNo] = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@SettleCost" dbType="Int32" />
      <param name="@FoldCost" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryConsignSettleItemsNew" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
          @TotalCount = COUNT(a.CosignAcctLogSysNo)
        FROM
           (SELECT
	             Consign.SysNo AS CosignAcctLogSysNo
            FROM   [IPP3].[dbo].[POConsign_ToAccLog] AS Consign WITH(NOLOCK)
            INNER JOIN   OverseaContentManagement.[dbo].[V_CM_ItemBasicInfo] AS Product WITH(NOLOCK)
            ON	  Product.SysNo = Consign.ProductSysNo
            INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo catrgory WITH(NOLOCK)
            ON catrgory.Category3Sysno = Product.Category3SysNo
            LEFT OUTER JOIN  [IPP3].[dbo].[Vendor] AS Vendor WITH(NOLOCK)
            ON	 Vendor.SysNo = Consign.VendorSysNo
            LEFT OUTER JOIN  OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK)
            ON	Stock.SysNo = Consign.StockSysNo
            LEFT OUTER JOIN   OverseaInventoryManagement.[dbo].[V_INM_Inventory] AS Inventory WITH(NOLOCK)
            ON Inventory.ItemSysNumber = Product.SysNo
			LEFT   JOIN   OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1 AS LastPOinfo WITH(NOLOCK)
			ON   LastPOinfo.ProductSysNo  =Consign.ProductSysNo
            LEFT JOIN OverseaPOASNManagement.dbo.ConsignSettleRule AS CSR WITH(NOLOCK)
              ON Product.SysNo = CSR.ProductSysNo 
				        AND CSR.VendorSysNo = Vendor.SysNo 
				        AND Consign.SettleType = 'O'  
				        AND Consign.CreateTime BETWEEN CSR.BeginDate AND CSR.EndDate 
				        AND CSR.[Status] IN ('A','E')
                AND csr.SettleRuleQuantity-ISNULL(csr.SettleedQuantity,0)>=Consign.Quantity
                AND Consign.Quantity > 0
            #StrWhere# AND Consign.CreateTime < (SELECT [VALUE] FROM IPP3.dbo.Sys_Configuration WHERE [Key]='NewCosignAcctLogOnlineDate')) AS a

        SELECT
               SysNo AS [ConsignToAccLogInfo.LogSysNo]
              ,Quantity as [ConsignToAccLogInfo.ProductQuantity]
              ,Status as  [ConsignToAccLogInfo.ConsignToAccStatus]
              ,CreateTime as InDate
              ,CreateCost as [ConsignToAccLogInfo.CreateCost]
              ,FoldCost
              ,round(SettleCost,2) as [ConsignToAccLogInfo.Cost]
              ,round(SettleCost,2) as Cost
              ,Vendor as [VendorInfo.VendorBasicInfo.VendorNameLocal]
              ,Stock as [ConsignToAccLogInfo.StockName]
              ,Product as [ProductName]
              ,ProductType
              ,VendorSysNo
              ,StockSysNo as [ConsignToAccLogInfo.StockSysNo]
              ,ProductSysNo
              ,ProductID
              ,ConsignQty
              ,OnLineQty
              ,SettleType as [SettleType]
              ,SettlePercentage as [ConsignToAccLogInfo.SettlePercentage]
              ,SalePrice as [ConsignToAccLogInfo.SalePrice]
              ,Point as [ConsignToAccLogInfo.Point]
              ,MinCommission as [ConsignToAccLogInfo.MinCommission]
              ,SettleRuleSysNo
              ,SettleRuleName
              ,NewSettlePrice as SettlePrice
              --,(SalePrice - round(SettleCost,2)) as [ConsignToAccLogInfo.RateMargin]
              --,(Quantity * round(SettleCost,2)) as [ConsignToAccLogInfo.CountMany]
              --,(Quantity * (SalePrice - round(SettleCost,2))) as [ConsignToAccLogInfo.RateMarginTotal]
        FROM
              (SELECT
	               TOP (@EndNumber)  Consign.SysNo
                ,Consign.Quantity
                ,Consign.[Status]
                ,Consign.CreateTime
                ,Consign.CreateCost
                ,Consign.FoldCost
             	,ISNULL(Price.VirtualPrice,0) SettleCost
                ,Vendor.VendorName AS Vendor
                ,Vendor.SysNo AS VendorSysNo
                ,Stock.StockName AS Stock
                ,Stock.SysNo AS StockSysNo
	            ,Product.ProductName AS Product
                ,Product.SysNo AS ProductSysNo
                ,Product.ProductID
                ,Product.ProductType
                ,Inventory.ConsignQty
                ,Inventory.OnLineQty
                ,(CASE WHEN Consign.SettleType = 'O' THEN 0 ELSE 1 END) as SettleType
                ,Consign.SettlePercentage
                ,Consign.RetailPrice as SalePrice
                ,Consign.Point
                ,Price.MinCommission
                ,CSR.SysNo AS SettleRuleSysNo
                ,CSR.SettleRuleName
                ,CSR.NewSettlePrice
                ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
            FROM  [IPP3].[dbo].[POConsign_ToAccLog] AS Consign WITH(NOLOCK)
            INNER JOIN 	OverseaContentManagement.[dbo].[V_CM_ItemBasicInfo] AS Product WITH(NOLOCK)
            ON	  Product.SysNo = Consign.ProductSysNo
            INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo catrgory WITH(NOLOCK)
            ON catrgory.Category3Sysno = Product.Category3SysNo
            LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price AS Price WITH(NOLOCK)
            ON Price.ProductSysNo = Consign.ProductSysNo
            LEFT OUTER JOIN  [IPP3].[dbo].[Vendor] AS Vendor WITH(NOLOCK)
            ON	 Vendor.SysNo = Consign.VendorSysNo
            LEFT OUTER JOIN   OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK)
            ON Stock.SysNo = Consign.StockSysNo
            LEFT OUTER JOIN    OverseaInventoryManagement.[dbo].[V_INM_Inventory] AS Inventory WITH(NOLOCK)
            ON  Inventory.ItemSysNumber = Product.SysNo
			LEFT   JOIN   OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1 AS LastPOinfo WITH(NOLOCK)
			ON   LastPOinfo.ProductSysNo  = Consign.ProductSysNo
            LEFT JOIN OverseaPOASNManagement.dbo.ConsignSettleRule AS CSR WITH(NOLOCK)
              ON Product.SysNo = CSR.ProductSysNo 
				        AND CSR.VendorSysNo = Vendor.SysNo 
				        AND Consign.SettleType = 'O'  
				        AND Consign.CreateTime BETWEEN CSR.BeginDate AND CSR.EndDate 
				        AND CSR.[Status] IN ('A','E')
                AND csr.SettleRuleQuantity-ISNULL(csr.SettleedQuantity,0)>=Consign.Quantity
                AND Consign.Quantity > 0
            #StrWhere# AND Consign.CreateTime < (SELECT [VALUE] FROM IPP3.dbo.Sys_Configuration WHERE [Key]='NewCosignAcctLogOnlineDate')) AS a
            WHERE
              RowNumber > @StartNumber
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="CreateConsignToAccountLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	      INSERT INTO IPP3.[dbo].[POConsign_ToAccLog_Sequence]
        (
          [CreateTime]
        )
        VALUES
        (
          CURRENT_TIMESTAMP
        )

        SELECT @SysNo = SCOPE_IDENTITY()

        INSERT INTO OverseaPOASNManagement.dbo.CosignAcctLog
        (
           [SysNo]
	        ,[ProductSysNo]
	        ,[VendorSysNo]
	        ,[StockSysNo]
	        ,[Quantity]
	        ,[CreateCost]
	        ,[CreateTime]
	        ,[SettleCost]
	        ,[ReferenceType]
	        ,[Status]
	        ,[SettleType]
	        ,[SettlePercentage]
	        ,[SalePrice]
	        ,[Point]
	        ,[OrderSysNo]
          ,[CompanyCode]
        )
        VALUES
        (
           @SysNo
	        ,@ProductSysNo
	        ,@VendorSysNo
	        ,@StockSysNo
	        ,@Quantity
	        ,@CreateCost
	        ,GETDATE()
	        ,@SettleCost
	        ,@ReferenceType
	        ,@Status
	        ,@SettleType
	        ,@SettlePercentage
	        ,@SalePrice
	        ,@Point
	        ,@OrderSysNo
          ,@CompanyCode
        )

        SELECT @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@CreateCost" dbType="Decimal" />
      <param name="@SettleCost" dbType="Decimal" />
      <param name="@ReferenceType" dbType="AnsiStringFixedLength"/>
      <param name="@Status" dbType="AnsiStringFixedLength"/>
      <param name="@SettleType" dbType="String"/>
      <param name="@SettlePercentage" dbType="Decimal" />
      <param name="@SalePrice" dbType="Decimal" />
      <param name="@Point" dbType="Int32" />
      <param name="@OrderSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOConsignToAccLogForInventory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			DECLARE @SysNo int
			INSERT INTO [IPP3].[dbo].[POConsign_ToAccLog_Sequence](CreateTime)Values(getdate());
			SELECT @SysNo=SCOPE_IDENTITY()	
			
			DECLARE @VenderSysNo int
			SELECT 
				@VenderSysNo=LastVendorSysNo 
			FROM OverseaContentManagement.dbo.V_IM_Product_LastPOInfo WITH(NOLOCK)
			WHERE 
				ProductSysNo=@ProductSysNo 
			AND StockSysNo=@StockSysNo

			DECLARE @RetailPrice decimal(12,2)
			DECLARE @SettleType char(1)
			DECLARE @SettlePercentage decimal(5,2)
			SET @SettleType=''
			
			SELECT @RetailPrice=CurrentPrice
			FROM OverseaContentManagement.dbo.V_IM_Product_Price
			WHERE ProductSysNo=@ProductSysNo


			DECLARE @ManufacturerSysNo int
			DECLARE @C2SysNo int
			DECLARE @C3SysNo int

			--查找查询参数
			SELECT 
				@ManufacturerSysNo=p.ManufacturerSysNo
				,@C3SysNo=p.C3SysNo
				,@C2SysNo=c.C2SysNo
			FROM OverseaContentManagement.dbo.V_IM_Product p
			INNER JOIN OverseaContentManagement.dbo.V_IM_Category3 c ON p.C3SysNo=c.SysNo AND c.[Status]=0
			WHERE p.SysNo=@ProductSysNo

			--如果找不到对应的C3类别，就以C2类别查询
			SELECT top 1
				@SettleType=ISNULL(SettleType,'')
				,@SettlePercentage=SettlePercentage
			FROM IPP3.dbo.Vendor_Manufacturer
			WHERE VendorSysNo=@VenderSysNo
					AND ManufacturerSysNo=@ManufacturerSysNo
					AND C3SysNo=@C3SysNo
					AND [Status]=0
					AND CompanyCode=@CompanyCode
					AND StoreCompanyCode=@StoreCompanyCode
					AND LanguageCode='zh-CN'

            IF(@SettleType='')
			BEGIN
				SELECT top 1 
				@SettleType=ISNULL(SettleType,'')
				,@SettlePercentage=SettlePercentage
				FROM IPP3.dbo.Vendor_Manufacturer
				WHERE VendorSysNo=@VenderSysNo
					AND ManufacturerSysNo=@ManufacturerSysNo
					AND C2SysNo=@C2SysNo
					AND [Status]=0
					AND CompanyCode=@CompanyCode
					AND StoreCompanyCode=@StoreCompanyCode
					AND LanguageCode='zh-CN'
			END
			
			IF(@SettleType='')
			SET @SettleType='O'
			

			
			INSERT INTO [IPP3].[dbo].[POConsign_ToAccLog]
           ([SysNo]
		   ,[ProductSysNo]
           ,[VendorSysNo]
           ,[StockSysNo]
           ,[Quantity]
           ,[CreateCost]
           ,[CreateTime]
		   ,[Note]
           ,[ConsignToAccType]
           ,[Status]
           ,[CompanyCode]
		   ,[SettleType]
		   ,[SettlePercentage]
		   ,[RetailPrice]
		   ,[Point]
		   ,[OrderSysNo]
       ,[IsConsign]
		   )
     VALUES
           (@SysNo
		   ,@ProductSysNo
		   ,@VendorSysNoOut  --,ISNull(@VenderSysNo,0)
           ,@StockSysNo
           ,@Quantity
           ,@CreateCost
           ,@CreateTime
		   ,'Created by Inventory when Adjust OutStock!'
           ,2
           ,0
           ,@CompanyCode
		   ,@SettleType
		   ,@SettlePercentage
		   ,@RetailPrice
		   ,NULL
		   ,@OrderSysNo
       ,@IsConsign
		   )       
       SELECT @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@CreateCost" dbType="Decimal" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength"/>
      <param name="@OrderSysNo" dbType="Int32"/>
      <param name="@IsConsign" dbType="Int32"/>
      <param name="@VendorSysNoOut" dbType="Int32"/>
      <param name="@StoreCompanyCode" dbType="AnsiStringFixedLength"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetBackupUserListBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT BackupUserList
      FROM OverseaContentManagement.dbo.V_PM_PMList WITH(NOLOCK)
      WHERE PMUserSysNo = @PMUserSysNo AND Status = 0 AND CompanyCode = @CompanyCode
			]]>
    </commandText>
    <parameters>
      <param name="@PMUserSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="ExistsDifferentPMSysNoNew" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
            count(1)
        FROM
            OverseaContentManagement.dbo.V_IM_Product product WITH(nolock)
            #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE  [IPP3].[dbo].[POConsign_Settle_Item] 
        SET 
           [Cost] = @Cost 
          ,[CurrencySysNo] = @CurrencySysNo
          ,[AcquireReturnPointType]=@AcquireReturnPointType
          ,[AcquireReturnPoint]=@AcquireReturnPoint
          ,[SettleType] = @SettleType
          ,[SettlePercentage] = @SettlePercentage
          ,[ConsignSettleRuleSysNo]=@SettleRuleSysNo
        WHERE  [SysNo] = @SysNo    
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Cost" dbType="Decimal" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@AcquireReturnPoint" dbType="Decimal" />
      <param name="@AcquireReturnPointType" dbType="Int32" />
      <param name="@SettleType" dbType="String" />
      <param name="@SettlePercentage" dbType="Decimal" />
      <param name="@SettleRuleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>


  <!--For Invoice Start-->
  <dataCommand name="GetConsignSettlementReturnPointSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT PM_ReturnPointSysNo
				FROM IPP3.dbo.POConsign_Settle WITH(NOLOCK)
				WHERE SysNo=@SysNo
	        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetVendorSettleSysNoListByVendorSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT SysNo
				 FROM [IPP3].[dbo].[POConsign_Settle] WITH (NOLOCK)
				#StrWhere#
	        ]]>
    </commandText>
  </dataCommand>
  <!--For Invoice End-->
  <dataCommand name="GetSettleRuleQuantityCount" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
  SELECT CR.SysNo as RuleSysNo
              ,CR.SettleRuleName as SettleRulesName
			        ,CR.SettleRuleQuantity as SettleRulesQuantity
			        ,ISNULL(CR.SettleedQuantity,0) AS SettledQuantity
			        ,SUM(ABS(A.SUMQuantity)) AS SubmitSettleQuantity 
              ,CR.[Status]
		        FROM (
						        SELECT PSI.ConsignSettleRuleSysNO
						              ,SUM(PT.Quantity) SUMQuantity
						        FROM  [IPP3].[dbo].[POConsign_Settle_Item] AS PSI WITH(NOLOCK)
						        INNER JOIN IPP3.dbo.POConsign_ToAccLog AS PT WITH(NOLOCK)
							            ON PSI.POConsignToAccLogSysNo = PT.SysNo
							      WHERE SettleSysNo = @SettleSysNo AND PT.SettleType = 'O'
							      GROUP BY PT.CreateCost
									        ,PT.SettleType
									        ,PT.RetailPrice
									        ,PT.Point
									        ,PT.ProductSysNo
									        ,PSI.ConsignSettleRuleSysNO
		        ) AS A
		        INNER JOIN OverseaPOASNManagement.dbo.ConsignSettleRule AS CR WITH(NOLOCK)
			        ON A.ConsignSettleRuleSysNO = CR.SysNo
		        GROUP BY CR.SysNo,CR.SettleRuleName,CR.SettleRuleQuantity,CR.SettleedQuantity,CR.[Status]
			]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="UpdateConsignSettleRuleStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         UPDATE [OverseaPOASNManagement].[dbo].[ConsignSettleRule]
         SET [Status] = @Status,SettleedQuantity = @Quantity
         WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@Quantity" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="UpdateExistsConsignSettleRuleItemStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DECLARE @BeginDate DATETIME,@EndTime DATETIME
        SELECT TOP 1 @BeginDate = CR.BeginDate
		        ,@EndTime = CR.EndDate 
        FROM  OverseaPOASNManagement.dbo.ConsignSettleRule AS CR WITH(NOLOCK)
	        WHERE SysNo = @SysNo
        IF @EndTime <= GETDATE()
        BEGIN
	        IF NOT EXISTS(
		         SELECT TOP 1 1 FROM IPP3.dbo.POConsign_ToAccLog AS PT WITH(NOLOCK)
				        INNER JOIN OverseaPOASNManagement.dbo.ConsignSettleRule AS CR WITH(NOLOCK)
				        ON PT.ProductSysNo = CR.ProductSysNo 
					        AND PT.VendorSysNo = CR.VendorSysNo
			        WHERE PT.[Status] IN (0,3,4) 
                AND CR.SysNo = @SysNo
				        AND PT.CreateTime BETWEEN @BeginDate AND @EndTime
		        )
	        BEGIN
            UPDATE OverseaPOASNManagement.dbo.ConsignSettleRule
                SET [Status] = 'D'
            WHERE SysNo = @SysNo
	        END
        END
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--For 未结算经销商品查询-->
  <dataCommand name="GetSettleAccountWithOrigin" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      if exists(select * from tempdb..sysobjects where id=object_id('tempdb..#tmp1'))
	        DROP TABLE #tmp1

        CREATE TABLE #tmp1
        (
	        Amount decimal(19,6),
	        ItemAmount decimal(19,6),
	        TaxRate decimal(19,6),
	        InDate datetime,
	        OrderSysNo int,
	        OrderType int,
            FinancePayOrderType int,
	        VendorSysNo int,
	        FinancePaySysNo int
        )

        --进货单
        IF(@flag%3 = 0)
        BEGIN
	        INSERT INTO #tmp1
	        SELECT Finance_Pay.OrderAmt AS Amount
			        ,Finance_Pay.OrderAmt AS ItemAmount --凑列
			        ,PO_Master.TaxRate AS TaxRate
			        ,Finance_Pay.InDate AS InDate
			        ,Finance_Pay.OrderSysNo AS OrderSysNo
			        --,Finance_Pay.OrderType AS OrderType
			        ,3 AS OrderType
			        ,Finance_Pay.OrderType as FinancePayOrderType
			        ,PO_Master.VendorSysNo AS VendorSysNo
			        ,Finance_Pay.sysNo AS FinancePaySysNo
	        FROM ipp3.dbo.Finance_Pay  AS  Finance_Pay
	        INNER JOIN ipp3.dbo.PO_Master  AS PO_Master ON Finance_Pay.OrderSysNo = PO_Master.SysNo AND  Finance_Pay.PayStatus = 0 AND Finance_Pay.OrderType = 0 AND PO_Master.potype = 0
        END 
        --返厂单
        IF(@flag%5 = 0) 
        BEGIN
	        INSERT INTO #tmp1
	        SELECT Finance_Pay.OrderAmt AS Amount
			        ,Finance_Pay.OrderAmt AS ItemAmount --凑列
			        ,PO_Master.TaxRate AS TaxRate
			        ,Finance_Pay.InDate AS InDate 
			        ,Finance_Pay.OrderSysNo AS OrderSysNo
			        ,5 AS OrderType
                    ,Finance_Pay.OrderType as FinancePayOrderType
			        ,PO_Master.VendorSysNo AS VendorSysNo
			        ,Finance_Pay.sysNo AS FinancePaySysNo
	        FROM ipp3.dbo.Finance_Pay  AS Finance_Pay
	        INNER JOIN ipp3.dbo.PO_Master  AS PO_Master ON Finance_Pay.OrderSysNo = PO_Master.SysNo
	        WHERE Finance_Pay.PayStatus = 0 AND Finance_Pay.OrderType = 0 AND PO_Master.potype = 1
        END 
        --变价单结算查询
        IF(@flag%7 = 0)
        BEGIN
	        INSERT INTO #tmp1
	        SELECT Finance_Pay.OrderAmt AS Amount
			        ,(CostChangeItem.NewPrice - CostChangeItem.OldPrice) * CostChangeItem.ChangeCount AS ItemAmount
			        ,PO_Master.TaxRate AS TaxRate
			        ,Finance_Pay.InDate AS InDate
			        ,Finance_Pay.OrderSysNo AS OrderSysNo
			        ,7 AS OrderType
                    ,Finance_Pay.OrderType as FinancePayOrderType
			        ,CostChange.VendorSysNo AS VendorSysNo
			        ,Finance_Pay.sysNo AS FinancePaySysNo
	        FROM ipp3.dbo.Finance_Pay AS Finance_Pay
	        INNER JOIN OverseaPOASNManagement.dbo.CostChange AS CostChange ON Finance_Pay.OrderSysNo = CostChange.SysNo AND Finance_Pay.PayStatus = 0 AND Finance_Pay.OrderType = 16
	        LEFT JOIN OverseaPOASNManagement.dbo.CostChangeItem AS CostChangeItem ON CostChange.SysNo = CostChangeItem.CostChangeSysNo
	        LEFT JOIN ipp3.dbo.PO_Master AS PO_Master ON CostChangeItem.POSysNo = PO_Master.SysNo
        END 

        SELECT  @TotalCount = COUNT(OrderSysNo)
        FROM (

	        SELECT  
			         Amount --总额
		          ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Tax17] --17税金
		          ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost17] --17价款
		          ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Tax13] --13税金
		          ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost13] --13价款
		          ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [TaxOt] --其他税金
		          ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [CostOt] --其他价款
		          ,InDate
		          ,OrderSysNo
		          ,OrderType
		          ,Vendor.SysNo AS VendorSysNo
		          ,Vendor.VendorName AS VendorName
		          ,FinancePaySysNo
	        FROM #tmp1
	        LEFT JOIN ipp3.dbo.Vendor AS Vendor ON #tmp1.VendorSysNo = Vendor.SysNo
          #StrWhere# 
	        GROUP BY OrderSysNo,Amount,OrderType,InDate,Vendor.SysNo,Vendor.VendorName ,FinancePayOrderType,FinancePaySysNo
	         ) AS T
	 
        SELECT  *
        FROM 
		        (
		        SELECT   Amount --总额
			          ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Tax17] --17税金
			          ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost17] --17价款
			          ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Tax13] --13税金
			          ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost13] --13价款
			          ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [TaxOt] --其他税金
			          ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [CostOt] --其他价款
			          ,InDate
			          ,OrderSysNo
			          ,OrderType
                      ,FinancePayOrderType
			          ,Vendor.SysNo AS VendorSysNo
			          ,Vendor.VendorName AS VendorName
			          ,FinancePaySysNo
			          ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
		        FROM #tmp1
		        LEFT JOIN ipp3.dbo.Vendor AS Vendor ON #tmp1.VendorSysNo = Vendor.SysNo
            #StrWhere# 
		        GROUP BY OrderSysNo,Amount,OrderType,InDate,Vendor.SysNo,Vendor.VendorName,FinancePayOrderType,FinancePaySysNo
		        ) AS RESULT 
        where RowNumber > @StartNumber And  RowNumber <= @EndNumber
			]]>
    </commandText>
  </dataCommand>

  <!--For 创建（添加）商品结算单主信息-->
  <dataCommand name="SettleInfoAdd" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	      INSERT INTO ipp3.dbo.PO_Settle (
	            VendorSysNo
	            ,StockSysNo
	            ,TotalAmt
	            ,CreateTime
	            ,CreateUserSysNo
	            ,Status
              ,CompanyCode
              )
        VALUES(
		         @VendorSysNo
	          ,@StockSysNo
	          ,@TotalAmt
	          ,@CreateTime
	          ,@CreateUserSysNo
	          ,@Status
            ,@CompanyCode
            )
        SELECT @SysNo = SCOPE_IDENTITY()
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"   direction="Output"/>
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@CreateUserSysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <!--For 添加经销商品结算单子项-->
  <dataCommand name="SettleItemInfoAdd" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DECLARE @OrderType int
        SELECT @OrderType = OrderType
        FROM ipp3.dbo.Finance_Pay 
        WHERE sysNo = @FinancePaySysNo

        IF(@orderType = 0) --采购（正负采购）
        BEGIN 
	        INSERT INTO ipp3.dbo.PO_Settle_Item(
		        SettleSysNo,TaxRate,PayAmt,OrderSysNo,CompanyCode,OrderType,FinancePaySysNo
	        )
	        SELECT @SettleSysNo,PO_Master.TaxRate,Finance_Pay.OrderAmt,Finance_Pay.ordersysNo,@CompanyCode,Finance_Pay.OrderType,Finance_Pay.SysNo
	        FROM ipp3.dbo.Finance_Pay AS Finance_Pay
	        INNER JOIN ipp3.dbo.PO_Master  AS PO_Master ON  Finance_Pay.OrderSysNo = PO_Master.SysNo 
	        WHERE Finance_Pay.sysno = @FinancePaySysNo

	        SELECT @SysNo = SCOPE_IDENTITY()
        END

        ELSE IF(@orderType = 16) --进价还价单
        BEGIN 
	        INSERT INTO ipp3.dbo.PO_Settle_Item(
		        SettleSysNo,TaxRate,PayAmt,OrderSysNo,CompanyCode,OrderType,FinancePaySysNo
	        )
	        SELECT @SettleSysNo
		        ,PO_Master.TaxRate 
		        ,(CostChangeItem.NewPrice - CostChangeItem.OldPrice) * CostChangeItem.ChangeCount
		        ,Finance_Pay.ordersysNo
				,@CompanyCode
				,Finance_Pay.OrderType
				,Finance_Pay.SysNo
	        FROM ipp3.dbo.Finance_Pay  AS Finance_Pay
			    INNER JOIN OverseaPOASNManagement.dbo.CostChange AS CostChange ON Finance_Pay.OrderSysNo = CostChange.SysNo AND Finance_Pay.PayStatus = 0 AND Finance_Pay.OrderType = 16
			    LEFT JOIN OverseaPOASNManagement.dbo.CostChangeItem AS CostChangeItem ON CostChange.SysNo = CostChangeItem.CostChangeSysNo
			    LEFT JOIN ipp3.dbo.PO_Master AS PO_Master ON CostChangeItem.POSysNo = PO_Master.SysNo
	        WHERE Finance_Pay.SysNo =@FinancePaySysNo

	        SELECT @SysNo = SCOPE_IDENTITY()
        END 

      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"   direction="Output"/>
      <param name="@SettleSysNo" dbType="Int32" />
      <!--<param name="@OrderSysNo" dbType="Decimal" />
      <param name="@OrderType" dbType="Int32" />-->
      <param name="@FinancePaySysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />

    </parameters>
  </dataCommand>

  <!--获取经销商品结算单信息-->
  <dataCommand name="GetSettleInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       SELECT PO_Settle.*,Vendor.VendorName
       FROM ipp3.dbo.PO_Settle AS PO_Settle
       LEFT JOIN  ipp3.dbo.Vendor AS Vendor ON PO_Settle.vendorSysNo = Vendor.sysNo
       WHERE PO_Settle.SysNo = @SettleSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32"  />
    </parameters>
  </dataCommand>

  <!--获取经销商品结算单子项信息-->
  <dataCommand name="GetSettleItemInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       SELECT [SysNo]
        ,[SettleSysNo]
        ,[TaxRate]
        ,[PayAmt]
        ,[CompanyCode]
        ,[OrderSysNo]
        ,[OrderType] AS FinancePayOrderType
        ,FinancePaySysNo
       FROM [IPP3].[dbo].[PO_Settle_Item]
       WHERE SettleSysNo = @SettleSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32"  />
    </parameters>
  </dataCommand>


  <!--获取经销商品结算单子信息（附带价款、税金信息）-->
  <dataCommand name="GetSettleItemInfoWithTaxAndCost" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         if exists(select * from tempdb..sysobjects where id=object_id('tempdb..#tmp1'))
	      DROP TABLE #tmp1

        CREATE TABLE #tmp1
        (
          Amount decimal(19,6),
          ItemAmount decimal(19,6),
          TaxRate decimal(19,6),
          InDate datetime,
          OrderSysNo int,
          OrderType int,
          VendorSysNo int,
          FinancePaySysNo int
        )
        INSERT INTO #tmp1
        SELECT Finance_Pay.OrderAmt AS Amount
              ,Finance_Pay.OrderAmt AS ItemAmount --凑列
              ,PO_Master.TaxRate AS TaxRate
              ,Finance_Pay.InDate AS InDate
              ,Finance_Pay.OrderSysNo AS OrderSysNo
              ,3 AS OrderType
              ,PO_Master.VendorSysNo AS VendorSysNo
              ,Finance_Pay.SysNo AS FinancePaySysNo
        FROM ipp3.dbo.Finance_Pay  AS Finance_Pay
        INNER JOIN ipp3.dbo.PO_Master  AS PO_Master ON Finance_Pay.OrderSysNo = PO_Master.SysNo AND Finance_Pay.OrderType = 0 AND PO_Master.potype = 0

        INSERT INTO #tmp1
        SELECT Finance_Pay.OrderAmt AS Amount
              ,Finance_Pay.OrderAmt AS ItemAmount --凑列
              ,PO_Master.TaxRate AS TaxRate
              ,Finance_Pay.InDate AS InDate 
              ,Finance_Pay.OrderSysNo AS OrderSysNo
              ,5 AS OrderType
              ,PO_Master.VendorSysNo AS VendorSysNo
              ,Finance_Pay.SysNo AS FinancePaySysNo
        FROM ipp3.dbo.Finance_Pay  AS Finance_Pay
        INNER JOIN ipp3.dbo.PO_Master  AS PO_Master ON Finance_Pay.OrderSysNo = PO_Master.SysNo
        WHERE  Finance_Pay.OrderType = 0 AND PO_Master.potype = 1

        INSERT INTO #tmp1
        SELECT Finance_Pay.OrderAmt AS Amount
              ,(CostChangeItem.NewPrice - CostChangeItem.OldPrice) * CostChangeItem.ChangeCount AS ItemAmount
              ,PO_Master.TaxRate AS TaxRate
              ,Finance_Pay.InDate AS InDate
              ,Finance_Pay.OrderSysNo AS OrderSysNo
              ,7 AS OrderType
              ,CostChange.VendorSysNo AS VendorSysNo
              ,Finance_Pay.SysNo AS FinancePaySysNo
        FROM ipp3.dbo.Finance_Pay AS Finance_Pay
        INNER JOIN OverseaPOASNManagement.dbo.CostChange AS CostChange ON Finance_Pay.OrderSysNo = CostChange.SysNo  AND Finance_Pay.OrderType = 16
        LEFT JOIN OverseaPOASNManagement.dbo.CostChangeItem AS CostChangeItem ON CostChange.SysNo = CostChangeItem.CostChangeSysNo
        LEFT JOIN ipp3.dbo.PO_Master AS PO_Master ON CostChangeItem.POSysNo = PO_Master.SysNo


        SELECT   Amount as [RateCost] --总额
		        ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Rate17] --17税金
		        ,SUM(CASE TaxRate WHEN 0.17 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost17] --17价款
		        ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [Rate13] --13税金
		        ,SUM(CASE TaxRate WHEN 0.13 THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [Cost13] --13价款
		        ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * TaxRate/(1+TaxRate) ELSE 0 END) AS [RateOther] --其他税金
		        ,SUM(CASE WHEN TaxRate not IN(0.13,0.17) THEN ItemAmount * 1/(1+TaxRate) ELSE 0 END) AS [CostOther] --其他价款
		        ,InDate
		        ,OrderSysNo
		        ,OrderType
		        ,Vendor.SysNo AS VendorSysNo
		        ,Vendor.VendorName AS VendorName
		        ,FinancePaySysNo
        FROM #tmp1
        LEFT JOIN ipp3.dbo.Vendor AS Vendor ON #tmp1.VendorSysNo = Vendor.SysNo
        WHERE FinancePaySysNo IN (SELECT FinancePaySysNo FROM ipp3.dbo.PO_Settle_Item WHERE SettleSysNo = @SettleSysNo)
        GROUP BY OrderSysNo,Amount,OrderType,InDate,Vendor.SysNo,Vendor.VendorName,FinancePaySysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32"  />
    </parameters>
  </dataCommand>

  <!--审核 经销商品结算单-->
  <dataCommand name="AuditSettleAccount" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE ipp3.dbo.PO_Settle
          SET STATUS = @status,AuditTime = @AuditTime,AuditUserSysNo = @AuditUserSysNo
          WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"  />
      <param name="@status" dbType="Int32"  />
      <param name="@AuditTime" dbType="DateTime"  />
      <param name="@AuditUserSysNo" dbType="Int32"  />
    </parameters>
  </dataCommand>

  <dataCommand name="ChangeFinancePayStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE ipp3.dbo.Finance_Pay 
          SET PayStatus = @PayStatus
          WHERE sysNo = @FinancePaySysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@PayStatus" dbType="Int32"  />
      <!--<param name="@OrderSysNo" dbType="Int32"  />
      <param name="@OrderType" dbType="Int32"  />-->
      <param name="@FinancePaySysNo" dbType="Int32"  />
    </parameters>
  </dataCommand>

  <dataCommand name="FinancePayItemPaid" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE FPM 
          SET FPM.Status=@PayItemStatus,PayTime=GETDATE()
          FROM IPP3.dbo.Finance_Pay_Item FPM WITH(NOLOCK) 
          INNER JOIN IPP3.dbo.Finance_Pay FP WITH(NOLOCK) 
          ON FPM.OrderType = FP.OrderType AND FPM.PaySysNo = FP.SysNo 
          AND FPM.Status<>-1 AND FP.PayStatus<>-1 
          WHERE FP.SysNo=@PaySysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@PaySysNo" dbType="Int32"  />
      <param name="@PayItemStatus" dbType="Int32"  />
    </parameters>
  </dataCommand>

  <dataCommand name="FinancePayItemOrigin" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE FPM 
          SET FPM.Status=@PayItemStatus
          FROM IPP3.dbo.Finance_Pay_Item FPM WITH(NOLOCK) 
          INNER JOIN IPP3.dbo.Finance_Pay FP WITH(NOLOCK) 
          ON FPM.OrderType = FP.OrderType AND FPM.PaySysNo = FP.SysNo 
          AND FPM.Status<>-1 AND FP.PayStatus<>-1 
          WHERE FP.SysNo=@PaySysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@PaySysNo" dbType="Int32"  />
      <param name="@PayItemStatus" dbType="Int32"  />
    </parameters>
  </dataCommand>
</dataOperations>
