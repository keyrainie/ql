<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <dataCommand name="QueryVendorSettleGather" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         SELECT
	           @TotalCount = COUNT(1)
          FROM  OverseaPOASNManagement.dbo.CollectionSettlement AS Settle WITH(NOLOCK)
          Inner  JOIN  [dbo].[Vendor] AS Vendor WITH(NOLOCK)
          ON   Vendor.SysNo = Settle.MerchantSysNo
          Inner JOIN  OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK)
          ON  Stock.SysNo = Settle.StockSysNo
          ##WareHouseNumber##
          #StrWhere#

         SELECT
             SysNo
	          ,SettleID
	          ,VendorSysNo
            ,VendorName
            ,StockSysNo
	          ,StockName
	          ,TotalAmt
	          ,CreateTime
            ,CreateUser
	          ,AuditTime
            ,AuditUser
	          ,SettleTime
	          ,SettleUser
	          ,Memo
	          ,Status
            ,PayPeriodType
            ,PayPeriodTypeName
            ,PaySettleCompany
         FROM
          (SELECT
	           TOP (@EndNumber)
             Settle.[SysNo]
	          ,Settle.[SysNo] AS SettleID
	          ,Settle.MerchantSysNo AS VendorSysNo
            ,Vendor.[VendorName]
            ,Settle.[StockSysNo]
	          ,Stock.[StockName]
	          ,Settle.TotalAmt
	          ,Settle.InDate AS  [CreateTime]
            ,Settle.InUser AS CreateUser
	          ,Settle.AuditDate AS AuditTime
            ,Settle.AuditUser AS AuditUser
	          ,Settle.SettleDate AS SettleTime
	          ,Settle.SettleUser
	          ,Settle.[Memo]
	          ,Settle.[Status]
            ,Vendor.[PayPeriodType]
            ,Vendor.[PaySettleCompany]
            ,PayTerms.[PayTermsName] AS PayPeriodTypeName
            ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
          FROM  OverseaPOASNManagement.dbo.CollectionSettlement AS Settle WITH(NOLOCK)
          INNER JOIN  [dbo].[Vendor] AS Vendor WITH(NOLOCK)
          ON   Vendor.SysNo = Settle.MerchantSysNo
          INNER JOIN  OverseaInventoryManagement.[dbo].[V_INM_Stock] AS Stock WITH(NOLOCK)
          ON  Stock.SysNo = Settle.StockSysNo
          LEFT OUTER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_VendorPayTerms AS PayTerms WITH(NOLOCK)
          ON   Vendor.SysNo = Settle.MerchantSysNo  AND  PayTerms.PayTermsNo = Vendor.PayPeriodType
          ##WareHouseNumber##

          #StrWhere#) AS a
          WHERE  RowNumber > @StartNumber
		  ORDER BY RowNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetVendorSettleGatherBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       SELECT   Settle.SysNo         AS SysNo
               ,Settle.SysNo         AS SettleID
               ,Settle.MerchantSysNo AS [VendorInfo.SysNo]
               ,stock.SysNo    AS [SourceStockInfo.SysNo]
               ,stock.StockName    AS [SourceStockInfo.StockName]
               ,Settle.TotalAmt     AS TotalAmt
               ,Settle.InDate       AS CreateDate
               ,Settle.Memo
               ,Settle.Status      AS SettleStatus
               ,Settle.CompanyCode      AS CompanyCode
               ,Vendor.VendorName  AS [VendorInfo.VendorBasicInfo.VendorNameLocal]
               ,Vendor.PaySettleCompany  AS [VendorInfo.VendorBasicInfo.PaySettleCompany]
        FROM OverseaPOASNManagement.dbo.CollectionSettlement  Settle WITH(NOLOCK)
        LEFT OUTER JOIN ipp3.[dbo].[Vendor]  Vendor WITH(NOLOCK)
        ON 	 Vendor.SysNo = Settle.MerchantSysNo
        LEFT OUTER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
        ON stock.SysNo = Settle.StockSysNo
        #StrWhere#
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetVendorSettleGatherItemsPageBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

 SELECT
         SysNo as [ItemSysNo]
        ,SettleSysNo
		    ,InvoiceNumber  --单据编号
		    ,OrderDate   as [CreateDate]   --创建日期
		    ,WarehouseNumber as  [StockSysNo]--仓库
		    ,ProductSysNo
		    ,OriginalPrice as [SalePrice]--销售价格
		    ,Quantity  as [ProductQuantity]   --数量
        ,TransactionNumber
		    ,ProductID  --商品编号
		    ,ProductName --商品名称
		    ,StockName --
		    ,SettleType as [SettleType]
        ,SettleType AS DisplaySettleType
        ,SONumber as [OrderSysNo]
        ,Point
        ,ItemType
        ,OutOrRefundDate
        ,PromotionDiscount
FROM
 (
 SELECT
         SysNo
        ,SettleSysNo
		,InvoiceNumber  --单据编号
		,OrderDate      --创建日期
		,WarehouseNumber --仓库
		,ProductSysNo
		,OriginalPrice --销售价格
		,Quantity     --数量
        ,TransactionNumber
		,ProductID  --商品编号
		,ProductName --商品名称
		,StockName --
		,SettleType
        ,SONumber
        ,Point
        ,ItemType
        ,OutOrRefundDate
        ,PromotionDiscount
 FROM
 (
    SELECT
         settleItem.SysNo
        ,settleItem.SettlementSysNo AS SettleSysNo
		,invoice.SONumber InvoiceNumber  --单据编号
		,invoice.OrderDate      --创建日期
		,invoice.WarehouseNumber --仓库
		,settleItem.ProductSysNo
		,settleItem.SalesAmt AS OriginalPrice --销售价格
		,settleItem.Qty  AS Quantity     --数量
        ,TransactionNumber = NULL
		,product.ProductID  --商品编号
		,product.ProductName --商品名称
		,stock.StockName --
		,settleItem.ReferenceType AS  SettleType
        ,settleItem.ReferenceSysNo AS  SONumber
        ,Point = null
        ,settleItem.ItemType
        ,invoice.InvoiceDate OutOrRefundDate
        ,settleItem.PromotionDiscount
      FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item settleItem WITH(NOLOCK)
      INNER JOIN  OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster  invoice WITH(NOLOCK)
      ON settleItem.ReferenceSysNo = invoice.SONumber AND settleItem.ReferenceType = 'SO'
			LEFT JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
			ON product.SysNo = settleItem.ProductSysNo
			LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
			ON stock.SysNo = invoice.WarehouseNumber
      WHERE   settleItem.SettlementSysNo = @SettleSysNo

      UNION ALL

      SELECT
         settleItem.SysNo
        ,settleItem.SettlementSysNo AS SettleSysNo
		,refund.SysNo AS InvoiceNumber
		,OrderDate = refund.CreateTime
		,WarehouseNumber = NULL
		,settleItem.ProductSysNo
		,settleItem.SalesAmt AS OriginalPrice --销售价格
		,settleItem.Qty  AS Quantity     --数量
		,TransactionNumber = NULL
		,Product.ProductID
		,product.ProductName
		,StockName = NULL
		,settleItem.ReferenceType AS SettleType
		,settleItem.ReferenceSysNo AS SONumber
    ,Point = null
    ,settleItem.ItemType
    ,refund.RefundTime OutOrRefundDate
    ,PromotionDiscount=NULL
    FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item settleItem WITH(NOLOCK)
    INNER JOIN  OverseaServiceManagement.dbo.V_SM_RMARefundMaster refund WITH(NOLOCK)
    ON settleItem.ReferenceSysNo = refund.SysNo AND settleItem.ReferenceType = 'RMA'
	LEFT JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
	ON Product.SysNo = settleItem.ProductSysNo
	LEFT  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
	ON so.SOSysNo  =  refund.SOSysNo
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
	ON ship.SOSysNo = so.SOSysNo
    WHERE   settleItem.SettlementSysNo = @SettleSysNo
    
  UNION ALL
    
    SELECT 
         settleItem.SysNo
        ,settleItem.SettlementSysNo AS SettleSysNo
		,ra.SysNo AS InvoiceNumber
		,OrderDate = ra.CreateTime
		,WarehouseNumber = NULL
		,settleItem.ProductSysNo  
		,settleItem.SalesAmt AS OriginalPrice --销售价格
		,settleItem.Qty  AS Quantity     --数量 
		,TransactionNumber = NULL
		,ProductID = NULL
		,ProductName = NULL
		,StockName = NULL
		,settleItem.ReferenceType AS SettleType
		,settleItem.ReferenceSysNo AS SONumber
    ,Point = null 
    ,settleItem.ItemType
    ,ra.RefundTime OutOrRefundDate
    ,PromotionDiscount=NULL
    FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item settleItem WITH(NOLOCK)
    INNER JOIN OverseaCustomerManagement.dbo.V_CM_RO_Adjust ra WITH(NOLOCK)
    ON settleItem.ReferenceSysNo = ra.SysNo AND settleItem.ReferenceType = 'RO_Adjust'	
	LEFT  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
	ON so.SOSysNo  =  ra.SOSysNo
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
	ON ship.SOSysNo = so.SOSysNo
  LEFT JOIN OverseaPOASNManagement.dbo.CollectionSettlement settlement WITH(NOLOCK)
      ON settleItem.SettlementSysNo=settlement.SysNo
      LEFT JOIN [IPP3].[dbo].[Vendor] vendor WITH(NOLOCK)
      ON settlement.MerchantSysNo=vendor.SysNo
    WHERE   settleItem.SettlementSysNo = @SettleSysNo  
    
    
    
   ) b
)c
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryConsignSettleGatherALLShippingCharge" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT  DISTINCT
						 main.InvoiceNumber  --单据编号
						,main.OrderDate  as CreateDate    --创建日期
						,main.WarehouseNumber as StockSysNo --仓库
						,VendorSysno = NULL
						,ProductSysNo = 0
						,round( isnull( so.ShippingCharge,0.0),2) as SalePrice --销售价格
						,1 as ProductQuantity    --数量
						,TransactionNumber = 0
						,VendorName = NULL   --供应商
						,ProductID = NULL   --商品编号
						,ProductName = 'SO运费' --商品名称
						,StockName = NULL
						,SettleType = 'SO'
						,main.SONumber as OrderSysNo
						,Point = NULL
					  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster  main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber  and trans.ItemType <>4
            ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
					  INNER JOIN IPP3.dbo.Vendor_Ex vex WITH(NOLOCK)
					  ON vex.VendorSysNo = ship.MerchantSysNo AND vex.StockType='MET' AND vex.ShippingType='MET' AND vex.InvoiceType = 'MET'
					  left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'

            #StrWhere#

            UNION ALL

					  SELECT DISTINCT
						 main.SysNo AS InvoiceNumber
						,main.CreateTime as CreateDate
						,register.LocationWarehouse as  StockSysNo
						,VendorSysno = NULL
						,ProductSysNo = -1
						,(round( isnull(so.ShippingCharge,0.00),2))  AS SalePrice
						,-1 as ProductQuantity
						,TransactionNumber = NULL
						,VendorName = NULL
						,ProductID = NULL
						,ProductName = 'RMA三费'
						,StockName = NULL
						,SettleType='RMA'
						,main.SysNo AS OrderSysNo
						,Point = null
					FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
					INNER JOIN IPP3.dbo.Vendor_Ex vex WITH(NOLOCK)
					ON vex.VendorSysNo = ship.MerchantSysNo AND vex.StockType='MET' AND vex.ShippingType='MET' AND vex.InvoiceType = 'MET'
          left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'

          #StrWhere#

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryConsignSettleGatherItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT  @TotalCount = COUNT(1)
		  FROM 
		  (
			   SELECT Number = 1
			   FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber and trans.ItemType <>4
					  ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
            INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					  ON vendorex.VendorSysNo = vendor.SysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
            left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'
            
            
            #StrWhere#
			  
			  UNION ALL 
			  
			    SELECT Number = 1
			    FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
          INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'
          
            
          #StrWhere#
                
 UNION ALL
           SELECT 	Number = 1					
					FROM OverseaCustomerManagement.dbo.V_CM_RO_Adjust main WITH(NOLOCK)
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo AND main.Status = 4
          ##OrderDate3##
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN IPP3.dbo.Vendor vendor WITH(NOLOCK) 
					ON vendor.SysNo = ship.MerchantSysNo 
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RO_Adjust'
          
        #StrWhere#
          )c
          
        SELECT 
         InvoiceNumber
        ,OrderDate as [CreateDate]     --创建日期
				,WarehouseNumber  as [StockSysNo] --仓库
				,VendorSysno
				,ProductSysNo
				,round(OriginalPrice,2) AS SalePrice  --销售价格
				,Quantity as [ProductQuantity]     --数量
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,TransactionNumber
				,SONumber as[OrderSysNo]
				,Point
        ,(ROUND(OriginalPrice,2) * Quantity) as TotalAmt
        ,OutOrRefundDate
        ,PromotionDiscount
        FROM 
        (
        	SELECT  TOP (@EndNumber)
				 InvoiceNumber  --单据编号
				,OrderDate      --创建日期
				,WarehouseNumber --仓库
				,VendorSysno
				,ProductSysNo
				,OriginalPrice --销售价格

				,Quantity     --数量
        ,TransactionNumber
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,SONumber
				,Point
        ,OutOrRefundDate
				,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
        ,PromotionDiscount
			  FROM
			  (
					  SELECT
						main.SONumber InvoiceNumber   --单据编号
						,main.OrderDate       --创建日期
						,main.WarehouseNumber --仓库
						,VendorSysno = ship.MerchantSysNo
						,trans.ProductSysNo
						,(trans.OriginalPrice   - (isnull(trans.Point,0)/10.00) + isnull(trans.DiscountAmt,0.00)/trans.Quantity) AS  OriginalPrice --销售价格

						,trans.Quantity     --数量
						,trans.TransactionNumber
						,vendor.VendorName  --供应商
						,product.ProductID  --商品编号
						,product.ProductName --商品名称
						,stock.StockName --
						,SettleType = 'SO'
						,main.SONumber
						,Point = null
            ,main.InvoiceDate OutOrRefundDate
            ,ISNULL(trans.PromotionDiscount,0) as PromotionDiscount--优惠券金额
					  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber  and trans.ItemType <>4
					  ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
            INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					  ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
					  left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'
           
           #StrWhere#
					  
            UNION ALL 
					  
					  SELECT 
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = register.LocationWarehouse 
						,VendorSysno = ship.MerchantSysNo
						,register.ProductSysNo 
						,(refundItem.OrgPrice + isnull(refundItem.UnitDiscount,0.00) - (isnull(refundItem.OrgPoint,0)/10.00))  AS OriginalPrice
						,-1
            ,TransactionNumber = NULL            
						,VendorName = NULL
						,Product.ProductID
						,product.ProductName
						,StockName = NULL
						,SettleType='RMA'
						,main.SysNo AS SONumber
						,Point = null
            ,main.RefundTime OutOrRefundDate
            ,PromotionDiscount=NULL
					FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
          INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'
          
          
                #StrWhere#
			   
         UNION ALL
           SELECT  
						 main.SysNo AS InvoiceNumber
						,main.CreateTime
						,so.WareHouseNumber
						,ship.MerchantSysNo
						,ProductSysNo = -1 
						,ISNULL(main.CashAmt,0)  AS OriginalPrice
            , -1
            ,TransactionNumber = NULL            
						,VendorName = vendor.VendorName
						,ProductID = NULL 
						,'RO_Adjust补偿退款'
						,StockName = NULL
						,'RO_Adjust'
						,main.SysNo AS SONumber
						,Point = null  
						,main.RefundTime OutOrRefundDate
            ,PromotionDiscount=NULL
					FROM OverseaCustomerManagement.dbo.V_CM_RO_Adjust main WITH(NOLOCK)
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo AND main.Status=4
          ##OrderDate3##
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN IPP3.dbo.Vendor vendor WITH(NOLOCK) 
					ON vendor.SysNo = ship.MerchantSysNo 
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RO_Adjust'
          
        #StrWhere#
         ) b 
		     
      )  a 
      WHERE  RowNumber > @StartNumber
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="CreateVendorSettleGather" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

          INSERT INTO OverseaPOASNManagement.dbo.CollectionSettlement
          (
	           MerchantSysNo
	          ,StockSysNo
	          ,TotalAmt
	          ,CurrencyCode
	          ,InUser
	          ,InDate
	          ,EditUser
	          ,EditDate
	          ,Status
            ,CompanyCode
            ,StoreCompanyCode
            ,Memo
          )
          VALUES
          (
	           @MerchantSysNo
	          ,@StockSysNo
	          ,@TotalAmt
	          ,@CurrencySysNo
	          ,@InUser
	          ,@InDate
	          ,@EditUser
	          ,@EditDate
	          ,@Status
            ,@CompanyCode
            ,@StoreCompanyCode
            ,@Memo
          )
         SELECT SCOPE_IDENTITY()
			]]>
    </commandText>
    <parameters>
      <param name="@MerchantSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CurrencySysNo" dbType="String" />
      <param name="@InUser" dbType="String" />
      <param name="@InDate" dbType="DateTime" />
      <param name="@EditUser" dbType="String" />
      <param name="@EditDate" dbType="DateTime" />
      <param name="@Status" dbType="String" />
      <param name="@CompanyCode" dbType="String" />
      <param name="@StoreCompanyCode" dbType="String" />
      <param name="@Memo" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="InsertConsignSettleGatherItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

        INSERT INTO OverseaPOASNManagement.dbo.CollectionSettlement_Item
         (
         	    ReferenceSysNo
	           ,ReferenceType
	           ,SettlementSysNo
	           ,ProductSysNo
	           ,Qty
	           ,SalesAmt
	           ,InUser
	           ,InDate
	           ,EditUser
	           ,EditDate
               ,ItemType
               ,CompanyCode
               ,StoreCompanyCode
               ,PromotionDiscount
               
         )
         SELECT ReferenceSysNo = SONumber
	           ,ReferenceType = SettleType
	           ,SettlementSysNo = #SettlementSysNo#
	           ,ProductSysNo = ProductSysNo
	           ,Qty = Quantity
	           ,SalesAmt = OriginalPrice
	           ,InUser = #InUser#
	           ,InDate = getdate()
	           ,EditUser = #InUser#
	           ,EditDate = getdate()
               ,ItemType = ItemType
               ,CompanyCode = #CompanyCode#
               ,StoreCompanyCode  = #StoreCompanyCode#
               ,PromotionDiscount=PromotionDiscount
         FROM
         (
         SELECT
             SONumber
            ,SettleType
            ,ProductSysNo
            ,Quantity
            ,OriginalPrice
            ,ItemType = 'PRD'
            ,PromotionDiscount
         FROM
           (
                SELECT
         InvoiceNumber  --单据编号
				,OrderDate      --创建日期
				,WarehouseNumber --仓库
				,VendorSysno
				,ProductSysNo
				,OriginalPrice --销售价格
				,Quantity     --数量
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,TransactionNumber
				,SONumber
				,Point
        ,PromotionDiscount
        FROM
        (
        	SELECT
				 InvoiceNumber  --单据编号
				,OrderDate      --创建日期
				,WarehouseNumber --仓库
				,VendorSysno
				,ProductSysNo
				,OriginalPrice = round( OriginalPrice,2)--销售价格
				,Quantity     --数量
        ,TransactionNumber
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,SONumber
				,Point
        ,PromotionDiscount
			  FROM
			  (
					  SELECT
						 main.InvoiceNumber   --单据编号
						,main.OrderDate       --创建日期
						,main.WarehouseNumber --仓库
						,VendorSysno = ship.MerchantSysNo
						,trans.ProductSysNo
						,(trans.OriginalPrice   - (isnull(trans.Point,0)/10.00) + isnull(trans.DiscountAmt,0.00)/trans.Quantity) AS  OriginalPrice --销售价格
						,trans.Quantity     --数量
						,trans.TransactionNumber
						,vendor.VendorName  --供应商
						,product.ProductID  --商品编号
						,product.ProductName --商品名称
						,stock.StockName --
						,SettleType = 'SO'
						,main.SONumber
						,Point = null
            ,trans.PromotionDiscount
					  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber  and trans.ItemType <>4
					  ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
            INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					  ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
					  left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD' AND it.ItemType ='PRD'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'

           #StrWhere#

            UNION ALL

					  SELECT
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = register.LocationWarehouse
						,VendorSysno = ship.MerchantSysNo
						,register.ProductSysNo
						,(refundItem.OrgPrice + isnull(refundItem.UnitDiscount,0.00) - (isnull(refundItem.OrgPoint,0)/10.00))  AS OriginalPrice
						,Quantity = -1
						,TransactionNumber = NULL
						,VendorName = NULL
						,Product.ProductID
						,product.ProductName
						,StockName = NULL
						,SettleType='RMA'
						,main.SysNo AS SONumber
						,Point = null
            ,PromotionDiscount = NULL
					FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
          INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
          left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD' AND it.ItemType ='PRD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'

                #StrWhere#

         ) b

      )  a
         ) g  WHERE  SONumber in (#SONumber#)
    )k

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleGather" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

          Update OverseaPOASNManagement.dbo.CollectionSettlement
	        Set   MerchantSysNo = @MerchantSysNo
	              ,StockSysNo = @StockSysNo
	              ,TotalAmt   = isnull( ( SELECT sum( (Qty * SalesAmt)+ISNULL(PromotionDiscount,0))
                              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item WITH(nolock)
                              WHERE SettlementSysNo = @SysNo ),0)
	              ,EditUser   = @EditUser
	              ,EditDate   = @EditDate
          WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@MerchantSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@EditUser" dbType="String" />
      <param name="@EditDate" dbType="DateTime" />
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSettleGatherItemsBySettleSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          Select
           SysNo        AS [ItemSysNo]
          ,SettlementSysNo  AS SettleSysNo
          ,ReferenceSysNo      AS SONumber
	        ,ReferenceType    AS SettleType
	        ,ProductSysNo AS ProductSysNo
	        ,Qty          AS ProductQuantity
	        ,SalesAmt     AS SalePrice
	        ,InUser
	        ,InDate
	        ,EditUser
	        ,EditDate
      FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item WITH(NOLOCK)
      WHERE SettlementSysNo = @SettleSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetCheckSettleGatherItemsBySettleSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          Select
           SysNo        AS ItemSysNo
          ,SettlementSysNo  AS SettleSysNo
          ,ReferenceSysNo      AS OrderSysNo
	        ,ReferenceType    AS SettleType
          ,ReferenceType AS DisplaySettleType
	        ,ProductSysNo AS ProductSysNo
	        ,Qty          AS ProductQuantity
	        ,SalesAmt     AS SalePrice
	        ,InUser
	        ,InDate
	        ,EditUser
	        ,EditDate
      FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item WITH(NOLOCK)
      WHERE SettlementSysNo = @SettleSysNo  @WHERESTRING
      ]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSettleGatherEntityBySettleSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       SELECT     SysNo
                 ,Status as [SettleStatus]
                 ,TotalAmt
                 ,InUser
       FROM     OverseaPOASNManagement.dbo.CollectionSettlement
       WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleGatherSettleStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       Update OverseaPOASNManagement.dbo.CollectionSettlement
       Set Status = @Status
           ,SettleUser = @SettleUser
           ,SettleDate = @SettleDate
       WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="String" />
      <param name="@SettleUser" dbType="String" />
      <param name="@SettleDate" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="DeleteVendorSettleGatherItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       Delete FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item
       WHERE ReferenceSysNo =@ReferenceSysNo AND ReferenceType=@ReferenceType AND SettlementSysNo = @SettlementSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ReferenceSysNo" dbType="Int32" />
      <param name="@ReferenceType" dbType="String" />
      <param name="@SettlementSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleGatherStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       Update OverseaPOASNManagement.dbo.CollectionSettlement
       Set Status = @Status
           ,AuditUser = @AuditUser
           ,AuditDate = @AuditDate
           ,SettleUser = @SettleUser
           ,SettleDate = @SettleDate
       WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="String" />
      <param name="@AuditUser" dbType="String" />
      <param name="@SettleUser" dbType="String" />
      <param name="@AuditDate" dbType="DateTime" />
      <param name="@SettleDate" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateVendorSettleGatherStatusNoUpdateTime" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       Update OverseaPOASNManagement.dbo.CollectionSettlement
       Set Status = @Status
       WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryConsignSettleGatherItemsNoPage" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

        SELECT
         InvoiceNumber  --单据编号
				,OrderDate  as [CreateDate]    --创建日期
				,WarehouseNumber as [StockSysNo] --仓库
				,VendorSysno
				,ProductSysNo
				,SalePrice = round(OriginalPrice,2)  --销售价格
        ,PromotionDiscount --优惠券金额
				,Quantity as [ProductQuantity]     --数量
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,TransactionNumber
				,SONumber as [OrderSysNo]
				,Point
        FROM
        (
        	SELECT
				 InvoiceNumber  --单据编号
				,OrderDate      --创建日期
				,WarehouseNumber --仓库
				,VendorSysno
				,ProductSysNo
				,OriginalPrice --销售价格
        ,PromotionDiscount --优惠券金额
				,Quantity     --数量
                ,TransactionNumber
				,VendorName  --供应商
				,ProductID  --商品编号
				,ProductName --商品名称
				,StockName --
				,SettleType
				,SONumber
				,Point
			  FROM
			  (
					  SELECT
						 main.InvoiceNumber   --单据编号
						,main.OrderDate       --创建日期
						,main.WarehouseNumber --仓库
						,VendorSysno = ship.MerchantSysNo
						,trans.ProductSysNo
						,(trans.OriginalPrice   - (isnull(trans.Point,0)/10.00) + isnull(trans.DiscountAmt,0.00)/trans.Quantity) AS  OriginalPrice --销售价格
            ,ISNULL(trans.PromotionDiscount,0) as PromotionDiscount--优惠券金额
						,trans.Quantity     --数量
						,trans.TransactionNumber
						,vendor.VendorName  --供应商
						,product.ProductID  --商品编号
						,product.ProductName --商品名称
						,stock.StockName --
						,SettleType = 'SO'
						,main.SONumber
						,Point = null
					  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber  and trans.ItemType <>4
					 ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
            INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					  ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
					  left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'

           #StrWhere#

            UNION ALL

					  SELECT
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = register.LocationWarehouse
						,VendorSysno = ship.MerchantSysNo
						,register.ProductSysNo
						,(refundItem.OrgPrice + isnull(refundItem.UnitDiscount,0.00) - (isnull(refundItem.OrgPoint,0)/10.00))  AS OriginalPrice
            ,PromotionDiscount=NULL
						,Quantity = -1
						,TransactionNumber = NULL
						,VendorName = NULL
						,Product.ProductID
						,product.ProductName
						,StockName = NULL
						,SettleType='RMA'
						,main.SysNo AS SONumber
						,Point = null
					FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
          INNER JOIN IPP3.dbo.Vendor_Ex vendorex WITH(NOLOCK)
					ON vendorex.VendorSysNo = ship.MerchantSysNo AND vendorex.StockType='MET' AND vendorex.InvoiceType='MET'
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
          left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'

                #StrWhere#

         ) b

      )  a

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="InsertConsignSettleGatherALLShippingCharge" database="NCService"  commandType="Text">
    <commandText>
      <![CDATA[
        INSERT INTO OverseaPOASNManagement.dbo.CollectionSettlement_Item
         (
         	    ReferenceSysNo
	           ,ReferenceType
	           ,SettlementSysNo
	           ,ProductSysNo
	           ,Qty
	           ,SalesAmt
	           ,InUser
	           ,InDate
	           ,EditUser
	           ,EditDate
               ,ItemType
               ,CompanyCode
               ,StoreCompanyCode
         )
         SELECT ReferenceSysNo = SONumber
	           ,ReferenceType = SettleType
	           ,SettlementSysNo = #SettlementSysNo#
	           ,ProductSysNo = ProductSysNo
	           ,Qty = Quantity
	           ,SalesAmt = OriginalPrice
	           ,InUser = #InUser#
	           ,InDate = getdate()
	           ,EditUser = #InUser#
	           ,EditDate = getdate()
               ,ItemType = ItemType
               ,CompanyCode = #CompanyCode#
               ,StoreCompanyCode  = #StoreCompanyCode#
         FROM
         (
         SELECT
             SONumber
            ,SettleType
            ,ProductSysNo
            ,Quantity
            ,OriginalPrice
            ,ItemType = 'SHP'
         FROM
           (
                SELECT  DISTINCT
						 main.InvoiceNumber  --单据编号
						,main.OrderDate      --创建日期
						,main.WarehouseNumber --仓库
						,VendorSysno = NULL
						,ProductSysNo = 0
						,OriginalPrice = round( isnull( so.ShippingCharge,0.0),2) --销售价格
						,Quantity = 1     --数量
						,TransactionNumber = 0
						,VendorName = NULL   --供应商
						,ProductID = NULL   --商品编号
						,ProductName = 'SO运费' --商品名称
						,StockName = NULL
						,SettleType = 'SO'
						,main.SONumber
						,Point = NULL
					  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceMaster  main WITH(NOLOCK)
					  INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_InvoiceTransaction trans WITH(NOLOCK)
					  ON main.InvoiceNumber = trans.InvoiceNumber
            ##OrderDate1##
            INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
					  ON product.SysNo = trans.ProductSysNo
					  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
					  ON stock.SysNo = main.WarehouseNumber
					  INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					  ON so.SOSysNo  =  main.SONumber
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					  ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					  INNER JOIN ipp3.dbo.Vendor vendor WITH(NOLOCK)
					  ON vendor.SysNo = ship.MerchantSysNo
					  INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					  ON category.Category3Sysno =product.C3SysNo
					  INNER JOIN IPP3.dbo.Vendor_Ex vex WITH(NOLOCK)
					  ON vex.VendorSysNo = ship.MerchantSysNo AND vex.StockType='MET' AND vex.ShippingType='MET' AND vex.InvoiceType = 'MET'
					  left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD' AND it.ItemType ='SHP'
            ) s on s.ReferenceSysNo = main.SONumber and s.ReferenceType = 'SO'

            #StrWhere#

            UNION ALL

					  SELECT DISTINCT
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = register.LocationWarehouse
						,VendorSysno = NULL
						,ProductSysNo = -1
						,(round( isnull(so.ShippingCharge,0.00),2))  AS OriginalPrice
						,Quantity = -1
						,TransactionNumber = NULL
						,VendorName = NULL
						,ProductID = NULL
						,ProductName = 'RMA三费'
						,StockName = NULL
						,SettleType='RMA'
						,main.SysNo AS SONumber
						,Point = null
					FROM  OverseaServiceManagement.dbo.V_SM_RMARefundMaster main WITH(NOLOCK)
					INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARefundTransaction refundItem WITH(NOLOCK)
					ON refundItem.RefundSysNo = main.SysNo  AND main.Status = 2
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister register WITH(NOLOCK)
					ON register.SysNo = refundItem.RegisterSysNo
          ##OrderDate2##
					INNER JOIN OverseaContentManagement.dbo.V_IM_Product Product WITH(NOLOCK)
					ON Product.SysNo = register.ProductSysNo
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK)
					ON so.SOSysNo  =  main.SOSysNo
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category WITH(NOLOCK)
					ON category.Category3Sysno =product.C3SysNo
					INNER JOIN IPP3.dbo.Vendor_Ex vex WITH(NOLOCK)
					ON vex.VendorSysNo = ship.MerchantSysNo AND vex.StockType='MET' AND vex.ShippingType='MET' AND vex.InvoiceType = 'MET'
          left join
            (
              SELECT DISTINCT
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD' AND it.ItemType ='SHP'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RMA'

          #StrWhere#
         ) g  WHERE  SONumber in (#SONumber#)
    )k

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetGatherSettlementSysNoListByVendorSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT SysNo FROM OverseaPOASNManagement.dbo.CollectionSettlement WITH (NOLOCK)
WHERE MerchantSysNo = @VendorSysNo
	        ]]>
    </commandText>
    <parameters>
      <param name="@VendorSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryConsignSettleGatherRO_Adjust" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					  SELECT DISTINCT 
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = CAST(so.WareHouseNumber AS int)
						,VendorSysno = ship.MerchantSysNo
						,ProductSysNo = -1  
						,ISNULL(main.CashAmt,0)  AS OriginalPrice
            ,ISNULL(main.CashAmt,0)  AS SalePrice
						,Quantity = -1
            ,ProductQuantity=-1
						,TransactionNumber = NULL
						,VendorName = vendor.VendorName
						,ProductID = NULL 
						,ProductName = 'RO_Adjust补偿退款'
						,StockName = NULL
						,SettleType='RO_Adjust'
						,main.SysNo as OrderSysNo
						,Point = null  
					FROM OverseaCustomerManagement.dbo.V_CM_RO_Adjust main WITH(NOLOCK)
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo AND main.Status = 4
          ##OrderDate3##
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN IPP3.dbo.Vendor vendor WITH(NOLOCK) 
					ON vendor.SysNo = ship.MerchantSysNo 
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RO_Adjust'
          
          #StrWhere#
			]]>
    </commandText>
  </dataCommand>
  
  
  
  
  <dataCommand name="InsertConsignSettleGatherRO_Adjust" database="NCService"  commandType="Text">
    <commandText>
      <![CDATA[
        INSERT INTO OverseaPOASNManagement.dbo.CollectionSettlement_Item
         (
         	    ReferenceSysNo 
	           ,ReferenceType 
	           ,SettlementSysNo
	           ,ProductSysNo 
	           ,Qty 
	           ,SalesAmt 
	           ,InUser 
	           ,InDate 
	           ,EditUser
	           ,EditDate 
               ,ItemType 
               ,CompanyCode 
               ,StoreCompanyCode  
         )
         SELECT ReferenceSysNo = SONumber
	           ,ReferenceType = SettleType
	           ,SettlementSysNo = #SettlementSysNo#
	           ,ProductSysNo = ProductSysNo
	           ,Qty = Quantity
	           ,SalesAmt = OriginalPrice
	           ,InUser = #InUser#
	           ,InDate = getdate()
	           ,EditUser = #InUser#
	           ,EditDate = getdate()
               ,ItemType = ItemType
               ,CompanyCode = #CompanyCode#
               ,StoreCompanyCode  = #StoreCompanyCode#
         FROM 
         (  
         SELECT  
             SONumber
            ,SettleType
            ,ProductSysNo
            ,Quantity
            ,OriginalPrice
            ,ItemType = 'ROA'
         FROM 
           (              
					  SELECT DISTINCT 
						 main.SysNo AS InvoiceNumber
						,OrderDate = main.CreateTime
						,WarehouseNumber = so.WareHouseNumber
						,VendorSysno = NULL 
						,ProductSysNo = -1  
						,ISNULL(main.CashAmt,0)  AS OriginalPrice
						,Quantity = -1
						,TransactionNumber = NULL
						,VendorName = vendor.VendorName
						,ProductID = NULL 
						,ProductName = 'RO_Adjust补偿退款'
						,StockName = NULL
						,SettleType='RO_Adjust'
						,main.SysNo AS SONumber
						,Point = null  
					FROM OverseaCustomerManagement.dbo.V_CM_RO_Adjust main WITH(NOLOCK)
					INNER  JOIN OverseaOrderManagement.dbo.V_OM_Sub_SO_Master  so WITH(NOLOCK) 
					ON so.SOSysNo  =  main.SOSysNo AND main.Status = 4					
          ##OrderDate3##
					INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping ship WITH(NOLOCK)
					ON ship.SOSysNo = so.SOSysNo AND ship.MerchantSysNo <> 1
					INNER JOIN IPP3.dbo.Vendor vendor WITH(NOLOCK) 
					ON vendor.SysNo = ship.MerchantSysNo
          left join 
            (
              SELECT DISTINCT 
                     it.ReferenceSysNo
                     ,it.ReferenceType
              FROM OverseaPOASNManagement.dbo.CollectionSettlement_Item it WITH(nolock)
              INNER JOIN  OverseaPOASNManagement.dbo.CollectionSettlement coll WITH(NOLOCK)
              ON coll.SysNo = it.SettlementSysNo
              WHERE coll.Status <>'ABD' AND it.ItemType ='ROA'
            ) s on s.ReferenceSysNo = main.SysNo and s.ReferenceType = 'RO_Adjust'
          
          #StrWhere#
         ) g  WHERE  SONumber in (#SONumber#)
    )k


			]]>
    </commandText>
  </dataCommand>


  <dataCommand name="QuerySettleList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT @TotalCount = COUNT(SysNo)
                FROM (select *,CONVERT(varchar(100), CreateTime, 23) as CreateTimeDay
	         ,CONVERT(varchar(100), AuditTime, 23) as AuditTimeDay from [IPP3].[dbo].[PO_Settle]  WITH(NOLOCK)) t
        #StrWhere#

        SELECT  *
        ,'0.00' as RateAmount
        ,'0.00' as RateTotal
        ,'0.00' as RateAmountOther
        ,'0.00' as RateCost13
        ,'0.00' as RateCost17
        ,'0.00' as Cost17
        ,'0.00' as Cost13
        ,'0.00' as CostOther
        FROM
        (
	          SELECT TOP (@EndNumber)
                   *
	            ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
	                 FROM (select *,CONVERT(varchar(100), CreateTime, 23) as CreateTimeDay
	         ,CONVERT(varchar(100), AuditTime, 23) as AuditTimeDay from [IPP3].[dbo].[PO_Settle]  WITH(NOLOCK)) t
	          #StrWhere#
        )RESULT where RowNumber > @StartNumber

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSettleItemList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT  [SysNo]
      ,[SettleSysNo]
      ,[TaxRate]
      ,[PayAmt]
      ,[CompanyCode]
  FROM [IPP3].[dbo].[PO_Settle_Item]
  where SettleSysNo=@SettleSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SettleSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
</dataOperations>
