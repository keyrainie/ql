<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <dataCommand name="QueryPOList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     IF OBJECT_ID(N'tempdb..#SearchPO') IS NOT NULL
 DROP TABLE #SearchPO
;
SELECT
 po.sysno
,po.poid
,po.createtime
,po.audittime
,po.intime
,po.status
,po.etp
,po.ComfirmTime
,po.PrintTime PrintTime
,po.HasSendMail
,po.MailAddress
,po.StockSysNo
,po.ITStockSysNo
,po.PM_ReturnPointSysNo
,po.Source
,po.CloseUser
,po.CloseTime
,po.ContractNumber
,po.ApportionTime
,po.createusersysno
,po.auditusersysno
,po.vendorsysno
,po.ApportionUserSysNo
,po.inusersysno
,po.ComfirmUserSysNo
,po.TPStatus
,po.PaySettleCompany
,po.ETATime
,po.LogisticsNumber
,po.ExpressName
INTO #SearchPO
FROM IPP3.dbo.po_master po WITH(NOLOCK)
#StrWhere# replaceSQL1

 SELECT @TotalCount = COUNT(1)
        FROM #SearchPO
          po WITH(NOLOCK)
	        INNER JOIN IPP3.dbo.Vendor WITH(NOLOCK)
				    ON po.vendorsysno =  IPP3.dbo.Vendor.sysno
	        INNER JOIN  OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK)
				    ON po.stocksysno = stock.sysno
	        LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_audit WITH(NOLOCK)
				    ON po.auditusersysno = con_audit.UserSysNo
            LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_apport WITH(NOLOCK)
				    ON po.ApportionUserSysNo = con_apport.UserSysNo
            replaceSQL2
            
        SELECT
          sysno
          ,poid
          ,VendorSysNo
          ,vendorname
          ,stockname
          ,ITStockName
          ,createname
          ,createtime
          , (CASE WHEN createtime IS NULL THEN '' ELSE  createname + '[' + CONVERT(varchar(100),createtime,120) + ']'  END) as CreateTimeAndUser
          ,auditname
          ,audittime
          , (CASE WHEN audittime IS NULL THEN '' ELSE  auditname + '[' + CONVERT(varchar(100),audittime,120) + ']'  END) as AuditTimeAndUser
          ,inname
          ,intime
          , (CASE WHEN intime IS NULL THEN '' ELSE  inname + '[' + CONVERT(varchar(100),intime,120) + ']'  END) as InTimeAndUser
          ,status
          ,etp
          ,ComfirmUserSysNo
          ,ComfirmTime
          ,ComfirmUser
          , (CASE WHEN ComfirmTime IS NULL THEN '' ELSE  ComfirmUser + '[' + CONVERT(varchar(100),ComfirmTime,120) + ']'  END) as ConfirmTimeAndUser
          ,PrintTime
          ,HasSendMail
          ,MailAddress
		      ,Email
		      ,StockSysNo
		      ,ITStockSysNo
          ,MaxTastDate
          ,PreEimsCount
          ,QtyEimsCount
          ,PreCount
          ,QtyCount
          ,AllPurchaseQty
          ,AllQuantity
		      ,EIMSNo
		      ,EIMSAmt
          ,UsedEIMSAmt
          ,Source
          ,CloseUser
          ,CloseTime
          , (CASE WHEN CloseTime IS NULL THEN '' ELSE  CloseUser + '[' + CONVERT(varchar(100),CloseTime,120) + ']'  END) as CloseTimeAndUser
          ,ContractNumber
          ,ApportionTime
          ,ApportionUserName
          , (CASE WHEN ApportionTime IS NULL THEN '' ELSE  ApportionUserName + '[' + CONVERT(varchar(100),ApportionTime,120) + ']'  END) as ApportionTimeAndUser
          ,EIMSNoList
          ,PaySettleCompany
          ,ETATime
          ,LogisticsNumber
          ,ExpressName
        FROM
        (
	          select TOP (@EndNumber)
	             po.sysno
	            ,po.poid
              ,vendor.SysNo as VendorSysNo
	            ,vendor.vendorname
	            ,(SELECT TOP (1) stock.stockname FROM OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK) WHERE po.stocksysno = stock.sysno) AS stockname
              ,(SELECT TOP (1) stock.stockname FROM OverseaInventoryManagement.dbo.V_INM_Stock stock WITH(NOLOCK) WHERE po.ITStockSysNo = stock.sysno) AS ITStockName
	            ,con_create.DisplayName as createname
	            ,po.createtime
	            ,con_audit.DisplayName as auditname
	            ,po.audittime
	            ,con_in.DisplayName as inname
	            ,po.intime
	            ,po.status
	            ,po.etp
	            ,po.ComfirmUserSysNo
	            ,po.ComfirmTime
	            ,com_user.DisplayName as ComfirmUser
	            ,po.PrintTime PrintTime
              ,po.HasSendMail
              ,po.MailAddress
			        ,vendor.Email
			        ,po.StockSysNo
			        ,po.ITStockSysNo
              ,a.MaxTastDate
              ,pocount.PreEimsCount
              ,pocount.QtyEimsCount
              ,pocount.PreCount
              ,pocount.QtyCount
              ,pocount.AllPurchaseQty
              ,pocount.AllQuantity
			        ,po.PM_ReturnPointSysNo AS EIMSNo
			        --,UsingReturnPoint AS EIMSAmt
				      ,po.Source
				      ,po.CloseUser
				      ,po.CloseTime
				      ,po.ContractNumber
				      ,po.ApportionTime
				      ,po.ApportionUserSysNo
              ,con_apport.DisplayName AS ApportionUserName
              ,EIMSAmt = (
                SELECT ISNULL( SUM(EIMSAmt),0.00)
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
              ),
              UsedEIMSAmt = (
                SELECT ISNULL( SUM(EIMSAmt),0.00)
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfoDetail WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
              )
              ,EIMSNoList = (
                SELECT ISNULL(CAST(EIMSNo AS VARCHAR)+',','')
                FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
                WHERE POSysNo = po.SysNo
                FOR XML PATH(''))
              ,po.PaySettleCompany
              ,po.ETATime
              ,po.LogisticsNumber
              ,po.ExpressName
	            ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
	          FROM #SearchPO po WITH(NOLOCK)
	          INNER JOIN  IPP3.dbo.Vendor vendor WITH(NOLOCK)
				      ON po.vendorsysno =  vendor.sysno
	          LEFT JOIN  OverseaArchitecture.dbo.V_AR_UserInfo AS con_create WITH(NOLOCK)
				      ON po.createusersysno = con_create.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_audit WITH(NOLOCK)
				      ON po.auditusersysno = con_audit.UserSysNo
            LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_apport WITH(NOLOCK)
				      ON po.ApportionUserSysNo = con_apport.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS con_in WITH(NOLOCK)
				      ON po.inusersysno = con_in.UserSysNo
	          LEFT  JOIN OverseaArchitecture.dbo.V_AR_UserInfo AS com_user WITH(NOLOCK)
				      ON po.ComfirmUserSysNo = com_user.UserSysNo
	          LEFT  JOIN
	          (   SELECT Purno,MAX(recdate) AS MaxTastDate
                  FROM scm.dbo.poLog WITH (nolock)
                  GROUP BY Purno
               )a ON po.SysNo = a.Purno
            LEFT OUTER JOIN
            (
              SELECT POSysNo
                    , SUM(CASE AcquireReturnPointType WHEN 1 THEN round( PurchaseQty*OrderPrice*AcquireReturnPoint/100,2) WHEN 0 THEN PurchaseQty*AcquireReturnPoint  END  ) AS PreEimsCount
                    , SUM(CASE AcquireReturnPointType WHEN 1 THEN round( Quantity*OrderPrice*AcquireReturnPoint/100,2 ) WHEN 0 THEN Quantity*AcquireReturnPoint  END  ) AS QtyEimsCount
                    , SUM(PurchaseQty*OrderPrice) AS PreCount
                    , SUM(Quantity*OrderPrice) AS QtyCount
                    ,SUM(PurchaseQty) AS AllPurchaseQty
                    , SUM(Quantity)  AS AllQuantity
              FROM IPP3.dbo.PO_Item
              GROUP BY POSysNo
            ) pocount ON pocount.POSysNo = po.sysno
            replaceSQL3
        )RESULT WHERE RowNumber > @StartNumber ORDER BY RESULT.RowNumber
			]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>

  <dataCommand name="POhistory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(po_master.SysNo) 
		  FROM IPP3.dbo.po_master po_master WITH(NOLOCK) 
		  INNER JOIN IPP3.dbo.PO_Item po_Item WITH(NOLOCK) 
		  ON po_master.sysno = po_Item.posysno
		  INNER JOIN IPP3.dbo.Vendor vendor WITH(NOLOCK) 
		  ON po_master.vendorsysno =  vendor.sysno
		  INNER JOIN Scm.dbo.POReceivedDetail b WITH (nolock)
		  ON po_master.SysNo = b.Purno AND b.Item = po_Item.ProductID
	 #StrWhere#
              
      SELECT
      [SysNo]
      ,poid
      ,VendorSysNo
      ,vendorName
      ,Quantity
      ,OrderPrice
      ,UnitCost
      ,InTime
      ,RowNumber
      ,BatchNumber
      ,CONVERT(VARCHAR(200),[SysNo]) + '-' + CONVERT(VARCHAR(200), BatchNumber) as SysNoAndBatchNo
      ,ReceivedDate
      FROM
      (
       SELECT TOP (@EndNumber) 
	          po_master.SysNo
	        , po_master.poid
	        , vendor.sysno as VendorSysNo
	        , vendor.vendorName
	        , b.ReceivedQuantity AS Quantity
	        , po_Item.OrderPrice
	        , po_Item.UnitCost
	        , po_master.InTime 
            , b.BatchNumber
	        , b.ReceivedDate
	        ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
          FROM IPP3.dbo.po_master po_master WITH(NOLOCK) 
          INNER JOIN IPP3.dbo.PO_Item po_Item WITH(NOLOCK) 
		  ON po_master.sysno = po_Item.posysno
          INNER JOIN  IPP3.dbo.Vendor vendor WITH(NOLOCK) 
		  ON po_master.vendorsysno = vendor.sysno
          INNER  JOIN Scm.dbo.POReceivedDetail b WITH (nolock) 
		  ON po_master.SysNo = b.Purno AND b.Item = po_Item.ProductID
       #StrWhere#
     )RESULT where RowNumber > @StartNumber
     
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="CreatePOSequence" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	     INSERT INTO ipp3.dbo.PO_Sequence
	      (
          createtime
	      )
	      VALUES(
	        getdate()
	      )
        SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="CreatePOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	      INSERT INTO ipp3.dbo.PO_Master
        (
        SysNo
        ,POID
        ,VendorSysNo
        ,StockSysNo
        ,ShipTypeSysNo
        ,PayTypeSysNo
        ,CurrencySysNo
        ,ExchangeRate
        ,TotalAmt
        ,CreateTime
        ,CreateUserSysNo
        ,AuditTime
        ,AuditUserSysNo
        ,InTime
        ,InUserSysNo
        ,IsApportion
        ,ApportionTime
        ,ApportionUserSysNo
        ,Memo
        ,Note
        ,Status
        ,ETP
        ,IsConsign
        ,POType
        ,PM_ReturnPointSysNo
        ,UsingReturnPoint
        ,ReturnPointC3SysNo
        ,TaxRate
        ,PurchaseStockSysno
        ,PMSysNo
        ,PaySettleCompany
        ,CompanyCode
		,ETATime
		,ETAHalfDay
		,PMRequestMemo
		,TLRequestMemo
		,ITStockSysNo
    ,ContractNumber
    ,AutoSendMail
    ,ProductLineSysNo
    ,LeaseFlag
    ,LogisticsNumber
    ,ExpressName
        )
        VALUES
        (
        @SysNo
        ,@POID
        ,@VendorSysNo
        ,@StockSysNo
        ,@ShipTypeSysNo
        ,@PayTypeSysNo
        ,@CurrencySysNo
        ,@ExchangeRate
        ,@TotalAmt
        ,@CreateTime
        ,@CreateUserSysNo
        ,@AuditTime
        ,@AuditUserSysNo
        ,@InTime
        ,@InUserSysNo
        ,@IsApportion
        ,@ApportionTime
        ,@ApportionUserSysNo
        ,@Memo
        ,@Note
        ,@Status
        ,@ETP
        ,@IsConsign
        ,@POType
        ,@PM_ReturnPointSysNo
        ,@UsingReturnPoint
        ,@ReturnPointC3SysNo
        ,@TaxRate
        ,@PurchaseStockSysno
        ,@PMSysNo
        ,@PaySettleCompany
        ,@CompanyCode
		,@ETATime
		,@ETAHalfDay
		,@PMRequestMemo
		,@TLRequestMemo
		,@ITStockSysNo
    ,@ContractNumber
    ,@AutoSendMail
    ,@ProductLineSysNo
    ,@LeaseFlag
    ,@LogisticsNumber
    ,@ExpressName
        )
			]]>
    </commandText>
    <parameters>
      <param name="@ContractNumber" dbType="String" />
      <param name="@SysNo" dbType="Int32" />
      <param name="@POID" dbType="String" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@ShipTypeSysNo" dbType="Int32" />
      <param name="@PayTypeSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@ExchangeRate" dbType="Decimal" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@CreateUserSysNo" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@InTime" dbType="DateTime" />
      <param name="@InUserSysNo" dbType="Int32" />
      <param name="@IsApportion" dbType="Int32" />
      <param name="@ApportionTime" dbType="DateTime" />
      <param name="@ApportionUserSysNo" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@IsConsign" dbType="Int32" />
      <param name="@POType" dbType="Int32" />
      <param name="@PM_ReturnPointSysNo" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@ReturnPointC3SysNo" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />
      <param name="@PurchaseStockSysno" dbType="Int32" />
      <param name="@PMSysNo" dbType="Int32" />
      <param name="@PaySettleCompany" dbType="Int32" />
      <param name="@CompanyCode" dbType="Int32" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="String" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@ITStockSysNo" dbType="Int32" />
      <param name="@AutoSendMail" dbType="String" />
      <param name="@ProductLineSysNo" dbType="Int32" />
      <param name="@LeaseFlag" dbType="Int32" />
      <param name="@LogisticsNumber" dbType="String" />
      <param name="@ExpressName" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOItems4PartPO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    INSERT INTO ipp3.dbo.PO_Item
			  (
			  POSysNo
			  ,ProductSysNo
			  ,BriefName
			  ,Quantity
			  ,Weight
			  ,OrderPrice
			  ,ApportionAddOn
			  ,UnitCost
			  ,ReturnCost
			  ,PurchaseQty
			  ,CheckStatus
			  ,CheckReasonMemo
			  ,lastOrderPrice
			  ,ExecptStatus
			  ,ProductID
			  ,UnitCostWithoutTax
			  ,JDPrice
			  ,AvailableQty
			  ,m1
			  ,CompanyCode
			  ,CurrencySysNo
			  ,LastAdjustPriceDate
			  ,LastInTime
        ,AcquireReturnPointType
        ,AcquireReturnPoint
        ,ReadyQuantity
        ,BatchInfo
			  )
      VALUES (
			  @POSysNo
			  ,@ProductSysNo
			  ,@BriefName
			  ,@Quantity
			  ,@Weight
			  ,@OrderPrice
			  ,@ApportionAddOn
			  ,@UnitCost
			  ,@ReturnCost
			  ,@PurchaseQty
			  ,-1
			  ,''
			  ,@lastOrderPrice
			  ,@ExecptStatus
			  ,@ProductID
			  ,@UnitCostWithoutTax
			  ,@JDPrice
			  ,@AvailableQty
			  ,@m1
			  ,@CompanyCode
			  ,@CurrencySysNo
			  ,@LastAdjustPriceDate
			  ,@LastInTime
        ,@AcquireReturnPointType
        ,@AcquireReturnPoint
        ,@ReadyQuantity
        ,@BatchInfo
			  )
      SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@BriefName" dbType="String" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@Weight" dbType="Int32" />
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@ApportionAddOn" dbType="Decimal" />
      <param name="@UnitCost" dbType="Decimal" />
      <param name="@ReturnCost" dbType="Decimal" />
      <param name="@lastOrderPrice" dbType="Decimal" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@ProductID" dbType="String" />
      <param name="@UnitCostWithoutTax" dbType="Decimal" />
      <param name="@JDPrice" dbType="Decimal" />
      <param name="@AvailableQty" dbType="Int32" />
      <param name="@m1" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@LastAdjustPriceDate" dbType="DateTime" />
      <param name="@LastInTime" dbType="DateTime" />
      <param name="@AcquireReturnPointType" dbType="Int32" />
      <param name="@AcquireReturnPoint" dbType="Decimal" />
      <param name="@ReadyQuantity" dbType="Int32" />
      <param name="@BatchInfo" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    INSERT INTO IPP3.dbo.PO_Item
				  (
				  POSysNo
				  ,ProductSysNo
				  ,BriefName
				  ,Quantity
				  ,Weight
				  ,OrderPrice
				  ,ApportionAddOn
				  ,UnitCost
				  ,ReturnCost
				  ,PurchaseQty
				  ,CheckStatus
				  ,CheckReasonMemo
				  ,lastOrderPrice
				  ,ExecptStatus
				  ,ProductID
				  ,UnitCostWithoutTax
				  ,JDPrice
				  ,AvailableQty
				  ,m1
				  ,CompanyCode
				  ,CurrencySysNo
          ,AcquireReturnPointType
          ,AcquireReturnPoint
          ,ReadyQuantity
          ,BatchInfo
				  )
      VALUES (
			  @POSysNo
			  ,@ProductSysNo
			  ,@BriefName
			  ,@Quantity
			  ,@Weight
			  ,@OrderPrice
			  ,@ApportionAddOn
			  ,@UnitCost
			  ,@ReturnCost
			  ,@PurchaseQty
			  ,-1
			  ,''
			  ,@lastOrderPrice
			  ,@ExecptStatus
			  ,@ProductID
			  ,@UnitCostWithoutTax
			  ,@JDPrice
			  ,@AvailableQty
			  ,@m1
			  ,@CompanyCode
			  ,@CurrencySysNo
        ,@AcquireReturnPointType
        ,@AcquireReturnPoint
        ,@ReadyQuantity
        ,@BatchInfo
			  )
      SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@BriefName" dbType="String" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@Weight" dbType="Int32" />
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@ApportionAddOn" dbType="Decimal" />
      <param name="@UnitCost" dbType="Decimal" />
      <param name="@ReturnCost" dbType="Decimal" />
      <param name="@lastOrderPrice" dbType="Decimal" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@ProductID" dbType="String" />
      <param name="@UnitCostWithoutTax" dbType="Decimal" />
      <param name="@JDPrice" dbType="Decimal" />
      <param name="@AvailableQty" dbType="Int32" />
      <param name="@m1" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@AcquireReturnPointType" dbType="Int32" />
      <param name="@AcquireReturnPoint" dbType="Decimal" />
      <param name="@ReadyQuantity" dbType="Int32" />
      <param name="@BatchInfo" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	        SELECT
          po.[SysNo]
          ,po.[POID] as [PurchaseOrderBasicInfo.PurchaseOrderID]
          ,po.[VendorSysNo]  as [VendorInfo.SysNo]
          ,po.[PaySettleCompany]  as [VendorInfo.VendorBasicInfo.PaySettleCompany]
          ,po.[StockSysNo] as  [PurchaseOrderBasicInfo.StockInfo.SysNo]
          ,po.[ShipTypeSysNo] as [PurchaseOrderBasicInfo.ShippingType.SysNo]
          ,po.[PayTypeSysNo] as [PurchaseOrderBasicInfo.PayType.SysNo]
          ,po.[CurrencySysNo] as [PurchaseOrderBasicInfo.CurrencyCode]
          ,po.[ExchangeRate] as [PurchaseOrderBasicInfo.ExchangeRate]
          ,po.[TotalAmt] as [PurchaseOrderBasicInfo.TotalAmt]
          ,po.[CreateTime] as [PurchaseOrderBasicInfo.CreateDate]
          ,po.[CreateUserSysNo] as [PurchaseOrderBasicInfo.CreateUserSysNo]
          ,po.[AuditTime] as [PurchaseOrderBasicInfo.AuditDate]
          ,po.[AuditUserSysNo] as [PurchaseOrderBasicInfo.AuditUserSysNo]
          ,po.[InTime] as [PurchaseOrderBasicInfo.InTime]
          ,po.[InUserSysNo] as [PurchaseOrderBasicInfo.InUserSysNo]
          ,po.[IsApportion] as [PurchaseOrderBasicInfo.IsApportion]
          ,po.[ApportionTime]
          ,po.[ApportionUserSysNo] as [PurchaseOrderBasicInfo.ApportionUserSysNo]
          ,po.[ETP] as [PurchaseOrderBasicInfo.ETP]
          ,po.[Memo] as [PurchaseOrderBasicInfo.MemoInfo.Memo]
          ,po.[Note] as [PurchaseOrderBasicInfo.MemoInfo.Note]
          ,po.[Status] as [PurchaseOrderBasicInfo.PurchaseOrderStatus]
          ,po.[IsConsign] as [PurchaseOrderBasicInfo.ConsignFlag]
          ,po.[POType] as [PurchaseOrderBasicInfo.PurchaseOrderType]
          ,po.[LeaseFlag] as [PurchaseOrderBasicInfo.PurchaseOrderLeaseFlag]
          ,po.[WHReceiptSN]
          ,po.[InStockMemo] as [PurchaseOrderBasicInfo.MemoInfo.InStockMemo]
          ,PMConfirmUser.DisplayName as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmUserName]
          --,po.[ComfirmUserSysNo] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[ComfirmTime] as [PurchaseOrderBasicInfo.MemoInfo.PMConfirmTime]
          ,po.[PartlyReceiveStatus]
          ,po.[CarriageCost]  as [PurchaseOrderBasicInfo.CarriageCost]
          ,po.[ExecptStatus] as [PurchaseOrderBasicInfo.PurchaseOrderExceptStatus]
          ,po.[CompanyCode]
          ,po.[PM_ReturnPointSysNo]  as [PurchaseOrderBasicInfo.PM_ReturnPointSysNo]
          ,po.[UsingReturnPoint]  as [PurchaseOrderBasicInfo.UsingReturnPoint]
          ,po.[ReturnPointC3SysNo] as [PurchaseOrderBasicInfo.ReturnPointC3SysNo]
          ,po.[TaxRate] as [PurchaseOrderBasicInfo.TaxRate]
          ,CONVERT(int ,po.[TaxRate] * 100)  as [PurchaseOrderBasicInfo.TaxRateType]
          ,po.[PurchaseStockSysno]  as [PurchaseOrderBasicInfo.PurchaseStockSysno]
          ,po.[PrintTime]
          ,po.[PMRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.PMRequestMemo]
          ,po.[TLRequestMemo] as [PurchaseOrderBasicInfo.MemoInfo.TLRequestMemo]
          ,po.[PMSysNo] [PurchaseOrderBasicInfo.ProductManager.SysNo]
          ,po.[SettlementCompany] as [PurchaseOrderBasicInfo.SettleCompanySysNo]
          ,po.ETATime as [PurchaseOrderBasicInfo.ETATimeInfo.ETATime]
          ,po.ETAHalfDay as [PurchaseOrderBasicInfo.ETATimeInfo.HalfDay]
          ,po.RefuseMemo as [PurchaseOrderBasicInfo.MemoInfo.RefuseMemo]
          ,po.ITStockSysNo as [PurchaseOrderBasicInfo.ITStockInfo.SysNo]
          ,po.ShiftSysNo as [PurchaseOrderBasicInfo.ShiftSysNo]
          ,po.CheckResult as [PurchaseOrderBasicInfo.CheckResult]
          ,po.Source as  [PurchaseOrderBasicInfo.Source]
          ,po.TPStatus as [PurchaseOrderBasicInfo.PurchaseOrderTPStatus]
          ,po.ContractNumber as [PurchaseOrderBasicInfo.ContractNumber]
          ,po.[AutoSendMail] as [PurchaseOrderBasicInfo.AutoSendMailAddress]
          ,po.[MailAddress] as [PurchaseOrderBasicInfo.MailAddress]
          ,Currency.CurrencySymbol as [PurchaseOrderBasicInfo.CurrencySymbol]
          ,Currency.CurrencyName as [PurchaseOrderBasicInfo.CurrencyName]
          ,Stock.StockName as [PurchaseOrderBasicInfo.StockInfo.StockName]
          ,Stock.ReceiveAddress
          ,Stock.ReceiveContact
          ,Stock.ReceiveContactPhone
          ,UserInfo.DisplayName as [PurchaseOrderBasicInfo.ProductManager.UserInfo.UserName]
          ,ShipType.ShipTypeName as [PurchaseOrderBasicInfo.ShippingType.ShippingTypeName]
          ,LocalCurrencySymbol=
          (
          SELECT TOP 1
          [CurrencySymbol]
          FROM [OverseaControlPanel].[dbo].[V_CP_Currency] WITH(nolock)
          WHERE IsLocal = 1
          )
          ,[PurchaseOrderBasicInfo.ARMCount]=
          (
          SELECT DISTINCT COUNT(1)
          FROM OverseaServiceManagement.dbo.V_SM_RMAOutboundMaster RMA_OutBound WITH(NOLOCK)
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMAOutboundTransaction RMA_OutBound_Item WITH (NOLOCK)
          on RMA_OutBound_Item.OutBoundSysNo = RMA_OutBound.SysNo
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister RMA_Register WITH (NOLOCK)
          on RMA_Register.SysNo = RMA_OutBound_Item.RegisterSysNo
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH (NOLOCK)
          on Product.SysNo = RMA_Register.ProductSysNo
          INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARequestTransaction] RMA_Request_Item WITH (NOLOCK)
          on RMA_Request_Item.RegisterSysNo = RMA_Register.Sysno
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster RMA_Request WITH(NOLOCK)
          on RMA_Request.SysNo = RMA_Request_Item.RequestSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master V_SO_Master WITH(NOLOCK)
          on V_SO_Master.SysNo = RMA_Request.SoSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item V_SO_Item WITH (NOLOCK)
          on (V_SO_Item.SOSysNo = V_SO_Master.SysNo and V_SO_Item.ProductSysNo = Product.SysNo)
          INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category3 WITH (NOLOCK)
          on product.Category3SysNo = category3.Category3Sysno
          LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sys_user WITH (NOLOCK)
          on Product.pmusersysno = sys_user.UserSysNo
          LEFT JOIN  IPP3.dbo.Vendor Vendor WITH (NOLOCK)
          on Vendor.SysNo=RMA_OutBound.VendorSysNo
          WHERE RMA_OutBound.VendorSysNo= po.[VendorSysNo]
          AND RMA_Register.ResponseDesc IS NOT NULL
          AND DateAdd(Day,15,RMA_OutBound.OutTime)<getdate()
          AND RMA_Register.Status=1
          AND RMA_Register.OutBoundStatus = 1
          )
          ,EIMSTotal=(
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfo WITH(NOLOCK)
            WHERE POSysNo=po.SysNo
          )
          ,UsedEIMSTotal = (
            SELECT ISNULL( SUM(EIMSAmt),0.00)
            FROM OverseaPOASNManagement.dbo.PO_EIMSInfoDetail WITH(NOLOCK)
            WHERE POSysNo = po.SysNo
          )
          ,pocount.AllPurchaseQty as [PurchaseOrderBasicInfo.PlanedPurchaseQty]
          ,pocount.AllQuantity as [PurchaseOrderBasicInfo.TotalQty]
          ,po.LogisticsNumber as [PurchaseOrderBasicInfo.LogisticsNumber]
          ,po.ExpressName as [PurchaseOrderBasicInfo.ExpressName]
          FROM IPP3.dbo.po_master po  WITH (NOLOCK)
          LEFT JOIN  IPP3.dbo.Vendor v WITH (NOLOCK)
          ON po.VendorSysNo =V.SysNo
          LEFT JOIN OverseaControlPanel.dbo.V_CP_Currency Currency WITH (NOLOCK)
          ON  Currency.SysNo = po.CurrencySysNo
          LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Stock Stock WITH (NOLOCK)
          ON Stock.SysNo =po.StockSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS UserInfo WITH(NOLOCK)
           ON UserInfo.UserSysNo = po.PMSysNo
          LEFT JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] AS PMConfirmUser WITH(NOLOCK)
           ON PMConfirmUser.UserSysNo = po.[ComfirmUserSysNo]
          LEFT JOIN [OverseaControlPanel].[dbo].[V_CP_ShipType] ShipType WITH(NOLOCK)
           ON ShipType.SysNo =po.ShipTypeSysNo
          LEFT OUTER JOIN
            (
              SELECT POSysNo
                    ,SUM(PurchaseQty) AS AllPurchaseQty
                    , SUM(Quantity)  AS AllQuantity
              FROM IPP3.dbo.PO_Item
              GROUP BY POSysNo
            ) pocount ON pocount.POSysNo = po.sysno
          #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPOSSBLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT [SysNo]
          ,[POSysNo]
          ,[Content]
          ,[ActionType]
          ,[InUser]
          ,[Indate]
          ,[ErrMSg]
          ,[ErrMSgTime]
          ,[SendErrMail]
          ,[CompanyCode]
          ,[LanguageCode]
          ,[StoreCompanyCode]
      FROM [OverseaPOASNManagement].[dbo].[POSSB_Log] WITH(NOLOCK)
      WHERE POSysNo = @POSysNo
      AND ActionType = @ActionType
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ActionType" dbType="StringFixedLength" />
    </parameters>
  </dataCommand>



  <dataCommand name="UpdatePOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE ipp3.[dbo].[PO_Master]
         SET VendorSysNo = @VendorSysNo
            ,StockSysNo = @StockSysNo
            ,ShipTypeSysNo = @ShipTypeSysNo
            ,PayTypeSysNo = @PayTypeSysNo
            ,CurrencySysNo = @CurrencySysNo
            ,ExchangeRate = @ExchangeRate
           -- ,TotalAmt = @TotalAmt
            ,ETP = @ETP
            ,Status = @Status
            ,IsConsign = @IsConsign
            ,POType = @POType
            ,PM_ReturnPointSysNo = @PM_ReturnPointSysNo
            ,UsingReturnPoint = @UsingReturnPoint
            ,ReturnPointC3SysNo = @ReturnPointC3SysNo
            ,TaxRate = @TaxRate
            ,SettlementCompany = @SettlementCompany
            ,ExecptStatus = @ExecptStatus
            ,PMSysNo = @PMSysNo
            ,PMRequestMemo = @PMRequestMemo
            ,TLRequestMemo = @TLRequestMemo
            ,Memo = @Memo
            ,Note = @Note
            ,InTime = @InTime
			,ETATime=@ETATime
			,ETAHalfDay=@ETAHalfDay
		  ,ITStockSysNo=@ITStockSysNo
      ,ContractNumber = @ContractNumber
      ,ProductLineSysNo=@ProductLineSysNo
      ,LogisticsNumber=@LogisticsNumber
      ,ExpressName=@ExpressName
       WHERE
           [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ContractNumber" dbType="String" />
      <param name="@SysNo" dbType="Int32" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@ShipTypeSysNo" dbType="Int32" />
      <param name="@PayTypeSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@ExchangeRate" dbType="Decimal" />
      <!--<param name="@TotalAmt" dbType="Decimal" />-->
      <param name="@ETP" dbType="DateTime" />
      <param name="@Status" dbType="Int32" />
      <param name="@IsConsign" dbType="Int32" />
      <param name="@POType" dbType="Int32" />
      <param name="@PM_ReturnPointSysNo" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@ReturnPointC3SysNo" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />
      <param name="@PMSysNo" dbType="Int32" />
      <param name="@SettlementCompany" dbType="Int32" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@InTime" dbType="DateTime" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="String" />
      <param name="@ITStockSysNo" dbType="Int32" />
      <param name="@ProductLineSysNo" dbType="Int32" />
      <param name="@LogisticsNumber" dbType="String" />
      <param name="@ExpressName" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateAutoAutoSendMailByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE TOP (1) ipp3.[dbo].[PO_Master]
        SET AutoSendMail = @AutoSendMail
        WHERE  [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@AutoSendMail" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOForJobETA" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      SELECT Sysno
				,TotalAmt as [PurchaseOrderBasicInfo.TotalAmt]
        ,ETATime as [PurchaseOrderBasicInfo.ETATimeInfo.ETATime]
				,ETAHalfDay as [PurchaseOrderBasicInfo.ETATimeInfo.HalfDay]
				,StockSysNo as [PurchaseOrderBasicInfo.StockInfo.SysNo]
				,PM_ReturnPointSysNo as [PurchaseOrderBasicInfo.PM_ReturnPointSysNo]
				,UsingReturnPoint as [PurchaseOrderBasicInfo.UsingReturnPoint]
				,ReturnPointC3SysNo  as [PurchaseOrderBasicInfo.ReturnPointC3SysNo]
			FROM IPP3.dbo.PO_Master WITH (NOLOCK)
			WHERE [Status]=3 AND CompanyCode=@CompanyCode
			]]>
    </commandText>
    <parameters>
      <param name="@CompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOItemsByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	     SELECT
		 item.[SysNo] as [ItemSysNo]
    ,item.BatchInfo as [BatchInfo]
		,item.[POSysNo] as [POSysNo]
		,item.[ProductSysNo] as [ProductSysNo]
		,item.[Quantity] as [Quantity]
		,item.[Weight] as [Weight]
		,item.[OrderPrice] as [OrderPrice]
		,item.[ApportionAddOn] as [ApportionAddOn]
		,item.[ReturnCost] as [ReturnCost]
		,item.[PurchaseQty] as [PurchaseQty]
		,item.[CheckStatus] as [CheckStatus]
		,item.[CheckReasonMemo] as [CheckReasonMemo]
		,item.[ExecptStatus] as [ExecptStatus]
		,product.[ProductID] as [ProductID]
		,item.[UnitCostWithoutTax] as [UnitCostWithoutTax]
		,item.[JDPrice] as [JingDongPrice]
		,item.[AvailableQty] as [AvailableQty]
		,item.[m1] as [M1]
		,item.[UnitCost] as [UnitCost]
		,item.[CurrentUnitCost] as [CurrentUnitCost]
		,item.[LastAdjustPriceDate] as [LastAdjustPriceDate]
		,item.[lastOrderPrice] as [LastOrderPrice]
		,item.[LastInTime] as [LastInTime]
    ,item.AcquireReturnPointType  as [AcquireReturnPointType]
    ,item.AcquireReturnPoint  as [AcquireReturnPoint]
    ,item.ReadyQuantity as [ReadyQuantity]
		,product.ProductMode as [ProductMode]
    ,product.BMCode as [BMCode]
    ,product.UPCCode as [UPCCode]
		,product.ProductName as [BriefName]
		,product.CurrentPrice as [CurrentPrice]
		,isnull(shs.ConsignQty,0) + isnull(shs.AvailableQty,0) + isnull(shs59.ConsignQty,0) + isnull(shs59.AvailableQty,0) as ShInventoryStock
		,isnull(bjs.ConsignQty,0) + isnull(bjs.AvailableQty,0) as bjInventoryStock
		,isnull(whs.ConsignQty,0) + isnull(whs.AvailableQty,0) as whInventoryStock
    ,isnull(gzs.ConsignQty,0) + isnull(gzs.AvailableQty,0) as GZInventoryStock
    ,isnull(cds54.ConsignQty,0) + isnull(cds54.AvailableQty,0) as CDInventoryStock
		,isnull(product.Week1SalesCount,0) as [Week1SalesCount]
		,isnull(shf.ShiftQty,0)as [ShiftQty]
    ,isnull(v_pps.PurchasePrice,0) as [PurchasePrice]
    , (CASE WHEN product.Vfitem = 'N' THEN 0 ELSE 1 END) as [IsVFItem]
    ,productPrice.VirtualPrice AS [VirtualPrice]
    ,isnull( h.UnActivatyCount,0) AS UnActivatyCount
    ,proEx.IsBatch AS IsBatch
    ,item.CompanyCode
	FROM ipp3.dbo.po_item as item WITH (NOLOCK)
	LEFT JOIN OverseaContentManagement.dbo.V_CM_ItemCommonInfo as product WITH (NOLOCK)
	ON product.SysNo = item.[ProductSysNo]
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs WITH(NOLOCK)
	ON shs.ProductSysNo = item.[ProductSysNo] and shs.stockSysNo in (51)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock cds54 WITH(NOLOCK)
	ON cds54.ProductSysNo = item.[ProductSysNo] and cds54.stockSysNo in (54)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs59 WITH(NOLOCK)
	ON shs59.ProductSysNo = item.[ProductSysNo] and shs59.stockSysNo in (59)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock bjs  WITH(NOLOCK)
	ON bjs.ProductSysNo = item.[ProductSysNo] and bjs.stockSysNo in (52)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock whs  WITH(NOLOCK)
	ON whs.ProductSysNo = item.[ProductSysNo] and whs.stockSysNo in (55)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock gzs  WITH(NOLOCK)
	ON gzs.ProductSysNo = item.[ProductSysNo] and gzs.stockSysNo in (53)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
	ON shf.ProductSysNo = Item.[ProductSysNo]
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_Mapping as v_mapping WITH (NOLOCK)
  ON v_mapping.ProductSysno = item.ProductSysNo
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_SynProduct v_pps WITH(NOLOCK)
  ON v_pps.ProductMappingSysNo = v_mapping.SysNo
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productPrice WITH(NOLOCK)
  ON  productPrice.ProductSysNo = product.SysNo
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Ex proEx WITH(NOLOCK)
  ON proEx.PreviousProductSysNo = product.SysNo
  LEFT JOIN (
      SELECT count(1) AS UnActivatyCount
             ,ProductSysNo
      FROM  OverseaInventoryManagement.dbo.Product_Batch WITH(NOLOCK)
      WHERE Status IN ('R','I')
      Group By ProductSysNo
      ) h 
    ON h.ProductSysNo = item.ProductSysNo
   WHERE  item.POSysNo = @POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>



  <dataCommand name="GetPurchaseOrderItemSalesInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
 
         SELECT 
                ProductSysNo 
               ,SUM( CASE WareHouseNumber 
                    WHEN 52 THEN W1 
                    ELSE 0 
                END ) AS BJW1 
               ,SUM( CASE WareHouseNumber 
                    WHEN 51 THEN W1
                    WHEN 59 THEN W1 
                    ELSE 0 
                END ) AS SHW1 
               ,SUM( CASE WareHouseNumber 
                    WHEN 53 THEN W1 
                    ELSE 0 
                END ) AS GZW1 
               ,SUM( CASE WareHouseNumber 
                    WHEN 55 THEN W1
                    ELSE 0 
                END ) AS WHW1 
               ,SUM( CASE WareHouseNumber 
                    WHEN 54 THEN W1
                    ELSE 0 
                END ) AS CDW1 
            FROM OverseaInventoryManagement.dbo.V_Inventory_InventoryBalancing 
            WHERE 
                ProductSysNo = @ProductSysNo
            GROUP BY ProductSysNo 
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPOItemsBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       SELECT
		 item.[SysNo] as [ItemSysNo]
    ,item.BatchInfo as [BatchInfo]
		,item.[POSysNo] as [POSysNo]
		,item.[ProductSysNo] as [ProductSysNo]
		,item.[Quantity] as [Quantity]
		,item.[Weight] as [Weight]
		,item.[OrderPrice] as [OrderPrice]
		,item.[ApportionAddOn] as [ApportionAddOn]
		,item.[ReturnCost] as [ReturnCost]
		,item.[PurchaseQty] as [PurchaseQty]
		,item.[CheckStatus] as [CheckStatus]
		,item.[CheckReasonMemo] as [CheckReasonMemo]
		,item.[ExecptStatus] as [ExecptStatus]
		,product.[ProductID] as [ProductID]
		,item.[UnitCostWithoutTax] as [UnitCostWithoutTax]
		,item.[JDPrice] as [JingDongPrice]
		,item.[AvailableQty] as [AvailableQty]
		,item.[m1] as [M1]
		,item.[UnitCost] as [UnitCost]
		,item.[CurrentUnitCost] as [CurrentUnitCost]
		,item.[LastAdjustPriceDate] as [LastAdjustPriceDate]
		,item.[lastOrderPrice] as [LastOrderPrice]
		,item.[LastInTime] as [LastInTime]
    ,item.AcquireReturnPointType  as [AcquireReturnPointType]
    ,item.AcquireReturnPoint  as [AcquireReturnPoint]
    ,item.ReadyQuantity as [ReadyQuantity]
		,product.ProductMode as [ProductMode]
		,product.ProductName as [BriefName]
		,product.CurrentPrice as [CurrentPrice]
		,isnull(shs.ConsignQty,0) + isnull(shs.AvailableQty,0)+isnull(shs59.ConsignQty,0) + isnull(shs59.AvailableQty,0) as ShInventoryStock
		,isnull(bjs.ConsignQty,0) + isnull(bjs.AvailableQty,0) as bjInventoryStock
		,isnull(whs.ConsignQty,0) + isnull(whs.AvailableQty,0) as whInventoryStock
    ,isnull(gzs.ConsignQty,0) + isnull(gzs.AvailableQty,0) as GZInventoryStock
    ,isnull(cds54.ConsignQty,0) + isnull(cds54.AvailableQty,0) as CDInventoryStock
		,isnull(product.Week1SalesCount,0) Week1SalesCount
		,isnull(shf.ShiftQty,0) ShiftQty
		,productprice.VirtualPrice AS VirtualPrice
    ,proEx.IsBatch AS IsBatch
	FROM IPP3.dbo.PO_Item as item WITH (NOLOCK)
	LEFT JOIN OverseaContentManagement.dbo.V_CM_ItemCommonInfo as product WITH (NOLOCK)
	ON product.SysNo = item.[ProductSysNo]
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs WITH(NOLOCK)
	ON shs.ProductSysNo = item.[ProductSysNo] and shs.stockSysNo = 51
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs59 WITH(NOLOCK)
	ON shs59.ProductSysNo = item.[ProductSysNo] and shs59.stockSysNo = 59
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock cds54 WITH(NOLOCK)
	ON cds54.ProductSysNo = item.[ProductSysNo] and cds54.stockSysNo = 54
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock bjs  WITH(NOLOCK)
	ON bjs.ProductSysNo = item.[ProductSysNo] and bjs.stockSysNo in( 52)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock whs  WITH(NOLOCK)
	ON whs.ProductSysNo = item.[ProductSysNo] and whs.stockSysNo in( 55)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock gzs  WITH(NOLOCK)
	ON gzs.ProductSysNo = item.[ProductSysNo] and gzs.stockSysNo in( 53)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
	ON shf.ProductSysNo = Item.[ProductSysNo]
	LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productprice WITH(NOLOCK)
	ON productprice.ProductSysNo = product.SysNo
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Ex proEx WITH(NOLOCK)
  ON proEx.PreviousProductSysNo = product.SysNo
	WHERE  item.SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>






  <dataCommand name="GetLastPoDate" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
        MAX(LastInTime)
     FROM OverseaContentManagement.dbo.V_IM_Product_LastPOInfo  WITH(NOLOCK)
        Where ProductSysNo=@ProductSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePoMasterTpStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE ipp3.dbo.PO_Master
      SET TPStatus = @TpStatus
         ,ApportionUserSysNo = @ApportionUserSysNo
         ,ApportionTime = @ApportionTime
      WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@TpStatus" dbType="String" />
      <param name="@ApportionUserSysNo" dbType="Int32" />
      <param name="@ApportionTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOItemStatusVerifyInStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE ipp3.[dbo].[PO_Master]
         SET Status = @Status
            ,ApportionTime = @ApportionTime
            ,ApportionUserSysNo = @ApportionUserSysNo
            ,AuditTime = @AuditTime
            ,AuditUserSysNo = @AuditUserSysNo
            ,UsingReturnPoint = @UsingReturnPoint
            ,PMRequestMemo = @PMRequestMemo
            ,TLRequestMemo = @TLRequestMemo
            ,ETP = @ETP
			      ,ETATime=@ETATime
			      ,ETAHalfDay=@ETAHalfDay
			      ,TPStatus=case @Status
            WHEN 5 THEN @TPStatus
					  ELSE ''
					  END
            ,RefuseMemo=@RefuseMemo
        WHERE   [SysNo] = @SysNo  AND Status in(1,5)

			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="AnsiStringFixedLength" />
      <param name="@TPStatus" dbType="String" />
      <param name="@RefuseMemo" dbType="String" />
      <param name="@ApportionTime" dbType="DateTime" />
      <param name="@ApportionUserSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	      UPDATE ipp3.dbo.PO_Item SET
        POSysNo=@POSysNo
        ,ProductSysNo=@ProductSysNo
        ,BriefName=@BriefName
        ,Quantity=@Quantity
        ,Weight=@Weight
        ,OrderPrice=@OrderPrice
        ,ApportionAddOn=@ApportionAddOn
        ,UnitCost=@UnitCost
        ,ReturnCost=@ReturnCost
        ,lastOrderPrice=@lastOrderPrice
        ,ExecptStatus=@ExecptStatus
        ,UnitCostWithoutTax=@UnitCostWithoutTax
        ,JDPrice=@JDPrice
        ,AvailableQty=@AvailableQty
        ,PurchaseQty = @PurchaseQty
        ,m1=@m1
        ,CurrencySysNo = @CurrencySysNo
        ,CurrentUnitCost = @CurrentUnitCost
        ,CurrentPrice = @CurrentPrice
        ,LastAdjustPriceDate = @LastAdjustPriceDate
        ,LastInTime = @LastInTime
        ,AcquireReturnPointType = @AcquireReturnPointType
        ,AcquireReturnPoint = @AcquireReturnPoint
        WHERE
        SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@AcquireReturnPointType" dbType="Int32" />
      <param name="@AcquireReturnPoint" dbType="Decimal" />
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@BriefName" dbType="String" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@Weight" dbType="Int32" />
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@ApportionAddOn" dbType="Decimal" />
      <param name="@UnitCost" dbType="Decimal" />
      <param name="@ReturnCost" dbType="Decimal" />
      <param name="@lastOrderPrice" dbType="Decimal" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@UnitCostWithoutTax" dbType="Decimal" />
      <param name="@JDPrice" dbType="Decimal" />
      <param name="@AvailableQty" dbType="Int32" />
      <param name="@m1" dbType="Int32" />
      <param name="@PurchaseQty" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@CurrentUnitCost" dbType="Decimal" />
      <param name="@CurrentPrice" dbType="Decimal" />
      <param name="@LastAdjustPriceDate" dbType="DateTime" />
      <param name="@LastInTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOWithItems" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
	         po.SysNo as PONumber
          ,po.ITStockSysNo
	        ,po.CompanyCode
	        ,po.VendorSysNo as VendorNumber
	        ,po.StockSysNo as WarehouseNumber
	        ,CASE po.POType
			       WHEN 0 THEN 'N'
			       WHEN 1 THEN 'R'
		       END AS POTYPE
	        ,po.Memo
	        ,item.ProductSysNo
	        ,product.ProductID as ItemNumber
	        ,product.BriefName ProductName
	        ,item.PurchaseQty
	        ,item.OrderPrice as Price
	        ,item.Weight
          ,item.BatchInfo
      FROM ipp3.dbo.PO_Master po WITH(NOLOCK)
      INNER JOIN IPP3.dbo.PO_Item item WITH(NOLOCK)
        ON po.SysNo = item.POSysNo
      INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
        ON item.ProductSysNo = product.SysNo
      WHERE po.SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPMNameAndPhoneNumberByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
	        isnull(DisplayName,'') + ' ' + isnull(PhoneNumber,'')
        FROM IPP3.dbo.PO_Master pomaster WITH(nolock)
        LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo userinfo WITH(nolock)
        ON userinfo.UserSysNo = pomaster.PMSysNo
        WHERE pomaster.SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SendSSBMessage" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      EXEC SSB3.PubSubService.Up_SendArticle @RequestMSG
			]]>
    </commandText>
    <parameters>
      <param name="@RequestMSG" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetTodayTotalAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
           DECLARE @date VARCHAR(50)
			SELECT @date=CONVERT(VARCHAR(10),CreateTime,121)  FROM ipp3.dbo.PO_Master WITH (nolock)
			WHERE SysNo=@POSysNo
			SELECT isnull( SUM(TotalAmt),0) FROM dbo.PO_Master WITH (nolock)
			WHERE CONVERT(VARCHAR(10),CreateTime,121) = @date AND PMSysNo = @PMSysNo
			AND Status NOT IN (0,-1)
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@PMSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>



  <dataCommand name="GetPOLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	SELECT
		[purno] POSysNo
		,SUM(ISNULL(TotalAmt,0)) SumTotalAmt
		,SUM(ISNULL(EIMSAmt,0))  SumEIMSAmt
	FROM [Scm].[dbo].[poLog]
	WHERE [purno]=@POSysNo
	GROUP BY [purno]
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="MaintainPO_ETACancle" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE [IPP3].[dbo].[PO_ETA]
           SET [STATUS]=@Status,
		       EditDate=getdate(),
			   EditUser=@EditUser
         WHERE POSysNo=@POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@EditUser" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="PO_ETAToPO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE [IPP3].[dbo].[PO_Master]
          Set ETATime=@ETATime,
			  ETAHalfDay=@HalfDay
		  Where SysNo=@POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@HalfDay" dbType="String" />
      <param name="@ETATime" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOTotalAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
           SELECT
            ipp3.dbo.po_master.sysno
            ,ipp3.dbo.po_master.TotalAmt
            ,ipp3.dbo.vendor.ValidDate
            ,ipp3.dbo.vendor.ExpiredDate
            ,ipp3.dbo.vendor.ContractAmt
            ,ipp3.dbo.vendor.TotalPOMoney
            FROM ipp3.dbo.po_master with(nolock),ipp3.dbo.vendor with(nolock)
            WHERE ipp3.dbo.po_master.vendorsysno = ipp3.dbo.vendor.sysno
            AND ipp3.dbo.po_master.sysno = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetAuditPOAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT isnull(sum(totalamt),0) totalamt
        FROM ipp3.dbo.po_master po WITH(NOLOCK)
        WHERE po.status = 3
        AND po.potype != 3
        AND po.isconsign=0 and po.PMSysNo = @PMSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@PMSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="ConFirmVindor" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE ipp3.[dbo].[PO_Master]
         SET ComfirmUserSysNo = @ComfirmUserSysNo
            ,ComfirmTime = @ComfirmTime
        WHERE
           [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ComfirmUserSysNo" dbType="Int32" />
      <param name="@ComfirmTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePO_ETA" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          INSERT INTO [IPP3].[dbo].[PO_ETA]
           ([POSysNo]
           ,[ETATime]
           ,[HalfDay]
           ,[STATUS]
           ,[Memo]
           ,[Indate]
           ,[InUser]
           )
		 VALUES
           (@POSysNo
           ,@ETATime
           ,@HalfDay
           ,1
           ,@Memo
           ,getdate()
           ,@InUser
           )
       SELECT SCOPE_IDENTITY();
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@ETATime" dbType="DateTime" />
      <param name="@HalfDay" dbType="AnsiStringFixedLength"/>
      <param name="@Memo" dbType="String" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetRMA" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT @TotalCount = Count(1)
        FROM
        (
          SELECT DISTINCT
           RMA_OutBound.VendorSysNo as VendorSysNo
          ,RMA_OutBound.VendorName as VendorName
          ,Product.PMUserSysNo as PMUserSysNo
          ,Product.ProductID as ProductID
          ,Product.ProductName as ProductName
          ,Product.SysNo as ProductSysNo
          ,RMA_Register.Cost as ProductCost
          ,RMA_Register.SysNo as RMASysNo
          ,V_SO_Master.SysNo as SOSysNo
          ,V_SO_Master.AuditTime as SODate
          ,V_SO_Item.Warranty as Warranty
          ,RMA_OutBound.SysNo as OutBoundSysNo
          ,RMA_OutBound.OutTime as OutTime
          ,RMA_Register.IsWithin7Days as IsWithin7Days
          ,RMA_Register.ResponseDesc as ResponseDesc
          ,RMA_Register.Memo as Memo
          ,sys_user.EmailAddress as Email
          ,Vendor.ValidDate
          ,Vendor.ExpiredDate,Vendor.ContractAmt
          ,Vendor.TotalPOMoney
          ,Vendor.PayPeriodType,Vendor.Status as venStatus
          ,RMA_OutBound_Item.IsSendMail
          ,RMA_Register.RefundStatus as RefundStatus
          ,RMA_Register.RevertStatus as RevertStatus
          ,category3.Category3Name as C3Name
          ,category3.WarrantyDays
          ,sys_user.DisplayName as PMUserName
          FROM OverseaServiceManagement.dbo.V_SM_RMAOutboundMaster RMA_OutBound WITH(NOLOCK)
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMAOutboundTransaction RMA_OutBound_Item WITH (NOLOCK) on RMA_OutBound_Item.OutBoundSysNo = RMA_OutBound.SysNo
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister RMA_Register WITH (NOLOCK) on RMA_Register.SysNo = RMA_OutBound_Item.RegisterSysNo
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH (NOLOCK) on Product.SysNo = RMA_Register.ProductSysNo
          INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARequestTransaction] RMA_Request_Item WITH (NOLOCK) on RMA_Request_Item.RegisterSysNo = RMA_Register.Sysno
          INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster RMA_Request WITH(NOLOCK) on RMA_Request.SysNo = RMA_Request_Item.RequestSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master V_SO_Master WITH(NOLOCK) on V_SO_Master.SysNo = RMA_Request.SoSysNo
          INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item V_SO_Item WITH (NOLOCK) on (V_SO_Item.SOSysNo = V_SO_Master.SysNo and V_SO_Item.ProductSysNo = Product.SysNo)
          INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category3 WITH (NOLOCK) on product.Category3SysNo = category3.Category3Sysno
          LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sys_user WITH (NOLOCK) on Product.pmusersysno = sys_user.UserSysNo
          LEFT JOIN ipp3.dbo.Vendor Vendor WITH (NOLOCK) on Vendor.SysNo=RMA_OutBound.VendorSysNo
          StrWhere
        ) AS TEMP

        SELECT
         PMUserSysNo
        , PMUserName
        , RMASysNo
        , ProductID
        , VendorName
        , ProductName
        , OutBoundSysNo
        , RowNumber
        FROM
        (
            SELECT TOP (@EndNumber)
             PMUserSysNo
            , PMUserName
            , RMASysNo
            , ProductID
            , VendorName
            , ProductName
            , OutBoundSysNo
            ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
            FROM
            (
               SELECT DISTINCT
               RMA_OutBound.VendorSysNo as VendorSysNo
              ,RMA_OutBound.VendorName as VendorName
              ,Product.PMUserSysNo as PMUserSysNo
              ,Product.ProductID as ProductID
              ,Product.ProductName as ProductName
              ,Product.SysNo as ProductSysNo
              ,RMA_Register.Cost as ProductCost
              ,RMA_Register.SysNo as RMASysNo
              ,V_SO_Master.SysNo as SOSysNo
              ,V_SO_Master.AuditTime as SODate
              ,V_SO_Item.Warranty as Warranty
              ,RMA_OutBound.SysNo as OutBoundSysNo
              ,RMA_OutBound.OutTime as OutTime
              ,RMA_Register.IsWithin7Days as IsWithin7Days
              ,RMA_Register.ResponseDesc as ResponseDesc
              ,RMA_Register.Memo as Memo
              ,sys_user.EmailAddress as Email
              ,Vendor.ValidDate
              ,Vendor.ExpiredDate,Vendor.ContractAmt
              ,Vendor.TotalPOMoney
              ,Vendor.PayPeriodType,Vendor.Status as venStatus
              ,RMA_OutBound_Item.IsSendMail
              ,RMA_Register.RefundStatus as RefundStatus
              ,RMA_Register.RevertStatus as RevertStatus
              ,category3.Category3Name as C3Name
              ,category3.WarrantyDays
              ,sys_user.DisplayName as PMUserName
              FROM OverseaServiceManagement.dbo.V_SM_RMAOutboundMaster RMA_OutBound WITH(NOLOCK)
              INNER JOIN OverseaServiceManagement.dbo.V_SM_RMAOutboundTransaction RMA_OutBound_Item WITH (NOLOCK) on RMA_OutBound_Item.OutBoundSysNo = RMA_OutBound.SysNo
              INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARegister RMA_Register WITH (NOLOCK) on RMA_Register.SysNo = RMA_OutBound_Item.RegisterSysNo
              INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH (NOLOCK) on Product.SysNo = RMA_Register.ProductSysNo
              INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARequestTransaction] RMA_Request_Item WITH (NOLOCK) on RMA_Request_Item.RegisterSysNo = RMA_Register.Sysno
              INNER JOIN OverseaServiceManagement.dbo.V_SM_RMARequestMaster RMA_Request (NOLOCK) on RMA_Request.SysNo = RMA_Request_Item.RequestSysNo
              INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master V_SO_Master WITH(NOLOCK) on V_SO_Master.SysNo = RMA_Request.SoSysNo
              INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Item V_SO_Item WITH (NOLOCK) on (V_SO_Item.SOSysNo = V_SO_Master.SysNo and V_SO_Item.ProductSysNo = Product.SysNo)
              INNER JOIN OverseaContentManagement.dbo.V_CM_CategoryInfo category3 WITH (NOLOCK) on product.Category3SysNo = category3.Category3Sysno
              LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sys_user WITH (NOLOCK) on Product.pmusersysno = sys_user.UserSysNo
              LEFT JOIN ipp3.dbo.Vendor Vendor WITH (NOLOCK) on Vendor.SysNo=RMA_OutBound.VendorSysNo
              StrWhere
           ) AS TEMP
       )RESULT where RowNumber > @StartNumber

			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdatePoMasterCheckResult" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE ipp3.dbo.PO_Master
      SET CheckResult = @CheckResult
      WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@CheckResult" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductByVendorSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
           product.SysNo
          ,product.ProductID
        FROM OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
        LEFT JOIN IPP3.dbo.Vendor_Manufacturer vm  WITH(NOLOCK)
          ON vm.ManufacturerSysNo = product.ManufacturerSysNo AND vm.CompanyCode = product.CompanyCode
        WHERE vm.VendorSysNo = @VendorSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@VendorSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOReceivedInfoByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT distinct pr.[Vendno]  VenderSysNo
			  ,pr.[Purno] as [POSysNo]
			  ,p.SysNo as [ProductSysNo]
			  ,pr.[Item] as [ProductID]
			  ,pr.[BatchNumber]
			  ,pr.Descrip as [ProductName]
			  ,pr.[WarehouseNumber]
			  ,pr.[ReceivedQuantity]
			  ,pr.[ReceivedDate]
			  ,pr.[ReceivedUser]
		FROM [Scm].[dbo].[POReceivedDetail]  pr WITH(NOLOCK)
		LEFT  JOIN OverseaContentManagement.dbo.V_IM_Product  p  WITH(NOLOCK)
		ON p.ProductID=pr.[Item]
		WHERE pr.[Purno]=@POSysNo
		ORDER BY pr.[ReceivedDate]
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPOCount" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
			    po.status,
			    COUNT(DISTINCT po.sysno) POQty,
				COUNT(item.posysno) ItemQty,
          (Case po.status WHEN 4 THEN SUM(ISNULL(item.Quantity,0)) --对于已入库状态下取Item的入库数量（Quantity）
			                     WHEN 0 THEN SUM(ISNULL(item.PurchaseQty,0)) -- 其他状态下取Item的采购数量（PurchaseQty
				                 WHEN -1 THEN SUM(ISNULL(item.PurchaseQty,0))
								 WHEN 1 THEN SUM(ISNULL(item.PurchaseQty,0))
								 WHEN 5 THEN SUM(ISNULL(item.PurchaseQty,0))
								 WHEN -2 THEN SUM(ISNULL(item.PurchaseQty,0))
								 WHEN 6 THEN SUM(ISNULL(item.PurchaseQty,0))
					             WHEN 7 THEN SUM(ISNULL(item.PurchaseQty,0))
				             	 WHEN 8 THEN SUM(ISNULL(item.PurchaseQty,0))
                                 WHEN 2 THEN SUM(ISNULL(item.PurchaseQty,0))
                                 WHEN 9 THEN SUM(ISNULL(item.PurchaseQty,0))
                                 WHEN 10 THEN SUM(ISNULL(item.PurchaseQty,0))
                                 WHEN 3 THEN SUM(ISNULL(item.PurchaseQty,0)) END) AS UnitQty
           FROM ipp3.dbo.po_master as po with(nolock)
           INNER JOIN  ipp3.dbo.vendor with(nolock)
			  ON po.vendorsysno = ipp3.dbo.vendor.sysno
           INNER JOIN  OverseaInventoryManagement.dbo.V_INM_Stock stock with(nolock)
			  ON po.stocksysno = stock.sysno
           INNER JOIN  OverseaArchitecture.dbo.V_AR_UserInfo as con_create with(nolock)
			  ON po.createusersysno = con_create.UserSysNo
           LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo as con_audit with(nolock)
			  ON po.auditusersysno = con_audit.UserSysNo
           LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo as con_in with(nolock)
			  ON po.inusersysno = con_in.UserSysNo
           LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo as com_user with(nolock)
			  ON po.ComfirmUserSysNo = com_user.UserSysNo
           LEFT OUTER JOIN OverseaArchitecture.dbo.V_AR_UserInfo as con_apport with(nolock)
			  ON po.ApportionUserSysNo = con_apport.UserSysNo
           LEFT OUTER JOIN ipp3.dbo.po_item as item with(nolock)
		      ON po.sysno = item.posysno
          LEFT OUTER JOIN
	          (   SELECT Purno,MAX(recdate) AS MaxTastDate
                  FROM scm.dbo.poLog WITH (nolock)
                  GROUP BY Purno
               )a ON po.SysNo = a.Purno
           #StrWhere# ReplaceSql
          GROUP BY po.status
			]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>







  <dataCommand name="QueryPOETA" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT  [Sysno]  as [ETATimeSysNo]
	             ,[POSysNo]
	             ,[ETATime]
	             ,[HalfDay]
	             ,[STATUS] as [Status]
	             ,[Memo]
	             ,[Indate]
	             ,[InUser]
	             ,[EditDate]
	             ,[EditUser]
        FROM IPP3.dbo.PO_ETA WITH(NOLOCK)
        #StrWhere#
			]]>
    </commandText>
  </dataCommand>




  <dataCommand name="DeletePOItemsByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DELETE FROM  [IPP3].[dbo].[PO_Item]
        WHERE [POSysNo] = @POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="DeletePOItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	      DELETE IPP3.dbo.PO_Item WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOMasetToAmt" database="NCService"  commandType="Text">
    <commandText>
      <![CDATA[
      DECLARE @TotalAmt decimal(19,6)

      SELECT  @TotalAmt = sum( isnull(b.PurchaseQty,0) * isnull(b.OrderPrice,0))
      FROM IPP3.dbo.PO_Master a WITH  (NOLOCK)
      INNER JOIN IPP3.dbo.PO_Item b WITH  (NOLOCK) ON b.POSysNo = a.SysNo
      WHERE b.POSysNo = @SysNo

      UPDATE IPP3.dbo.PO_Master
      SET TotalAmt = @TotalAmt
      WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateAllAcquireReturnInfo" database="NCService"  commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE  ipp3.dbo.PO_Item
      SET  AcquireReturnPointType = @AcquireReturnPointType
          ,AcquireReturnPoint = @AcquireReturnPoint
      WHERE POSysNo = @POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@AcquireReturnPointType" dbType="Int32" />
      <param name="@AcquireReturnPoint" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="AddPOItemByProductSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DECLARE @ExchangeRate DECIMAL(19,6),@CurrencySymbol varchar(10)
        SELECT
	        @ExchangeRate = ExchangeRate
         ,@CurrencySymbol = CurrencySymbol
        FROM OverseaControlPanel.dbo.V_CP_Currency WITH(NOLOCK)
		    WHERE SysNo = @CurrencySysNo

        SELECT
          Item.SysNo ProductSysNo
          ,Item.ProductID
          ,Item.ProductName
          ,Item.ProductMode
          ,Item.BMCode
          ,Item.UPCCode
          ,Item.PMUserSysNo
          ,Item.CurrentPrice
          ,Item.JDPrice as JingDongPrice
          ,Item.UnitCost
          ,Item.ItemPoint as Point
          ,basic.Weight
          ,basic.BriefName
	        ,isnull(Item.Month1SalesCount,0) M1
          ,@ExchangeRate ExchangeRate
          ,@CurrencySymbol  CurrencySymbol
          ,isnull(shs.ConsignQty,0) + isnull(shs.AvailableQty,0)+isnull(shs59.ConsignQty,0) + isnull(shs59.AvailableQty,0) as SHInventoryStock
          ,isnull(bjs.ConsignQty,0) + isnull(bjs.AvailableQty,0) as BJInventoryStock
          ,isnull(whs.ConsignQty,0) + isnull(whs.AvailableQty,0) as WHInventoryStock
          ,isnull(gzs.ConsignQty,0) + isnull(gzs.AvailableQty,0) as GZInventoryStock
          ,isnull(cds54.ConsignQty,0) + isnull(cds54.AvailableQty,0) as CDInventoryStock
          ,isnull(Item.Week1SalesCount,0) Week1SalesCount
          ,isnull(shf.ShiftQty,0) ShiftQty
          ,isnull(v_pps.PurchasePrice,0) PurchasePrice
          ,Item.Vfitem as [IsVFItem]
          ,productprice.VirtualPrice AS VirtualPrice
        FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo Item WITH(NOLOCK)
        INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo basic  WITH(NOLOCK)
           ON basic.SysNo = Item.SysNo
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs WITH(NOLOCK)
		       ON shs.ProductSysNo = Item.SysNo and shs.stockSysNo = 51

        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock cds54 WITH(NOLOCK)
		       ON cds54.ProductSysNo = Item.SysNo and cds54.stockSysNo = 54
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock gzs WITH(NOLOCK)
		       ON gzs.ProductSysNo = Item.SysNo and gzs.stockSysNo = 53

        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs59 WITH(NOLOCK)
		       ON shs59.ProductSysNo = Item.SysNo and shs59.stockSysNo = 59
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock bjs  WITH(NOLOCK)
		       ON bjs.ProductSysNo = Item.SysNo and bjs.stockSysNo = 52
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock whs  WITH(NOLOCK)
		       ON whs.ProductSysNo = Item.SysNo and whs.stockSysNo = 55
        LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
		       ON shf.ProductSysNo = Item.SysNo
        LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_Mapping as v_mapping WITH (NOLOCK)
           ON v_mapping.ProductSysno = basic.SysNo AND v_mapping.PartnerType NOT IN('D','T','M')
        LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_SynProduct v_pps WITH(NOLOCK)
		       ON v_pps.ProductMappingSysNo = v_mapping.SysNo
        LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productprice WITH(NOLOCK)
		       ON productprice.ProductSysNo = item.SysNo
        WHERE Item.SysNo = @ProductSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetJDPriceAndM1AndAndAvailableQty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT
      CurrentUnitCost =
          (
            SELECT  UnitCost
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      CurrentPrice =
          (
            SELECT TOP 1  CurrentPrice
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      LastOrderPrice=
          (
            SELECT TOP 1  LastPrice AS lastOrderPrice
            FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      AvailableQty = --每个Item在库存中应对应一条数据
          (
            SELECT TOP 1 SUM( isnull(OnlineQty,0) - isnull(VirtualQty,0)) FROM OverseaInventoryManagement.dbo.V_INM_Inventory  WITH(NOLOCK)
            WHERE ItemSysNumber = @ProductSysNo
          ),
      M1=
          (
            SELECT TOP 1 [m1] FROM [OverseaContentManagement].[dbo].[V_CM_ItemSaleTrendInfo]  WITH (NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
          ),
      JingDongPrice=
          (
            SELECT TOP 1 JDPrice FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo  WITH(NOLOCK)
            WHERE SysNo = @ProductSysNo
          ),
      LastAdjustPriceDate =
          (
            SELECT TOP 1 CreateDate AS LastAdjustPriceDate FROM OverseaContentManagement.dbo.V_IM_ProductPricechangeLog WITH(NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
            ORDER BY CreateDate DESC
          ),
      LastInTime =
          (
              SELECT TOP 1 LastInTime FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo WITH(NOLOCK)
              WHERE ProductSysNo = @ProductSysNo
          ),
       UnActivatyCount= (SELECT count(1) AS UnActivatyCount
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ProductSysNo
       )
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="V_INM_Inventory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT [ItemSysNumber]
      ,Inv.[AccountQty]
      ,isnull(Inv.OnlineQty,0) - isnull(Inv.VirtualQty,0) AS AvailableQty
      ,Inv.[AllocatedQty]
      ,Inv.[OrderQty]
      ,Inv.[ConsignQty]
      ,Inv.[VirtualQty]
      ,Inv.[OnlineQty]
      ,Inv.[PurchaseQty]
      ,Inv.[ShiftQty]
      ,act.UnActivatyCount
      FROM OverseaInventoryManagement.dbo.V_INM_Inventory Inv WITH(NOLOCK)
      LEFT JOIN
      (SELECT count(1) AS UnActivatyCount
        ,ProductSysNo
        FROM  OverseaInventoryManagement.dbo.V_Product_Batch WITH(NOLOCK)
        WHERE Status IN ('R','I') and ProductSysNo = @ItemSysNumber
        GROUP BY ProductSysNo
      ) act on act.ProductSysNo = Inv.ItemSysNumber
      WHERE ItemSysNumber = @ItemSysNumber
			]]>
    </commandText>
    <parameters>
      <param name="@ItemSysNumber" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetGiftList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	       SELECT  p.productid as GiftId
          ,p.productname AS ProductName
          ,p.status
          ,p.weight
		  ,g.productid
		  ,g.productname
          ,(i.AvailableQty+i.VirtualQty+i.ConsignQty) AS OnlineQty
          FROM OverseaContentManagement.dbo.V_CM_Sale_Gift sg  WITH (NOLOCK)
          inner join OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH (NOLOCK)  ON p.sysno = sg.giftsysno
          inner join OverseaInventoryManagement.dbo.V_INM_Inventory i  WITH (NOLOCK)  ON i.ItemSysNumber = p.sysno
          inner join OverseaContentManagement.dbo.V_CM_ItemBasicInfo g WITH (NOLOCK)  ON g.sysno = sg.ProductSysNo
          #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPurchaseOrderAccessoriesBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
WITH temp as
(
  SELECT
  Product.ProductID as Id,
  Accessories.AccessoriesName
  FROM  OverseaContentManagement.dbo.V_CM_Product_Accessories Product_Accessories WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH(NOLOCK)
  ON Product_Accessories.ProductSysno = Product.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_CM_Accessories Accessories WITH(NOLOCK)
  ON Product_Accessories.AccessoriesSysno = Accessories.Sysno
  #StrWhere# OtherCondition
  UNION ALL
  SELECT
  item.ProductID as Id,
  product.BriefName AS AccessoriesName
  FROM  OverseaContentManagement.dbo.V_IM_Product_Attachment atc WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo item WITH(NOLOCK)
  ON atc.ProductSysno = item.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
  ON atc.ProductAttachmentSysNo = product.Sysno
  WHERE  product.status = 2 AND #CustomCondition#
)
SELECT row_number() OVER(ORDER BY Id) as rowNumber
,Id
,STUFF
(
  (
        SELECT ' '+ltrim(rtrim(AccessoriesName)
  )
  FROM temp t WHERE Id=temp.Id FOR XML PATH('')), 1, 1, ''
) as Description
FROM temp GROUP BY Id
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="POItemPriceLimit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT
       TOP 1 [SysNo]
      ,[OrderPriceFrom]
      ,[OrderPriceTo]
      ,[LowRate]
      ,[TopRate]
      ,[CreateTime]
      ,[CreateUserSysNo]
      ,[Status]
      FROM IPP3.dbo.PO_ItemPriceLimit WITH(NOLOCK)
      WHERE OrderPriceFrom <= @OrderPrice
      AND OrderPriceTo > @OrderPrice
      AND Status = @Status
      AND CompanyCode = @CompanyCode
      ORDER BY CreateTime DESC ;
			]]>
    </commandText>
    <parameters>
      <param name="@OrderPrice" dbType="Decimal" />
      <param name="@Status" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="VerifyInStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE  [IPP3].[dbo].[PO_Master]
         SET Status = @Status
            ,AuditTime = @AuditTime
            ,AuditUserSysNo = @AuditUserSysNo
            ,UsingReturnPoint = @UsingReturnPoint
            ,TLRequestMemo = @TLRequestMemo
            ,ETP = @ETP
			      ,ETATime=@ETATime
			      ,ETAHalfDay=@ETAHalfDay
			      ,TPStatus=case @Status
            WHEN 5 THEN @TPStatus
					  ELSE ''
					  END
            ,RefuseMemo=@RefuseMemo
        WHERE   [SysNo] = @SysNo

			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditTime" dbType="DateTime" />
      <param name="@AuditUserSysNo" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="AnsiStringFixedLength" />
      <param name="@TPStatus" dbType="String" />
      <param name="@RefuseMemo" dbType="String" />

    </parameters>
  </dataCommand>

  <dataCommand name="UpdateInStockMemo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE  [IPP3].[dbo].[PO_Master]
        SET InStockMemo = @InStockMemo
             ,CarriageCost = @CarriageCost
       WHERE
           [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@InStockMemo" dbType="String" />
      <param name="@CarriageCost" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreatePOSSBLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      INSERT INTO [OverseaPOASNManagement].[dbo].[POSSB_Log]
           ([POSysNo]
           ,[Content]
           ,[ActionType]
           ,[InUser]
           ,[Indate]
           ,[ErrMSg]
           ,[ErrMSgTime]
           ,[SendErrMail]
           ,[CompanyCode]
           ,[LanguageCode]
           ,[StoreCompanyCode])
     VALUES
           (@POSysNo
           ,@Content
           ,@ActionType
           ,@InUser
           ,GETDATE()
           ,@ErrMSg
           ,@ErrMSgTime
           ,@SendErrMail
           ,@CompanyCode
           ,@LanguageCode
           ,@StoreCompanyCode)
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@Content" dbType="String" />
      <param name="@ActionType" dbType="StringFixedLength" />
      <param name="@InUser" dbType="Int32" />
      <param name="@ErrMSg" dbType="String" />
      <param name="@ErrMSgTime" dbType="DateTime" />
      <param name="@SendErrMail" dbType="StringFixedLength" />
      <param name="@CompanyCode" dbType="StringFixedLength" />
      <param name="@LanguageCode" dbType="StringFixedLength" />
      <param name="@StoreCompanyCode" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateMailAddressByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         UPDATE TOP (1)  [IPP3].[dbo].[PO_Master]
         SET MailAddress = @MailAddress,HasSendMail=1
         WHERE  [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@MailAddress" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetMailAddressByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT TOP 1 (MailAddress) FROM  [IPP3].[dbo].[PO_Master] WITH(NOLOCK)
        WHERE  [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			  UPDATE [IPP3].[dbo].[PO_Master]
			   SET [InstockAmt] = ISNULL(@TotalAmt,0)
				  ,[Status] =@Status
				  ,[UsingReturnPoint] = ISNULL(@UsingReturnPoint,0)
          ,[CloseUser] = @CloseUser
          ,[CloseTime] = @CloseTime
			 WHERE  SysNo = @POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@Status" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Int32" />
      <param name="@CloseUser" dbType="String" />
      <param name="@CloseTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="ConfirmVendorPortalPO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE  [IPP3].[dbo].[PO_Master]
        SET
           VendorSysNo = @VendorSysNo
          ,StockSysNo = @StockSysNo
          ,ShipTypeSysNo = @ShipTypeSysNo
          ,PayTypeSysNo = @PayTypeSysNo
          ,CurrencySysNo = @CurrencySysNo
          ,ExchangeRate = @ExchangeRate
          ,TotalAmt = @TotalAmt
          ,ETP = @ETP
          ,Status = @Status
          ,IsConsign = @IsConsign
          ,POType = @POType
          ,PM_ReturnPointSysNo = @PM_ReturnPointSysNo
          ,UsingReturnPoint = @UsingReturnPoint
          ,ReturnPointC3SysNo = @ReturnPointC3SysNo
          ,TaxRate = @TaxRate
          ,SettlementCompany = @SettlementCompany
          ,ExecptStatus = @ExecptStatus
          ,PMSysNo = @PMSysNo
          ,PMRequestMemo = @PMRequestMemo
          ,TLRequestMemo = @TLRequestMemo
          ,Memo = @Memo
          ,Note = @Note
          ,InTime = @InTime
          ,ETATime = @ETATime
          ,ETAHalfDay = @ETAHalfDay
          ,ITStockSysNo = @ITStockSysNo
          ,POID = @POID
          ,CreateTime = @CreateTime
          ,CreateUserSysNo = @CreateUserSysNo
        WHERE [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@POID" dbType="String" />
      <param name="@CreateTime" dbType="DateTime" />
      <param name="@StockSysNo" dbType="Int32" />
      <param name="@ShipTypeSysNo" dbType="Int32" />
      <param name="@PayTypeSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
      <param name="@ExchangeRate" dbType="Decimal" />
      <param name="@TotalAmt" dbType="Decimal" />
      <param name="@ETP" dbType="DateTime" />
      <param name="@Status" dbType="Int32" />
      <param name="@IsConsign" dbType="Int32" />
      <param name="@POType" dbType="Int32" />
      <param name="@PM_ReturnPointSysNo" dbType="Int32" />
      <param name="@UsingReturnPoint" dbType="Decimal" />
      <param name="@ReturnPointC3SysNo" dbType="Int32" />
      <param name="@TaxRate" dbType="Decimal" />
      <param name="@PMSysNo" dbType="Int32" />
      <param name="@SettlementCompany" dbType="Int32" />
      <param name="@ExecptStatus" dbType="Int32" />
      <param name="@Memo" dbType="String" />
      <param name="@Note" dbType="String" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@InTime" dbType="DateTime" />
      <param name="@ETATime" dbType="String" />
      <param name="@ETAHalfDay" dbType="String" />
      <param name="@ITStockSysNo" dbType="Int32" />
      <param name="@CreateUserSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryProductLastPOPrice" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT *
FROM  OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1 pl WITH(NOLOCK)
WHERE pl.ProductSysNo=@ProductSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SearchPOBatchNumberList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(1)
      FROM OverseaInventoryManagement.dbo.V_INM_ProductBatch batch WITH(NOLOCK)
      #StrWhere#

        SELECT BatchNumber AS BatchInfoNumber
       ,ProductSysNo
       ,ExpDate AS  DtBatchInfoPassTime
       ,MfgDate AS DtBatchInfoCreateTime
       ,Status
       ,AvaliableQty
       ,DtBatchInfoInTimer
       ,BatchInfoFactory
       ,BatchInfoStockNumber
       ,StockSysNo
       ,StockName AS StockSysNoString
       ,BatchInfoMaxDay
        FROM
        (
	          select TOP (@EndNumber)
	                batch.BatchNumber
				         ,batch.ProductSysNo
				         ,batch.ExpDate
				         ,batch.MfgDate
				         ,batch.Status
				         ,batch.AvaliableQty
                 ,batch.InDate AS DtBatchInfoInTimer
                 ,batch.LotNo AS BatchInfoFactory
                 ,batch.AvaliableQty AS BatchInfoStockNumber
                 ,batch.StockSysNo
                 ,b.StockName
                 ,c.MaxDeliveryDays AS BatchInfoMaxDay
	               ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
	         FROM OverseaInventoryManagement.dbo.V_INM_ProductBatch batch WITH(NOLOCK)
           LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Stock b WITH(NOLOCK)  ON b.SysNo = batch.StockSysNo
           LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_BatchManagementInfo c WITH(NOLOCK)
           ON c.ProductSysNo = batch.ProductSysNo
           #StrWhere#
        )RESULT WHERE RowNumber > @StartNumber
			]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePoItemBatchInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         UPDATE IPP3.dbo.PO_Item
         SET BatchInfo = @BatchInfo
         WHERE SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@BatchInfo" dbType="String" />
    </parameters>
  </dataCommand>



  <dataCommand name="CheckReturnPurchaseOrderValid" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
	     [WarehouseSysNumber]
      ,[ItemSysNumber]
      ,[AccountQty]
      ,[AvailableQty]
      ,[AllocatedQty]
      ,[OrderQty]
      ,[ConsignQty]
      ,[VirtualQty]
      ,[PurchaseQty]
      ,[DMSValue]
      ,[ShiftInQty]
      ,[ShiftOutQty]
       FROM OverseaInventoryManagement.dbo.V_INM_Inventory_Stock WITH(NOLOCK)
       #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPOHistoryAbsentInvoiceOrWaitingInStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       --PO 单已经付款，但发票没到，且付款日期在30天以前
      SELECT
        Pay.OrderSysNo
        ,Max(PayItem.PayTime) as 'PayTime'
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_Pay Pay with (nolock)
      INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PayItem PayItem with (nolock) on Pay.SysNo=PayItem.PaySysNo
      INNER JOIN IPP3.dbo.PO_Master PO with (nolock) on Pay.OrderSysNo=PO.SysNo
      WHERE Pay.OrderType = 0 and Pay.PayStatus=2 and Pay.InvoiceStatus=0 and pay.OrderAmt!=0
      AND PO.VendorSysNo=@VendorSysNo
      AND Pay.CompanyCode = @CompanyCode
      GROUP BY Pay.OrderSysNo having Max(PayItem.PayTime)<getdate()-30 order by Max(PayItem.PayTime)

      --PO 单已经付款，付款日期在7天以前，但是PO还没有入库的
      SELECT
        Pay.OrderSysNo
        ,Max(PayItem.PayTime) as 'PayTime'
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_Pay Pay with (nolock)
      INNER JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PayItem PayItem with (nolock) on Pay.SysNo=PayItem.PaySysNo
      INNER JOIN IPP3.dbo.PO_Master PO with (nolock) on Pay.OrderSysNo=PO.SysNo
      WHERE Pay.OrderType = 0 and Pay.PayStatus=2 and PO.Status=@Status
      AND PO.VendorSysNo=@VendorSysNo AND Pay.CompanyCode = @CompanyCode
      GROUP BY Pay.OrderSysNo having Max(PayItem.PayTime)<getdate()-7 order by Max(PayItem.PayTime)
			]]>
    </commandText>
    <parameters>
      <param name="@VendorSysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetJDPrice" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[     
     
            SELECT JDPrice
            FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo  WITH(NOLOCK) 
            WHERE SysNo = @ProductSysNo              
      
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductLastOrderPrice" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT  LastPrice 
				FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1  WITH (NOLOCK)
				WHERE ProductSysNo = @ProductSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="IsBatchProductInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT SysNo AS  ProductSysNo
      FROM OverseaContentManagement.dbo.V_IM_Product_Ex pe WITH(nolock)
      WHERE pe.IsBatch = 'Y' AND pe.SysNo = @PreviousProductSysNo
  		]]>
    </commandText>
    <parameters>
      <param name="@PreviousProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductAccessoriesByProductSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
WITH temp as
(
  SELECT
  Product.ProductID,
  Accessories.AccessoriesName
  FROM  OverseaContentManagement.dbo.V_CM_Product_Accessories Product_Accessories WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH(NOLOCK)
  ON Product_Accessories.ProductSysno = Product.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_CM_Accessories Accessories WITH(NOLOCK)
  ON Product_Accessories.AccessoriesSysno = Accessories.Sysno
  #StrWhere# OtherCondition
  UNION ALL
  SELECT
  item.ProductID,
  product.BriefName AS AccessoriesName
  FROM  OverseaContentManagement.dbo.V_IM_Product_Attachment atc WITH(NOLOCK)
  INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo item WITH(NOLOCK)
  ON atc.ProductSysno = item.SysNo
  INNER JOIN OverseaContentManagement.dbo.V_IM_Product product WITH(NOLOCK)
  ON atc.ProductAttachmentSysNo = product.Sysno
  WHERE  product.status = 2 AND #CustomCondition#
)
SELECT row_number() OVER(ORDER BY ProductID) as rowNumber
,ProductID
,STUFF
(
  (
        SELECT ' '+ltrim(rtrim(AccessoriesName)
  )
  FROM temp t WHERE ProductID=temp.ProductID FOR XML PATH('')), 1, 1, ''
) as Description
FROM temp GROUP BY ProductID
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetProduct_LastPOInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
    SELECT
    LastVendorSysNo,
    LastPrice,
    ProductSysNo
    FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo_V1 WITH (NOLOCK)
    WHERE ProductSysNo = @ProductSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SetPoStatueIsClose" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      UPDATE ipp3.dbo.PO_Master
      SET 
         Status = 8
        ,[CloseUser] = @CloseUser
        ,[CloseTime] = @CloseTime
      WHERE SysNo = @PoSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@PoSysNo" dbType="Int32" />
      <param name="@CloseUser" dbType="String" />
      <param name="@CloseTime" dbType="DateTime" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdatePOStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE [IPP3].[dbo].[PO_Master]
          Set
			  Status=@Status,
			  RefuseMemo=@RefuseMemo,
		      TPStatus=@TPStatus,
			  AuditUserSysNo=@AuditUserSysNo,
			  TLRequestMemo=@TLRequestMemo,
			  PMRequestMemo=@PMRequestMemo
		  Where SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@RefuseMemo" dbType="String" />
      <param name="@TLRequestMemo" dbType="String" />
      <param name="@PMRequestMemo" dbType="String" />
      <param name="@TPStatus" dbType="AnsiStringFixedLength" />
      <param name="@Status" dbType="Int32" />
      <param name="@AuditUserSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetWHReceiptSNBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      [WHReceiptSN]
      FROM IPP3.dbo.po_master
      WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SetPoMasterToAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      UPDATE ipp3.dbo.PO_Master
      SET InstockAmt =ISNULL(f.sumTotalAmt,0)
      FROM  IPP3.dbo.PO_Master
      INNER JOIN 
      (
	        SELECT c.purno
		            ,SUM(c.TotalAmt) AS sumTotalAmt
	        FROM
	        scm.dbo.poLog c WITH (nolock) INNER JOIN ipp3.dbo.PO_Master a WITH (nolock) 
	        ON c.purno = a.SysNo AND a.Status = 6 AND a.SysNo = @PoSysNo
	        GROUP BY c.purno
      )f
      ON PO_Master.SysNo = f.purno
      WHERE PO_Master.SysNo = @PoSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@PoSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateWHReceiptSN" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE  [IPP3].[dbo].[PO_Master]
        SET WHReceiptSN = @WHReceiptSN
        WHERE
           [SysNo] = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@WHReceiptSN" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="RetreatVendorPortalPO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        DELETE FROM  [IPP3].[dbo].[PO_Master]
        WHERE [SysNo] = @SysNo 
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetNeedClosePoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
       SELECT  a.SysNo AS SysNo
              ,a.Status AS [PurchaseOrderBasicInfo.PurchaseOrderStatus]
      FROM ipp3.dbo.PO_Master a WITH (nolock) INNER JOIN
      Scm.dbo.poLog b WITH(NOLOCK)
      ON a.sysno = b.Purno AND a.Status = 6  AND b.batch = 1
      WHERE DateDiff(hour,b.recdate,getdate()) >12
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetNeedSendEmailPO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      SELECT a.SysNo
            ,a.CreateUserSysNo
            ,a.MailAddress
            ,a.PMSysNo
            ,b.UserSysNo
            ,b.EmailAddress AS PMEmail
            ,c.EmailAddress AS CreateEmail
      FROM 
      IPP3.dbo.PO_Master a 
      LEFT  JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] b WITH (nolock) ON a.PMSysNo = b.UserSysNo 
      LEFT  JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] c WITH (nolock) ON a.CreateUserSysNo = c.UserSysNo
      WHERE a.SysNo = @PoSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@PoSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductAccessoriesByPOSysno" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT
			  Product.ProductID
			  ,Accessories.AccessoriesID
			  ,Accessories.AccessoriesName as AccessoriesIDAndName
			  ,Product_Accessories.Qty
      FROM  OverseaContentManagement.dbo.V_CM_Product_Accessories Product_Accessories WITH(NOLOCK)
      INNER JOIN IPP3.dbo.PO_Item po_item WITH(NOLOCK)
			  ON Product_Accessories.ProductSysno = po_item.ProductSysNo
      INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo Product WITH(NOLOCK)
			  ON Product_Accessories.ProductSysno = Product.SysNo
      INNER JOIN OverseaContentManagement.dbo.V_CM_Accessories Accessories WITH(NOLOCK)
			  ON Product_Accessories.AccessoriesSysno = Accessories.Sysno
      WHERE po_item.POSysNo = @POSysNo
		    AND Product_Accessories.Status = 0
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="QueryItemStockInfoList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
  SELECT
            p.ProductSysNo
           ,k.SHHaveStockNumber
           ,k.BJHaveStockNumber
           ,k.GZHaveStockNumber
           ,k.WHHaveStockNumber
           ,k.CDHaveStockNumber
           ,h.SHWaitInStockNumber
           ,h.BJWaitInStockNumber
           ,h.GZWaitInStockNumber
           ,h.WHWaitInStockNumber
           ,h.CDWaitInStockNumber
           ,m.SHWaitCheckNumber
           ,m.BJWaitCheckNumber
           ,m.GZWaitCheckNumber
           ,m.WHWaitCheckNumber
           ,m.CDWaitCheckNumber
          -- ,( isnull(g.WHSheftOnRoadNumber,0) + isnull( k.WHHaveStockNumber,0)) AS WHOnRoadNumber
          -- ,( isnull(g.GZSheftOnRoadNumber,0) + isnull( k.GZHaveStockNumber,0) ) AS GZOnRoadNumber
         --  ,( isnull(g.SHSheftOnRoadNumber,0) + isnull( k.SHHaveStockNumber,0) ) AS SHOnRoadNumber
          -- ,( isnull(g.BJSheftOnRoadNumber,0) + isnull(k.BJHaveStockNumber,0) ) AS BJOnRoadNumber
         --  ,( isnull(g.CDSheftOnRoadNumber,0) + isnull(k.CDHaveStockNumber,0) ) AS CDOnRoadNumber
        FROM
              --产品列表
         (
                SELECT
                    SysNo AS ProductSysNo
                FROM OverseaContentManagement.dbo.V_IM_Product  WITH(NOLOCK)
                WHERE
                    SysNo IN (@ProductSysNos)
             ) p
        LEFT JOIN (
              --移仓在途
         SELECT
                b.ProductSysNo AS ProductSysNo
               ,SUM(CASE a.StockSysNoB
                    WHEN 55 THEN b.ShiftQty
                    ELSE 0
                END ) AS WHSheftOnRoadNumber
               ,SUM(CASE a.StockSysNoB
                    WHEN 53 THEN b.ShiftQty
                    ELSE 0
                END ) AS GZSheftOnRoadNumber
               ,SUM(CASE a.StockSysNoB
                    WHEN 51 THEN b.ShiftQty
                    WHEN 59 THEN b.ShiftQty
                    ELSE 0
                END ) AS SHSheftOnRoadNumber
               ,SUM(CASE a.StockSysNoB
                    WHEN 52 THEN b.ShiftQty
                    ELSE 0
                END ) AS BJSheftOnRoadNumber
               ,SUM(CASE a.StockSysNoB
                    WHEN 54 THEN b.ShiftQty
                    ELSE 0
                END ) AS CDSheftOnRoadNumber
            FROM OverseaInventoryManagement.dbo.V_INM_Shift a WITH(NOLOCK)
            INNER JOIN OverseaInventoryManagement.dbo.V_INM_ShiftItem b WITH(NOLOCK)
                ON b.ShiftSysNo = a.SysNo
            WHERE
                b.ProductSysNo IN(@ProductSysNos)
                AND a.Status = 2
            GROUP BY b.ProductSysNo
         )g
            ON g.ProductSysNo = p.ProductSysNo
        LEFT  JOIN (
              --已采购数量
         SELECT
                b.ProductSysNo
               ,SUM(CASE
                    WHEN a.StockSysNo IN(51,59) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS SHHaveStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo= 52 OR (a.StockSysNo=50 AND a.ITStockSysNo=52) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS BJHaveStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 53 OR (a.StockSysNo=50 AND a.ITStockSysNo=53) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS GZHaveStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 55 OR (a.StockSysNo=50 AND a.ITStockSysNo=55) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS WHHaveStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo IN(54) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS CDHaveStockNumber
            FROM ipp3.dbo.PO_Master a WITH(NOLOCK)
            INNER JOIN ipp3.dbo.PO_Item b WITH(NOLOCK)
                ON a.SysNo = b.POSysNo
            WHERE
                a.Status IN (5,3,6)
                AND b.ProductSysNo IN(@ProductSysNos)
            GROUP BY b.ProductSysNo
         )k
            ON k.ProductSysNo = p.ProductSysNo
        LEFT  JOIN (
              --待入库数量
         SELECT
                b.ProductSysNo
               ,SUM(CASE
                    WHEN a.StockSysNo IN(51,59) THEN b.PurchaseQty  - b.Quantity
                    ELSE 0
                END) AS SHWaitInStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo=52 OR (a.StockSysNo=50 AND a.ITStockSysNo=52) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS BJWaitInStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 53 OR (a.StockSysNo=50 AND a.ITStockSysNo=53) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS GZWaitInStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 55 OR (a.StockSysNo=50 AND a.ITStockSysNo=55) THEN b.PurchaseQty - b.Quantity
                    ELSE 0
                END) AS WHWaitInStockNumber
               ,SUM(CASE
                    WHEN a.StockSysNo IN(54) THEN b.PurchaseQty  - b.Quantity
                    ELSE 0
                END) AS CDWaitInStockNumber
            FROM ipp3.dbo.PO_Master a WITH(NOLOCK)
            INNER JOIN ipp3.dbo.PO_Item b WITH(NOLOCK)
                ON a.SysNo = b.POSysNo
            WHERE
                a.Status IN (3,6)
                AND b.ProductSysNo IN(@ProductSysNos)
            GROUP BY b.ProductSysNo
         )h
            ON h.ProductSysNo = p.ProductSysNo
        LEFT JOIN (
              --待审核数量
         SELECT
                b.ProductSysNo
               ,SUM(CASE
                    WHEN a.StockSysNo IN(51,59) THEN b.PurchaseQty
                    ELSE 0
                END) AS SHWaitCheckNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 52 OR (a.StockSysNo=50 AND a.ITStockSysNo = 52)  THEN b.PurchaseQty
                    ELSE 0
                END) AS BJWaitCheckNumber
               ,SUM(CASE
                    WHEN a.StockSysNo = 53 OR (a.StockSysNo=50 AND a.ITStockSysNo=53) THEN b.PurchaseQty
                    ELSE 0
                END) AS GZWaitCheckNumber
               ,SUM(CASE
                    WHEN a.StockSysNo=55 OR (a.StockSysNo=50 AND a.ITStockSysNo=55) THEN b.PurchaseQty
                    ELSE 0
                END) AS WHWaitCheckNumber
               ,SUM(CASE
                    WHEN a.StockSysNo IN(54) THEN b.PurchaseQty
                    ELSE 0
                END) AS CDWaitCheckNumber
            FROM ipp3.dbo.PO_Master a WITH(NOLOCK)
            INNER JOIN ipp3.dbo.PO_Item b WITH(NOLOCK)
                ON a.SysNo = b.POSysNo
            WHERE
                a.Status =5
                AND b.ProductSysNo IN(@ProductSysNos)
            GROUP BY b.ProductSysNo
         ) m
            ON m.ProductSysNo = p.ProductSysNo
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPMSaleInfor" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
        SaleRatePerMonth
        ,SaleTargetPerMonth
        ,MaxAmtPerDay
        ,TLSaleRatePerMonth
        ,MaxAmtPerOrder
		,PMDMaxAmtPerOrder
		,PMDMaxAmtPerDay
        FROM OverseaContentManagement.dbo.V_PM_PMList with(nolock)
        WHERE PMUserSysNo = @PMUserSysNo AND CompanyCode = @CompanyCode
			]]>
    </commandText>
    <parameters>
      <param name="@PMUserSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetMinInterestRate" database="NCService"  commandType="Text">
    <commandText>
      <![CDATA[				
       SELECT isnull(MinMargin,0) as MinMargin
            ,isnull(MinMarginPMD,0) as MinMarginPMD
            ,p.SysNo
            ,isnull(pp.CurrentPrice,0) AS CurrentPrice
            ,isnull( pp.Point,0) AS Point
            ,p.ProductID
            ,'' AS Tax
      FROM OverseaContentManagement.dbo.V_IM_Category3 c3 WITH(NOLOCK)
      INNER JOIN OverseaContentManagement.dbo.V_IM_Product p WITH(NOLOCK)
      ON c3.SysNo=p.C3SysNo
      INNER JOIN OverseaContentManagement.dbo.V_IM_Product_Price pp WITH(NOLOCK)
      ON p.SysNo=pp.ProductSysNo    
      WHERE p.SysNo IN (@SysNo)
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetPMInventoryAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
      isnull(sum((i.accountqty ) * pp.unitcost / 1.17 ),0) as amt
      FROM OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK)
      INNER JOIN OverseaInventoryManagement.dbo.V_INM_Inventory i WITH(NOLOCK) on i.ItemSysNumber = p.sysno
      INNER JOIN OverseaContentManagement.dbo.V_CM_ItemPriceInfo pp WITH(NOLOCK) on p.sysno = pp.sysno
      WHERE i.accountqty + i.consignqty > 0 and p.pmusersysno = @pmSysNo and p.CompanyCode = @CompanyCode
			]]>
    </commandText>
    <parameters>
      <param name="@pmSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetC2TotalAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT CP.C2SysNo AS C2SysNo
      ,isnull(a.C2InventoryAmt,0) AS C2InventoryAmt
      ,isnull(CP.Quota,0) AS Quota
      FROM IPP3.dbo.Category2_Property CP WITH (NOLOCK)
      LEFT JOIN 
      (
        SELECT sum(i.AccountQty*PP.UnitCost) AS C2InventoryAmt,
               c3.C2SysNo
        FROM OverseaInventoryManagement.dbo.V_INM_Inventory i WITH  (NOLOCK)
        INNER JOIN OverseaContentManagement.dbo.V_IM_Product_Price PP WITH  (NOLOCK)	
        ON i.ProductSysNo=pp.ProductSysNo
        INNER JOIN OverseaContentManagement.dbo.V_IM_Product p WITH(NOLOCK)
        ON p.SysNo = PP.ProductSysNo
        INNER JOIN OverseaContentManagement.dbo.V_IM_Category3 c3 WITH(Nolock)
        ON c3.SysNo = p.C3SysNo
        WHERE c3.C2SysNo IN (@C2SysNo)
        GROUP BY c3.C2SysNo
      ) a
      ON a.C2SysNo = CP.C2SysNo
      WHERE cp.C2SysNo IN (@C2SysNo) 
      AND isnull(a.C2InventoryAmt,0)>isnull(CP.Quota,0)
			]]>
    </commandText>
  </dataCommand>

  <!--For Invoice Start-->
  <dataCommand name="GetPurchaseOrderReturnPointSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT PM_ReturnPointSysNo
				FROM IPP3.dbo.PO_Master WITH(NOLOCK)
				WHERE SysNo=@SysNo
	        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetPurchaseOrderSysNoListByVendorSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT SysNo FROM [IPP3].[dbo].[PO_Master] WITH (NOLOCK)
#StrWhere#
	        ]]>
    </commandText>
  </dataCommand>
  <!--For Invoice End-->

  <dataCommand name="AbandonPOForJob" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      UPDATE IPP3.dbo.PO_Master 
			 SET [Status]=-1,AbandonTime=getdate()
			WHERE SysNo=@SysNo 
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="AbandonETAForJob" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
      UPDATE [IPP3].[dbo].[PO_ETA]
			   SET [STATUS]=-1
			WHERE [POSysNo]=@SysNo
				AND [STATUS]=1
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateExtendPOInfo" database="OverseaPOASNManagement" commandType="Text">
    <commandText>
      <![CDATA[				
      DECLARE @UnitCost decimal(19,6)
      DECLARE @CurrentPrice decimal(19,6)
      DECLARE @lastOrderPrice decimal(19,6)
      DECLARE @LastInTime datetime
      DECLARE @m1 int
      DECLARE @JDPrice decimal(19,6)
      DECLARE @LastAdjustPriceDate datetime
	    DECLARE @AvailableQty int	
      SET 
      @UnitCost = 
          (
            SELECT TOP 1 UnitCost AS CurrentUnitCost
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK) 
            WHERE ProductSysNo = @ProductSysNo 
          )
      SET
      @CurrentPrice = 
          (
            SELECT TOP 1 CurrentPrice
            FROM IPP3.[dbo].Product_Price  WITH (NOLOCK) 
            WHERE ProductSysNo = @ProductSysNo 
          )
      SET
      @lastOrderPrice=
          (
            SELECT TOP 1 LastPrice AS lastOrderPrice
            FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo  WITH (NOLOCK) 
            WHERE ProductSysNo = @ProductSysNo 
          )
      SET
      @LastInTime = 
          (
            SELECT TOP 1 LastInTime
            FROM OverseaContentManagement.dbo.V_CM_Product_LastPOInfo  WITH (NOLOCK) 
            WHERE ProductSysNo = @ProductSysNo 
          )
      SET
      @AvailableQty =
          (
            SELECT TOP 1 AvailableQty 
			FROM OverseaInventoryManagement.dbo.V_INM_Inventory WITH(NOLOCK)
            WHERE ItemSysNumber = @ProductSysNo 
          )
      SET
      @M1=
          (
            SELECT TOP 1 [m1] 
			FROM [OverseaContentManagement].[dbo].[V_CM_ItemSaleTrendInfo]  WITH (NOLOCK) 
            WHERE ProductSysNo = @ProductSysNo 
          )
      SET
      @JDPrice=
          (  
            SELECT TOP 1 JDPrice 
			FROM OverseaContentManagement.dbo.V_CM_ItemCommonInfo  WITH(NOLOCK) 
            WHERE SysNo = @ProductSysNo 
          )
      SET
      @LastAdjustPriceDate = 
          (
            SELECT TOP 1 CreateDate AS LastAdjustPriceDate 
			FROM OverseaContentManagement.dbo.V_IM_ProductPricechangeLog WITH(NOLOCK)
            WHERE ProductSysNo = @ProductSysNo
            ORDER BY CreateDate DESC
          )
          
      UPDATE IPP3.[dbo].PO_Item
      SET CurrentUnitCost = @UnitCost,
          CurrentPrice = @CurrentPrice,
          lastOrderPrice = @lastOrderPrice,
          LastInTime = @LastInTime,
          AvailableQty = @AvailableQty,
          m1 = @m1,
          JDPrice = @JDPrice,
          LastAdjustPriceDate = @LastAdjustPriceDate
      WHERE SysNo=@SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  <dataCommand name="GetPOItemsByHasPagePOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     SELECT 
		 item.[SysNo]
    ,item.BatchInfo
		,item.[POSysNo]
		,item.[ProductSysNo]
		,item.[Quantity]
		,item.[Weight]
		,item.[OrderPrice]
		,item.[ApportionAddOn]
		,item.[BriefName]
		,item.[ReturnCost]
		,item.[PurchaseQty]
		,item.[CheckStatus]
		,item.[CheckReasonMemo]
		,item.[ExecptStatus]
		,product.[ProductID]
		,item.[UnitCostWithoutTax]
		,item.[JDPrice]
		,item.[AvailableQty]
		,item.[m1]
		,item.[UnitCost]
		,item.[CurrentUnitCost]
		,item.[CurrentPrice]
		,item.[LastAdjustPriceDate]
		,item.[lastOrderPrice]
		,item.[LastInTime]
    ,item.AcquireReturnPointType 
    ,item.AcquireReturnPoint 
    ,item.ReadyQuantity 
		,product.ProductMode
		,product.ProductName
		--,product.CurrentPrice
		,isnull(shs.ConsignQty,0) + isnull(shs.AvailableQty,0) + isnull(shs59.ConsignQty,0) + isnull(shs59.AvailableQty,0) as ShInventoryStock
		,isnull(bjs.ConsignQty,0) + isnull(bjs.AvailableQty,0) as bjInventoryStock
		,isnull(whs.ConsignQty,0) + isnull(whs.AvailableQty,0) as whInventoryStock
    ,isnull(gzs.ConsignQty,0) + isnull(gzs.AvailableQty,0) as GZInventoryStock
    ,isnull(cds54.ConsignQty,0) + isnull(cds54.AvailableQty,0) as CDInventoryStock
		,isnull(product.Week1SalesCount,0) Week1SalesCount
		,isnull(shf.ShiftQty,0) ShiftQty
    ,isnull(v_pps.PurchasePrice,0) PurchasePrice
    ,product.Vfitem 
    ,productPrice.VirtualPrice AS VirtualPrice
    ,proEx.IsBatch AS IsBatch
    ,(ROW_NUMBER() OVER(ORDER BY item.sysno desc)) AS RowNumber
	FROM IPP3.dbo.PO_Item as item WITH (NOLOCK)
	LEFT JOIN OverseaContentManagement.dbo.V_CM_ItemCommonInfo as product WITH (NOLOCK) 
	ON product.SysNo = item.[ProductSysNo]   
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs WITH(NOLOCK)
	ON shs.ProductSysNo = item.[ProductSysNo] and shs.stockSysNo in (51)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock shs59 WITH(NOLOCK)
	ON shs59.ProductSysNo = item.[ProductSysNo] and shs59.stockSysNo in (59)
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock cds54 WITH(NOLOCK)
	ON cds54.ProductSysNo = item.[ProductSysNo] and cds54.stockSysNo in (54)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock bjs  WITH(NOLOCK)
	ON bjs.ProductSysNo = item.[ProductSysNo] and bjs.stockSysNo in (52)
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock whs  WITH(NOLOCK)
	ON whs.ProductSysNo = item.[ProductSysNo] and whs.stockSysNo in (55)  
  LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory_Stock gzs  WITH(NOLOCK)
	ON gzs.ProductSysNo = item.[ProductSysNo] and gzs.stockSysNo in (53) 
	LEFT JOIN OverseaInventoryManagement.dbo.V_INM_Inventory shf WITH(NOLOCK)
	ON shf.ProductSysNo = Item.[ProductSysNo]        
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_Mapping as v_mapping WITH (NOLOCK) 
  ON v_mapping.ProductSysno = item.ProductSysNo AND v_mapping.PartnerType NOT IN('D','T','M')
  LEFT JOIN OverseaContentManagement.dbo.V_CM_Product3Party_SynProduct v_pps WITH(NOLOCK)
  ON v_pps.ProductMappingSysNo = v_mapping.SysNo  
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Price productPrice WITH(NOLOCK) 
  ON  productPrice.ProductSysNo = product.SysNo 
  LEFT JOIN OverseaContentManagement.dbo.V_IM_Product_Ex proEx WITH(NOLOCK)
  ON proEx.PreviousProductSysNo = product.SysNo
  where 
          item.POSysNo=@POSysNo
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetProductSysNoByPOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
SELECT
	ProductSysNo
FROM 
	IPP3.DBO.PO_ITEM WITH(NOLOCK)
WHERE
	POSYSNO=@POSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@POSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GetCostQuantity" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[				
          SELECT
	           	ISNULL(sum(c.LeftQuantity-c.LockQuantity),0)
            FROM 
	             OverseaInventoryManagement.dbo.ProductCostIn c WITH(NOLOCK)
            WHERE
	            c.ProductSysNo=@ProductSysNo and Cost=@Cost and WarehouseNumber=@WarehouseNumber
			]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@Cost" dbType="Decimal" />
      <param name="@WarehouseNumber" dbType="Int32" />
    </parameters>
  </dataCommand>
  
</dataOperations>