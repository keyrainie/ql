<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">


  <dataCommand name="GetSaleIncomeSOList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      #tempTab1#
      SELECT	@TotalCount = COUNT(fs.SysNo)
			 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
       	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
			  INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
			  LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
				  ON sc.sosysno = fs.ordersysno
        LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
			#StrWhere#

      SELECT
        	 SysNo
          ,CompanyCode
          ,CustomerSysNo
				  ,IncomeStyle
				  ,OrderType
				  ,OrderAmt
				  ,IncomeAmt
				  ,PrepayAmt
				  ,GiftCardPayAmt
				  ,RefundGiftCard
				  ,IncomeUser
				  ,IncomeTime
				  ,ConfirmUser
				  ,ConfirmTime
				  ,OrderID
				  ,OrderSysNo
          ,ShipTotal
				  ,IncomeStatus
				  ,ShipPrice
				  ,ShippingFee
				  ,PackageFee
				  ,RegisteredFee
				  ,ShipCost
				  ,OutTime
				  ,RelatedSoSysNo
				  ,ReferenceID
				  ,ReturnCashAmt
				  ,ReturnPointAmt
				  ,ToleranceAmt
          ,SAPReturnCashAmt
				  ,SAPReturnPointAmt
				  ,SAPToleranceAmt
				  ,SOSysNo
				  ,BankName
				  ,BranchBankName
				  ,CardNumber
				  ,CardOwnerName
				  ,PostAddress
				  ,PostCode
				  ,ReceiverName
				  ,RMARefundPayType
          ,RefundPayTypeSysNo
          ,PayTypeSysNo
          ,PayTypeName
          ,SOStatus
          ,IsOutStock
          ,IsCombine
          ,ShipTypeName
          ,DeliveryManName
          ,MasterSoSysNo
          ,SAPImportedDate
          ,SAPDocNo
          ,SapImportedStatus
          ,SapInFailedReason
          ,SAPPostDate
          ,PayedDate
          ,PointPayAmt
          ,TariffAmt
          ,CostAmout
          ,ProductPrice
          ,PomotionAmt
          
           INTO #tmp
          
        FROM (SELECT TOP (@EndNumber)
					  fs.SysNo
           ,fs.CompanyCode
           ,fs.CustomerSysNo
				   ,fs.IncomeStyle
				   ,fs.OrderType
				   ,fs.OrderAmt
				   ,fs.IncomeAmt
				   ,fs.PrepayAmt
				   ,fs.GiftCardPayAmt
				   ,fsb.RefundGiftCard
				   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS IncomeUser
				   ,fs.IncomeTime
				   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS ConfirmUser
				   ,fs.ConfirmTime
				   ,fs.OrderID
				   ,fs.fsOrderSysNo AS OrderSysNo
           ,fs.shipprice AS ShipTotal
				   ,fs.status AS IncomeStatus
				   ,fs.ShipPrice
				   ,sc.ShippingFee
				   ,sc.PackageFee
				   ,sc.RegisteredFee
				   ,sc.ShipCost
				   ,CASE sc.IsCombine
				   WHEN 0 THEN fs.OutTime
				   WHEN 1 THEN sc.MergeCompleteTime
				   ElSE NULL
				   END AS OutTime
				   ,CASE netPay.[Status]
				   WHEN 1 THEN netPay.RelatedSoSysNo
				   ELSE NULL
				   END AS RelatedSoSysNo
				   ,fs.ReferenceID
				   ,fsb.RefundCashAmt AS ReturnCashAmt
				   ,fsb.RefundPoint AS ReturnPointAmt
				   ,fsb.ToleranceAmt
           ,fsb.RefundCashAmt AS SAPReturnCashAmt
				   ,fsb.RefundPoint AS SAPReturnPointAmt
				   ,fsb.ToleranceAmt AS SAPToleranceAmt
				   ,fs.OrderSysNo AS SOSysNo
				   ,NULL AS BankName
				   ,NULL AS BranchBankName
				   ,NULL AS CardNumber
				   ,NULL AS CardOwnerName
				   ,NULL AS PostAddress
				   ,NULL AS PostCode
				   ,NULL AS ReceiverName
				   ,fsb.refundpaytype AS RMARefundPayType
           ,fsb.refundpaytype AS RefundPayTypeSysNo
           ,fs.PayTypeSysNo AS PayTypeSysNo
           ,paytype.PayTypeName AS PayTypeName
           ,fs.SOStatus
           ,CASE
              WHEN fs.SOStatus=4 THEN '是'
              ELSE '否'
              END AS IsOutStock
          ,sc.IsCombine AS IsCombine
          ,ST.ShipTypeName
          ,sucu2.DisplayName as DeliveryManName
          ,fs.MasterSoSysNo AS MasterSoSysNo
          ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
          ,fs.SAPImportedDate
          ,fs.SAPDocNo
          ,fs.SapImportedStatus
          ,fs.SapInFailedReason
          ,fs.SAPPostDate
          ,fs.PayedDate
          ,fs.PointPayAmt
          ,fs.TariffAmt
          ,(SELECT SUM(Cost*Quantity*ISNULL(ExchangeRate,1)) FROM OverseaInventoryManagement.dbo.ProductCostOUT WITH(NOLOCK) WHERE BillType=20 AND BillSysNo=fs.fsOrderSysNo) AS CostAmout
          ,(SELECT SUM(Price*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS ProductPrice
          ,(SELECT SUM(PromotionDiscount*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS PomotionAmt
			  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
          ON fs.PayTypeSysNo=paytype.SysNo
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno
			  INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
			  LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
				  ON sc.sosysno = fs.ordersysno
        LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
        LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
		LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
			  #StrWhere#)
        result
      WHERE RowNumber > @StartNumber


SELECT #tmp.*,
		0 AS PosPrePay,
		0 AS PosCash,
		0 AS PosBankCard
       FROM #tmp


       SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(fs.shipprice)
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
       LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno
	  INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
      LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
          ON sc.sosysno = fs.ordersysno
      LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
          ON dl.OrderSysNo = fs.fsOrderSysNo
          AND dl.status = 0
          AND dl.ordertype = 1
          #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAOList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT
			@TotalCount = COUNT(fs.SysNo)
			FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
				LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					ON sc.sosysno = fs.ordersysno
				LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype = 3
					AND fsb.ordertype = 3
    #StrWhere#

		SELECT
        SysNo
       ,CompanyCode
       ,CustomerSysNo
		   ,IncomeStyle
		   ,OrderType
       ,OrderAmt
		   ,IncomeAmt
		   ,PrepayAmt
		   ,GiftCardPayAmt
		   ,RefundGiftCard
		   ,IncomeUser
		   ,IncomeTime
		   ,ConfirmUser
		   ,ConfirmTime
		   ,OrderID
		   ,OrderSysNo
       ,ShipTotal
		   ,IncomeStatus
		   ,ShipPrice
		   ,ShippingFee
		   ,PackageFee
		   ,RegisteredFee
		   ,ShipCost
		   ,ReferenceID
		   ,ReturnPointAmt
		   ,ReturnCashAmt
		   ,ToleranceAmt
       ,SAPReturnPointAmt
		   ,SAPReturnCashAmt
		   ,SAPToleranceAmt
		   ,SOSysNo
		   ,BankName
		   ,BranchBankName
		   ,CardNumber
		   ,CardOwnername
		   ,PostAddress
		   ,PostCode
		   ,ReceiverName
		   ,RMARefundPayType
       ,RefundPayTypeSysNo
       ,PayTypeSysNo
       ,PayTypeName
       ,SOStatus
       ,IsOutStock
       ,SAPImportedDate
      ,SAPDocNo
      ,SapImportedStatus
      ,SapInFailedReason
      ,SAPPostDate
      ,0 AS PosPrePay
		  ,0 AS PosCash
		  ,0 AS PosBankCard
      ,NULL AS OutTime
      ,NULL AS PayedDate
      ,NULL AS ProductPrice
      ,NULL AS PointPayAmt 
      ,NULL AS PomotionAmt
      ,NULL AS TariffAmt
		FROM (
				SELECT TOP (@EndNumber)
					  fs.sysno
           ,fs.CompanyCode
           ,fs.CustomerSysNo
				   ,fs.incomeStyle
				   ,fs.ordertype
				   ,fs.orderamt
				   ,fs.incomeamt
				   ,fs.PrepayAmt
				   ,fsb.RefundGiftCard
				   ,fs.GiftCardPayAmt
				   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
				   ,fs.incometime
				   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
				   ,fs.confirmtime
				   ,fs.orderid
				   ,fs.fsordersysno AS ordersysno
           ,fs.shipprice AS ShipTotal
				   ,fs.status AS incomestatus
				   ,fs.shipprice
				   ,sc.shippingfee
				   ,sc.packagefee
				   ,sc.registeredfee
				   ,sc.shipcost
				   ,fs.ReferenceID
				   ,fsb.RefundCashAmt AS ReturnCashAmt
				   ,fsb.RefundPoint AS ReturnPointAmt
				   ,fsb.ToleranceAmt AS ToleranceAmt
           ,fsb.RefundCashAmt AS SAPReturnCashAmt
				   ,fsb.RefundPoint AS SAPReturnPointAmt
				   ,fsb.ToleranceAmt AS SAPToleranceAmt
				   ,fs.OrderSysNo AS SOSysNo
				   ,fsb.bankname AS bankname
				   ,fsb.branchbankname AS branchbankname
				   ,fsb.cardnumber AS cardnumber
				   ,fsb.cardownername AS cardownername
				   ,fsb.postaddress AS postaddress
				   ,fsb.postcode AS postcode
				   ,fsb.receivername AS receivername
				   ,fsb.refundpaytype AS rmarefundpaytype
           ,fsb.RefundPayType AS RefundPayTypeSysNo
           ,fs.PayTypeSysNo AS PayTypeSysNo
           ,paytype.PayTypeName
           ,fs.SOStatus
           ,CASE
              WHEN fs.SOStatus=4 THEN '是'
              ELSE '否'
          END AS IsOutStock
				   ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
           ,fs.SAPImportedDate
	          ,fs.SAPDocNo
	          ,fs.SapImportedStatus
            ,fs.SapInFailedReason
            ,fs.SAPPostDate
				FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
            ON fs.PayTypeSysNo=paytype.SysNo
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					ON sc.sosysno = fs.ordersysno
				LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype = 3
					AND fsb.ordertype = 3 #StrWhere#) RESULT
				WHERE
					RowNumber > @StartNumber

          SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(fs.shipprice)
        FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
				LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					ON sc.sosysno = fs.ordersysno
				LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype = 3
					AND fsb.ordertype = 3
       #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeROList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT @TotalCount = COUNT(fs.sysno)
			FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
      	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype=2
					AND fsb.ordertype=2
      #StrWhere#

			SELECT
			SysNo
      ,CompanyCode
      ,CustomerSysNo
			,IncomeStyle
			,OrderType
      ,OrderAmt
			,IncomeAmt
			,PrepayAmt
			,GiftCardPayAmt
			,RefundGiftCard
			,IncomeUser
			,IncomeTime
			,ConfirmUser
			,ConfirmTime
			,OrderID
			,OrderSysNo
			,IncomeStatus
      ,ShipTotal
			,ShipPrice
			,ShippingFee
			,PackageFee
			,RegisteredFee
			,ShipCost
			,ReferenceID
			,ReturnPointAmt
			,ReturnCashAmt
			,ToleranceAmt
      ,SAPReturnPointAmt
			,SAPReturnCashAmt
			,SAPToleranceAmt
			,SOSysNo
			,BankName
			,BranchBankName
			,CardNumber
			,CardOwnername
			,PostAddress
			,PostCode
			,ReceiverName
			,RMARefundPayType
      ,RefundPayTypeSysNo
       ,PayTypeSysNo
       ,PayTypeName
       ,SOStatus
       ,IsOutStock
       ,SAPImportedDate
	      ,SAPDocNo
	      ,SapImportedStatus
        ,SapInFailedReason
        ,SAPPostDate
      ,0 AS PosPrePay
		  ,0 AS PosCash
		  ,0 AS PosBankCard
      ,NULL AS OutTime
      ,NULL AS PayedDate
      ,NULL AS ProductPrice
      ,NULL AS PointPayAmt 
      ,NULL AS PomotionAmt
      ,NULL AS TariffAmt
			FROM (
				SELECT TOP (@EndNumber)
					 fs.sysno
           ,fs.CompanyCode
           ,fs.CustomerSysNo
				   ,fs.incomeStyle
				   ,fs.ordertype
				   ,fs.orderamt
				   ,fs.incomeamt
				   ,fs.PrepayAmt
				   ,fs.GiftCardPayAmt
				   ,fsb.RefundGiftCard
				   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
				   ,fs.incometime
				   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
				   ,fs.confirmtime
				   ,fs.orderid
				   ,fs.fsOrderSysNo AS ordersysno
				   ,fs.status AS incomestatus
           ,0.0 AS ShipTotal
				   ,0.0 AS shipprice
				   ,0.0 AS shippingfee
				   ,0.0 AS packagefee
				   ,0.0 AS registeredfee
				   ,0.0 AS shipcost
				   ,fs.ReferenceID
				   ,fsb.RefundCashAmt AS ReturnCashAmt
				   ,fsb.RefundPoint AS ReturnPointAmt
				   ,fsb.ToleranceAmt AS ToleranceAmt
           ,0.0 AS SAPReturnCashAmt
				   ,0 AS SAPReturnPointAmt
				   ,0.0 AS SAPToleranceAmt
				   ,fs.SOSysNo AS SOSysNo
				   ,fsb.bankname AS bankname
				   ,fsb.branchbankname AS branchbankname
				   ,fsb.cardnumber AS cardnumber
				   ,fsb.cardownername AS cardownername
				   ,fsb.postaddress AS postaddress
				   ,fsb.postcode AS postcode
				   ,fsb.receivername AS receivername
				   ,fsb.refundpaytype AS rmarefundpaytype
           ,fs.refundpaytype as RefundPayTypeSysNo
           ,NULL AS PayTypeSysNo
           ,NULL AS PayTypeName
           ,NULL AS SOStatus
           ,NULL AS IsOutStock
				   ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
           ,fs.SAPImportedDate
	          ,fs.SAPDocNo
	          ,fs.SapImportedStatus
            ,fs.SapInFailedReason
            ,fs.SAPPostDate
				FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype=2
					AND fsb.ordertype=2 #StrWhere#) RESULT
				WHERE
					RowNumber > @StartNumber

        SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(0.0)
			FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
      	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					ON fsb.ordersysno=fs.ordersysno
					AND fs.ordertype=2
					AND fsb.ordertype=2
      #StrWhere#
		]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeROBalanceList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT
			@TotalCount = COUNT(fs.sysno)
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
						ON fsb.ordersysno=fs.OrderSysNo
						AND fs.ordertype = 4
						AND fsb.ordertype = 4
    #StrWhere#

		SELECT
         SysNo
         ,CompanyCode
         ,CustomerSysNo
			   ,IncomeStyle
			   ,OrderType
         ,OrderAmt
			   ,IncomeAmt
			   ,PrepayAmt
			   ,GiftCardPayAmt
			   ,RefundGiftCard
			   ,IncomeUser
			   ,IncomeTime
			   ,ConfirmUser
			   ,ConfirmTime
			   ,OrderID
			   ,OrderSysNo
			   ,IncomeStatus
         ,ShipTotal
			   ,ShipPrice
			   ,ShippingFee
			   ,PackageFee
			   ,RegisteredFee
			   ,ShipCost
			   ,ReferenceID
			   ,ReturnPointAmt
			   ,ReturnCashAmt
			   ,ToleranceAmt
         ,SAPReturnPointAmt
			   ,SAPReturnCashAmt
			   ,SAPToleranceAmt
			   ,SOSysNo
			   ,BankName
			   ,BranchBankName
			   ,CardNumber
			   ,CardOwnername
			   ,PostAddress
			   ,PostCode
			   ,ReceiverName
			   ,RMARefundPayType
         ,RefundPayTypeSysNo
         ,PayTypeSysNo
         ,PayTypeName
         ,SOStatus
         ,IsOutStock
         ,SAPImportedDate
	          ,SAPDocNo
	          ,SapImportedStatus
            ,SapInFailedReason
            ,SAPPostDate
         ,0 AS PosPrePay
		    ,0 AS PosCash
		    ,0 AS PosBankCard
        ,NULL AS OutTime
        ,NULL AS PayedDate
        ,0 AS ProductPrice
        ,0 AS PointPayAmt
        ,0 AS PomotionAmt
        ,0 AS TariffAmt 
			FROM (
					SELECT TOP (@EndNumber)
						 fs.sysno
             ,fs.CompanyCode
             ,fs.CustomerSysNo
					   ,fs.incomeStyle
					   ,fs.ordertype
					   ,fs.orderamt
					   ,fs.incomeamt
					   ,fs.PrepayAmt
					   ,fs.GiftCardPayAmt
					   ,fsb.RefundGiftCard
					   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
					   ,fs.incometime
					   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
					   ,fs.confirmtime
					   ,fs.orderid
					   ,fs.fsOrderSysNo AS ordersysno
					   ,fs.status AS incomestatus
             ,0.0 AS ShipTotal
					   ,0.0 AS shipprice
					   ,0.0 AS shippingfee
					   ,0.0 AS packagefee
					   ,0.0 AS registeredfee
					   ,0.0 AS shipcost
					   ,fs.ReferenceID
					   ,fsb.RefundCashAmt AS ReturnCashAmt
					   ,fsb.RefundPoint AS ReturnPointAmt
             ,fsb.ToleranceAmt AS ToleranceAmt
             ,0.0 AS SAPReturnCashAmt
					   ,0 AS SAPReturnPointAmt
             ,0.0 AS SAPToleranceAmt
					   ,fs.SOSysNo AS SOSysNo
					   ,fsb.bankname AS bankname
					   ,fsb.branchbankname AS branchbankname
					   ,fsb.cardnumber AS cardnumber
					   ,fsb.cardownername AS cardownername
					   ,fsb.postaddress AS postaddress
					   ,fsb.postcode AS postcode
					   ,fsb.receivername AS receivername
					   ,fsb.refundpaytype AS rmarefundpaytype
             ,fs.refundpaytype as RefundPayTypeSysNo
             ,NULL AS PayTypeSysNo
             ,NULL AS PayTypeName
             ,NULL AS SOStatus
             ,NULL AS IsOutStock
					   ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
             ,fs.SAPImportedDate
	          ,fs.SAPDocNo
	          ,fs.SapImportedStatus
            ,fs.SapInFailedReason
            ,fs.SAPPostDate
					FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
					LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
						ON suiu.UserSysNo = fs.incomeusersysno
					LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
						ON sucu.UserSysNo = fs.confirmusersysno
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
						ON fsb.ordersysno=fs.OrderSysNo
						AND fs.ordertype = 4
						AND fsb.ordertype = 4 #StrWhere#) RESULT
					WHERE
						RowNumber > @StartNumber

         SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(0.0)
		   FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    	 LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
			 ON suiu.UserSysNo = fs.incomeusersysno
			 LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
						ON fsb.ordersysno=fs.OrderSysNo
						AND fs.ordertype = 4
						AND fsb.ordertype = 4
    #StrWhere#
					]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeMROList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     SELECT @TotalCount=COUNT(1)
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
        	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				  LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					  ON sc.sosysno = fs.ordersysno
				  LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					  ON fsb.ordersysno=fs.ordersysno
					  AND fs.ordertype =5
					  AND fsb.ordertype = 5
        #StrWhere#

       SELECT
			    SysNo
          ,CompanyCode
         ,CustomerSysNo
		     ,IncomeStyle
		     ,OrderType
         ,OrderAmt
		     ,IncomeAmt
		     ,PrepayAmt
			 ,GiftCardPayAmt
			 ,RefundGiftCard
		     ,IncomeUser
		     ,IncomeTime
		     ,ConfirmUser
		     ,ConfirmTime
		     ,OrderID
		     ,OrderSysNo
		     ,IncomeStatus
         ,ShipTotal
		     ,ShipPrice
		     ,ShippingFee
		     ,PackageFee
		     ,RegisteredFee
		     ,ShipCost
		     ,ReferenceID
		     ,ReturnCashAmt
		     ,ReturnPointAmt
		     ,ToleranceAmt
         ,SAPReturnCashAmt
		     ,SAPReturnPointAmt
		     ,SAPToleranceAmt
		     ,SOSysNo
		     ,BankName
		     ,BranchBankName
		     ,CardNumber
		     ,CardOwnername
		     ,PostAddress
		     ,PostCode
		     ,ReceiverName
		     ,RMARefundPayType
         ,RefundPayTypeSysNo
         ,PayTypeSysNo
         ,PayTypeName
         ,SOStatus
         ,IsOutStock
         ,SAPImportedDate
	          ,SAPDocNo
	          ,SapImportedStatus
            ,SapInFailedReason
            ,SAPPostDate
      ,0 AS PosPrePay
		  ,0 AS PosCash
		  ,0 AS PosBankCard
      ,NULL AS OutTime
      ,NULL AS PayedDate
          ,NULL AS ProductPrice
                ,NULL AS PointPayAmt 
      ,NULL AS PomotionAmt
      ,NULL AS TariffAmt
		  FROM (SELECT TOP (@EndNumber)
              fs.sysno
             ,fs.CompanyCode
             ,fs.CustomerSysNo
				     ,fs.incomeStyle
				     ,fs.ordertype
				     ,fs.orderamt
				     ,fs.incomeamt
				     ,fs.PrepayAmt
					 ,fs.GiftCardPayAmt
					 ,fsb.RefundGiftCard
				     ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
				     ,fs.incometime
				     ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
				     ,fs.confirmtime
				     ,fs.orderid
				     ,fs.fsordersysno AS ordersysno
             ,fs.shipprice as ShipTotal
				     ,fs.status AS incomestatus
				     ,0.0 AS shipprice
				     ,sc.shippingfee
				     ,sc.packagefee
				     ,sc.registeredfee
				     ,sc.shipcost
				     ,fs.ReferenceID
				     ,fsb.RefundCashAmt AS ReturnCashAmt
				     ,fsb.RefundPoint AS ReturnPointAmt
				     ,fsb.ToleranceAmt AS ToleranceAmt
             ,ISNULL(fsb.RefundCashAmt,0.0) AS SAPReturnCashAmt
				     ,ISNULL(fsb.RefundPoint,0) AS SAPReturnPointAmt
				     ,ISNULL(fsb.ToleranceAmt,0.0) AS SAPToleranceAmt
				     ,fs.OrderSysNo AS SOSysNo
				     ,fsb.bankname AS bankname
				     ,fsb.branchbankname AS branchbankname
				     ,fsb.cardnumber AS cardnumber
				     ,fsb.cardownername AS cardownername
				     ,fsb.postaddress AS postaddress
				     ,fsb.postcode AS postcode
				     ,fsb.receivername AS receivername
				     ,fsb.refundpaytype AS rmarefundpaytype
             ,fsb.RefundPayType AS RefundPayTypeSysNo
             ,fs.PayTypeSysNo
             ,paytype.PayTypeName AS PayTypeName
             ,NULL AS SOStatus
             ,NULL AS IsOutStock
             ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
             ,fs.SAPImportedDate
	          ,fs.SAPDocNo
	          ,fs.SapImportedStatus
            ,fs.SapInFailedReason
            ,fs.SAPPostDate
				  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
          LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
            ON fs.PayTypeSysNo=paytype.SysNo
				  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					  ON suiu.UserSysNo = fs.incomeusersysno
				  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					  ON sucu.UserSysNo = fs.confirmusersysno
				  LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					  ON sc.sosysno = fs.ordersysno
				  LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					  ON fsb.ordersysno=fs.ordersysno
					  AND fs.ordertype =5
					  AND fsb.ordertype = 5 #StrWhere#) RESULT
				WHERE RowNumber > @StartNumber

         SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(0.0)
          FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
        	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
					ON suiu.UserSysNo = fs.incomeusersysno
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
					ON sucu.UserSysNo = fs.confirmusersysno
				  LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
					  ON sc.sosysno = fs.ordersysno
				  LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
					  ON fsb.ordersysno=fs.ordersysno
					  AND fs.ordertype =5
					  AND fsb.ordertype = 5
            AND fsb.RefundCashAmt = -fs.IncomeAmt
            #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS IncomeUser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS ConfirmUser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    ,CASE sc.IsCombine
				   WHEN 0 THEN fs.OutTime
				   WHEN 1 THEN sc.MergeCompleteTime
				   ElSE NULL
				   END AS OutTime
    ,(SELECT SUM(Cost*Quantity*ISNULL(ExchangeRate,1)) FROM OverseaInventoryManagement.dbo.ProductCostOUT WITH(NOLOCK) WHERE BillType=20 AND BillSysNo=fs.fsOrderSysNo) AS CostAmout
    ,(SELECT SUM(Price*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS ProductPrice
    ,fs.PointPayAmt
    ,fs.TariffAmt
    ,(SELECT SUM(PromotionDiscount*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere#
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS OutTime
    ,NULL AS CostAmout
	  ,NULL AS ProductPrice
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere#
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS OutTime
    ,NULL AS CostAmout
	  ,NULL AS ProductPrice
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere#
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS OutTime
    ,NULL AS CostAmout
	  ,NULL AS ProductPrice
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere#
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS OutTime
    ,NULL AS CostAmout
	  ,NULL AS ProductPrice
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere#
  AND fs.ordertype = 4
  
  UNION ALL
  SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS OutTime
    ,NULL AS CostAmout
	  ,NULL AS ProductPrice
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 6
        AND fsb.ordertype = 6
	#StrWhere#
  AND fs.ordertype = 6
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM (
           SELECT AllSoIncome.*,
	        0 AS PosPrePay,
	        0 AS PosCash,
	        0 AS PosBankCard
          FROM AllSoIncome
          ) as T
  ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere#
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere#
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere#
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere#
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere#
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT
DECLARE @TotalCount6 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere#

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere#

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#

SELECT @TotalCount6 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 6
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =6
        AND fsb.ordertype = 6
#StrWhere# 

SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5 + @TotalCount6
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllListBySO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS IncomeUser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS ConfirmUser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    ,fs.PointPayAmt
    ,fs.TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,(SELECT SUM(Price*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS ProductPrice
    ,(SELECT SUM(PromotionDiscount*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,fs.PointPayAmt
    ,fs.TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,(SELECT SUM(Price*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS ProductPrice
    ,(SELECT SUM(PromotionDiscount*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,NULL AS ProductPrice
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,fs.PointPayAmt
    ,fs.TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,(SELECT SUM(Price*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS ProductPrice
    ,(SELECT SUM(PromotionDiscount*Quantity) FROM IPP3.dbo.SO_Item WITH(NOLOCK) WHERE SOSysNo=fs.fsOrderSysNo) AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,NULL AS ProductPrice
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
  AND fs.ordertype = 4
  
  UNION ALL
  SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    ,NULL AS PointPayAmt
    ,NULL AS TariffAmt
    ,NULL AS CostAmout
    ,NULL AS OutTime
    ,NULL AS ProductPrice
    ,NULL AS PomotionAmt
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 6
        AND fsb.ordertype = 6
	#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
  AND fs.ordertype = 6
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM AllSoIncome ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT
DECLARE @TotalCount6 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#      And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#  And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount6 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 6
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =6
        AND fsb.ordertype = 6
#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#        And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=1 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5 + @TotalCount6
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllListByRO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS IncomeUser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS ConfirmUser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere# And fs.orderid in (#tempPara1#) or fs.ordersysno in (#tempPara2#)
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere# And fs.orderid in (#tempPara1#) or fs.ordersysno in (select b.sysNo from OverseaServiceManagement.dbo.V_SM_ROBalance b where b.OrgRefundSysno in(#tempPara2#))
  AND fs.ordertype = 4
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM AllSoIncome ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere# And fs.orderid in (#tempPara1#) or fs.ordersysno in (#tempPara2#)
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere# And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere# And fs.orderid in (#tempPara1#)  or fs.ordersysno in (select b.sysNo from OverseaServiceManagement.dbo.V_SM_ROBalance b where b.OrgRefundSysno in(#tempPara2#))
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#      And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#  And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere# And fs.orderid in (#tempPara1#) or fs.ordersysno in (#tempPara2#)

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere#  And fs.orderid in (select sosysno  from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where refundid in(#tempPara1#) or sysno in(#tempPara2#))

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#        And fs.orderid in (#tempPara1#)  or fs.ordersysno in (select b.sysNo from OverseaServiceManagement.dbo.V_SM_ROBalance b where b.OrgRefundSysno in(#tempPara2#))
SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllListByAO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS IncomeUser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS ConfirmUser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
  AND fs.ordertype = 4
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM AllSoIncome ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#      And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#  And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#        And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=3 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllListByROBalance" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere# And fs.orderid in (select r.RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere# And fs.ordersysno in (#tempPara2#)
  AND fs.ordertype = 4
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM AllSoIncome ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere# And fs.orderid in (select r.RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere# And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere# And fs.ordersysno in (#tempPara2#)
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#      And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#  And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere# And fs.orderid in (select r.RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere#  And fs.OrderSysno in (select r.SosysNo from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.Sysno in(#tempPara2#))

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#        And fs.ordersysno in (#tempPara2#)
SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeAllListByOverPayment" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
#tempTab1#
WITH AllSoIncome AS (
    SELECT
        fs.SysNo
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.IncomeStyle
       ,fs.OrderType
       ,fs.OrderAmt
       ,fs.IncomeAmt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.IncomeTime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.ConfirmTime
       ,fs.OrderID
       ,fs.fsOrderSysNo AS OrderSysNo
       ,fs.status AS IncomeStatus
       ,fs.ShipPrice
       ,sc.ShippingFee
       ,sc.PackageFee
       ,sc.RegisteredFee
       ,sc.ShipCost
       ,fs.ReferenceID
	   ,fsb.RefundCashAmt AS ReturnCashAmt
	   ,fsb.RefundPoint AS ReturnPointAmt
	   ,fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,NULL AS BankName
       ,NULL AS BranchBankName
       ,NULL AS CardNumber
       ,NULL AS CardOwnerName
       ,NULL AS PostAddress
       ,NULL AS PostCode
       ,NULL AS ReceiverName
       ,fsb.refundpaytype AS RMARefundPayType
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus
       ,CASE
          WHEN fs.SOStatus=4 THEN '是'
          ELSE '否'
      END AS IsOutStock
	  ,ST.ShipTypeName
	  ,sucu2.DisplayName as DeliveryManName
        ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,fs.PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
	LEFT JOIN OverseaOrderManagement.dbo.V_OM_Delivery dl WITH(NOLOCK)
				ON dl.OrderSysNo = fs.fsOrderSysNo
				AND dl.status = 0
				AND dl.ordertype = 1
	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu2 WITH(NOLOCK)
			ON sucu2.UserSysNo = dl.DeliveryManUserSysNo
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
     #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
     AND fs.ordertype = 1
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsordersysno AS ordersysno
       ,fs.status AS incomestatus
       ,fs.shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo AS PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,fs.SOStatus AS SOStatus
       ,CASE
            WHEN fs.SOStatus=4 THEN '是'
            ELSE '否'
        END AS IsOutStock
		,null as ShipTypeName
	    ,null as DeliveryManName
          ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
         AND fs.ordertype = 3
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
				   ,ReturnCashAmt = fsb.RefundCashAmt
				   ,ReturnPointAmt = fsb.RefundPoint
				   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
        #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
        AND fs.ordertype = 2
    UNION ALL

    SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,sc.shippingfee
       ,sc.packagefee
       ,sc.registeredfee
       ,sc.shipcost
       ,fs.ReferenceID
		   ,ReturnCashAmt = fsb.RefundCashAmt
		   ,ReturnPointAmt = fsb.RefundPoint
		   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.OrderSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,fs.PayTypeSysNo
       ,paytype.PayTypeName AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
        ON fs.PayTypeSysNo=paytype.SysNo
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
		#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
    AND fs.ordertype = 5

		UNION ALL
		 SELECT
        fs.sysno
       ,fs.CompanyCode
       ,fs.CustomerSysNo
       ,fs.incomeStyle
       ,fs.ordertype
       ,fs.orderamt
       ,fs.incomeamt
       ,fs.PrepayAmt
	   ,fs.GiftCardPayAmt
	   ,fsb.RefundGiftCard
       ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
       ,fs.incometime
       ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
       ,fs.confirmtime
       ,fs.orderid
       ,fs.fsOrderSysNo AS ordersysno
       ,fs.status AS incomestatus
       ,0.0 AS shipprice
       ,0.0 AS shippingfee
       ,0.0 AS packagefee
       ,0.0 AS registeredfee
       ,0.0 AS shipcost
       ,fs.ReferenceID
	   ,ReturnCashAmt = fsb.RefundCashAmt
	   ,ReturnPointAmt = fsb.RefundPoint
	   ,ToleranceAmt = fsb.ToleranceAmt
       ,fs.SOSysNo AS SOSysNo
       ,fsb.bankname AS bankname
       ,fsb.branchbankname AS branchbankname
       ,fsb.cardnumber AS cardnumber
       ,fsb.cardownername AS cardownername
       ,fsb.postaddress AS postaddress
       ,fsb.postcode AS postcode
       ,fsb.receivername AS receivername
       ,fsb.refundpaytype AS rmarefundpaytype
       ,NULL AS PayTypeSysNo
       ,NULL AS PayTypeName
       ,NULL AS SOStatus
       ,NULL AS IsOutStock
	   ,null as ShipTypeName
	   ,null as DeliveryManName
         ,fs.SAPImportedDate
	  ,fs.SAPDocNo
	  ,fs.SapImportedStatus
    ,fs.SapInFailedReason
    ,fs.SAPPostDate
    ,NULL AS PayedDate
    FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.fsordersysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
	#StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
  AND fs.ordertype = 4
)

SELECT  *
FROM (
    SELECT TOP (@EndNumber) *
	   ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
    FROM AllSoIncome ) A
WHERE RowNumber > @StartNumber
		;

 WITH AllSoIncomeAmount AS (
            SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=fs.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
          #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
          AND fs.ordertype = 1
          GROUP BY fs.status
          UNION ALL

           SELECT
          SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(fs.shipprice) AS ShipPrice
         ,fs.status AS IncomeStatus
      FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
       #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
       AND fs.ordertype = 3
      GROUP BY fs.status
      UNION ALL

        SELECT
      	 SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
      #StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
      AND fs.ordertype = 2
      GROUP BY fs.status
      UNION ALL

    SELECT
     SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
 	  	  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
        AND fsb.RefundCashAmt = -fs.IncomeAmt
        #StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))
        AND fs.ordertype = 5
        GROUP BY fs.status

		UNION ALL
		 SELECT
			  SUM(fs.orderamt) AS OrderAmt
         ,SUM(fs.incomeamt) AS IncomeAmt
         ,SUM(fs.prepayamt) AS PrepayAmt
         ,SUM(0.0) AS ShipPrice
         ,fs.status AS IncomeStatus
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
    #StrWhere# And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
    AND fs.ordertype = 4
    GROUP BY fs.status
        )

        SELECT
          @TotalOrderAmt = SUM(OrderAmt)
         ,@TotalIncomeAmt = SUM(IncomeAmt)
         ,@TotalAlreadyIncomeAmt = SUM(case when IncomeStatus =1 then IncomeAmt else 0 end)
         ,@TotalPrepayAmt = SUM(PrepayAmt)
         ,@TotalShipPrice = SUM(ShipPrice)  FROM AllSoIncomeAmount

DECLARE @TotalCount1 INT
DECLARE @TotalCount2 INT
DECLARE @TotalCount3 INT
DECLARE @TotalCount4 INT
DECLARE @TotalCount5 INT

SELECT  @TotalCount1 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 1
	INNER JOIN OverseaControlPanel.dbo.V_CP_ShipType ST WITH(NOLOCK) ON ST.SysNo=sm.ShipTypeSysNo
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb with(nolock) ON fsb.ordersysno=fs.ordersysno AND fsb.ordertype=5
#StrWhere#      And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount2 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 3
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype = 3
        AND fsb.ordertype = 3
#StrWhere#  And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount3 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSM fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = fs.ordersysno
        AND fs.ordertype = 2
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype=2
        AND fsb.ordertype=2
#StrWhere# And fs.orderid in (select  refundid from OverseaServiceManagement.dbo.V_SM_RMARefundMaster where sosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))

SELECT @TotalCount5 = COUNT(1)
  FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeSo fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        ON sm.sysno = fs.ordersysno
        AND fs.ordertype = 5
    LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_CheckShipping sc WITH(NOLOCK)
        ON sc.sosysno = fs.ordersysno
    LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=fs.ordersysno
        AND fs.ordertype =5
        AND fsb.ordertype = 5
#StrWhere# And fs.orderid in (select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#))

SELECT @TotalCount4 = COUNT(1)
 FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeROBalance fs WITH(NOLOCK)
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
        ON suiu.UserSysNo = fs.incomeusersysno
    LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
        ON sucu.UserSysNo = fs.confirmusersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_ROBalance] rob WITH(NOLOCK)
        ON rob.sysno=fs.ordersysno
    INNER JOIN OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster]  rm WITH(NOLOCK)
        ON rm.sysno = rob.OrgRefundSysNo
        AND fs.ordertype = 4
    LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK)
        ON fsb.ordersysno=rob.sysno
        AND fs.ordertype = 4
        AND fsb.ordertype = 4
#StrWhere#        And fs.orderid in (select  RefundId from OverseaServiceManagement.dbo.V_SM_RMARefundMaster r  join OverseaServiceManagement.dbo.V_SM_ROBalance b on b.OrgRefundSysno=r.Sysno where b.orgsosysno in(select soid from OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory  s join [IPP3].[dbo].[Finance_SOIncome] i on i.ordertype=5 and i.ordersysno=s.sysno  and s.soid in(#tempPara1#)))
SELECT  @PageTotalCount  = @TotalCount1 + @TotalCount2 + @TotalCount3 + @TotalCount4 + @TotalCount5
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
   SELECT
       @TotalCount = COUNT(sm.SysNo)
   FROM OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
   LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK)
       ON suud.UserSysNo = sm.updateusersysno
   LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH(NOLOCK)
       ON cm.Sysno = sm.CustomerSysNo
   LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncome fs WITH(NOLOCK)
       ON fs.ordersysno = sm.sysno
       AND fs.status>-1
       AND fs.ordertype=1
   LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK)
       ON pt.sysno = sm.paytypesysno #StrWhere#

  SELECT
      @TotalAmount = SUM(TotalAmount)
  FROM (
        SELECT
            sm.CashPay+sm.PayPrice+sm.ShipPrice+sm.PremiumAmt+sm.DiscountAmt AS TotalAmount
        FROM OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
        LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK)
            ON suud.UserSysNo = sm.updateusersysno
        LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH(NOLOCK)
            ON cm.Sysno = sm.CustomerSysNo
        LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncome fs WITH(NOLOCK)
            ON fs.ordersysno = sm.sysno
            AND fs.status>-1
            AND fs.ordertype=1
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK)
            ON pt.sysno = sm.paytypesysno  #StrWhere#) RESULT

      SELECT
          SysNo
         ,CustomerSysNo
         ,CustomerName
         ,ReceiveName
         ,ReceivePhone
         ,TotalAmount
         ,PointPay
         ,PointAmt
         ,OrderDate
         ,AuditTime
         ,OutTime
         ,UpdateMan
         ,SOStatus
         ,PayType
         ,PayStatus
         ,IsMobilePhone
         ,RowNumber
      FROM (
              SELECT TOP
                  (@EndNumber) sm.SysNo AS SysNo
                 ,cm.Sysno AS CustomerSysNo
                 ,cm.CustomerName AS CustomerName
                 ,sm.ReceiveName AS ReceiveName
                 ,sm.ReceivePhone AS ReceivePhone
                 ,sm.CashPay+sm.PayPrice+sm.ShipPrice+sm.PremiumAmt+sm.DiscountAmt AS TotalAmount
                 ,sm.PointPay AS PointPay
                 ,sm.PointAmt AS PointAmt
                 ,sm.OrderDate AS OrderDate
                 ,sm.AuditTime AS AuditTime
                 ,sm.OutTime AS OutTime
                 ,suud.DisplayName AS UpdateMan
                 ,sm.Status AS SOStatus
                 ,pt.PayTypeName AS PayType
                 ,fs.Status AS PayStatus
                 ,convert(bit,sm.IsMobilePhone) AS IsMobilePhone
                 ,(ROW_NUMBER() OVER(
              ORDER BY #SortColumnName#)) AS RowNumber
              FROM OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK)
              LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK)
                  ON suud.UserSysNo = sm.updateusersysno
              LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH(NOLOCK)
                  ON cm.Sysno = sm.CustomerSysNo
              LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncome fs WITH(NOLOCK)
                  ON fs.ordersysno = sm.sysno
                  AND fs.status>-1
                  AND fs.ordertype=1
              LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK)
                  ON pt.sysno = sm.paytypesysno #StrWhere#) RESULT
              WHERE
                  RowNumber > @StartNumber

      ]]>
    </commandText>
  </dataCommand>


  <dataCommand name="GetSOMasterForExport" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
          sm.SysNo AS SysNo 
         ,sm.CompanyCode
         ,cm.Sysno AS CustomerSysNo
         ,cm.CustomerName AS CustomerName 
         ,sm.ReceiveName AS ReceiveName 
         ,sm.ReceivePhone AS ReceivePhone 
         ,sm.CashPay+sm.PayPrice+sm.ShipPrice+sm.PremiumAmt+sm.DiscountAmt AS TotalAmount 
         ,sm.PointPay AS PointPay 
         ,sm.PointAmt AS PointAmt 
         ,sm.OrderDate AS OrderDate 
         ,sm.AuditTime AS AuditTime 
         ,sm.OutTime AS OutTime 
         ,suud.DisplayName AS UpdateMan 
         ,sm.Status AS SOStatus 
         ,pt.PayTypeName AS PayType 
         ,fs.Status AS PayStatus 
         ,sm.IsMobilePhone AS IsMobilePhone 
      FROM OverseaOrderManagement.dbo.V_OM_SO_Master sm WITH(NOLOCK) 
      LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) 
          ON suud.UserSysNo = sm.updateusersysno 
      LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH(NOLOCK) 
          ON cm.Sysno = sm.CustomerSysNo 
      LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncome fs WITH(NOLOCK) 
          ON fs.ordersysno = sm.sysno 
          AND fs.status>-1 
          AND fs.ordertype=1 
      LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) 
          ON pt.sysno = sm.paytypesysno 
      #StrWhere#
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdateToProcessedStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
            UPDATE [IPP3].[dbo].[Finance_SOIncome]
            SET Status = 3
            WHERE SysNo IN (#SysNo#)
    ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdateSOIncomeAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			  UPDATE ipp3.dbo.Finance_SOIncome
			 SET PayAmount = @PayAmount,
			 IncomeAmt=@PayAmount,
			 OrderAmt = @OrderAmt,
			 PointPayAmt = @PointPayAmt,
			 PrePayAmt=@PrePayAmt
			 WHERE OrderSysNo=@OrderSysNo
			 AND [Status]=2
			 AND OrderType=1
			]]>
    </commandText>
    <parameters>
      <param name="@OrderSysNo" dbType="Int32" />
      <param name="@PayAmount" dbType="Decimal" />
      <param name="@PrePayAmt" dbType="Decimal" />
      <param name="@OrderAmt" dbType="Decimal" />
      <param name="@PointPayAmt" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSOIncomeList" database="NCService" commandType ="Text">
    <commandText>
      <![CDATA[
SELECT TOP 5000
     [SysNo]
    ,[OrderType]
    ,[OrderSysNo]
    ,[OrderAmt]
    ,[IncomeStyle]
    ,[IncomeAmt]
    ,[IncomeTime]
    ,[IncomeUserSysNo]
    ,[ConfirmTime]
    ,[ConfirmUserSysNo]
    ,[ReferenceID]
    ,[Note]
    ,[Status]
    ,[PrepayAmt]
    ,[CustomerSysNo]
    ,[GiftCardPayAmt]
    ,[PointPayAmt] AS PointPay
    ,[CompanyCode]
FROM [OverseaInvoiceReceiptManagement].[dbo].[V_IM_SOIncome] WITH(NOLOCK)
#StrWhere#
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="UpdateSOIncomeStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE IPP3.dbo.Finance_SOIncome
        SET ConfirmTime = GETDATE()
           ,ConfirmUserSysNo = @ConfirmUserSysNo
           ,Status = @Status
           ,ExternalKey=@ExternalKey
        WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ConfirmUserSysNo" dbType="Int32" property="[UserSysNo]"  />
      <param name="@Status" dbType="Int32" />
      <param name="@ExternalKey" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="InsertSOIncome" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
DECLARE @SysNo int
IF NOT EXISTS(SELECT top 1 sysno FROM ipp3.dbo.Finance_SOIncome WITH  (NOLOCK)
	  WHERE OrderType=@OrderType and OrderSysNo=@OrderSysNo and [Status]=@Status)

BEGIN
        INSERT INTO [IPP3].[dbo].[Finance_SOIncome]
           ([OrderType]
           ,[OrderSysNo]
           ,[OrderAmt]
           ,[IncomeStyle]
           ,[IncomeAmt]
           ,[IncomeTime]
           ,[IncomeUserSysNo]
           ,[ReferenceID]
           ,[Note]
           ,[Status]
           ,[PrepayAmt]
           ,[CompanyCode]
		   ,[MasterSoSysNo],
		   [PayAmount],
		   [PointPayAmt],
		   [GiftCardPayAmt])
     VALUES
           (@OrderType
           ,@OrderSysNo
           ,@OrderAmt
           ,@IncomeStyle
           ,@IncomeAmt
           ,GETDATE()
           ,@IncomeUserSysNo
           ,@ReferenceID
           ,@Note
           ,@Status
           ,@PrepayAmt
           ,@CompanyCode
		   ,@MasterSoSysNo,
		   @PayAmount,
		   @PointPayAmt,
		   @GiftCardPayAmt)
End
SELECT @SysNo=SCOPE_IDENTITY()
SELECT CASE WHEN @SysNo is null THEN 0 else @SysNo END
      ]]>
    </commandText>
    <parameters>
      <param name="@OrderType" dbType="Int32"/>
      <param name="@OrderSysNo" dbType="Int32"/>
      <param name="@IncomeStyle" dbType="Int32"/>
      <param name="@IncomeUserSysNo" dbType="Int32" property="[UserSysNo]" />
      <param name="@Note" dbType="String"/>
      <param name="@OrderAmt" dbType="Decimal"/>
      <param name="@IncomeAmt" dbType="Decimal"/>
      <param name="@ReferenceID" dbType="String"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@PrepayAmt" dbType="Decimal"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@MasterSoSysNo" dbType="Int32" />
      <param name="@PayAmount" dbType="Decimal" />
      <param name="@PointPayAmt" dbType="Decimal" property="PointPay" />
      <param name="@GiftCardPayAmt" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetValidSOIncomeInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT
             [SysNo]
            ,[OrderType]
            ,[OrderSysNo]
            ,[OrderAmt]
            ,[IncomeStyle]
            ,[IncomeAmt]
            ,[IncomeTime]
            ,[IncomeUserSysNo]
            ,[ConfirmTime]
            ,[ConfirmUserSysNo]
            ,[ReferenceID]
            ,[Note]
            ,[Status]
            ,[PrepayAmt]
            ,[CustomerSysNo]
            ,[GiftCardPayAmt]
            ,[PointPayAmt] AS PointPay
            ,[CompanyCode]
          FROM [OverseaInvoiceReceiptManagement].[dbo].[V_IM_SOIncome] WITH(NOLOCK)
          WHERE [OrderSysNo] = @SOSysNo
            AND [OrderType] = @OrderType
            AND [Status] <> -1
            AND [Status] <> 2
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@OrderType" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetConfirmedSOIncomeInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT
             [SysNo]
            ,[OrderType]
            ,[OrderSysNo]
            ,[OrderAmt]
            ,[IncomeStyle]
            ,[IncomeAmt]
            ,[IncomeTime]
            ,[IncomeUserSysNo]
            ,[ConfirmTime]
            ,[ConfirmUserSysNo]
            ,[ReferenceID]
            ,[Note]
            ,[Status]
            ,[PrepayAmt]
            ,[CustomerSysNo]
            ,[GiftCardPayAmt]
            ,[PointPayAmt] AS PointPay
            ,[CompanyCode]
          FROM [OverseaInvoiceReceiptManagement].[dbo].[V_IM_SOIncome]  WITH(NOLOCK)
          WHERE [OrderSysNo] = @SOSysNo
            AND [OrderType] = @OrderType
            AND Status=1
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@OrderType" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateSOIncomeOrderAmtForSO" database="NCService" commandType ="Text">
    <commandText>
      <![CDATA[
        UPDATE [IPP3].[dbo].[Finance_SOIncome]
        SET [OrderAmt] = @OrderAmt
        WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@OrderAmt" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <dataCommand name="SetSOIncomeReferenceID" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
         UPDATE [IPP3].[dbo].[Finance_SOIncome]
        SET
          [ReferenceID] = @ReferenceID
        WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@ReferenceID" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="SetIncomeAmount" database="NCService" commandType ="Text">
    <commandText>
      <![CDATA[
        UPDATE [IPP3].[dbo].[Finance_SOIncome]
        SET
          [IncomeAmt] = @IncomeAmt
        WHERE SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@IncomeAmt" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetROExport" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT
          rma.refundid AS RefundID
         ,rma.CompanyCode
         ,round(rma.cashAmt,2) AS CashAmt
         ,rma.refundtime AS RefoundTime
         ,rma.sosysno AS SOSysNo
         ,so.outtime AS OutTime
      FROM OverseaServiceManagement.[dbo].[V_SM_RMARefundMaster] rma (NOLOCK)
      LEFT JOIN OverseaOrderManagement.dbo.V_OM_SO_Master so (NOLOCK)
          ON so.sysno=rma.sosysno
      WHERE
          rma.status=2
          AND rma.refundpaytype!=1
          AND RefundTime>=@RefundTimeFrom
          AND RefundTime<@RefundTimeTo
          AND rma.CompanyCode=@CompanyCode
      ORDER BY rma.sysno
      ]]>
    </commandText>
    <parameters>
      <param dbType="DateTime" name="@RefundTimeFrom"/>
      <param dbType="DateTime" name="@RefundTimeTo"/>
      <param dbType="AnsiStringFixedLength" name="@CompanyCode" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateSOIncomeStatusSplitForSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE IPP3.dbo.Finance_SOIncome
        SET Status = @Status
        WHERE SysNo = @SysNo AND Status=0
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="AbandonSplitSOIncomeForSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			  UPDATE Ipp3.dbo.Finance_SOIncome SET [Status] = -1
				WHERE OrderSysNo IN (@SoSysNoList@) AND OrderType=1

				IF NOT EXISTS(SELECT 1 FROM Ipp3.dbo.Finance_SOIncome WITH(NOLOCK) WHERE MasterSoSysNo=@MasterSoSysNo AND [Status]<>-1)
				BEGIN
					UPDATE Ipp3.dbo.Finance_SOIncome SET [Status] = -1
					WHERE OrderSysNo=@MasterSoSysNo AND OrderType=1 AND Status=2
				END
			]]>
    </commandText>
  </dataCommand>


  <dataCommand name="GetSaleIncomeRO_AdjustList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT 
			@TotalCount = COUNT(fs.sysno) 
		FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK) 	
    	LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK) 
					ON suiu.UserSysNo = fs.incomeusersysno 
				LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK) 
					ON sucu.UserSysNo = fs.confirmusersysno 
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK) 
						ON fsb.ordersysno=fs.fsOrderSysNo    
						AND fs.ordertype = 6 
						AND fsb.ordertype = 6
    #StrWhere#
    
		SELECT 
         SysNo 
         ,CompanyCode
         ,CustomerSysNo
			   ,IncomeStyle 
			   ,OrderType
         ,OrderAmt
			   ,IncomeAmt 
			   ,PrepayAmt
			   ,GiftCardPayAmt
			   ,RefundGiftCard
			   ,IncomeUser 
			   ,IncomeTime 
			   ,ConfirmUser 
			   ,ConfirmTime 
			   ,OrderID 
			   ,OrderSysNo 
			   ,IncomeStatus 
         ,ShipTotal
			   ,ShipPrice 
			   ,ShippingFee 
			   ,PackageFee 
			   ,RegisteredFee 
			   ,ShipCost 
			   ,ReferenceID 
			   ,ReturnPointAmt 
			   ,ReturnCashAmt 
			   ,ToleranceAmt 	
         ,SAPReturnPointAmt 
			   ,SAPReturnCashAmt 
			   ,SAPToleranceAmt 			    
			   ,SOSysNo 
			   ,BankName 
			   ,BranchBankName 
			   ,CardNumber 
			   ,CardOwnername 
			   ,PostAddress 
			   ,PostCode 
			   ,ReceiverName 
			   ,RMARefundPayType 
         ,RefundPayTypeSysNo
         ,PayTypeSysNo
         ,PayTypeName
         ,SOStatus
         ,IsOutStock
         ,SAPImportedDate
	          ,SAPDocNo
	          ,SapImportedStatus
            ,SapInFailedReason
            ,SAPPostDate
			FROM ( 
					SELECT TOP (@EndNumber)
						 fs.sysno 
             ,fs.CompanyCode
             ,fs.CustomerSysNo
					   ,fs.incomeStyle 
					   ,fs.ordertype 
					   ,fs.orderamt 
					   ,fs.incomeamt 
					   ,fs.PrepayAmt 
					   ,fs.GiftCardPayAmt
					   ,fsb.RefundGiftCard
					   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser 
					   ,fs.incometime 
					   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser 
					   ,fs.confirmtime 
					   ,fs.orderid 
					   ,fs.fsOrderSysNo AS ordersysno 
					   ,fs.status AS incomestatus 
             ,0.0 AS ShipTotal
					   ,0.0 AS shipprice 
					   ,0.0 AS shippingfee 
					   ,0.0 AS packagefee 
					   ,0.0 AS registeredfee 
					   ,0.0 AS shipcost 
					   ,fs.ReferenceID 
					   ,fsb.RefundCashAmt AS ReturnCashAmt
					   ,fsb.RefundPoint AS ReturnPointAmt
             ,fsb.ToleranceAmt AS ToleranceAmt
             ,0.0 AS SAPReturnCashAmt
					   ,0 AS SAPReturnPointAmt
             ,0.0 AS SAPToleranceAmt
					   ,fs.SOSysNo AS SOSysNo
					   ,fsb.bankname AS bankname 
					   ,fsb.branchbankname AS branchbankname 
					   ,fsb.cardnumber AS cardnumber 
					   ,fsb.cardownername AS cardownername 
					   ,fsb.postaddress AS postaddress 
					   ,fsb.postcode AS postcode 
					   ,fsb.receivername AS receivername 
					   ,fsb.refundpaytype AS rmarefundpaytype
             ,fs.refundpaytype as RefundPayTypeSysNo
             ,NULL AS PayTypeSysNo
             ,NULL AS PayTypeName
             ,NULL AS SOStatus
             ,NULL AS IsOutStock 
					   ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
             ,fs.SAPImportedDate
	          ,fs.SAPDocNo
	          ,fs.SapImportedStatus
            ,fs.SapInFailedReason
            ,fs.SAPPostDate
					FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK) 
					LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK) 
						ON suiu.UserSysNo = fs.incomeusersysno 
					LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK) 
						ON sucu.UserSysNo = fs.confirmusersysno 
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK) 
						ON fsb.ordersysno=fs.fsOrderSysNo  
						AND fs.ordertype = 6 
						AND fsb.ordertype = 6 #StrWhere#) RESULT 
					WHERE 
						RowNumber > @StartNumber
            
         SELECT 
          @TotalOrderAmt = SUM(fs.orderamt) 
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         ,@TotalShipPrice = SUM(0.0)        
		   FROM OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncomeRO_Adjust fs WITH(NOLOCK) 	
    	 LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK) 
			 ON suiu.UserSysNo = fs.incomeusersysno 
			 LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK) 
					ON sucu.UserSysNo = fs.confirmusersysno 
					LEFT JOIN ipp3.dbo.Finance_SOIncome_BankInfo  fsb WITH(NOLOCK) 
						ON fsb.ordersysno=fs.fsOrderSysNo  
						AND fs.ordertype = 6 
						AND fsb.ordertype = 6
    #StrWhere#
					]]>
    </commandText>
  </dataCommand>
  <dataCommand name="GetROSOSysNO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
          SELECT 
    bk.SOSysNo 
FROM IPP3.dbo.Finance_SOIncome so WITH(NOLOCK) 
LEFT JOIN IPP3.dbo.Finance_SOIncome_BankInfo bk WITH(NOLOCK) 
    ON so.OrderSysNo=bk.OrderSysNo 
    AND so.OrderType=bk.OrderType 
WHERE 
    so.OrderSysNo=@OrderSysNo 
    AND so.OrderType=@OrderType
       ]]>
    </commandText>
    <parameters>
      <param name="@OrderSysNo" dbType="Int32" />
      <param name="@OrderType" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSOIncomeBankInfoRefundPayType" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
          SELECT 
    RefundPayType 
FROM IPP3.dbo.Finance_SOIncome_BankInfo with(nolock)
WHERE 
    SOSysNo=@SOSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GetRMAReundRefundPayType" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
         SELECT 
    RefundPayType 
from IPP3.dbo.RMA_Refund with(nolock)
where 
SOSysNo=@SOSysNo 
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GetSOIncomeBankStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
          SELECT 
     [Status]
FROM IPP3.dbo.Finance_SOIncome_BankInfo with(nolock)
WHERE 
    SOSysNo=@SOSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GetSOIncomeAmt" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      select top 1 IncomeAmt from [OverseaInvoiceReceiptManagement].[dbo].[V_IM_SOIncome] WITH(NOLOCK) 
      where OrderType=1 and OrderSysNo=@SOSysNo 
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--通过订单号，获取订单的Pos信息（预付款、银行卡付款、现金付款）-->
  <dataCommand name="GetPosInfoByOrderSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       DECLARE @PosPrePay decimal(14,2)
        DECLARE @PosCash decimal(14,2)
        DECLARE @PosBankCard decimal(14,2)

        SELECT @PosPrePay = 0

        SELECT  @PosCash= 0

        SELECT  @PosBankCard = 0

        SELECT @PosPrePay AS PosPrePay,@PosCash AS PosCash,@PosBankCard AS PosBankCard
      ]]>
    </commandText>
    <parameters>
      <param name="@OrderSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetSaleIncomeGroupSOList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       #tempTab1#
       
      SELECT
			@TotalCount = COUNT(fs.SysNo)
			FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN (select distinct OrderSysNo, CustomerSysNo,PayType  from OverseaContentManagement.Dbo.GroupBuyingTicket) gbt 
         on fs.OrderSysno=gbt.OrderSysNo 
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
          ON gbt.PayType=paytype.SysNo
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno	 
			  
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
				 
     #StrWhere#

SELECT
        SysNo
       ,CompanyCode
       ,CustomerSysNo
		   ,IncomeStyle
		   ,OrderType
       ,OrderAmt
		   ,IncomeAmt
		   ,PrepayAmt
		   ,GiftCardPayAmt
		   ,RefundGiftCard
		   ,IncomeUser
		   ,IncomeTime
		   ,ConfirmUser
		   ,ConfirmTime
		   ,OrderID
		   ,OrderSysNo
       ,ShipTotal
		   ,IncomeStatus
		   ,ShipPrice
		   ,ShippingFee
		   ,PackageFee
		   ,RegisteredFee
		   ,ShipCost
		   ,ReferenceID
		   ,ReturnPointAmt
		   ,ReturnCashAmt
		   ,ToleranceAmt
       ,SAPReturnPointAmt
		   ,SAPReturnCashAmt
		   ,SAPToleranceAmt
		   ,SOSysNo
		   ,BankName
		   ,BranchBankName
		   ,CardNumber
		   ,CardOwnername
		   ,PostAddress
		   ,PostCode
		   ,ReceiverName
		   ,RMARefundPayType
       ,RefundPayTypeSysNo
       ,PayTypeSysNo
       ,PayTypeName
       ,SOStatus
       ,IsOutStock
       ,SAPImportedDate
      ,SAPDocNo
      ,SapImportedStatus
      ,SapInFailedReason
      ,SAPPostDate
		FROM (  
  
  SELECT  TOP (@EndNumber)
					  fs.SysNo
           ,fs.CompanyCode
           ,gbt.CustomerSysNo
				   ,fs.IncomeStyle
				   ,fs.OrderType
				   ,fs.OrderAmt
				   ,fs.IncomeAmt
				   ,fs.PrepayAmt
				   ,fs.GiftCardPayAmt 
				   ,null as RefundGiftCard
				   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
				   ,fs.IncomeTime
				   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
				   ,fs.ConfirmTime
				   ,gbt.OrderSysno as OrderID
				    
				   ,fs.OrderSysno AS OrderSysNo
           ,0 AS ShipTotal
				   ,fs.status AS IncomeStatus
				   ,0 as ShipPrice
				 
				   ,null as ShippingFee
				   ,null as PackageFee
				   ,null as RegisteredFee
				   ,null as ShipCost
				   ,null AS OutTime
				    
				   ,CASE netPay.[Status]
				   WHEN 1 THEN netPay.RelatedSoSysNo
				   ELSE NULL
				   END AS RelatedSoSysNo
				   ,fs.ReferenceID
				    
				    ,0.0 AS ReturnCashAmt
				   ,0.0 AS ReturnPointAmt
				   ,0.0 as ToleranceAmt
				   ,0.0 AS SAPReturnCashAmt
				   ,0.0 AS SAPReturnPointAmt
				   ,0.0 AS SAPToleranceAmt
				    
				   ,fs.OrderSysNo AS SOSysNo
				   ,NULL AS BankName
				   ,NULL AS BranchBankName
				   ,NULL AS CardNumber
				   ,NULL AS CardOwnerName
				   ,NULL AS PostAddress
				   ,NULL AS PostCode
				   ,NULL AS ReceiverName				    
           
            ,null AS RMARefundPayType
           ,null AS RefundPayTypeSysNo
           
           ,gbt.PayType AS PayTypeSysNo
           ,paytype.PayTypeName AS PayTypeName
           ,null as SOStatus
            
          ,'' as IsOutStock
          ,'' as ShipTypeName
          ,fs.MasterSoSysNo AS MasterSoSysNo
          ,(ROW_NUMBER() OVER(ORDER BY fs.sysno )) AS RowNumber
          ,fs.SAPImportedDate
          ,fs.SAPDocNo
          ,fs.SapImportedStatus
          ,fs.SapInFailedReason
          ,fs.SAPPostDate
          ,fs.PayedDate
			  FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN (select distinct OrderSysNo, CustomerSysNo,PayType  from OverseaContentManagement.Dbo.GroupBuyingTicket) gbt 
         on fs.OrderSysno=gbt.OrderSysNo 
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
          ON gbt.PayType=paytype.SysNo
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno	 
			  
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
				 
				#StrWhere#
				) RESULT
				WHERE
						RowNumber > @StartNumber
		
		SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         , @TotalShipPrice=0.0
        FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN (select distinct OrderSysNo, CustomerSysNo,PayType  from OverseaContentManagement.Dbo.GroupBuyingTicket) gbt 
         on fs.OrderSysno=gbt.OrderSysNo 
			  LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
			 
				
      #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetSaleIncomeGroupRefundSOList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
       #tempTab1#
       
      SELECT
			@TotalCount = COUNT(fs.SysNo)
			FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN OverseaContentManagement.Dbo.GroupBuyingTicket  gbt 
         on fs.OrderSysno=gbt.SysNo 
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
          ON gbt.PayType=paytype.SysNo
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno	 
			  
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
				 
     #StrWhere#

SELECT
        SysNo
       ,CompanyCode
       ,CustomerSysNo
		   ,IncomeStyle
		   ,OrderType
       ,OrderAmt
		   ,IncomeAmt
		   ,PrepayAmt
		   ,GiftCardPayAmt
		   ,RefundGiftCard
		   ,IncomeUser
		   ,IncomeTime
		   ,ConfirmUser
		   ,ConfirmTime
		   ,OrderID
		   ,OrderSysNo
       ,ShipTotal
		   ,IncomeStatus
		   ,ShipPrice
		   ,ShippingFee
		   ,PackageFee
		   ,RegisteredFee
		   ,ShipCost
		   ,ReferenceID
		   ,ReturnPointAmt
		   ,ReturnCashAmt
		   ,ToleranceAmt
       ,SAPReturnPointAmt
		   ,SAPReturnCashAmt
		   ,SAPToleranceAmt
		   ,SOSysNo
		   ,BankName
		   ,BranchBankName
		   ,CardNumber
		   ,CardOwnername
		   ,PostAddress
		   ,PostCode
		   ,ReceiverName
		   ,RMARefundPayType
       ,RefundPayTypeSysNo
       ,PayTypeSysNo
       ,PayTypeName
       ,SOStatus
       ,IsOutStock
       ,SAPImportedDate
      ,SAPDocNo
      ,SapImportedStatus
      ,SapInFailedReason
      ,SAPPostDate
		FROM (  
  
  SELECT  TOP (@EndNumber)
					  fs.SysNo
           ,fs.CompanyCode
           ,gbt.CustomerSysNo
				   ,fs.IncomeStyle
				   ,fs.OrderType
				   ,fs.OrderAmt
				   ,fs.IncomeAmt
				   ,fs.PrepayAmt
				   ,fs.GiftCardPayAmt 
				   ,null as RefundGiftCard
				   ,ISNULL(fs.InComeUserName,suiu.DisplayName) AS incomeuser
				   ,fs.IncomeTime
				   ,ISNULL(fs.ConfirmUserName,sucu.DisplayName) AS confirmuser
				   ,fs.ConfirmTime
				   ,gbt.OrderSysno as OrderID
				    
				   ,fs.OrderSysno AS OrderSysNo
           ,0 AS ShipTotal
				   ,fs.status AS IncomeStatus
				   ,0 as ShipPrice
				 
				   ,null as ShippingFee
				   ,null as PackageFee
				   ,null as RegisteredFee
				   ,null as ShipCost
				   ,null AS OutTime
				    
				   ,CASE netPay.[Status]
				   WHEN 1 THEN netPay.RelatedSoSysNo
				   ELSE NULL
				   END AS RelatedSoSysNo
				   ,fs.ReferenceID
				    
				    ,0.0 AS ReturnCashAmt
				   ,0.0 AS ReturnPointAmt
				   ,0.0 as ToleranceAmt
				   ,0.0 AS SAPReturnCashAmt
				   ,0.0 AS SAPReturnPointAmt
				   ,0.0 AS SAPToleranceAmt
				    
				   ,fs.OrderSysNo AS SOSysNo
				   ,NULL AS BankName
				   ,NULL AS BranchBankName
				   ,NULL AS CardNumber
				   ,NULL AS CardOwnerName
				   ,NULL AS PostAddress
				   ,NULL AS PostCode
				   ,NULL AS ReceiverName				    
           
            ,4 AS RMARefundPayType
           ,null AS RefundPayTypeSysNo
           
           ,gbt.PayType AS PayTypeSysNo
           ,paytype.PayTypeName AS PayTypeName
           ,null as SOStatus
            
          ,'' as IsOutStock
          ,'' as ShipTypeName
          ,fs.MasterSoSysNo AS MasterSoSysNo
          ,(ROW_NUMBER() OVER(ORDER BY fs.sysno )) AS RowNumber
          ,fs.SAPImportedDate
          ,fs.SAPDocNo
          ,fs.SapImportedStatus
          ,fs.SapInFailedReason
          ,fs.SAPPostDate
          ,fs.PayedDate
			  FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN OverseaContentManagement.Dbo.GroupBuyingTicket  gbt 
         on fs.OrderSysno=gbt.SysNo 
        LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType paytype WITH(NOLOCK)
          ON gbt.PayType=paytype.SysNo
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suiu WITH(NOLOCK)
				  ON suiu.UserSysNo = fs.incomeusersysno
			  LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo sucu WITH(NOLOCK)
				  ON sucu.UserSysNo = fs.confirmusersysno	 
			  
		LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
				 
				#StrWhere#
				) RESULT
				WHERE
						RowNumber > @StartNumber
		
		SELECT
          @TotalOrderAmt = SUM(fs.orderamt)
         ,@TotalIncomeAmt = SUM(fs.incomeamt)
         ,@TotalAlreadyIncomeAmt = SUM(case when fs.status =1 then fs.incomeamt else 0 end)
         ,@TotalPrepayAmt = SUM(fs.prepayamt)
         , @TotalShipPrice=0.0
        FROM IPP3.dbo.Finance_SOIncome fs WITH(NOLOCK) 
         LEFT JOIN  OverseaContentManagement.Dbo.GroupBuyingTicket gbt 
         on fs.OrderSysno=gbt.SysNo 
			  LEFT JOIN Ipp3.dbo.finance_netpay netPay WITH(NOLOCK)
				ON netPay.SOSysNo = fs.ordersysno AND netPay.[Status]=1
			 
				
      #StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QuerySaleReceivables" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      ;WITH TEMP AS (
	      SELECT 
		       IC.SysNo
		      ,IC.IncomeAmt
		      ,SO.ShipPrice
		      ,(CASE WHEN SO.TariffAmt>50 THEN SO.TariffAmt
		       ELSE 0 END) AS TariffAmt
		      ,SO.CurrencySysNo
		      ,SO.ExchangeRate
		      ,SO.PayTypeSysNo
		      ,IC.IncomeTime
		      ,CR.SysNo AS NowCurrencySysNo
		      ,CR.ExchangeRate AS NowExchangeRate
	      FROM IPP3.dbo.Finance_SOIncome IC WITH(NOLOCK)
	      INNER JOIN IPP3.dbo.SO_Master SO WITH(NOLOCK)
	      ON SO.[SysNo] = IC.[OrderSysNo] AND SO.[Status]>=4 AND IC.[Status]=0 AND OrderType=1
	      INNER JOIN IPP3.dbo.Currency CR WITH(NOLOCK)
	      ON CR.SysNo=@CurreySysNo
	      WHERE IC.IncomeTime<=DATEADD(s,-1,CONVERT(DATETIME,DATEADD(d,1,CONVERT(date,@QueryDate)))) AND SO.PayTypeSysNo=@PaySysNo
      )

      SELECT 
	       SysNo
	      ,PayTypeSysNo
	      ,IncomeTime
	      ,CurrencySysNo
	      ,ExchangeRate
        ,(CASE WHEN CurrencySysNo=@CurreySysNo THEN IncomeAmt
		      ELSE IncomeAmt*ExchangeRate END) AS IncomeAmt
	      ,(CASE WHEN CurrencySysNo=@CurreySysNo THEN ShipPrice
		      ELSE ShipPrice*ExchangeRate END) AS ShipPrice
	      ,(CASE WHEN CurrencySysNo=@CurreySysNo THEN ProductPrice
		      ELSE ProductPrice*ExchangeRate END) AS ProductPrice
	      ,(CASE WHEN CurrencySysNo=@CurreySysNo THEN TariffAmt
		      ELSE TariffAmt*ExchangeRate END) AS TariffAmt
      INTO #TEMP 
      FROM (
	      SELECT 
		       SysNo
		      ,IncomeAmt
		      ,PayTypeSysNo
		      ,IncomeTime
		      ,CurrencySysNo
		      ,ExchangeRate
		      ,(CASE WHEN ShipPrice-IncomeAmt+TariffAmt>=0 THEN IncomeAmt-TariffAmt
		        ELSE ShipPrice END) AS ShipPrice
		      ,(CASE WHEN ShipPrice-IncomeAmt+TariffAmt<0 THEN IncomeAmt-TariffAmt-ShipPrice
		        ELSE 0 END) AS ProductPrice
		      ,TariffAmt
	      FROM TEMP
      ) T

      SELECT * INTO #TempAll FROM (
	      SELECT
		         1 AS SysNo
		        ,'商品金额' AS Title
		        ,SUM(ProductPrice) AS Price
		        ,@CurreySysNo AS Currency
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,DATEADD(d,1,CONVERT(date,@QueryDate)))))AS ProductPrice1
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate))))) AS ProductPrice2
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate))))) AS ProductPrice3
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate))))) AS ProductPrice4
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate))))) AS ProductPrice5
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate)))))AS ProductPrice6
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate)))))AS ProductPrice7
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate)))))AS ProductPrice8
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate)))))AS ProductPrice9
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate)))))AS ProductPrice10
		        ,(SELECT SUM(ProductPrice) FROM #TEMP WHERE IncomeTime < CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))))AS ProductPrice11
	      FROM #TEMP
	      UNION ALL
	      SELECT 
		        2 AS SysNo
		        ,'运费金额' AS Title
		        ,SUM(ShipPrice) AS Price
		        ,@CurreySysNo AS Currency
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,DATEADD(d,1,CONVERT(date,@QueryDate))))) AS ShipPrice1
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate)))))AS ShipPrice2
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate)))))AS ShipPrice3
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate)))))AS ShipPrice4
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate)))))AS ShipPrice5
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))))) AS ShipPrice6
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate)))))AS ShipPrice7
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate)))))AS ShipPrice8
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate)))))AS ShipPrice9
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate)))))AS ShipPrice10
		        ,(SELECT SUM(ShipPrice) FROM #TEMP WHERE IncomeTime < CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))))AS ShipPrice11
	      FROM #TEMP
	      UNION ALL
	      SELECT 
		         3 AS SysNo
		        ,'税费金额' AS Title
		        ,SUM(TariffAmt) AS Price
		        ,@CurreySysNo AS Currency
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,DATEADD(d,1,CONVERT(date,@QueryDate))))) AS TariffAmt1
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate)))))AS TariffAmt2
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate)))))AS TariffAmt3
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate)))))AS TariffAmt4
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate)))))AS TariffAmt5
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))))) AS TariffAmt6
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate)))))AS TariffAmt7
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate)))))AS TariffAmt8
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate)))))AS TariffAmt9
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate)))))AS TariffAmt10
		        ,(SELECT SUM(TariffAmt) FROM #TEMP WHERE IncomeTime < CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))))AS TariffAmt11
	      FROM #TEMP
	      UNION ALL
	      SELECT
		         4 AS SysNo
		        ,'合计' AS Title
		        ,SUM(IncomeAmt) AS Price
		        ,@CurreySysNo AS Currency
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,DATEADD(d,1,CONVERT(date,@QueryDate))))) AS IncomeAmt1
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-1,@QueryDate)))))AS IncomeAmt2
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-2,@QueryDate)))))AS IncomeAmt3
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-3,@QueryDate)))))AS IncomeAmt4
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-6,@QueryDate)))))AS IncomeAmt5
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-9,@QueryDate))))) AS IncomeAmt6
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-12,@QueryDate)))))AS IncomeAmt7
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-24,@QueryDate)))))AS IncomeAmt8
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-36,@QueryDate)))))AS IncomeAmt9
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime BETWEEN CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))) AND DATEADD(s,-1,CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-48,@QueryDate)))))AS IncomeAmt10
		        ,(SELECT SUM(IncomeAmt) FROM #TEMP WHERE IncomeTime < CONVERT(DATETIME,CONVERT(date,DATEADD(MONTH,-60,@QueryDate))))AS IncomeAmt11
	      FROM #TEMP
      ) T
      
      SELECT	@TotalCount = COUNT(*)
      FROM #TempAll
      
      SELECT  *
      FROM (
          SELECT TOP (@EndNumber) 
           SysNo
          ,Title
          ,ISNULL(Price,0) AS Price
          ,Currency
          ,ISNULL(ProductPrice1,0) AS ProductPrice1
          ,ISNULL(ProductPrice2,0) AS ProductPrice2
          ,ISNULL(ProductPrice3,0) AS ProductPrice3
          ,ISNULL(ProductPrice4,0) AS ProductPrice4
          ,ISNULL(ProductPrice5,0) AS ProductPrice5
          ,ISNULL(ProductPrice6,0) AS ProductPrice6
          ,ISNULL(ProductPrice7,0) AS ProductPrice7
          ,ISNULL(ProductPrice8,0) AS ProductPrice8
          ,ISNULL(ProductPrice9,0) AS ProductPrice9
          ,ISNULL(ProductPrice10,0) AS ProductPrice10
          ,ISNULL(ProductPrice11,0) AS ProductPrice11
	        ,(ROW_NUMBER() OVER( ORDER BY #SortColumnName#)) AS RowNumber
          FROM #TempAll #StrWhere#) result
      WHERE RowNumber > @StartNumber;
			]]>
    </commandText>
    <parameters>
      <param name="@QueryDate" dbType="DateTime"/>
      <param name="@PaySysNo" dbType="Int32"/>
      <param name="@CurreySysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="QuerySOFreightStatDetai" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT @TotalCount = COUNT(*) 
        FROM OverseaInvoiceReceiptManagement.dbo.SOFreightStatDetail WITH(NOLOCK)      
        #StrWhere#

        SELECT * FROM
          (
	          SELECT TOP (@EndNumber) 
               [SysNo]
              ,[SOSysNo]
              ,[TrackingNumber]
              ,[ShipTypeSysNo]
              ,Convert(decimal,[SOWeight])/1000 AS [SOWeight]
              ,[SOFreight]
              ,[RealWeight]
              ,[RealPayFreight]
              ,[RealOutFreight]
              ,([SOFreight]-[RealPayFreight]) AS [PayProfit]
              ,[OrderDate]
              ,[OutDate]
              ,ISNULL([SOFreightConfirm],0) AS [SOFreightConfirm]
              ,[SOFreightConfirmDate]
              ,ISNULL([RealFreightConfirm],0) AS [RealFreightConfirm]
              ,[RealFreightConfirmDate]
              ,[CurrencySysNo] 
			      ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
	          FROM OverseaInvoiceReceiptManagement.dbo.SOFreightStatDetail WITH(NOLOCK)           
			      #StrWhere#
          ) Result 
        WHERE RowNumber > @StartNumber
			]]>
    </commandText>
  </dataCommand>

  <dataCommand name="LoadSOFreightConfirmBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT TOP 1 [SysNo]
                    ,[SOSysNo]
                    ,[TrackingNumber]
                    ,[ShipTypeSysNo]
                    ,[SOWeight]
                    ,[SOFreight]
                    ,[RealWeight]
                    ,[RealPayFreight]
                    ,[RealOutFreight]
                    ,[OrderDate]
                    ,[OutDate]
                    ,ISNULL([SOFreightConfirm],0) AS [SOFreightConfirm]
                    ,[SOFreightConfirmDate]
                    ,ISNULL([RealFreightConfirm],0) AS [RealFreightConfirm]
                    ,[RealFreightConfirmDate]
                    ,[CurrencySysNo] 
        FROM [OverseaInvoiceReceiptManagement].[dbo].[SOFreightStatDetail] WITH(NOLOCK) 
        WHERE SysNo=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SOFreightConfirm" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE [OverseaInvoiceReceiptManagement].[dbo].[SOFreightStatDetail]
        SET [SOFreightConfirm]=1,[SOFreightConfirmDate]=GETDATE()
        WHERE SysNo=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="RealFreightConfirm" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE [OverseaInvoiceReceiptManagement].[dbo].[SOFreightStatDetail]
        SET [RealFreightConfirm]=1,[RealFreightConfirmDate]=GETDATE()
        WHERE SysNo=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="SOIncome_QueryVendorCustomsInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT * FROM IPP3.dbo.Vendor_Customs_Info WITH(NOLOCK)
WHERE
	CBTMerchantCode IS NOT NULL
	AND CBTSRC_NCode IS NOT NULL
	AND EasiPaySecretKey IS NOT NULL
      ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>

  <dataCommand name="SOIncome_GetSysNoListByRefund" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
select B.SysNo from IPP3.dbo.SO_Master(nolock) A
INNER JOIN IPP3.dbo.Finance_SOIncome(nolock) B
ON A.SysNo = B.OrderSysNo
INNER JOIN [IPP3].[dbo].[Finance_SOIncome_BankInfo](nolock) C
ON B.OrderSysNo = C.OrderSysNo
where B.OrderType = 3 AND A.PayTypeSysNo = 114 AND C.RefundPayType = 4
      ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>
  
</dataOperations>