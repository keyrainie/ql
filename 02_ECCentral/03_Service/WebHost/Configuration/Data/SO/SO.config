<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <!-- 生成新的订单号-->
  <dataCommand name="SO_Insert_NewSOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				INSERT INTO IPP3.dbo.SO_Sequence(createtime) Values(getdate())
				SELECT SCOPE_IDENTITY() AS SysNo
        ]]>
    </commandText>
  </dataCommand>

  <!--根据订单信息 -->
  <dataCommand name="SO_Get_SOInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      #Top#
    m.SysNo 
   ,m.SOID [BaseInfo.SOID]
   ,m.CustomerSysNo [BaseInfo.CustomerSysNo]
   ,t.CustomerID  [BaseInfo.CustomerID]
   ,t.CustomerName  [BaseInfo.CustomerName]   
   ,te.ChannelMasterSysNo
   ,m.Status  
   ,m.OrderDate [BaseInfo.CreateTime]
   ,m.IsWholeSale [BaseInfo.IsWholeSale]
   ,m.IsLarge  [BaseInfo.IsLarge]
   ,m.PointAmt [BaseInfo.GainPoint]
   ,m.Memo [BaseInfo.Memo]
   ,m.Note [BaseInfo.Note]
   ,m.SalesManSysNo [BaseInfo.SalesManSysNo]
   ,m.UpdateTime [BaseInfo.UpdateTime]
   ,m.IsMobilePhone [BaseInfo.IsPhoneOrder]
   ,m.IsVIP  [BaseInfo.IsVIP]
   ,m.IsPremium  [BaseInfo.IsPremium]
   ,m.PremiumAmt [BaseInfo.PremiumAmount]
   ,m.ShipPrice [BaseInfo.ShipPrice]
   ,m.PayPrice  [BaseInfo.PayPrice]
   ,m.DiscountAmt [BaseInfo.PromotionAmount]
   ,m.SOAmt [BaseInfo.SOAmount]
   ,m.PayTypeSysNo [BaseInfo.PayTypeSysNo]
   ,m.IsUseChequesPay [BaseInfo.IsUseChequesPay]
   ,m.PointPay [BaseInfo.PointPay]
   ,m.PrepayAmt [BaseInfo.PrepayAmount]
   ,m.IsUsePrepay [BaseInfo.IsUsePrePay]
   ,m.GiftCardPay [BaseInfo.GiftCardPay]
   ,m.HoldUser [BaseInfo.HoldUser]
   ,m.HoldReason [BaseInfo.HoldReason]
   ,m.HoldDate [BaseInfo.HoldTime]
   ,m.HoldMark 
   ,m.ShoppingMasterSysNo [BaseInfo.ShoppingMasterSysNo]
   ,m.ReceiveAreaSysNo [ReceiverInfo.AreaSysNo]
   ,m.ReceiveContact [ReceiverInfo.Name]
   ,m.ReceiveAddress [ReceiverInfo.Address]
   ,m.ReceiveCellPhone [ReceiverInfo.MobilePhone]
   ,m.ReceivePhone [ReceiverInfo.Phone]
   ,m.ReceiveZip [ReceiverInfo.Zip]
   ,m.ReceiveName [InvoiceInfo.Header]
   ,m.IsVAT [InvoiceInfo.IsVAT]
   ,m.InvoiceNote [InvoiceInfo.InvoiceNote]
   ,m.InvoiceNo [InvoiceInfo.InvoiceNo]
   ,m.FinanceNote [InvoiceInfo.FinanceNote]
   ,m.ShipTypeSysNo  [ShippingInfo.ShipTypeSysNo]
   ,m.AllocatedManSysNo [ShippingInfo.AllocatedManSysNo]
   ,m.FreightUserSysNo [ShippingInfo.FreightUserSysNo]
   ,m.PackageID  [ShippingInfo.PackageID]
   ,m.OutUserSysNo [ShippingInfo.OutUserSysNo]
   ,m.OutTime [ShippingInfo.OutTime]
   ,m.DeliveryMemo [ShippingInfo.DeliveryMemo]
   ,m.DeliveryDate [ShippingInfo.DeliveryDate]
   ,m.DeliveryTimeRange [ShippingInfo.DeliveryTimeRange]
   ,m.StockSysNo 
   ,m.CashPay 
   ,m.UpdateUserSysNo 
   ,m.AuditUserSysNo 
   ,m.AuditTime 
   ,m.ManagerAuditUserSysNo 
   ,m.ManagerAuditTime 
   ,m.IsPrintPackageCover [ShippingInfo.IsPrintPackageCover]
   ,m.PromotionCustomerSysNo 
   ,m.PositiveSOSysNo 
   ,m.PromotionCodeSysNo 
   ,m.HaveAutoRMA 
   ,m.CurrencySysNo 
   ,m.LanguageCode [BaseInfo.LanguageCode]
   --,m.StoreCompanyCode 
   ,m.ReceivingStatus 
   ,m.CompanyCode [CompanyCode]
   ,m.TariffAmt [BaseInfo.TariffAmount]
   
   ,c.SOType [BaseInfo.SOType]
   ,c.MemoForCustomer [BaseInfo.MemoForCustomer]
   ,c.IsBackOrder [BaseInfo.IsBackOrder]
   ,c.VIPSOType [BaseInfo.VIPSOType]
   ,c.VIPUserType  [BaseInfo.VIPUserType]
   ,c.IsExtendWarrantyOrder [BaseInfo.IsExtendWarrantyOrder]
   ,c.IsExpiateOrder [BaseInfo.IsExpiateOrder]
   ,c.IsExperienceOrder [BaseInfo.IsExperienceOrder]
   ,c.IsDCOrder [BaseInfo.IsDCOrder]
   ,c.DC_Status  [BaseInfo.DCStatus]
   ,c.SettlementStatus [BaseInfo.SettlementStatus]
   ,c.ReferenceSysno [BaseInfo.ReferenceSysNo]
   ,c.SpecialSOType [BaseInfo.SpecialSOType]
   ,c.SplitUserSysNo [InvoiceInfo.SplitUserSysNo]
   ,c.SplitDateTime [InvoiceInfo.SplitDateTime]
   ,c.SoSplitType [BaseInfo.SplitType]
   ,c.SoSplitMaster [BaseInfo.SOSplitMaster]
   ,c.HoldStatus
   ,c.InvoiceType [InvoiceInfo.InvoiceType]
   ,c.IsMultiInvoice [InvoiceInfo.IsMultiInvoice]
   ,c.IsVATPrinted [InvoiceInfo.IsVATPrinted]
   ,c.NeedInvoice [BaseInfo.NeedInvoice]
   ,c.IsRequireShipInvoice [InvoiceInfo.IsRequireShipInvoice]
   ,c.RingOutShipType  [ShippingInfo.RingOutShipType]
   ,c.DeliverySection [ShippingInfo.DeliverySection]
   ,c.DeliveryPromise [ShippingInfo.DeliveryPromise]
   ,c.ShippingType [ShippingInfo.ShippingType]
   ,c.WeightSO [ShippingInfo.Weight]
   ,c.ShippingFee [ShippingInfo.ShippingFee]
   ,c.PackageFee [ShippingInfo.PackageFee]
   ,c.RegisteredFee [ShippingInfo.RegisteredFee]
   ,c.Weight3PL  [ShippingInfo.Weight3PL]
   ,c.ShipCost  [ShippingInfo.ShipCost]
   ,c.ShipCost3PL [ShippingInfo.ShipCost3PL]
   ,c.OriginShipPrice [ShippingInfo.OriginShipPrice]
   ,c.VPOStatus [ShippingInfo.VPOStatus]
   ,c.IsCombine [ShippingInfo.IsCombine]
   ,c.IsMergeComplete [ShippingInfo.IsMergeComplete]
   ,c.MergeCompleteTime [ShippingInfo.MergeCompleteTime]
   ,c.MergeOutTime [ShippingInfo.MergeOutTime]
   ,c.DestWarehouseNumber [ShippingInfo.MergeToStockSysNo]
   ,c.StockStatus [ShippingInfo.StockStatus]
   ,c.StockType  [ShippingInfo.StockType]
   ,s.OfficialWebsite [ShippingInfo.OfficialWebsite]
   ,c.IsFPSO [FPInfo.IsFPSO]
   ,c.FPReason [FPInfo.FPReason]
   ,c.IsFPCheck [FPInfo.IsFPCheck]
   ,c.FPCheckTime [FPInfo.FPCheckTime]
   ,c.FPExtend [FPInfo.FPExtend]
   ,c.CustomerIPAddress [ClientInfo.CustomerIPAddress]
   ,c.CustomerCookie  [ClientInfo.CustomerCookie]
   ,c.IsPhoneOrder  [ClientInfo.PhoneType]
   ,c.CreateTime  
   ,c.IsDuplicateOrder
   ,c.IsDirectAlipay
   ,c.TenpayCoupon
   ,c.MKTActivityType
   ,c.AuditType [BaseInfo.AuditType]
   ,c.AuditType
   ,c.AuditSOSendMailFlag
   ,c.AutoAuditMemo
   ,c.IsLastVat
   ,c.LocalWHSysNo [ShippingInfo.LocalWHSysNo]
   ,c.DeliveryType
   ,c.MerchantSysNo [Merchant.MerchantID]
   ,c.MerchantSysNo [Merchant.SysNo]
   ,v.VendorName [Merchant.MerchantName]
   ,p.IsPayWhenRecv [BaseInfo.PayWhenReceived]
   ,p.IsNet
   ,KFC.FraudType AS [BaseInfo.KFCStatus]
   ,channelm.SOChannelCode [WebChannel.ChannelID]
FROM IPP3.dbo.V_SO_Master m WITH(NOLOCK)
INNER JOIN [IPP3].[dbo].[Customer] t WITH(NOLOCK)
ON t.SysNo=m.CustomerSysNo
INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerExtend te WITH(NOLOCK)
ON t.SysNo=te.CustomerSysno
INNER JOIN  IPP3.dbo.SO_CheckShipping  c WITH(NOLOCK)
ON c.SOSysNo= m.SysNo 
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType p WITH(NOLOCK)
ON m.PayTypeSysNo = p.SysNo
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType s WITH(NOLOCK)
ON m.ShipTypeSysNo= s.SysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC WITH (NOLOCK)
ON m.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.ThridPart_SOMapping tpso WITH(NOLOCK) 
ON m.SysNo = tpso.SOSysNo
LEFT JOIN OverseaContentManagement.dbo.V_IM_ChannelMaster channelm WITH(NOLOCK) 
ON channelm.SOChannelCode = tpso.[TYPE]
LEFT JOIN IPP3.dbo.Vendor v WITH(NOLOCK)				
ON c.MerchantSysNo=v.SysNo
#SO_ConditionString#

SELECT
      i.SysNo
      ,i.SOSysNo
      ,i.ProductSysNo
      ,i.BriefName [ProductName]
      ,i.ProductType
      ,i.Quantity
      ,i.Price
      ,i.DiscountAmt [PromotionAmount]
      ,i.PromotionDiscount [CouponAverageDiscount]
      ,i.OriginalPrice
      ,i.Cost [CostPrice]
      ,i.UnitCostWithoutTax [NoTaxCostPrice]
      ,i.IsMemberPrice [PriceType]
      ,i.Point [GainAveragePoint]
      ,i.PointType [PayType]
      ,i.Warranty
      ,i.[Weight]
      ,i.WarehouseNumber [StockSysNo]
      ,i.MasterProductSysNo [MasterProductSysNo]
      ,i.IsShippedOut [IsShippedOut]
      ,i.ShippedOutTime [ShippedOutTime]
      
      ,i.GiftSysNo
      ,i.DiscountType
      ,i.IsDuplicateOrder
      ,i.DuplicateSOSysNo
      ,i.CompanyCode
      ,i.CurrencySysNo
      ,i.LanguageCode
      ,i.StoreCompanyCode
      ,iet.Discount [AdjustPrice]
      ,iet.Reason [AdjustPriceReason]
      ,p.InventoryType
      ,i.TariffAmt [TariffAmount]
      ,isnull(i.StoreType,0) [StoreType]
      ,pe.TariffRate
  FROM	IPP3.dbo.V_SO_Item i WITH(NOLOCK) 
      INNER JOIN  IPP3.dbo.SO_CheckShipping  c  WITH(NOLOCK) 
        ON c.SOSysNo= i.SOSysNo
      INNER JOIN IPP3.dbo.V_SO_Master m WITH(NOLOCK) 
        ON m.SysNo = i.SOSysNo
      LEFT JOIN IPP3.dbo.Product p WITH(NOLOCK) 
        on i.ProductSysNo =p.SysNo
     LEFT JOIN OverseaOrderManagement.dbo.SO_ItemExtend iet WITH(NOLOCK)
      ON i.SOSysNo = iet.SOSysNo AND i.ProductSysNo = iet.ProductSysNo
            LEFT JOIN IPP3.dbo.Product_EntryInfo pe WITH(NOLOCK) 
        on p.SysNo = pe.ProductSysNo 
        WHERE  i.SOSysNo in (  
        SELECT
      #Top#
    m.SysNo FROM IPP3.dbo.V_SO_Master m WITH(NOLOCK)
INNER JOIN [IPP3].[dbo].[Customer] t WITH(NOLOCK)
ON t.SysNo=m.CustomerSysNo
INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerExtend te WITH(NOLOCK)
ON t.SysNo=te.CustomerSysno
INNER JOIN  IPP3.dbo.SO_CheckShipping  c WITH(NOLOCK)
ON c.SOSysNo= m.SysNo 
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType p WITH(NOLOCK)
ON m.PayTypeSysNo = p.SysNo
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType s WITH(NOLOCK)
ON m.ShipTypeSysNo= s.SysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC WITH (NOLOCK)
ON m.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.ThridPart_SOMapping tpso WITH(NOLOCK) 
ON m.SysNo = tpso.SOSysNo
LEFT JOIN OverseaContentManagement.dbo.V_IM_ChannelMaster channelm WITH(NOLOCK) 
ON channelm.SOChannelCode = tpso.[TYPE]
LEFT JOIN IPP3.dbo.Vendor v WITH(NOLOCK)				
ON c.MerchantSysNo=v.SysNo
#SO_ConditionString#)
      ]]>
    </commandText>
  </dataCommand>

  <!--根据一组订单编号取得一组订单,但不是订单的所有信息-->
  <dataCommand name="SO_Get_SimpleSOListBySOSysNos" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[SELECT
    m.SysNo 
   ,m.SOID [BaseInfo.SOID]
   ,m.CustomerSysNo [BaseInfo.CustomerSysNo]
   ,m.Status
   ,m.LanguageCode [BaseInfo.LanguageCode]
   ,m.OutTime [ShippingInfo.OutTime]
   ,m.PayTypeSysNo [BaseInfo.PayTypeSysNo]
   ,m.ReceiveCellPhone [ReceiverInfo.MobilePhone]
   ,m.ReceivePhone [ReceiverInfo.Phone]
   ,m.InvoiceNo [InvoiceInfo.InvoiceNo]
   ,m.ShipTypeSysNo  [ShippingInfo.ShipTypeSysNo]
   ,m.HaveAutoRMA 
   ,m.CashPay 
   ,m.HoldMark
   ,m.AuditUserSysNo 
   ,m.AuditTime 
   ,m.ManagerAuditUserSysNo 
   ,m.ManagerAuditTime  
   
   ,c.SOType [BaseInfo.SOType]
   ,c.IsBackOrder [BaseInfo.IsBackOrder]
   ,c.IsCombine [ShippingInfo.IsCombine]
   ,c.IsMergeComplete [ShippingInfo.IsMergeComplete]
   ,c.MergeCompleteTime [ShippingInfo.MergeCompleteTime]
   ,p.IsPayWhenRecv [BaseInfo.PayWhenReceived]
   ,c.HoldStatus
   ,c.AuditType
FROM IPP3.dbo.V_SO_Master m 
LEFT JOIN  IPP3.dbo.SO_CheckShipping  c  
    ON c.SOSysNo= m.SysNo 
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType p 
    ON m.PayTypeSysNo = p.SysNo
WHERE	m.SysNo IN (#SOSysNo#)
      ]]>
    </commandText>
  </dataCommand>

  <!--取得订单基本信息-->
  <dataCommand name="SO_Get_SOBaseInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[SELECT #Top#
    m.SysNo 
   ,m.SOID [SOID]
   ,m.CustomerSysNo [CustomerSysNo]
   ,m.Status 
   ,m.OrderDate [CreateTime]
   ,m.IsWholeSale [IsWholeSale]
   ,m.IsLarge  [IsLarge]
   ,m.PointAmt [GainPoint]
   ,m.Memo [Memo]
   ,m.Note [Note]
   ,m.SalesManSysNo [SalesManSysNo]
   ,m.UpdateTime [UpdateTime]
   ,m.IsMobilePhone [IsPhoneOrder]
   ,m.IsVIP  [IsVIP]
   ,m.IsPremium  [IsPremium]
   ,m.PremiumAmt [PremiumAmount]
   ,m.ShipPrice [ShipPrice]
   ,m.PayPrice  [PayPrice]
   ,m.DiscountAmt [PromotionAmount]
   ,m.SOAmt [SOAmount]
   ,m.PayTypeSysNo [PayTypeSysNo]
   ,m.IsUseChequesPay [IsUseChequesPay]
   ,m.PointPay [PointPay]
   ,m.PrepayAmt [PrepayAmount]
   ,m.IsUsePrepay [IsUsePrePay]
   ,m.GiftCardPay [GiftCardPay]
   ,m.HoldUser [HoldUser]
   ,m.HoldReason [HoldReason]
   ,m.HoldDate [HoldTime]
   ,m.HoldMark 
   ,m.HaveAutoRMA 
   ,m.CashPay 
   ,m.CompanyCode [CompanyCode]
   ,m.LanguageCode [LanguageCode]
   ,m.TariffAmt [TariffAmount]
   
   ,c.SOType [SOType]
   ,c.MemoForCustomer [MemoForCustomer]
   ,c.IsBackOrder [IsBackOrder]
   ,c.VIPSOType [VIPSOType]
   ,c.VIPUserType  [VIPUserType]
   ,c.IsExtendWarrantyOrder [IsExtendWarrantyOrder]
   ,c.IsExpiateOrder [IsExpiateOrder]
   ,c.IsExperienceOrder [IsExperienceOrder]
   ,c.IsDCOrder [IsDCOrder]
   ,c.DC_Status  [DCStatus]
   ,c.SettlementStatus [SettlementStatus]
   ,c.ReferenceSysno [ReferenceSysNo]
   ,c.SpecialSOType [SpecialSOType]
   ,c.SoSplitType [SplitType]
   ,c.SoSplitMaster [SOSplitMaster]
   ,c.HoldStatus [HoldStatus]
   ,c.MerchantSysNo [Merchant.MerchantID]
   ,c.IsCombine [IsCombine]
   ,c.IsMergeComplete [IsMergeComplete]
   ,p.IsPayWhenRecv [PayWhenReceived]
   ,p.IsNet
FROM IPP3.dbo.SO_Master m WITH(NOLOCK)
INNER JOIN  IPP3.dbo.SO_CheckShipping  c WITH(NOLOCK)
    ON c.SOSysNo= m.SysNo 
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType p  WITH(NOLOCK)
    ON m.PayTypeSysNo = p.SysNo
    #SO_ConditionString#

      ]]>
    </commandText>
  </dataCommand>

  <!--取得订单商品信息-->
  <dataCommand name="SO_Get_SOItemsBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      i.SysNo
      ,i.SOSysNo
      ,i.ProductSysNo
      ,i.BriefName [ProductName]
      ,i.ProductType
      ,i.Quantity
      ,i.Price
      ,i.PromotionDiscount [CouponAverageDiscount]
      ,i.OriginalPrice
      ,i.Cost [CostPrice]
      ,i.UnitCostWithoutTax [NoTaxCostPrice]
      ,i.IsMemberPrice [PriceType]
      ,i.Point [GainAveragePoint]
      ,i.PointType [PayType]
      ,i.Warranty
      ,i.[Weight]
      ,i.WarehouseNumber [StockSysNo]
      ,i.MasterProductSysNo [MasterProductSysNo]
      ,i.IsShippedOut [IsShippedOut]
      ,i.ShippedOutTime [ShippedOutTime]

      ,i.DiscountAmt
      ,i.GiftSysNo
      ,i.DiscountType
      ,i.IsDuplicateOrder
      ,i.DuplicateSOSysNo
      ,i.CompanyCode
      ,i.CurrencySysNo
      ,i.LanguageCode
      ,i.StoreCompanyCode
      ,ie.ReferenceSysNo [ReferenceSysNo]
      ,ie.SettlementStatus [SettlementStatus]
      ,ie.[Type] [ActivityType]
      ,iet.Discount [AdjustPrice]
      ,iet.Reason [AdjustPriceReason]
      ,p.InventoryType
      ,i.TariffAmt [TariffAmount]
  FROM	IPP3.dbo.V_SO_Item i WITH(NOLOCK) 
  left join ipp3.dbo.product p WITH(NOLOCK) 
    on p.sysno=i.ProductSysNo
  LEFT JOIN OverseaOrderManagement.dbo.SO_Item_Extension ie WITH(NOLOCK)
    ON i.SOSysNo = ie.SOSysNo AND i.ProductSysNo = ie.ProductSysNo
   LEFT JOIN OverseaOrderManagement.dbo.SO_ItemExtend iet WITH(NOLOCK)
    ON i.SOSysNo = iet.SOSysNo AND i.ProductSysNo = iet.ProductSysNo
      WHERE i.SOSysNo = @SOSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号取得订单使用的组合销售(销售规则)-->
  <dataCommand name="SO_Get_SOComboBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[ 
SELECT 
    SOSysNo
   ,SaleRuleSysNo [PromotionSysNo]
   ,Discount*Times [DiscountAmount]
   ,Times [Time]
   ,Note 
   ,SaleRuleName [PromotionName]
   ,Discount
   ,ReferenceType
FROM IPP3.dbo.SO_SaleRule WITH(NOLOCK)
WHERE  
    SOSysNo = @SOSysNo  

SELECT  
    s.SaleRuleSysNo [PromotionSysNo]
   ,i.ProductSysNo [MasterProductSysNo] 
   ,i.ProductType [MasterProductType] 
   ,i.DiscountAmt  [DiscountAmount] 
   ,s.Times * si.Quantity [MasterProductQuantity]
   ,s.ReferenceType
FROM IPP3.dbo.SO_item  i  WITH(NOLOCK)
INNER JOIN IPP3.dbo.SO_SaleRule s  WITH(NOLOCK)
    ON i.SOSysNo = s.SOSysNo 
INNER JOIN  IPP3.dbo.SaleRule_Item si  WITH(NOLOCK)
    ON s.SaleRuleSysNo = si.SaleRuleSysNo 
    AND i.ProductSysNo= si.ProductSysNo 
WHERE     
    i.SOSysNo = @SOSysNo 
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--添加到订单组合销售规则-->
  <dataCommand name="SO_Insert_SOSaleRule" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					INSERT INTO IPP3.dbo.SO_SaleRule
                 (SOSysNo
                 ,SaleRuleSysNo
                 ,SaleRuleName
                 ,Discount
                 ,Times
                 ,Note
				 ,CompanyCode)
           VALUES 
                  (@SOSysNo
                  ,@SaleRuleSysNo
                  ,@SaleRuleName
                  ,@Discount
                  ,@Times
                  ,@Note
				  ,@CompanyCode)

        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@SaleRuleSysNo" dbType="Int32"/>
      <param name="@SaleRuleName" dbType="String" size="500"/>
      <param name="@Discount" dbType="Decimal"/>
      <param name="@Times" dbType="Int32"/>
      <param name="@Note" dbType="String" size="200"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号取得订单参与的赠品规则-->
  <dataCommand name="SO_Get_SOSelfGiftBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[ 
SELECT  
    PromotionSysNo [PromotionSysNo]
   ,[Count] [Time]
   ,[Type] [InnerType]
   ,[Order] [Priority]
FROM OverseaOrderManagement.dbo.SO_GiftMaster 
WHERE  
    SOSysNo = @SOSysNo

SELECT 
    ProductSysNo [ProductSysNo]
   ,Quantity [Quantity]
   ,PromotionSysNo [PromotionSysNo]
FROM OverseaOrderManagement.dbo.SO_GiftItem 
WHERE  
    SOSysNo = @SOSysNo 
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号取得订单商品的附件和厂商赠品-->
  <dataCommand name="SO_Get_SOAccessoryAndVendorGiftBySOSysNoV2" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[ 
SELECT  
    PromotionSysNo 
   ,Type AS Type
   ,a.MasterProductSysNo [MasterProductSysNo] 
   ,i.ProductType [MasterProductType] 
   ,i.Quantity [MasterProductQuantity] 
   ,a.ProductSysNo [ProductSysNo] 
   ,a.Quantity [Quantity] 
FROM OverseaOrderManagement.dbo.SO_Item_Accessory  a 
INNER JOIN IPP3 .dbo.SO_Item i 
    ON  a.SOSysNo= i.SOSysNo 
    AND a.MasterProductSysNo = i.ProductSysNo 
WHERE 
    i.ProductType=0 
    AND a.SOSysNo= @SOSysNo  
ORDER BY  a.PromotionSysNo DESC
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号取得订单商品的附件和厂商赠品-->
  <dataCommand name="SO_Get_SOAccessoryAndVendorGiftBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[ 
SELECT  
    PromotionSysNo 
   ,CASE	WHEN [Type]='A' THEN 'Accessory' 
			    WHEN [Type]='V' THEN 'VendorGift'  
			    ELSE NULL END AS [PromotionType] 
   ,a.MasterProductSysNo [MasterProductSysNo] 
   ,i.ProductType [MasterProductType] 
   ,i.Quantity [MasterProductQuantity] 
   ,a.ProductSysNo [ProductSysNo] 
   ,a.Quantity [Quantity] 
FROM OverseaOrderManagement.dbo.SO_Item_Accessory  a 
INNER JOIN IPP3 .dbo.SO_Item i 
    ON  a.SOSysNo= i.SOSysNo 
    AND a.MasterProductSysNo = i.ProductSysNo 
WHERE 
    i.ProductType=0 
    AND a.SOSysNo= @SOSysNo  
ORDER BY  a.PromotionSysNo DESC
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--包括历史记录 IPP3:GetItemGrossProfitsBySOSysNo-->
  <dataCommand name="SO_Get_ItemGrossProfitsBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      
      Select 
        SOSysNo
	      ,ActionType
	      ,ProductSysNo
	      ,Quantity
	      ,DisCount
	      ,GrossProfitType
	      ,Status
      FROM  OverseaOrderManagement.dbo.SO_ItemGrossProfit with(nolock)
      where SOSysno=@SOSysNo And Status='A'
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!-- 添加订单毛利分配 IPP3:InsertGossProfit-->
  <dataCommand name="SO_Insert_ItemGossProfit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      INSERT INTO OverseaOrderManagement.dbo.SO_ItemGrossProfit
      (
	      [SOSysNo]
        ,[ActionType]
        ,[ProductSysNo]
        --,[Quantity]
        ,[DisCount]
        ,[GrossProfitType]
        ,[Status]
        ,[InDate]
        ,[InUser]
	      )
      VALUES
      (
	      @SOSysNo
	      ,@ActionType
	      ,@ProductSysNo
	      --,@Quantity
	      ,@DisCount
	      ,@GrossProfitType
	      ,@Status
	      ,Getdate()
        ,@InUser
	      )
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ActionType" dbType="String"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@DisCount" dbType="Decimal"/>
      <param name="@GrossProfitType" dbType="Int32"/>
      <param name="@Status"  dbType="AnsiStringFixedLength" size="1" />
      <param name="@InUser" dbType="String" property="[USERACCT]"/>
    </parameters>
  </dataCommand>

  <!--包括历史记录 IPP3:GetSOListAll-->
  <dataCommand name="SO_Query_GetSOAll" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
 SELECT   @TotalCount = COUNT(sm.sysno)
FROM IPP3.dbo.V_SO_Master sm WITH (NOLOCK) 
LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC ON sm.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN ON sm.SysNo = OCN.SOSysNo
LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
LEFT JOIN OverseaOrderManagement.dbo.SO_Unicom sim WITH(NOLOCK) ON sm.SysNo=sim.SOSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo
LEFT JOIN ipp3.dbo.customer AS Customer WITH(NOLOCK) ON sm.CustomerSysNo = Customer.SysNo
#StrWhere# 
                             
DECLARE @OriginPageSize AS INT;
DECLARE @PageSize AS INT;

SET @OriginPageSize = @EndNumber - @StartNumber;

IF @EndNumber > @TotalCount
  SET @EndNumber = @TotalCount

IF (@EndNumber - @StartNumber) < 0
  SET @PageSize = @OriginPageSize
ELSE
  SET @PageSize = @EndNumber - @StartNumber

;WITH s AS 
(
	SELECT TOP (@PageSize)  SysNo, RowNumber  
	FROM 
	(
		SELECT TOP (@EndNumber) sm.SysNo AS SysNo,
		ROW_NUMBER() OVER(order by #SortColumnName#) AS RowNumber
		FROM IPP3.dbo.V_SO_Master sm WITH (NOLOCK) 
		LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
		LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
		LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
		LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
		LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
		LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
		LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC ON sm.CustomerSysNo = KFC.CustomerSysNo
		LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN ON sm.SysNo = OCN.SOSysNo
		LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
		LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
		LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
		LEFT JOIN OverseaOrderManagement.dbo.SO_Unicom sim WITH(NOLOCK) ON sm.SysNo=sim.SOSysNo
    LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo
    LEFT JOIN ipp3.dbo.customer AS Customer WITH(NOLOCK) ON sm.CustomerSysNo = Customer.SysNo
		#StrWhere# 
	) AS a
	ORDER BY RowNumber DESC
)
                          
SELECT   sm.sysno as SysNo
    ,sm.soid as SOID
    ,sm.status as Status
    ,sm.customersysno as CustomerSysNo
    ,cm.CustomerID as CustomerID
    ,sm.receivename as ReceiveName
    ,sm.receivecellphone as ReceiveCellPhone
    ,sm.receivephone as ReceivePhone
    ,CashPay+PayPrice+sm.ShipPrice+PremiumAmt+sm.DiscountAmt as SOAmount
    ,sm.DiscountAmt as DiscountAmount
    ,sm.pointpay as PointPay
    ,sm.pointamt as Point
    ,sm.orderdate as OrderTime
    ,suat.DisplayName as AuditName
    ,sm.outtime as OutStockTime
    ,sm.paytypesysno as PayTypeSysNo
    ,pt.paytypename as PayTypeName
    ,vinp.status as NetPayStatus
    ,CONVERT(bit,isnull(IsPhoneOrder,0)) as IsPhoneOrder
    ,channelm.ChannelName WebChannelName
    ,sm.HaveAutoRMA
    ,isnull(SO_CheckShipping.SOType,0) as SOType
    
    ,sm.PromotionCodeSysNo as PromotionCodeSysNo
    ,sm.IsVAT
    ,sm.audittime as AuditTime
    ,suud.DisplayName as UpdatedMan
    ,fs.status as SOIncomeStatus
    ,isPayWhenRecv 
    ,isMobilePhone
    ,cm.VIPRank VIPRank
    ,vipp.status as PostPayStatus
    ,pt.isnet as IsNet
    ,isnull(SO_CheckShipping.IsFPSO,0) as IsFPSO
    ,isnull(SO_CheckShipping.IsFPCheck,0) as IsFPCheck
    ,ShipType.ShipTypeName as ShipTypeName
    ,isnull(SO_CheckShipping.IsDuplicateOrder,0) as IsDuplicateOrder
    ,KFC.FraudType
    ,IsBackOrder
    ,OCN.Status OcnStatus
    ,OCN.IsSubmit
    ,SO_CheckShipping.CustomerIPAddress
    ,SO_CheckShipping.DeliveryPromise
    ,SO_CheckShipping.SOSplitType
		,SO_CheckShipping.StockType
		,SO_CheckShipping.ShippingType
		,SO_CheckShipping.InvoiceType
    ,SO_CheckShipping.IsCombine
    ,SO_CheckShipping.IsMergeComplete
    ,shc.ShoppingCartSysNo  AS ShoppingCartNo
FROM s
INNER JOIN IPP3.dbo.V_SO_Master sm WITH (NOLOCK) on sm.sysno = s.SysNo
LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC WITH (NOLOCK) ON sm.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN  WITH (NOLOCK) ON sm.SysNo = OCN.SOSysNo
LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
LEFT JOIN OverseaOrderManagement.dbo.ThridPart_SOMapping tpso WITH(NOLOCK) ON sm.SysNo = tpso.SOSysNo
LEFT JOIN OverseaContentManagement.dbo.V_IM_ChannelMaster channelm WITH(NOLOCK) ON channelm.SOChannelCode = tpso.[TYPE]
LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo
ORDER BY RowNumber
        ]]>
    </commandText>
  </dataCommand>

  <!--不包括历史记录 IPP3:GetSOList-->
  <dataCommand name="SO_Query_GetSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT   @TotalCount = COUNT(sm.sysno)
FROM IPP3.dbo.SO_Master sm WITH (NOLOCK) 
LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC ON sm.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN ON sm.SysNo = OCN.SOSysNo
LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
LEFT JOIN OverseaOrderManagement.dbo.SO_Unicom sim WITH(NOLOCK) ON sm.SysNo=sim.SOSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo
LEFT JOIN ipp3.dbo.customer AS Customer WITH(NOLOCK) ON sm.CustomerSysNo = Customer.SysNo
#StrWhere# 
                             
DECLARE @OriginPageSize AS INT;
DECLARE @PageSize AS INT;

SET @OriginPageSize = @EndNumber - @StartNumber;

IF @EndNumber > @TotalCount
  SET @EndNumber = @TotalCount

IF (@EndNumber - @StartNumber) < 0
  SET @PageSize = @OriginPageSize
ELSE
  SET @PageSize = @EndNumber - @StartNumber

;WITH s AS 
(
	SELECT TOP (@PageSize)  SysNo, RowNumber  
	FROM 
	(
		SELECT TOP (@EndNumber) sm.SysNo AS SysNo,
		ROW_NUMBER() OVER(order by #SortColumnName#) AS RowNumber
		FROM IPP3.dbo.SO_Master sm WITH (NOLOCK) 
		LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
		LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
		LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
		LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
		LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
		LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
		LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC ON sm.CustomerSysNo = KFC.CustomerSysNo
		LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN ON sm.SysNo = OCN.SOSysNo
		LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
		LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
		LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
		LEFT JOIN OverseaOrderManagement.dbo.SO_Unicom sim WITH(NOLOCK) ON sm.SysNo=sim.SOSysNo
    LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo
    LEFT JOIN ipp3.dbo.customer AS Customer WITH(NOLOCK) ON sm.CustomerSysNo = Customer.SysNo
		#StrWhere# 
	) AS a
	ORDER BY RowNumber DESC
)
                          
SELECT   sm.sysno as SysNo
    ,sm.soid as SOID
    ,sm.status as Status
    ,sm.customersysno as CustomerSysNo
    ,cm.CustomerID as CustomerID
    ,sm.receivename as ReceiveName
    ,sm.ReceiveContact
    ,sm.ReceiveAddress
    ,sm.receivecellphone as ReceiveCellPhone
    ,sm.receivephone as ReceivePhone
    ,CashPay+PayPrice+sm.ShipPrice+PremiumAmt+sm.DiscountAmt+sm.TariffAmt as SOAmount
    ,sm.DiscountAmt as DiscountAmount
    ,sm.pointpay as PointPay
    ,sm.pointamt as Point
    ,sm.orderdate as OrderTime
    ,suat.DisplayName as AuditName
    ,sm.outtime as OutStockTime
    ,sm.paytypesysno as PayTypeSysNo
    ,pt.paytypename as PayTypeName
    ,vinp.status as NetPayStatus
    ,CONVERT(bit,isnull(IsPhoneOrder,0)) as IsPhoneOrder
    ,channelm.ChannelName WebChannelName
    ,sm.HaveAutoRMA
    ,isnull(SO_CheckShipping.SOType,0) as SOType
    
    ,sm.PromotionCodeSysNo as PromotionCodeSysNo
    ,sm.IsVAT
    ,sm.audittime as AuditTime
    ,suud.DisplayName as UpdatedMan
    ,fs.status as SOIncomeStatus
    ,isPayWhenRecv 
    ,isMobilePhone
    ,cm.VIPRank VIPRank
    ,vipp.status as PostPayStatus
    ,pt.isnet as IsNet
    ,isnull(SO_CheckShipping.IsFPSO,0) as IsFPSO
    ,isnull(SO_CheckShipping.IsFPCheck,0) as IsFPCheck
    ,ShipType.ShipTypeName as ShipTypeName
    ,isnull(SO_CheckShipping.IsDuplicateOrder,0) as IsDuplicateOrder
    ,KFC.FraudType
    ,IsBackOrder
    ,OCN.Status OcnStatus
    ,OCN.IsSubmit
    ,SO_CheckShipping.CustomerIPAddress
    ,SO_CheckShipping.DeliveryPromise
    ,SO_CheckShipping.SOSplitType
		,SO_CheckShipping.StockType
		,SO_CheckShipping.ShippingType
		,SO_CheckShipping.InvoiceType
    ,SO_CheckShipping.IsCombine
    ,SO_CheckShipping.IsMergeComplete
    ,shc.ShoppingCartSysNo AS ShoppingCartNo
    ,u.username as AuditUserName
    ,n.inputtime as InputTime
FROM s
INNER JOIN IPP3.dbo.SO_Master sm WITH (NOLOCK) on sm.sysno = s.SysNo
LEFT JOIN IPP3.dbo.SO_CheckShipping WITH (NOLOCK) ON SO_CheckShipping.SOSysNo = sm.sysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suat WITH (NOLOCK) ON suat.UserSysNo = sm.auditusersysno
LEFT JOIN OverseaArchitecture.dbo.V_AR_UserInfo suud WITH (NOLOCK) ON suud.UserSysNo = sm.updateusersysno
LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cm WITH (NOLOCK) ON cm.sysno = sm.customersysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_PayType pt WITH (NOLOCK) ON pt.sysno = sm.paytypesysno
LEFT JOIN OverseaControlPanel.dbo.V_CP_ShipType ShipType WITH (NOLOCK) ON ShipType.sysno=sm.ShipTypeSysNo
LEFT JOIN OverseaOrderManagement.dbo.KnownFraudCustomer KFC WITH (NOLOCK) ON sm.CustomerSysNo = KFC.CustomerSysNo
LEFT JOIN OverseaOrderManagement.dbo.SO_OldChangeNew OCN  WITH (NOLOCK) ON sm.SysNo = OCN.SOSysNo
LEFT JOIN IPP3.dbo.Finance_SOIncome fs WITH (NOLOCK)  ON fs.[Status]>-1 and fs.ordertype=1 and fs.ordersysno = sm.sysno  
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_NetPay vinp ON sm.SysNo = vinp.SOSysNo AND vinp.[Status] > -1 
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_PostPay vipp ON sm.SysNo = vipp.SOSysNo AND vipp.[Status] > 0
LEFT JOIN OverseaOrderManagement.dbo.ThridPart_SOMapping tpso WITH(NOLOCK) ON sm.SysNo = tpso.SOSysNo
LEFT JOIN OverseaContentManagement.dbo.V_IM_ChannelMaster channelm WITH(NOLOCK) ON channelm.SOChannelCode = tpso.[TYPE]
LEFT JOIN OverseaOrderManagement.dbo.SO_ShoppingCart shc WITH(NOLOCK) ON sm.SysNo=shc.SOSysNo

LEFT JOIN ipp3.dbo.Finance_netpay n ON sm.Sysno=n.SoSysNo and n.Status>-1
LEFT JOIN ipp3.dbo.sys_user u on  u.sysno=n.ApproveUserSysno

ORDER BY RowNumber
        ]]>
    </commandText>
  </dataCommand>

  <!--SOInvoiceChangeLog-->
  <dataCommand name="SO_Query_GetInvoiceChangeLog" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT @TotalCount = COUNT(1)
        FROM	IPP3.dbo.SO_InvoiceChangeLog AS SICL WITH(NOLOCK)
		        LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] AS STOCK 
                ON (SICL.WarehouseNumber = Stock.SysNo)
        #StrWhere#

        IF @EndNumber > @TotalCount
	        SET @EndNumber = @TotalCount

        ;WITH IT AS (
		          SELECT TOP (@EndNumber - @StartNumber ) a.Sysno, RowNumber 
		          FROM 
			           (SELECT TOP (@EndNumber) SICL.SysNo AS SysNo
						        ,ROW_NUMBER() OVER(ORDER BY #SortColumnName#) AS RowNumber
				         FROM	IPP3.dbo.SO_InvoiceChangeLog AS SICL WITH(NOLOCK)
						        LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] AS STOCK 
                        ON (SICL.WarehouseNumber = Stock.SysNo)
				        #StrWhere#
				        ) AS a
                 ORDER BY RowNumber DESC)

            SELECT	
	              SICL.SysNo 
                ,SICL.SONumber 
                ,SICL.WarehouseNumber
                ,SICL.ChangeType
                ,SICL.CreateUser AS CreateUserName
                ,SICL.CreateTime
                ,SICL.Note
                ,STOCK.StockName
            FROM IT
	            INNER JOIN 	IPP3.dbo.SO_InvoiceChangeLog AS SICL WITH(NOLOCK) 
		            ON (IT.SysNo = SICL.SysNo)
	            LEFT JOIN [OverseaInventoryManagement].[dbo].[V_INM_Stock] AS STOCK 
		            ON SICL.WarehouseNumber = CAST(Stock.SysNo AS VARCHAR(4))
            ORDER BY RowNumber
        ]]>
    </commandText>
  </dataCommand>

  <!--审核订单 IPP3:UpdateSOStatus -->
  <dataCommand name="SO_Update_SOStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
UPDATE IPP3.dbo.SO_Master 
SET Status=@Status 
   ,UpdateTime=GETDATE() 
WHERE 
    SysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--审核订单 IPP3:UpdateSOAuditInfo -->
  <dataCommand name="SO_Update_SOStatusForAudit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET Status=@Status
					     ,UpdateUserSysNo=@UserSysNo
						   ,UpdateTime=GETDATE()
						   ,AuditUserSysNo=@UserSysNo
						   ,AuditTime=GETDATE()
          WHERE SysNo=@SOSysNo 
           AND [Status] = @OldStatus
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@OldStatus" dbType="Int32"/>
      <param name="@UserSysNo" dbType="Int32" property="[usersysno]"/>
    </parameters>
  </dataCommand>

  <!--主管审核订单 IPP3:UpdateSOManagerAuditInfo -->
  <dataCommand name="SO_Update_SOStatusForManagerAudit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET Status=@Status
					     ,UpdateUserSysNo=@UserSysNo
						   ,UpdateTime=GETDATE()
						   ,ManagerAuditUserSysNo=@UserSysNo
						   ,ManagerAuditTime=GETDATE()
           WHERE SysNo = @SOSysNo
           AND [Status] = @OldStatus
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@OldStatus" dbType="Int32"/>
      <param name="@UserSysNo" dbType="Int32" property="[usersysno]"/>
    </parameters>
  </dataCommand>

  <!--更改订单是否是并单 IPP3:InitCombineSOInfo -->
  <dataCommand name="SO_Update_UpdateCombineSOInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          EXEC IPP3.dbo.up_UpdateCombineSOInfo @SOSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--更新出仓时间为当前时间 IPP3:UpdateOutStockTime,UpdateOutStockTimeForSOItem -->
  <dataCommand name="SO_Update_UpdateOutStockTime" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET OutTime=GETDATE()
          WHERE SysNo=@SOSysNo 
          
					UPDATE IPP3.dbo.SO_Item 
					   SET ShippedOutTime=GETDATE(),IsShippedOut = 1
          WHERE SOSysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--设置订单增票已开具 -->
  <dataCommand name="SO_Update_SOVATPrinted" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_CheckShipping
					   SET IsVATPrinted=1
          WHERE SOSysNo IN (#SOSysNo#)
        ]]>
    </commandText>
  </dataCommand>

  <!--判断订单是否被下载到仓库 IPP3:IsDownLoad -->
  <dataCommand name="SO_Get_SOIsDownLoad" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
                    DECLARE @Return BIT
                    SET @Return = 0
                    IF exists( SELECT TOP(1) 1 
	                    FROM	Dropship.dbo.downloadso WITH(NOLOCK)
	                    WHERE	SoNumber = @SOSysNo)
	                    SET @Return = 1
                    ELSE
                    BEGIN
	                    IF exists(SELECT TOP(1) 1 
	                    FROM	Dropship_History.dbo.downloadso WITH(nolock)
	                    WHERE	SoNumber = @SOSysNo)
	                    SET @Return = 1
                    END
                    SELECT @Return
       ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--订单取消审核 IPP3:UpdateSOCancelAuditInfo -->
  <dataCommand name="SO_Update_CancelAudit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET Status=@Status
					      ,UpdateUserSysNo=@UserSysNo
						    ,UpdateTime=GETDATE()
						    ,AuditUserSysNo=@UserSysNo
						    ,AuditTime=GETDATE()
						    ,FreightUserSysNo = NULL
             WHERE SysNo=@SOSysNo
             AND Status = @OldStatus
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@OldStatus" dbType="Int32"/>
      <param name="@UserSysNo" dbType="Int32" property="[usersysno]"/>
    </parameters>
  </dataCommand>

  <!--修改锁定信息 IPP3:UpdateSOHoldInfo -->
  <dataCommand name="SO_Update_SOHoldInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET HoldMark=@HoldMark
					      ,HoldDate=GETDATE()
						    ,HoldUser=@HoldUser
						    ,HoldReason=@HoldReason
          WHERE SysNo=@SysNo 
          
				  UPDATE IPP3.dbo.so_checkshipping 
              SET HoldStatus = @HoldStatus
					       ,HoldDate = GETDATE()
          WHERE  sosysno = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@HoldMark" dbType="Boolean"/>
      <param name="@HoldStatus" dbType="Int32"/>
      <param name="@HoldUser" dbType="Int32" property="[usersysno]"/>
      <param name="@HoldReason" dbType="String" size="200"/>
    </parameters>
  </dataCommand>

  <!--修改锁定信息 IPP3:SOShipOut -->
  <dataCommand name="SO_Update_StockOut" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					SET Status =4
						,ReceivingStatus='SHP'
						,OutTime=getdate()
						,OutUserSysNo=@OperatorSysNo
            ,UpdateTime=Getdate()
          WHERE SysNo=@SOSysno 
					
					UPDATE ipp3.dbo.SO_Item
					SET
						IsShippedOut = 1
						,ShippedOutTime = getdate()
					WHERE SOSysNo=@SOSysno
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@OperatorSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--拆分发票修改订单信息 -->
  <dataCommand name="SO_Update_ForSplitInvoice" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_CheckShipping
					SET  [IsMultiInvoice]=1
              ,[SplitUserSysNo]=@SplitUserSysNo
              ,[SplitDateTime]=GETDATE()
          WHERE SysNo=@SOSysno 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@SplitUserSysNo" dbType="Int32" property="[usersysno]"/>
      <param name="@IsMultiInvoice" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改锁定信息 IPP3:GetShoppingCartSysNo -->
  <dataCommand name="SO_Get_ShoppingCartSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1 
			  ShoppingCartSysNo
		  FROM [OverseaOrderManagement].[dbo].[SO_ShoppingCart] WITH(NOLOCK) 
		  WHERE 
			  SOSysNo=@SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--删除订单商品 IPP3:DeleteSOItemByProductSysNo -->
  <dataCommand name="SO_Delete_SOItemBySOSysNoAndProductSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					Delete FROM IPP3.dbo.SO_Item 
					WHERE	SOSysNo = @SOSysNo
					AND ProductSysNo = @ProductSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="SO_Update_SOAmountInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE IPP3.dbo.SO_Master SET 
					    Status=ISNULL(@Status,Status)
					   ,IsPremium=ISNULL(@IsPremium,IsPremium) 
					   ,PremiumAmt=ISNULL(@PremiumAmount,PremiumAmt)
					   ,ShipPrice=ISNULL(@ShipPrice,ShipPrice)
					   ,PayTypeSysNo=ISNULL(@PayTypeSysNo,PayTypeSysNo) 
					   ,PayPrice=ISNULL(@PayPrice,PayPrice)
					   ,SOAmt=ISNULL(@SOAmount,SOAmt) 
					   ,DiscountAmt=ISNULL(@PromotionAmount,DiscountAmt)
					   ,PointAmt=ISNULL(@GainPoint,PointAmt)
					   ,CashPay=ISNULL(@CashPay,CashPay)
					   ,PointPay=ISNULL(@PointPay,PointPay)
					   ,UpdateUserSysNo=ISNULL(@UpdateUserSysNo,UpdateUserSysNo)
					   ,UpdateTime=GETDATE()
					   ,Memo=ISNULL(@Memo,Memo)
					   ,Note=ISNULL(@Note,Note)
					   ,IsUseChequesPay=ISNULL(@IsUseChequesPay,IsUseChequesPay)
					   ,IsUsePrepay=ISNULL(@IsUsePrepay,IsUsePrepay)
					   ,PrepayAmt=ISNULL(@PrepayAmount,PrepayAmt)
             ,GiftCardPay=ISNULL(@GiftCardPay,GiftCardPay)
					   WHERE SysNo=@SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32"/>
      <param name="@IsPremium" dbType="Int32"/>
      <param name="@PremiumAmount" dbType="Decimal"/>
      <param name="@ShipPrice" dbType="Decimal"/>
      <param name="@PayTypeSysNo" dbType="Int32"/>
      <param name="@PayPrice" dbType="Decimal"/>
      <param name="@SOAmount" dbType="Decimal"/>
      <param name="@PromotionAmount" dbType="Decimal"/>
      <param name="@GainPoint" dbType="Int32"/>
      <param name="@CashPay" dbType="Decimal"/>
      <param name="@PointPay" dbType="Int32"/>
      <param name="@UpdateUserSysNo" dbType="Int32" property="[usersysno]"/>
      <param name="@Memo" dbType="String" size="1000"/>
      <param name="@Note" dbType="String" size="1000"/>
      <param name="@IsUseChequesPay" dbType="Int32"/>
      <param name="@IsUsePrepay" dbType="Int32"/>
      <param name="@PrepayAmount" dbType="Decimal"/>
      <param name="@GiftCardPay" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <!--修改订单 IPP3:UpdateSOAbandonInfo-->
  <dataCommand name="SO_Update_AbandonSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					  SET Status=@Status
					     ,UpdateUserSysNo=@UpdateUserSysNo
						   ,UpdateTime=GETDATE()
						   ,CashPay=@CashPay
						   ,PromotionCodeSysNo=NULL
						   ,FreightUserSysNo = NULL
						   ,Note=@Note
           WHERE SysNo=@SysNo  
             AND Status>=0
          IF(@Status = -1)
          BEGIN
              IF(EXISTS(SELECT 1 FROM OverseaContentManagement.dbo.GroupBuyingTicket(NOLOCK)
                          WHERE OrderSysNo = @SysNo ))
              BEGIN
	              UPDATE OverseaContentManagement.dbo.GroupBuyingTicket
	              SET [Status] = -1
	              WHERE OrderSysNo = @SysNo
              END
          END
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@UpdateUserSysNo" dbType="Int32" property="[usersysno]"/>
      <param name="@CashPay" dbType="Decimal"/>
      <param name="@Note" dbType="String" size="1000"/>
    </parameters>
  </dataCommand>

  <!--修改订单主信息 IPP3:IsOriginSO -->
  <dataCommand name="SO_Get_ShiftSysNoBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[ 
            SELECT           
              sost.shiftsysno 
            FROM IPP3.dbo.so_autoshift sost WITH (NOLOCK) 
            INNER JOIN IPP3.dbo.V_so_master so WITH (NOLOCK) 
            ON so.sysno = sost.sosysno 
            where so.Sysno=@SOSysNo AND sost.[Status]=@Status
                        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--删除SOItem-->
  <dataCommand name="SO_Delete_SOItemBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
            Delete FROM IPP3.dbo.SO_Item 
            WHERE SysNo = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改订单商品的价格信息-->
  <dataCommand name="SO_Update_SOItemAmountInfoBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE IPP3.dbo.SO_Item 
      SET Price = ISNULL(@Price,Price)
         ,PromotionDiscount= ISNULL(@CouponAverageDiscount ,PromotionDiscount)
      WHERE  SysNo =@SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@Price" dbType="Decimal"/>
      <param name="@CouponAverageDiscount" dbType="Decimal"/>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
  <!--修改订单发票号 IPP3:UpdateInvoiceNo-->
  <!--
  <dataCommand name="SO_Update_SOInvoiceNoBySysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET InvoiceNo = @InvoiceNo
                     WHERE SysNo=@SysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@InvoiceNo" dbType="Decimal"/>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>-->

  <!--取消延保： IPP3:CancelSOExtendWarranty-->
  <dataCommand name="SO_Update_CancelSOExtendWarranty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE IPP3.dbo.SO_ExtendWarrantyItem 
                SET   Status=-1
				WHERE SOSysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--检查订单是否占用虚库： IPP3:ISExistVirtualItemRequest-->
  <dataCommand name="SO_Get_IsExistVirtualItemRequest" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
                SELECT TOP 1 1 
                FROM IPP3.dbo.SO_VirtualItemRequest  AS sv (NOLOCK)
                INNER JOIN IPP3.dbo.V_SO_Item (NOLOCK) 
	                ON (sv.SOSysNo = V_SO_Item.SOSysNo 
		                AND sv.ProductSysNo=V_SO_Item.ProductSysNo)  
                WHERE sv.Status!= -1 AND sv.SOSysNo = @SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--取消订单虚库申请： IPP3:AbandonSOVirtualItemRequest-->
  <dataCommand name="SO_Update_VirtualItemRequestStatusBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
IF(EXISTS(SELECT TOP 1 1 
          FROM IPP3.dbo.SO_VirtualItemRequest  AS sv (NOLOCK) 
          INNER JOIN IPP3.dbo.V_SO_Item (NOLOCK) 
              ON (sv.SOSysNo = V_SO_Item.SOSysNo 
              AND sv.ProductSysNo=V_SO_Item.ProductSysNo)  
          WHERE 
              sv.[Status]!= -1 
              AND sv.SOSysNo = @SOSysNo)) 
BEGIN
UPDATE	IPP3.dbo.SO_VirtualItemRequest 
SET	[Status]=-1 
   ,PMHandleUserSysNo=@PMHandleUserSysNo ---IPP3中固定写为: 493 
   ,PMHandleTime=GETDATE() 
WHERE	 
    SOSysNo= @SOSysNo
END
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@PMHandleUserSysNo" dbType="Int32" property="[usersysno]" />
    </parameters>
  </dataCommand>

  <!--向 ShoppingMaster 表中 添加记录-->
  <dataCommand name="SO_InsertSOShoppingMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					 INSERT INTO Shopping.dbo.ShoppingMaster
								(SOSysNo
								,CustomerSysNo
								,ShippingAreaSysNo
								,ShipTypeSysNo
								,ActionType								
								,CompanyCode)
            VALUES 
								(@SOSysNo
								,@CustomerSysNo
								,@ShippingAreaSysNo
								,@ShipTypeSysNo
								,@ActionType							
								,@CompanyCode);
            SELECT @SysNo = SCOPE_IDENTITY();
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" direction="Output"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@ShippingAreaSysNo" dbType="Int32"/>
      <param name="@ShipTypeSysNo" dbType="Int32"/>
      <param name="@ActionType" dbType="String"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--向 ShoppingTransactio 表中 添加记录-->
  <dataCommand name="SO_InsertSOShoppingTransaction" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					 INSERT INTO Shopping.dbo.ShoppingTransaction
								(ShoppingMasterSysNo
								,ProductType
								,ProductSysNo
								,ItemNumber
								,ShoppingQty
								,AvailableQty
								,Price
								,Cost
								,MasterProductSysNo
								,WarehouseNumber
								,CompanyCode)
             VALUES 
								(@ShoppingMasterSysNo
								,@ProductType
								,@ProductSysNo
								,@ItemNumber
								,@ShoppingQty
								,@AvailableQty
								,@Price
								,@CostPrice
								,@MasterProductSysNo
								,@StockSysNo
								,@CompanyCode);					 
        ]]>
    </commandText>
    <parameters>
      <param name="@ShoppingMasterSysNo" dbType="Int32"/>
      <param name="@ProductType" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@ItemNumber" dbType="String"/>
      <param name="@ShoppingQty" dbType="Int32"/>
      <param name="@AvailableQty" dbType="Int32"/>
      <param name="@Price" dbType="Decimal"/>
      <param name="@CostPrice" dbType="Decimal"/>
      <param name="@MasterProductSysNo" dbType="String"/>
      <param name="@StockSysNo" dbType="String"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!-- 调用存储过程分仓-->
  <dataCommand name="GetAllocateInventoryForSaleOrder" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			EXEC	OverseaOrderManagement.dbo.UP_OM_AllocateInventoryForSaleOrder_V6
						@ShoppingMasterSysNo,
						@ShippingAreaSysNo,
						@ShipTypeSysNo,
						@CompanyCode,
						@returnValue output
        ]]>
    </commandText>
    <parameters>
      <param name="@ShoppingMasterSysNo" dbType="Int32"/>
      <param name="@ShippingAreaSysNo" dbType="Int32"/>
      <param name="@ShipTypeSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@returnValue" dbType="Int32"   direction="Output"/>
    </parameters>
  </dataCommand>

  <!-- 调用统一调仓SP 调仓-->
  <dataCommand name="InventoryAdjustment" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
          Exec OverseaInventoryManagement.dbo.UP_InventoryDeduction_V1 @xmlMessage
       ]]>
    </commandText>
    <parameters>
      <param name="@xmlMessage" dbType="Xml" />
    </parameters>
  </dataCommand>

  <!--删除订单商品信息 -->
  <dataCommand name="DeleteSOItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					DELETE FROM IPP3.dbo.SO_Item 
					WHERE SOSysNo = @SOSysNo AND CompanyCode=@CompanyCode;
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--删除订单商品信息 -->
  <dataCommand name="DeleteSOItemExtend" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          DELETE FROM OverseaOrderManagement.dbo.SO_ItemExtend 
					WHERE SOSysNo = @SOSysNo
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--删除订单商品 -->
  <dataCommand name="DeleteSOItemByProductSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					DELETE FROM IPP3.dbo.SO_Item 
					WHERE	SOSysNo = @SOSysNo
					AND ProductSysNo = @ProductSysNo
					AND CompanyCode=@CompanyCode;
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!-- 手动修改价格 -->
  <dataCommand name="InsertSOItemExtend" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
                    IF EXISTS (SELECT TOP 1 1 FROM OverseaOrderManagement.dbo.SO_ItemExtend WITH(NOLOCK)
                        WHERE SOSysNo = @SOSysNo AND ProductSysNo = @ProductSysNo)
                    BEGIN
                        UPDATE OverseaOrderManagement.dbo.SO_ItemExtend
                        SET  Price = @Price,
                             Discount = @Discount,
                             Reason   = @Reason,
                             EditUser = @EditUser,
                             EditDate = @EditDate
                        WHERE SOSysNo = @SOSysNo AND ProductSysNo = @ProductSysNo
                    END
                    ELSE
                    BEGIN
                        INSERT INTO OverseaOrderManagement.dbo.SO_ItemExtend
                                (
                                SOSysNo, 
                                ProductSysNo, 
                                Price, 
                                Discount, 
                                Reason, 
							                  InUser,
							                  InDate,
							                  CompanyCode
                                )
                         VALUES (
                                @SOSysNo, 
                                @ProductSysNo, 
                                @Price, 
                                @Discount, 
                                @Reason, 
                                @InUser,
                                @InDate,
							                  @CompanyCode
                                );
                    END
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Price" dbType="Decimal"/>
      <param name="@Discount" dbType="Decimal"/>
      <param name="@Reason" dbType="String"/>
      <param name="@InUser" dbType="String"/>
      <param name="@InDate" dbType="DateTime"/>
      <param name="@EditUser" dbType="String"/>
      <param name="@EditDate" dbType="DateTime"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--删除订单 订单附件-->
  <dataCommand name="DeleteSOAccessory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      DELETE 
      FROM [OverseaOrderManagement].[dbo].[SO_Item_Accessory] 
      WHERE 
          SOSysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--删除订单 订单绑定销售-->
  <dataCommand name="SO_Delete_SOSaleRuleBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     DELETE FROM IPP3.dbo.SO_SaleRule 
					WHERE SOSysNo = @SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--删除订单 订单赠品主信息-->
  <dataCommand name="DeleteSOGiftMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      DELETE FROM  OverseaOrderManagement.dbo.SO_GiftMaster 
      WHERE  SOSysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--删除订单 订单赠品Item信息-->
  <dataCommand name="DeleteSOGiftItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      DELETE FROM  OverseaOrderManagement.dbo.SO_GiftItem  
      WHERE  SOSysNo=@SOSysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--判断是否同城发货-->
  <dataCommand name="IsSameCityStock" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[                    
         SELECT 
               COUNT(1) 
         FROM ( 
                SELECT 
                    WHArea 
                FROM [IPP3].[dbo].[SO_Item] si  WITH(NOLOCK) 
                LEFT JOIN  [IPP3].[dbo].[stock] st  WITH(NOLOCK) 
                    ON si.warehousenumber = st.sysno 
                WHERE 
                    si.sosysno  = @SOSysNo AND si.CompanyCode=@CompanyCode
                GROUP BY st.WHArea 
            ) AS T            
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--存在商品接受预定-->
  <dataCommand name="ExistEngageItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[                    
            SELECT COUNT(1)
            FROM IPP3.dbo.so_item si with(nolock)
            INNER JOIN OverseaInventoryManagement.dbo.V_INM_Inventory i ON si.productsysno = i.productsysno
            WHERE si.sosysno = @SOSysNo AND si.ProductType in (0,1,2) AND si.CompanyCode=@CompanyCode
            AND (i.AvailableQty + i.ConsignQty <=0) AND (i.AvailableQty + i.ConsignQty+i.VirtualQty)>=1             
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--是否指定仓分货-->
  <dataCommand name="GetOnlyForStockSysNoByShipTypSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT TOP(1) [OnlyForStockSysNo]             
          FROM   [OverseaControlPanel].[dbo].[V_CP_ShipType] WITH(NOLOCK)
          WHERE  SysNo = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--更新订单拆分类型-->
  <dataCommand name="SetSoSplitType" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE IPP3.dbo.so_checkshipping 
        SET    SoSplitType =@SoSplitType
        WHERE  sosysno = @SOSysNo and Companycode = @CompanyCode
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@SoSplitType" dbType="AnsiStringFixedLength" size="1"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--根据客户编号 获取客户对应中的 增值税发票信息-->
  <dataCommand name="GetDistinctSOVATInvoiceInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT DISTINCT
           SysNo
          ,SOSysNo
          ,CustomerSysNo
          ,CompanyName
          ,Taxnum AS TaxNumber
          ,CompanyAddress
          ,CompanyPhone
          ,BankName
          ,BankAccount
          ,Memo
          ,IsReceTaxpayerCertificate AS ExistTaxpayerCertificate
          FROM IPP3.dbo.SO_ValueAdded_Invoice WITH(NOLOCK)
          WHERE CustomerSysNo =@CustomerSysNo
         ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号 获取订单对应的增值税发票信息-->
  <dataCommand name="GetSOVATInvoiceInfoBySoSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          SELECT TOP(1)
           SysNo
          ,SOSysNo
          ,CustomerSysNo
          ,CompanyName
          ,Taxnum AS TaxNumber
          ,CompanyAddress
          ,CompanyPhone
          ,BankName
          ,BankAccount
          ,Memo
          ,IsReceTaxpayerCertificate AS ExistTaxpayerCertificate
          FROM IPP3.dbo.SO_ValueAdded_Invoice WITH(NOLOCK)
          WHERE SOSysNo =@SOSysNo
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据客户编号 获取客户对应中的 礼品卡信息-->
  <dataCommand name="GetGiftCardsInfoByCustomerSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      DECLARE @Today DATETIME
      SET @Today=DATEADD(DAY, DATEDIFF(DAY,0,GETDATE()), 0) 				  
      SELECT
             [Code] as CardCode
            ,[TotalAmount]
            ,[AvailAmount] 
            ,CASE WHEN [Status]='A' THEN 'Valid' WHEN [Status]='D' THEN 'InValid'  ELSE 'Hold' END AS [Status]
            ,[BindingCustomerSysNo]  [Customer.SysNo]
            ,[BeginDate]
            ,[EndDate]
      FROM  [OverseaECommerceManagement].[dbo].[V_GiftCardInfo]
      WHERE [AvailAmount] > 0 AND [Status] = 'A'
        AND [BindingCustomerSysNo]=@CustomerSysNo
        AND BeginDate <= @Today
        AND EndDate>=@Today
      ORDER BY EndDate ASC
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改订单状态为订单已拆分,ipp3:UpdateStatus4SOSplit-->
  <dataCommand name="SO_Update_SOStatusToSplit" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					UPDATE IPP3.dbo.SO_Master 
					   SET Status=-6,UpdateTime=Getdate()
                    WHERE SysNo=@SOSysNo And Status=0
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改订单状态为订单为物流拒收,ipp3:RejectAutoRMA-->
  <dataCommand name="SO_Update_SOStatusToReject" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE	IPP3.dbo.SO_Master
				SET HaveAutoRMA = 1
				WHERE SysNo = @SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据优惠券编号，取得使用此优惠券的订单编号-->
  <dataCommand name="SO_Get_SOSysNoByCouponSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP(1) SysNo 
FROM IPP3.dbo.SO_Master WITH(NOLOCK) 
WHERE	[Status] NOT IN(-1,-2,-3,-4,-5) 
	AND PromotionCodeSysNo =@CouponSysNo 
ORDER BY SysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--添加订单主信息 IPP3:InsertSOMaster_Logistic-->
  <dataCommand name="SO_Insert_SOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO [IPP3].[dbo].[SO_Master]
([SysNo]
,[SOID]
,[CustomerSysNo]
,[Status]
,[OrderDate]
,[IsWholeSale]
,[IsLarge]
,[PointAmt]
,[Memo]
,[Note]
,[SalesManSysNo]
,[UpdateTime]
,[IsMobilePhone]
,[IsVIP]
,[IsPremium]
,[PremiumAmt]
,[ShipPrice]
,[PayPrice]
,[DiscountAmt]
,[SOAmt]
,[PayTypeSysNo]
,[IsUseChequesPay]
,[PointPay]
,[PrepayAmt]
,[IsUsePrepay]
,[GiftCardPay]
,[HoldUser]
,[HoldReason]
,[HoldDate]
,[HoldMark]
,[ShoppingMasterSysNo]
,[ReceiveAreaSysNo]
,[ReceiveContact]
,[ReceiveAddress]
,[ReceiveCellPhone]
,[ReceivePhone]
,[ReceiveZip]
,[ReceiveName]
,[IsVAT]
,[InvoiceNote]
,[InvoiceNo]
,[FinanceNote]
,[ShipTypeSysNo]
,[AllocatedManSysNo]
,[FreightUserSysNo]
,[PackageID]
,[OutUserSysNo]
,[OutTime]
,[DeliveryMemo]
,[DeliveryDate]
,[DeliveryTimeRange]
,[StockSysNo]
,[CashPay]
,[UpdateUserSysNo]
,[AuditUserSysNo]
,[AuditTime]
,[ManagerAuditUserSysNo]
,[ManagerAuditTime]
,[IsPrintPackageCover]
,[PromotionCustomerSysNo]
,[PositiveSOSysNo]
,[PromotionCodeSysNo]
,[HaveAutoRMA]
,[LanguageCode]
,[StoreCompanyCode]
,[ReceivingStatus]
,[CompanyCode]
,[TariffAmt]
,[ExchangeRate])
VALUES
(@SysNo
,@BaseInfo_SOID
,@BaseInfo_CustomerSysNo
,@BaseInfo_Status
,@BaseInfo_CreateTime
,@BaseInfo_IsWholeSale
,@BaseInfo_IsLarge
,@BaseInfo_GainPoint
,@BaseInfo_Memo
,@BaseInfo_Note
,@BaseInfo_SalesManSysNo
,@BaseInfo_UpdateTime
,@BaseInfo_IsPhoneOrder
,@BaseInfo_IsVIP
,@BaseInfo_IsPremium
,@BaseInfo_PremiumAmount
,@BaseInfo_ShipPrice
,@BaseInfo_PayPrice
,@BaseInfo_PromotionAmount
,@BaseInfo_SOAmount
,@BaseInfo_PayTypeSysNo
,@BaseInfo_IsUseChequesPay
,@BaseInfo_PointPay
,@BaseInfo_PrepayAmount
,@BaseInfo_IsUsePrePay
,@BaseInfo_GiftCardPay
,@BaseInfo_HoldUser
,@BaseInfo_HoldReason
,@BaseInfo_HoldTime
,@HoldMark
,@BaseInfo_ShoppingMasterSysNo
,@ReceiverInfo_AreaSysNo
,@ReceiverInfo_Name
,@ReceiverInfo_Address
,@ReceiverInfo_MobilePhone
,@ReceiverInfo_Phone
,@ReceiverInfo_Zip
,@InvoiceInfo_Header
,@InvoiceInfo_IsVAT
,@InvoiceInfo_InvoiceNote
,@InvoiceInfo_InvoiceNo
,@InvoiceInfo_FinanceNote
,@ShippingInfo_ShipTypeSysNo
,@ShippingInfo_AllocatedManSysNo
,@ShippingInfo_FreightUserSysNo
,@ShippingInfo_PackageID
,@ShippingInfo_OutUserSysNo
,@ShippingInfo_OutTime
,@ShippingInfo_DeliveryMemo
,@ShippingInfo_DeliveryDate
,@ShippingInfo_DeliveryTimeRange
,@StockSysNo
,@BaseInfo_CashPay
,NULL
,@AuditUserSysNo
,@AuditTime
,@ManagerAuditUserSysNo
,@ManagerAuditTime
,@ShippingInfo_IsPrintPackageCover
,@PromotionCustomerSysNo
,@PositiveSOSysNo
,@PromotionCodeSysNo
,@HaveAutoRMA
,@BaseInfo_LanguageCode
,@StoreCompanyCode
,@ReceivingStatus
,@CompanyCode
,@BaseInfo_TariffAmount
,1)
]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@BaseInfo_SOID" dbType="String"/>
      <param name="@BaseInfo_CustomerSysNo" dbType="Int32"/>
      <param name="@BaseInfo_Status" dbType="Int32"/>
      <param name="@BaseInfo_CreateTime" dbType="DateTime"/>
      <param name="@BaseInfo_IsWholeSale" dbType="Int32"/>
      <param name="@BaseInfo_IsLarge" dbType="Int32"/>
      <param name="@BaseInfo_GainPoint" dbType="Int32"/>
      <param name="@BaseInfo_Memo" dbType="String"/>
      <param name="@BaseInfo_Note" dbType="String"/>
      <param name="@BaseInfo_SalesManSysNo" dbType="Int32"/>
      <param name="@BaseInfo_UpdateTime" dbType="DateTime"/>
      <param name="@BaseInfo_IsPhoneOrder" dbType="Int32"/>
      <param name="@BaseInfo_IsVIP" dbType="Int32"/>
      <param name="@BaseInfo_IsPremium" dbType="Int32"/>
      <param name="@BaseInfo_PremiumAmount" dbType="Decimal"/>
      <param name="@BaseInfo_ShipPrice" dbType="Decimal"/>
      <param name="@BaseInfo_PayPrice" dbType="Decimal"/>
      <param name="@BaseInfo_PromotionAmount" dbType="Decimal"/>
      <param name="@BaseInfo_SOAmount" dbType="Decimal"/>
      <param name="@BaseInfo_PayTypeSysNo" dbType="Int32"/>
      <param name="@BaseInfo_IsUseChequesPay" dbType="Int32"/>
      <param name="@BaseInfo_PointPay" dbType="Int32"/>
      <param name="@BaseInfo_PrepayAmount" dbType="Decimal"/>
      <param name="@BaseInfo_CashPay" dbType="Decimal"/>
      <param name="@BaseInfo_IsUsePrePay" dbType="Int32"/>
      <param name="@BaseInfo_GiftCardPay" dbType="Decimal"/>
      <param name="@BaseInfo_HoldUser" dbType="Int32"/>
      <param name="@BaseInfo_HoldReason" dbType="String"/>
      <param name="@BaseInfo_HoldTime" dbType="DateTime"/>
      <param name="@HoldMark" dbType="Boolean"/>
      <param name="@BaseInfo_ShoppingMasterSysNo" dbType="Int32"/>
      <param name="@ReceiverInfo_AreaSysNo" dbType="Int32"/>
      <param name="@ReceiverInfo_Name" dbType="String"/>
      <param name="@ReceiverInfo_Address" dbType="String"/>
      <param name="@ReceiverInfo_MobilePhone" dbType="String"/>
      <param name="@ReceiverInfo_Phone" dbType="String"/>
      <param name="@ReceiverInfo_Zip" dbType="String"/>
      <param name="@InvoiceInfo_Header" dbType="String"/>
      <param name="@InvoiceInfo_IsVAT" dbType="Int32"/>
      <param name="@InvoiceInfo_InvoiceNote" dbType="String"/>
      <param name="@InvoiceInfo_InvoiceNo" dbType="String"/>
      <param name="@InvoiceInfo_FinanceNote" dbType="String"/>
      <param name="@ShippingInfo_ShipTypeSysNo" dbType="Int32"/>
      <param name="@ShippingInfo_AllocatedManSysNo" dbType="Int32"/>
      <param name="@ShippingInfo_FreightUserSysNo" dbType="Int32"/>
      <param name="@ShippingInfo_PackageID" dbType="String"/>
      <param name="@ShippingInfo_OutUserSysNo" dbType="Int32"/>
      <param name="@ShippingInfo_OutTime"  dbType="DateTime"/>
      <param name="@ShippingInfo_DeliveryMemo" dbType="String"/>
      <param name="@ShippingInfo_DeliveryDate"  dbType="DateTime"/>
      <param name="@ShippingInfo_DeliveryTimeRange" dbType="String"/>
      <param name="@StockSysNo" dbType="Int32"/>
      <param name="@AuditUserSysNo" dbType="Int32"/>
      <param name="@AuditTime" dbType="DateTime"/>
      <param name="@ManagerAuditUserSysNo" dbType="Int32"/>
      <param name="@ManagerAuditTime" dbType="DateTime"/>
      <param name="@ShippingInfo_IsPrintPackageCover"  dbType="Int32"/>
      <param name="@PromotionCustomerSysNo" dbType="Int32"/>
      <param name="@PositiveSOSysNo" dbType="Int32"/>
      <param name="@PromotionCodeSysNo" dbType="Int32"/>
      <param name="@HaveAutoRMA" dbType="Int32"/>
      <param name="@BaseInfo_LanguageCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
      <param name="@ReceivingStatus" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@BaseInfo_TariffAmount" dbType="Decimal"/>

    </parameters>
  </dataCommand>

  <!--修改订单主信息 IPP3:UpdateSOMaster_Logistic -->
  <dataCommand name="SO_Update_SOMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
UPDATE IPP3.dbo.SO_Master SET 
 [AllocatedManSysNo]=ISNULL(@ShippingInfo_AllocatedManSysNo,[AllocatedManSysNo])
,[AuditTime]=ISNULL(@AuditTime,[AuditTime])
,[AuditUserSysNo]=ISNULL(@AuditUserSysNo,[AuditUserSysNo])
,[CashPay]=ISNULL(@BaseInfo_CashPay,[CashPay])
,[DeliveryDate]=@ShippingInfo_DeliveryDate
,[DeliveryMemo]=ISNULL(@ShippingInfo_DeliveryMemo,[DeliveryMemo])
,[DeliveryTimeRange]=ISNULL(@ShippingInfo_DeliveryTimeRange,[DeliveryTimeRange])
,[DiscountAmt]=ISNULL(@BaseInfo_PromotionAmount,[DiscountAmt])
,[FinanceNote]=ISNULL(@InvoiceInfo_FinanceNote,[FinanceNote])
,[FreightUserSysNo]=ISNULL(@ShippingInfo_FreightUserSysNo,[FreightUserSysNo])
,[GiftCardPay]=ISNULL(@BaseInfo_GiftCardPay,[GiftCardPay])
,[HoldDate]=ISNULL(@BaseInfo_HoldTime,[HoldDate])
,[HoldMark]=ISNULL(@HoldMark,[HoldMark])
,[HoldReason]=ISNULL(@BaseInfo_HoldReason,[HoldReason])
,[HoldUser]=ISNULL(@BaseInfo_HoldUser,[HoldUser])
,[InvoiceNo]=ISNULL(@InvoiceInfo_InvoiceNo,[InvoiceNo])
,[InvoiceNote]=ISNULL(@InvoiceInfo_InvoiceNote,[InvoiceNote])
,[IsLarge]=ISNULL(@BaseInfo_IsLarge,[IsLarge])
,[IsMobilePhone]=ISNULL(@BaseInfo_IsPhoneOrder,[IsMobilePhone])
,[IsPremium]=ISNULL(@BaseInfo_IsPremium,[IsPremium])
,[IsPrintPackageCover]=ISNULL(@ShippingInfo_IsPrintPackageCover,[IsPrintPackageCover])
,[IsUseChequesPay]=ISNULL(@BaseInfo_IsUseChequesPay,[IsUseChequesPay])
,[IsUsePrepay]=ISNULL(@BaseInfo_IsUsePrePay,[IsUsePrepay])
,[IsVAT]=ISNULL(@InvoiceInfo_IsVAT,[IsVAT])
,[IsVIP]=ISNULL(@BaseInfo_IsVIP,[IsVIP])
,[IsWholeSale]=ISNULL(@BaseInfo_IsWholeSale,[IsWholeSale])
,[ManagerAuditTime]=ISNULL(@ManagerAuditTime,[ManagerAuditTime])
,[ManagerAuditUserSysNo]=ISNULL(@ManagerAuditUserSysNo,[ManagerAuditUserSysNo])
,[Memo]=ISNULL(@BaseInfo_Memo,[Memo])
,[Note]=ISNULL(@BaseInfo_Note,[Note])
,[OutTime]=ISNULL(@ShippingInfo_OutTime,[OutTime])
,[OutUserSysNo]=ISNULL(@ShippingInfo_OutUserSysNo,[OutUserSysNo])
,[PayPrice]=ISNULL(@BaseInfo_PayPrice,[PayPrice])
,[PayTypeSysNo]=ISNULL(@BaseInfo_PayTypeSysNo,[PayTypeSysNo])
,[PointAmt]=ISNULL(@BaseInfo_GainPoint,[PointAmt])
,[PointPay]=ISNULL(@BaseInfo_PointPay,[PointPay])
,[PremiumAmt]=ISNULL(@BaseInfo_PremiumAmount,[PremiumAmt])
,[PrepayAmt]=ISNULL(@BaseInfo_PrepayAmount,[PrepayAmt])
,[PromotionCodeSysNo]=ISNULL(@PromotionCodeSysNo,[PromotionCodeSysNo])
,[ReceiveAddress]=ISNULL(@ReceiverInfo_Address,[ReceiveAddress])
,[ReceiveAreaSysNo]=ISNULL(@ReceiverInfo_AreaSysNo,[ReceiveAreaSysNo])
,[ReceiveCellPhone]=ISNULL(@ReceiverInfo_MobilePhone,[ReceiveCellPhone])
,[ReceiveContact]=ISNULL(@ReceiverInfo_Name,[ReceiveContact])
,[ReceiveName]=ISNULL(@InvoiceInfo_Header,[ReceiveName])
,[ReceivePhone]=ISNULL(@ReceiverInfo_Phone,[ReceivePhone])
,[ReceiveZip]=ISNULL(@ReceiverInfo_Zip,[ReceiveZip])
,[SalesManSysNo]=ISNULL(@BaseInfo_SalesManSysNo,[SalesManSysNo])
,[ShipPrice]=ISNULL(@BaseInfo_ShipPrice,[ShipPrice])
,[ShipTypeSysNo]=ISNULL(@ShippingInfo_ShipTypeSysNo,[ShipTypeSysNo])
,[ShoppingMasterSysNo]=ISNULL(@BaseInfo_ShoppingMasterSysNo,[ShoppingMasterSysNo])
,[SOAmt]=ISNULL(@BaseInfo_SOAmount,[SOAmt])
,[Status]=ISNULL(@BaseInfo_Status,[Status])
,[UpdateTime]=ISNULL(@BaseInfo_UpdateTime,[UpdateTime])
,[UpdateUserSysNo]=ISNULL(@UpdateUserSysNo,[UpdateUserSysNo])
,[TariffAmt]=ISNULL(@BaseInfo_TariffAmount,[TariffAmt])
WHERE SysNo=@SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ShippingInfo_AllocatedManSysNo" dbType="Int32"/>
      <param name="@AuditTime" dbType="DateTime"/>
      <param name="@AuditUserSysNo" dbType="Int32"/>
      <param name="@BaseInfo_CashPay" dbType="Decimal"/>
      <param name="@ShippingInfo_DeliveryDate"  dbType="DateTime"/>
      <param name="@ShippingInfo_DeliveryMemo" dbType="String"/>
      <param name="@ShippingInfo_DeliveryTimeRange" dbType="String"/>
      <param name="@BaseInfo_PromotionAmount" dbType="Decimal"/>
      <param name="@InvoiceInfo_FinanceNote" dbType="String"/>
      <param name="@ShippingInfo_FreightUserSysNo" dbType="Int32"/>
      <param name="@BaseInfo_GiftCardPay" dbType="Decimal"/>
      <param name="@BaseInfo_HoldTime" dbType="DateTime"/>
      <param name="@HoldMark" dbType="Boolean"/>
      <param name="@BaseInfo_HoldReason" dbType="String"/>
      <param name="@BaseInfo_HoldUser" dbType="Int32"/>
      <param name="@InvoiceInfo_InvoiceNo" dbType="String"/>
      <param name="@InvoiceInfo_InvoiceNote" dbType="String"/>
      <param name="@BaseInfo_IsLarge" dbType="Int32"/>
      <param name="@BaseInfo_IsPhoneOrder" dbType="Int32"/>
      <param name="@BaseInfo_IsPremium" dbType="Int32"/>
      <param name="@ShippingInfo_IsPrintPackageCover"  dbType="Int32"/>
      <param name="@BaseInfo_IsUseChequesPay" dbType="Int32"/>
      <param name="@BaseInfo_IsUsePrePay" dbType="Int32"/>
      <param name="@InvoiceInfo_IsVAT" dbType="Int32"/>
      <param name="@BaseInfo_IsVIP" dbType="Int32"/>
      <param name="@BaseInfo_IsWholeSale" dbType="Int32"/>
      <param name="@ManagerAuditTime" dbType="DateTime"/>
      <param name="@ManagerAuditUserSysNo" dbType="Int32"/>
      <param name="@BaseInfo_Memo" dbType="String"/>
      <param name="@BaseInfo_Note" dbType="String"/>
      <param name="@ShippingInfo_OutTime"  dbType="DateTime"/>
      <param name="@ShippingInfo_OutUserSysNo" dbType="Int32"/>
      <param name="@BaseInfo_PayPrice" dbType="Decimal"/>
      <param name="@BaseInfo_PayTypeSysNo" dbType="Int32"/>
      <param name="@BaseInfo_GainPoint" dbType="Int32"/>
      <param name="@BaseInfo_PointPay" dbType="Int32"/>
      <param name="@BaseInfo_PremiumAmount" dbType="Decimal"/>
      <param name="@BaseInfo_PrepayAmount" dbType="Decimal"/>
      <param name="@PromotionCodeSysNo" dbType="Int32"/>
      <param name="@ReceiverInfo_Address" dbType="String"/>
      <param name="@ReceiverInfo_AreaSysNo" dbType="Int32"/>
      <param name="@ReceiverInfo_MobilePhone" dbType="String"/>
      <param name="@ReceiverInfo_Name" dbType="String"/>
      <param name="@InvoiceInfo_Header" dbType="String"/>
      <param name="@ReceiverInfo_Phone" dbType="String"/>
      <param name="@ReceiverInfo_Zip" dbType="String"/>
      <param name="@BaseInfo_SalesManSysNo" dbType="Int32"/>
      <param name="@BaseInfo_ShipPrice" dbType="Decimal"/>
      <param name="@ShippingInfo_ShipTypeSysNo" dbType="Int32"/>
      <param name="@BaseInfo_ShoppingMasterSysNo" dbType="Int32"/>
      <param name="@BaseInfo_SOAmount" dbType="Decimal"/>
      <param name="@BaseInfo_Status" dbType="Int32"/>
      <param name="@BaseInfo_UpdateTime" dbType="DateTime"/>
      <param name="@UpdateUserSysNo" dbType="Int32" property="[usersysno]"/>
      <param name="@BaseInfo_TariffAmount" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <!--添加订单CheckShipping信息 IPP3:InsertSOCheckShipping_Logistic-->
  <dataCommand name="SO_Insert_SOCheckShipping" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[  
INSERT INTO [IPP3].[dbo].[SO_CheckShipping]
([SOType]
,[MemoForCustomer]
,[IsBackOrder]
,[VIPSOType]
,[VIPUserType]
,[IsExtendWarrantyOrder]
,[IsExpiateOrder]
,[IsExperienceOrder]
,[IsDCOrder]
,[DC_Status]
,[SettlementStatus]
,[ReferenceSysno]
,[SpecialSOType]
,[SplitUserSysNo]
,[SplitDateTime]
,[SoSplitType]
,[SoSplitMaster]
,[HoldStatus]
,[NeedInvoice]
,[InvoiceType]
,[IsMultiInvoice]
,[IsVATPrinted]
,[IsRequireShipInvoice]
,[RingOutShipType]
,[DeliverySection]
,[DeliveryType]
,[DeliveryPromise]
,[ShippingType]
,[WeightSO]
,[ShippingFee]
,[PackageFee]
,[RegisteredFee]
,[Weight3PL]
,[ShipCost]
,[ShipCost3PL]
,[OriginShipPrice]
,[VPOStatus]
,[IsCombine]
,[IsMergeComplete]
,[MergeCompleteTime]
,[MergeOutTime]
,[DestWarehouseNumber]
,[StockStatus]
,[StockType]
,[IsFPSO]
,[FPReason]
,[IsFPCheck]
,[FPCheckTime]
,[FPExtend]
,[CustomerIPAddress]
,[CustomerCookie]
,[IsPhoneOrder]
,[CreateTime]
,[IsDuplicateOrder]
,[AuditType]
,[AuditSOSendMailFlag]
,[AutoAuditMemo]
,[IsLastVat]
,[LocalWHSysNo]
,[MerchantSysNo]
,[CompanyCode]
,[CurrencySysNo]
,[HoldDate]
,[LanguageCode]
,[SOSysNo]
,[StoreCompanyCode]
)
VALUES
(@BaseInfo_SOType
,@BaseInfo_MemoForCustomer
,@BaseInfo_IsBackOrder
,@BaseInfo_VIPSOType
,@BaseInfo_VIPUserType
,@BaseInfo_IsExtendWarrantyOrder
,@BaseInfo_IsExpiateOrder
,@BaseInfo_IsExperienceOrder
,@BaseInfo_IsDCOrder
,@BaseInfo_DCStatus
,@BaseInfo_SettlementStatus
,@BaseInfo_ReferenceSysNo
,@BaseInfo_SpecialSOType
,@InvoiceInfo_SplitUserSysNo
,@InvoiceInfo_SplitDateTime
,@BaseInfo_SplitType
,@BaseInfo_SOSplitMaster
,@BaseInfo_HoldStatus
,@BaseInfo_NeedInvoice
,@InvoiceInfo_InvoiceType
,@InvoiceInfo_IsMultiInvoice
,@InvoiceInfo_IsVATPrinted
,@InvoiceInfo_IsRequireShipInvoice
,@ShippingInfo_RingOutShipType
,@ShippingInfo_DeliverySection
,@ShippingInfo_DeliveryType
,@ShippingInfo_DeliveryPromise
,@ShippingInfo_ShippingType
,@ShippingInfo_Weight
,@ShippingInfo_ShippingFee
,@ShippingInfo_PackageFee
,@ShippingInfo_RegisteredFee
,@ShippingInfo_Weight3PL
,@ShippingInfo_ShipCost
,@ShippingInfo_ShipCost3PL
,@ShippingInfo_OriginShipPrice
,@ShippingInfo_VPOStatus
,@ShippingInfo_IsCombine
,@ShippingInfo_IsMergeComplete
,@ShippingInfo_MergeCompleteTime
,@ShippingInfo_MergeOutTime
,@ShippingInfo_MergeToStockSysNo
,@ShippingInfo_StockStatus
,@ShippingInfo_StockType
,@FPInfo_IsFPSO
,@FPInfo_FPReason
,@FPInfo_IsFPCheck
,@FPInfo_FPCheckTime
,@FPInfo_FPExtend
,@ClientInfo_CustomerIPAddress
,@ClientInfo_CustomerCookie
,@ClientInfo_PhoneType
,@BaseInfo_CreateTime
,@IsDuplicateOrder
,@AuditType
,@AuditSOSendMailFlag
,@AutoAuditMemo
,0
,@LocalWHSysNo
,@Merchant_MerchantID
,@CompanyCode
,@CurrencySysNo
,@BaseInfo_HoldTime
,@BaseInfo_LanguageCode
,@SysNo
,@StoreCompanyCode
)
]]>
    </commandText>
    <parameters>
      <param name="@StockSysNo" dbType="Int32"/>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@StoreCompanyCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@CurrencySysNo" dbType="Int32"/>
      <param name="@BaseInfo_LanguageCode" dbType="String"/>
      <param name="@BaseInfo_HoldTime" dbType="DateTime"/>
      <param name="@BaseInfo_CreateTime" dbType="DateTime"/>
      <param name="@BaseInfo_SOType" dbType="Int32"/>
      <param name="@BaseInfo_MemoForCustomer" dbType="String"/>
      <param name="@BaseInfo_IsBackOrder" dbType="Int32"/>
      <param name="@BaseInfo_VIPSOType" dbType="String"/>
      <param name="@BaseInfo_VIPUserType" dbType="String"/>
      <param name="@BaseInfo_IsExtendWarrantyOrder" dbType="Int32"/>
      <param name="@BaseInfo_IsExpiateOrder" dbType="Int32"/>
      <param name="@BaseInfo_IsExperienceOrder" dbType="Int32"/>
      <param name="@BaseInfo_IsDCOrder" dbType="Int32"/>
      <param name="@BaseInfo_DCStatus" dbType="Int32"/>
      <param name="@BaseInfo_SettlementStatus" dbType="String"/>
      <param name="@BaseInfo_ReferenceSysNo" dbType="Int32"/>
      <param name="@BaseInfo_SpecialSOType" dbType="Int32"/>
      <param name="@InvoiceInfo_SplitUserSysNo" dbType="Int32"/>
      <param name="@InvoiceInfo_SplitDateTime" dbType="DateTime"/>
      <param name="@BaseInfo_SplitType" dbType="String"/>
      <param name="@BaseInfo_SOSplitMaster" dbType="Int32"/>
      <param name="@BaseInfo_HoldStatus" dbType="Int32"/>
      <param name="@BaseInfo_NeedInvoice" dbType="Int32"/>
      <param name="@InvoiceInfo_InvoiceType" dbType="String"/>
      <param name="@InvoiceInfo_IsMultiInvoice" dbType="Int32"/>
      <param name="@InvoiceInfo_IsVATPrinted" dbType="Int32"/>
      <param name="@InvoiceInfo_IsRequireShipInvoice" dbType="Int32"/>
      <param name="@ShippingInfo_RingOutShipType" dbType="String"/>
      <param name="@ShippingInfo_DeliverySection" dbType="String"/>
      <param name="@ShippingInfo_DeliveryType" dbType="Int32"/>
      <param name="@ShippingInfo_DeliveryPromise" dbType="String"/>
      <param name="@ShippingInfo_ShippingType" dbType="String"/>
      <param name="@ShippingInfo_Weight" dbType="Int32"/>
      <param name="@ShippingInfo_ShippingFee" dbType="Decimal"/>
      <param name="@ShippingInfo_PackageFee" dbType="Decimal"/>
      <param name="@ShippingInfo_RegisteredFee" dbType="Decimal"/>
      <param name="@ShippingInfo_Weight3PL" dbType="Int32"/>
      <param name="@ShippingInfo_ShipCost" dbType="Decimal"/>
      <param name="@ShippingInfo_ShipCost3PL" dbType="Decimal"/>
      <param name="@ShippingInfo_OriginShipPrice" dbType="Decimal"/>
      <param name="@ShippingInfo_VPOStatus" dbType="Int32"/>
      <param name="@ShippingInfo_IsCombine" dbType="Int32"/>
      <param name="@ShippingInfo_IsMergeComplete" dbType="Int32"/>
      <param name="@ShippingInfo_MergeCompleteTime" dbType="DateTime"/>
      <param name="@ShippingInfo_MergeOutTime" dbType="DateTime"/>
      <param name="@ShippingInfo_MergeToStockSysNo" dbType="Int32"/>
      <param name="@ShippingInfo_StockStatus" dbType="Int32"/>
      <param name="@ShippingInfo_StockType" dbType="String"/>
      <param name="@FPInfo_IsFPSO" dbType="Int32"/>
      <param name="@FPInfo_FPReason" dbType="String"/>
      <param name="@FPInfo_IsFPCheck" dbType="Int32"/>
      <param name="@FPInfo_FPCheckTime" dbType="DateTime"/>
      <param name="@FPInfo_FPExtend" dbType="String"/>
      <param name="@ClientInfo_CustomerIPAddress" dbType="String"/>
      <param name="@ClientInfo_CustomerCookie" dbType="String"/>
      <param name="@ClientInfo_PhoneType" dbType="Int32"/>
      <param name="@IsDuplicateOrder" dbType="Int32"/>
      <param name="@AuditType" dbType="Int32"/>
      <param name="@AuditSOSendMailFlag" dbType="Int32"/>
      <param name="@AutoAuditMemo" dbType="String"/>
      <param name="@LocalWHSysNo" dbType="String"/>
      <param name="@Merchant_MerchantID" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="SO_Update_SOCheckShippingVPOStatus" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					 UPDATE IPP3.dbo.SO_CheckShipping 
           SET VPOStatus=ISNULL(@VPOStatus,VPOStatus) 
				   WHERE SOSysNo=@SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@VPOStatus" dbType="Int32" />
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--修改订单CheckShipping信息 UpdateSOCheckShipping_Logistic-->
  <dataCommand name="SO_Update_SOCheckShipping" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					 UPDATE IPP3.dbo.SO_CheckShipping
					 SET
							 WeightSO=ISNULL(@WeightSO,WeightSO)
							,ShippingFee=ISNULL(@ShippingFee,ShippingFee)
							,PackageFee=ISNULL(@PackageFee,PackageFee)
							,RegisteredFee=ISNULL(@RegisteredFee,RegisteredFee)
							,UpdateTime=ISNULL(@UpdateTime,UpdateTime)
							,Weight3PL=ISNULL(@Weight3PL,Weight3PL)
							,ShipCost=ISNULL(@ShipCost,ShipCost)
							,IsFPSO=ISNULL(@IsFPSO,IsFPSO)
							,FPReason=ISNULL(@FPReason,FPReason)
							,CustomerIPAddress=ISNULL(@CustomerIPAddress,CustomerIPAddress)							
							,IsFPCheck=ISNULL(@IsFPCheck,IsFPCheck)
							,FPCheckTime=ISNULL(@FPCheckTime,FPCheckTime)
							,SpecialSOType=ISNULL(@SpecialSOType,SpecialSOType)							
							,ShipCost3PL=ISNULL(@ShipCost3PL,ShipCost3PL)						
							,MemoForCustomer=ISNULL(@MemoForCustomer,MemoForCustomer)
							,VPOStatus=ISNULL(@VPOStatus,VPOStatus)
							,IsPhoneOrder=ISNULL(@IsPhoneOrder,IsPhoneOrder)
							,OriginShipPrice=ISNULL(@OriginShipPrice,OriginShipPrice)
							,IsMultiInvoice=ISNULL(@IsMultiInvoice,IsMultiInvoice)
							,SplitUserSysNo=ISNULL(@SplitUserSysNo,SplitUserSysNo)
							,SplitDateTime=ISNULL(@SplitDateTime,SplitDateTime)
							,IsRequireShipInvoice=ISNULL(@IsRequireShipInvoice,IsRequireShipInvoice)	
              ,NeedInvoice = ISNULL(@NeedInvoice,NeedInvoice)
							,IsVATPrinted=ISNULL(@IsVATPrinted,IsVATPrinted)
							,IsCombine=ISNULL(@IsCombine,IsCombine)
							,IsExtendWarrantyOrder=ISNULL(@IsExtendWarrantyOrder,IsExtendWarrantyOrder)
							,IsExpiateOrder = ISNULL(@IsExpiateOrder,IsExpiateOrder)
              ,IsExperienceOrder = ISNULL(@IsExperienceOrder,IsExperienceOrder)
							,RingOutShipType = @RingOutShipType
							,SOType =ISNULL(@SOType,SOType)
							,DeliveryPromise=ISNULL(@DeliveryPromise,DeliveryPromise)
							,HoldStatus =ISNULL(@HoldStatus ,HoldStatus)
							,HoldDate =ISNULL(@HoldDate ,HoldDate)
              ,SoSplitMaster =ISNULL(@SoSplitMaster ,SoSplitMaster)
              ,DeliverySection = @DeliverySection
              ,DeliveryType = @DeliveryType
              ,VIPSOType=@VIPSOType
              ,VIPUserType=@VIPUserType
              ,SettlementStatus=@SettlementStatus
              ,LocalWHSysNo=@LocalWHSysNo
				WHERE SOSysNo=@SOSysNo
				AND CompanyCode=@CompanyCode
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@WeightSO" dbType="Int32" />
      <param name="@ShippingFee" dbType="Decimal" />
      <param name="@PackageFee" dbType="Decimal" />
      <param name="@RegisteredFee" dbType="Decimal" />
      <param name="@UpdateTime" dbType="DateTime" />
      <param name="@Weight3PL" dbType="Int32" />
      <param name="@ShipCost" dbType="Decimal" />
      <param name="@IsFPSO" dbType="Int32" />
      <param name="@FPReason" dbType="String" size="400" />
      <param name="@CustomerIPAddress" dbType="String" size="40"/>
      <param name="@IsFPCheck" dbType="Int32" />
      <param name="@FPCheckTime" dbType="DateTime" />
      <param name="@SpecialSOType" dbType="Int32" />
      <param name="@ShipCost3PL" dbType="Decimal" />
      <param name="@MemoForCustomer" dbType="String" />
      <param name="@VPOStatus" dbType="Int32" />
      <param name="@IsPhoneOrder" dbType="Int32" />
      <param name="@OriginShipPrice" dbType="Decimal" />
      <param name="@IsMultiInvoice" dbType="Int32" />
      <param name="@SplitUserSysNo" dbType="Int32" />
      <param name="@SplitDateTime" dbType="DateTime" />
      <param name="@IsRequireShipInvoice" dbType="Int32" />
      <param name="@NeedInvoice" dbType="Int32" />
      <param name="@IsVATPrinted" dbType="Int32" />
      <param name="@IsCombine" dbType="Int32" />
      <param name="@IsExtendWarrantyOrder" dbType="Int32" />
      <param name="@IsExpiateOrder" dbType="Int32" />
      <param name="@IsExperienceOrder" dbType="Int32" />
      <param name="@RingOutShipType" dbType="AnsiStringFixedLength" size="2"/>
      <param name="@SOType" dbType="Int32"/>
      <param name="@DeliveryPromise" dbType="AnsiStringFixedLength" size="3"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@HoldStatus" dbType="Int32"/>
      <param name="@HoldDate" dbType="DateTime"/>
      <param name="@SoSplitMaster" dbType="Int32"/>
      <param name="@DeliverySection" dbType ="String" size="50"/>
      <param name="@DeliveryType" dbType="Int32"/>
      <param name="@VIPUserType" dbType="AnsiStringFixedLength" size="1" />
      <param name="@VIPSOType" dbType="AnsiStringFixedLength" size="1" />
      <param name="@SettlementStatus" dbType="AnsiStringFixedLength" size="1" />
      <param name="@LocalWHSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!-- 添加订单商品 Ipp3:InsertSOItem-->
  <dataCommand name="SO_Insert_SOItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      
DECLARE @SOItemSysNo int 
INSERT INTO [IPP3].[dbo].[SO_Item] 
(
     [SOSysNo] 
    ,[ProductSysNo] 
    ,[Quantity] 
    ,[Weight] 
    ,[Price] 
    ,[Cost] 
    ,[Point] 
    ,[PointType] 
    ,[DiscountAmt] 
    ,[Warranty] 
    ,[ProductType] 
    ,[GiftSysNo] 
    ,[BriefName] 
    ,[OriginalPrice] 
    ,[PromotionDiscount]
    ,[MasterProductSysNo] 
    ,[WarehouseNumber] 
    ,[UnitCostWithoutTax] 
    ,[IsMemberPrice] 
    ,[DiscountType] 
    ,[TariffAmt]
    ,[TariffCode]
    ,[TariffRate]
    ,[EntryRecord]
    ,[StoreType]
    ,[ExchangeRate]
) 
VALUES
( 
   @SOSysNo 
  ,@ProductSysNo 
  ,@Quantity 
  ,@Weight 
  ,@Price 
  ,@CostPrice 
  ,@GainAveragePoint 
  ,@PayType 
  ,@PromotionAmount 
  ,@Warranty 
  ,@ProductType 
  ,NULL
  ,@ProductName 
  ,@OriginalPrice 
  ,@CouponAverageDiscount 
  ,@MasterProductSysNo 
  ,@StockSysNo 
  ,@NoTaxCostPrice 
  ,@PriceType 
  ,@DiscountType 
  ,@TariffAmount
  ,@TariffCode
  ,@TariffRate
  ,@EntryRecord
  ,@StoreType
  ,1
)   
SET @SOItemSysNo=SCOPE_IDENTITY()
--IF(@ReferenceSysNo IS NOT NULL AND @ReferenceSysNo<>0)
--BEGIN
--INSERT INTO OverseaOrderManagement.dbo.SO_Item_Extension
--( 
--     [SOSysNo] 
--    ,[ProductSysNo] 
--    ,[ReferenceSysNo] 
--    ,[Type] 
--    ,[SettlementStatus] 
--    ,[InDate] 
--    ,[InUser] 
--    ,[EditDate] 
--    ,[EditUser]
--) 
--VALUES
--( 
--     @SOSysNo 
--    ,@ProductSysNo 
--    ,@ReferenceSysNo 
--    ,@ActivityType
--    ,@SettlementStatus 
--    ,@CreateDate 
--    ,@CreateUserSysNo 
--    ,@LastEditDate 
--    ,@LastEditUserSysNo 
--)
--END

IF( @ProductType IS NOT NULL AND @ProductType=4)
BEGIN	 
INSERT INTO IPP3.dbo.SO_ExtendWarrantyItem 
(
     SOSysNo 
    ,ProductSysNo 
    ,Briefname 
    ,Price 
    ,Quantity 
    ,MasterProductSysNo 
    ,CreateTime 
    ,CreateUserSysNo 
    ,Status 
    ,CompanyCode
) 
VALUES
(
     @SOSysNo 
    ,@ProductSysNo 
    ,@BriefName 
    ,@Price 
    ,@Quantity 
    ,@MasterProductSysNo 
    ,@CreateDate 
    ,@CreateUserSysNo 
    ,0 
    ,@CompanyCode
)
END

SELECT @SOItemSysNo
]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@Weight" dbType="Int32"/>
      <param name="@Price" dbType="Decimal"/>
      <param name="@CostPrice" dbType="Decimal"/>
      <param name="@GainAveragePoint" dbType="Int32"/>
      <param name="@PayType" dbType="Int32"/>
      <param name="@PromotionAmount" dbType="Decimal"/>
      <param name="@Warranty" dbType="String"/>
      <param name="@ProductType" dbType="Int32"/>
      <param name="@ProductName" dbType="String"/>
      <param name="@OriginalPrice" dbType="Decimal"/>
      <param name="@CouponAverageDiscount" dbType="Decimal"/>
      <param name="@MasterProductSysNo" dbType="String"/>
      <param name="@StockSysNo" dbType="String"/>
      <param name="@NoTaxCostPrice" dbType="Decimal"/>
      <param name="@PriceType" dbType="Int32"/>
      <param name="@DiscountType" dbType="Int32"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@ReferenceSysNo" dbType="Int32"/>
      <param name="@SettlementStatus" dbType="String"/>
      <param name="@CreateDate" dbType="DateTime"/>
      <param name="@CreateUserSysNo" dbType="Int32"/>
      <param name="@LastEditDate" dbType="DateTime"/>
      <param name="@LastEditUserSysNo" dbType="String"/>
      <param name="@BriefName" dbType="String"/>
      <param name="@ActivityType" dbType="String"/>
      <param name="@TariffAmount" dbType="Decimal"/>
      <param name="@TariffCode" dbType="AnsiString"/>
      <param name="@TariffRate" dbType="Decimal"/>
      <param name="@EntryRecord" dbType="AnsiString"/>
      <param name="@StoreType" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--添加订单赠品规则记录主信息 IPP3: InsertGiftMaster-->
  <dataCommand name="SO_Insert_GiftMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO OverseaOrderManagement.dbo.SO_GiftMaster 
(
     SOSysNo
    ,PromotionSysNo
    ,[Type]
    ,[Count]
    ,[Order]
    ,InDate
    ,InUser
) 
VALUES
(
     @SoSysNo
    ,@PromotionSysNo
    ,@InnerType
    ,@Time
    ,@Priority
    ,GETDATE()
    ,@InUser
)
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@InnerType" dbType="String"/>
      <param name="@Time" dbType="Int32"/>
      <param name="@Priority" dbType="Int32"/>
      <param name="@InUser" dbType="String"  property="[USERACCT]"/>
    </parameters>
  </dataCommand>

  <!--添加订单赠品规则记录商品信息 IPP3: InsertSOGiftItem-->
  <dataCommand name="SO_Insert_SOGiftItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO OverseaOrderManagement.dbo.SO_GiftItem 
(
     SOSysNo
    ,PromotionSysNo
    ,ProductSysNo
    ,Quantity
    ,InDate
    ,InUser
) 
VALUES
(
     @SOSysNo
    ,@PromotionSysNo
    ,@ProductSysNo
    ,@Quantity
    ,GETDATE()
    ,@InUser
)
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@InUser" dbType="String" property="[USERACCT]"/>
    </parameters>
  </dataCommand>

  <!--添加订单附件厂商赠品记录，IPP3:InsertSOItemAccessory-->
  <dataCommand name="SO_Insert_SOItemAccessory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[

INSERT INTO OverseaOrderManagement.dbo.SO_Item_Accessory 
(
     SOSysNo
    ,PromotionSysNo
    ,MasterProductSysNo
    ,ProductSysNo
    ,Quantity
    ,[Type]
    ,InDate
    ,InUser
) 
VALUES
(
     @SOSysNo
    ,@PromotionSysNo
    ,@MasterProductSysNo
    ,@ProductSysNo
    ,@Quantity
    ,@Type
    ,GETDATE()
    ,@InUser
)
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@MasterProductSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@Type" dbType="String"/>
      <param name="@InUser" dbType="String" property="[USERACCT]"/>
    </parameters>
  </dataCommand>

  <!--更新订单增值税发票信息到数据库，IPP3:UpdateSOVAT-->
  <dataCommand name="SO_Update_SOVATInvoice" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
           IF Exists(SELECT TOP 1 1 FROM IPP3.dbo.SO_ValueAdded_Invoice WITH(NOLOCK) WHERE SOSysNo=@SOSysNo)
           BEGIN
           
            UPDATE TOP(1)  IPP3.dbo.SO_ValueAdded_Invoice 
            SET CompanyName=@CompanyName
            ,TaxNum=@TaxNumber
            ,CompanyAddress=@CompanyAddress
            ,CompanyPhone=@CompanyPhone
            ,BankAccount=@BankAccount
            ,IsReceTaxpayerCertificate=@ExistTaxpayerCertificate
            ,Memo=@Memo
            WHERE SOSysNo =@SOSysNo
                      
           END
           ELSE
           BEGIN
           
             INSERT INTO IPP3.dbo.SO_ValueAdded_Invoice 
              (
                   SOSysNo
                  ,CustomerSysNo
                  ,CompanyName
                  ,TaxNum
                  ,CompanyAddress
                  ,CompanyPhone
                  ,BankAccount
                  ,Memo
                  ,CreateTime
                  ,IsReceTaxpayerCertificate
                  ,BankName
              ) 
              VALUES 
              (
                 @SOSysNo
                ,@CustomerSysNo
                ,@CompanyName
                ,@TaxNumber
                ,@CompanyAddress
                ,@CompanyPhone
                ,@BankAccount
                ,@Memo
                ,GETDATE()
                ,@ExistTaxpayerCertificate
                ,@BankName
              )
              SELECT SCOPE_IDENTITY()  
              
           END   
           
           UPDATE TOP(1) IPP3.dbo.SO_Master SET ISVAT=1 WHERE SysNo=@SOSysNo;
     ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@CompanyName" dbType="String"/>
      <param name="@TaxNumber" dbType="String"/>
      <param name="@CompanyAddress" dbType="String"/>
      <param name="@CompanyPhone" dbType="String"/>
      <param name="@BankAccount" dbType="String"/>
      <param name="@Memo" dbType="String"/>
      <param name="@ExistTaxpayerCertificate" dbType="Int32"/>
      <param name="@BankName" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--添加订单邮政自提信息，IPP3:InsertChinaPost-->
  <dataCommand name="SO_Insert_ChinaPost" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[			
      INSERT INTO [OverseaOrderManagement].[dbo].[SO_ChinaPost]
      (           
            [SOSysNo],
            [PickupPointId],
            [PointCode],
            [DisplayName],
            [Description],
            [Address],
            [ArrivalDays],
            [Length],
            [Width],
            [Height],
            [Weight],
            [CanAgentFund],
            [RegionId],
            [Longitude],
            [Latitude],
            [ZipCode],
            [Phone],
            [ContactWith],
            [State],
            [Province],
            [City],
            [District],
            [InDate],
            [InUser]
      )
      VALUES
       (         
            @SOSysNo,
            @PickupPointID,
            @PointCode,
            @DisplayName,
            @Description,
            @Address,
            @ArrivalDays,
            @Length,
            @Width,
            @Height,
            @Weight,
            @CanAgentFund,
            @RegionID,
            @Longitude,
            @Latitude,
            @ZipCode,
            @Phone,
            @ContactName,
            @State,
            @Province,
            @City,
            @District,
            getdate(),
            @InUser
      )
	  ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" size="4"/>
      <param name="@PickupPointID" dbType="Int32" size="4"/>
      <param name="@PointCode" dbType="String" size="50"/>
      <param name="@DisplayName" dbType="String" size="100"/>
      <param name="@Description" dbType="String" size="200"/>
      <param name="@Address" dbType="String" size="200"/>
      <param name="@ArrivalDays" dbType="Int32" size="4"/>
      <param name="@Length" dbType="Decimal" size="17"/>
      <param name="@Width" dbType="Decimal" size="17"/>
      <param name="@Height" dbType="Decimal" size="17"/>
      <param name="@Weight" dbType="Decimal" size="17"/>
      <param name="@CanAgentFund" dbType="Int32" size="4"/>
      <param name="@RegionID" dbType="Int32" size="4"/>
      <param name="@Longitude" dbType="Decimal" size="17"/>
      <param name="@Latitude" dbType="Decimal" size="17"/>
      <param name="@ZipCode" dbType="AnsiString" size="10"/>
      <param name="@Phone" dbType="AnsiString" size="50"/>
      <param name="@ContactName" dbType="String" size="50"/>
      <param name="@State" dbType="String" size="100"/>
      <param name="@Province" dbType="String" size="100"/>
      <param name="@City" dbType="String" size="100"/>
      <param name="@District" dbType="String" size="100"/>
      <param name="@InUser" dbType="String"   property="[USERACCT]"/>
    </parameters>
  </dataCommand>

  <!--判断支付类型和配送类型是否匹配-->
  <dataCommand name="GetShipPayList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT	 SysNo
					    	,ShipTypeSysNo
						    ,PayTypeSysNo
				FROM	IPP3.dbo.ShipType_PayType_un WITH(NOLOCK)
        WHERE CompanyCode=@CompanyCode AND  ShipTypeSysNo=@ShipTypeSysNo AND PayTypeSysNo=@PayTypeSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@companyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@shipTypeSysNo" dbType="Int32" size="10"/>
      <param name="@payTypeSysNo" dbType="Int32" size="10"/>
    </parameters>
  </dataCommand>

  <!--获取第一个订单-->
  <dataCommand name="SO_Get_IsFristSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					SELECT COUNT(1) 
          FROM OverseaOrderManagement.dbo.V_OM_SO_Master WITH(NOLOCK)
          WHERE CustomerSysNo = @CustomerSysNo 
            AND ([Status] = 4 OR [Status] = 5)
            AND [SysNo] <> @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--插入可疑订单用户-->
  <dataCommand name="InsertKnowFrandCustomer" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
                    INSERT INTO [OverseaOrderManagement].[dbo].[KnownFraudCustomer]
                               ([CustomerSysNo]
                               ,[ShippingContact]
                               ,[ShippingAddress]
                               ,[BrowseInfo]
                               ,[MobilePhone]
                               ,[Telephone]
                               ,[EmailAddress]
                               ,[IPAddress]
                               ,[Status]
                               ,[InUser]
                               ,[InDate]
                               ,[FraudType]
                               ,[CompanyCode])
                         VALUES
                               (@CustomerSysNo
                               ,@ShippingContact
                               ,@ShippingAddress
                               ,@BrowseInfo
                               ,@MobilePhone
                               ,@Telephone
                               ,@EmailAddress
                               ,@IPAddress
                               ,@Status
                               ,@InUser
                               ,@InDate
                               ,@FraudType
                               ,@CompanyCode)
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@ShippingContact" dbType="String"/>
      <param name="@ShippingAddress" dbType="String"/>
      <param name="@BrowseInfo" dbType="String"/>
      <param name="@MobilePhone" dbType="String"/>
      <param name="@Telephone" dbType="String"/>
      <param name="@EmailAddress" dbType="String"/>
      <param name="@IPAddress" dbType="String"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
      <param name="@InDate" dbType="DateTime"/>
      <param name="@FraudType" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--调用SP 计算 运费-->
  <dataCommand name="GetShipPrice_EC" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				EXEC OverseaOrderManagement.dbo.UP_OM_GetShippingFee_V3
					 @SOTotalWeight,
					 @SOAmount,
					 @ShipTypeSysNo,
					 @AreaSysNo,
					 @CustomerSysNo,
					 @IsUseDiscount,
					 @SOSingleMaxWeight,
           @LanguageCode,
					 @CompanyCode,
           @StoreCompanyCode
        ]]>
    </commandText>
    <parameters>
      <param name="@SOTotalWeight" dbType="Int32"/>
      <param name="@SOAmount" dbType="Decimal"/>
      <param name="@ShipTypeSysNo" dbType="Int32"/>
      <param name="@AreaSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@IsUseDiscount" dbType="Int32"/>
      <param name="@SOSingleMaxWeight" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="String" size="50"/>
    </parameters>
  </dataCommand>

  <!--特殊订单查询-->
  <dataCommand name="SO_Query_SpecialSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
        Select @TotalCount = COUNT(distinct sm.sysno)
          FROM IPP3.dbo.SO_Master sm WITH(NOLOCK)
          INNER JOIN  IPP3.dbo.SO_Item si With(NoLock) ON sm.SysNo=si.SOSysNo                        
          INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p With(NoLock) On p.SysNo=si.ProductSysNo
            #StrWhere#
    
        IF @EndNumber > @TotalCount
	      SET @EndNumber = @TotalCount
  
        ;WITH IT AS (
		    SELECT TOP (@EndNumber - @StartNumber) Sysno,RowNumber
		    FROM 
			    ( select TOP (@EndNumber) a.SysNo , ROW_NUMBER() OVER(ORDER BY #SortColumnName#) AS RowNumber from
				  IPP3.dbo.SO_Master sm 
				  INNER JOIN 
					(SELECT  sm.SysNo AS SysNo
					 FROM IPP3.dbo.SO_Item si With(NoLock)
						INNER JOIN IPP3.dbo.SO_Master sm With(NoLock) On sm.SysNo=si.SOSysNo                          
						INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p With(NoLock) On p.SysNo=si.ProductSysNo
				     #StrWhere#
					 GROUP BY sm.sysno 
					) AS a
			    ON sm.sysno=a.sysno
				) AS b
         ORDER BY RowNumber DESC)
 
        SELECT	p.[ProductID],
		      si.[SOSysNo],
		      sm.[SOID],
		      sm.[Status] as [SOStatus],
		      sm.[OrderDate] as [CreateTime],
		      sm.[CashPay] + sm.[PayPrice] + sm.[ShipPrice] + sm.[PremiumAmt] + sm.[DiscountAmt] as [TotalAmount]
        FROM IT
	        INNER JOIN IPP3.dbo.SO_Item si With(NoLock) ON (IT.SysNo = si.SOSysNo)
	        INNER JOIN IPP3.dbo.SO_Master sm With(NoLock) On sm.SysNo=si.SOSysNo                          
	        INNER JOIN OverseaContentManagement.dbo.V_CM_ItemBasicInfo p With(NoLock) On p.SysNo=si.ProductSysNo
        #extendWhere#
        ORDER BY RowNumber
        ]]>
    </commandText>
  </dataCommand>

  <!--(中蛋定制)待审核OZZO订单查询-->
  <dataCommand name="SO_Query_GetOZZOOriginNote" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT  @TotalCount= COUNT(1)
        FROM IPP3.dbo.V_SO_Master SO (NOLOCK) 
		        Left OUTER JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] USIF (NOLOCK) 
			        ON SO.UpdateUserSysno = USIF.UserSysno 
        #StrWhere#
        
        IF @EndNumber > @TotalCount
	      SET @EndNumber = @TotalCount
        
        ;WITH IT AS (
		          SELECT TOP (@EndNumber - @StartNumber ) a.Sysno, RowNumber 
		          FROM 
			           (SELECT TOP (@EndNumber) SO.SysNo AS SysNo
						        ,ROW_NUMBER() OVER(ORDER BY #SortColumnName#) AS RowNumber
				        FROM IPP3.dbo.V_SO_Master SO (NOLOCK) 
						        Left OUTER JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] USIF (NOLOCK) 
							        ON SO.UpdateUserSysno = USIF.UserSysno
				        #StrWhere#
				        ) AS a
                 ORDER BY RowNumber DESC)

        SELECT	 SO.SysNo,
		         SO.SoID,
		         SO.ReceiveName,
		         SO.Orderdate  AS OrderTime,
		         SO.Updatetime AS LastEditDate,
		         SO.Note,
		         USIF.[DisplayName] AS LastEditUserName
        FROM IT
	        INNER JOIN IPP3.dbo.V_SO_Master SO (NOLOCK) 
                ON (IT.SysNo = SO.SysNo)
	        Left OUTER JOIN [OverseaArchitecture].[dbo].[V_AR_UserInfo] USIF (NOLOCK) 
		        ON(SO.UpdateUserSysno = USIF.UserSysno)
        ORDER BY RowNumber
        ]]>
    </commandText>
  </dataCommand>

  <!--获取数据路系统配置表 读取相关配置文件-->
  <dataCommand name="QueryConfigurationByGetConfigKey" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT [value] from  IPP3.dbo.Sys_Configuration with (nolock) where [key] = '@Key' AND CompanyCode=@CompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <!--作废联通合约机订单 是 接触SIM 占用-->
  <dataCommand name="AbandonUnicomContractPhone" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[            
        DECLARE @Phone char(11)
        SELECT TOP(1) @Phone=su.CellPhone 
        FROM OverseaOrderManagement.dbo.SO_Unicom su WITH(NOLOCK)	
	      WHERE SoSysno=@SOSysNo AND CompanyCode=@CompanyCode	
    
        UPDATE TOP(1) OverseaContentManagement.dbo.Unicom_ContractPhone_PhoneNumber
        SET [Status]='A',[EditUser]=@EditUser
        WHERE CellPhone = @Phone
    
        SELECT @Phone;
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@EditUser" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="IsGeneratedSOVirtual" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
		SELECT COUNT(sv.sysno)
		FROM  ipp3.dbo.SO_VirtualItemRequest AS sv WITH(NOLOCK)
		INNER JOIN  IPP3.dbo.SO_Item V_SO_Item WITH(NOLOCK)
		ON sv.SOSysNo = V_SO_Item.SOSysNo and sv.ProductSysNo=V_SO_Item.ProductSysNo
		WHERE sv.Status!=@Status 
		AND V_SO_Item.SysNo = @SysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--查询BackOrder-->
  <dataCommand name="SO_Query_BackOrderItem" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
 SELECT	
     bo.SysNo
    ,bo.SOSysNo
    ,bo.ProductSysNo
    ,bo.KilledQty
    ,bo.OriginalQty
    ,p.ProductName
    ,p.ProductID 
 FROM	IPP3.dbo.SO_CheckShipping cs   WITH(NOLOCK) 
 INNER JOIN	IPP3.dbo.SO_BackOrderItem  bo WITH(NOLOCK) 
     ON cs.sosysno=bo.sosysno 
 INNER JOIN	OverseaContentManagement.dbo.V_CM_ItemBasicInfo p WITH(NOLOCK) 
     ON bo.productsysno = p.sysno 
 WHERE	
     cs.IsBackOrder=1 
     AND cs.SOSysNo =@SOSysNo 
         ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--查询CheckItemAccountQty-->
  <dataCommand name="SO_Query_CheckItemAccountQty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     SELECT	SI.ProductSysno,
		SI.WarehouseNumber,
		ISNULL(s.accountqty + s.consignqty - s.orderqty - s.allocatedqty - isnull(s.InvalidQty,0),0) AS Stock,
		ISNULL(s.accountqty + s.consignqty+ISNULL(svcount.svqty,0) - s.orderqty- s.allocatedqty - isnull(s.InvalidQty,0),0) AS CalQty
FROM	Ipp3.dbo.SO_Item SI WITH(NOLOCK) 
		LEFT JOIN 
		(
				SELECT	sv.productsysno AS svproductsysno,
						si.warehousenumber,
						SUM(sv.PurchaseQty) AS svqty 
				FROM	Ipp3.dbo.SO_VirtualItemRequest AS sv WITH (nolock)
					INNER JOIN	Ipp3.dbo.so_item si WITH (NOLOCK)       
						ON (si.ProductSysNo= sv.ProductSysNo AND si.SOSysNo=sv.SOSysNo)
					INNER JOIN	Ipp3.dbo.so_master sm WITH(nolock) 
						ON  sm.sysno=si.sosysno 
					LEFT JOIN	Ipp3.dbo.PO_Master WITH (NOLOCK)    
						ON (PO_Master.SysNo=sv.InStockOrderSysNo AND PO_Master.StockSysNo=si.warehousenumber   AND  sv.instockordertype=0 )
					LEFT JOIN	OverseaInventoryManagement.dbo.V_INM_Shift St_Shift WITH(nolock) 
						ON (St_Shift.sysno=sv.InStockOrderSysNo  AND St_Shift.StockSysNoB=si.warehousenumber   AND  sv.instockordertype=1 ) 
					LEFT JOIN	OverseaInventoryManagement.dbo.V_INM_Transfer St_Transfer WITH(nolock) 
						ON (St_Transfer.sysno=sv.InStockOrderSysNo AND St_Transfer.StockSysNo=si.warehousenumber   AND  sv.instockordertype=2)
				WHERE sm.status not in (4,-6) AND sv.status!=-1 
					AND ((ISNULL(PO_Master.Status,-999999)!=4	AND instockordertype=0 ) 
						   OR (ISNULL(St_Shift.Status,-999999)!=4  AND  instockordertype=1)
						   OR (ISNULL(St_Transfer.Status,-999999)!=3  AND  instockordertype=2))
				GROUP BY sv.productsysno,si.warehousenumber
		) svcount 
			ON si.productsysno = svcount.svproductsysno  
				AND si.warehousenumber=svcount.warehousenumber 
		LEFT JOIN  OverseaInventoryManagement.dbo.V_INM_Inventory_Stock s WITH (NOLOCK) 
			ON s.ProductSysNo = si.productsysno 
				AND s.StockSysNo=si.WarehouseNumber 
    WHERE	si.productType IN (0,1,2)  
		    AND sosysno = @SOSysNO 
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNO" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--查询商品的分仓OrderQty中的未支付数量-->
  <dataCommand name="SO_Query_CalUnPayOrderQty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
     SELECT IsNull(Sum(ISNull(SI.Quantity,0)),0)  
		FROM IPP3.dbo.SO_Item  SI WITH(NOLOCK)  
		Inner  Join IPP3.dbo.SO_Master  SM WITH(NOLOCK) ON  SI.SOSysNo=SM.SysNo
		Inner  Join OverseaControlPanel.dbo.V_CP_PayType    PI WITH(NOLOCK) ON  SM.PayTypeSysNo=PI.SysNo 
		WHERE  SM.Status>=0  
			AND SM.Status<>1  
			AND SM.Status<>4 
			AND PI.IsPayWhenRecv=0 
			AND ProductSysNo=@ProductSysNo  
			AND SI.WarehouseNumber=@StockSysNo
			AND Not Exists
			( 
				SELECT  1
				FROM  IPP3.dbo.Finance_NetPay FN WITH(NOLOCK)
				WHERE   FN.SOSysNo=SM.SysNo   
					AND  FN.Status>=0
			) 
			AND Not Exists
			(
				SELECT 1
				FROM  IPP3.dbo.Finance_PostPay  FP WITH(NOLOCK)
				WHERE   FP.SOSysNo=SM.SysNo   
					AND  FP.Status>=0
			)
        ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@StockSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--根据订单编号获取证件名-->
  <dataCommand name="SO_Get_CertificaterNameBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 
				CertificaterName 
			FROM OverseaOrderManagement.dbo.SO_OldChangeNew WITH(NOLOCK) 
			WHERE 
				SOSysNo=@SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateSONote" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
					 UPDATE IPP3.dbo.SO_Master 
					 SET Note=@Note
                     WHERE SysNo=@SysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@Note" dbType="String" size="1000"/>
    </parameters>
  </dataCommand>

  <!--获取推荐商品信息-->
  <dataCommand name="SO_Get_CommendatoryProducts" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
          EXEC OverseaOrderManagement.dbo.UP_OM_QueryCommendatoryProducts @SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetAllGoupMaxPreOrder" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT g.SysNo
		  ,g.MaxPerOrder
		  ,s.ProductSysNo
FROM OverseaECommerceManagement.dbo.V_MKT_ProductGroupBuying g WITH(NOLOCK)
LEFT JOIN OverseaECommerceManagement.dbo.V_MKT_ProductGroupBuying_SnapShotPrice s WITH(NOLOCK)
ON g.SysNo = s.ProductGroupBuyingSysNo
WHERE g.SysNo IN (#SysNo#)      
        ]]>
    </commandText>
    <parameters>
      <!--<param name="@SOSysNo" dbType="Int32"/>-->
    </parameters>
  </dataCommand>
  <dataCommand name="SO_Get_HasAcctConfirmed" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT	COUNT(1) 
				FROM	IPP3.dbo.so_master AS a WITH (nolock) 
						LEFT JOIN OverseaInvoiceReceiptManagement.dbo.V_IM_SOIncome AS b WITH (nolock) ON a.sysno=b.OrderSysNo
				WHERE	a.OutTime < dateadd(d,-@PayDays,getdate()) 
						AND b.Status=0 
						AND b.OrderType=1
						AND a.PayTypeSysNo=4 
						AND a.CustomerSysNo=@CustomerSysNo
						AND a.CompanyCode=@CompanyCode
        ]]>
    </commandText>
    <parameters>
      <param name="@PayDays" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--删除新促销应用日志信息(明细及主表信息)-->
  <dataCommand name="SO_NewPromo_DeleteMasterAndDetail" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
delete mpd
from OverseaOrderManagement.dbo.SO_MarketingPromoDetail mpd
inner join OverseaOrderManagement.dbo.SO_MarketingPromo mp
on mpd.SOMarketingPromoSysNo=mp.SysNo
where mp.SOSysNo=@SOSysNo

DELETE FROM  OverseaOrderManagement.dbo.SO_MarketingPromo 
WHERE  SOSysNo=@SOSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>


  <!--新促销应用日志主表-->
  <dataCommand name="SO_NewPromo_InsertLogMaster" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
    INSERT INTO OverseaOrderManagement.[dbo].[SO_MarketingPromo]
		(
			[SOSysNo]
      ,[PromoSysNo]
      ,[PromoType]
      ,VendorSysNo
      ,PromoRuleData
      ,InDate
      ,InUser
		)
    VALUES
    (
      @SOSysNo
      ,@PromoSysNo
      ,@PromoType
      ,@VendorSysNo
      ,@PromoRuleData
      ,getdate()
      ,@InUser
    )
    SET @SysNo=SCOPE_IDENTITY()
    ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromoSysNo" dbType="Int32"/>
      <param name="@PromoType" dbType="Int32"/>
      <param name="@VendorSysNo" dbType="Int32"/>
      <param name="@PromoRuleData" dbType="String"/>
      <param name="@InUser" dbType="String"/>
      <param name="@SysNo" dbType="Int32" direction="Output" />
    </parameters>
  </dataCommand>

  <!--新促销应用日志明细表-->
  <dataCommand name="SO_NewPromo_InsertLogDetail" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
    INSERT INTO OverseaOrderManagement.[dbo].[SO_MarketingPromoDetail]
        (
			SOMarketingPromoSysNo
           ,ProductSysNo
           ,ProductQuantity
           ,DiscountAmount
		)
    VALUES
    (
      @SOMarketingPromoSysNo
      ,@ProductSysNo
      ,@ProductQuantity
      ,@DiscountAmount
    )
    ]]>
    </commandText>
    <parameters>
      <param name="@SOMarketingPromoSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@ProductQuantity" dbType="Int32"/>
      <param name="@DiscountAmount" dbType="Decimal"/>
    </parameters>
  </dataCommand>


  <dataCommand name="GetTrackingNumberStrBySoSysno" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT distinct TrackingNumber --快递单号
      FROM [Dropship].[dbo].[SO_TrackingNumber] WITH(NOLOCK)
      WHERE SONumber = @SOSysNo and TrackingNumber is not null
        ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

 
<dataCommand name="GetProductStockByProductSysNoAndQty" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
Stock.StockName,Stock.SysNo
  FROM OverseaInventoryManagement.dbo.V_INM_Inventory_Stock as Inventory
  INNER JOIN OverseaInventoryManagement.dbo.V_INM_Stock as Stock 
    ON Stock.SysNo = Inventory.WarehouseSysNumber 
  WHERE 
  Inventory.AvailableQty+Inventory.ConsignQty+Inventory.VirtualQty-isnull(Inventory.InvalidQty,0) >= @ProductQty
    AND Inventory.ItemSysNumber = @ProductSysNo
    order by 
    case  when Inventory.AvailableQty+Inventory.ConsignQty - Inventory.InvalidQty - @ProductQty >=0 then 1 else 0 end , stock.WarehouseRate desc, Stock.SysNo asc
        ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@ProductQty" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改订单状态为订单为报关失败作废-->
  <dataCommand name="SO_Update_SOStatusToReportedFailure" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE	IPP3.dbo.SO_Master
				SET Status = 6
				WHERE SysNo = @SOSysNo
        
     UPDATE	IPP3.dbo.SO_CheckShipping
				SET  LastChangeStatusDate=getdate() 
				WHERE SOSysNo = @SOSysNo
        
        
INSERT INTO [OverseaInventoryManagement].[dbo].[ProductCostIn]
           ([ProductSysNo]
           ,[BillType]
           ,[BillSysNo]
           ,[Cost]
           ,[Quantity]
           ,[LeftQuantity]
           ,[LockQuantity]
           ,[TaxRate]
           ,[InDate]
           ,[Priority]
           ,CurrencySysNo
           ,ExchangeRate
           ,WarehouseNumber)
  SELECT po.[ProductSysNo]
      ,[BillType]
      ,[BillSysNo]
      ,po.[Cost]
      ,po.[Quantity]
      ,po.[Quantity] as [LeftQuantity]
      ,0
      ,ISNULL(pct.TaxRate,0.17) as [TaxRate]
      ,GETDATE() as [InDate]
      ,9999 AS [Priority]
      ,si.CurrencySysNo
      ,si.ExchangeRate
      ,si.WarehouseNumber
  FROM [OverseaInventoryManagement].[dbo].[ProductCostOut] as po WITH(NOLOCK)
  INNER JOIN IPP3.dbo.SO_Item as si WITH(NOLOCK) ON po.BillSysNo=si.SOSysNo AND BillType=20 AND si.ProductSysNo=po.ProductSysNo AND si.ProductType<>3 AND si.ProductType<>4
  INNER JOIN IPP3.dbo.Product as p WITH(NOLOCK) ON p.SysNo=po.ProductSysNo
  Left JOIN OverseaContentManagement.dbo.ProductCommonInfo_TaxRate as pct WITH(NOLOCK) ON p.ProductCommonInfoSysno=pct.ProductCommonInfoSysno
  Where po.BillSysNo=@SOSysNo
  
    
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--修改订单状态为订单为已报关-->
  <dataCommand name="SO_Update_SOStatusToReported" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE	IPP3.dbo.SO_Master
				SET Status = 41
				WHERE SysNo = @SOSysNo and Status=4
        
     UPDATE	IPP3.dbo.SO_CheckShipping
				SET  LastChangeStatusDate=getdate() 
				WHERE SOSysNo = @SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
  
  <!--修改订单SO_CheckShipping的LastChangeStatusDate-->
  <dataCommand name="SO_Update_SOCheckShippingLastChangeStatusDate" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE [IPP3].[dbo].[SO_CheckShipping]
				SET [LastChangeStatusDate] = GETDATE()
				WHERE [SOSysNo] = @SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--获取查询物流信息的订单-->
  <dataCommand name="SO_Get_WaitingFinishShippingList" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT
	SOTrackingNumber.TrackingNumber
FROM [IPP3].[dbo].[SO_Master](NOLOCK) SOMaster
INNER JOIN [Dropship].[dbo].[SO_TrackingNumber](NOLOCK) SOTrackingNumber ON SOMaster.SysNo = SOTrackingNumber.SONumber
INNER JOIN [IPP3].[dbo].[ShipType] AS st ON st.SysNo = SOMaster.ShipTypeSysNo
WHERE
	SOMaster.[Status] = 4--已通关发往顾客
	AND SOMaster.ShipTypeSysNo = @ShipTypeSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@ShipTypeSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--获取快递100查询物流信息的订单-->
  <dataCommand name="SO_Get_WaitingFinishShippingListForKD100" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT
	SOTrackingNumber.TrackingNumber,st.ShipTypeID
FROM [IPP3].[dbo].[SO_Master](NOLOCK) SOMaster
INNER JOIN [Dropship].[dbo].[SO_TrackingNumber](NOLOCK) SOTrackingNumber ON SOMaster.SysNo = SOTrackingNumber.SONumber
INNER JOIN [IPP3].[dbo].[ShipType] AS st ON st.SysNo = SOMaster.ShipTypeSysNo
WHERE
	SOMaster.[Status] = 4--已通关发往顾客
		 ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>
  
  <!--根据运单号查询订单号-->
  <dataCommand name="SO_Get_SOSysNoByTrackingNumber" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT SONumber FROM [Dropship].[dbo].[SO_TrackingNumber](NOLOCK)
WHERE TrackingNumber = @TrackingNumber
		 ]]>
    </commandText>
    <parameters>
      <param name="@TrackingNumber" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--订单申报Start-->
  <!--获取待申报的订单-->
  <dataCommand name="SO_GetWaitDeclareSO" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				SELECT SOMaster.SysNo AS SOSysNo, SOTrackingNumber.TrackingNumber
	        FROM [IPP3].[dbo].[SO_Master](NOLOCK) SOMaster
	        LEFT JOIN [Dropship].[dbo].[SO_TrackingNumber](NOLOCK) SOTrackingNumber
	        ON SOMaster.SysNo = SOTrackingNumber.SONumber
	        LEFT JOIN [IPP3].[dbo].[SO_CheckShipping](NOLOCK) CheckShipping
	        ON SOMaster.SysNo = CheckShipping.SOSysNo
	        WHERE SOMaster.[Status] = 4
	        AND CheckShipping.SOType = 0
	        AND SOTrackingNumber.TrackingNumber IS NOT NULL
	        AND SOMaster.SysNo NOT IN
	        (SELECT [SOSysNo] FROM [IPP3].[dbo].[SO_DeclareRecords](NOLOCK))
          AND CheckShipping.LocalWHSysNo IN (SELECT [SysNo] FROM [IPP3].[dbo].[Stock](NOLOCK) WHERE MerchantSysNo = 1 AND StockType = 1)--只取泰隆优选自贸仓订单
		 ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>
  <!--创建订单申报记录编号-->
  <dataCommand name="SO_CreateSODeclareRecordsSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				INSERT INTO [IPP3].[dbo].[SO_DeclareRecordsSequence]
                   ([InDate])
             VALUES
                   (GETDATE())
        SELECT SCOPE_IDENTITY() AS SysNo
		 ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>
  <!--创建订单申报记录-->
  <dataCommand name="SO_CreateSODeclareRecords" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				INSERT INTO [IPP3].[dbo].[SO_DeclareRecords]
                   ([SysNo]
                   ,[SOSysNo]
                   ,[TrackingNumber]
                   ,[Status]
                   ,[InDate]
                   ,[EditDate])
             VALUES
                   (@SysNo
                   ,@SOSysNo
                   ,@TrackingNumber
                   ,0
                   ,GETDATE()
                   ,NULL)
		 ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@TrackingNumber" dbType="String"/>
    </parameters>
  </dataCommand>
  <!--申报时获取订单信息-->
  <dataCommand name="SO_DeclareGetOrderInfoBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT TOP 1
	    A.SysNo AS SoSysNo,
      (select SUM(PromotionDiscount*Quantity) from IPP3..SO_Item(nolock) where SOSysNo=@SOID) as PromotionAmt,
      A.TariffAmt as TariffAmt,
    	A.PointAmt as PointAmt,
	    A.SOID AS SOCode,
	    A.Status AS SOStatus,
	    A.CustomerSysNo,
	    A.StockSysNo,
	    A.OrderDate,
	    A.DeliveryDate,
	    A.SalesManSysNo,
	    A.IsWholeSale,
	    A.IsPremium,		
	    A.PayTypeSysNo,
	    A.SOAmt,
	    A.AllocatedManSysNo,
	    A.FreightUserSysNo,
	    A.UpdateUserSysNo,
	    ISNULL(A.UpdateTime,'1900-01-01') AS UpdateTime,
	    A.AuditUserSysNo,
	    A.AuditTime,
	    A.ManagerAuditUserSysNo,
	    A.ManagerAuditTime,
	    A.OutUserSysNo,
	    A.OutTime,
	    A.Memo,
	    A.Note,
	    A.InvoiceNote,
	    A.IsVAT,
	    A.IsPrintPackageCover,
	    A.DeliveryMemo,
	    A.PackageID,
	    A.FinanceNote,
	    A.InvoiceNo,
	    A.PromotionCustomerSysNo,
	    A.IsLarge,
	    A.PositiveSOSysNo,
	    A.IsMobilePhone,
	    A.DeliveryTimeRange,
	    A.PromotionCodeSysNo,
	    promotion.PromotionCode,
	    A.HoldMark,
	    A.HoldDate,
	    A.HoldUser,
	    A.HoldReason,
	    A.ShoppingMasterSysNo,
	    A.HaveAutoRMA,
	    A.IsUseChequesPay,
	    A.IsUsePrepay,
	    A.PrepayAmt,
	    D.CompanyCustomer,
	    D.Email,
	    U.UserName,
	    U.Phone,
	    ISNULL(E.IsDCOrder,0) AS IsDCOrder,
	    ISNULL(E.SOType,0) AS SOType,
	    ISNULL(E.IsBackOrder,0) AS IsBackOrder,
	    ISNULL(E.RingOutShipType,'') AS RingOutShipType,
	    ISNULL(E.DeliveryType,'0') AS ShipDeliveryType,
	    A.HoldMark,
	    A.HoldDate,
	    E.HoldStatus,
	    ISNULL(F.ProvinceName,'')+' '+ISNULL(F.CityName,'')+' '
	    + ISNULL(F.DistrictName,'') AS AddressArea,
	    E.DeliveryPromise,
	    D.FromLinkSource,
	    B.ShipTypeDesc,
	    E.IsRequireShipInvoice,
	    E.SoSplitType,
	    E.SoSplitMaster,
	    A.GiftCardPay,
	    E.DeliverySection,
	    A.CashPay as [Amount.CashPay],
	    A.DiscountAmt as [Amount.DiscountAmt],
	    A.GiftCardPay as [Amount.GiftCardPay],
	    A.PayPrice as [Amount.PayPrice],
	    A.PointAmt as [Amount.PointAmt],
	    A.PointPay as [Amount.PointPay],
	    A.PremiumAmt as [Amount.PremiumAmt],
	    A.PrepayAmt as [Amount.PrepayAmt],
	    A.SOAmt as [Amount.SOAmt],
	    A.ShipPrice as [Amount.ShipPrice],
	    B.ShipTypeName as  [ShipType.ShipTypeName],
	    B.ShipTypeDesc as  [ShipType.ShipTypeDesc],
	    C.SysNo as  [Payment.PayTypeID],
	    C.PayTypeName as  [Payment.PayTypeName],
	    C.IsPayWhenRecv as  [Payment.IsPayWhenRecv],
	    C.IsNet as  [Payment.IsNet],
	    f.ProvinceName + ' ' + f.CityName + ' ' + f.DistrictName as ReceiveAreaName,	
	    A.ReceiveAreaSysNo,
	    A.ReceiveContact,
	    A.ReceiveName,
	    A.ReceivePhone,
	    A.ReceiveCellPhone,
	    A.ReceiveAddress,
	    A.ReceiveZip,
      A.CurrencySysNo,
      A.[CompanyCode],
      A.[LanguageCode],
      A.[StoreCompanyCode],
      A.PointPay
	,s.Contact AS senderName
	,s.Phone AS senderTel
	,s.CompanyName AS senderCompanyName
	,s.Address AS senderAddr
	,s.Zip AS senderZip
	,s.City AS senderCity
	,s.Province AS senderProvince
	,s.CustomsCode
	,s.StockType
	,ISNULL(country.CountryCode3, country.CountryCode) AS senderCountry
  ,C.SysNo AS PayTypeSysNo
  ,C.PayTypeID AS PayTypeID
    FROM [IPP3].dbo.SO_Master A WITH (NOLOCK)
    LEFT JOIN [IPP3].dbo.ShipType B WITH (NOLOCK) ON A.ShipTypeSysNo = B.SysNo
    LEFT JOIN [IPP3].dbo.PayType C WITH (NOLOCK) ON A.PayTypeSysNo = C.SysNo
    LEFT JOIN [IPP3].dbo.Customer D WITH (NOLOCK) ON A.CustomerSysNo = D.SysNo
    LEFT JOIN [IPP3].dbo.sys_user U WITH(NOLOCK) ON U.sysno = A.FreightUserSysNo
    LEFT JOIN [IPP3].dbo.SO_CheckShipping E WITH(NOLOCK) ON A.SysNo = E.SOSysNo	
    LEFT JOIN [IPP3].[dbo].[area] F WITH(NOLOCK) ON A.ReceiveAreaSysNo =F.SysNo
    LEFT JOIN [IPP3].dbo.Promotion_Code promotion WITH (NOLOCK) 
    ON A.PromotionCodeSysNo = promotion.SysNo
    LEFT JOIN [IPP3].[dbo].[Stock] AS s WITH(NOLOCK) ON s.SysNo = E.LocalWHSysNo
    LEFT JOIN [IPP3].[dbo].[Country] AS country WITH(NOLOCK) ON country.CountryCode = s.CountryCode
    WHERE A.SysNo = @SOID

    SELECT 
	    A.SysNo,
	    A.SOSysNo AS SOID,
	    A.ProductSysNo AS ProductID,
	    p.ProductTitle AS ProductName,
	    A.Quantity,
	    A.Weight,
	    A.Price,
	    A.Cost,
	    A.Point,
	    A.PointType,
	    A.DiscountAmt,
	    A.Warranty,
	    CASE WHEN A.ProductType = 1 
	    AND EXISTS(SELECT TOP 1 1 FROM [IPP3].dbo.sale_gift AS gift WITH(Nolock) 
          WHERE CHARINDEX(','+CAST(gift.ProductSysNo AS NVARCHAR)+',', ','+A.MasterProductSysNo+',') > 0
		    AND gift.GiftSysNo=A.ProductSysNo 
		    AND gift.isOnlineShow = 0
		    AND gift.Status <> -1) 
        THEN 5 ELSE A.ProductType END AS ProductType,
	    A.GiftSysNo AS GiftID,
	    A.BriefName,
	    A.OriginalPrice,
	    A.PromotionDiscount,
	    A.IsDuplicateOrder,
	    A.DuplicateSOSysNo,
	    A.MasterProductSysNo,
	    A.WarehouseNumber,
	    A.UnitCostWithoutTax,
	    A.IsMemberPrice,
	    p.ProductID AS Code,
	    p.Status,
	    p.C3SysNo,
	    price.MaxPerOrder,
	    stock.StockName AS WarehouseName,
      ISNULL(country.CountryCode3, country.CountryCode) AS CountryCode,
	    e.TariffRate,
      e.EntryCode,
      e.TariffCode,
      A.TariffAmt
    FROM [IPP3].dbo.SO_Item A WITH (NOLOCK)
    LEFT JOIN [IPP3].dbo.Product p WITH (NOLOCK) ON p.SysNo = a.ProductSysNo 
      LEFT JOIN [IPP3].dbo.Product_Price AS price WITH (NOLOCK) ON a.ProductSysNo = price.ProductSysNo
      LEFT JOIN [IPP3].dbo.Stock AS stock WITH (NOLOCK) ON a.WarehouseNumber = stock.SysNo
        join IPP3..Product_EntryInfo e (nolock)
    LEFT JOIN [IPP3].[dbo].[Country] AS country WITH(NOLOCK) ON country.CountryCode = e.Origin
	    on e.ProductSysNo=p.SysNo
    WHERE A.SOSysNo = @SOID 
    ORDER BY A.SysNo
    
    SELECT TOP 1 ISNULL([ExternalKey], '') AS [SerialNumber]
      ,ISNULL([PayProcessTime], '') AS [PayProcessTime]
      FROM [IPP3].[dbo].[Finance_NetPay](NOLOCK)
      WHERE SOSysNo = @SOID
			]]>
    </commandText>
    <parameters>
      <param name="@SOID" dbType="Int32" />
    </parameters>
  </dataCommand>
  <!--订单申报End-->

  <!--订单支付申报Start-->
  <!--申报时获取订单支付信息-->
  <dataCommand name="SO_DeclareGetPaymentInfoBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT
	soa.SOSysNo AS MerchantOrderId
	,fnp.PayAmount AS PayAmount
	,vci.PayCurrencyCode AS PayCUR
	,fnp.PayTransNumber
	,fnp.PayProcessTime AS PayTime
	,pt.PayTypeName AS BankPayName
	,pt.PayTypeID AS BankPayCode
	,fnp.BankTransNumber AS BankSerialNo
	,soa.Name AS PersonName
	,soa.IDCardType
	,soa.IDCardNumber AS IdentifyCode
	,soa.PhoneNumber AS Mobile
	,156 AS CountryCode--国家代码，目前默认156:中国
	,soa.Email AS Email
	,soa.Address AS Address
	,soa.Gender
	,soa.Birthday AS Birthday
	,socs.MerchantSysNo
	,fnp.DeclareTrackingNumber
	,fnp.DeclareStatus
  ,pt.PayTypeID
  ,pt.SysNo AS PayTypeSysNo
FROM [IPP3].[dbo].[SO_Authentication] AS soa WITH(NOLOCK)
INNER JOIN [IPP3].[dbo].[SO_CheckShipping] AS socs WITH(NOLOCK) ON socs.SOSysNo=soa.SOSysNo
INNER JOIN [IPP3].[dbo].[Finance_NetPay] AS fnp WITH(NOLOCK) ON soa.SOSysNo=fnp.SOSysNo AND fnp.Status = 1
INNER JOIN [IPP3].[dbo].[Vendor_Customs_Info] AS vci WITH(NOLOCK) ON socs.MerchantSysNo=vci.MerchantSysNo
INNER JOIN [IPP3].[dbo].[PayType] AS pt WITH(NOLOCK) ON pt.SysNo=fnp.PayTypeSysNo
WHERE fnp.SOSysNo = @SOID
			]]>
    </commandText>
    <parameters>
      <param name="@SOID" dbType="Int32" />
    </parameters>
  </dataCommand>
  <!--申报时更新订单支付申报状态-->
  <dataCommand name="SO_DeclareUpdatePaymentDeclareInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
UPDATE [IPP3].[dbo].[Finance_NetPay]
	SET DeclareTrackingNumber=@DeclareTrackingNumber,DeclareStatus=@DeclareStatus
WHERE SOSysNo = @SOID
			]]>
    </commandText>
    <parameters>
      <param name="@SOID" dbType="Int32" />
      <param name="@DeclareTrackingNumber" dbType="String" />
      <param name="@DeclareStatus" dbType="Int32" />
    </parameters>
  </dataCommand>
  <!--订单支付申报End-->

  <!--修改订单状态为订单为 已通关发往顾客-->
  <dataCommand name="SO_Update_SOStatusToCustomsPass" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
				UPDATE	IPP3.dbo.SO_Master
				SET Status = 4
				WHERE SysNo = @SOSysNo
        
     UPDATE	IPP3.dbo.SO_CheckShipping
				SET  LastChangeStatusDate=getdate() 
				WHERE SOSysNo = @SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--加载关务对接相关信息-->
  <dataCommand name="SO_LoadVendorCustomsInfo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT TOP 1 vci.* FROM IPP3.dbo.Vendor_Customs_Info AS vci WITH(NOLOCK)
LEFT JOIN IPP3.dbo.SO_CheckShipping AS socs WITH(NOLOCK) ON socs.MerchantSysNo=vci.MerchantSysNo
LEFT JOIN IPP3.dbo.SO_Master AS som WITH(NOLOCK) ON som.SysNo=socs.SOSysNo
#StrWhere# 
			]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>

  <!--获取 订单中快照的下单人实名认证信息-->
  <dataCommand name="SO_Get_SOCustomer_Authentication" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT [SOSysNo]
      ,[CustomerSysNo]
      ,[Name]
      ,[IDCardType]
      ,[IDCardNumber]
      ,[Birthday]
      ,[PhoneNumber]
      ,[Email]
      ,[Address]
      ,[Gender]
      FROM [IPP3].[dbo].[SO_Authentication] WITH(NOLOCK)
      WHERE [SOSysNo]=@SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

<!--订单编辑页面 保存 更新备注-->
  <dataCommand name="SOMaintain_UpdateNote" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
			UPDATE [IPP3].[dbo].[SO_CheckShipping]
         SET [MemoForCustomer] = @MemoForCustomer
       WHERE [SOSysNo] = @SOSysNo
       
      UPDATE [IPP3].[dbo].[SO_Master]
       SET [Note] = @Note
          ,[InvoiceNote] = @InvoiceNote
          ,[FinanceNote] = @FinanceNote
          ,[ReceiveAreaSysNo]=@ReceiveAreaSysNo
          ,[ReceiveAddress]=@ReceiveAddress
     WHERE [SysNo] = @SOSysNo
		 ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@MemoForCustomer" dbType="String"/>
      <param name="@Note" dbType="String"/>
      <param name="@InvoiceNote" dbType="String"/>
      <param name="@FinanceNote" dbType="String"/>
      <param name="@ReceiveAreaSysNo" dbType="Int32"/>
      <param name="@ReceiveAddress" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--是否归还库存-->
  <dataCommand name="CheckReturnInventory" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[		
  SELECT  COUNT(1)
  FROM [IPP3].[dbo].[Sale_CountDown]
  WHERE [ProductSysNo]=@ProductSysNo and  @SOCreatDate between [StartTime] and  [EndTime]
    ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@SOCreatDate" dbType="DateTime"/>
    </parameters>
  </dataCommand>
    <!--根据订单号查询Netpay-->
  <dataCommand name="Order_GetCenterDBNetpayBySOSysNo" database="NCService" commandType="Text">
    <commandText>
      <![CDATA[
	    SELECT [SysNo]
            ,[SOSysNo]
            ,[PayTypeSysNo]
            ,[PayAmount]
            ,[Source]
            ,[InputTime]
            ,[InputUserSysNo]
            ,[ApproveUserSysNo]
            ,[ApproveTime]
            ,[Note]
            ,[Status]
            ,[ReviewedUserSysNo]
            ,[ReviewedTime]
            ,[RelatedSoSysNo]
            ,[ExternalKey]
            ,[CompanyCode]
            ,[LanguageCode]
            ,[CurrencySysNo]
            ,[StoreCompanyCode]
            ,[MasterSoSysNo]
            ,[OrderAmt]
            ,[PrePayAmt]
            ,[PointPayAmt]
            ,[GiftCardPayAmt]
        FROM [IPP3].[dbo].[Finance_NetPay]
        WHERE [SOSysNo] = @SOSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
</dataOperations>
