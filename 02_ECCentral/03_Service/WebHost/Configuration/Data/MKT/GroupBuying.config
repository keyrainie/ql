<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <!--查询团购-->
  <dataCommand name="GetProductGroupBuyingList" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[			
SELECT @TotalCount=COUNT(1)
FROM OverseaContentManagement.dbo.ProductGroupBuying M WITH(NOLOCK)
LEFT JOIN (SELECT P1.SysNo
                  ,P1.C3SysNo as C3SysNo
                  ,C2.SysNo as C2SysNo
                  ,C2.C1SysNo as C1SysNo
                  ,P1.ProductID
                  ,P1.ProductTitle FROM IPP3.dbo.Product P1 WITH(NOLOCK)
    INNER JOIN OverseaContentManagement.dbo.V_IM_Category3 C3 WITH(NOLOCK) ON P1.C3SysNo = C3.SysNo  
    INNER JOIN OverseaContentManagement.dbo.V_IM_Category2 C2 WITH(NOLOCK) ON C3.C2SysNo = C2.SysNo ) P 
      ON M.ProductSysNo = P.SysNo 
    LEFT JOIN [OverseaContentManagement].[dbo].[GroupBuyingCategory] c ON M.GroupBuyingCategorySysNo=c.SysNo
    #StrWhere#

IF OBJECT_ID(N'tempdb.dbo.#TempTable',N'U') IS NOT NULL
	DROP TABLE #TempTable

CREATE TABLE #TempTable
(
RowNumber INT PRIMARY KEY
,SysNo INT NOT NULL
)

INSERT #TempTable(SysNo,RowNumber)
SELECT M.SysNo
,ROW_NUMBER() OVER(ORDER BY #SortColumnName#) AS RowNumber
FROM OverseaContentManagement.dbo.ProductGroupBuying M WITH(NOLOCK)
LEFT JOIN (SELECT P1.SysNo
                  ,P1.C3SysNo as C3SysNo
                  ,C2.SysNo as C2SysNo
                  ,C2.C1SysNo as C1SysNo
                  ,P1.ProductID
                  ,P1.ProductTitle FROM IPP3.dbo.Product P1 WITH(NOLOCK)
    INNER JOIN OverseaContentManagement.dbo.V_IM_Category3 C3 WITH(NOLOCK) ON P1.C3SysNo = C3.SysNo  
    INNER JOIN OverseaContentManagement.dbo.V_IM_Category2 C2 WITH(NOLOCK) ON C3.C2SysNo = C2.SysNo ) P 
      ON M.ProductSysNo = P.SysNo
    LEFT JOIN [OverseaContentManagement].[dbo].[GroupBuyingCategory] c ON M.GroupBuyingCategorySysNo=c.SysNo
    LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V on V.SysNo=M.VendorSysNo
#StrWhere#

SELECT  
    M.SysNo
    ,M.ProductSysNo
    ,M.GroupBuyingTitle
    ,M.GroupBuyingDesc
    ,M.GroupBuyingPicUrl
    ,M.GroupBuyingSmallPicUrl
    ,M.BeginDate
    ,M.CompanyCode
    ,M.EndDate
    ,M.CurrentSellCount
    ,M.Status
    ,'' as StatusDesc
    ,M.Priority
    ,M.InDate
    ,M.InUser
    ,M.EditDate
    ,M.EditUser
    ,M.AuditDate
    ,M.AuditUser
    ,P.ProductID
    ,P.ProductTitle
    ,M.CompanyCode
    ,MT.ProductGroupBuyingTypeName GroupBuyingTypeName
    ,c.Name GroupBuyingCategoryName
    ,MA.ProductGroupBuyingAreaName GroupBuyingAreaName
    ,M.VendorSysNo
    ,M.RequestSysNo
    ,c.CategoryType as GroupBuyingCategoryType
    ,V.VendorName
FROM #TempTable T
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying M WITH(NOLOCK)
ON T.SysNo=M.SysNo
LEFT JOIN (SELECT P1.SysNo
                  ,P1.C3SysNo as C3SysNo
                  ,C2.SysNo as C2SysNo
                  ,C2.C1SysNo as C1SysNo
                  ,P1.ProductID
                  ,P1.ProductTitle FROM IPP3.dbo.Product P1 WITH(NOLOCK)
        INNER JOIN OverseaContentManagement.dbo.V_IM_Category3 C3 WITH(NOLOCK) ON P1.C3SysNo = C3.SysNo  
        INNER JOIN OverseaContentManagement.dbo.V_IM_Category2 C2 WITH(NOLOCK) ON C3.C2SysNo = C2.SysNo ) P 
          ON M.ProductSysNo = P.SysNo 
LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V on V.SysNo=M.VendorSysNo
LEFT JOIN [OverseaContentManagement].[dbo].[ProductGroupBuying_Type] MT WITH(NOLOCK) ON M.GroupBuyingTypeSysNo = MT.SysNo
LEFT JOIN [OverseaContentManagement].[dbo].[ProductGroupBuying_Area] MA WITH(NOLOCK) ON M.GroupBuyingAreaSysNo = MA.SysNo
LEFT JOIN [OverseaContentManagement].[dbo].[GroupBuyingCategory] c ON M.GroupBuyingCategorySysNo=c.SysNo
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber

SELECT gp.ProductGroupBuyingSysNo,gp.SellCount,gp.GroupBuyingPrice
FROM #TempTable T
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying_Price gp WITH(NOLOCK)
ON T.SysNo=gp.ProductGroupBuyingSysNo
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber
ORDER BY gp.ProductGroupBuyingSysNo ASC,gp.SellCount ASC
    ]]>
    </commandText>
  </dataCommand>
  <!--加载团购-->
  <dataCommand name="GetProductGroupBuyingEntity" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT M.SysNo
  ,M.ProductSysNo
  ,P.ProductID
  ,M.GroupBuyingTitle
  ,M.GroupBuyingRules
  ,M.GroupBuyingDesc
  ,M.GroupBuyingPicUrl
  ,M.GroupBuyingMiddlePicUrl
  ,M.GroupBuyingSmallPicUrl
  ,M.BeginDate
  ,M.EndDate
  ,case M.IsByGroup when 'Y' then 1
  else 0 end AS IsByGroup
  ,M.MaxPerOrder
  ,ISNULL(SnapShotPrice.SnapShotCurrentPrice,M.OriginalPrice) as OriginalPrice
  ,M.DealPrice [GBPrice]
  ,M.CurrentSellCount
  ,M.IsSettlement [SettlementStatus]
  ,M.GroupBuyingTypeSysNo
  ,M.GroupBuyingAreaSysNo
  ,M.LimitOrderCount
  ,M.CurrencySysNo
  ,M.Status
  ,M.Reasons
  ,M.Priority
  ,M.InDate
  ,M.InUser
  ,M.CompanyCode
  ,M.[SuccessDate] 
  ,MEX.GroupBuyingDescLong
  ,M.VendorSysNo
  ,M.RequestSysNo
  ,V.VendorName
  ,c.CategoryType AS GroupBuyingCategoryType
  ,M.CouponValidDate
  ,M.LotteryRule
  ,M.GroupBuyingCategorySysNo
  ,M.IsWithoutReservation
  ,M.IsVouchers
FROM OverseaContentManagement.dbo.ProductGroupBuying M WITH(NOLOCK)
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying_Ex MEX WITH(NOLOCK) ON M.SysNo = MEX.ProductGroupBuyingSysNo
LEFT JOIN IPP3.dbo.Product P WITH(NOLOCK) ON M.ProductSysNo = P.SysNo
LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList V on V.SysNo=M.VendorSysNo
LEFT JOIN OverseaContentManagement.dbo.GroupBuyingCategory c WITH(NOLOCK)
  ON c.SysNo=M.GroupBuyingCategorySysNo
LEFT JOIN OverseaContentManagement.dbo.ProductGroupBuying_SnapShotPrice(NOLOCK) SnapShotPrice
                  ON M.SysNo = SnapShotPrice.ProductGroupBuyingSysNo
WHERE  M.SysNo = @SysNo

SELECT gp.SysNo,gp.SellCount,gp.GroupBuyingPrice,gp.GroupBuyingPoint,gp.CostAmt
FROM OverseaContentManagement.dbo.ProductGroupBuying_Price gp WITH(NOLOCK)
WHERE gp.ProductGroupBuyingSysNo=@SysNo
ORDER BY gp.SellCount ASC
         ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductGroupBuyingPriceByProductSysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT  gp.SysNo,
        gp.ProductGroupBuyingSysNo,
        gp.SellCount,
        gp.GroupBuyingPrice,
        gp.GroupBuyingPoint
FROM OverseaContentManagement.dbo.ProductGroupBuying_Price gp WITH(NOLOCK)
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying M ON M.SysNo = gp.ProductGroupBuyingSysNo
WHERE M.ProductSysNo = @ProductSysNo AND M.Status = @Status
ORDER BY gp.SellCount ASC
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Status" dbType="String"/>
    </parameters>
  </dataCommand>
  
  <!--创建团购-->
  <dataCommand name="CreateProductGroupBuying" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
        INSERT INTO OverseaContentManagement.dbo.ProductGroupBuying
                   (ProductSysNo
                   ,GroupBuyingTitle
                   ,GroupBuyingRules
                   ,GroupBuyingDesc
                   ,GroupBuyingPicUrl
                   ,GroupBuyingMiddlePicUrl
                   ,GroupBuyingSmallPicUrl
                   ,BeginDate
                   ,EndDate
                   ,IsByGroup
                   ,MaxPerOrder
                   ,OriginalPrice
                   ,DealPrice
                   ,CurrentSellCount
                   ,IsSettlement
                   ,GroupBuyingAreaSysNo
                   ,GroupBuyingTypeSysNo
                   ,LimitOrderCount
                   ,CurrencySysNo
                   ,Status
                   ,Reasons
                   ,Priority
                   ,InDate
                   ,InUser
                   ,CompanyCode
                   ,StoreCompanyCode
                   ,LanguageCode
                   ,VendorSysNo
                   ,CouponValidDate
                   ,LotteryRule
                   ,GroupBuyingCategorySysNo
                   ,IsWithoutReservation
                   ,IsVouchers)
             VALUES
                   (@ProductSysNo
                   ,@GroupBuyingTitle
                   ,@GroupBuyingRules                   
                   ,@GroupBuyingDesc
                   ,@GroupBuyingPicUrl
                   ,@GroupBuyingMiddlePicUrl
                   ,@GroupBuyingSmallPicUrl
                   ,@BeginDate
                   ,@EndDate
                   ,@IsByGroup
                   ,@MaxPerOrder
                   ,@OriginalPrice
                   ,@DealPrice
                   ,@CurrentSellCount
                   ,@SettlementStatus
                   ,@GroupBuyingAreaSysNo
                   ,@GroupBuyingTypeSysNo                   
                   ,@LimitOrderCount
                   ,@CurrencySysNo
                   ,@Status
                   ,@Reasons
                   ,@Priority
                   ,GetDate()
                   ,@InUser
                   ,@CompanyCode
                   ,@StoreCompanyCode
                   ,@LanguageCode
                   ,@VendorSysNo
                   ,@CouponValidDate
                   ,@LotteryRule
                   ,@GroupBuyingCategorySysNo
                   ,@IsWithoutReservation
                   ,@IsVouchers
                   )
                   
         SELECT @SysNo = SCOPE_IDENTITY();
         
         INSERT INTO OverseaContentManagement.dbo.ProductGroupBuying_Ex
                  (ProductGroupBuyingSysNo                 
                  ,GroupBuyingDescLong)
             VALUES(@SysNo
                  , @GroupBuyingDescLong)
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@GroupBuyingTitle" dbType="String"/>
      <param name="@GroupBuyingDesc" dbType="String"/>
      <param name="@GroupBuyingRules" dbType="String"/>
      <param name="@GroupBuyingDescLong" dbType="String"/>
      <param name="@GroupBuyingPicUrl" dbType="String"/>
      <param name="@GroupBuyingMiddlePicUrl" dbType="String"/>
      <param name="@GroupBuyingSmallPicUrl" dbType="String"/>
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
      <param name="@IsByGroup" dbType="String"/>
      <param name="@MaxPerOrder" dbType="Int32"/>
      <param name="@OriginalPrice" dbType="Decimal"/>
      <param name="@DealPrice" dbType="Decimal"/>
      <param name="@CurrentSellCount" dbType="Int32"/>
      <param name="@SettlementStatus" dbType="String"/>      
      <param name="@LimitOrderCount" dbType="Int32"/>
      <param name="@CurrencySysNo" dbType="Int32"/>
      <param name="@Reasons" dbType="String"/>
      <param name="@Priority" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
      <param name="@Status" dbType="AnsiStringFixedLength" size="1"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50" />
      <param name="@StoreCompanyCode" dbType="String"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@SysNo" dbType="Int32" size="10" direction="Output"/>
      <param name="@GroupBuyingAreaSysNo" dbType="Int32"/>
      <param name="@GroupBuyingTypeSysNo" dbType="Int32"/>
      <param name="@VendorSysNo" dbType="String"/>
      <param name="@CouponValidDate" dbType="DateTime"/>
      <param name="@LotteryRule" dbType="String"/>
      <param name="@GroupBuyingCategorySysNo" dbType="Int32"/>      
      <param name="@IsWithoutReservation" dbType="Int32"/>      
      <param name="@IsVouchers" dbType="Int32"/>      
    </parameters>
  </dataCommand>
  <!--创建团购阶梯价格-->
  <dataCommand name="CreateProductGroupBuyingPrice" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO OverseaContentManagement.dbo.ProductGroupBuying_Price
       (ProductGroupBuyingSysNo
       ,SellCount
       ,GroupBuyingPrice
       ,GroupBuyingPoint
       ,CostAmt)
VALUES
       (@ProductGroupBuyingSysNo
       ,@SellCount
       ,@GroupBuyingPrice
       ,ISNULL(@GroupBuyingPoint,0)
       ,@CostAmt)	  
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductGroupBuyingSysNo" dbType="Int32" />
      <param name="@SellCount" dbType="Int32" />
      <param name="@GroupBuyingPrice" dbType="Decimal" />
      <param name="@CostAmt" dbType="Decimal" />
      <param name="@GroupBuyingPoint" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="DeleteProductGroupBuyingPrice" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
        DELETE FROM [OverseaContentManagement].[dbo].ProductGroupBuying_Price
        WHERE ProductGroupBuyingSysNo=@ProductGroupBuyingSysNo
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductGroupBuyingSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <!--更新团购-->
  <dataCommand name="UpdateProductGroupBuying" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
           UPDATE OverseaContentManagement.dbo.ProductGroupBuying
           SET                  
              ProductSysNo            = @ProductSysNo
             ,GroupBuyingTitle        = @GroupBuyingTitle
             ,GroupBuyingDesc         = @GroupBuyingDesc
             ,GroupBuyingRules        = @GroupBuyingRules
             ,GroupBuyingPicUrl       = @GroupBuyingPicUrl
             ,GroupBuyingMiddlePicUrl = @GroupBuyingMiddlePicUrl
             ,GroupBuyingSmallPicUrl  = @GroupBuyingSmallPicUrl
             ,BeginDate               = @BeginDate
             ,EndDate                 = @EndDate
             ,IsByGroup               = @IsByGroup
             ,MaxPerOrder             = @MaxPerOrder             
             ,LimitOrderCount         = @LimitOrderCount
             ,Reasons                 = @Reasons
             ,Priority                = @Priority
             ,EditDate                = GetDate()
             ,EditUser                = @EditUser
             ,GroupBuyingAreaSysNo    = @GroupBuyingAreaSysNo
             ,GroupBuyingTypeSysNo    = @GroupBuyingTypeSysNo
             ,VendorSysNo             = @VendorSysNo
             ,CouponValidDate         = @CouponValidDate
             ,LotteryRule             = @LotteryRule
             ,GroupBuyingCategorySysNo= @GroupBuyingCategorySysNo
             ,IsWithoutReservation    = @IsWithoutReservation
             ,IsVouchers              = @IsVouchers
            WHERE SysNo= @SysNo 
              AND CompanyCode=@CompanyCode
              
           UPDATE OverseaContentManagement.dbo.ProductGroupBuying_Ex
           SET                  
              GroupBuyingDescLong     = @GroupBuyingDescLong
            WHERE ProductGroupBuyingSysNo = @SysNo 
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@GroupBuyingRules" dbType="String"/>
      <param name="@GroupBuyingTitle" dbType="String"/>
      <param name="@GroupBuyingDesc" dbType="String"/>
      <param name="@GroupBuyingDescLong" dbType="String"/>
      <param name="@GroupBuyingPicUrl" dbType="String"/>
      <param name="@GroupBuyingMiddlePicUrl" dbType="String"/>
      <param name="@GroupBuyingSmallPicUrl" dbType="String"/>
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
      <param name="@IsByGroup" dbType="String"/>
      <param name="@MaxPerOrder" dbType="Int32"/>      
      <param name="@LimitOrderCount" dbType="Int32"/>
      <param name="@Reasons" dbType="String"/>
      <param name="@Priority" dbType="Int32"/>
      <param name="@EditUser" dbType="String"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50" />
      <param name="@GroupBuyingAreaSysNo" dbType="Int32"/>
      <param name="@GroupBuyingTypeSysNo" dbType="Int32"/>
      <param name="@VendorSysNo" dbType="String"/>
      <param name="@CouponValidDate" dbType="DateTime"/>
      <param name="@LotteryRule" dbType="String"/>
      <param name="@GroupBuyingCategorySysNo" dbType="Int32"/>
      <param name="@IsWithoutReservation" dbType="Int32"/>      
      <param name="@IsVouchers" dbType="Int32"/>     
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateProductGroupBuyingStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE OverseaContentManagement.dbo.ProductGroupBuying
          SET 
                Status = @Status,
                Reasons = @Reasons,
                AuditDate = Getdate(),
                AuditUser = @AuditUser
           WHERE SysNo=@SysNo
         ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" size="1"/>
      <param name="@Reasons" dbType="String" size="300"/>
      <param name="@AuditUser" dbType="String"/>
    </parameters>
  </dataCommand>
  
  <!--验证商品是否在时间段内有团购活动，要注意组(商品组相关的概念)团购这种情况-->
  <dataCommand name="CheckProductInGBByDateTime" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[     
              SELECT COUNT(1) FROM
              OverseaContentManagement.dbo.ProductGroupBuying GB WITH(NOLOCK)  
        WHERE
              (GB.BeginDate BETWEEN @BeginDate AND @EndDate OR
               GB.EndDate BETWEEN @BeginDate AND @EndDate OR
               @BeginDate BETWEEN GB.BeginDate AND GB.EndDate OR
               @EndDate BETWEEN GB.BeginDate AND GB.EndDate) 
          AND GB.Status NOT IN ('F','D') 
          AND GB.ProductSysno in (#ProductSysNos#)
          AND GB.SysNo != @ExcludeSysNo
       
         ]]>
    </commandText>
    <parameters>
      <param name="@ExcludeSysNo" dbType="Int32" />
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
    </parameters>
  </dataCommand>
  <!--更新团购状态-->
  <dataCommand name="UpdateGroupBuyStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
        UPDATE OverseaContentManagement.dbo.ProductGroupBuying
        SET [status]=@Status 
           ,EditUser = @EditUser
           ,EditDate = Getdate()
        WHERE  SysNo = @SysNo
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--更新团购结束时间为当前时间，用于中止团购-->
  <dataCommand name="UpdateGroupBuyingEndDate" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE OverseaContentManagement.dbo.ProductGroupBuying
          SET EndDate = GETDATE()
              ,EditUser = @EditUser
              ,EditDate = Getdate()
           WHERE SysNo=@SysNo 
         ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>
  
  <!--根据商品编号获取正在进行的团购的商品编号-->
  <dataCommand name="ProductsOnGroupBuying" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
         SELECT sp.ProductSysNo
          FROM OverseaContentManagement.dbo.ProductGroupBuying gb WITH(NOLOCK)
          LEFT JOIN OverseaContentManagement.dbo.ProductGroupBuying_SnapShotPrice sp WITH(NOLOCK)
          ON gb.SysNo=sp.ProductGroupBuyingSysNo
          WHERE 
          sp.ProductSysNo IN (#ProductsStr#)
          AND (gb.Status='P' OR gb.Status='A' OR (gb.Status='F' AND  gb.SuccessDate IS NOT NULL AND gb.IsSettlement='N'))
        ]]>
    </commandText>
  </dataCommand>

  <!--同步Seller Portal团购状态-->
  <dataCommand name="SyncGroupBuyingStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
          IF(@Status = 'N')
			    BEGIN
				    SET @Status = 'R'
			    END
			    ELSE IF(@Status = 'D')
			    BEGIN
				    SET @Status = 'V'
			    END
          exec [OverseaContentManagement].[dbo].[UP_SP_GroupBuyingReply] @RequestSysNo=@RequestSysNo,@Status=@Status,@Reason=@Reasons,@ReplyType=@ReplyType
      ]]>
    </commandText>
    <parameters>
      <param name="@RequestSysNo" dbType="Int32" />
      <param name="@Reasons" dbType="String" size="300" />
      <param name="@Status" dbType="String" size="1" />
      <param name="@ReplyType" dbType="String" size="100" />
    </parameters>
  </dataCommand>

  <!--取得需要处理的团购-->
  <dataCommand name="GetGroupBuyNeedProcess" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
            SELECT 
                [SysNo] 
               ,[ProductSysNo] 
               ,[GroupBuyingTitle] [GroupBuyingTitle.Content]
               ,[GroupBuyingDesc] [GroupBuyingDesc.Content] 
               ,[GroupBuyingPicUrl] [GroupBuyingPicUrl.Content]
               ,[GroupBuyingSmallPicUrl]  [GroupBuyingSmallPicUrl.Content] 
               ,[BeginDate] 
               ,[EndDate] 
               ,case [IsByGroup] when 'Y' then 1 else 0 END AS IsByGroup
               ,[MaxPerOrder] [MaxCountPerOrder]
               ,[SuccessDate] 
               ,[OriginalPrice] 
               ,[DealPrice]  [GBPrice]
               ,[CurrentSellCount] 
               ,[IsSettlement]  [SettlementStatus]
               ,[GroupBuyingTypeSysNo] 
               ,[LimitOrderCount] 
               ,[CurrencySysNo] 
               ,[Status] 
               ,[Reasons] 
               ,[Priority] 
               ,[InDate] 
               ,[InUser] 
               ,[EditDate] 
               ,[EditUser] 
               ,[AuditDate] 
               ,[AuditUser]  
            FROM [OverseaContentManagement].[dbo].[ProductGroupBuying] WITH(NOLOCK) 
            WHERE 
                (
                  (Status='F' AND IsSettlement='N' AND DATEADD(Minute,2,EndDate)< Getdate())
                  OR IsSettlement='C'
                )
                AND( CompanyCode=@CompanyCode OR @CompanyCode IS NULL)
        ]]>
    </commandText>
    <parameters>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <!--修改团购处理状态-->
  <dataCommand name="ChangeGroupBuySettlement" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[    UPDATE OverseaContentManagement.dbo.ProductGroupBuying
    SET    IsSettlement = @SettlementStatus
    WHERE  SysNo = @SysNo 
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@SettlementStatus" dbType="AnsiStringFixedLength" size="1"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductOriginalPrice" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
        DECLARE @Price DECIMAL(19,6)
        DECLARE @BasicPrice DECIMAL(19,6)
        DECLARE @ProductDescLong NVARCHAR(MAX)
        DECLARE @VendorSysNo INT
        DECLARE @VendorName NVARCHAR(200)
        
        SET @Price = 0
        
        SELECT TOP 1 
               @ProductDescLong = PD.ProductDescLong 
              ,@VendorName = isnull(v.VendorName,v.EnglishName)
              ,@VendorSysNo = v.SysNo
              ,@Price=ISNULL(PP.CurrentPrice,0)
              ,@BasicPrice = ISNULL(PP.BasicPrice,0)
          FROM IPP3.dbo.Product PD WITH(NOLOCK)
          INNER JOIN OverseaContentManagement.dbo.V_IM_Product_Price PP WITH(NOLOCK) ON PP.ProductSysNo = PD.SysNo 
          INNER JOIN OverseaPOASNManagement.dbo.V_PM_VendorList v ON pd.MerchantSysNo=v.SysNo
          WHERE PD.SysNo = @ProductSysNo
             
        IF(@IsByGroup = 'Y')
        BEGIN
        
          DECLARE @ProductGroupSysno INT
          
          SELECT @ProductGroupSysno = b.ProductGroupSysno 
          FROM IPP3.dbo.Product a WITH(NOLOCK) 
          INNER JOIN OverseaContentManagement.dbo.V_IM_ProductCommonInfo b WITH(NOLOCK)
          ON a.ProductCommonInfoSysno = b.SysNo
          WHERE a.SysNo = @ProductSysNo
          
        
          SELECT 
                  @Price=ISNULL(MIN(PP.CurrentPrice),0)
                 ,@BasicPrice = ISNULL(MAX(PP.BasicPrice),0)
              FROM OverseaContentManagement.dbo.V_IM_Product_Price PP WITH(NOLOCK) 
              INNER JOIN IPP3.dbo.Product PD WITH(NOLOCK) ON PP.ProductSysNo = PD.SysNo 
              INNER JOIN OverseaContentManagement.dbo.V_IM_ProductCommonInfo PC WITH(NOLOCK)
                  ON PD.ProductCommonInfoSysno = PC.SysNo AND PC.CompanyCode = @CompanyCode  
              WHERE 
                  PC.ProductGroupSysno = @ProductGroupSysno
        
        END
        

        --SELECT CASE WHEN @BasicPrice > @Price THEN @BasicPrice ELSE @Price END, @BasicPrice, @ProductDescLong, @VendorSysNo, @VendorName
        SELECT CASE WHEN @BasicPrice > @Price THEN @BasicPrice ELSE @Price END, @BasicPrice

			 ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@IsByGroup" dbType="String" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetProductGroupBuyingAreas" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[			
    SELECT [SysNo]
      ,[ProductGroupBuyingAreaName] as [Name]
      ,[Priority]
    FROM [OverseaContentManagement].[dbo].[ProductGroupBuying_Area] with(nolock) Order by Priority
         ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetProductGroupBuyingTypes" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[			
    SELECT [SysNo]
      ,[ProductGroupBuyingTypeName] as [Name]
      ,[Priority]
    FROM [OverseaContentManagement].[dbo].[ProductGroupBuying_Type] with(nolock) Order by Priority
         ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GetGroupBuyingVendorList" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
          SELECT SysNo
                  ,VendorName 
          FROM OverseaPOASNManagement.dbo.V_PM_VendorList with(nolock) WHERE SysNo IN (
                SELECT VendorSysNo 
                  FROM OverseaContentManagement.dbo.ProductGroupBuying pgb with(nolock)
                GROUP BY VendorSysNo
          )
         ]]>
    </commandText>
  </dataCommand>
  
  
  <!--Job相关-->
  <dataCommand name="GetGroupBuyingList" database="OverseaECommerceManagement" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT      a.SysNo
                   ,a.ProductSysNo
                   ,b.ProductID
                   ,a.GroupBuyingTitle
                   ,a.GroupBuyingDesc
                   ,a.GroupBuyingPicUrl
                   ,a.GroupBuyingSmallPicUrl
                   ,a.BeginDate
                   ,a.EndDate
                   ,a.IsByGroup
                   ,a.MaxPerOrder
                   ,a.SuccessDate
                   ,a.OriginalPrice
                   ,a.DealPrice
                   ,a.CurrentSellCount
                   ,a.IsSettlement
                   ,a.GroupBuyingTypeSysNo
                   ,a.LimitOrderCount
                   ,a.CurrencySysNo
                   ,a.Status
                   ,a.Reasons
                   ,a.Priority
                   ,a.InDate
                   ,a.InUser
                   ,a.RequestSysNo
            FROM   OverseaContentManagement.dbo.ProductGroupBuying a WITH(NOLOCK) LEFT JOIN
                   IPP3.dbo.V_IM_Product b WITH(NOLOCK) ON a.ProductSysNo = b.SysNo AND b.CompanyCode =@CompanyCode
          WHERE  (a.SysNo = @GroupBuyingSysNo OR @GroupBuyingSysNo = 0)  AND a.CompanyCode =@CompanyCode
                  AND a.Status IN ('P','A')
         ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50" />
    </parameters>
  </dataCommand>

  <dataCommand name="CreateGroupBuyingCategory" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO [OverseaContentManagement].[dbo].[GroupBuyingCategory]
           ([Name]
           ,[CategoryType]
           ,[Status]           
           ,[CreateDate]
           ,[CreateUser]
           ,[CompanyCode]
           ,[StoreCompanyCode]
           ,[LanguageCode]
           ,[IsHotKey]
           )
     VALUES
           (@Name
           ,@CategoryType
           ,@Status    
           ,GETDATE()
           ,@CreateUser
           ,@CompanyCode
           ,@StoreCompanyCode
           ,'zh-CN'
           ,@IsHotKey
          )
        
        SELECT @SysNo = SCOPE_IDENTITY()
      ]]>
    </commandText>
    <parameters>
      <param name="@Name" dbType="String" />
      <param name="@CategoryType" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />     
      <param name="@CreateUser" dbType="String"  property="[UserAcct]"/>
      <param name="@CompanyCode" dbType="String" />
      <param name="@StoreCompanyCode" dbType="String" property="CompanyCode"/>
      <!--<param name="@LanguageCode" dbType="String" />-->
      <param name="@SysNo" dbType="Int32" size="10" direction="Output"/>
      <param name="@IsHotKey" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateGroupBuyingCategory" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
UPDATE [OverseaContentManagement].[dbo].[GroupBuyingCategory] SET
  Name=@Name,
  CategoryType=@CategoryType,
  Status=@Status,
  EditDate=GETDATE(),
  EditUser=@EditUser,
  IsHotKey=@IsHotKey
WHERE SysNo=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Name" dbType="String" />
      <param name="@CategoryType" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@EditUser" dbType="String"  property="[UserAcct]"/>
      <param name="@IsHotKey" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GetAllGroupBuyingCategory" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
  SysNo
  ,Name
  ,CategoryType
  ,Status
  ,CreateUser
  ,CreateDate
  ,EditUser
  ,EditDate
  ,IsHotKey
FROM [OverseaContentManagement].[dbo].[GroupBuyingCategory] WITH(NOLOCK)
--WHERE Status='A'
      ]]>
    </commandText>   
  </dataCommand>

  <dataCommand name="GetGroupBuyingCategoryBySysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
  SysNo
  ,Name
  ,CategoryType
  ,Status
  ,CreateUser
  ,CreateDate
  ,EditUser
  ,EditDate
  ,IsHotKey
FROM [OverseaContentManagement].[dbo].[GroupBuyingCategory] WITH(NOLOCK)
WHERE SysNo=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />     
    </parameters>
  </dataCommand>
  
  <dataCommand name="CheckGroupBuyingCategoryNameExists" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT COUNT(1) FROM OverseaContentManagement.dbo.GroupBuyingCategory 
WHERE Name=@CategoryName 
  AND SysNo != @ExcludeSysNo
  AND CategoryType=@CategoryType
	  ]]>
    </commandText>
    <parameters>
      <param name="@ExcludeSysNo" dbType="Int32"/>
      <param name="@CategoryName" dbType="String"/>
      <param name="@CategoryType" dbType="Int32"/>
    </parameters>
  </dataCommand>

<dataCommand name="CreateGroupBuyingActivityRel" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
IF NOT EXISTS(
	SELECT TOP 1 SysNo
	FROM OverseaContentManagement.dbo.GroupBuyingActivityRel
	WHERE GroupBuyingSysNo=@GroupBuyingSysNo
		AND VendorStoreSysNo=@VendorStoreSysNo
)
BEGIN
	INSERT INTO OverseaContentManagement.dbo.GroupBuyingActivityRel
	(
		GroupBuyingSysNo,
		VendorStoreSysNO,
		CreateUser,
		CreateDate,
		CompanyCode,
		StoreCompanyCode,
		LanguageCode
	)
	VALUES
	(
		@GroupBuyingSysNo,
		@VendorStoreSysNO,
		@CreateUser,
		GETDATE(),
		'8601',
		'8601',
		'zh-CN'
	)
END
	  ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32"/>
      <param name="@VendorStoreSysNo" dbType="Int32"/>
      <param name="@CreateUser" dbType="String"/>
    </parameters>
  </dataCommand>

<dataCommand name="DeleteGroupBuyingActivityRel" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	DELETE FROM OverseaContentManagement.dbo.GroupBuyingActivityRel
	WHERE GroupBuyingSysNo=@GroupBuyingSysNo		
	  ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32"/>    
    </parameters>
  </dataCommand>

<dataCommand name="GetGroupBuyingVendorStores" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	SELECT
    VendorStoreSysNo
  FROM OverseaContentManagement.dbo.GroupBuyingActivityRel
	WHERE GroupBuyingSysNo=@GroupBuyingSysNo		
	  ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32"/>    
    </parameters>
  </dataCommand>

  <dataCommand name="QueryGroupBuyingFeedback" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
	@TotalCount=COUNT(1)
FROM OverseaContentManagement.dbo.GroupBuyingFeedback WITH(NOLOCK)
#StrWhere#

;WITH TempTable AS (
SELECT
 m.[SysNo]
,ROW_NUMBER() OVER(ORDER BY  #SortColumnName#) AS RowNumber
FROM OverseaContentManagement.dbo.GroupBuyingFeedback m WITH(NOLOCK)
#StrWhere#
)

SELECT  
	m.SysNo,
	m.Content,
	m.ContactWay,
	m.Status,
	m.Type,
	m.CustomerSysNo,
	c.CustomerName,
	m.CreateUser,
	m.CreateDate,
	m.EditUser,
	m.EditDate
FROM TempTable T
INNER JOIN OverseaContentManagement.dbo.GroupBuyingFeedback m WITH(NOLOCK)
	ON t.SysNo=m.SysNo
INNER JOIN IPP3.dbo.Customer c WITH(NOLOCK)
	ON m.CustomerSysNo=c.SysNo
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber
ORDER BY T.RowNumber ASC
	  ]]>
    </commandText>   
  </dataCommand>

  <dataCommand name="ReadGroupbuyingFeedback" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	UPDATE 	OverseaContentManagement.dbo.GroupBuyingFeedback SET
  Status = 1,
  EditDate=GETDATE(),
  EditUser=@EditUser
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>
  
  <dataCommand name="QueryBusinessCooperation" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
	@TotalCount=COUNT(1)
FROM OverseaContentManagement.dbo.GroupBuyingBusinessCooperation m WITH(NOLOCK)
INNER JOIN IPP3.dbo.Area a WITH(NOLOCK)
  ON m.AreaSysNo=a.SysNo
#StrWhere#

;WITH TempTable AS (
SELECT
 m.[SysNo]
,ROW_NUMBER() OVER(ORDER BY  #SortColumnName#) AS RowNumber
FROM OverseaContentManagement.dbo.GroupBuyingBusinessCooperation m WITH(NOLOCK)
INNER JOIN IPP3.dbo.Area a WITH(NOLOCK)
  ON m.AreaSysNo=a.SysNo
#StrWhere#
)

SELECT  
	m.SysNo,
	m.ContactName,
	m.ContactTel,
  m.OtherContact,
  m.AreaSysNo,
  m.Address,
  m.VendorName,  
	m.Status,
	m.Type,
  m.Content,		
	m.CreateUser,
	m.CreateDate,
	m.EditUser,
	m.EditDate,
  a.ProvinceName,
  a.CityName,
  a.DistrictName  
FROM TempTable T
INNER JOIN OverseaContentManagement.dbo.GroupBuyingBusinessCooperation m WITH(NOLOCK)
	ON t.SysNo=m.SysNo
INNER JOIN IPP3.dbo.Area a WITH(NOLOCK)
  ON m.AreaSysNo=a.SysNo
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber
ORDER BY T.RowNumber ASC
	  ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryGroupBuyingSettlement" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
	@TotalCount=COUNT(1)
FROM OverseaContentManagement.dbo.GroupBuyingSettlement m WITH(NOLOCK)
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
  LEFT JOIN IPP3.dbo.Finance_Pay FP WITH(NOLOCK)       
ON FP.OrderType=14 AND FP.OrderSysNo = m.SysNo 
LEFT JOIN IPP3.dbo.Finance_Pay_Item FPM WITH(NOLOCK)
ON FPM.OrderType=14 AND FPM.PaySysNo = FP.SysNo 
#StrWhere#

;WITH TempTable AS (
SELECT
 m.[SysNo]
 ,FPM.Status
 ,FPM.PayTime
,ROW_NUMBER() OVER(ORDER BY  #SortColumnName#) AS RowNumber
FROM OverseaContentManagement.dbo.GroupBuyingSettlement m WITH(NOLOCK)
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
 LEFT JOIN IPP3.dbo.Finance_Pay FP WITH(NOLOCK)       
ON FP.OrderType=14 AND FP.OrderSysNo = m.SysNo 
LEFT JOIN IPP3.dbo.Finance_Pay_Item FPM WITH(NOLOCK)
ON FPM.OrderType=14 AND FPM.PaySysNo = FP.SysNo 
#StrWhere#
)

SELECT  
	m.SysNo,
	m.AuditDate,
  m.AuditUser,	
  m.SettleAmt,
  m.Status,
  m.VendorSysNo,
  v.VendorName,
  m.BeginDate,
  m.EndDate, 
	m.CreateUser,
	m.CreateDate,
	m.EditUser,
	m.EditDate,
  m.CompanyCode,
  pt.PayTermsName,
  T.[Status] AS PayItemStatus,
  T.PayTime
FROM TempTable T
INNER JOIN OverseaContentManagement.dbo.GroupBuyingSettlement m WITH(NOLOCK)
	ON t.SysNo=m.SysNo
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
LEFT JOIN OverseaInvoiceReceiptManagement.dbo.VendorPayTerms pt WITH(NOLOCK)
  ON pt.PayTermsNo = V.PayPeriodType
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber
ORDER BY T.RowNumber ASC
	  ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="QueryGroupBuyingTicket" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
	@TotalCount=COUNT(1)
FROM OverseaContentManagement.dbo.GroupBuyingTicket m WITH(NOLOCK)
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying g WITH(NOLOCK)
  ON m.GroupBuyingSysNo=g.SysNo
INNER JOIN IPP3.dbo.Product p WITH(NOLOCK)
  ON g.ProductSysNo=p.SysNo
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
INNER JOIN IPP3.dbo.Customer c WITH(NOLOCK)
  ON m.CustomerSysNo=c.SysNo
LEFT JOIN IPP3.dbo.Vendor_Store s WITH(NOLOCK)
  ON m.UsedStoreSysNo=s.SysNo

#StrWhere#

;WITH TempTable AS (
SELECT
 m.[SysNo]
,ROW_NUMBER() OVER(ORDER BY  #SortColumnName#) AS RowNumber
FROM OverseaContentManagement.dbo.GroupBuyingTicket m WITH(NOLOCK)
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying g WITH(NOLOCK)
  ON m.GroupBuyingSysNo=g.SysNo
INNER JOIN IPP3.dbo.Product p WITH(NOLOCK)
  ON g.ProductSysNo=p.SysNo
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
INNER JOIN IPP3.dbo.Customer c WITH(NOLOCK)
  ON m.CustomerSysNo=c.SysNo
LEFT JOIN IPP3.dbo.Vendor_Store s WITH(NOLOCK)
  ON m.UsedStoreSysNo=s.SysNo
#StrWhere#
)

SELECT  
	m.SysNo,
	m.GroupBuyingSysNo,
	m.TicketID,  
  m.TicketAmt,
  m.Status,
  m.RefundStatus,
  m.RefundMemo,  
  m.AvailableDate,
  m.Tel,
  m.UsedStoreSysNo,
  m.UsedDate,
  m.CustomerSysNo,
  m.VendorSysNo, 
  m.RefundDate,
  m.RefundUser,
	m.CreateUser,
	m.CreateDate,
	m.EditUser,
	m.EditDate,
  m.CompanyCode,
  m.OrderSysNo,
  v.VendorName,
  s.Name as [VendorStoreName],
  p.ProductName,
  c.CustomerName,
  g.GroupBuyingTitle
FROM TempTable T
INNER JOIN OverseaContentManagement.dbo.GroupBuyingTicket m WITH(NOLOCK)
	ON t.SysNo=m.SysNo
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying g WITH(NOLOCK)
  ON m.GroupBuyingSysNo=g.SysNo
INNER JOIN IPP3.dbo.Product p WITH(NOLOCK)
  ON g.ProductSysNo=p.SysNo
INNER JOIN IPP3.dbo.Vendor v WITH(NOLOCK)
  ON m.VendorSysNo=v.SysNo
INNER JOIN IPP3.dbo.Customer c WITH(NOLOCK)
  ON m.CustomerSysNo=c.SysNo
LEFT JOIN IPP3.dbo.Vendor_Store s WITH(NOLOCK)
  ON m.UsedStoreSysNo=s.SysNo
WHERE T.RowNumber > @StartNumber and T.RowNumber <= @EndNumber
ORDER BY T.RowNumber ASC
	  ]]>
    </commandText>
  </dataCommand>
  
  <dataCommand name="HandleGroupbuyingBusinessCooperation" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	UPDATE 	OverseaContentManagement.dbo.GroupBuyingBusinessCooperation SET
  Status = 1,
  EditDate=GETDATE(),
  EditUser=@EditUser
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="LoadGroupBuyingSettlementBySysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	SELECT
    SysNo,
    AuditDate,
    AuditUser,    
    SettleAmt,
    Status,
    VendorSysNo,
    BeginDate,
    EndDate,    
    CreateUser,
    CreateDate,
    EditUser,
    EditDate,
    CompanyCode,
    EditUserName=(select username from ipp3.dbo.sys_user where userid=EditUser)
  FROM OverseaContentManagement.dbo.GroupBuyingSettlement WITH(NOLOCK)
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>      
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateGroupBuyingSettlementStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	UPDATE OverseaContentManagement.dbo.GroupBuyingSettlement SET
    Status=@Status,
    EditUser=@EditUser,
    EditDate=GETDATE()
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="LoadGroupBuyingSettlementItemBySettleSysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
      
      ;WITH TempTable AS (
      SELECT i.SysNo AS SysNo, COUNT(*) AS TCount,AVG(m.CostAmt) AS CostAmt
      FROM OverseaContentManagement.dbo.GroupBuyingTicket m
      INNER JOIN OverseaContentManagement.dbo.GroupBuyingTicketToAcc t WITH(NOLOCK)
	      ON m.SysNo=t.GroupBuyingTicketSysNo
      INNER JOIN OverseaContentManagement.dbo.GroupBuyingSettlementItem i WITH(NOLOCK)
	      ON i.SysNo=t.SettlementItemSysNo GROUP BY i.SysNo
      )
SELECT	  
    i.SysNo,   
    i.SettleAmt,
    i.SettlementSysNo,
    i.GroupBuyingSysNo,    
    p.ProductName,    
    g.GroupBuyingTitle,
    t.TCount,
	  t.CostAmt
FROM OverseaContentManagement.dbo.GroupBuyingSettlement m WITH(NOLOCK)
INNER JOIN OverseaContentManagement.dbo.GroupBuyingSettlementItem i WITH(NOLOCK)
	ON m.SysNo = i.SettlementSysNo
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying g WITH(NOLOCK)
	ON i.GroupBuyingSysNo=g.SysNo
INNER JOIN IPP3.dbo.Product p WITH(NOLOCK)
	ON g.ProductSysNo=p.SysNo
  LEFT JOIN TempTable t ON i.SysNo=t.SysNo
WHERE m.SysNo=@SettlementSysNo	  ]]>
    </commandText>
    <parameters>
      <param name="@SettlementSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="LoadTicketByGroupBuyingSysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT  
	m.SysNo,
	m.GroupBuyingSysNo,
  m.OrderSysNo,
	m.TicketID,  
  m.TicketAmt,
  m.Status,
  m.RefundStatus,
  m.RefundMemo,  
  m.AvailableDate,
  m.Tel,  
  m.UsedStoreSysNo,
  m.UsedDate,
  m.CustomerSysNo,
  m.VendorSysNo, 
  m.RefundDate,
  m.RefundUser,  
  m.PayType,
  m.CostAmt,
	m.CreateUser,
	m.CreateDate,
	m.EditUser,
	m.EditDate,
  m.CompanyCode
FROM OverseaContentManagement.dbo.GroupBuyingTicket m
INNER JOIN OverseaContentManagement.dbo.GroupBuyingTicketToAcc t WITH(NOLOCK)
	ON m.SysNo=t.GroupBuyingTicketSysNo
INNER JOIN OverseaContentManagement.dbo.GroupBuyingSettlementItem i WITH(NOLOCK)
	ON i.SysNo=t.SettlementItemSysNo
WHERE i.SysNo=@GroupBuyingSysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="LoadGroupBuyingTicketBySysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
SELECT [SysNo]
      ,[GroupBuyingSysNo]
      ,[OrderSysNo]
      ,[TicketID]
      ,[TicketAmt]
      ,[RefundMemo]
      ,[AvailableDate]
      ,[Tel]
      ,[UsedStoreSysNo]
      ,[UsedDate]
      ,[CustomerSysNo]
      ,[VendorSysNo]
      ,[RefundDate]
      ,[RefundUser]
      ,[CreateUser]
      ,[CreateDate]
      ,[EditUser]
      ,[EditDate]
      ,[CompanyCode]
      ,[StoreCompanyCode]
      ,[LanguageCode]
      ,[Status]
      ,[RefundStatus]
      ,[PayType]
      ,[CostAmt]
  FROM [OverseaContentManagement].[dbo].[GroupBuyingTicket] WITH(NOLOCK)
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
  
  <dataCommand name="UpdateGroupBuyingTicketStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	UPDATE OverseaContentManagement.dbo.GroupBuyingTicket SET
    Status=@Status,
    EditUser=@EditUser,
    EditDate=GETDATE()
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@EditUser" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateGroupBuyingTicketRefundInfo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
	UPDATE OverseaContentManagement.dbo.GroupBuyingTicket SET
    Status=@Status,
    EditUser=@EditUser,
    EditDate=GETDATE(),
    RefundDate=@RefundDate,
    RefundStatus=@RefundStatus,
    RefundMemo=@RefundMemo,
    RefundUser=@EditUser
  WHERE SysNo=@SysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@EditUser" dbType="Int32"/>
      <param name="@RefundDate" dbType="DateTime"/>
      <param name="@RefundStatus" dbType="Int32"/>
      <param name="@RefundMemo" dbType="String"/>
    </parameters>
  </dataCommand>
</dataOperations>
