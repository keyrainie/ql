<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">

  <!--获取主信息-->
  <dataCommand name="LoadCouponsMaster" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
      SELECT TOP 1 
       [SysNo]
      ,[CouponName] as [Title.Content]
      ,[CouponDesc] as UserDescription
      ,[CouponType] as CouponRuleType
      ,[ChannelType] as CouponChannelType
      ,[RulesType] AS ProductRangeType
      ,[Status] 
      ,[BeginDate] as StartTime
      ,[EndDate] as EndTime
      ,[EIMSSysNo]
      ,MerchantSysNo
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,[AuditDate]
      ,[AuditUser]
      ,[CompanyCode]
      ,[LanguageCode]      
         FROM [OverseaECommerceManagement].[dbo].[Coupon] with(nolock) 
         WHERE SysNo = @SysNo 
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--获取其它所有的信息，除了优惠券码-->
  <dataCommand name="LoadCouponsInfo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
    SELECT TOP 1 
       [SysNo]
      ,[CouponName] as [Title.Content]
      ,[CouponDesc] as UserDescription
      ,[CouponType] as CouponRuleType
      ,[ChannelType] as CouponChannelType
      ,[RulesType] AS ProductRangeType
      ,[Status] 
      ,[BeginDate] as StartTime
      ,[EndDate] as EndTime
      ,[EIMSSysNo]
      ,MerchantSysNo
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,[AuditDate]
      ,[AuditUser]
      ,[CompanyCode]
      ,[LanguageCode]      
    FROM [OverseaECommerceManagement].[dbo].[Coupon] with(nolock) 
    WHERE SysNo = @SysNo
     
    SELECT TOP 1 [SysNo]
      ,[CouponSysNo]
      ,[IsAutoBinding]
      ,[BindingDate]
      ,[IsSendMail]
      ,[BindCondition]
      ,[ValidPeriod]
      ,[Status]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,[BindBeginDate]
      ,[BindEndDate]      
      ,AmountLimit
      ,LimitType
  FROM [OverseaECommerceManagement].[dbo].[Coupon_BindRules] 
  WHERE CouponSysNo= @SysNo
  
  SELECT  [SysNo]
      ,[CouponSysNo]
      ,[RulesType]
      ,[Amount]
      ,[Value]
      ,[Quantity]
      ,[ProductSysNo]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
  FROM [OverseaECommerceManagement].[dbo].[Coupon_DiscountRules]
  WHERE CouponSysNo= @SysNo
  
  SELECT  [SysNo]
      ,[CouponSysNo]
      ,[Type]
      ,[C3SysNo]
      ,[BrandSysNo]
      ,[ProductSysNo]
      ,[CustomerRank]
      ,[AreaSysNo]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,[RelationType]
  FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRules]
  WHERE CouponSysNo= @SysNo
  
  SELECT TOP 1 [SysNo]
      ,[CouponSysNo]
      ,[OrderAmountLimit]
      ,[PayTypeSysNo]
      ,[ShippingTypeSysNo]
      ,[OrderMaxDiscount]
      ,[CustomerMaxFrequency]
      ,[MaxFrequency]
      ,[UsedFrequency]
      ,[NeedEmailVerification]
      ,[NeedMobileVerification]
      ,[InvalidForAmbassador]
      ,[IsAutoUse]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
  FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRules_Ex]
  WHERE CouponSysNo= @SysNo
      
  SELECT cs.[SysNo]
      ,cs.[CouponSysNo]
      ,cs.[CustomerSysNo]
      ,cs.[Status]
      ,cs.[InDate]
      ,cs.[InUser]
      ,cs.[EditDate]
      ,cs.[EditUser]
      ,c.CustomerID
      ,c.CustomerName
  FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRulesCustomer]  as cs  WITH(NOLOCK)   
INNER Join [IPP3].[dbo].[Customer] AS c WITH(NOLOCK) ON c.Sysno=cs.[CustomerSysNo]
  WHERE CouponSysNo= @SysNo
  
  
  SELECT cbri.[SysNo]
      ,cbri.[CouponSysNo]
      ,cbri.[RuleItemType]
      ,cbri.[ItemDataSysNo]
      ,cbri.[RelationType]
      ,cbri.[InDate]
      ,cbri.[InUser]
      ,cbri.[EditDate]
      ,cbri.[EditUser]
      ,cbri.[SellerSysNo]
      ,p.ProductID
      ,p.ProductName
      ,p.[Status] as ProductStatus
  FROM [OverseaECommerceManagement].[dbo].[Coupon_BindRuleItems] as cbri  WITH(NOLOCK)  
  INNER JOIN IPP3.dbo.Product as p WITH(NOLOCK) ON cbri.RuleItemType='I' AND cbri.ItemDataSysNo=p.SysNo
  WHERE CouponSysNo= @SysNo
  
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--根据优惠券SysNo 获取对应优惠券的折扣活动信息-->
  <dataCommand name="GetCouponsSysNoByCouponCodeSysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
         SELECT TOP(1) CouponSysNo,CouponCode
         FROM [OverseaECommerceManagement].[dbo].[CouponCode]  WITH(NOLOCK)
         WHERE SysNo =@SysNo
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  <!--创建主信息-->
  <dataCommand name="CreateCouponsMaster" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
         INSERT INTO [OverseaECommerceManagement].[dbo].[Coupon]
           ([CouponName]
           ,[CouponDesc]
           ,[CouponType]
           ,[ChannelType]
           ,[RulesType]
           ,[Status]
           ,[BeginDate]
           ,[EndDate]
           ,[EIMSSysNo]
           ,[MerchantSysNo]
           ,[InDate]
           ,[InUser]
           ,[EditDate]
           ,[EditUser]
           ,[AuditDate]
           ,[AuditUser]
           ,CompanyCode
           )
        VALUES
           (@CouponName
           ,@CouponDesc
           ,@CouponType
           ,@ChannelType
           ,@RulesType
           ,'O'
           ,@BeginDate
           ,@EndDate
           ,CASE WHEN @EIMSSysNo = 0 THEN NULL ELSE @EIMSSysNo END
           ,1
           ,Getdate()
           ,@InUser
           ,null
           ,''
           ,null
           ,''
           ,@CompanyCode
           )           
        SELECT @SysNo = SCOPE_IDENTITY();   
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" direction="Output"/>
      <param name="@CouponName" dbType="String" />
      <param name="@CouponDesc" dbType="String" />
      <param name="@CouponType" dbType="AnsiStringFixedLength" />
      <param name="@ChannelType" dbType="AnsiStringFixedLength" />
      <param name="@RulesType" dbType="AnsiStringFixedLength" /> 
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
      <param name="@EIMSSysNo" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength"/>

    </parameters>
  </dataCommand>

  <!--更新主信息-->
  <dataCommand name="UpdateCouponsMaster" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
         UPDATE [OverseaECommerceManagement].[dbo].[Coupon]
         SET [CouponName] = @CouponName
            ,[CouponDesc] = @CouponDesc
            ,[CouponType] = @CouponType
            ,[ChannelType] = @ChannelType
            ,[RulesType] = @RulesType    
            ,[BeginDate] = @BeginDate
            ,[EndDate] = @EndDate
            ,[EIMSSysNo] = @EIMSSysNo
            ,[EditDate] = Getdate()
            ,[EditUser] = @EditUser
            ,[Status] = @Status
         WHERE SysNo = @SysNo   
		 
		 IF exists (SELECT TOP 1 1
            FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRules] WITH(NOLOCK) 
            WHERE Couponsysno=@SysNo   AND Type ='R' and CustomerRank =-1)
		  BEGIN
				  UPDATE code 
				  SET code.BeginDate=c.BeginDate 
				     ,code.EndDate=c.EndDate 
				  FROM OverseaECommerceManagement.dbo.CouponCode code  WITH(NOLOCK) 
				  INNER JOIN OverseaECommerceManagement.dbo.Coupon c WITH(NOLOCK) 
					  ON c.SysNo=code .CouponSysNo 
				  WHERE 
					  code.CouponSysNo = @SysNo
		  END
         
     IF (@RulesType = 'A')
         BEGIN
           DELETE FROM OverseaECommerceManagement.dbo.Coupon_SaleRules
           WHERE CouponSysNo = @SysNo
             AND Type IN ('C','B','I')
           
           DELETE FROM OverseaECommerceManagement.dbo.Coupon_DiscountRules
           WHERE CouponSysNo = @SysNo
             AND RulesType IN ('Z','F')
         END
     IF (@RulesType = 'X')
         BEGIN
           DELETE FROM OverseaECommerceManagement.dbo.Coupon_SaleRules
           WHERE CouponSysNo = @SysNo
             AND Type = 'I'
             
           DELETE FROM OverseaECommerceManagement.dbo.Coupon_DiscountRules
           WHERE CouponSysNo = @SysNo
             AND RulesType IN ('Z','F')
         END
     IF (@RulesType = 'I')
         BEGIN
           DELETE FROM OverseaECommerceManagement.dbo.Coupon_SaleRules
           WHERE CouponSysNo = @SysNo
             AND Type IN ('C','B')
         END             
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@CouponName" dbType="String" />
      <param name="@CouponDesc" dbType="String" />
      <param name="@CouponType" dbType="AnsiStringFixedLength" />
      <param name="@ChannelType" dbType="AnsiStringFixedLength" />
      <param name="@RulesType" dbType="AnsiStringFixedLength" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
      <param name="@EIMSSysNo" dbType="Int32"/>
      <param name="@EditUser" dbType="String" />
    </parameters>
  </dataCommand>

  <!--判断是否存在EMIS SysNo-->
  <dataCommand name="IsExistEMIS" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
         SELECT TOP 1 1 FROM OverseaPOASNManagement.dbo.V_PM_ReturnPoint with(nolock) WHERE SysNo = @SysNo 
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--更改优惠券状态-->
  <dataCommand name="UpdateCouponsStatus" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
        UPDATE [OverseaECommerceManagement].[dbo].[Coupon]
        SET [status]=@Status 
           ,EditUser = @EditUser
           ,EditDate = Getdate()
        WHERE  SysNo = @SysNo  
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--审核优惠券-->
  <dataCommand name="AuditCoupons" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
        UPDATE OverseaECommerceManagement.dbo.Coupon 
        SET [status]=@Status 
           ,AuditUser = @AuditUser
           ,AuditDate = Getdate()
        WHERE SysNo = @SysNo  
             ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@AuditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <!-- 当非 注册生日支付宝金账户时，需判断是否有优惠券代码 -->
  <dataCommand name="CheckCouponCodeIsHave" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          SELECT 
              Count(SysNo)
          FROM OverseaECommerceManagement.dbo.CouponCode WITH(NOLOCK)
          WHERE 
              CouponSysNo=@CouponSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--清除商品条件-->
  <!--2012.10.30 update 
  修改类容 IN ('C','B','I','S')
  修改目的 新增商家限定条件S
  -->
  <dataCommand name="DeleteProductCondition" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          DELETE FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRules] 
        where [CouponSysNo]=@CouponSysNo AND [Type] IN ('C','B','I','S')
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />       
    </parameters>
  </dataCommand>
  
  <!--添加活动条件：商品类别，品牌，指定商品，客户级别，客户地区-->
  <dataCommand name="AddCoupon_SaleRules" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          INSERT INTO [OverseaECommerceManagement].[dbo].[Coupon_SaleRules]
           ([CouponSysNo]
           ,[Type]
           ,[C3SysNo]
           ,[BrandSysNo]
           ,[ProductSysNo]
           ,[CustomerRank]
           ,[AreaSysNo]
           ,[InDate]
           ,[InUser]
           ,[RelationType])
     VALUES
           (@CouponSysNo
           ,@Type
           ,@C3SysNo
           ,@BrandSysNo
           ,@ProductSysNo
           ,@CustomerRank
           ,@AreaSysNo
           ,GETDATE()
           ,@InUser
           ,@RelationType) 
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@Type" dbType="AnsiStringFixedLength" />
      <param name="@C3SysNo" dbType="Int32" />
      <param name="@BrandSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@CustomerRank" dbType="Int32" />
      <param name="@AreaSysNo" dbType="Int32" />
      <param name="@InUser" dbType="String" />
      <param name="@RelationType" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <!--清除客户条件-->
  <dataCommand name="DeleteCustomerCondition" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
        DELETE FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRules] 
        where [CouponSysNo]=@CouponSysNo AND [Type] IN ('A','R')
        
        DELETE FROM [OverseaECommerceManagement].[dbo].Coupon_SaleRulesCustomer 
        WHERE [CouponSysNo]=@CouponSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--添加客户条件中指定客户-->
  <dataCommand name="AddCoupon_SaleRulesCustomer" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          INSERT INTO [OverseaECommerceManagement].[dbo].[Coupon_SaleRulesCustomer]
             ([CouponSysNo]
             ,[CustomerSysNo]
             ,[Status]
             ,[InDate]
             ,[InUser]
             ,[EditDate]
             ,[EditUser])
           VALUES
             (@CouponSysNo
             ,@CustomerSysNo
             ,'N'
             ,GETDATE()
             ,@InUser
             ,NULL
             ,NULL)
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>

  <!--设置客户条件中三种CheckBox-->
  <dataCommand name="SetCustomerConditionEx" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          UPDATE [OverseaECommerceManagement].[dbo].[Coupon_SaleRules_Ex]
   SET [NeedEmailVerification] = @NeedEmailVerification
      ,[NeedMobileVerification] = @NeedMobileVerification
      ,[InvalidForAmbassador] = @InvalidForAmbassador     
 WHERE [CouponSysNo]=@CouponSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@NeedEmailVerification" dbType="AnsiStringFixedLength" />
      <param name="@NeedMobileVerification" dbType="AnsiStringFixedLength" />
      <param name="@InvalidForAmbassador" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <!--设置活动规则：订单条件、次数条件-->
  <dataCommand name="SetSaleRuleEx" database="MKTService"  commandType="Text">
  <commandText>
    <![CDATA[		  
IF(EXISTS(SELECT Top 1 1 FROM OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex  WHERE CouponSysNo=@CouponSysNo))
BEGIN
	UPDATE OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex
	   SET OrderAmountLimit = @OrderAmountLimit 
		  ,PayTypeSysNo = @PayTypeSysNo 
		  ,ShippingTypeSysNo = @ShippingTypeSysNo 
		  ,OrderMaxDiscount = @OrderMaxDiscount 
		  ,CustomerMaxFrequency = @CustomerMaxFrequency 
		  ,MaxFrequency = @MaxFrequency      
		  ,IsAutoUse = @IsAutoUse 
		  ,EditDate = GETDATE()
		  ,EditUser = @EditUser
	 WHERE CouponSysNo=@CouponSysNo
END
ELSE
BEGIN
	INSERT INTO OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex
           (CouponSysNo
           ,OrderAmountLimit
           ,PayTypeSysNo
           ,ShippingTypeSysNo
           ,OrderMaxDiscount
           ,CustomerMaxFrequency
           ,MaxFrequency           
           ,IsAutoUse
           ,InDate
           ,InUser)
     VALUES
           (@CouponSysNo
           ,@OrderAmountLimit
           ,@PayTypeSysNo
           ,@ShippingTypeSysNo
           ,@OrderMaxDiscount
           ,@CustomerMaxFrequency
           ,@MaxFrequency           
           ,@IsAutoUse
           ,GETDATE()
           ,@InUser) 
END
       ]]>
  </commandText>
  <parameters>
    <param name="@CouponSysNo" dbType="Int32" />
    <param name="@OrderAmountLimit" dbType="Decimal" />
    <param name="@PayTypeSysNo" dbType="Int32" />
    <param name="@ShippingTypeSysNo" dbType="Int32" />
    <param name="@OrderMaxDiscount" dbType="Decimal" />
    <param name="@CustomerMaxFrequency" dbType="Int32" />
    <param name="@MaxFrequency" dbType="Int32" />
    <param name="@IsAutoUse" dbType="AnsiStringFixedLength" />
    <param name="@EditUser" dbType="String" />
    <param name="@InUser" dbType="String" /> 
  </parameters>
</dataCommand>

  <!--清除活动折扣规则-->
  <dataCommand name="Coupons_DeleteDiscountRules" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
        DELETE FROM [OverseaECommerceManagement].[dbo].Coupon_DiscountRules  where [CouponSysNo]=@CouponSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  <!--添加活动折扣规则-->
  <dataCommand name="Coupons_AddDiscountRules" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          INSERT INTO OverseaECommerceManagement.dbo.Coupon_DiscountRules
           (CouponSysNo
           ,RulesType
           ,Amount
           ,Value
           ,Quantity
           ,ProductSysNo
           ,InDate
           ,InUser)           
      VALUES
           (@CouponSysNo
           ,@RulesType
           ,@Amount
           ,@Value
           ,@Quantity
           ,@ProductSysNo
           ,GETDATE()
           ,@InUser)
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@RulesType" dbType="AnsiStringFixedLength" />
      <param name="@Amount" dbType="Decimal" />
      <param name="@Value" dbType="Decimal" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>

  <!--设置活动规则：触发条件-->
  <dataCommand name="Coupons_SetBindRules" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
        IF EXISTS (SELECT TOP 1 1
                   FROM [OverseaECommerceManagement].[dbo].[Coupon_BindRules] with(nolock)
                   WHERE CouponSysNo = @CouponSysNo)
          BEGIN
            UPDATE [OverseaECommerceManagement].[dbo].[Coupon_BindRules]
            SET [IsAutoBinding] = @IsAutoBinding
                ,[BindingDate] = @BindingDate
                ,[IsSendMail] = @IsSendMail
                ,[BindCondition] = @BindCondition
                ,[ValidPeriod] = @ValidPeriod
                ,[EditDate] = GETDATE()
                ,[EditUser] = @InUser
                ,[BindBeginDate]=@BeginDate
                ,[BindEndDate]=@EndDate
                ,[AmountLimit]=@AmountLimit
                ,[LimitType]=@LimitType
            WHERE CouponSysNo = @CouponSysNo
          END
        ELSE
          BEGIN
            INSERT INTO [OverseaECommerceManagement].[dbo].[Coupon_BindRules]
               ([CouponSysNo]
               ,[IsAutoBinding]
               ,[BindingDate]
               ,[IsSendMail]
               ,[BindCondition]
               ,[ValidPeriod]
               ,[InDate]
               ,[InUser]              
               ,[BindBeginDate]
               ,[BindEndDate]
               ,[AmountLimit]
               ,[LimitType]
               )
            VALUES
               (@CouponSysNo
               ,@IsAutoBinding
               ,@BindingDate
               ,@IsSendMail
               ,@BindCondition
               ,@ValidPeriod
               ,GETDATE()
               ,@InUser
               ,@BeginDate
               ,@EndDate
               ,@AmountLimit
               ,@LimitType) 
          END     
             ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32"/>
      <param name="@IsAutoBinding" dbType="AnsiStringFixedLength"/>
      <param name="@BindingDate" dbType="DateTime"/>
      <param name="@IsSendMail" dbType="AnsiStringFixedLength" />
      <param name="@BindCondition" dbType="AnsiStringFixedLength"/>
      <param name="@ValidPeriod" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
      <param name="@AmountLimit" dbType="Decimal"/>
      <param name="@LimitType" dbType="AnsiStringFixedLength"/>
    </parameters>
  </dataCommand>

  <!--检查该活动中是否存在指定类型的优惠券代码-->
  <dataCommand name="Coupons_CheckExistThisTypeCouponCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		         
         SELECT COUNT(1) FROM [OverseaECommerceManagement].[dbo].[CouponCode] WITH(NOLOCK)
         WHERE CouponSysNo = @CouponSysNo
           AND CodeType = @CodeType
             ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32"/>
      <param name="@CodeType" dbType="AnsiStringFixedLength"/>
    </parameters>
  </dataCommand>

  <!--优惠券代码查询-->
  <dataCommand name="QueryCouponCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
SELECT @TotalCount = COUNT(SysNo) 
FROM [OverseaECommerceManagement].[dbo].[CouponCode] WITH(NOLOCK)
 #StrWhere# 

;WITH TempTable AS (
  SELECT SysNo,RowNumber FROM
  (
	   SELECT  [SysNo]
			    ,Row_Number() OVER (Order BY #SortColumnName#) AS RowNumber
		  FROM [OverseaECommerceManagement].[dbo].[CouponCode]  WITH(NOLOCK)
		   #StrWhere# 
  ) T WHERE RowNumber > @StartNumber AND RowNumber <= @EndNumber 
)

SELECT  C.[SysNo]
      ,[CouponSysNo]
      ,[CouponCode]
      ,CASE CodeType  WHEN 'C' Then '通用型' ELSE '投放型' END AS CodeType
      ,[DueInvertRate]
      ,[CustomerMaxFrequency]
      ,[TotalCount]
      ,[UseCount]
      ,[TotalDiscount]
      ,[BeginDate]
      ,[EndDate]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,TempTable.RowNumber
FROM TempTable
INNER JOIN [OverseaECommerceManagement].[dbo].[CouponCode] C WITH(NOLOCK)
    ON TempTable.SysNo = C.SysNo 
ORDER BY TempTable.RowNumber
             ]]>
    </commandText>   
  </dataCommand>

  <!--验证该Code是否已存在有效的活动中， 查询 如果此code所属活动已经是(作废,完成)，则此code也是可用-->
  <dataCommand name="CheckExistCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          SELECT 
              COUNT(1) 
          FROM [OverseaECommerceManagement].[dbo].[CouponCode] CC WITH(NOLOCK) 
          INNER JOIN OverseaECommerceManagement.dbo.Coupon C WITH(NOLOCK) 
              ON CC.CouponSysNo=C.SysNo
          WHERE 
              CC.CouponCode = @CouponCode
              AND (C.Status!='D' AND C.Status!='F')
        ]]>
    </commandText>
    <parameters>
      <param name="@CouponCode" dbType="String" />
    </parameters>
  </dataCommand>

  <!--逐一创建每张优惠券-->
  <dataCommand name="CreateCouponCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
         DECLARE @SysNo INT
         DECLARE @BeginDate DATETIME
         DECLARE @EndDate DATETIME
         SELECT TOP 1 @BeginDate=BeginDate,@EndDate=EndDate FROM OverseaECommerceManagement.dbo.Coupon WITH(NOLOCK) 
                          WHERE SYSNO = @CouponSysNo
         
         
         INSERT INTO [OverseaECommerceManagement].[dbo].[CouponCode]
             ([CouponSysNo]
             ,[CouponCode]
             ,[CodeType]
             ,[DueInvertRate]
             ,[CustomerMaxFrequency]
             ,[TotalCount]
             ,BeginDate
             ,EndDate
             ,[InDate]
             ,[InUser]
             ,[EditDate]
             ,[EditUser])
         VALUES
             (@CouponSysNo
             ,@CouponCode
             ,@CodeType
             ,@DueInvertRate
             ,@CustomerMaxFrequency
             ,@TotalCount
             ,@BeginDate
             ,@EndDate             
             ,GETDATE()
             ,@InUser
             ,NULL
             ,NULL)
           
        
             ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo"/>
      <param name="@CouponCode" dbType="String"/>
      <param name="@CodeType" dbType="AnsiStringFixedLength" />
      <param name="@DueInvertRate" dbType="Decimal"/>
      <param name="@CustomerMaxFrequency" dbType="Int32"/>
      <param name="@TotalCount" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
    </parameters>
  </dataCommand>
  
  <!--创建优惠券(自动赠送)-->
  <dataCommand name="CreateCouponCodeForSend" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
         INSERT INTO [OverseaECommerceManagement].[dbo].[CouponCode]
             ([CouponSysNo]
             ,[CouponCode]
             ,[CodeType]
             ,[DueInvertRate]
             ,[CustomerMaxFrequency]
             ,[TotalCount]
             ,BeginDate
             ,EndDate
             ,[InDate]
             ,[InUser]
             ,[EditDate]
             ,[EditUser])
         VALUES
             (@CouponSysNo
             ,@CouponCode
             ,@CodeType
             ,@DueInvertRate
             ,@CustomerMaxFrequency
             ,@TotalCount
             ,@BeginDate
             ,@EndDate             
             ,GETDATE()
             ,@InUser
             ,NULL
             ,NULL)
           
        
             ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo"/>
      <param name="@CouponCode" dbType="String"/>
      <param name="@CodeType" dbType="AnsiStringFixedLength" />
      <param name="@DueInvertRate" dbType="Decimal"/>
      <param name="@CustomerMaxFrequency" dbType="Int32"/>
      <param name="@TotalCount" dbType="Int32"/>
      <param name="@InUser" dbType="String"/>
      <param name="@BeginDate" dbType="DateTime"/>
      <param name="@EndDate" dbType="DateTime"/>
    </parameters>
  </dataCommand>

  <!--批量删除优惠券号码-->
  <dataCommand name="DelCouponCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          DELETE  FROM [OverseaECommerceManagement].[dbo].[CouponCode]  
          WHERE SysNo IN (#CouponCodeSysNoList#)
        ]]>
    </commandText>
  </dataCommand>

  <!--删除指定活动下所有优惠券-->
  <dataCommand name="DelAllCouponCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          DELETE  FROM [OverseaECommerceManagement].[dbo].[CouponCode]  
          WHERE CouponSysNo=@CouponSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  <!--根据优惠券号码获取活动是运行状态的优惠券代码的详细信息-->
  <dataCommand name="GetActivedCouponCodeInfoByCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          SELECT A.[SysNo] as CodeSysNo
      ,A.[CouponSysNo] as CouponsSysNo
      ,A.[CouponCode]
      ,A.[CodeType] as CouponCodeType
      ,A.[DueInvertRate]
      ,A.[CustomerMaxFrequency] as CCCustomerMaxFrequency
      ,A.[TotalCount] as CCMaxFrequency
      ,A.[UseCount] as UsedCount
      ,A.[TotalDiscount] as TotalDiscount
      ,A.[BeginDate] as StartTime
      ,A.[EndDate] as EndTime
      ,A.[InDate]
      ,A.[InUser]       
          FROM [OverseaECommerceManagement].[dbo].[CouponCode]  A WITH(NOLOCK)
          INNER JOIN [OverseaECommerceManagement].[dbo].Coupon B WITH(NOLOCK)
            ON A.CouponSysNo=B.SysNo
          WHERE A.CouponCode=@CouponCode AND B.Status='A'
        ]]>
    </commandText>
    <parameters>
      <param name="@CouponCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetCouponCodeInfoByCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          SELECT A.[SysNo] as CodeSysNo
      ,A.[CouponSysNo] as CouponsSysNo
      ,A.[CouponCode]
      ,A.[CodeType] as CouponCodeType
      ,A.[DueInvertRate]
      ,A.[CustomerMaxFrequency] as CCCustomerMaxFrequency
      ,A.[TotalCount] as CCMaxFrequency
      ,A.[UseCount] as UsedCount
      ,A.[TotalDiscount] as TotalDiscount
      ,A.[BeginDate] as StartTime
      ,A.[EndDate] as EndTime
      ,A.[InDate]
      ,A.[InUser]       
          FROM [OverseaECommerceManagement].[dbo].[CouponCode]  A WITH(NOLOCK)
          INNER JOIN [OverseaECommerceManagement].[dbo].Coupon B WITH(NOLOCK)
            ON A.CouponSysNo=B.SysNo
          WHERE A.CouponCode=@CouponCode
        ]]>
    </commandText>
    <parameters>
      <param name="@CouponCode" dbType="String"/>
    </parameters>
  </dataCommand>
  
    
  <!--获取已参与次数: 该活动总的使用次数，该活动当前客户的使用次数；当前代码的使用总使用次数，当前代码当前客户的使用次数-->
  <dataCommand name="GetCouponsUsedCount" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
      DECLARE @TotalCount INT
      DECLARE @CustomerTotalCount INT
      DECLARE @CCTotalCount INT 
      DECLARE @CCCustomerTotalCount INT     
      
     SELECT @TotalCount=COUNT(SysNo) 
          FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK)
          WHERE  CouponSysNo=@CouponsSysNo AND Status='A'
              
      SELECT @CustomerTotalCount=COUNT(SysNo) 
          FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK)
          WHERE  CouponSysNo=@CouponsSysNo AND CustomerSysNo=@CustomerSysNo AND Status='A'
              
      SELECT @CCTotalCount=COUNT(SysNo) 
          FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK)
          WHERE   CouponSysNo=@CouponsSysNo  AND CouponCode=@CouponCode AND Status='A'
     
      SELECT @CCCustomerTotalCount=COUNT(SysNo) 
          FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK)
          WHERE   CouponSysNo=@CouponsSysNo  AND CustomerSysNo=@CustomerSysNo AND CouponCode=@CouponCode AND Status='A'
              
      SELECT @TotalCount AS TotalCount,@CustomerTotalCount AS CustomerTotalCount, 
        @CCTotalCount AS CCTotalCount, @CCCustomerTotalCount AS CCCustomerTotalCount
        ]]>
    </commandText>
    <parameters> 
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@CouponsSysNo" dbType="Int32" />
      <param name="@CouponCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--触发方式为：注册，生日，支付宝金账户，Check是否存在发放记录 -->
  <dataCommand name="CheckExistCustomerIssueLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          SELECT 
              COUNT(SysNo) 
          FROM OverseaECommerceManagement.dbo.CouponCode_CustomerLog WITH(NOLOCK)
          WHERE 
              CouponCode=@CouponCode
              AND CustomerSysNo=@CustomerSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponCode" dbType="String" />
      <param name="@CustomerSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--根据优惠券编号检查优惠券是否有效，不管优惠券是否有效都要返回优惠券代码-->
  <dataCommand name="CheckCouponIsValidAndGetCode" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		
          SELECT TOP 1 [CouponCode]
          FROM [OverseaECommerceManagement].[dbo].[CouponCode]  
          WHERE SysNo=@CouponCodeSysNo 
          
          SELECT COUNT(1) AS CodeCount
          FROM [OverseaECommerceManagement].[dbo].[CouponCode]  A WITH(NOLOCK)
          INNER JOIN [OverseaECommerceManagement].[dbo].Coupon B WITH(NOLOCK)
            ON A.CouponSysNo=B.SysNo
          WHERE A.SysNo=@CouponCodeSysNo  AND  B.Status='A'
        ]]>
    </commandText>
    <parameters>
      <param name="@CouponCodeSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!-- 优惠券应用时，写RedeemLog表,更新活动及优惠券的应用次数和折扣总额 -->
  <dataCommand name="CouponCodeApply" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
       DECLARE @CouponActionSysNo INT   --参数传进来的实际是优惠券的系统编号，不是优惠券活动的编号
      set @CouponActionSysNo=@CouponSysNo
      Select  @CouponActionSysNo=CouponSysNo FROM OverseaECommerceManagement.dbo.CouponCode with(nolock) where
        CouponCode=@CouponCode and SysNo=@CouponSysNo
      
            INSERT INTO OverseaECommerceManagement.dbo.CouponCode_RedeemLog
						(
							CouponSysNo,
							CouponCode,
							CustomerSysNo,
							ShoppingCartSysNo,
							SOSysNo,
							RedeemAmount,
							Status,
							InDate,
							InUser
						)
						Values
            ( 
							@CouponActionSysNo,
							@CouponCode,
							@CustomerSysNo,
							@ShoppingCartSysNo,
							@SOSysNo,
							@RedeemAmount,
							'A',
							GETDATE(),
							@InUser
            )
            
            UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode 
            SET UseCount = ISNULL(UseCount,0) + 1
               ,TotalDiscount = ISNULL(TotalDiscount,0) + @RedeemAmount 
            WHERE 
                CouponSysNo = @CouponActionSysNo AND CouponCode=@CouponCode
		
            UPDATE TOP (1) OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex 
            SET UsedFrequency = ISNULL(UsedFrequency,0) + 1 
            WHERE 
                CouponSysNo = @CouponActionSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@CouponCode" dbType="String" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@ShoppingCartSysNo" dbType="Int32" />
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@RedeemAmount" dbType="Decimal" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>

  <!-- 已应用的优惠券取消时，更新RedeemLog表中原纪录状态,更新活动及优惠券的应用次数和折扣总额 -->
  <dataCommand name="CouponCodeCancel" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[       
        DECLARE @CouponSysNo INT
          DECLARE @RedeemAmount decimal(12,2)
          DECLARE @RedeemLogSysNo INT

          SELECT TOP 1 
              @CouponSysNo=CouponSysNo,
              @RedeemLogSysNo=SysNo,
              @RedeemAmount=RedeemAmount 
          FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK) 
          WHERE   CouponCode=@CouponCode
              AND SOSysNo = @SOSysNo                             
              AND Status = 'A' 
          IF(@RedeemLogSysNo IS NULL)
          BEGIN
            RETURN
          END
          
          --fixbug:前台订单拆分了优惠券的返还了多次优惠券使用记录
          IF(@ShoppingCartSysNo > 0 )
           BEGIN
             IF NOT EXISTS (SELECT TOP 1 1 FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog 
                WHERE ShoppingcartSysNo = @ShoppingCartSysNo AND [Status] = 'D')
             BEGIN
               UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode 
                  SET UseCount = ISNULL(UseCount,0) - 1
                  WHERE 
                      CouponSysNo = @CouponSysNo AND CouponCode=@CouponCode
		
               UPDATE TOP (1) OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex 
                  SET UsedFrequency = ISNULL(UsedFrequency,0) - 1 
                  WHERE 
                      CouponSysNo = @CouponSysNo     
            END
          END
          ELSE
          BEGIN
           UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode 
                SET UseCount = ISNULL(UseCount,0) - 1
                WHERE 
                    CouponSysNo = @CouponSysNo AND CouponCode=@CouponCode
		
             UPDATE TOP (1) OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex 
                SET UsedFrequency = ISNULL(UsedFrequency,0) - 1 
                WHERE 
                    CouponSysNo = @CouponSysNo   
          END
          
          UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode_RedeemLog 
          SET Status = 'D'
             ,EditUser=@EditUser
             ,EditDate=GETDATE() 
          WHERE SysNo= @RedeemLogSysNo
          
          UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode 
              SET TotalDiscount = TotalDiscount-@RedeemAmount
          WHERE 
              CouponSysNo = @CouponSysNo AND CouponCode=@CouponCode
              
       ]]>
    </commandText>
    <parameters>    
      <param name="@CouponCode" dbType="String" />
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@ShoppingCartSysNo" dbType="Int32" />
      <param name="@EditUser" dbType="String" property="[USERACCT]" />
    </parameters>
  </dataCommand>


  <!--优惠券查询-->
  <dataCommand name="QueryCoupons" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
IF (@CouponCode is NULL)
  BEGIN
  SELECT @TotalCount=COUNT(1)  
  FROM [OverseaECommerceManagement].[dbo].[Coupon] A WITH(NOLOCK) 
		     #StrWhere# 
      
  SELECT [SysNo]
        ,[CouponName]
        ,[CouponDesc]
        ,[CouponType]  
        ,[ChannelType]
        ,[RulesType]
        ,RulesTypeName=''
        ,[Status]
        ,'' AS StatusName
        ,[BeginDate]
        ,[EndDate]
        ,[EIMSSysNo]
        ,[MerchantSysNo]
        ,[InDate]
        ,[InUser]
        ,[EditDate]
        ,[EditUser]
        ,[AuditDate]
        ,[AuditUser]
        ,[CompanyCode]
        ,WebChannelID='' 
        ,[MerchantName]
    FROM(
      SELECT TOP (@EndNumber)
         A.[SysNo]
        ,A.[CouponName]
        ,A.[CouponDesc]
        ,A.[CouponType]  
        ,A.[ChannelType]
        ,A.[RulesType]
        ,A.[Status]
        ,A.[BeginDate]
        ,A.[EndDate]
        ,A.[EIMSSysNo]
        ,A.[MerchantSysNo]
        ,A.[InDate]
        ,A.[InUser]
        ,A.[EditDate]
        ,A.[EditUser]
        ,A.[AuditDate]
        ,A.[AuditUser]
        ,A.[CompanyCode]  
        ,V.[VendorName] AS MerchantName
        ,Row_Number() OVER (Order BY #SortColumnName#) AS RowNumber
      FROM [OverseaECommerceManagement].[dbo].[Coupon] A WITH(NOLOCK) 
      LEFT JOIN IPP3.dbo.Vendor AS V WITH(NOLOCK) 
        ON V.Sysno=A.MerchantSysNo
        #StrWhere# 
    )  T WHERE RowNumber > @StartNumber
    
END   
ELSE
BEGIN 
  SELECT @TotalCount = COUNT(1) FROM [OverseaECommerceManagement].[dbo].[Coupon] A WITH(NOLOCK) 
    INNER JOIN [OverseaECommerceManagement].[dbo].CouponCode B with(NOLOCK)
     ON A.SysNo = B.CouponSysNo AND B.CouponCode=@CouponCode 
     #StrWhere# 
  
  SELECT [SysNo]
      ,[CouponName]
      ,[CouponDesc]
      ,[CouponType]
      ,[ChannelType]
      ,[RulesType]
      ,RulesTypeName=''
      ,[Status]
      ,'' AS StatusName
      ,[BeginDate]
      ,[EndDate]
      ,[EIMSSysNo]
      ,[MerchantSysNo]
      ,[InDate]
      ,[InUser]
      ,[EditDate]
      ,[EditUser]
      ,[AuditDate]
      ,[AuditUser]
      ,[CompanyCode]
	    ,WebChannelID=''
      ,[MerchantName]
  FROM 
    (
    SELECT TOP (@EndNumber)
       A.[SysNo]
      ,A.[CouponName]
      ,A.[CouponDesc]
      ,A.[CouponType]
      ,A.[ChannelType]
      ,A.[RulesType] 
      ,A.[Status] 
      ,A.[BeginDate]
      ,A.[EndDate]
      ,A.[EIMSSysNo]
      ,A.[MerchantSysNo]
      ,A.[InDate]
      ,A.[InUser]
      ,A.[EditDate]
      ,A.[EditUser]
      ,A.[AuditDate]
      ,A.[AuditUser]
      ,A.[CompanyCode]
      ,V.[VendorName] AS MerchantName
      ,Row_Number() OVER (Order BY #SortColumnName#) AS RowNumber
    FROM [OverseaECommerceManagement].[dbo].[Coupon] A WITH(NOLOCK) 
    INNER JOIN [OverseaECommerceManagement].[dbo].CouponCode B with(NOLOCK)
     ON A.SysNo = B.CouponSysNo AND B.CouponCode=@CouponCode 
     LEFT JOIN IPP3.dbo.Vendor AS V WITH(NOLOCK) 
        ON V.Sysno=MerchantSysNo
     #StrWhere# 
    )T WHERE RowNumber > @StartNumber
    
END
             ]]>
    </commandText>
  </dataCommand>

  <!--优惠券发放记录查询-->
  <dataCommand name="QueryCouponCodeCustomerLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	

SELECT @TotalCount=COUNT(1) 
FROM [OverseaECommerceManagement].[dbo].[Coupon] Coupon  
INNER JOIN [OverseaECommerceManagement].[dbo].CouponCode_CustomerLog CustomerLog WITH(NOLOCK) ON CustomerLog.[CouponSysNo] = Coupon.SysNo
INNER JOIN [IPP3].[dbo].[Customer] Customer ON CustomerLog.[CustomerSysNo] = Customer.SysNo
#StrWhere#

SELECT * FROM 
(
SELECT TOP (@EndNumber)
Row_Number() OVER (ORDER BY #SortColumnName#) AS RowNumber,
Coupon.[SysNo], 
Coupon.[CouponName],
Coupon.[Status],
Coupon.[InDate],
Coupon.[InUser],
CustomerLog.[CustomerSysNo],
Customer.[CustomerID],
CustomerLog.[GetCouponCodeDate],
CustomerLog.[CouponCode],
(SELECT TOP 1 BeginDate 
   	FROM OverseaECommerceManagement.dbo.CouponCode WITH(nolock) 
   	WHERE couponsysno=Coupon.sysno) AS [BeginDate] 
   ,(SELECT TOP 1 EndDate 
   	FROM OverseaECommerceManagement.dbo.CouponCode WITH(nolock) 
   	WHERE couponsysno=Coupon.sysno) AS [EndDate] 
FROM [OverseaECommerceManagement].[dbo].[Coupon] Coupon  
INNER JOIN [OverseaECommerceManagement].[dbo].CouponCode_CustomerLog CustomerLog WITH(NOLOCK) ON CustomerLog.[CouponSysNo] = Coupon.SysNo
INNER JOIN [IPP3].[dbo].[Customer] Customer ON CustomerLog.[CustomerSysNo] = Customer.SysNo
#StrWhere#   ) RESULT
WHERE RowNumber > @StartNumber
             ]]>
    </commandText>
  </dataCommand>
  <!--优惠券使用日志查询-->
  <dataCommand name="QueryCouponCodeRedeemLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
SELECT @TotalCount=COUNT(1) 
FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog RedeemLog WITH(NOLOCK)
INNER JOIN OverseaECommerceManagement.dbo.Coupon Coupon ON RedeemLog.CouponSysNo = Coupon.SysNo
INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory so ON RedeemLog.SOSysNo = so.SysNo
INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cs ON cs.SysNo = so.CustomerSysNo
#StrWhere#

SELECT 
  * 
FROM 
(
    SELECT TOP (@EndNumber)
        RedeemLog.[SysNo] as CouponSysNo,
        RedeemLog.[CouponCode],
        so.[SysNo] as SOSysNo,
        so.[Status] as SOStatus,        
        so.[SOAmt],
        RedeemLog.[RedeemAmount],
        cs.[CustomerID],
        so.[OrderDate],
        RedeemLog.[Status] as RedeemLogStatus,        
        Row_Number() OVER (ORDER BY #SortColumnName#) AS RowNumber
    FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog RedeemLog WITH(NOLOCK)
    INNER JOIN OverseaECommerceManagement.dbo.Coupon Coupon 
      ON RedeemLog.CouponSysNo = Coupon.SysNo
    INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory so 
      ON RedeemLog.SOSysNo = so.SysNo
    INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo cs 
      ON cs.SysNo = so.CustomerSysNo
    #StrWhere#) RESULT
WHERE RowNumber > @StartNumber
             ]]>
    </commandText>
  </dataCommand>

  <!--获取订单产生的优惠卷信息 -->
  <dataCommand name="GetPromotionCodeLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
            SELECT TOP 1 
                A.PromotionCode,
                A.PromotionAmountType ,
                B.SysNo AS PromotionSysNo,
               A.SOSysNo
            from Ecommerce.dbo.PromotionCode_Customer_Log A WITH(NOLOCK) 
            INNER JOIN IPP3.dbo.Promotion_Code B WITH(NOLOCK)
                ON A.PromotionCode = B.PromotionCode
            INNER JOIN OverseaECommerceManagement.dbo.CouponCode C WITH(NOLOCK)
				ON A.PromotionCode=C.CouponCode AND A.PromotionSysNo=C.CouponSysNo
            WHERE A.SOSysNo = @SOSysNo 
                AND A.Status='D'
                ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" /> 
    </parameters>
  </dataCommand>

  <dataCommand name="GetCouponAmount" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
 SELECT r.CouponSysNo ReferenceSysNo
        ,CASE WHEN r.RulesType='P' THEN p.CurrentPrice*r.Value
          WHEN r.RulesType='F' THEN p.CurrentPrice-r.Value
          ELSE r.Value END AS Discount
        --,r.SysNo DiscountRuleSysNo
 FROM  OverseaEcommerceManagement.dbo.Coupon_SaleRules s WITH (NOLOCK)
INNER JOIN OverseaContentManagement.dbo.V_IM_Product_Price p  WITH (NOLOCK) ON  s.ProductSysNo=p.ProductSysNo
INNER JOIN OverseaEcommerceManagement.dbo.Coupon c WITH (NOLOCK) ON  s.CouponSysNo=c.SysNo
INNER JOIN OverseaEcommerceManagement.dbo.CouponCode z WITH (NOLOCK) ON  z.CouponSysNo=c.SysNo 
RIGHT JOIN OverseaEcommerceManagement.dbo.Coupon_DiscountRules r WITH (NOLOCK) ON  r.CouponSysNo=c.SysNo
WHERE c.ChannelType='P' AND c.RulesType='I' AND s.Type='I' AND c.Status='A' AND z.BeginDate<=GETDATE() AND z.EndDate>=GETDATE()
 AND s.ProductSysNo=@ProductSysNo
	  ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo"  dbType="Int32"/>
    </parameters>
  </dataCommand>
<!--商家限定相关 begin-->
  <dataCommand name="GetVendorSaleRulesByCouponSysNo" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
      DECLARE @WhereSql NVARCHAR(2000)
DECLARE @SelectSql NVARCHAR(MAX)

SET @WhereSql = N' WHERE csr.Type = ''S'' '
	IF @CouponSysNo >=0
		SET @WhereSql = @WhereSql + N' AND c.SysNo = @CouponSysNo'      


	    SET @SelectSql =
		  N'SELECT v.SysNo as VendorSysNo
               ,v.VendorName as VendorName
         FROM OverseaECommerceManagement.dbo.Coupon_SaleRules csr WITH(nolock) 
         INNER JOIN OverseaECommerceManagement.dbo.Coupon c WITH(nolock) 
            ON c.SysNo = csr.CouponSysNo 
         LEFT JOIN OverseaPOASNManagement.dbo.V_PM_VendorList v WITH(nolock) 
            ON csr.SellerSysNo = v.SysNo '+@WhereSql
   

EXEC SP_EXECUTESQL @SelectSql,
    N'@CouponSysNo INT',
    @CouponSysNo
    

      ]]>
    </commandText>
    <parameters>
       <param name="@CouponSysNo" dbType="Int32" size="20"/>
  </parameters>
  </dataCommand>
  <!--创建-->
  <dataCommand name="CreateVendorSaleRules" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
      insert into OverseaECommerceManagement.dbo.Coupon_SaleRules
      (
      CouponSysNo,Type,InDate,InUser,RelationType,SellerSysNo
      )Values
      (@CouponSysNo,@Type,getdate(),@UserName,@RelationType,@SellerSysNo)
    
     ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" size="20"/>
      <param name="@Type" dbType="AnsiStringFixedLength" />
      <param name="@UserName" dbType="AnsiStringFixedLength" />
      <param name="@RelationType" dbType="AnsiStringFixedLength" />
      <param name="@SellerSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

 <!--商家限定相关 end-->

  <!--清除触发条件 商品规则-->
  <dataCommand name="DeleteBindRulesProductCondition" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[
        DELETE FROM [OverseaECommerceManagement].[dbo].Coupon_BindRuleItems 
        WHERE [CouponSysNo]=@CouponSysNo
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--添加活动条件：触发条件 商品-->
  <dataCommand name="AddCoupon_BindRulesProductCondition" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[		  
          INSERT INTO [OverseaECommerceManagement].[dbo].[Coupon_BindRuleItems]
           ([CouponSysNo]
           ,[RuleItemType]
           ,[ItemDataSysNo]
           ,[RelationType]
           ,[InDate]
           ,[InUser]
           ,[EditDate]
           ,[EditUser])
     VALUES
           (@CouponSysNo
           ,@RuleItemType
           ,@ItemDataSysNo
           ,@RelationType
           ,GETDATE()
           ,@InUser
           ,GETDATE()
           ,@InUser) 
       ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" />
      <param name="@RuleItemType" dbType="AnsiStringFixedLength" />
      <param name="@ItemDataSysNo" dbType="Int32" />
      <param name="@RelationType" dbType="AnsiStringFixedLength" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>
  <!--查询下单时有效或者已完成的商家优惠券活动-->
  <dataCommand name="QueryCouponsByMerchant" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
--活动主信息
SELECT
	c.*
FROM [OverseaECommerceManagement].[dbo].[Coupon] AS c WITH(NOLOCK)
WHERE (c.Status = 'A' OR c.Status = 'F')
	AND c.MerchantSysNo = @MerchantSysNo AND c.BeginDate <= @SODateTime AND c.EndDate >= @SODateTime
--发放规则
SELECT
	cbr.*
FROM [OverseaECommerceManagement].[dbo].[Coupon_BindRules] AS cbr WITH(NOLOCK)
INNER JOIN [OverseaECommerceManagement].[dbo].[Coupon] AS c
	ON c.SysNo = cbr.CouponSysNo
WHERE (c.Status = 'A' OR c.Status = 'F')
	AND c.MerchantSysNo = @MerchantSysNo AND c.BeginDate <= @SODateTime AND c.EndDate >= @SODateTime
--发放规则商品列表
SELECT
	cbri.*
FROM [OverseaECommerceManagement].[dbo].[Coupon_BindRuleItems] AS cbri WITH(NOLOCK)
INNER JOIN [OverseaECommerceManagement].[dbo].[Coupon] AS c
	ON c.SysNo = cbri.CouponSysNo
WHERE (c.Status = 'A' OR c.Status = 'F')
	AND c.MerchantSysNo = @MerchantSysNo AND c.BeginDate <= @SODateTime AND c.EndDate >= @SODateTime
--用户范围
SELECT
	csrc.*
	,Customer.CustomerID
	,Customer.CustomerName
FROM [OverseaECommerceManagement].[dbo].[Coupon_SaleRulesCustomer] AS csrc WITH(NOLOCK)
INNER JOIN [IPP3].[dbo].[Customer] AS Customer WITH(NOLOCK) ON Customer.Sysno = csrc.[CustomerSysNo]
INNER JOIN [OverseaECommerceManagement].[dbo].[Coupon] AS c
	ON c.SysNo = csrc.CouponSysNo
WHERE (c.Status = 'A' OR c.Status = 'F')
	AND c.MerchantSysNo = @MerchantSysNo AND c.BeginDate <= @SODateTime AND c.EndDate >= @SODateTime
     ]]>
    </commandText>
    <parameters>
      <param name="@MerchantSysNo" dbType="Int32" size="20"/>
      <param name="@SODateTime" dbType="DateTime" />
    </parameters>
  </dataCommand>
  <!--创建优惠卷获取记录-->
  <dataCommand name="CreateCouponCodeCustomerLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
INSERT INTO [OverseaECommerceManagement].[dbo].[CouponCode_CustomerLog]
	([CouponSysNo]
	,[CouponCode]
	,[CustomerSysNo]
	,[UserCodeType]
	,[InUser]
	,[SOSysNo]
	,[GetCouponCodeDate]
	,[InDate])
VALUES
	(@CouponSysNo
	,@CouponCode
	,@CustomerSysNo
	,'O'
	,@InUser
	,@SOSysNo
	,GETDATE()
	,GETDATE())
     ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" size="20"/>
      <param name="@CustomerSysNo" dbType="Int32" size="20"/>
      <param name="@SOSysNo" dbType="Int32" size="20"/>
      <param name="@CouponCode" dbType="String" />
      <param name="@InUser" dbType="String" />
    </parameters>
  </dataCommand>
  <!--检查用户这个订单是否已经赠送过优惠券-->
  <dataCommand name="CheckExistCouponCodeCustomerLog" database="MKTService"  commandType="Text">
    <commandText>
      <![CDATA[	
SELECT TOP 1 1  FROM [OverseaECommerceManagement].[dbo].[CouponCode_CustomerLog]
WHERE [CouponSysNo] = @CouponSysNo AND [CustomerSysNo] = @CustomerSysNo AND [SOSysNo] = @SOSysNo
     ]]>
    </commandText>
    <parameters>
      <param name="@CouponSysNo" dbType="Int32" size="20"/>
      <param name="@CustomerSysNo" dbType="Int32" size="20"/>
      <param name="@SOSysNo" dbType="Int32" size="20"/>
    </parameters>
  </dataCommand>

</dataOperations>