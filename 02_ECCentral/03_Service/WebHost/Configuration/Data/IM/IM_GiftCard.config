<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">
  <dataCommand name="GetGiftCardRedeemLogBySoSysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT 
    a.[TransactionNumber] 
   ,a.[Code] 
   ,a.[CustomerSysNo] 
   ,a.[amount] 
   ,a.[ActionSysNo] 
   ,a.[ActionType] 
   ,a.[Status] 
   ,a.[CurrencySysNo] 
   ,a.[InUser] 
   ,a.[InDate] 
   ,a.[EditUser] 
   ,a.[EditDate] 
   ,b.[EndDate] 
   ,b.TotalAmount
	,b.AvailAmount
  ,b.Type
FROM [OverseaECommerceManagement].[dbo].[V_GiftCardRedeemLog] AS a With(NOLOCK)
LEFT JOIN [OverseaECommerceManagement].[dbo].V_GiftCardInfo AS b With(NOLOCK)
    ON b.code=a.code 
WHERE 
    a.Status = @Status
    AND a.[ActionSysNo]=@ActionSysNo 
    AND a.[ActionType]=@ActionType     
ORDER BY b.[EndDate] DESC
      ]]>
    </commandText>
    <parameters>
      <param name="@ActionSysNo" dbType="Int32"/>
      <param name="@ActionType" dbType="AnsiStringFixedLength" size="4"/>
      <param name="@Status" dbType="AnsiStringFixedLength" size="1"/>      
    </parameters>
  </dataCommand>
  <dataCommand name="OperateGiftCard" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
				EXEC OverseaECommerceManagement.dbo.UP_OperateGiftCard
					@Msg,
					@StatusCode output
			]]>
    </commandText>
    <parameters>
      <param name="@Msg" dbType="Xml"/>
      <param name="@StatusCode" dbType="StringFixedLength" size="2" direction="Output"/>
    </parameters>
  </dataCommand>
  <dataCommand name="GetGiftCardInfoByReferenceSOSysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT TOP 1
    [TransactionNumber] 
   ,[Code]  AS [CardCode]
   ,[Password] 
   ,[Barcode] 
   ,[TotalAmount] 
   ,[AvailAmount] 
   ,[CustomerSysNo] 
   ,[BindingCustomerSysNo] 
   ,[BeginDate] 
   ,[EndDate] 
   ,[Type] 
   ,[ReferenceId] 
   ,[ReferenceSOSysNo] 
   ,[InternalType] 
   ,CASE WHEN [Status]='A' THEN 'Valid' WHEN [Status]='D' THEN 'InValid'  ELSE 'Hold' END AS [Status]
   ,[CurrencySysNo] 
   ,[InUser]   AS [InUser.UserName]
   ,[InDate]  
   ,[EditUser] AS [EditUser.UserName]
   ,[EditDate] 

FROM [OverseaECommerceManagement].[dbo].[V_GiftCardInfo] With(NOLOCK)
WHERE 
    [ReferenceSOSysNo]=@ReferenceSOSysNo 
    AND [CustomerSysNo]=@CustomerSysNo 
    AND [InternalType]=@InternalType 
    AND [Type]=@Type     
ORDER BY  [TransactionNumber] DESC
      ]]>
    </commandText>
    <parameters>
      <param name="@ReferenceSOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@InternalType" dbType="Int32"/>
      <param name="@Type" dbType="Int32"/>      
    </parameters>
  </dataCommand>

  <dataCommand name="GetGiftCardInfoBySOSysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT [TransactionNumber] 
   ,[Code]  AS [CardCode]
   ,[Password] 
   ,[Barcode] 
   ,[TotalAmount] 
   ,[AvailAmount] 
   ,[CustomerSysNo] 
   ,[BindingCustomerSysNo] 
   ,[BeginDate] 
   ,[EndDate] 
   ,[Type] 
   ,[ReferenceId] 
   ,[ReferenceSOSysNo] 
   ,[InternalType] 
   ,CASE WHEN [Status]='A' THEN 'Valid' 
         WHEN [Status]='D' THEN 'InValid' 
         WHEN [Status]='V' THEN 'Void'  
         WHEN [Status]='U' THEN 'Used'  
         ELSE 'InValid' END AS [Status]
   ,[CurrencySysNo] 
   ,[InUser]   AS [InUser.UserName]
   ,[InDate]  
   ,[EditUser] AS [EditUser.UserName]
   ,[EditDate] 
FROM [OverseaECommerceManagement].[dbo].[V_GiftCardInfo] With(NOLOCK)
WHERE 
    [ReferenceSOSysNo]=@SOSysNo 
    AND [InternalType]=@InternalType     
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@InternalType" dbType="Int32"/>      
    </parameters>
  </dataCommand>

  <dataCommand name="GetGiftCardsByCodeList" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[			
SELECT [TransactionNumber] 
   ,[Code]  AS [CardCode]
   ,[Password] 
   ,[Barcode] 
   ,[TotalAmount] 
   ,[AvailAmount] 
   ,[CustomerSysNo] 
   ,[BindingCustomerSysNo] 
   ,[BeginDate] 
   ,[EndDate] 
   ,[Type] 
   ,[ReferenceId] 
   ,[ReferenceSOSysNo] 
   ,[InternalType] 
   ,CASE WHEN [Status]='A' THEN 'Valid' WHEN [Status]='D' THEN 'InValid'  ELSE 'Hold' END AS [Status]
   ,[CurrencySysNo] 
   ,[InUser]   AS [InUser.UserName]
   ,[InDate]  
   ,[EditUser] AS [EditUser.UserName]
   ,[EditDate] 
FROM [OverseaECommerceManagement].[dbo].[V_GiftCardInfo] With(NOLOCK)
WHERE 
    [Code] IN (#CodeList#)
      ]]>
    </commandText>
  </dataCommand>
  

<!--bober add-->
  <dataCommand name="GiftCard_QueryGiftCardInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[		
    SELECT @TotalCount = COUNT(1) FROM [OverseaECommerceManagement].[dbo].[GiftCardInfo] B WITH (NOLOCK) 
      LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo C  WITH (NOLOCK)  ON B.BindingCustomerSysNo = C.SysNo
    #StrWhere#

  
SELECT [SysNo] = [TransactionNumber]
      ,[Code] as CardCode
      ,[Password]
      ,[Barcode]
      ,[TotalAmount]
      ,[AvailAmount]
      ,[CustomerSysNo]
      ,[BindingCustomerSysNo]
      ,[BindingCustomerID]
      ,[BeginDate]
      ,[EndDate]
      ,PreEndDate
      ,[Type]
      ,[ReferenceId]
      ,[ReferenceSOSysNo] as SOSysNo
      ,[InternalType] as CardType
      ,[Status]
      ,[CurrencySysNo]
      ,[InUser]
      ,[InDate]
      ,[EditUser]
      ,[EditDate]
      ,[CompanyCode]
      ,[LanguageCode]
      ,[StoreCompanyCode]
      ,IsHold
      ,CustomerID
      ,PeriodAdjustCount = (SELECT COUNT(1) 
      FROM OverseaControlPanel.dbo.V_CP_Sys_Log WITH (NOLOCK) 
      WHERE TicketType=118002 AND TicketSysNo=result.TransactionNumber)
    FROM(SELECT TOP (@EndNumber) ROW_NUMBER() OVER (ORDER BY #SortColumnName#) AS RowNumber,
       B.[TransactionNumber]
      ,B.[Code]
      ,B.[Password]
      ,B.[Barcode]
      ,B.[TotalAmount]
      ,B.[AvailAmount]
      ,B.[CustomerSysNo]
      ,B.[BindingCustomerSysNo]
      ,BindingCustomerID = c.[CustomerID]
      ,B.[BeginDate]
      ,B.[EndDate]
      ,PreEndDate = B.[EndDate]
      ,B.[Type]
      ,B.[ReferenceId]
      ,B.[ReferenceSOSysNo]
      ,B.[InternalType]
      ,B.[Status]
      ,B.[CurrencySysNo]
      ,B.[InUser]
      ,B.[InDate]
      ,B.[EditUser]
      ,B.[EditDate]
      ,B.[CompanyCode]
      ,B.[LanguageCode]
      ,B.[StoreCompanyCode]
      ,B.IsHold
      ,c.CustomerID
  FROM   [OverseaECommerceManagement].[dbo].[GiftCardInfo] B WITH (NOLOCK) 
  LEFT JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c  WITH (NOLOCK) 
    ON B.BindingCustomerSysNo = c.SysNo
    #StrWhere#) result WHERE RowNumber > @StartNumber -- AND RowNumber <= @EndNumber ORDER BY RowNumber 
      ]]>
    </commandText>
  </dataCommand>
  <dataCommand name="GiftCard_GetGiftCardInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
SELECT 
       [SysNo] = [TransactionNumber]
      ,[Code] as CardCode
      ,[Password]
      ,[Barcode]
      ,[TotalAmount]
      ,[AvailAmount]
      ,[CustomerSysNo] as [Customer.CustomerSysNo]
      ,[BindingCustomerSysNo]
      ,(SELECT TOP 1 CustomerID FROM OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c  WITH (NOLOCK)  WHERE  B.BindingCustomerSysNo>0 AND SysNo=B.BindingCustomerSysNo) as [BindingCustomer.BindingCustomerID]
      ,[BeginDate]
      ,[EndDate]
      ,[EndDate] as PreEndDate
      ,[Type]
      ,[ReferenceId]
      ,[ReferenceSOSysNo] as [ReferenceSO.BaseInfo.SysNo]
      ,[InternalType] as CardType
      ,[Status]
      ,[InUser] as [InUser.UserName]
      ,[InDate]
      ,[EditUser] as [EditUser.UserName]
      ,[EditDate]
      ,IsHold
       ,PeriodAdjustCount = (SELECT COUNT(1)  FROM OverseaControlPanel.dbo.V_CP_Sys_Log WITH (NOLOCK) WHERE TicketType=118002 AND TicketSysNo=B.TransactionNumber)
 FROM   [OverseaECommerceManagement].[dbo].[GiftCardInfo] B WITH (NOLOCK)  WHERE TransactionNumber = @SysNo
    ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
<!--导出礼品卡信息-->
  <dataCommand name="GiftCard_GetGiftCardInfoByGiftCardFabricationSysNo" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TransactionNumber, Code,Password,Barcode,TotalAmount  FROM [OverseaECommerceManagement].[dbo].[GiftCardInfo]
      WHERE ReferenceId = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <!--<dataCommand name="GiftCard_ECOperateGiftCard" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      EXEC OverseaECommerceManagement.dbo.UP_OperateGiftCard @Msg,@StatusCode
        ]]>
    </commandText>
    <parameters>
      <param name="@Msg" dbType="Xml"/>
      <param name="@StatusCode" dbType="AnsiStringFixedLength" size="2" direction="Output" />
    </parameters>
  </dataCommand>-->
  <dataCommand name="GiftCard_GetGiftCardOperateLogByCode" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT [TransactionNumber]  as SysNo
            ,[Source] 
            ,[ActionType] 
            ,[Status] 
            ,[Memo] 
            ,[InUser] 
            ,[InDate] 
            ,[Code]              
       FROM   OverseaECommerceManagement.dbo.V_MKT_GiftCardOperateLog Where Code=@Code
       ]]>
    </commandText>
    <parameters>
      <param name="@Code" dbType="String" />
    </parameters>
  </dataCommand>
  <!--操作日志列表-->
  <dataCommand name="GiftCard_GetGiftCardRedeemLogJoinSOMaster" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
--      SELECT 
--		    @TotalCount = COUNT(1) 
--	    FROM OverseaECommerceManagement.dbo.GiftCardRedeemLog g WITH (NOLOCK) 
--		       INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory s  WITH (NOLOCK) 
--			     ON g.ActionSysNo = s.SysNo 
--		       INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c  WITH (NOLOCK) 
--			     ON s.CustomerSysNo = c.SysNo
--	    #StrWhere#

 --     SELECT SysNo = TransactionNumber
 --           ,Code
 --           ,ActionType
 --           ,ActionNO
 --           ,OrderStatus
 --           ,InDate
 --           ,CustomerID
 --           ,EditUser
 --           ,RedeemStatus
 --           ,Amount = amount
 --         FROM(
            
            SELECT
					   g.TransactionNumber
					  ,g.Code
					  ,g.ActionType
					  --,g.ActionSysNo
					  ,ActionSysNo =
					  CASE
						  WHEN g.ActionType IN ('SO','SplitSO') THEN g.ActionSysNo
						  WHEN g.ActionType = 'ROBalance' THEN (SELECT rb.OrgSOSysNo
																  FROM OverseaServiceManagement.dbo.V_SM_ROBalance rb WHERE g.ActionSysNo = rb.SysNo)
						  WHEN g.ActionType = 'RMA' THEN (SELECT rr.SOSysNo
																  FROM OverseaServiceManagement.dbo.V_SM_RMARefundMaster rr WHERE g.ActionSysNo = rr.SysNo)
						ELSE
	    					null
					  END  
					  --,s.Status AS OrderStatus
					  ,OrderStatus = 
					  CASE 
						  WHEN g.ActionType IN ('SO','SplitSO') THEN s.Status
						ELSE null 
					  END 
					  ,g.InDate
					  ,c.CustomerID
					  ,g.EditUser
					  ,g.Amount
            ,g.Status RedeemStatus
            
					 -- ,(ROW_NUMBER() OVER(ORDER BY g.TransactionNumber desc)) AS RowNumber
				FROM  OverseaECommerceManagement.dbo.GiftCardRedeemLog g WITH (NOLOCK) 
					  INNER JOIN OverseaOrderManagement.dbo.V_OM_SO_Master_NoHistory s  WITH (NOLOCK) 
						ON g.ActionSysNo = s.SysNo 
					  INNER JOIN OverseaCustomerManagement.dbo.V_CUM_CustomerBaseInfo c  WITH (NOLOCK) 
						ON s.CustomerSysNo = c.SysNo where Code=@Code order by g.TransactionNumber desc
			--		#StrWhere#) result  WHERE WHERE RowNumber > @StartNumber  AND RowNumber <= @EndNumber ORDER BY RowNumber 
        ]]>
    </commandText>
    <parameters>
      <param name="@Code" dbType="String" />
    </parameters>
  </dataCommand>
  
  <!--礼品卡制作-->

  <dataCommand name="GiftCard_QueryGiftCardFabricationMaster" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
         SELECT @TotalCount = COUNT(1) FROM (SELECT GM.SysNo AS GiftCardFabricationSysNo
			,(CASE WHEN PV.POID IS NOT NULL AND (PV.Status = 4 OR PV.Status = 6 OR PV.Status = 7 OR PV.Status = 8) THEN -2 WHEN PV.POID IS NOT NULL AND (PV.Status = -1 OR PV.Status = 0) THEN -1 ELSE GM.[Status] END) AS [Status]					
			FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] GM WITH(NOLOCK)
			LEFT JOIN (SELECT SUM((CASE WHEN PP.Price=999999 THEN 0 ELSE CONVERT(decimal(30,2), PP.Price) END)) AS TotalPrice, GI.GiftCardFabricationSysNo
			FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK)
			LEFT JOIN IPP3.[dbo].Product PG WITH(NOLOCK) ON GI.ProductSysNo = PG.SysNo
			LEFT JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct PP WITH(NOLOCK) ON PG.SysNo = PP.ProductSysNo
			GROUP BY GI.GiftCardFabricationSysNo) PGP ON PGP.GiftCardFabricationSysNo = GM.SysNo
			LEFT JOIN [OverseaPOASNManagement].[dbo].[V_PM_POMaster] PV WITH(NOLOCK) ON GM.POSysNo = PV.SysNo
    #StrWhere#) GG #StrWhere2#

SELECT TOP (@EndNumber) TT.RowNumber,TT.GiftCardFabricationSysNo as SysNo,
					  TT.Title,
					  TT.POSysNo,
					  TT.Status,
					  TT.InDate,
					  TT.InUser,
					  TT.TotalPrice,
					  TT.POID,
					  TT.InPoDate,
            TT.POStatus
            FROM (
      SELECT ROW_NUMBER() OVER(ORDER BY #SortColumnName#) AS RowNumber,
				     GG.GiftCardFabricationSysNo,
				     GG.Title,
				     GG.POSysNo,
				     GG.Status,
				     GG.InDate,
				     GG.InUser,
				     GG.TotalPrice,
				     GG.POID,
				     GG.InPoDate,
             GG.POStatus 
        FROM (SELECT GM.SysNo AS GiftCardFabricationSysNo
					  ,GM.[Title]
					  ,GM.[POSysNo]
					 ,(CASE WHEN PV.POID IS NOT NULL AND (PV.Status = 4 OR PV.Status = 6 OR PV.Status = 7 OR PV.Status = 8) THEN -2 WHEN PV.POID IS NOT NULL AND (PV.Status = -1 OR PV.Status = 0) THEN -1 ELSE GM.[Status] END) AS [Status]
					  ,GM.[InDate]
					  ,GM.[InUser]
					  ,PGP.TotalPrice
					  ,PV.POID
					  ,PV.CreateTime AS InPoDate
            ,PV.Status AS POStatus
					 FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] GM WITH(NOLOCK)
					 LEFT JOIN (SELECT SUM((CASE WHEN PP.Price=999999 THEN 0 ELSE PP.Price END)*ISNULL(GI.Quantity,0)) AS TotalPrice, GI.GiftCardFabricationSysNo
					  FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK)
					 INNER JOIN IPP3.[dbo].Product PG WITH(NOLOCK) ON GI.ProductSysNo = PG.SysNo AND PG.ProductType = 0 AND PG.Status IN (0,1,2) --AND SUBSTRING(PG.ProductID,1,6) <> 'GC-001' AND PG.ManufacturerSysNo=125--配置时请注意
					 LEFT JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct PP WITH(NOLOCK) ON PG.SysNo = PP.ProductSysNo 
					GROUP BY GI.GiftCardFabricationSysNo) PGP ON PGP.GiftCardFabricationSysNo = GM.SysNo
					LEFT JOIN [OverseaPOASNManagement].[dbo].[V_PM_POMaster] PV WITH(NOLOCK) ON GM.POSysNo = PV.SysNo
          #StrWhere#) GG  #StrWhere3# ) TT WHERE TT.RowNumber > @StartNumber -- AND RowNumber <= @EndNumber ORDER BY RowNumber 
        ]]>
    </commandText>
  </dataCommand>


  <dataCommand name="GiftCard_GetGiftCardFabricationItem" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
        SELECT 
        PG.SysNo AS [Product.SysNo], PG.ProductID as [Product.ProductID],
        (CASE WHEN PP.Price=999999 THEN 0 ELSE CONVERT(decimal(30,2), PP.Price) END) AS [Product.ProductPriceInfo.CurrentPrice],
        PG.ProductDesc as [Product.ProductBasicInfo.ShortDescription.Content],
        ISNULL(GI.Quantity,0) AS Quantity
        ,GI.SysNo AS SysNo,
        '' AS VendorSysNo,PG.PMUserSysNo,@PayPeriodType AS PayTypeSysNo,PG.IsConsign,PG.BriefName,PG.Weight,PP.UnitCost,@ExchangeRate AS ExchangeRate
        FROM
        IPP3.[dbo].Product PG WITH(NOLOCK) 
        INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct PP WITH(NOLOCK) ON PG.SysNo = PP.ProductSysNo
        LEFT JOIN [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK) ON PG.SysNo = GI.ProductSysNo AND GI.GiftCardFabricationSysNo = @GiftCardFabricationSysNo
        WHERE PG.SysNo IN (
        SELECT GI.ProductSysNo
          FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK) WHERE GI.GiftCardFabricationSysNo = @GiftCardFabricationSysNo)
        AND PG.CompanyCode = @CompanyCode AND PG.ProductType = 0 AND PG.Status IN (0,1) AND PG.C3SysNo = @C3SysNo AND PG.ManufacturerSysNo=@ManufacturerSysNo AND substring(PG.ProductID,1,6) <> 'GC-001'
        UNION
        SELECT 
        PG.SysNo AS ProductSysNo, PG.ProductID,(CASE WHEN PP.Price=999999 THEN 0 ELSE CONVERT(decimal(30,2), PP.Price) END) AS CurrentPrice
        ,PG.ProductDesc,0 AS Quantity,0 AS ItemSysNo,'' AS VendorSysNo,PG.PMUserSysNo,@PayPeriodType AS PayTypeSysNo,PG.IsConsign,PG.BriefName,PG.Weight,PP.UnitCost,@ExchangeRate AS ExchangeRate
        FROM
        IPP3.[dbo].Product PG WITH(NOLOCK) 
        INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct PP WITH(NOLOCK) ON PG.SysNo = PP.ProductSysNo
        WHERE PG.SysNo NOT IN (
        SELECT GI.ProductSysNo
          FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK) WHERE GI.GiftCardFabricationSysNo = @GiftCardFabricationSysNo)
        AND PG.CompanyCode = @CompanyCode AND PG.ProductType = 0 AND PG.Status IN (0,1) AND PG.C3SysNo = @C3SysNo AND PG.ManufacturerSysNo=@ManufacturerSysNo AND substring(PG.ProductID,1,6) <> 'GC-001'
        ]]>
    </commandText>
    <parameters>
      <param name="@GiftCardFabricationSysNo" dbType="Int32" />
      <param name="@ManufacturerSysNo" dbType="Int32" />
      <param name="@C3SysNo" dbType="Int32" />
      <param name="@PayPeriodType" dbType="Int32" />
      <param name="@ExchangeRate" dbType="Decimal" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>



  <dataCommand name="GiftCard_GetItemExchangeRate" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
        SELECT [SysNo]
        ,[CurrencyID]
        ,[CurrencyName]
        ,[CurrencySymbol]
        ,[IsLocal]
        ,[ExchangeRate]
        ,[ListOrder]
        ,[Status]
        FROM OverseaControlPanel.dbo.V_CP_Currency WITH(NOLOCK)
        WHERE  sysno=@CurrencySysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@CurrencySysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GiftCard_GetItemPayTypeSysNo" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
        SELECT PayPeriodType
        FROM OverseaPOASNManagement.dbo.V_PM_VendorList WITH(NOLOCK)
        WHERE SysNo=@VendorSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@VendorSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  <dataCommand name="GiftCard_GetGiftCardFabricationItemSum" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
SUM((CASE WHEN TT.Price=999999 THEN 0 ELSE CONVERT(decimal(30,2), TT.Price) END)* CONVERT(decimal(30), ISNULL(TT.Quantity,0))) AS TotalPrice,
SUM(CONVERT(decimal(30),ISNULL(TT.Quantity,0))) AS TotalCount,TT.GiftCardFabricationSysNo  FROM (
SELECT PP.Price,GI.SysNo,GI.GiftCardFabricationSysNo,GI.ProductSysNo,
GI.Quantity
  FROM [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] GI WITH(NOLOCK)
 INNER JOIN IPP3.[dbo].Product PG WITH(NOLOCK) ON GI.ProductSysNo = PG.SysNo AND PG.ProductType = 0 AND PG.Status IN (0,1,2) 
 --AND SUBSTRING(PG.ProductID,1,6) <> 'GC-001' AND PG.CompanyCode=@CompanyCode AND PG.ManufacturerSysNo=@ManufacturerSysNo AND C3SysNo=@C3SysNo
 LEFT JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct PP WITH(NOLOCK) ON PG.SysNo = PP.ProductSysNo )TT
 WHERE TT.GiftCardFabricationSysNo = @GiftCardFabricationSysNo
GROUP BY TT.GiftCardFabricationSysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@GiftCardFabricationSysNo" dbType="Int32" />
      <param name="@ManufacturerSysNo" dbType="Int32" />
      <param name="@C3SysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>
<!--导出制卡后更新状态-->
  <dataCommand name="GiftCard_UpdateGiftCardInfoStatus" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] SET Status=1,EditUser=@EditUser,EditDate=GETDATE() WHERE SysNo = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
    </parameters>
  </dataCommand>
  <!--更新-->

  <dataCommand name="GiftCard_UpdateGiftCardFabricationMaster" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] SET Title=@Title,EditUser=@EditUser,EditDate=GETDATE() WHERE SysNo = @SysNo AND CompanyCode=@CompanyCode
       ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Title" dbType="String"/>
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_UpdateGiftCardFabricationItem" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
     IF EXISTS(SELECT TOP 1 1 FROM OverseaContentManagement.dbo.GiftCardFabrication_Item WITH(NOLOCK)
                  WHERE GiftCardFabricationSysNo=@MasterSysNo AND SysNo=@SysNo AND ProductSysNo=@Product_SysNo)
	    BEGIN  
          UPDATE OverseaContentManagement.dbo.GiftCardFabrication_Item
			    SET Quantity=@Quantity,
			    EditUser=@EditUser,
			    EditDate=GETDATE()
			    WHERE GiftCardFabricationSysNo=@MasterSysNo AND SysNo=@SysNo AND ProductSysNo=@Product_SysNo
       END
	    ELSE
	    BEGIN   
           INSERT INTO OverseaContentManagement.dbo.GiftCardFabrication_Item
                (GiftCardFabricationSysNo
                ,ProductSysNo
                ,Quantity
                ,InDate
                ,InUser
                ,EditDate
                ,EditUser)
        VALUES  (@MasterSysNo
                ,@Product_SysNo
                ,@Quantity
                ,GETDATE()
                ,@EditUser
                ,GETDATE()
                ,@EditUser)
       END 
        ]]>
    </commandText>
    <parameters>
      <param name="@Product_SysNo" dbType="Int32"/>
      <param name="@MasterSysNo" dbType="Int32"/>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_DeleteGiftCardFabrications" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] SET Status=-1,EditUser=@EditUser,EditDate=GETDATE()
      WHERE SysNo = @SysNo
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@EditUser" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_CreatePOGiftCardFabrication" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE [OverseaContentManagement].[dbo].[GiftCardFabrication_Master] SET POSysNo=@POSysNo,EditUser=@EditUser,EditDate=GETDATE() 
      WHERE SysNo = @SysNo AND CompanyCode=@CompanyCode
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@POSysNo" dbType="Int32" />
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_InsertGiftCardFabricationMaster" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
     INSERT INTO [OverseaContentManagement].[dbo].[GiftCardFabrication_Master]
           ([Title]
           ,[Status]
           ,[InDate]
           ,[InUser]
           ,[EditDate]
           ,[EditUser]
           ,[CompanyCode]
           )
     VALUES
           (@Title
           ,0
           ,GETDATE()
           ,@EditUser
           ,GETDATE()
           ,@EditUser
           ,@CompanyCode)
           
         SELECT @SysNo = SCOPE_IDENTITY()
        ]]>
    </commandText>
    <parameters>
      <param name="@Title" dbType="String"/>
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@SysNo" dbType="Int32" size="10" direction="Output"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_InsertGiftCardFabricationItem" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
 INSERT INTO [OverseaContentManagement].[dbo].[GiftCardFabrication_Item]
           ([GiftCardFabricationSysNo]
           ,[ProductSysNo]
           ,[Quantity]
           ,[InDate]
           ,[InUser]
           ,[EditDate]
           ,[EditUser])
     VALUES
           (@MasterSysNo
           ,@Product_SysNo --ProductSysNo
           ,@Quantity
           ,GETDATE()
           ,@EditUser
           ,GETDATE()
           ,@EditUser)
        ]]>
    </commandText>
    <parameters>
      <param name="@Product_SysNo" dbType="Int32"/>
      <param name="@MasterSysNo" dbType="Int32" />
      <param name="@Quantity" dbType="Int32" />
      <param name="@EditUser" dbType="String" property="[UserAcct]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetPassGiftCardInfo" database="IMService"  commandType="Text">
    <commandText>
      <![CDATA[
        SELECT SUM(TotalAmount) AS TotalPass FROM [OverseaECommerceManagement].[dbo].[GiftCardInfo] WHERE ReferenceId = @SysNo--COUNT(Code)
        ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetGiftVoucherProductInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(1)
		  FROM
		  OverseaECommerceManagement.dbo.GiftVoucherProduct WITH(NOLOCK)
		  #StrWhere#

		  SELECT
		  SysNo
		  ,ID
		  ,ProductSysNo
      ,ProductID
		  ,Price
		  ,Status
		  ,CreateUser
		  ,CreateDate
		  ,AuditUser
		  ,AuditDate
		  ,EditUser
		  ,EditDate
      ,ProductID
      ,ProductName
		  FROM
		  (
		  SELECT TOP (@EndNumber) 
		  GP.SysNo
		  ,GP.ID
		  ,GP.ProductSysNo
		  ,GP.Price
		  ,GP.Status
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.CreateUser) as CreateUser
		  ,GP.CreateDate
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.AuditUser) as AuditUser
		  ,GP.AuditDate
      ,(select
      DisplayName      
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.EditUser) as EditUser
		  ,GP.EditDate
      ,P.ProductID
      ,P.ProductName
		  ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
		  FROM 
		  OverseaECommerceManagement.dbo.GiftVoucherProduct AS GP WITH(NOLOCK)
      INNER JOIN IPP3.dbo.Product AS P WITH(NOLOCK)
		  ON GP.ProductSysNo = P.SysNo
		  #StrWhere#
		  ) AS RESULT
		  WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GiftCard_SaveGiftVoucherProductInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      BEGIN TRY
      BEGIN TRANSACTION
      
      INSERT INTO OverseaECommerceManagement.dbo.GiftVoucherProduct
      (
      ProductSysNo
      ,ProductID
      ,Price
      ,Status
      ,CreateUser
      ,CreateDate
      )
      VALUES
      (
      @ProductSysNo
      ,@ProductID
      ,@Price
      ,@Status
      ,@CreateUser
      ,GETDATE()
      )
      
      SELECT @@IDENTITY;
      
      COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      ROLLBACK TRANSACTION
      END CATCH
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@ProductID" dbType="String" />
      <param name="@Price" dbType="Decimal" />
      <param name="@Status" dbType="Int32" />
      <param name="@CreateUser" dbType="Int32" property="[UserSysNo]"/>
    </parameters>
  </dataCommand>
  
  <dataCommand name="GiftCard_GetGiftVoucherProductBySysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      GVP.SysNo
      ,GVP.ID
      ,GVP.ProductSysNo
      ,GVP.ProductID
      ,CONVERT(Decimal(20,2),GVP.Price) AS Price
      ,GVP.Status
      ,GVP.CreateUser
      ,GVP.CreateDate
      ,GVP.AuditUser
      ,GVP.AuditDate
      ,GVP.EditUser
      ,GVP.EditDate
      FROM 
      OverseaECommerceManagement.dbo.GiftVoucherProduct  AS GVP WITH(NOLOCK)
      WHERE GVP.SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetGiftVoucherProductRelationByVoucherSysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
      VR.SysNo
      ,VR.GiftVoucherSysNo
      ,VR.ProductSysNo
      ,VR.Status
      ,VR.CreateUser
      ,VR.CreateDate
      ,(SELECT Top 1 TYPE FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS TYPE
       ,(SELECT Top 1 AuditStatus FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS AuditStatus
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelation AS VR WITH(NOLOCK)
       WHERE GiftVoucherSysNo = @GiftVoucherSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@GiftVoucherSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetGiftVoucherProductRelationByReqeust" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
      VR.SysNo
      ,VR.GiftVoucherSysNo
      ,VR.ProductSysNo
      ,VR.Status
      ,VR.CreateUser
      ,VR.CreateDate
      ,(SELECT Top 1 TYPE FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS TYPE
       ,(SELECT Top 1 AuditStatus FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS AuditStatus
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelation AS VR WITH(NOLOCK)
       INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
       ON VR.SysNo = VRR.RelationSysNo
       WHERE VRR.SysNo = @RequestSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@RequestSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetVoucherRelationByVoucherPaging" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(1)
		  FROM
		  OverseaECommerceManagement.dbo.GiftVoucherProductRelation WITH(NOLOCK)
		  #StrWhere#
      
		  SELECT 
      SysNo
      ,GiftVoucherSysNo
      ,ProductSysNo
      ,Status
      ,CreateUser
      ,CreateDate
      ,Type
      ,AuditStatus
		  FROM
		  (
		  SELECT TOP (@EndNumber) 
      VR.SysNo
      ,VR.GiftVoucherSysNo
      ,VR.ProductSysNo
      ,VR.Status
      ,VR.CreateUser
      ,VR.CreateDate
      ,(SELECT Top 1 TYPE FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS Type
       ,(SELECT Top 1 AuditStatus FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS VRR WITH(NOLOCK)
      WHERE VRR.RelationSysNo = VR.SysNo
       ORDER BY VRR.CreateDate DESC) AS AuditStatus
      ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelation AS VR WITH(NOLOCK)
       #StrWhere#
		  ) AS RESULT
		  WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GiftCard_GetVoucherRelationRequestByRelationPaging" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount = COUNT(1)
		  FROM
		  OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS GP WITH(NOLOCK)
      INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProductRelation AS GV WITH(NOLOCK)
       ON GP.RelationSysNo = GV.SysNo
       INNER JOIN IPP3.dbo.Product AS P WITH(NOLOCK)
       ON P.SysNo = GV.ProductSysNo
		  #StrWhere#
      
		  SELECT 
      SysNo
      ,RelationSysNo
      ,ProductID
      ,ProductName
      ,Type
      ,AuditStatus
      ,CreateUser
      ,CreaterName
      ,CreateDate
      ,AuditUser
      ,AuditerName
      ,AuditDate
		  FROM
		  (
		  SELECT TOP (@EndNumber) 
      GP.SysNo
      ,GP.RelationSysNo
      ,P.ProductID
      ,P.ProductName
      ,GP.Type
      ,GP.AuditStatus
      ,GP.CreateUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.CreateUser) as CreaterName
      ,GP.CreateDate
      ,GP.AuditUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.AuditUser) as AuditerName
      ,GP.AuditDate
      ,(ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber 
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS GP WITH(NOLOCK)
       INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProductRelation AS GV WITH(NOLOCK)
       ON GP.RelationSysNo = GV.SysNo
       INNER JOIN IPP3.dbo.Product AS P WITH(NOLOCK)
       ON P.SysNo = GV.ProductSysNo
       #StrWhere#
		  ) AS RESULT
		  WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="GiftCard_GetVoucherRelationRequestByRelationSysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
      SysNo
      ,RelationSysNo
      ,Type
      ,AuditStatus
      ,CreateUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.CreateUser) as CreaterName
      ,CreateDate
      ,AuditUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.AuditUser) as AuditerName
      ,AuditDate
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS GP WITH(NOLOCK)
       WHERE RelationSysNo= @RelationSysNo
       ORDER BY SysNo DESC
      ]]>
    </commandText>
    <parameters>
      <param name="@RelationSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_GetVoucherRelationRequestBySysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT 
      SysNo
      ,RelationSysNo
      ,Type
      ,AuditStatus
      ,CreateUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.CreateUser) as CreaterName
      ,CreateDate
      ,AuditUser
      ,(select
      DisplayName
      from OverseaArchitecture.dbo.V_AR_UserInfo as ul (nolock)
      where ul.UserSysNo = GP.AuditUser) as AuditerName
      ,AuditDate
       FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest AS GP WITH(NOLOCK)
       WHERE SysNo= @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  
  <dataCommand name="GiftCard_UpdateGiftVoucherProduct" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      BEGIN TRY
      BEGIN TRANSACTION
      
      UPDATE OverseaECommerceManagement.dbo.GiftVoucherProduct
        SET Status = @Status
        ,Price = @Price
        ,ProductSysNo = @ProductSysNo
        ,EditUser = @EditUser
        ,EditDate = GETDATE()
        WHERE SysNo = @SysNo
      IF @Status = 2
      BEGIN
        UPDATE OverseaECommerceManagement.dbo.GiftVoucherProduct
        SET AuditUser = @AuditUser,AuditDate = GETDATE()
        WHERE SysNo = @SysNo
      END
      COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      ROLLBACK TRANSACTION
      END CATCH
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Price" dbType="Decimal" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@ProductID" dbType="String" />
      <param name="@Status" dbType="Int32" />
      <param name="@EditUser" dbType="Int32" property="[UserSysNo]"/>
      <param name="@AuditUser" dbType="Int32" property="[UserSysNo]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_SaveGiftVoucherRelationInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      BEGIN TRY
      BEGIN TRANSACTION
      
      UPDATE IPP3.dbo.Product_Ex
      SET GiftVoucherType = @GiftVoucherType
      WHERE SysNo = @ProductSysNo
      
      INSERT INTO OverseaECommerceManagement.dbo.GiftVoucherProductRelation
      (
      GiftVoucherSysNo
      ,ProductSysNo
      ,Status
      ,CreateUser
      ,CreateDate
      )
      VALUES
      (
      @GiftVoucherSysNo
      ,@ProductSysNo
      ,@Status
      ,@CreateUser
      ,GETDATE()
      )
      SELECT @@IDENTITY;
      COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      ROLLBACK TRANSACTION
      END CATCH
      ]]>
    </commandText>
    <parameters>
      <param name="@GiftVoucherSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@GiftVoucherType" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" />
      <param name="@CreateUser" dbType="Int32" property="[UserSysNo]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_SaveGiftVoucherRelationRequestInfo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      
      INSERT INTO OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest
      (
      RelationSysNo
      ,Type
      ,AuditStatus
      ,CreateUser
      ,CreateDate
      )
      VALUES
      (
      @RelationSysNo
      ,@Type
      ,@AuditStatus
      ,@CreateUser
      ,GETDATE()
      )
      ]]>
    </commandText>
    <parameters>
      <param name="@RelationSysNo" dbType="Int32" />
      <param name="@Type" dbType="Int32" />
      <param name="@AuditStatus" dbType="AnsiStringFixedLength" />
      <param name="@CreateUser" dbType="Int32" property="[UserSysNo]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_DeleteGiftVoucherRelationByRelation" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      BEGIN TRY
      BEGIN TRANSACTION
      UPDATE IPP3.dbo.Product_Ex
      SET GiftVoucherType = 0
      WHERE SysNo IN (
      SELECT ProductSysNo FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelation
      WHERE SysNo = @RelationSysNo
      )
      
      DELETE OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest
      WHERE RelationSysNo = @RelationSysNo
      DELETE OverseaECommerceManagement.dbo.GiftVoucherProductRelation
      WHERE SysNo = @RelationSysNo
      COMMIT TRANSACTION
      END TRY
      BEGIN CATCH
      ROLLBACK TRANSACTION
      END CATCH
      
      ]]>
    </commandText>
    <parameters>
      <param name="@RelationSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="UpdateProductGiftVoucherType" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE IPP3.dbo.Product_Ex
      SET GiftVoucherType = @GiftVoucherType
      WHERE SysNo = @ProductSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@GiftVoucherType" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="IsExistsSameRelationProduct" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT COUNT(1) FROM OverseaECommerceManagement.dbo.GiftVoucherProductRelation WITH(NOLOCK)
      WHERE ProductSysNo = @ProductSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
  

  <dataCommand name="GiftCard_DeleteGiftVoucherRelationRequestByRelation" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      DELETE OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest
      WHERE RelationSysNo = @RelationSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@RelationSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_DeleteGiftVoucherRelationBySysNo" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      DELETE OverseaECommerceManagement.dbo.GiftVoucherProductRelation
      WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  

  <dataCommand name="GiftCard_UpdateGiftVoucherRelationRequestStatus" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE OverseaECommerceManagement.dbo.GiftVoucherProductRelationRequest
      SET AuditStatus = @AuditStatus,AuditUser = @AuditUser,AuditDate = GETDATE()
      WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@AuditStatus" dbType="AnsiStringFixedLength" size="1" />
      <param name="@AuditUser" dbType="Int32" property="[UserSysNo]"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GiftCard_UpdateGiftVoucherRelationStatus" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE OverseaECommerceManagement.dbo.GiftVoucherProductRelation
      SET Status = @Status
      WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@Status" dbType="AnsiStringFixedLength" size="1" />
    </parameters>
  </dataCommand>

<dataCommand name="GiftVoucherProduct_IsExistSameProduct" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1 1
      FROM OverseaECommerceManagement.dbo.GiftVoucherProduct WITH(NOLOCK)
      WHERE ProductSysNo = @ProductSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="GiftVoucherProduct_IsExistSamePrice" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1 1
      FROM OverseaECommerceManagement.dbo.GiftVoucherProduct WITH(NOLOCK)
      WHERE Price = @Price AND SysNo != @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@Price" dbType="Decimal" />
      <param name="@SysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

<dataCommand name="GiftVoucherProduct_GetFabricationItem" database="IMService" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT
      ISNULL(GI.SysNo,0) AS SysNo
      ,P.SysNo AS [Product.SysNo]
      ,P.ProductID AS [Product.ProductID]
      ,P.ProductDesc AS [Product.ProductBasicInfo.ShortDescription.Content]
      ,GVP.Price
      ,P.PMUserSysNo
      ,P.IsConsign
      ,ISNULL(GI.Quantity,0) AS Quantity
      ,(CASE WHEN PP.Price=999999 THEN 0 ELSE CONVERT(decimal(30,2), PP.Price) END) AS [Product.ProductPriceInfo.CurrentPrice]
      FROM OverseaECommerceManagement.dbo.GiftVoucherProduct AS GVP  WITH(NOLOCK)
      INNER JOIN IPP3.dbo.Product AS P WITH(NOLOCK)
      ON P.SysNo = GVP.ProductSysNo AND GVP.Status = 2
      INNER JOIN OverseaECommerceManagement.dbo.GiftVoucherProduct AS PP WITH(NOLOCK)
      ON PP.ProductSysNo = P.SysNo
      LEFT JOIN [OverseaContentManagement].[dbo].[GiftCardFabrication_Item] AS GI WITH(NOLOCK) 
      ON P.SysNo = GI.ProductSysNo AND GI.GiftCardFabricationSysNo = @GiftCardFabricationSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@GiftCardFabricationSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

</dataOperations>
