<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.newegg.com/DataOperation">

  <dataCommand name="Customer_GetCustomerInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT cus.SysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
				cus.IsEmailConfirmed,
				cus.Pwd as Password,
				cus.RegisterTime,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment,
				cus.Birthday,
				cus.FromLinkSource,
        (select top 1 1 
			from [Ecommerce].[dbo].[Customer_CellPhoneConfirm] cpc (nolock) 
			where cpc.CustomerSysNo=cus.sysno and cpc.Status=1) as IsPhoneValided,
				cus.CompanyCustomer,
				cus.NewPassword,
				cus.PasswordSalt,
				cus.Status,
				cus.Gender,
        cus.CellPhone,
        cus.DwellAreaSysNo,
        cus.DwellAddress,
        cus.DwellZip,
        cus.Phone,
        cus.ReceiveAreaSysNo,
        cus.ValidPrepayAmt,
        cus.ValidScore,
        ISNULL(cp.Status,0) AS IsPhoneValided,
			--	@isGoldAccount AS IsGoldAccount,
        ISNULL(tpu.UserSource,'None') AS DBSourceType,
        ISNULL(ext.LastPayTypeSysNo,0) AS [ExtendInfo.LastPayTypeSysNo]
			FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)
      LEFT JOIN [Ecommerce].[dbo].[ThirdPartyUser] tpu WITH(NOLOCK)
        ON cus.SysNo = tpu.CustomerSysNo 
      LEFT JOIN Ecommerce.dbo.Customer_CellPhoneConfirm cp WITH(NOLOCK)
        ON cp.CustomerSysNo=cus.SysNo AND cus.CellPhone=cp.CellPhone AND cp.Status=1
      LEFT JOIN ipp3.dbo.Customer_Extend ext WITH(NOLOCK)
        ON ext.CustomerSysno=cus.Sysno
			WHERE cus.SysNo=@CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_GetCustomerInfoCenterDB" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT cus.SysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
				cus.IsEmailConfirmed,
				cus.Pwd as Password,
				cus.RegisterTime,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment,
				cus.Birthday,
				cus.FromLinkSource,
        (select top 1 1 
			from [Ecommerce].[dbo].[Customer_CellPhoneConfirm] cpc (nolock) 
			where cpc.CustomerSysNo=cus.sysno and cpc.Status=1) as IsPhoneValided,
				cus.CompanyCustomer,
				cus.NewPassword,
				cus.PasswordSalt,
				cus.Status,
				cus.Gender,
        cus.CellPhone,
        cus.DwellAreaSysNo,
        cus.DwellAddress,
        cus.DwellZip,
        cus.Phone,
        cus.ReceiveAreaSysNo,
        cus.ValidPrepayAmt,
        cus.ValidScore,
        ISNULL(cp.Status,0) AS IsPhoneValided,
			--	@isGoldAccount AS IsGoldAccount,
        ISNULL(tpu.UserSource,'None') AS DBSourceType,
        ISNULL(ext.LastPayTypeSysNo,0) AS [ExtendInfo.LastPayTypeSysNo]
			FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)
      LEFT JOIN [Ecommerce].[dbo].[ThirdPartyUser] tpu WITH(NOLOCK)
        ON cus.SysNo = tpu.CustomerSysNo 
      LEFT JOIN Ecommerce.dbo.Customer_CellPhoneConfirm cp WITH(NOLOCK)
        ON cp.CustomerSysNo=cus.SysNo AND cus.CellPhone=cp.CellPhone AND cp.Status=1
      LEFT JOIN ipp3.dbo.Customer_Extend ext WITH(NOLOCK)
        ON ext.CustomerSysno=cus.Sysno
			WHERE cus.SysNo=@CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_GetCustomerByEmail" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 cus.SysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment
			FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)
			WHERE UPPER(cus.Email) = UPPER(@Email)
			--AND cus.LanguageCode = @LanguageCode
			--AND cus.CompanyCode = @CompanyCode
			--AND cus.StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@Email" direction="Input" size="50"/>
      <!--<param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>-->
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetCustomerByPhoneForCheck" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 cus.SysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment
			FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)
			WHERE cus.CellPhone= @PhoneNumber
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@PhoneNumber" direction="Input" size="50"/>
    </parameters>
  </dataCommand>

  <!--获取手机用户绑定来验证手机是否已被绑定-->
  <dataCommand name="Customer_GetCustomerConfirmByPhoneForCheck" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1000 [SysNo]
            ,[CustomerSysNo]
            ,[CellPhone]
            ,[ConfirmKey]
            ,[Status]
            ,[CreateDate]
            ,[CompanyCode]
            ,[StoreCompanyCode]
            ,[LanguageCode]
        FROM [Ecommerce].[dbo].[Customer_CellPhoneConfirm]
        where CellPhone=@PhoneNumber and [Status]=1 and CustomerSysNo!=0
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@PhoneNumber" direction="Input" size="50"/>
    </parameters>
  </dataCommand>
  
  <dataCommand name="Customer_GetCustomerLastLoginDate" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 LastLoginDate FROM IPP3.dbo.Customer WITH (NOLOCK)  WHERE  SysNo=@CustomerSysNo 
			    AND LanguageCode = @LanguageCode
			    AND CompanyCode = @CompanyCode
			    AND StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_IsExistCustomer" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 1 FROM [IPP3].[dbo].[Customer] WITH (NOLOCK) WHERE CustomerID=@CustomerID
			    AND LanguageCode = @LanguageCode
			    AND CompanyCode = @CompanyCode
			    AND StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_IsExistsEmail" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT TOP 1 1  FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)  WHERE cus.Email=@Email  AND cus.SysNo<>@SysNo
			    AND cus.LanguageCode = @LanguageCode
			    AND cus.CompanyCode = @CompanyCode
			    AND cus.StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@Email" direction="Input" size="50"/>
      <param dbType="Int32" name="@SysNo" direction="Input" size="4"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_CheckCustomerData" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT * FROM IPP3.dbo.Customer  WHERE CustomerID=@CustomerID AND Email=@Email
			    AND LanguageCode = @LanguageCode
			    AND CompanyCode = @CompanyCode
			    AND StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" size="50"/>
      <param dbType="String" name="@Email" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetPasswordTokenInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			 IF @TokenType = 'P'
        BEGIN 
          SELECT TOP 1 [CustomerSysNo],TokenType
			          FROM [OverseaCustomerManagement].[dbo].[Customer_PasswordToken] WITH(NOLOCK)
			          WHERE Token=@Token AND status='A' AND [Indate]>DATEADD(hh, -1, getdate())
			          AND LanguageCode = @LanguageCode
			          AND CompanyCode = @CompanyCode
			          AND StoreCompanyCode = @StoreCompanyCode
        END
        ELSE
        BEGIN 
          SELECT TOP 1 [CustomerSysNo],TokenType
			          FROM [OverseaCustomerManagement].[dbo].[Customer_PasswordToken]  WITH(NOLOCK)
			          WHERE Token=@Token AND status='A' AND [Indate]>DATEADD(DAY, -1, getdate())
			          AND LanguageCode = @LanguageCode
			          AND CompanyCode = @CompanyCode
			          AND StoreCompanyCode = @StoreCompanyCode
        END
			]]>
    </commandText>
    <parameters>
      <param dbType="AnsiString" name="@Token" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@TokenType" dbType="AnsiStringFixedLength" size="1"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetCustomerPasswordTokenInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			 IF @TokenType = 'P'
        BEGIN 
          SELECT TOP 1 CustomerSysNo,TokenType,Token
			          FROM  ECCMS_Customer.dbo.Customer_PasswordToken WITH(NOLOCK)
			          WHERE CustomerSysNo=@CustomerSysNo AND status='A' AND [Indate]>DATEADD(hh, -1, getdate())
        END
        ELSE
        BEGIN 
          SELECT TOP 1 [CustomerSysNo],TokenType,Token
			          FROM  ECCMS_Customer.dbo.Customer_PasswordToken WITH(NOLOCK)
			          WHERE CustomerSysNo=@CustomerSysNo AND status='A' AND [Indate]>DATEADD(DD, -7, getdate())
        END
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="50"/>
      <param name="@TokenType" dbType="AnsiStringFixedLength" size="1"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_IsExistsPhone" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT TOP 1 1  FROM [IPP3].[dbo].[Customer] cus WITH(NOLOCK)  
          WHERE cus.CellPhone = @CellPhone
			    AND cus.LanguageCode = @LanguageCode
			    AND cus.CompanyCode = @CompanyCode
			    AND cus.StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CellPhone" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>


  <dataCommand name="Customer_GetCustomerByPhone" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      
			SELECT cus.SysNo as CustomerSysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
				cus.Pwd as Password,
				cus.RegisterTime,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment,
				cus.Birthday,
				cus.FromLinkSource,
				cus.CompanyCustomer,
				cus.NewPassword,
				cus.PasswordSalt,
        cus.ReceiveAreaSysNo,
				cus.Status,
        cus.CellPhone
			FROM IPP3.dbo.Customer cus WITH (NOLOCK) 
			WHERE cus.CellPhone = @CellPhone
				AND cus.LanguageCode = @LanguageCode
				AND cus.CompanyCode = @CompanyCode
				AND cus.StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CellPhone" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>


  <dataCommand name="Customer_GetCustomerByID" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      
			SELECT cus.SysNo,
				cus.CustomerID,
				cus.CustomerName,
				cus.Email,
        cus.IsEmailConfirmed,
				cus.Pwd as Password,
				cus.RegisterTime,
				cus.Rank AS CustomerRank,
				cus.IsAllowComment,
				cus.Birthday,
				cus.FromLinkSource,
				cus.CompanyCustomer,
				cus.NewPassword,
				cus.PasswordSalt,
        cus.ReceiveAreaSysNo,
				cus.Status,
        cus.CellPhone,
        (SELECT TOP 1 1 
			   FROM [Ecommerce].[dbo].[Customer_CellPhoneConfirm] cpc (nolock) 
			   WHERE cpc.CustomerSysNo=cus.sysno and cpc.Status=1
        ) as IsPhoneValided
			FROM IPP3.dbo.Customer cus WITH (NOLOCK) 
			WHERE cus.CustomerID = @CustomerID
				AND cus.LanguageCode = @LanguageCode
				AND cus.CompanyCode = @CompanyCode
				AND cus.StoreCompanyCode = @StoreCompanyCode
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" size="50"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetCustomerPasswordSalt" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 PasswordSalt FROM [IPP3].[dbo].[Customer] WITH(NOLOCK) WHERE CustomerID=@CustomerID
      ]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" />
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetCustomerEncryptMeta" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT TOP 1 PasswordSalt, EncryptMode FROM [IPP3].[dbo].[Customer] WHERE CustomerID=@CustomerID      ]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" />
    </parameters>
  </dataCommand>
  
  <dataCommand name="Customer_CustomerLogin" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1  [Rank] as CustomerRank,* FROM [IPP3].[dbo].[Customer] WITH(NOLOCK) WHERE CustomerID=@CustomerID AND Pwd=@Password And Status <> 1
      ]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@CustomerID" direction="Input" />
      <param dbType="String" name="@Password" direction="Input" />
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_IsCustomerPhoneValided" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 1 FROM Ecommerce.dbo.Customer_CellPhoneConfirm  A WITH(NOLOCK)
			INNER JOIN IPP3.dbo.Customer B WITH(NOLOCK) 
			ON A.CustomerSysNo = B.SysNo AND A.CellPhone = B.CellPhone
			 WHERE   A.CustomerSysNo = @CustomerSysNo 
				AND B.Status = 0 
        AND A.Status=1
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Favorite_GetRecentListCount" database="Read" commandType="Text" >
    <commandText>
      <![CDATA[
          SELECT count(1) as RecordCount
					FROM IPP3.dbo.WishList w WITH(NOLOCK)
					INNER JOIN IPP3.dbo.Product p WITH(NOLOCK) on w.ProductSysNo=p.SysNo
					WHERE p.Status = 1
					AND w.CreateTime>=DATEADD(DAY,-@Day,GETDATE())
					AND w.CustomerSysNo=@SysNo 
		]]>
    </commandText>
    <parameters>
      <param dbType ="Int32" name="@SysNo" direction="Input" size="4"/>
      <param dbType ="Int32" name="@Day" direction="Input" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Favorite_GetWishListByCustomerID" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
DECLARE @WhereSql NVARCHAR(2000)
DECLARE @CountSql NVARCHAR(MAX)   
DECLARE @SelectSql NVARCHAR(MAX)
  
IF @SortType = 'Ascending' SET @SortType = 'ASC'
ELSE IF @SortType = 'Descending' SET @SortType = 'DESC'

SET @WhereSql = N'WHERE p.Status in (1,0)  and CustomerSysNo = @CustomerSysNo '
  
IF (len(@ProductName) > 0) 
BEGIN
	set @ProductName=N'%'+@ProductName+'%'
	SET @WhereSql = @WhereSql + N' AND p.ProductName like @ProductName'
END 

BEGIN
  SET @CountSql = N'SELECT @TotalCount = COUNT(1) 
  FROM IPP3.dbo.WishList w WITH(NOLOCK)
  INNER JOIN IPP3.dbo.Product p WITH(NOLOCK) on w.ProductSysNo=p.SysNo
  INNER JOIN IPP3.dbo.Product_Price pp WITH(NOLOCK) on w.ProductSysNo=pp.ProductSysNo
  LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 i WITH(NOLOCK) on w.ProductSysNo=i.ProductSysNo
  ' + @WhereSql

  EXEC SP_EXECUTESQL @CountSql 
  			  ,N'@CustomerSysNo INT
			  ,@ProductName VARCHAR(50)
  			  ,@TotalCount INT OUTPUT'
              ,@CustomerSysNo
  			  ,@ProductName
  			  ,@TotalCount OUTPUT  
             
  --Check @CurrentPageIndex
  DECLARE @MyTempIndex INT
  DECLARE @MyModeNumber INT
  SET @MyTempIndex = @TotalCount/@PageSize
  SET @MyModeNumber = @TotalCount%@PageSize

  IF @MyModeNumber <> 0 
	  SET @MyTempIndex = @MyTempIndex + 1
  IF @CurrentPageIndex > @MyTempIndex 
	  SET @CurrentPageIndex = @MyTempIndex

  SET @SelectSql = N'SELECT TOP (@PageSize) TT.[SysNo]
						    ,TT.[CustomerSysNo]
						    ,TT.[CreateTime]
						    ,TT.ProductSysNo
							,TT.ProductID
							,TT.ProductName
						    ,TT.BriefName
                            ,TT.ProductStatus
							,TT.CurrentPrice
							,TT.BasicPrice
							,TT.QuantityForSale
							,TT.ProductTitle
							,TT.PromotionTitle
							,TT.IsHaveValidGift
							,TT.RemarkCount 
							,TT.RemarkScore
							,TT.Weight
							,TT.CashRebate
							,TT.PointType
							,TT.ImageVersion
							,TT.DefaultImage
              ,TT.Mincountperorder
					    FROM (SELECT ROW_NUMBER() OVER (ORDER BY ' + @SortField + N' ' + @SortType + N' ) AS RowNumber
			      	,w.[SysNo]
						  ,w.[CustomerSysNo]
						  ,w.[ProductSysNo]
						  ,w.[CreateTime]
						  ,p.ProductID
						  ,p.ProductName
						  ,p.BriefName
                          ,p.Status as ProductStatus
						  ,pp.CurrentPrice
						  ,pp.BasicPrice
              ,pp.Mincountperorder
						  , i.OnlineQty as QuantityForSale
						  ,p.ProductTitle
						  ,p.PromotionTitle	
						  ,p.IsHaveValidGift
						  ,pgrm.ReviewCount AS RemarkCount
						  ,pgrm.AvgScore AS RemarkScore
						  ,p.Weight
						  ,pp.CashRebate
						  ,pp.PointType
						  ,Product_Ex.ImageVersion
						  ,p.DefaultImage
						   FROM IPP3.dbo.WishList w WITH(NOLOCK)
  INNER JOIN IPP3.dbo.Product p WITH(NOLOCK) on w.ProductSysNo=p.SysNo
  INNER JOIN IPP3.dbo.Product_Price pp WITH(NOLOCK) on w.ProductSysNo=pp.ProductSysNo
  LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 i WITH(NOLOCK) on w.ProductSysNo=i.ProductSysNo
  INNER JOIN dbo.Product_Ex WITH (NOLOCK) ON p.SysNo=product_Ex.sysno
  INNER JOIN OverseaContentManagement.dbo.ProductCommonInfo b with(nolock)
		ON p.ProductCommonInfoSysno = b.sysno
  LEFT JOIN OverseaECommerceManagement.dbo.ProductGroupReview_Master pgrm WITH(NOLOCK) 
		ON b.ProductGroupSysno = pgrm.ProductGroupSysNo
  '+ @WhereSql+N')TT	
							  WHERE TT.RowNumber > @PageSize * (@CurrentPageIndex - 1) '

  EXEC SP_EXECUTESQL @SelectSql
  			  ,N'@CustomerSysNo INT
              ,@ProductName VARCHAR(50)			
  			  ,@PageSize INT
			  ,@SortField VARCHAR(50)
			  ,@SortType VARCHAR(10)
			  ,@CurrentPageIndex INT
			  ,@CustomerSysNo
  			  ,@ProductName
  			  ,@PageSize
  			  ,@SortField
  			  ,@SortType
  			  ,@CurrentPageIndex 
END
  ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@ProductName" dbType="String" size="200"/>
      <param name="@PageSize" dbType="Int32"/>
      <param name="@CurrentPageIndex" dbType="Int32"/>
      <param name="@SortField" dbType="AnsiString" size="50"/>
      <param name="@SortType" dbType="AnsiString" size="10"/>
      <param name="@TotalCount" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Favorite_GetMyWishTopList" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
SELECT TOP (@Top) WishList.[ProductSysNo]
			,Product.ProductID
			,Product.ProductName
			,Product.DefaultImage
			,Product.ProductTitle
			,ProductPrice.CurrentPrice
      ,Product.Status AS ProductStatus
			,v.OnlineQty as QuantityForSale
			,ProductPrice.CashRebate
			,ProductPrice.PointType
			,Product_Ex.ImageVersion
			,ProductPrice.BasicPrice AS MarketPrice
      ,0 as TariffRate
		FROM IPP3.dbo.WishList WishList WITH(NOLOCK)
			INNER JOIN IPP3.dbo.Product Product WITH(NOLOCK) on WishList.ProductSysNo=Product.SysNo
			INNER JOIN IPP3.dbo.Product_Price ProductPrice WITH(NOLOCK) on WishList.ProductSysNo=ProductPrice.ProductSysNo
			LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 v WITH (NOLOCK) ON  product.sysno = v.productsysno			
			INNER JOIN IPP3.dbo.Product_Ex WITH (NOLOCK) ON Product.SysNo=product_Ex.sysno
      --INNER JOIN IPP3.DBO.Product_EntryInfo AS PE WITH(NOLOCK) ON Product.SysNo=PE.ProductSysNo
		WHERE Product.Status IN (1)  
			AND WishList.CustomerSysNo = @CustomerSysNo 
	ORDER BY 
		WishList.CreateTime Desc

  ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@Top" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--动态验证码相关操作-->
  <dataCommand name="Customer_CreateCustomerCellPhoneDynamicConfirmInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
		   DECLARE @IpCount INT;
       DECLARE @DateInterval DATETIME;
       DECLARE @SendTimes INT;
       
      --判断CustomerSysNo在60秒（时间配置）内不能重复点击获取验证码
     IF @CustomerID !=0
		BEGIN
		  SELECT TOP 1 
				@DateInterval=InDate 
		  FROM 
				[EcommerceRealtime].dbo.Customer_CellPhoneDynamicConfirm WITH(NOLOCK)
		  WHERE CustomerSysNo=@CustomerID 
		  ORDER BY InDate DESC
		END
      ELSE
        BEGIN
          SELECT TOP 1 
                 @DateInterval=InDate
          FROM [EcommerceRealtime].dbo.Customer_CellPhoneDynamicConfirm WITH(NOLOCK)
          WHERE FromIP=@FromIP AND CellPhone=@CellPhone
          ORDER BY InDate DESC
        END
       
    IF (@DateInterval IS NOT NULL) AND 
		(DATEDIFF(S,@DateInterval,GETDATE()) < @IntervalSecond)
     BEGIN
       SELECT 2
       RETURN;
     END
        
     --判断同一Ip，5分钟内，不能操过100次。
     SELECT @SendTimes=COUNT(1)
     FROM dbo.Customer_CellPhoneDynamicConfirm WITH(NOLOCK)
     WHERE FromIP=@FromIP 
           AND InDate > DATEADD(MI,-@IntervalMinute,GETDATE())

     IF @SendTimes >= @TotalSendTimes
     BEGIN
       SELECT 3;
       RETURN;
     END
        
     --插入验证码
     INSERT INTO [EcommerceRealtime].dbo.Customer_CellPhoneDynamicConfirm(
       CustomerSysNo,
       CellPhone,
       ConfirmKey,
       Status,
       TryTimes,
       FromIP,
       InDate,
       InUser,
       CompanyCode,
       LanguageCode,
       StoreCompanyCode
     )VALUES(
        @CustomerID,
        @CellPhone,
        @ConfirmKey,
        'A',
        0,
        @FromIP,
        GETDATE(),
        'WebSite',
        @CompanyCode,
        @LanguageCode,
        @StoreCompanyCode
     )
        
    SELECT 1;
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerID" dbType="Int32"/>
      <param name="@CellPhone" dbType="String" size="50"/>
      <param name="@ConfirmKey" dbType="String" size="100"/>
      <param name="@FromIP" dbType="String" size="50"/>
      <param name="@IntervalMinute" dbType="Int32"/>
      <param name="@IntervalSecond" dbType="Int32"/>
      <param name="@TotalSendTimes" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <!--验证-->
  <dataCommand name="Customer_ValidateCustomerCellPhoneDynamicConfirmInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
          DECLARE @ConfirmKeyRecent NVARCHAR(100);
    DECLARE @SysNo INT;
    DECLARE @TryTimesTotal INT;
    DECLARE @Status CHAR(1);
    DECLARE @CreateTime DATETIME;

   --根据CellPhone获取最后一条有效信息
    SELECT TOP 1 
         @ConfirmKeyRecent=ConfirmKey,
         @SysNo=SysNo,
         @TryTimesTotal=TryTimes,
         @Status=Status,
         @CreateTime=InDate
    FROM EcommerceRealtime.[dbo].[Customer_CellPhoneDynamicConfirm] WITH(NOLOCK)
    WHERE CellPhone = @CellPhone 
    ORDER BY SysNo DESC

    IF @Status = 'D'
      BEGIN 
        SELECT 4
        RETURN;
      END

    IF @TryTimesTotal >= @IsRepeatTimes
      BEGIN 
        SELECT 4
        RETURN;
      END
     
     --三分钟失效
     IF @CreateTime < DATEADD(MI,-@InvalidateMinute,GETDATE())
       BEGIN 
         SELECT 2
         RETURN;
       END
   

	--判断Realtime表中是否存在符合条件	
	IF @ConfirmKeyRecent = @ConfirmKey
	BEGIN
		 --输入正确，设置Status为D
		  UPDATE TOP(1) EcommerceRealtime.[dbo].[Customer_CellPhoneDynamicConfirm]
		  SET STATUS='D',
			  EditDate=GETDATE(),
              EditUser='WebSite'
		  WHERE SysNo=@SysNo 
				AND LanguageCode = @LanguageCode
				AND CompanyCode = @CompanyCode
				AND StoreCompanyCode = @StoreCompanyCode
		
		SELECT 1
          
	END
	--不存在更新该customer相关状态　
	ELSE
	BEGIN
		  UPDATE TOP(1) EcommerceRealtime.[dbo].[Customer_CellPhoneDynamicConfirm]
				  SET TryTimes=TryTimes+1,
                      EditDate=GETDATE(),
                      EditUser='WebSite'
				  WHERE SysNo=@SysNo 
                        AND LanguageCode = @LanguageCode
					    AND CompanyCode = @CompanyCode
					    AND StoreCompanyCode = @StoreCompanyCode
           SELECT 3;
     END
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerID" dbType="Int32"/>
      <param name="@CellPhone" dbType="String" size="50"/>
      <param name="@ConfirmKey" dbType="String" size="100"/>
      <param name="@FromIP" dbType="String" size="50"/>
      <param name="@IsRepeatTimes" dbType="Int32"/>
      <param name="@InvalidateMinute" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetCustomerCellPhoneConfirmInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT TOP 1 
				A.SysNo,
				A.CustomerSysNo,
				A.CellPhone,
				A.Status
			FROM Ecommerce.dbo.Customer_CellPhoneConfirm  A WITH(NOLOCK)
			INNER JOIN IPP3.dbo.Customer B WITH(NOLOCK) 
			ON A.CustomerSysNo = B.SysNo AND A.CellPhone = B.CellPhone
			WHERE A.CustomerSysNo = @CustomerID 
				AND B.Status = 0 
				AND A.LanguageCode = B.LanguageCode
				AND A.CompanyCode = B.CompanyCode
				AND A.StoreCompanyCode = B.StoreCompanyCode
			ORDER BY A.Status DESC
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerID" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_CheckCustomerEmail" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			select top 1 Email from IPP3.dbo.Customer WHERE SysNo=@SysNo and Email=@Email
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@SysNo" direction="Input" size="4"/>
      <param dbType="AnsiString" name="@Email" direction="Input" size="50"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_GetCustomerExtendInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			select top 1 *,AvtarImageStatus AS AvtarImageDBStatus from IPP3.dbo.Customer_Extend WHERE CustomerSysno=@CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_GetCustomerExtendInfoCenterDB" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			select top 1 *,AvtarImageStatus AS AvtarImageDBStatus from IPP3.dbo.Customer_Extend WHERE CustomerSysno=@CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Customer_GetCustomerPersonExtendInfo" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
			select top 1 * from OverseaCustomerManagement.dbo.CustomerPersonal_ExtendInfo WHERE CustomerSysNo=@CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_GetMyFavoriteProductList" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
        ;WITH Temp AS(
	        SELECT 
		        product.SysNo,
		        product.BriefName AS ProductName,
		        product.DefaultImage,
            product.ProductTitle,
		        price.CurrentPrice AS CurrentPrice,
            price.CashRebate,
		        0 as TariffRate,
            wl.SysNo AS WishSysNo,
            v.OnlineQty,
		        ROW_NUMBER() OVER( ORDER BY wl.SysNo DESC)  AS RowNumber
	        FROM IPP3.dbo.WishList wl WITH(NOLOCK)
	        INNER JOIN IPP3.dbo.Customer customer WITH(NOLOCK)
	          ON customer.SysNo = wl.CustomerSysNo
	        INNER JOIN IPP3.dbo.Product product WITH(NOLOCK)
	          ON product.SysNo = wl.ProductSysNo AND product.Status=1
	        INNER JOIN IPP3.dbo.Product_Price price WITH(NOLOCK)
	          ON product.SysNo = price.ProductSysNo
	      --  INNER JOIN IPP3.DBO.Product_EntryInfo AS PE WITH(NOLOCK)
		     --   ON product.SysNo=PE.ProductSysNo 
		    LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 v WITH (NOLOCK) 
				ON  product.sysno = v.productsysno
	        WHERE wl.CustomerSysNo = @CustomerSysNo
        )
        SELECT * FROM Temp
        WHERE RowNumber > (@PageIndex-1) * @PageSize AND RowNumber <= @PageIndex * @PageSize
        
        SELECT @TotalCount = COUNT(1)
	      FROM IPP3.dbo.WishList wl WITH(NOLOCK)
	      INNER JOIN IPP3.dbo.Customer customer WITH(NOLOCK)
	        ON customer.SysNo = wl.CustomerSysNo
	      INNER JOIN IPP3.dbo.Product product WITH(NOLOCK)
	        ON product.SysNo = wl.ProductSysNo AND product.Status=1
	      INNER JOIN IPP3.dbo.Product_Price price WITH(NOLOCK)
	        ON product.SysNo = price.ProductSysNo
	     -- INNER JOIN IPP3.DBO.Product_EntryInfo AS PE WITH(NOLOCK)
		    --  ON product.SysNo=PE.ProductSysNo 
	      WHERE wl.CustomerSysNo = @CustomerSysNo
			]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CustomerSysNo" />
      <param name="@PageSize" dbType="Int32"/>
      <param name="@PageIndex" dbType="Int32"/>
      <param name="@TotalCount" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>

  <!--查询用户的优惠券-->
  <dataCommand name="Customer_QueryCouponCode" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      DECLARE @RegisterTime DATETIME;
      SELECT @RegisterTime = RegisterTime FROM [IPP3].[dbo].[Customer](NOLOCK)
      WHERE SysNo = @CustomerSysNo

      DECLARE @VouchTable TABLE 
      ( 
	        ID INT  IDENTITY(1,1)   PRIMARY KEY
	      ,CouponCodeSysNo INT
	      ,CouponCode NVARCHAR(20)
	      ,CouponMasterId  INT
	      ,CouponName NVARCHAR(200)
	      ,CouponDesc NVARCHAR(500)
	      ,BeginDate DATETIME
	      ,EndDate DATETIME
	      ,CustomerSysno INT 
	      ,[Status] CHAR(1)
	      ,UsedCount INT
      )
      INSERT INTO @VouchTable 
      (
	        CouponCodeSysNo
	      ,CouponCode 
	      ,CouponMasterId 
	      ,CouponName 
	      ,CouponDesc
	      ,BeginDate 
	      ,EndDate 
	      ,CustomerSysno
	      ,[Status]
	      ,UsedCount
      )
      SELECT  
	      PC.SysNo AS CouponCodeSysNo
          ,PCL.CouponCode 
          ,PM.SysNo AS PromotionMasterID 
          ,PM.CouponName
          ,PM.CouponDesc
          ,PC.BeginDate 
          ,PC.EndDate 
          ,PCL.CustomerSysno  
          ,PM.Status,
          (SELECT COUNT(1) FROM [OverseaECommerceManagement].[dbo].[CouponCode_RedeemLog](NOLOCK) T
            WHERE T.[Status] = N'A'
            AND T.CustomerSysNo = PCL.CustomerSysno
            AND T.CouponCode =pc.CouponCode) AS UsedCount
      FROM [OverseaECommerceManagement].dbo.CouponCode_CustomerLog AS PCL WITH (NOLOCK) 
	      INNER JOIN [OverseaECommerceManagement].dbo.CouponCode AS PC WITH (NOLOCK) 
		      ON PCL.CouponCode = PC.CouponCode AND PCL.CouponSysNo = PC.CouponSysNo
	      INNER JOIN [OverseaECommerceManagement].dbo.Coupon AS PM WITH (NOLOCK) 
		      ON PM.SysNo = PC.CouponSysno  
      WHERE PCL.CustomerSysno =@CustomerSysNo 
	      AND PM.Status IN('A','F','R')

      INSERT INTO @VouchTable
      (
	        CouponCodeSysNo
	      ,CouponCode
	      ,CouponMasterId
	      ,CouponName
	      ,CouponDesc
	      ,BeginDate
	      ,EndDate
	      ,CustomerSysno
	      ,[Status]
	      ,UsedCount
      )	 
      SELECT  
		      couCode.SysNo AS CouponCodeSysNo
		      ,couCode.CouponCode
		      ,couM.SysNo AS PromotionMasterID
		      ,couM.CouponName
		      ,couM.CouponDesc
		      ,couCode.BeginDate
		      ,couCode.EndDate
		      ,@CustomerSysNo
		      ,couM.Status,
		        (SELECT COUNT(1) FROM [OverseaECommerceManagement].[dbo].[CouponCode_RedeemLog](NOLOCK) T
		        WHERE T.[Status] = N'A'
		        AND T.CustomerSysNo = @CustomerSysNo
		        AND T.CouponCode = couCode.CouponCode) AS UsedCount
      FROM [OverseaECommerceManagement].dbo.Coupon_SaleRules saRule WITH(NOLOCK)
		      INNER JOIN [OverseaECommerceManagement].dbo.CouponCode couCode WITH(NOLOCK) 
			      ON saRule.CouponSysNo = couCode.CouponSysNo  AND couCode.CodeType='C'
		      INNER JOIN [OverseaECommerceManagement].dbo.Coupon couM WITH(NOLOCK)
			      ON saRule.CouponSysNo = couM.SysNo
          LEFT JOIN OverseaEcommerceManagement.dbo.Coupon_BindRules(nolock) saBindRules
            ON saRule.CouponSysNo = saBindRules.CouponSysNo
      WHERE (saRule.CustomerRank = @CustomerRank OR saRule.CustomerRank = -1)
	      AND couM.Status IN('A','F','R')
	      AND NOT EXISTS(SELECT TOP 1 1 FROM @VouchTable WHERE CouponMasterId = couM.SysNo)
        AND couCode.EndDate >= @RegisterTime
        AND saBindRules.IsAutoBinding = 'N' AND saBindRules.BindCondition = 'A'

      DELETE 
      FROM @VouchTable 
      WHERE  CouponMasterId not in 
      (SELECT MAX(CouponMasterId) 
        FROM @VouchTable 
        GROUP BY  CouponCode)
        --所有数量
      SELECT @TotalCount=COUNT(1) FROM @VouchTable #StrWhere# 
      --当前页优惠券
      SELECT Tbl.* FROM
      (SELECT TOP (@EndNumber)
            (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber,
            T.CouponCode,
            T.CouponName,
            T.CouponDesc,
            T.BeginDate,
            T.EndDate,
            T.UsedCount
            FROM @VouchTable T #StrWhere# ) Tbl
      WHERE Tbl.RowNumber > @StartNumber
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@CustomerRank" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_QueryProductNotify" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount=COUNT(1) 
      FROM IPP3.dbo.product_notify AS pnr WITH (NOLOCK) 
      INNER JOIN IPP3.dbo.product p WITH (NOLOCK)ON p.sysno =pnr.productsysno AND p.Status = 1
      INNER JOIN IPP3.dbo.product_price pp WITH (NOLOCK) ON p.sysno = pp.productsysno
      LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 v WITH (NOLOCK) ON  p.sysno = v.productsysno
      --INNER JOIN ipp3.dbo.Product_EntryInfo en WITH (NOLOCK) ON p.SysNo=en.ProductSysNo
      #StrWhere#

      SELECT * FROM
      (
        SELECT TOP (@EndNumber) (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
            ,pnr.[SysNo]
            ,pnr.[Status]
            ,pnr.[CustomerSysNo]
            ,pnr.[ProductSysNo]
            ,pnr.NotifyTime
   	        ,p.ProductID 
	          ,p.ProductTitle
            ,p.ProductMode
	          ,pp.CurrentPrice
	          ,pp.CashRebate 
	          ,0 as TariffRate
	          ,v.OnlineQty
	          ,p.DefaultImage
        FROM IPP3.dbo.product_notify AS pnr WITH (NOLOCK) 
        INNER JOIN IPP3.dbo.product p WITH (NOLOCK)ON p.sysno =pnr.productsysno AND p.Status = 1
        INNER JOIN IPP3.dbo.product_price pp WITH (NOLOCK) ON p.sysno = pp.productsysno
        LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 v WITH (NOLOCK) ON  p.sysno = v.productsysno
       -- INNER JOIN ipp3.dbo.Product_EntryInfo en WITH (NOLOCK) ON p.SysNo=en.ProductSysNo
		    #StrWhere# 
      ) T WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_QueryProductPriceNotify" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @TotalCount=COUNT(1) 
      FROM OverseaECommerceManagement.dbo.Product_PriceNotify w WITH(NOLOCK) 
      INNER JOIN IPP3.dbo.Product p WITH(NOLOCK) ON w.ProductSysNo=p.SysNo AND p.Status=1
      INNER JOIN IPP3.dbo.Product_Price pp WITH(NOLOCK) ON w.ProductSysNo=pp.ProductSysNo AND pp.PointType != 2
      LEFT JOIN IPP3.dbo.[V_EC_Inventory_V2] v WITH (NOLOCK) ON  p.sysno = v.productsysno
     -- INNER JOIN ipp3.dbo.Product_EntryInfo en WITH (NOLOCK) ON p.SysNo=en.ProductSysNo
      #StrWhere#

      SELECT * FROM
      (
        SELECT TOP (@EndNumber) (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
			        ,w.[SysNo]
	            ,w.[CustomerSysNo]
	            ,w.[InstantPrice]
	            ,w.[ExpectedPrice]
	            ,w.[Status]
	            ,w.[ProductSysNo] 
	            ,p.ProductID 
	            ,p.ProductTitle
	            ,pp.CurrentPrice
	            ,pp.CashRebate 
	            ,0 as TariffRate
	            ,v.OnlineQty
	            ,p.DefaultImage
            FROM OverseaECommerceManagement.dbo.Product_PriceNotify w WITH(NOLOCK) 
            INNER JOIN IPP3.dbo.Product p WITH(NOLOCK) ON w.ProductSysNo=p.SysNo AND p.Status=1
            INNER JOIN IPP3.dbo.Product_Price pp WITH(NOLOCK) ON w.ProductSysNo=pp.ProductSysNo AND pp.PointType != 2 
            LEFT JOIN IPP3.dbo.V_EC_Inventory_V2 v WITH (NOLOCK) ON  p.sysno = v.productsysno
           -- INNER JOIN ipp3.dbo.Product_EntryInfo en WITH (NOLOCK) ON p.SysNo=en.ProductSysNo
		    #StrWhere# 
      ) T WHERE RowNumber > @StartNumber
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Customer_GetPrepayList" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
      SELECT @PrepayAmount = ValidPrepayAmt
      FROM IPP3.dbo.Customer WITH(NOLOCK) 
      WHERE SysNo = @CustomerID
      AND LanguageCode = @LanguageCode
      AND CompanyCode = @CompanyCode
      AND StoreCompanyCode = @StoreCompanyCode
      
      SELECT @TotalCount=COUNT(1) 
      FROM IPP3.dbo.Customer_PrepayLog WITH(NOLOCK)
      #StrWhere#

      SELECT * FROM
      (
        SELECT TOP (@EndNumber) (ROW_NUMBER() OVER(ORDER BY #SortColumnName#)) AS RowNumber
			    ,OrderSysNo AS OrderID
			    ,PrepayType AS LogType
			    ,CreateTime AS TimeString
			    ,PrepayAmt AS PrepayAmount
          ,Note
        FROM IPP3.dbo.Customer_PrepayLog WITH (NOLOCK) 
		    #StrWhere# 
      ) T WHERE RowNumber > @StartNumber
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerID" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@PrepayAmount" dbType="Decimal" direction="Output" precision="19" scale="2"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Point_GetPointObtainAndConsumeList" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
DECLARE @CountSql NVARCHAR(MAX)  
DECLARE @RowSql NVARCHAR(MAX)  
 IF(@ResultType = 1)  
 BEGIN   
  SELECT @CountSql=N'SELECT @RowCount=COUNT(1)   
      FROM  [OverseaInvoiceReceiptManagement].[dbo].[Point_Obtain] A WITH(NOLOCK)  
                    where A.[CustomerSysNo]=@CustomerSysno   
       and A.ObtainType <> 51 and A.ObtainType <> 50  
       and A.LanguageCode=@LanguageCode AND A.CompanyCode=@CompanyCode AND A.StoreCompanyCode=@StoreCompanyCode  
      ';  
  
  SELECT @RowSql=N'SELECT TOP (@PageSize)  
       T.[SysNo]  
       ,T.[CustomerSysNo]  
       ,T.[Point]
       ,T.[ObtainType] AS ObtainType  
       ,T.[IsFromSysAccount]  
       ,T.[SysAccount]  
       ,T.[SoSysNo]  
       ,T.[InDate]  AS CreateDate
       ,T.[InUser]  
       ,T.[EditDate]  
       ,T.[EditUser]  
       ,T.[ExpireDate]  
       ,T.[Memo]  
       ,T.[Status]  
       ,T.[LanguageCode]  
       ,T.[CurrencyCode]  
       ,T.[CompanyCode]  
       ,T.[StoreCompanyCode]  
      FROM  
      (SELECT   
       ROW_NUMBER() OVER (ORDER BY A.ExpireDate) AS RowNumber,  
      A.[SysNo]  
       ,A.[CustomerSysNo]  
       ,A.[Point]  
       ,A.[AvailablePoint]  
       ,A.[ObtainType]  
       ,A.[IsFromSysAccount]  
       ,A.[SysAccount]  
       ,A.[SoSysNo]  
       ,A.[InDate]  
       ,A.[InUser]  
       ,A.[EditDate]  
       ,A.[EditUser]  
       ,A.[ExpireDate]  
       ,A.[Memo]  
       ,A.[Status]  
       ,A.[LanguageCode]  
       ,A.[CurrencyCode]  
       ,A.[CompanyCode]  
       ,A.[StoreCompanyCode]  
      FROM [OverseaInvoiceReceiptManagement].[dbo].[Point_Obtain] A WITH(NOLOCK)  
      where A.[CustomerSysNo]=@CustomerSysno  
       and A.ObtainType <> 51 and A.ObtainType <> 50  
       and A.LanguageCode=@LanguageCode AND A.CompanyCode=@CompanyCode AND A.StoreCompanyCode=@StoreCompanyCode  
      ) T  
      WHERE T.RowNumber > @PageSize * (@PageIndex - 1) ';  
 END  
 ELSE  
  BEGIN  
   SELECT @CountSql=N'SELECT @RowCount=COUNT(1)   
      FROM  [OverseaInvoiceReceiptManagement].[dbo].[Point_Consume] A WITH(NOLOCK)  
       where A.CustomerSysNo = @CustomerSysno and A.status =''A''  
       and A.ConsumeType <> 51 and A.ConsumeType <> 50 and A.IsShow=1  
       and A.LanguageCode=@LanguageCode AND A.CompanyCode=@CompanyCode AND A.StoreCompanyCode=@StoreCompanyCode  
      ';  
  
  SELECT @RowSql=N'SELECT TOP (@PageSize)  
        T.[SysNo]  
       ,T.[CustomerSysNo]  
       ,T.[RelatedObtainNo]  
       ,T.[Point]  
       ,T.[SoSysNo]  
       ,T.[InDate]  AS CreateDate
       ,T.[InUser]  
       ,T.[EditDate]  
       ,T.[EditUser]  
       ,T.[ConsumeType]
       ,T.[Memo]  
       ,T.[IsShow]  
       ,T.[Status]  
       ,T.[LanguageCode]  
       ,T.[CurrencyCode]  
       ,T.[CompanyCode]  
       ,T.[StoreCompanyCode]  
      FROM  
      (SELECT   
       ROW_NUMBER() OVER (ORDER BY A.InDate DESC) AS RowNumber,  
        A.[SysNo]  
       ,A.[CustomerSysNo]  
       ,A.[RelatedObtainNo]  
       ,A.[Point]  
       ,A.[SoSysNo]  
       ,A.[InDate]  
       ,A.[InUser]  
       ,A.[EditDate]  
       ,A.[EditUser]  
       ,A.[ConsumeType]  
       ,A.[Memo]  
       ,A.[IsShow]  
       ,A.[Status]  
       ,A.[LanguageCode]  
       ,A.[CurrencyCode]  
       ,A.[CompanyCode]  
       ,A.[StoreCompanyCode]  
      FROM [OverseaInvoiceReceiptManagement].[dbo].[Point_Consume] A WITH(NOLOCK)  
       where A.CustomerSysNo = @CustomerSysno and A.status =''A''  
       and A.ConsumeType <> 51 and A.ConsumeType <> 50 and A.IsShow=1  
       and A.LanguageCode=@LanguageCode AND A.CompanyCode=@CompanyCode AND A.StoreCompanyCode=@StoreCompanyCode  
      ) T  
      WHERE T.RowNumber > @PageSize * (@PageIndex - 1)  
      ';  
  END  
  
  EXECUTE SP_EXECUTESQL @CountSql,  
    N'@CustomerSysno int,@RowCount int Output,@LanguageCode CHAR(5),@CompanyCode CHAR(50),@StoreCompanyCode VARCHAR(50)',  
    @CustomerSysno,@RowCount Output,@LanguageCode,@CompanyCode,@StoreCompanyCode   
  EXECUTE SP_EXECUTESQL @RowSql,  
    N'@CustomerSysno int,@PageSize int,@PageIndex int,@LanguageCode CHAR(5),@CompanyCode CHAR(50),@StoreCompanyCode VARCHAR(50)'  
    ,@CustomerSysno,@PageSize,@PageIndex,@LanguageCode,@CompanyCode,@StoreCompanyCode   
   
      ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@PageSize" dbType="Int32"/>
      <param name="@PageIndex" dbType="Int32"/>
      <param name="@ResultType" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@RowCount" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>
  <dataCommand name="Experience_GetExperienceList" database="Read" commandType="StoredProcedure">
    <commandText>
      <![CDATA[[ipp3].[dbo].[UP_EC_GetExperienceList_V1]]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@PageSize" dbType="Int32"/>
      <param name="@PageIndex" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@TotalCount" dbType="Int32" direction="Output"/>
      <param name="@ExperienceTotal" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Customer_PhoneIsValidate" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
select top 1 1 
from [Ecommerce].[dbo].[Customer_CellPhoneConfirm]  (nolock)
where CellPhone=@PhoneNumber and Status=1
			]]>
    </commandText>
    <parameters>
      <param dbType="String" name="@PhoneNumber"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetMyReview" database="Read" commandType="StoredProcedure">
    <commandText>
      <![CDATA[[OverseaECommerceManagement].[dbo].[UP_EC_GetMyReviewListV3]]]>
    </commandText>
    <parameters>
      <param name="@CustomerID" dbType="Int32"/>
      <param name="@PageSize" dbType="Int32"/>
      <param name="@PageIndex" dbType="Int32"/>
      <param name="@Type" dbType="Int32"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@TotalCount" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>

  <dataCommand name="GetConsultListByCustomerSysNo" database="Read" commandType="StoredProcedure">
    <commandText>
      <![CDATA[[OverseaECommerceManagement].[dbo].[UP_EC_GetConsultListBySysNo_V2]]]>
    </commandText>
    <parameters>
      <param name="@ProductGroupSysNo" dbType="Int32" size="4"/>
      <param name="@CustomerSysNo" dbType="Int32" size="4"/>
      <param name="@Type" dbType="Int32" size="4"/>
      <param name="@ConsultType" dbType="AnsiStringFixedLength" size="1"/>
      <param name="@KeyWord" dbType="String" size="100"/>
      <param name="@CustomerReply" dbType="Int32" size="4"/>
      <param name="@PageSize" dbType="Int32" size="4"/>
      <param name="@PageIndex" dbType="Int32" size="4"/>
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" size="5"/>
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" size="50"/>
      <param name="@StoreCompanyCode" dbType="AnsiString" size="50"/>
      <param name="@TotalCount" dbType="Int32" direction="Output"/>
    </parameters>
  </dataCommand>

  <!--我的店铺收藏-->
 <dataCommand name="Customer_GetMyFavoriteSellerList" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
        ;WITH CTE_Paging AS(
select ms.SysNo
,ms.SellerSysNo
,sb.StoreName
,sb.LogoURL
,ROW_NUMBER() OVER(order by #SortColumnName#) AS RowNumber
from OverseaCustomerManagement.[dbo].[MyFavoriteSeller] ms
inner join ECStore.dbo.StoreBasicInfo sb
on ms.SellerSysNo=sb.SellerSysNo
inner join IPP3.dbo.Vendor v
on sb.SellerSysNo=v.SysNo
#StrWhere#
)

SELECT t.SysNo
,t.SellerSysNo
,t.StoreName
,t.LogoURL
,(select COUNT(*) from IPP3.dbo.Product p where p.MerchantSysNo=t.SellerSysNo and p.Status in(0,1)) as ItemCount
from CTE_Paging t
where t.RowNumber>@StartNumber AND t.RowNumber<=@EndNumber

select @TotalCount = COUNT(1)
from OverseaCustomerManagement.[dbo].[MyFavoriteSeller] ms
inner join ECStore.dbo.StoreBasicInfo sb
on ms.SellerSysNo=sb.SellerSysNo
inner join IPP3.dbo.Vendor v
on sb.SellerSysNo=v.SysNo
#StrWhere#
			]]>
    </commandText>
  </dataCommand>

  <!--判断当前店铺是否已收藏-->
  <dataCommand name="Customer_IsMyFavoriteSeller" database="Read" commandType="Text">
    <commandText>
      <![CDATA[
select 1 from OverseaCustomerManagement.[dbo].[MyFavoriteSeller]
where CustomerSysNo=@CustomerSysNo and SellerSysNo=@SellerSysNo
			]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@SellerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--获取最近几天收藏的店铺-->
  <dataCommand name="Favorite_GetRecentFavoriteSellerCount" database="Read" commandType="Text" >
    <commandText>
      <![CDATA[
          SELECT count(1) as RecordCount
					FROM OverseaCustomerManagement.[dbo].[MyFavoriteSeller] ms
          inner join ECStore.dbo.StoreBasicInfo sb
          on ms.SellerSysNo=sb.SellerSysNo
          inner join IPP3.dbo.Vendor v
          on sb.SellerSysNo=v.SysNo
					WHERE v.Status = 0
					AND ms.CreateTime>=DATEADD(DAY,-@Day,GETDATE())
					AND ms.CustomerSysNo=@CustomerSysNo 
		]]>
    </commandText>
    <parameters>
      <param dbType ="Int32" name="@CustomerSysNo" direction="Input" size="4"/>
      <param dbType ="Int32" name="@Day" direction="Input" size="4"/>
    </parameters>
  </dataCommand>
</dataOperations>
