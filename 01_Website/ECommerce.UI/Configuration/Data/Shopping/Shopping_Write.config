<?xml version="1.0" encoding="utf-8" ?>
<dataOperations xmlns="http://oversea.ECommerce.com/DataOperation">

  <dataCommand name="Pipeline_GetCouponCodeUsedQuantity" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT COUNT(*) FROM OverseaECommerceManagement.dbo.CouponCode
			WHERE SysNo = @CouponCodeSysNo 
      AND (ISNULL(TotalCount,0) = 0 
      OR ISNULL(TotalCount,0) >= ISNULL(UseCount,0) + @Times)
      ]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CouponCodeSysNo" direction="Input" size="50"/>
      <param dbType="Int32" name="@Times" direction="Input" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CouponSaleRulesExUsedQuantity" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			SELECT COUNT(*) FROM OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex
			WHERE CouponSysNo = (SELECT TOP 1 CouponSysNo FROM OverseaECommerceManagement.dbo.CouponCode WITH(NOLOCK)
									         WHERE SysNo = @CouponCodeSysNo)
			AND (ISNULL(MaxFrequency,0) = 0 OR ISNULL(MaxFrequency,0) >= ISNULL(UsedFrequency,0) + @Times)
      ]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CouponCodeSysNo" direction="Input" size="50"/>
      <param dbType="Int32" name="@Times" direction="Input" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_UpdateCouponCodeQuantity" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			UPDATE TOP (1) OverseaECommerceManagement.dbo.CouponCode
			SET UseCount = ISNULL(UseCount,0) + @Times
			WHERE SysNo = @CouponCodeSysNo 
      AND (ISNULL(TotalCount,0) = 0 
      OR ISNULL(TotalCount,0) >= ISNULL(UseCount,0) + @Times)
      ]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CouponCodeSysNo" direction="Input" size="50"/>
      <param dbType="Int32" name="@Times" direction="Input" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_UpdateSaleRulesExQuantity" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			UPDATE TOP (1) OverseaECommerceManagement.dbo.Coupon_SaleRules_Ex
			SET UsedFrequency = ISNULL(UsedFrequency,0) + @Times
			WHERE CouponSysNo = (SELECT TOP 1 CouponSysNo FROM OverseaECommerceManagement.dbo.CouponCode WITH(NOLOCK)
									         WHERE SysNo = @CouponCodeSysNo)
			AND (ISNULL(MaxFrequency,0) = 0 OR ISNULL(MaxFrequency,0) >= ISNULL(UsedFrequency,0) + @Times)
      ]]>
    </commandText>
    <parameters>
      <param dbType="Int32" name="@CouponCodeSysNo" direction="Input" size="50"/>
      <param dbType="Int32" name="@Times" direction="Input" size="50"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_IsExistShoppingCart" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		      SELECT COUNT(*) FROM OverseaOrderManagement.dbo.SO_ShoppingCart WITH(NOLOCK)
				      WHERE ShoppingCartSysNo = @ShoppingCartSysNo
					        AND SOSysNo = @SOSysNo
					        AND CustomerSysNo = @CustomerSysNo
					        AND LanguageCode = @LanguageCode
					        AND CompanyCode = @CompanyCode
					        AND StoreCompanyCode = @StoreCompanyCode)
      ]]>
    </commandText>
    <parameters>
      <param name="@ShoppingCartSysNo" dbType="Int32"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CreateShoppingCart" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		        INSERT INTO OverseaOrderManagement.dbo.SO_ShoppingCart
		        (
			        ShoppingCartSysNo,
			        SOSysNo,
			        CustomerSysNo,
			        InUser,
			        InDate,
			        LanguageCode,
			        CompanyCode,
			        StoreCompanyCode
		        )
		        VALUES
		        (
			        @ShoppingCartSysNo,
			        @SOSysNo,
			        @CustomerSysNo,
			        'WebSite',
			        GETDATE(),
			        @LanguageCode,
			        @CompanyCode,
			        @StoreCompanyCode
		        )
      ]]>
    </commandText>
    <parameters>
      <param name="@ShoppingCartSysNo" dbType="Int32"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_GenerateSOSysNo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			    INSERT INTO [IPP3].[dbo].[SO_Sequence] ([CreateTime]) VALUES (GETDATE()) 
          SELECT SCOPE_IDENTITY()
      ]]>
    </commandText>
  </dataCommand>

  <!--扣减商品库存：获取库存模式-->
  <dataCommand name="Pipeline_GetInventoryType" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
        SELECT InventoryType   
        FROM IPP3.dbo.Product WITH(NOLOCK)  
        WHERE SysNo = @ProductSysNo  
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--扣减商品库存：更新总的库存-->
  <dataCommand name="Pipeline_UpdateInventory" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE IPP3.dbo.Inventory     
          SET OrderQty = OrderQty + @Quantity    
             ,AvailableQty = AvailableQty - @Quantity     
          WHERE ProductSysNo = @ProductSysNo     
            AND AvailableQty + VirtualQty + ConsignQty - InvalidQty - @Quantity>=0    
            AND LanguageCode = @LanguageCode    
            AND CompanyCode = @CompanyCode    
            AND StoreCompanyCode = @StoreCompanyCode    
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--扣减商品库存：更新对应仓库的库存-->
  <dataCommand name="Pipeline_UpdateInventoryStock" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          UPDATE IPP3.dbo.Inventory_Stock     
          SET OrderQty = OrderQty + @Quantity    
             ,AvailableQty = AvailableQty - @Quantity     
          WHERE ProductSysNo = @ProductSysNo     
          AND StockSysNo = Cast(@WarehouseNumber AS INT)    
          AND AvailableQty + VirtualQty + ConsignQty - InvalidQty - @Quantity>=0    
          AND LanguageCode = @LanguageCode    
          AND CompanyCode = @CompanyCode    
          AND StoreCompanyCode = @StoreCompanyCode    
      ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@WarehouseNumber" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--Create SO Master-->
  <dataCommand name="Pipeline_CreateSOMaster" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		        INSERT INTO IPP3.dbo.SO_Master
               (  
                AllocatedManSysNo,  
                CashPay,  
                CustomerSysNo,  
                DeliveryDate,  
                DeliveryMemo,  
                DeliveryTimeRange,  
                DiscountAmt,  
                FinanceNote,  
                FreightUserSysNo,  
                HaveAutoRMA,  
                HoldDate,  
                HoldMark,  
                HoldReason,  
                HoldUser,  
                InvoiceNo,  
                InvoiceNote,  
                IsLarge,  
                IsMobilePhone,  
                IsPremium,  
                IsPrintPackageCover,  
                IsUseChequesPay,  
                IsUsePrepay,  
                IsVAT,  
                IsWholeSale,  
                Memo,  
                Note,  
                OrderDate,  
                OutTime,  
                OutUserSysNo,  
                PackageID,  
                PayPrice,  
                PayTypeSysNo,  
                PointAmt,  
                PointPay,  
                PositiveSOSysNo,  
                PremiumAmt,  
                PrepayAmt,  
                GiftCardPay,  
                PromotionCodeSysNo,  
                PromotionCustomerSysNo,  
                ReceiveAddress,  
                ReceiveAreaSysNo,  
                ReceiveCellPhone,  
                ReceiveContact,  
                ReceiveName,  
                ReceivePhone,  
                ReceiveZip,  
                SalesManSysNo,  
                ShipPrice,  
                ShipTypeSysNo,  
                ShoppingMasterSysNo,  
                SOAmt,  
                SOID,  
                Status,  
                StockSysNo,  
                SysNo,  
                LanguageCode,  
                CompanyCode,  
                StoreCompanyCode,
                TariffAmt,
                CurrencySysNo,
                ExchangeRate,
                PlatPromotionCodeSysNo
               )  
          VALUES
		          (
                0,
                @CashPayAmount,
                @CustomerSysNo,
                @DeliveryDate,
                @DeliveryMemo,
                @DeliveryTimeRange,
                @DiscountAmount,
                NULL,
                NULL,
                0,
                NULL,
                NULL,
                NULL,
                NULL,
                @InvoiceNo,
                @InvoiceNote,
                @IsLarge,
                @IsMobilePhone,
                @IsPremium,
                0,
                @IsUseChequesPay,
                @IsUsePrepay,
                @IsVAT,
                @IsWholeSale,
                @Memo,
                N'',
                @OrderDataTime,
                NULL,
                NULL,
                NULL,
                @PayPrice,
                @PayTypeSysNo,
                @TotalRewardedPoint,
                @PointPay,
                NULL,
                @PremiumAmt,
                @PrepayAmt,
                @GiftCardPay,
                @PromotionCodeSysNo,
                @PromotionCustomerSysNo,
                @ReceiveAddress,
                @ReceiveAreaSysNo,
                @ReceiveCellPhone,
                @ReceiveContact,
                @ReceiveName,
                @ReceivePhone,
                @ReceiveZip,
                0,
                @ShipAmount,
                @ShipTypeSysNo,
                NULL,
                @SOAmount,
                @SOSysNo,
                @Status,
                @StockSysNo,
                @SOSysNo,
                @LanguageCode,
                @CompanyCode,
                @StoreCompanyCode,
                @TariffAmt,
                @CurrencySysNo,
                @ExchangeRate,
                @PlatPromotionCodeSysNo
        )
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="String"/>
      <param name="@SOAmount" dbType="Decimal"/>
      <param name="@StockSysNo" dbType="Int32"/>
      <param name="@Status" dbType="Int32"/>
      <param name="@CashPayAmount" dbType="Decimal"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@DeliveryMemo" dbType="String"/>
      <param name="@DeliveryDate" dbType="DateTime"/>
      <param name="@DeliveryTimeRange" dbType="Int32"/>
      <param name="@DiscountAmount" dbType="Decimal"/>
      <param name="@InvoiceNo" dbType="Int32"/>
      <param name="@InvoiceNote" dbType="String"/>
      <param name="@IsLarge" dbType="Int32"/>
      <param name="@IsMobilePhone" dbType="Int32"/>
      <param name="@IsPremium" dbType="Int32"/>
      <param name="@IsUseChequesPay" dbType="Int32"/>
      <param name="@IsUsePrepay" dbType="Int32"/>
      <param name="@IsVAT" dbType="Int32"/>
      <param name="@IsWholeSale" dbType="Int32"/>
      <param name="@Memo" dbType="String"/>
      <param name="@OrderDataTime" dbType="DateTime"/>
      <param name="@PayPrice" dbType="Decimal"/>
      <param name="@PayTypeSysNo" dbType="Int32"/>
      <param name="@TotalRewardedPoint" dbType="Int32"/>
      <param name="@PointPay" dbType="Int32"/>
      <param name="@PremiumAmt" dbType="Decimal"/>
      <param name="@PrepayAmt" dbType="Decimal"/>
      <param name="@GiftCardPay" dbType="Decimal"/>
      <param name="@PromotionCodeSysNo" dbType="Int32"/>
      <param name="@PromotionCustomerSysNo" dbType="Int32"/>
      <param name="@ReceiveAddress" dbType="String"/>
      <param name="@ReceiveAreaSysNo" dbType="Int32"/>
      <param name="@ReceiveCellPhone" dbType="String"/>
      <param name="@ReceiveContact" dbType="String"/>
      <param name="@ReceiveName" dbType="String"/>
      <param name="@ReceivePhone" dbType="String"/>
      <param name="@ReceiveZip" dbType="String"/>
      <param name="@ShipAmount" dbType="Decimal"/>
      <param name="@ShipTypeSysNo" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
      <param name="@TariffAmt" dbType="Decimal"/>
      <param name="@CurrencySysNo" dbType="Int32"/>
      <param name="@ExchangeRate" dbType="Decimal"/>
      <param name="@PlatPromotionCodeSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--Create SO Item-->
  <dataCommand name="Pipeline_CreateSOItem" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		        INSERT INTO IPP3.dbo.SO_Item  
               (  
                BriefName,  
                Cost,  
                DiscountAmt,  
                GiftSysNo,  
                IsMemberPrice,  
                MasterProductSysNo,  
                OriginalPrice,  
                Point,  
                PointType,  
                Price,  
                ProductSysNo,  
                ProductType,  
                PromotionDiscount,  
                Quantity,  
                SOSysNo,  
                UnitCostWithoutTax,  
                WarehouseNumber,  
                Warranty,  
                Weight,  
                LanguageCode,  
                CompanyCode,  
                StoreCompanyCode,
                TariffAmt,
                TariffCode,
                TariffRate,
                EntryRecord,
                StoreType,
                CurrencySysNo,
                ExchangeRate,
                PlatPromotionDiscount
               )  
          VALUES
		          (
                @BriefName,  
                @UnitCostPrice,  
                @DiscountAmt,  
                @GiftSysNo,  
                @IsMemberPrice,  
                @MasterProductCode,  
                @OriginalPrice,  
                @Point,  
                @PointType,  
                @Price,  
                @ProductSysNo,  
                @ProductType,  
                @PromotionDiscount,  
                @Quantity,  
                @SOSysNo,  
                @UnitCostWithoutTax,  
                @WarehouseNumber,  
                @Warranty,  
                @Weight,
                @LanguageCode,
                @CompanyCode,
                @StoreCompanyCode,
                @TariffAmt,
                @TariffCode,
                @TariffRate,
                @EntryRecord,
                @ProductStoreType,
                @CurrencySysNo,
                @ExchangeRate,
                @PlatPromotionDiscount
        )
      ]]>
    </commandText>
    <parameters>
      <param name="@BriefName" dbType="String"/>
      <param name="@UnitCostPrice" dbType="Decimal"/>
      <param name="@DiscountAmt" dbType="Decimal"/>
      <param name="@GiftSysNo" dbType="Int32"/>
      <param name="@IsMemberPrice" dbType="Int32"/>
      <param name="@MasterProductCode" dbType="String"/>
      <param name="@OriginalPrice" dbType="Decimal"/>
      <param name="@Point" dbType="Int32"/>
      <param name="@PointType" dbType="Int32"/>
      <param name="@Price" dbType="Decimal"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@ProductType" dbType="Int32"/>
      <param name="@PromotionDiscount" dbType="Decimal"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@UnitCostWithoutTax" dbType="Decimal"/>
      <param name="@WarehouseNumber" dbType="String"/>
      <param name="@Warranty" dbType="String"/>
      <param name="@Weight" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
      <param name="@TariffAmt" dbType="Decimal"/>
      <param name="@TariffCode" dbType="String"/>
      <param name="@TariffRate" dbType="Decimal"/>
      <param name="@EntryRecord" dbType="String"/>
      <param name="@ProductStoreType" dbType="Int32"/>
      <param name="@CurrencySysNo" dbType="Int32"/>
      <param name="@ExchangeRate" dbType="Decimal"/>
      <param name="@PlatPromotionDiscount" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <!--整单折扣信息-->
  <dataCommand name="Pipeline_CreateSalesRuleInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
              IF NOT EXISTS(  
                SELECT 1   
                FROM IPP3.dbo.SO_SaleRule WITH(NOLOCK)  
                WHERE SOSysNo = @SOSysNo   
                  AND SaleRuleSysNo = @SaleRuleSysNo  
                  AND LanguageCode = @LanguageCode  
                  AND CompanyCode = @CompanyCode  
                  AND StoreCompanyCode = @StoreCompanyCode
              )
              BEGIN
                INSERT INTO IPP3.dbo.SO_SaleRule  
                  (  
                    SOSysNo,   
                    SaleRuleSysNo,   
                    SaleRuleName,   
                    Discount,   
                    Times,   
                    Note,  
                    ReferenceType,  
                    LanguageCode,  
                    CompanyCode,  
                    StoreCompanyCode  
                  )  
                VALUES
                  (
                    @SOSysNo,   
                    @SaleRuleSysNo,   
                    @SaleRuleName,
                    @Discount,
                    @Times,
                    @Note,
                    @ReferenceType,
                    @LanguageCode,  
                    @CompanyCode,  
                    @StoreCompanyCode  
                  )
              END  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@SaleRuleSysNo" dbType="Int32"/>
      <param name="@SaleRuleName" dbType="String"/>
      <param name="@Discount" dbType="Decimal"/>
      <param name="@Times" dbType="Int32"/>
      <param name="@Note" dbType="String"/>
      <param name="@ReferenceType" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--xxx新促销“销售立减”具体请参考 [OverseaInvoiceReceiptManagement].[dbo].[UP_EC_SSB_CreateSONewPromotionLog]xxx-->
  <dataCommand name="Pipeline_CreateSONewPromotionLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
		    INSERT INTO [dbo].[SO_MarketingPromo]  
        (  
           [SOSysNo]  
          ,[PromoSysNo]  
          ,[PromoType]  
          ,VendorSysNo  
          ,PromoRuleData  
          ,InDate  
          ,InUser  
        )  
        VALUES
		    (
            @SOSysNo,  
            @PromoSysNo,  
            @PromoType,  
            @PromoRuleData,  
            GETDATE(),  
            N'WebSite'
        )
        
        DECLARE @MasterSysNo INT
        SET @MasterSysNo= SCOPE_IDENTITY()
          
        INSERT INTO [dbo].[SO_MarketingPromoDetail]  
        (  
           SOMarketingPromoSysNo  
          ,ProductSysNo  
          ,ProductQuantity  
          ,DiscountAmount  
        )  
        VALUES
		    (
            @MasterSysNo,  
            @ProductSysNo,  
            @ProductQuantity,  
            @DiscountAmount,  
        )
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromoSysNo" dbType="Int32"/>
      <param name="@PromoType" dbType="Int32"/>
      <param name="@VendorSysNo" dbType="Int32"/>
      <param name="@PromoRuleData" dbType="String"/>

      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@ProductQuantity" dbType="Int32"/>
      <param name="@DiscountAmount" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <!--更新优惠券兑换日志-->
  <dataCommand name="Pipeline_UpdatePromotionCodeRedeemLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      
         DECLARE @CouponSysNo INT;
         DECLARE @CouponCode NVARCHAR(20);
         
      
         SELECT TOP 1 @CouponCode = CouponCode,  
            @CouponSysNo = CouponSysNo   
         FROM OverseaECommerceManagement.dbo.CouponCode WITH(NOLOCK)  
         WHERE SysNo = @CouponCodeSysNo
      
		     --记录蛋券使用记录  
         --IF NOT EXISTS(SELECT TOP 1 1 FROM OverseaECommerceManagement.dbo.CouponCode_RedeemLog WITH(NOLOCK)  
              --WHERE CustomerSysNo = @CustomerSysNo  
              --AND SOSysNo = @SOSysNo  
              --AND Status = 'A')  
           --BEGIN  
            INSERT INTO OverseaECommerceManagement.dbo.CouponCode_RedeemLog  
            (  
             CouponSysNo,  
             CouponCode,  
             CustomerSysNo,  
             ShoppingCartSysNo,  
             SOSysNo,  
             RedeemAmount,  
             Status,  
             InDate,  
             InUser  
            )
            Values
            (
             @CouponSysNo,  
             @CouponCode,  
             @CustomerSysNo,  
             @ShoppingCartSysNo,  
             @SOSysNo,  
             @RedeemAmount,  
             'A',  
             GETDATE(),  
             N'WebSite'
            )  
          --END  
     
         --2.更新蛋券的已使用金额  
         EXEC OverseaOrderManagement.dbo.[UP_EC_SSB_UpdatePromotionCodeBasic_V1] @CouponCodeSysNo,0,@RedeemAmount  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CouponCodeSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@ShoppingCartSysNo" dbType="Int32"/>
      <param name="@RedeemAmount" dbType="Decimal"/>
    </parameters>
  </dataCommand>

  <!--更新积分-->
  <dataCommand name="Pipeline_UpdatePointForCustomer" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          DECLARE @ReturnPointResult CHAR(10);    
          
          EXEC @ReturnPointResult=OverseaInvoiceReceiptManagement.dbo.UP_UpdatePointForCustomer    
           @CustomerSysNo,    
           @Point,    
           3,    
           NULL,    
           @SOSysNo,    
           0,--@OperationType 1:VoidSO;0:其它    
           'WebSite',--@InUser    
           @Memo,    
           'WebSite',
           @LanguageCode,    
           @CurrencyCode,   
           @CompanyCode,    
           @StoreCompanyCode    
          
          SELECT @ReturnPointResult
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@Point" dbType="Int32"/>
      <param name="@Memo" dbType="String"/>
      <param name="@CurrencyCode" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--更新余额-->
  <dataCommand name="Pipeline_UpdateCustomerPrepayBasic" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
           EXEC OverseaOrderManagement.dbo.[UP_EC_SSB_UpdateCustomerPrepayBasic] 
           @SOSysNo,    
           @CustomerSysNo,    
           @ValidPrepayAmt,    
           1,    
           'Create SO',    
           @LanguageCode,    
           @CompanyCode,    
           @StoreCompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@ValidPrepayAmt" dbType="Decimal"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--更新用户扩展信息-->
  <dataCommand name="Pipeline_UpdateCustomerExtend" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
        UPDATE TOP (1) IPP3.dbo.Customer_Extend    
        SET LastReceiveAreaSysNo = @LastReceiveAreaID,    
            LastPayTypeSysNo = @PayTypeID    
        WHERE CustomerSysno = @CustomerSysNo    
          AND LanguageCode = @LanguageCode    
          AND CompanyCode = @CompanyCode    
          AND StoreCompanyCode = @StoreCompanyCode
      ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@LastReceiveAreaID" dbType="Int32"/>
      <param name="@PayTypeID" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--更新检查运费-->
  <dataCommand name="Pipeline_UpdateSOCheckShipping" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
         DECLARE @MKTActivityType INT=0
         DECLARE @SpecialSOType INT=0
         DECLARE @IsRequireShipInvoice INT=0
        
         IF EXISTS(    
           SELECT 1     
           FROM IPP3.dbo.SO_CheckShipping WITH(NOLOCK)     
           WHERE SOSysNo = @SOSysNo    
            AND LanguageCode = @LanguageCode    
            AND CompanyCode = @CompanyCode    
            AND StoreCompanyCode = @StoreCompanyCode)    
         BEGIN    
     
          UPDATE TOP (1) IPP3.dbo.SO_CheckShipping    
          SET     
           WeightSO = @SOWeightAmount,    
           PackageFee = 0,    
           ShippingFee = @ShippingFee,    
           RegisteredFee = 0,    
           UpdateTime = GETDATE(),    
           CustomerIPAddress = NULL,    
           CustomerCookie = NULL,    
           MKTActivityType = @MKTActivityType,    
           SpecialSOType = @SpecialSOType,    
           IsRequireShipInvoice = @IsRequireShipInvoice,    
           IsLastVat = 0,    
           IsExtendWarrantyOrder = 0,    
           IsDCOrder = 0,    
           SOType = @SOType,  
           LocalWHSysNo=@LocalWHSysNo,
           RingOutShipType = NULL,    
           DeliveryPromise = N'',    
           DeliveryType= 0,    
           SoSplitType = 0,    
           IsBackOrder = 0,    
           DeliverySection = N'',    
           IsPhoneOrder = @IsPhoneOrder,    
           MerchantSysNo = @MerchantSysNo,    
           StockType = @StockType,    
           ShippingType = @ShippingType,    
           InvoiceType = @InvoiceType  ,  
           NeedInvoice = 0 ,
           MemoForCustomer = @MemoForCustomer,
           ReferenceSysNo = @ReferenceSysNo,
           SettlementStatus = (CASE @SOType 
              WHEN 7 THEN 'S'
              ELSE NULL
            END)
           WHERE SOSysNo = @SOSysNo    
            AND LanguageCode = @LanguageCode    
            AND CompanyCode = @CompanyCode    
            AND StoreCompanyCode = @StoreCompanyCode    
    
         END    
         ELSE    
         BEGIN    
          INSERT INTO IPP3.dbo.SO_CheckShipping    
          (    
           SOSysNo,     
           WeightSO,    
           CreateTime,     
           ShippingFee,    
           PackageFee,    
           RegisteredFee,    
           CustomerIPAddress,    
           CustomerCookie,    
           MKTActivityType,    
           SpecialSOType,    
           IsRequireShipInvoice,    
           IsLastVat,    
           IsExtendWarrantyOrder,    
           IsDCOrder,    
           SOType,
           LocalWHSysNo,
           RingOutShipType,    
           DeliveryPromise,    
           DeliveryType,    
           SoSplitType,    
           DeliverySection,    
           LanguageCode,    
           CompanyCode,    
           StoreCompanyCode,    
           IsPhoneOrder,    
           MerchantSysNo,    
           StockType,    
           ShippingType,    
           InvoiceType,    
           ReferenceSysno  ,  
           NeedInvoice ,
           MemoForCustomer,
           SettlementStatus
          )    
          VALUES     
          (    
            @SOSysNo,     
            @SOWeightAmount,     
            GETDATE(),     
            @ShippingFee,     
            0,     
            0,    
            NULL,    
            NULL,    
            @MKTActivityType,    
            @SpecialSOType,    
            @IsRequireShipInvoice,    
            0,    
            0,    
            0,    
            @SOType,
            @LocalWHSysNo,
            NULL,    
            N'',    
            0,    
            0,    
            N'',    
            @LanguageCode,    
            @CompanyCode,    
            @StoreCompanyCode,    
            @IsPhoneOrder,    
            @MerchantSysNo,    
            @StockType,    
            @ShippingType,    
            @InvoiceType,    
            @ReferenceSysNo,  
            @NeedInvoice ,
            @MemoForCustomer,
            CASE @SOType 
              WHEN 7 THEN 'S'
              ELSE NULL
            END
          )    
         END    
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@SOWeightAmount" dbType="Decimal"/>
      <param name="@ShippingFee" dbType="Decimal"/>
      <param name="@SOType" dbType="Int32"/>
      <param name="@IsPhoneOrder" dbType="Int32"/>
      <param name="@LocalWHSysNo" dbType="Int32"/>
      <param name="@StockType" dbType="String"/>
      <param name="@ShippingType" dbType="String"/>
      <param name="@InvoiceType" dbType="String"/>
      <param name="@MemoForCustomer" dbType="String"/>
      <param name="@ReferenceSysNo" dbType="Int32"/>
      <param name="@NeedInvoice" dbType="Int32"/>
      <param name="@MerchantSysNo" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--CREATE SO Extension Info-->
  <dataCommand name="Pipeline_CreateSOMasterExtension" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
         INSERT INTO OverseaOrderManagement.dbo.SO_Master_Extension  
        (  
            [SOSysNo]  
           ,[ExtensionName]  
           ,[ExtensionValue]  
           ,[InDate]  
           ,[Status]  
           ,LanguageCode  
           ,CompanyCode  
           ,StoreCompanyCode  
         )
         VALUES(
            @SOSysNo,
            @ExtensionName,
            @ExtensionValue,
            @OrderDataTime,
            1,
            @LanguageCode,  
            @CompanyCode,  
            @StoreCompanyCode 
        )
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ExtensionName" dbType="String"/>
      <param name="@ExtensionValue" dbType="String"/>
      <param name="@OrderDataTime" dbType="DateTime"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--xxxCREATE DC ORDER LOGxxx 货到付款商品信息-->
  <dataCommand name="Pipeline_SOAnniversaryLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          INSERT INTO [IPP3].[dbo].[SO_AnniversaryLog]  
            ([SOSysNo]  
            ,[InDate]  
            ,[ProductSysNo]  
            ,LanguageCode  
            ,CompanyCode  
            ,StoreCompanyCode  
            )  
        VALUES  
            (  
             @SOSysNo  
            ,GETDATE()  
            ,@ProductSysNo  
            ,@LanguageCode  
            ,@CompanyCode  
            ,@StoreCompanyCode  
            )  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--订单商品附件和赠品-->
  <dataCommand name="Pipeline_CreateSOItemAccessory" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          INSERT INTO OverseaOrderManagement.dbo.SO_Item_Accessory  
            (  
            SOSysNo,  
            PromotionSysNo,  
            MasterProductSysNo,  
            ProductSysNo,  
            Quantity,  
            [Type],  
            InDate,  
            InUser  
            )  
          VALUES  
            (  
             @SOSysNo  
            ,@PromotionSysNo
            ,@MasterProductSysNo  
            ,@ProductSysNo
            ,@Quantity
            ,@Type
            ,GETDATE()
            ,'WebSite'  
            )  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@MasterProductSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
      <param name="@Type" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--促销活动订单赠送-->
  <dataCommand name="Pipeline_CreateSOGiftMaster" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
           INSERT INTO OverseaOrderManagement.[dbo].[SO_GiftMaster]  
            (  
             [SOSysNo]  
            ,[PromotionSysNo]  
            ,[Type]  
            ,[Count]  
            ,[Order]  
            ,[InDate]  
            ,[InUser]  
            )  
          VALUES  
            (  
             @SOSysNo  
            ,@PromotionSysNo
            ,@Type  
            ,@Count
            ,@Order
            ,GETDATE()
            ,'WebSite'  
            )  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@Type" dbType="String"/>
      <param name="@Count" dbType="Int32"/>
      <param name="@Order" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--促销活动订单赠品列表-->
  <dataCommand name="Pipeline_CreateSOGiftItem" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          INSERT INTO OverseaOrderManagement.[dbo].[SO_GiftItem]  
            (  
               [SOSysNo]  
              ,[PromotionSysNo]  
              ,[ProductSysNo]  
              ,[Quantity]  
              ,PlusBuyPrice  
              ,[InDate]  
              ,[InUser]  
            )  
          VALUES  
            (  
               @SOSysNo  
              ,@PromotionSysNo
              ,@ProductSysNo
              ,@Quantity
              ,0
              ,GETDATE()
              ,'WebSite'  
            )  
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PromotionSysNo" dbType="Int32"/>
      <param name="@ProductSysNo" dbType="Int32"/>
      <param name="@Quantity" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--赠品毛利分配-->
  <dataCommand name="Pipeline_CreateSOItemGrossProfit" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
          EXEC OverseaOrderManagement.dbo.UP_EC_SSB_CreateSOItemGrossProfit @SOSysNo ,'CreateSO',1
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>

  <!--订单支付和余额支付日志-->
  <dataCommand name="Pipeline_UpdateFinanceNetPayForPrepay" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
            DECLARE @PostIncomeSysno INT  
            DECLARE @SystemUserSysNo INT      

          ------------1.判定是否用余额或者礼品卡支付完成--------------------------------------------  
            IF @CashPay + @PayPrice + @ShippingPrice + @TaxAmount + @DiscountAmount - @PrepayAmount - ISNULL(@GiftCardPayAmt,0) <> 0  
            BEGIN  
              IF EXISTS(SELECT TOP 1 1 FROM IPP3.dbo.Finance_NetPay WITH(NOLOCK)  
                WHERE SOSysNo = @SOSysNo  
                AND PayAmount = 0  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode)  
              BEGIN  
                UPDATE TOP (1) IPP3.dbo.Finance_NetPay   
                SET [Status]= -1  
                WHERE SOSysNo = @SOSysNo  
                AND PayAmount = 0  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode   
              END    
              IF EXISTS(SELECT TOP 1 1 FROM IPP3.dbo.Finance_PostIncome WITH(NOLOCK)  
                WHERE SOSysNo = @SOSysNo  
                AND IncomeAmt = 0  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode)  
              BEGIN  
                DELETE TOP (1) FROM IPP3.dbo.Finance_PostIncome  
                WHERE SOSysNo = @SOSysNo  
                AND IncomeAmt = 0  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode   
              END  
      
              RETURN;  
            END  
            ----------------------2.获取SystemUserSysNo--------------------------------------------  
            SELECT TOP 1 @SystemUserSysNo=CONVERT(INT,[Value])   
            FROM IPP3.dbo.Sys_Configuration WITH(NOLOCK)   
            WHERE [key] = 'SystemUserSysNo'  
            AND LanguageCode = @LanguageCode  
            AND CompanyCode = @CompanyCode  
            AND StoreCompanyCode = @StoreCompanyCode  
            ------------------------3.银行在线支付-------------------------------------------------   
            IF EXISTS(SELECT TOP 1 1   
            FROM IPP3.dbo.PayType WITH(NOLOCK)  
            WHERE IsNet = 1   
            AND SysNo = @PayTypeID  
            AND LanguageCode = @LanguageCode  
            AND CompanyCode = @CompanyCode  
            AND StoreCompanyCode = @StoreCompanyCode)  
            BEGIN  
            IF NOT EXISTS(SELECT TOP 1 1 FROM IPP3.dbo.Finance_NetPay n WITH(NOLOCK)  
                WHERE SOSysNo = @SOSysNo  
                AND Status > -1  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode)  
              BEGIN  
              INSERT INTO IPP3.dbo.Finance_NetPay  
              (  
                SOSysNo,  
                PayTypeSysNo,  
                PayAmount,  
                Source,  
                InputTime,  
                InputUserSysNo,  
                Status,  
                LanguageCode,  
                CompanyCode,  
                StoreCompanyCode,  
                PrePayAmt,  
                PointPayAmt,  
                GiftCardPayAmt  
              )  
              VALUES  
              (  
                @SOSysNo,  
                @PayTypeID,  
                0.0,  
                2,  
                GetDate(),  
                @SystemUserSysNo,  
                0,  
                @LanguageCode,  
                @CompanyCode,  
                @StoreCompanyCode,  
                @PrepayAmount,  
                @PointPayAmt,  
                @GiftCardPayAmt  
              )  
              END  
            END  
          ------------------------------4.非在线支付---------------------------------------------------------  
            IF EXISTS(  
            SELECT TOP 1 1  
            FROM IPP3.dbo.PayType WITH(NOLOCK)  
            WHERE IsPayWhenRecv = 0 AND IsNet = 0 AND SysNo = @PayTypeID  
            AND LanguageCode = @LanguageCode  
            AND CompanyCode = @CompanyCode  
            AND StoreCompanyCode = @StoreCompanyCode)  
            BEGIN  

            ---------4.1 Finance_PostIncome数据插入  
            IF NOT EXISTS(SELECT TOP 1 1 FROM IPP3.dbo.Finance_PostIncome WITH(NOLOCK)  
                WHERE SOSysNo = @SOSysNo  
                AND LanguageCode = @LanguageCode  
                AND CompanyCode = @CompanyCode  
                AND StoreCompanyCode = @StoreCompanyCode)  
              BEGIN  
              INSERT INTO IPP3.dbo.Finance_PostIncome  
              (  
                SOSysNo,  
                IncomeAmt,  
                PayUser,  
                CreateDate,  
                IncomeDate,  
                IncomeBank,  
                Notes,  
                CreateUserSysNo,  
                ConfirmUserSysNo,  
                ConfirmDate,  
                ConfirmStatus,  
                HandleStatus,  
                LanguageCode,  
                CompanyCode,  
                StoreCompanyCode  
              )  
              VALUES  
              (  
                @SOSysNo,  
                0.0,  
                @CustomerName,  
                GETDATE(),  
                GETDATE(),  
                N'无',  
                N'系统自动生成的金额为0的收款',  
                @SystemUserSysNo,  
                @SystemUserSysNo,  
                GETDATE(),  
                1,  
                0,  
                @LanguageCode,  
                @CompanyCode,  
                @StoreCompanyCode  
              )  
  
              SELECT @PostIncomeSysno= scope_identity()  
              ---------4.2 PostIncomeConfirm数据插入  
              INSERT INTO [OverseaInvoiceReceiptManagement].[dbo].[PostIncomeConfirm]  
                    ([PostIncomeSysNo]  
                    ,[ConfirmedSOSysNo]  
                    ,[Status]  
                    ,[InUser]  
                    ,[InDate]  
                    ,[EditUser]  
                    ,[EditDate]  
                    ,[CompanyCode]  
                    ,[CurrencyCode]  
                    ,[LanguageCode]  
                    ,[StoreCompanyCode])  
                VALUES  
                    (@PostIncomeSysno  
                    ,@SOSysNo  
                    ,'R'  
                    ,'WebSite'  
                    ,GETDATE()  
                    ,NULL  
                    ,NULL  
                    ,@CompanyCode  
                    ,'1'  
                    ,@LanguageCode  
                    ,@StoreCompanyCode  
                  )  
              END  
            ELSE  
              BEGIN  
              UPDATE TOP (1) IPP3.dbo.Finance_PostIncome  
              SET PayUser = @CustomerName  
              WHERE SOSysNo = @SOSysNo  
              AND LanguageCode = @LanguageCode  
              AND CompanyCode = @CompanyCode  
              AND StoreCompanyCode = @StoreCompanyCode  
              END  
            END 
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@PrepayAmount" dbType="Decimal"/>
      <param name="@CashPay" dbType="Decimal"/>
      <param name="@DiscountAmount" dbType="Decimal"/>
      <param name="@PayPrice" dbType="Decimal"/>
      <param name="@ShippingPrice" dbType="Decimal"/>
      <param name="@TaxAmount" dbType="Decimal"/>
      <param name="@PointPayAmt" dbType="Int32"/>
      <param name="@GiftCardPayAmt" dbType="Decimal"/>
      <param name="@PayTypeID" dbType="Int32"/>
      <param name="@CustomerName" dbType="String"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--订单创建日志-->
  <dataCommand name="Pipeline_UpdateSalesOrderLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
               INSERT INTO IPP3.dbo.SO_Log  
               (  
                OptTime,  
                OptUserSysNo,  
                OptIP,  
                OptType,  
                SOSysNo,  
                Note,  
                LanguageCode,  
                CompanyCode,  
                StoreCompanyCode  
               )  
               VALUES  
               (  
                GetDate(),  
                @CustomerSysNo,  
                @CustomerIPAddress,  
                @OperatorType,  
                @SOSysNo,  
                @Note,    
                @LanguageCode,  
                @CompanyCode,  
                @StoreCompanyCode  
               )    
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
      <param name="@CustomerIPAddress" dbType="String"/>
      <param name="@OperatorType" dbType="Int32"/>
      <param name="@Note" dbType="String"/>
      <param name="@LanguageCode" dbType="String"/>
      <param name="@CompanyCode" dbType="String"/>
      <param name="@StoreCompanyCode" dbType="String"/>
    </parameters>
  </dataCommand>

  <!--根据购物车ID获取Thankyou页面订单列表-->
  <dataCommand name="Shopping_GetOrderListByShoppingCartID" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
			DECLARE @TblList TABLE(SOSysNo INT, PromotionAmt DECIMAL(18,2));

      INSERT INTO @TblList
      SELECT ShoppingCart.SOSysNo, SUM(ISNULL(Item.PromotionDiscount, 0) * Item.Quantity) AS PromotionAmt
	      FROM [IPP3].[dbo].[SO_Item](NOLOCK) Item
	      INNER JOIN [OverseaOrderManagement].[dbo].[SO_ShoppingCart](NOLOCK) ShoppingCart
		      ON Item.SOSysNo = ShoppingCart.SOSysNo
	      WHERE ShoppingCart.ShoppingCartSysNo = @ShoppingCartID
	      GROUP BY ShoppingCart.SOSysNo

      SELECT ShoppingCart.SOSysNo,(SOMaster.SOAmt + SOMaster.ShipPrice - ABS(Promotion.PromotionAmt)
	          - ABS(SOMaster.PointPay * 1.0 / 100)
	          - ABS(SOMaster.GiftCardPay) - ABS(SOMaster.DiscountAmt)
	          + (CASE WHEN SOMaster.TariffAmt > 50 THEN SOMaster.TariffAmt ELSE 0 END)) AS SOAmount,
	         (SOMaster.SOAmt + SOMaster.ShipPrice - ABS(Promotion.PromotionAmt)
	          - ABS(SOMaster.PrepayAmt) - ABS(SOMaster.PointPay * 1.0 / 100)
	          - ABS(SOMaster.GiftCardPay) - ABS(SOMaster.DiscountAmt)
	          + (CASE WHEN SOMaster.TariffAmt > 50 THEN SOMaster.TariffAmt ELSE 0 END)) AS PayAmount,
	         SOMaster.PayTypeSysNo,
	         PayType.PayTypeID,
	         PayType.PayTypeName,
	         PayType.IsNet,
           SOMaster.ShipTypeSysNo,
           ShipType.ShipTypeName, 
           SOCheckShipping.MemoForCustomer
	      FROM [OverseaOrderManagement].[dbo].[SO_ShoppingCart](NOLOCK) ShoppingCart
	      INNER JOIN [IPP3].[dbo].[SO_Master](NOLOCK) SOMaster
		      ON ShoppingCart.SOSysNo = SOMaster.SysNo
	      INNER JOIN [IPP3].[dbo].[PayType](NOLOCK) PayType
		      ON SOMaster.PayTypeSysNo = PayType.SysNo
        INNER JOIN [IPP3].[dbo].[ShipType](NOLOCK) ShipType
          ON SOMaster.ShipTypeSysNo = ShipType.SysNo
	      INNER JOIN @TblList Promotion
		      ON SOMaster.SysNo = Promotion.SOSysNo
        INNER JOIN ipp3.dbo.SO_CheckShipping(NOLOCK) SOCheckShipping
          ON SOMaster.SysNo = SOCheckShipping.SOSysNo
	      WHERE ShoppingCart.ShoppingCartSysNo = @ShoppingCartID
      ]]>
    </commandText>
    <parameters>
      <param name="@ShoppingCartID" dbType="Int32" />
    </parameters>
  </dataCommand>


  <dataCommand name="Pipeline_CreateSOItemExtension" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      
     DELETE FROM OverseaOrderManagement.dbo.SO_Item_Extension  
     WHERE SOSysNo = @SOSysNo  
 
			INSERT INTO OverseaOrderManagement.dbo.SO_Item_Extension  
           (  
            [SOSysNo]  
           ,[ProductSysNo]  
           ,[ReferenceSysNo]  
           ,[Type]  
           ,[InUser]  
           ,[InDate]  
           )  
       VALUES
           (
             @SOSysNo
            ,@ProductSysNo
            ,@ReferenceSysNo
            ,@Type
            ,'WebSite'
            ,GETDATE()
           )
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32" />
      <param name="@ProductSysNo" dbType="Int32" />
      <param name="@ReferenceSysNo" dbType="Int32" />
      <param name="@Type" dbType="AnsiStringFixedLength" />
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CreateAdvEffectMonitor" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
INSERT Ecommerce.dbo.AdvEffectMonitor (CMP, OperationType, CustomerSysNo, ReferenceSysNo, CreateDate, CompanyCode, LanguageCode, StoreCompanyCode, CMP1, CMP2, CMP3, CMP4) 
VALUES (@CMP, @OperationType, @CustomerSysNo, @ReferenceSysNo, GETDATE(), @CompanyCode, @LanguageCode, @StoreCompanyCode, @CMP1, @CMP2, @CMP3, @CMP4);
      ]]>
    </commandText>
    <parameters>
      <param name="@CMP" dbType="String" />
      <param name="@OperationType" dbType="String" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@ReferenceSysNo" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" />
      <param name="@StoreCompanyCode" dbType="AnsiString" />
      <param name="@CMP1" dbType="String" />
      <param name="@CMP2" dbType="String" />
      <param name="@CMP3" dbType="String" />
      <param name="@CMP4" dbType="String" />
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CreateGroupBuyingTicket" database="Write" commandType="Text">
    <commandText>
      <![CDATA[      
      DECLARE @TicketAmt DECIMAL(18,2), @AvailableDate DATETIME, @VendorSysNo INT, @CostAmt DECIMAL(18,2), @SysNo INT;
SELECT @VendorSysNo = GB.VendorSysNo,
@AvailableDate = ISNULL(GB.CouponValidDate, DATEADD(DAY, 1, GETDATE())),
@TicketAmt = Price.CurrentPrice,
@CostAmt = GBPrice.CostAmt
FROM [OverseaContentManagement].[dbo].[ProductGroupBuying](NOLOCK) GB
INNER JOIN IPP3.dbo.Product_Price(NOLOCK) Price  
ON GB.ProductSysNo = Price.ProductSysNo
INNER JOIN OverseaContentManagement.dbo.ProductGroupBuying_Price(nolock) GBPrice
ON GB.SysNo = GBPrice.ProductGroupBuyingSysNo
WHERE GB.SysNo = @GroupBuyingSysNo

SELECT @SysNo = MAX(SysNo) + 1 FROM [OverseaContentManagement].[dbo].[GroupBuyingTicket](NOLOCK)

INSERT INTO [OverseaContentManagement].[dbo].[GroupBuyingTicket]
           ([GroupBuyingSysNo]
           ,[OrderSysNo]
           ,[TicketID]
           ,[TicketAmt]
           ,[RefundMemo]
           ,[AvailableDate]
           ,[Tel]
           ,[UsedStoreSysNo]
           ,[UsedDate]
           ,[CustomerSysNo]
           ,[VendorSysNo]
           ,[RefundDate]
           ,[RefundUser]
           ,[CreateUser]
           ,[CreateDate]
           ,[EditUser]
           ,[EditDate]
           ,[CompanyCode]
           ,[StoreCompanyCode]
           ,[LanguageCode]
           ,[Status]
           ,[RefundStatus]
           ,[PayType]
           ,[CostAmt]
           ,[SysNo])
     VALUES
           (@GroupBuyingSysNo
           ,@OrderSysNo
           ,NULL
           ,@TicketAmt
           ,NULL
           ,@AvailableDate
           ,@Tel
           ,NULL
           ,NULL
           ,@CustomerSysNo
           ,@VendorSysNo
           ,NULL
           ,NULL
           ,@CustomerSysNo
           ,GETDATE()
           ,NULL
           ,NULL
           ,@CompanyCode
           ,@StoreCompanyCode
           ,@LanguageCode
           ,-3
           ,NULL
           ,@PayType
           ,@CostAmt
           ,@SysNo)
      ]]>
    </commandText>
    <parameters>
      <param name="@GroupBuyingSysNo" dbType="Int32" />
      <param name="@OrderSysNo" dbType="Int32" />
      <param name="@Tel" dbType="String" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@PayType" dbType="Int32" />
      <param name="@CompanyCode" dbType="AnsiStringFixedLength" />
      <param name="@LanguageCode" dbType="AnsiStringFixedLength" />
      <param name="@StoreCompanyCode" dbType="AnsiString" />
    </parameters>
  </dataCommand>
  
  <dataCommand name="CreateGroupBuyingTicketSequence" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      INSERT INTO [OverseaContentManagement].[dbo].[GroupBuyingTicketSequence]
           ([CreateTime])
      VALUES
           (GETDATE())
      SELECT SCOPE_IDENTITY()
      ]]>
    </commandText>
    <parameters>
    </parameters>
  </dataCommand>
  
  <dataCommand name="UpdateGroupBuyingTicketID" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
      UPDATE OverseaContentManagement.dbo.GroupBuyingTicket
      SET TicketID = @TicketID, Status = 0
      WHERE SysNo = @SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@TicketID" dbType="String" />
    </parameters>
  </dataCommand>
  
  <dataCommand name="Pipeline_QueryGiftCardInfoList" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
SELECT TransactionNumber AS SysNo
  ,RTRIM([Code]) AS [Code]
  ,[Password]
  ,[TotalAmount]
  ,[AvailAmount] AS [AvailableAmount]
  ,[BindingCustomerSysNo]
  ,[BeginDate] AS [ValidBeginDate]
  ,[EndDate] AS [ValidEndDate]
  ,[Status]
  ,CASE WHEN ISNULL([IsHold],'N') = 'Y' THEN 1 ELSE 0 END AS IsLock
FROM [OverseaECommerceManagement].[dbo].[GiftCardInfo] WITH(NOLOCK)
#StrWhere#
      ]]>
    </commandText>
  </dataCommand>

  <dataCommand name="Pipeline_GetCustomerBindingGiftCardInfoList" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
SELECT TransactionNumber AS SysNo
  ,RTRIM([Code]) AS [Code]
  ,[TotalAmount]
  ,[AvailAmount] AS [AvailableAmount]
  ,[BindingCustomerSysNo]
  ,[BeginDate] AS [ValidBeginDate]
  ,[EndDate] AS [ValidEndDate]
  ,[Status]
  ,CASE WHEN ISNULL([IsHold],'N') = 'Y' THEN 1 ELSE 0 END AS IsLock
FROM [OverseaECommerceManagement].[dbo].[GiftCardInfo] WITH(NOLOCK)
WHERE BindingCustomerSysNo = @CustomerSysNo
  AND [Status] <>'D' AND ISNULL([IsHold],'N') = 'N'
  AND AvailAmount > 0
  AND BeginDate <= Convert(date,getdate())
  AND EndDate >= Convert(date,getdate()) 
      ]]>
    </commandText>
    <parameters>
      <param name="@CustomerSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_UpdateGiftCardInfo" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
UPDATE A  
  SET   
   AvailAmount = AvailAmount - @UseAmount 
   ,EditUser = 'Website'
   ,EditDate = GETDATE()  
  FROM OverseaEcommerceManagement.dbo.GiftCardInfo A
  WHERE TransactionNumber=@SysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SysNo" dbType="Int32" />
      <param name="@UseAmount" dbType="Decimal" />
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CreateGiftCardRedeemLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO OverseaEcommerceManagement.dbo.GiftCardRedeemLog  
           ([Code]  
           ,[CustomerSysNo]  
           ,[amount]  
           ,[ActionSysNo]  
           ,[ActionType]  
           ,[Status]  
           ,[CurrencySysNo]  
           ,[InUser]  
           ,[InDate]  
           ,[EditUser]  
           ,[EditDate]  
         )  
  VALUES( 
           @Code  
           ,@CustomerSysNo  
           ,@ConsumeAmount  
           ,@ReferenceSOSysNo  
           ,'SO'  
           ,'A'  
           ,@CurrencySysNo  
           ,'Website'  
           ,GETDATE()          
           ,'Website'   
           ,GETDATE()
        )
      ]]>
    </commandText>
    <parameters>
      <param name="@Code" dbType="String" />
      <param name="@CustomerSysNo" dbType="Int32" />
      <param name="@ConsumeAmount" dbType="Decimal" />
      <param name="@ReferenceSOSysNo" dbType="Int32" />
      <param name="@CurrencySysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
  
  <dataCommand name="Pipeline_CreateGiftCardOperateLog" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO OverseaEcommerceManagement.dbo.GiftCardOperateLog  
       ([Source]  
       ,[ActionType]  
       ,[MessageBody]  
       ,[Status]  
       ,[Memo]  
       ,[InUser]  
       ,[InDate]  
       ,[EditUser]  
       ,[EditDate]  
    )  
    VALUES  
       ('EC'  
       ,'SOConsume'  
       ,@Msg  
       ,'S'  
       ,''  
       ,'Website'
       ,GETDATE()  
       ,'Website' 
       ,GETDATE()  
      )
      ]]>
    </commandText>
    <parameters>
      <param name="@Msg" dbType="Xml" />
    </parameters>
  </dataCommand>

  <!--订单创建实名认证信息-->
  <dataCommand name="Pipeline_CreateSOAuthentication" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
INSERT INTO IPP3.[dbo].[SO_Authentication]
SELECT TOP 1 @SOSysNo,[CustomerSysNo]
      ,[Name]
      ,[IDCardType]
      ,[IDCardNumber]
      ,[Birthday]
      ,[PhoneNumber]
      ,[Email]
      ,[Address]
      ,[Gender]
FROM IPP3.[dbo].[Customer_Authentication](NOLOCK)
WHERE [CustomerSysNo]= @CustomerSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@SOSysNo" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>


  <!--用户下单频率检查-->
  <dataCommand name="Pipeline_CheckCustomerOrderFrequency" database="Write" commandType="Text">
    <commandText>
      <![CDATA[
  SELECT COUNT(1) FROM ipp3.dbo.SO_Master WITH(NOLOCK)
  WHERE OrderDate >= DateAdd(mi, -1 * @TimeSpan,  getdate())
   AND CustomerSysno =@CustomerSysNo
      ]]>
    </commandText>
    <parameters>
      <param name="@TimeSpan" dbType="Int32"/>
      <param name="@CustomerSysNo" dbType="Int32"/>
    </parameters>
  </dataCommand>
  <!--根据主商品编号判断此赠品活动是否在运行中-->
  <dataCommand name="Pipeline_CheckGiftSaleListByProductSysNo" database="Write"  commandType="Text">
    <commandText>
      <![CDATA[			
      
  SELECT  count(1)
  FROM OverseaECommerceManagement.dbo.Gift_SaleRules ggr WITH(NOLOCK)
  INNER JOIN OverseaECommerceManagement.dbo.Gift g WITH(NOLOCK) ON ggr.PromotionSysNo=g.SysNo
  AND (g.Status = 'A')
 WHERE ggr.ProductSysNo = @ProductSysNo 
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>

  <dataCommand name="Pipeline_CheckCountDownByProductSysNo" database="Write"  commandType="Text">
    <commandText>
      <![CDATA[			
      
   SELECT count(1) 
   FROM [IPP3].[dbo].[Sale_CountDown] sc WITH(NOLOCK)
   INNER JOIN IPP3.dbo.Product p WITH(NOLOCK)  ON sc.ProductSysNo=p.SysNo
   WHERE sc.ProductSysNo = @ProductSysNo AND  sc.[Status] = 1 AND p.[Status]=1
         ]]>
    </commandText>
    <parameters>
      <param name="@ProductSysNo" dbType="Int32" />
    </parameters>
  </dataCommand>
</dataOperations>
